---
title: "KSR_2020"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console

NOTES:
  -leaving off here in mid-Jan.
  -Still to do--
    -figure out if I did the herbivore RDA correctly
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -renv::snapshot() to update packages
    -export stats w/flextable ? see ch1
    -calculate heritability coefficients

---
# Set up notebook
## Load packages
```{r}
library(dplyr)
library(reshape)
library(reshape2)
library(tidyr)
library(ggplot2)
library(ggExtra)
library("ggpubr")
library(devtools)
library(rpart)
library("tibble", lib.loc="~/R/win-library/3.5")
library(ISLR)
library(MASS)
library(car)
library(data.table)
library(plyr)
library(dplyr)
library(MuMIn)
library(ggplot2)
library(gridExtra)
library(Hmisc)
library(lme4)
library(nlme)
library(reshape)
library(lmerTest)
library(tidyverse)
library(vegan)
library(lindia)
library(e1071)
library(ggpubr)
library(forcats)
library(car)
library(multcomp)
library(lsmeans)
library(ggbiplot)
library(ggplot2)
require(MASS)
require(scales)
require(car)
require(ggplot2)
require(ggiraph)
require(ggiraphExtra)
library(geosphere)
library(vctrs)
library(here)
library(stringi)
```

## Add functions
```{r}
diagnostic<-function(x){
  plot(x)
  hist(x)
  qqnorm(x)
  qqline(x,lty=2, col="Red")

  skew<-function(x){
    m3<-sum((x-mean(x))^3)/length(x)
    s3<-sqrt(var(x))^3
    m3/s3}

  kurtosis<-function(x){
    m4<-sum((x-mean(x))^4)/length(x)
    s4<-var(x)^2
    m4/s4-3}

  print(paste("Kurtosis=", kurtosis(x), sep=""))
  print(paste("Skew=", skew(x), sep=""))
}

# diagnostic(x)
```

## Import data
```{r}
# 2019 data-----
data_clean_2019 <- read.csv(here::here("./CommonGardenExperiment_2019Data/clean_data/clean_data_2019KSR.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -c(1:2))

# 2020 data-----
heights_both_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_heights_clean.csv")) %>%
  dplyr::select(., -c(1:2))

herbivory_both_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_herbivory_clean.csv")) %>%
  dplyr::select(., -c(1:2))

survival_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_survival_clean.csv")) %>%
  dplyr::select(., -c(1:2))

weevil_both <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_weevil_damage_clean.csv")) %>%
  dplyr::select(., -c(1:2))

herbivores <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_herbivores_clean.csv")) %>%
  dplyr::select(., -c(1:2))

reproductive <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_reproductive_clean.csv")) %>%
  dplyr::select(., -c(1:2))

flowering_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_floweringplants_clean.csv")) %>%
  dplyr::select(., -c(1:2))
```

## Make combined 2019/2020 dfs
```{r}
# heights (includes heights and num. ramets)-----
## first make copy of data_clean_2019 with colnames that match heights_both_2020's
heights_2019 <- data_clean_2019 %>%
  dplyr::select(., c(1:6, 11:13, 18:19, 25:41)) %>%
  dplyr::filter(., Dead_2019 == 0) %>%
  dplyr::rename(., Dead = Dead_2019,
                Ramets_midJune = Num_Ramets_DC2, # doing this & following rows to compare btwn years
                Ramets_Sept = Num_Ramets_DC3, 
                Total_Height_midJune = Total_Height_DC2,
                Total_Height_Sept = Total_height_DC3) 
heights_2019$Year = 2019
heights_2019$rel_growth_rate <- as.character(heights_2019$rel_growth_rate)
heights_2019$rel_growth_rate <- as.numeric(heights_2019$rel_growth_rate)


# copy of 2020 data w/colnames that match 2019's
heights_2020 <- heights_both_2020 %>%
  dplyr::select(., -c(16)) %>%
  dplyr::rename(., Ramets_midJune = Ramets_June, # doing this & following rows to compare btwn years
                Total_Height_midJune = Total_Height_June) 
heights_2020$Year = 2020

# combine yearly dfs
heights_19_20 <- rbind.fill(heights_2019, heights_2020)
heights_19_20$Year <- as.factor(heights_19_20$Year)
heights_19_20$Family <- as.factor(heights_19_20$Family)
heights_19_20$Population <- as.factor(heights_19_20$Population)
heights_19_20$rel_growth_rate <- as.numeric(heights_19_20$rel_growth_rate)

# rm(heights_2019, heights_2020)




# herbivory-----
## first make copy of data_clean_2019 with colnames that match heights_both_2020's
herb_2019 <- data_clean_2019 %>%
  dplyr::select(., c(1:6, 18:19, 21, 32, 35:41)) %>%
  dplyr::filter(., Dead_2019 == 0) %>%
  dplyr::rename(., Dead = Dead_2019,
                Herbivory_mean_Sept = Herbivory_mean_DC3 # doing this to compare btwn years
                ) 
herb_2019$Year = 2019
herb_2019$Herbivory_mean_Sept <- as.character(herb_2019$Herbivory_mean_Sept)
herb_2019$Herbivory_mean_Sept <- as.numeric(herb_2019$Herbivory_mean_Sept)

# copy of 2020 data w/colnames that match 2019's
herb_2020 <- herbivory_both_2020 %>%
  dplyr::select(., -c(18)) %>%
  dplyr::rename(., Herbivory_mean_Sept = Herbivory.Sept_mean # doing thisto compare btwn years
                ) 
herb_2020$Year = 2020

# combine yearly dfs
herbivory_19_20 <- rbind.fill(herb_2019, herb_2020)

# rm(herb_2019, herb_2020)





# survival-----

## first make copy of data_clean_2019 with colnames that match heights_both_2020's
surv_2019 <- data_clean_2019 %>%
  dplyr::select(., c(1:6, 14:16, 25, 32, 35:41)) %>%
  dplyr::rename(., Dead = Dead_2019                ) 
surv_2019$Year = 2019

# copy of 2020 data w/colnames that match 2019's
surv_2020 <- survival_2020 %>%
  dplyr::select(., -c(12)) %>%
  dplyr::rename(., Dead = dead_2020 # doing thisto compare btwn years
                ) 
surv_2020$Year = 2020

# combine yearly dfs
survival_19_20 <- rbind.fill(surv_2019, surv_2020)

# rm(surv_2019, surv_2020)

```

# Find averages per family & population
## reproductive
### Binary: flowering success
```{r}

# Find family means
flowered2020_familymeans <- reproductive  %>%
  dplyr::select(., c(2:7, 10, 14, 16:18)) %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      sum_flowered_indivs = sum(as.integer(Flowered2020)),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      nPlants=n())


# Find population means
flowered2020_popmeans <- flowered2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      sum_flowered_indivs = sum(as.integer(sum_flowered_indivs)),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score)) %>%
  as.data.frame(flowered2020_popmeans) %>%
  
# add percent flowered column
  dplyr::mutate(., percent_flowered = sum_flowered_indivs / sum_replicates)

# remove pops with only 1 rep?




# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```



## Height
### 2019
```{r}

# Find family means
heights_both2019_familymeans <- heights_2019 %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      sum_height_earlyJune = sum(Total_Height_DC1),
      sum_height_midJune = sum(Total_Height_midJune),
      sum_height_Sept = sum(Total_Height_Sept),
      mean_Ramets_earlyJune = mean(Num_Ramets_DC1),
      mean_Ramets_midJune = mean(Ramets_midJune),
      mean_Ramets_Sept = mean(Ramets_Sept),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      mean_rel_growth_rate = mean(rel_growth_rate, na.rm = TRUE),
      Urb_score = first(Urb_score),
      nPlants=n())
## divide total height by num. plants/pop
heights_both2019_familymeans$mean_height_midJune <- heights_both2019_familymeans$sum_height_midJune / heights_both2019_familymeans$sum_replicates

heights_both2019_familymeans$mean_height_earlyJune <- heights_both2019_familymeans$sum_height_earlyJune / heights_both2019_familymeans$sum_replicates

heights_both2019_familymeans$mean_height_Sept <- heights_both2019_familymeans$sum_height_Sept / heights_both2019_familymeans$sum_replicates


# Find population means
heights_both2019_popmeans <- heights_both2019_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      sum_height_earlyJune = sum(sum_height_earlyJune),
      sum_height_midJune = sum(sum_height_midJune),
      sum_height_Sept = sum(sum_height_Sept),
      mean_Ramets_earlyJune = mean(mean_Ramets_earlyJune),
      mean_Ramets_midJune = mean(mean_Ramets_midJune),
      mean_Ramets_Sept = mean(mean_Ramets_Sept),
      mean_height_earlyJune = mean(mean_height_earlyJune),
      mean_height_midJune = mean(mean_height_midJune),
      mean_height_Sept = mean(mean_height_Sept),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      mean_rel_growth_rate = mean(mean_rel_growth_rate))


```



### 2020
```{r}

# Find family means
heights_both2020_familymeans <- heights_both_2020 %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      sum_height_June = sum(Total_Height_June),
      sum_height_Sept = sum(Total_Height_Sept),
      mean_Ramets_June = mean(Ramets_June),
      mean_Ramets_Sept = mean(Ramets_Sept),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      mean_rel_growth_rate = mean(rel_growth_rate),
      Urb_score = first(Urb_score),
      nPlants=n())
## divide total height by num. plants/pop
heights_both2020_familymeans$mean_height_June <- heights_both2020_familymeans$sum_height_June / heights_both2020_familymeans$sum_replicates

heights_both2020_familymeans$mean_height_Sept <- heights_both2020_familymeans$sum_height_Sept / heights_both2020_familymeans$sum_replicates


# Find population means
heights_both2020_popmeans <- heights_both2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      sum_height_June = sum(sum_height_June),
      sum_height_Sept = sum(sum_height_Sept),
      mean_Ramets_June = mean(mean_Ramets_June),
      mean_Ramets_Sept = mean(mean_Ramets_Sept),
      mean_height_June = mean(mean_height_June),
      mean_height_Sept = mean(mean_height_Sept),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      mean_rel_growth_rate = mean(mean_rel_growth_rate))



# # Use SummarySE to get stats per family & population
# ## HEIGHTS
# intermediate1 <- summarySE(heights_both_2020, measurevar="Total_Height_June", groupvars=c("Population", "Family"), na.rm=TRUE)
# 
# intermediate2 <- summarySE(heights_both_2020, measurevar="Total_Height_Sept", groupvars=c("Population", "Family"), na.rm=TRUE)
# 
# heights_2020_familymeans_stats <- left_join(intermediate1, intermediate2, by = c("Population", "Family"), suffix = c(".July", ".Sept"))
# 
# 
# # Use SummarySE to get stats per family & population
# ## no. ramets
# intermediate1 <- summarySE(heights_both_2020, measurevar="Ramets_June", groupvars=c("Population", "Family"), na.rm=TRUE)
# 
# intermediate2 <- summarySE(heights_both_2020, measurevar="Ramets_Sept", groupvars=c("Population", "Family"), na.rm=TRUE)
# 
# ramets_2020_familymeans_stats <- left_join(intermediate1, intermediate2, by = c("Population", "Family"), suffix = c(".June", ".Sept"))
# 
# # Add transect data via merge
# ramets_2020_familymeans_stats <- merge(ramets_2020_familymeans_stats, Distances, by = "Population", all.x = TRUE)
# 
# 
# 
# # SSE_pops_height_2020 <- summarySE(intermediates, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)

```


## Weevil scar lengths
```{r}
# Find family means
weevil_both2020_familymeans <- weevil_both %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      mean_scar_div_Juneheight = mean(scar_div_Juneheight, na.rm = TRUE),
      mean_scar = mean(Scar_length_cm),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      nPlants=n())


# Find population means
weevil_both2020_popmeans <- weevil_both2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      mean_scar_div_Juneheight = mean(mean_scar_div_Juneheight, na.rm = TRUE),
      mean_scar = mean(mean_scar),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score))



# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```
## Herbivores
```{r}

# Find family means
herbivores2020_familymeans <- herbivores %>%
  group_by(Population, Family, Sample) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      mean_Monarch_Quantity_Past = mean(Monarch_Quantity_Past),
      mean_Monarch_Quantity_Observed = mean(Monarch_Quantity_Observed),
      mean_Tetraopes_tetropthalmus = mean(Tetraopes_tetropthalmus),
      mean_Liriomyza_asclepiadis = mean(Liriomyza_asclepiadis),
      mean_Aphis_nerii = mean(Aphis_nerii),
      mean_Aphis_asclepiadis = mean(Aphis_asclepiadis),
      mean_Myzocallis_asclepiadis = mean(Myzocallis_asclepiadis),
      mean_Euchaetes_egle = mean(Euchaetes_egle),
      mean_Lygaeus_kalmii = mean(Lygaeus_kalmii),
      mean_Labidomera_clivicollis = mean(Labidomera_clivicollis),
      mean_Rhyssomatus_lineaticollis = mean(Rhyssomatus_lineaticollis),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      nPlants=n())
herbivores2020_familymeans <- as.data.frame(herbivores2020_familymeans)


# Find population means
herbivores2020_popmeans <- herbivores2020_familymeans %>%
  group_by(Population, Sample) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      mean_Monarch_Quantity_Past = mean(mean_Monarch_Quantity_Past),
      mean_Monarch_Quantity_Observed = mean(mean_Monarch_Quantity_Observed),
      mean_Tetraopes_tetropthalmus = mean(mean_Tetraopes_tetropthalmus),
      mean_Liriomyza_asclepiadis = mean(mean_Liriomyza_asclepiadis),
      mean_Aphis_nerii = mean(mean_Aphis_nerii),
      mean_Aphis_asclepiadis = mean(mean_Aphis_asclepiadis),
      mean_Myzocallis_asclepiadis = mean(mean_Myzocallis_asclepiadis),
      mean_Euchaetes_egle = mean(mean_Euchaetes_egle),
      mean_Lygaeus_kalmii = mean(mean_Lygaeus_kalmii),
      mean_Labidomera_clivicollis = mean(mean_Labidomera_clivicollis),
      mean_Rhyssomatus_lineaticollis = mean(mean_Rhyssomatus_lineaticollis),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score))
herbivores2020_popmeans <- as.data.frame(herbivores2020_popmeans)


# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```


## Herbivory
### 2019
```{r}
# Find family means
herbivory2019_familymeans <- herb_2019 %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      Herbivory.Sept_mean = mean(Herbivory_mean_Sept, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      nPlants=n())
herbivory2019_familymeans <- as.data.frame(herbivory2019_familymeans)


# Find population means
herbivory2019_popmeans <- herbivory2019_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      Herbivory.Sept_mean = mean(Herbivory.Sept_mean, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score))
herbivory2019_popmeans <- as.data.frame(herbivory2019_popmeans)

```

### 2020
```{r}
# Find family means
herbivory2020_familymeans <- herbivory_both_2020 %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      Herbivory.July_mean = mean(Herbivory.July_mean, na.rm = T),
      Herbivory.Sept_mean = mean(Herbivory.Sept_mean, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      nPlants=n())
herbivory2020_familymeans <- as.data.frame(herbivory2020_familymeans)


# Find population means
herbivory2020_popmeans <- herbivory2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      Herbivory.July_mean = mean(Herbivory.July_mean, na.rm = T),
      Herbivory.Sept_mean = mean(Herbivory.Sept_mean, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score))
herbivory2020_popmeans <- as.data.frame(herbivory2020_popmeans)


# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```


## Survival
### 2019
```{r}
# Find family means
survival2019_familymeans <- surv_2019 %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      survival_mean = mean(Dead, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      nPlants=n())
survival2019_familymeans <- as.data.frame(survival2019_familymeans)


# Find population means
survival2019_popmeans <- survival2019_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      survival_mean = mean(survival_mean, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score))
survival2019_popmeans <- as.data.frame(survival2019_popmeans)

```


### 2020
```{r}
# Find family means
survival2020_familymeans <- survival_2020 %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      survival_mean = mean(dead_2020, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      nPlants=n())
survival2020_familymeans <- as.data.frame(survival2020_familymeans)


# Find population means
survival2020_popmeans <- survival2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      survival_mean = mean(survival_mean, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score))
survival2020_popmeans <- as.data.frame(survival2020_popmeans)


# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```

# Statistics: 2019
## Heights
### Early June height
#### lmer
##### Entire gradient: *Not sig for city_dis or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant


r.squaredGLMM(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_DC1 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant



# ANy variation within families or populations?
m.1 <- lmer(Total_Height_DC1 ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families
# 
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_EarlyJuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_EarlyJuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)
# is singular...

car::Anova(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant


r.squaredGLMM(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_DC1 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant

```

##### Urban subtransects: *transect sig for both
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_DC1 ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for within families

m.2 <- lmer(Total_Height_DC1 ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# YES among transects


m.3 <- lmer(Total_Height_DC1 ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# YES among transects (still)


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_earlyJuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_earlyJuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_earlyJuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


AIC(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Mid June height
#### lmer
##### Entire gradient: *NOT sig for city_dist or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance NOT significant


r.squaredGLMM(lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant




# ANy variation within families or populations?
m.1 <- lmer(Total_Height_midJune ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant


r.squaredGLMM(lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant

```

##### Urban subtransects: *transect sig for both
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular, transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_midJune ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families

m.2 <- lmer(Total_Height_midJune ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# YES among transects though


m.3 <- lmer(Total_Height_midJune ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# YES amnog transects


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_urban_lmer_PVE.csv",
            col.names=TRUE, sep=",")
write.table(variances1,
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Sept height
#### lmer
##### Entire gradient: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))
# distance not significant


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance not  significant

r.squaredGLMM(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))

# ANy variation within families or populations?
m.1 <- lmer(Total_Height_Sept ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families

sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)
# not singular...

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# not significant


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# not significant

r.squaredGLMM(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))

```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_Sept ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families

m.2 <- lmer(Total_Height_Sept ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects though


m.3 <- lmer(Total_Height_Sept ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",")
write.table(variances1,
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
```


###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```

## Relative Growth Rate
### Mid-June through Sept
#### lmer
##### Entire gradient: *Not sig for city_dis or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant


r.squaredGLMM(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant




# ANy variation within families or populations?
m.1 <- lmer(rel_growth_rate ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families
# 
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant


r.squaredGLMM(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant

```

##### Urban subtransects: *transect sig for both
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(rel_growth_rate ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for within families

m.2 <- lmer(rel_growth_rate ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# YES among transects


m.3 <- lmer(rel_growth_rate ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# YES among transects (still)


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


## No. Ramets
### Early June ramets
#### lmer
##### Entire gradient: *Not sig for city_dis or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant


r.squaredGLMM(lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant




# ANy variation within families or populations?
m.1 <- lmer(Num_Ramets_DC1 ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families
# 
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_EarlyJuneRamets_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_EarlyJuneRamets_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)
# not singular...

car::Anova(lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant


r.squaredGLMM(lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant

```

##### Urban subtransects: *transect sig for both
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Num_Ramets_DC1 ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for within families

m.2 <- lmer(Num_Ramets_DC1 ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# YES among transects


m.3 <- lmer(Num_Ramets_DC1 ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# YES among transects (still)


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_earlyJuneRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_earlyJuneRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_earlyJuneRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


# Just main effects
car::Anova(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# No warnings!!

car::Anova(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


# Just main effects
car::Anova(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


AIC(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

AIC(lmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Mid June ramets
#### lmer
##### Entire gradient: *NOT sig for city_dist or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))

car::Anova(lmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance NOT significant


r.squaredGLMM(lmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

### CROSSED RANDOM EFFECTS-----
lmer(Ramets_midJune ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Ramets_midJune ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant




# ANy variation within families or populations?
m.1 <- lmer(Ramets_midJune ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneRamets_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneRamets_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)

car::Anova(lmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant


r.squaredGLMM(lmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Ramets_midJune ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Ramets_midJune ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant

```

##### Urban subtransects: *transect marg sig for city_dist, not for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect marg significant


# Just main effects
car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular, transect marg significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect marg significant


# Just main effects
car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect marg significant


AIC(lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Ramets_midJune ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families

m.2 <- lmer(Ramets_midJune ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# YES among transects (marginally sig)


m.3 <- lmer(Ramets_midJune ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
car::Anova(m.3)
# YES amnog transects (marginally sig)


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneRamets_urban_lmer_PVE.csv",
            col.names=TRUE, sep=",")
write.table(variances1,
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneRamets_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneRamets_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Sept ramets
#### lmer
##### Entire gradient: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F)
#  singular

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))
# distance not significant


### CROSSED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance not  significant

r.squaredGLMM(lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))

# ANy variation within families or populations?
m.1 <- lmer(Ramets_Sept ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families

sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptRamets_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptRamets_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
#  singular...

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# not significant


### CROSSED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# not significant

r.squaredGLMM(lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))

```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Ramets_Sept ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families

m.2 <- lmer(Ramets_Sept ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects though


m.3 <- lmer(Ramets_Sept ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptRamets_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",")
write.table(variances1,
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptRamets_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptRamets_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
```


###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```

## Herbivory
### Sept
#### lmer
##### Entire gradient: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herb_2019, REML = F)
# is singular...

car::Anova(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herb_2019, REML = F))
# nothing is significant

r.squaredGLMM(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herb_2019, REML = F))
  

### CROSSED RANDOM EFFECTS-----
lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herb_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
#  singular

car::Anova(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herb_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance not significant



# ANy variation within families or populations?
m.1 <- lmer(Herbivory_mean_Sept ~ (1|Population/Family), data = herb_2019, REML = T,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_HerbivorySept_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_HerbivorySept_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herb_2019, REML = F)
# is singular...

car::Anova(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herb_2019, REML = F))
# nothing is significant

r.squaredGLMM(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herb_2019, REML = F))
  

### CROSSED RANDOM EFFECTS-----
lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herb_2019, REML = F)
#  singular

car::Anova(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herb_2019, REML = F))
#  not significant


```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothingsignificant


# Just main effects
car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing is significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# NOT singular...

car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing is significant


# Just main effects
car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing is significant


AIC(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though main effects model has lower AIC


# ANy variation among families or populations?
m.1 <- lmer(Herbivory_mean_Sept ~ (1|Population/Family), data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Herbivory_mean_Sept ~ (1|Population/Family) + Transect_ID, data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects either


m.3 <- lmer(Herbivory_mean_Sept ~ (1|Population/Family) + Transect_ID, data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_HerbivorySept_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1,
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_HerbivorySept_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_HerbivorySept_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# NOT singular...

car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing significant


AIC(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though main effects model has lower AIC

```



## Survival
### glmer
#### Entire gradient: *Nothing sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Population/Family) + City_dist,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# CONVERGES when I set nAGQ to 0

car::Anova(glmer(Dead ~ (1|Block) + (1|Population/Family) + City_dist,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Population:Family) + City_dist,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# no problems


car::Anova(glmer(Dead ~ (1|Block) + (1|Population:Family) + City_dist,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant

```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# CONVERGES when I set nAGQ to 0

car::Anova(glmer(Dead ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# no problems


car::Anova(glmer(Dead ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


```


#### Urban subtransects: *interaxn sig for city_dist when crossed; nothing sig for urb_score
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# no problems!

car::Anova(glmer(Dead  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# interaxn marg significant


# Just main effects
car::Anova(glmer(Dead  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings

car::Anova(glmer(Dead  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# interaxn is significant



AIC(glmer(Dead  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(Dead  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC >2 apart; full model is "best model"
```


##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# no problems!

car::Anova(glmer(Dead  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Dead  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings

car::Anova(glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
                 family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


AIC(glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC <2 apart; both "best models" though full model lower AIC
```


# Statistics: 2020
## reproductive
### Plants that flowered
#### Flowering success
##### Sig difference between urb vs rural? (Odds ratio)
```{r}
# # How many plants flowered per subtransect? using 2019 alive plants
# tib1 <- reproductive %>%
#   filter(Alive_DC1 != '0')%>%
#   group_by(Flowered2020, Urb_Rur) %>%
#   tally()
# tib1
# 
# 
# Flowered_ttest <- matrix(c(21, 3, 556, 282), nrow = 2,
#                          dimnames = list(
#                            c("Urban", "Rural"),
#                            c("Flowered", "Didn't Flower")))
# 
# fisher.test(Flowered_ttest, alternative = "two.sided")
# # odds ratio = 3.5464
# # p = 0.02859
# # medium effect size


# How many plants flowered per subtransect? using 2020 alive plants
reproductive <- anti_join(reproductive, dead_2020, by = c("Row", "Column"))

tib2 <- reproductive %>%
  group_by(Flowered2020, Urb_Rur) %>%
  tally()
tib2


Flowered_ttest2 <- matrix(c(
  as.integer(tib2[3,3]),
  as.integer(tib2[4,3]),
  as.integer(tib2[1,3]),
  as.integer(tib2[2,3])),
  nrow = 2,
  dimnames = list(
    c("Urban", "Rural"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest2, alternative = "two.sided")
# odds ratio = 3.5148
# p = 0.0445
# medium effect size

chisq.test(Flowered_ttest2)
# X-squared = 3.7416, df = 1, p-value = 0.05307





# How many populations had at least one plant flower per subtransect? using 2020 alive plants
reproductive <- anti_join(reproductive, dead_2020, by = c("Row", "Column"))

tib3 <- reproductive[,c(1:6, 78:86)] %>%
  group_by(Population, Flowered2020, Urb_Rur) %>%
  dplyr::summarise(Pops = n_distinct(Population),
                   Urb_Rur = first(Urb_Rur)) %>%
  group_by(Population, Urb_Rur) %>%
  dplyr::summarise(Flowered = sum(as.integer(Flowered2020)),
                   Urb_Rur = first(Urb_Rur)) %>%
  group_by(Urb_Rur, Flowered) %>%
  dplyr::summarise(Pops = n_distinct(Population))
  
tib3
# Flowered = 1: Didn't flower
# Flowered = 3: Did flower



Flowered_ttest3 <- matrix(c(
  as.integer(tib3[2,3]),
  as.integer(tib3[4,3]),
  as.integer(tib3[3,3]),
  as.integer(tib3[2,3])),
  nrow = 2,
  dimnames = list(
    c("Urban", "Rural"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest3, alternative = "two.sided")
# odds ratio = 3.5750
# p = 0.1006 (NOT SIGNIFICANT; CAN'T REJECT NULL)
# medium effect size


chisq.test(Flowered_ttest3)
# X-squared = 2.0551, df = 1, p-value = 0.1517
```



##### Sig difference between urb:north vs urb:south? (Odds ratio)
```{r}
# How many plants flowered per subtransect? using 2020 alive plants
reproductive <- anti_join(reproductive, dead_2020, by = c("Row", "Column"))

tib4 <- reproductive %>%
  filter(., Transect_ID != 'Rural') %>%
  group_by(Flowered2020, Transect_ID) %>%
  tally()
tib4


Flowered_ttest4 <- matrix(c(
  as.integer(tib4[3,3]),
  as.integer(tib4[4,3]),
  as.integer(tib4[1,3]),
  as.integer(tib4[2,3])),
  nrow = 2,
  dimnames = list(
    c("North", "South"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest4, alternative = "two.sided")
# odds ratio = 0.7970 (inverted = 1.2547)
# p = 0.6618 (CAN'T REJECT THE NULL)
# negligible effect size

chisq.test(Flowered_ttest4)
# X-squared = 0.081128, df = 1, p-value = 0.7758






# How many populations had at least one plant flower per subtransect? using 2020 alive plants
reproductive <- anti_join(reproductive, dead_2020, by = c("Row", "Column"))

tib5 <- reproductive[,c(1:6, 78:86)] %>%
  filter(., Transect_ID != "Rural") %>%
  group_by(Population, Flowered2020, Transect_ID) %>%
  dplyr::summarise(Pops = n_distinct(Population),
                   Transect_ID = first(Transect_ID)) %>%
  group_by(Population, Transect_ID) %>%
  dplyr::summarise(Flowered = sum(as.integer(Flowered2020)),
                   Transect_ID = first(Transect_ID)) %>%
  group_by(Transect_ID, Flowered) %>%
  dplyr::summarise(Pops = n_distinct(Population))
  
tib5
# Flowered = 1: Didn't flower
# Flowered = 3: Did flower



Flowered_ttest5 <- matrix(c(
  as.integer(tib5[2,3]),
  as.integer(tib5[4,3]),
  as.integer(tib5[3,3]),
  as.integer(tib5[2,3])),
  nrow = 2,
  dimnames = list(
    c("North", "South"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest5, alternative = "two.sided")
# odds ratio = 0.4737 (reciprocal = 2.1110)
# p = 0.4521 (NOT SIGNIFICANT; CAN'T REJECT NULL)
# small effect size

chisq.test(Flowered_ttest5)
# X-squared = 0.41878, df = 1, p-value = 0.5175
```


##### Block effect?
```{r}
glmer(Flowered2020 ~ Block + (1|Population/Family),
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=1,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

car::Anova(glmer(Flowered2020 ~ Block + (1|Population/Family),
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=1,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# Block is significant, so yes, the number of plants that flowered DID significantly vary by block.

summary(glmer(Flowered2020 ~ Block + (1|Population/Family),
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=1,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
```

#### Flower count
##### Mean flower count/inflorescence
###### Sig difference along gradient?
####### lmer: **YES: Both city_dist and urb_score significant
######## City_dist
```{r}
### NESTED RANDOM EFFECTS-----
flowercount_2020_lmer_gradient <- lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + City_dist, REML = F,data = flowering_2020)
# is singular

# ANOVA
car::Anova(flowercount_2020_lmer_gradient)
# distance is sig

library(MuMIn)
r.squaredGLMM(flowercount_2020_lmer_gradient)


### CROSSED RANDOM EFFECTS-----
lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, REML = F)
# singular

car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, REML = F))
# distance is sig


# ANy variation among families or populations?
ranova(lmer(mean_flower_count ~ (1|Population/Family), data = flowering_2020, REML = T))
# no... is singular
```

######## Urb_score
```{r}
### NESTED RANDOM EFFECTS-----
flowercount_2020_lmer_gradient_urbscore <- lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020, REML = F)
# is singular

# ANOVA
car::Anova(flowercount_2020_lmer_gradient_urbscore)
# sig

library(MuMIn)
r.squaredGLMM(flowercount_2020_lmer_gradient_urbscore)


### CROSSED RANDOM EFFECTS-----
lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, REML = F)
# singular

car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, REML = F))
#  sig

```

###### Sig difference btwn urban subtransects?
####### lmer: *NO: Nothing sig for city_dist or urb_score
######## City_dist
```{r}
### NESTED RANDOM EFFECTS-----
flowercount_2020_lmer_subtr <- lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(flowercount_2020_lmer_subtr)
# nothing sig
AIC(flowercount_2020_lmer_subtr)

car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# nothing sig

r.squaredGLMM(flowercount_2020_lmer_subtr)
# is this worth doing, since I have two regression lines?

AIC(lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# nothing sig


car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# nothing sig



# ANy variation among families or populations?
ranova(lmer(mean_flower_count ~ (1|Population/Family), data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = T))
# no... is singular
car::Anova(lmer(mean_flower_count ~ (1|Population/Family) + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# no... is singular

```
######## Urb_score
```{r}
### NESTED RANDOM EFFECTS-----
flowercount_2020_lmer_subtr_urbscore <- lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(flowercount_2020_lmer_subtr_urbscore)
# nothing sig
AIC(flowercount_2020_lmer_subtr_urbscore)

car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# nothing sig

r.squaredGLMM(flowercount_2020_lmer_subtr_urbscore)
# is this worth doing, since I have two regression lines?

AIC(lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# nothing sig


car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# nothing sig

```

##### Total flower count
###### Sig difference along gradient?
####### glmer: *Marginally sig for city_dist, insig for urb_score
######## City_dist
```{r}
### nested RANDOM EFFECTS-----
flowercountsum_2020_glmer_gradient <- glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, family = 'poisson')
# is singular...


# ANOVA
car::Anova(flowercountsum_2020_glmer_gradient)
# distance is marginally sig

r.squaredGLMM(flowercountsum_2020_glmer_gradient)


### CROSSED RANDOM EFFECTS-----
glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, family = 'poisson')
# NOT singular!


# ANOVA
car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, family = 'poisson')
)
# distance is marginally sig




# ANy variation among families or populations?
# ranova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, family = 'poisson'))
```

######## Urb_score
```{r}
### nested RANDOM EFFECTS-----
flowercountsum_2020_glmer_gradient_urbscore <- glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020, family = 'poisson')
# is singular...


# ANOVA
car::Anova(flowercountsum_2020_glmer_gradient_urbscore)
# not sig

r.squaredGLMM(flowercountsum_2020_glmer_gradient_urbscore)


### CROSSED RANDOM EFFECTS-----
glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, family = 'poisson')
# NOT singular!


# ANOVA
car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, family = 'poisson')
)
# not sig

```

###### Sig difference btwn urban subtransects?
####### glmer: *NO for both city_dist & urb_score
######## City_dist
```{r}
### NESTED RANDOM EFFECTS-----
flowercountsum_2020_glmer_subtr <- glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
                                     data = flowering_2020 %>% filter(Transect_ID != "Rural"))
# singular

# ANOVA
car::Anova(flowercountsum_2020_glmer_subtr)
AIC(flowercountsum_2020_glmer_subtr)
# nothing sig


car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig

car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig



### CROSSED RANDOM EFFECTS-----
glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
# singular

# ANOVA
car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
AIC(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
# nothing sig


car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
# nothing sig
AIC(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)

```

######## Urb_score
```{r}
### NESTED RANDOM EFFECTS-----
flowercountsum_2020_glmer_subtr_urbscore <- glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
                                     data = flowering_2020 %>% filter(Transect_ID != "Rural"),
                                     family = poisson)
# singular

# ANOVA
car::Anova(flowercountsum_2020_glmer_subtr_urbscore)
AIC(flowercountsum_2020_glmer_subtr_urbscore)
# nothing sig


car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"),
                                     family = poisson))
# nothing sig

car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"),
                                     family = poisson))
# nothing sig



### CROSSED RANDOM EFFECTS-----
glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"),
                                     family = poisson)
# NOT singular

# ANOVA
car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"),
                                     family = poisson)
)
AIC(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"),
                                     family = poisson)
)
# nothing sig


car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"),
                                     family = poisson)
)
# nothing sig
AIC(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"),
                                     family = poisson)
)

```


#### Flower size
##### Mean flower size/inflorescence
###### lmer
####### gradient: *NOt sig for either city_dist or urb_score
######## City_dist
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, REML = F)
# is singular

# ANOVA
car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, REML = F)
)
# distance not sig

library(MuMIn)
r.squaredGLMM(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, REML = F)
)


### CROSSED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, REML = F)
# singular

car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, REML = F))
# distance not sig


# ANy variation among families or populations?
ranova(lmer(Overall_mean ~ (1|Population/Family), data = flowering_2020, REML = T))
# no
```


######## Urb_score
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020,
     REML = F, lmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# singular

# ANOVA
car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020, REML = F)
)
# not sig

library(MuMIn)
r.squaredGLMM(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020, REML = F)
)


### CROSSED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, REML = F)
# singular

car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, REML = F))
# urb_score not sig

```

####### urban subtransects: *Main effects sig for both; interaxn sig for city_dist (marg sig for urb_score)
######## City_dist
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# remove block?
lmer(Overall_mean ~ (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# main effects and interaxn sig

car::Anova(lmer(Overall_mean ~  (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# still singular,  everything  sig

AIC(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)

car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# both main effects sig

r.squaredGLMM(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# very high r-sq...is this worth doing, since I have two regression lines?

AIC(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# NOT singular

# ANOVA
car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# everything sig


car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# main effects sig



# ANy variation among families or populations?
ranova(lmer(Overall_mean ~ (1|Population/Family), data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = T))
# no
car::Anova(lmer(Overall_mean ~ (1|Population/Family) + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# YES... variance DOES differ by subtransect... is singular

```
######## Urb_score
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# remove block?
lmer(Overall_mean ~ (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# main effects sig

car::Anova(lmer(Overall_mean ~  (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# still singular, main effects sig

AIC(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)

car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# both main effects sig

r.squaredGLMM(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# very high r-sq...is this worth doing, since I have two regression lines?

AIC(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# main effects sig


car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# main effects sig

```

#### Pods
##### lmer
###### gradient: *NOt sig for either city_dist or urb_score
####### City_dist
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Pods ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, REML = F)
# is singular

# ANOVA
car::Anova(lmer(Pods ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, REML = F)
)
# distance not sig

r.squaredGLMM(lmer(Pods ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, REML = F)
)


### CROSSED RANDOM EFFECTS-----
lmer(Pods ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, REML = F)
# singular

car::Anova(lmer(Pods ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, REML = F))
# distance not sig


# ANy variation among families or populations?
ranova(lmer(Pods ~ (1|Population/Family), data = flowering_2020, REML = T))
# no
```


####### Urb_score
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Pods ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020,
     REML = F, lmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# singular

# ANOVA
car::Anova(lmer(Pods ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020, REML = F)
)
# not sig

r.squaredGLMM(lmer(Pods ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020, REML = F)
)


### CROSSED RANDOM EFFECTS-----
lmer(Pods ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, REML = F)
# singular

car::Anova(lmer(Pods ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, REML = F))
# urb_score not sig

```

###### urban subtransects: *Main effects marg sig for city_dist; nothing sig for urb_score)
####### City_dist
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Pods ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# remove block?
lmer(Pods ~ (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(Pods ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# main effects marg sig

car::Anova(lmer(Pods ~  (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# still singular, main effects marg  sig

AIC(lmer(Pods ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)

car::Anova(lmer(Pods ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# both main effects marg sig

r.squaredGLMM(lmer(Pods ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# very high r-sq...is this worth doing, since I have two regression lines?

AIC(lmer(Pods ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(Pods ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
#  singular

# ANOVA
car::Anova(lmer(Pods ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# main effects marg sig


car::Anova(lmer(Pods ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# main effects marg sig



# ANy variation among families or populations?
ranova(lmer(Pods ~ (1|Population/Family), data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = T))
# no
car::Anova(lmer(Pods ~ (1|Population/Family) + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# no ...variance doesn't differ by subtransect

```
####### Urb_score
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Pods ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# remove block?
lmer(Pods ~ (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(Pods ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# nothing sig

car::Anova(lmer(Pods ~  (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# still singular,nothing sig

AIC(lmer(Pods ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)

car::Anova(lmer(Pods ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# both main effects NOT sig

r.squaredGLMM(lmer(Pods ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)

AIC(lmer(Pods ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(Pods ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(Pods ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# nothing sig

car::Anova(lmer(Pods ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# nothing sig

```

#### Peduncles (Inflorescences)
##### lmer
###### gradient: *NOt sig for either city_dist or urb_score
####### City_dist
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Peduncles ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, REML = F)
# is singular

# ANOVA
car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, REML = F)
)
# distance not sig

r.squaredGLMM(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, REML = F)
)


### CROSSED RANDOM EFFECTS-----
lmer(Peduncles ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, REML = F)
# singular

car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, REML = F))
# distance not sig


# ANy variation among families or populations?
ranova(lmer(Peduncles ~ (1|Population/Family), data = flowering_2020, REML = T))
# no
```


####### Urb_score
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Peduncles ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020,
     REML = F, lmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# singular

# ANOVA
car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020, REML = F)
)
# not sig

r.squaredGLMM(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + Urb_score, data = flowering_2020, REML = F)
)


### CROSSED RANDOM EFFECTS-----
lmer(Peduncles ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, REML = F)
# singular

car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population:Family) + Urb_score, data = flowering_2020, REML = F))
# urb_score not sig

```

###### urban subtransects: *nothing sig for city_dist (transect marg sig when interaction included but becomes non-sig when only main effects present); transect marg sig for urb_score)
####### City_dist
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Peduncles ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# remove block?
lmer(Peduncles ~ (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# transect marg sig

car::Anova(lmer(Peduncles ~  (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# still singular, transect marg  sig

AIC(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)

car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# nothing sig

r.squaredGLMM(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)

AIC(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(Peduncles ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
#  singular

# ANOVA
car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# transect marg sig


car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# nothing sig



# ANy variation among families or populations?
ranova(lmer(Peduncles ~ (1|Population/Family), data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = T))
# no
car::Anova(lmer(Peduncles ~ (1|Population/Family) + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# no ...variance doesn't differ by subtransect

```
####### Urb_score
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Peduncles ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# remove block?
lmer(Peduncles ~ (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# transect is marg sig

car::Anova(lmer(Peduncles ~  (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# still singular, transect marg sig

AIC(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)

car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# transect marg sig

r.squaredGLMM(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)

AIC(lmer(Peduncles ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(Peduncles ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
# is singular

# ANOVA
car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# transect marg sig

car::Anova(lmer(Peduncles ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F)
)
# transect marg sig

```


### All plants
#### Regressions (is urbanization related to flowering?)
##### glmer
###### Entire gradient: *Nothing sig for either
####### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
glmer(Flowered2020 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=0)

car::Anova(glmer(Flowered2020 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=0))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(Flowered2020 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=0)

car::Anova(glmer(Flowered2020 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=0))
# nothing significant


# ranova(glmer(Flowered2020 ~ (1|Population/Family), data = reproductive, REML = T, family = binomial(link = "logit")))

# ranova(lmer(Flowered2020 ~ (1|Population/Family), data = reproductive, REML = T))
```

####### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
glmer(Flowered2020 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=0)

car::Anova(glmer(Flowered2020 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=0))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(Flowered2020 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=0)

car::Anova(glmer(Flowered2020 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=0))
# nothing significant

```

###### Urban subtransects: *Nothing sig for either
####### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Flowered2020  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# is singular w/the glmerControl added; doesn't converge without it!

car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings!!

car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
                 family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


AIC(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
                 data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC <2 apart; both "best models" though just main effects lower AIC
```

####### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Flowered2020  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# is singular w/the glmerControl added; doesn't converge without it!

car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings!!

car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
  data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),
                 family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


AIC(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
                 data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = reproductive %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC <2 apart; both "best models" though just main effects lower AIC
```


## Heights
### June height
#### lmer
##### Entire gradient: *Sig for city_dist, not for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F)
# is singular...

car::Anova(lmer(Total_Height_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F))
# distance is significant


r.squaredGLMM(lmer(Total_Height_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_June ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_June ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F))
# distance is significant




# ANy variation within families or populations?
m.1 <- lmer(Total_Height_June ~ (1|Population/Family), data = heights_both_2020, REML = T)

ranova(m.1)
# YES for within families
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_June ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F)
# is singular...

car::Anova(lmer(Total_Height_June ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F))
# nothing significant


r.squaredGLMM(lmer(Total_Height_June ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_June ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_June ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F))
# nothing significant

```

##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_June  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_June ~ (1|Population/Family), data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families

m.2 <- lmer(Total_Height_June ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects though


m.3 <- lmer(Total_Height_June ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_June  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Sept height
#### lmer
##### Entire gradient: *Sig for city_dist, not for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F)
# NOT singular

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F))
# distance is significant


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F))
# distance is  significant

r.squaredGLMM(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F))

# ANy variation within families or populations?
m.1 <- lmer(Total_Height_Sept ~ (1|Population/Family), data = heights_both_2020, REML = T)

ranova(m.1)
# YES for among families (marginally sig)
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F)
# is singular...

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F))
# not significant


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F))
# not significant

r.squaredGLMM(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F))

```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_Sept ~ (1|Population/Family), data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families (marg sig)

m.2 <- lmer(Total_Height_Sept ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects though


m.3 <- lmer(Total_Height_Sept ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```


###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```



## Weevil scars: standardized by June height
### lmer
#### Entire gradient: *Not sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(scar_div_Juneheight ~ (1|Block) + (1|Population/Family) + City_dist,
  data = weevil_both, REML = F)
# is singular...

car::Anova(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population/Family) + City_dist,
  data = weevil_both, REML = F))
# nothing significant


### CROSSED RANDOM EFFECTS-----
lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F)
# NOT singular!

car::Anova(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))
# nothing significant
summary(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))


r.squaredGLMM(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))


# ANy variation within families or populations?
m.1 <- lmer(scar_div_Juneheight ~ (1|Population/Family), data = weevil_both, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(scar_div_Juneheight ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = weevil_both, REML = F)
# is singular...

car::Anova(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = weevil_both, REML = F))
# nothing significant


### CROSSED RANDOM EFFECTS-----
lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = weevil_both, REML = F)
# NOT singular!

car::Anova(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = weevil_both, REML = F))
# nothing significant
summary(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = weevil_both, REML = F))


r.squaredGLMM(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = weevil_both, REML = F))


```


#### Urban subtransects: *Not sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# is singular

car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best model"



# ANy variation among families or populations?
m.1 <- lmer(scar_div_Juneheight ~ (1|Population/Family), data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no, is singular

m.2 <- lmer(scar_div_Juneheight ~ (1|Population/Family) + Transect_ID, data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects though


m.3 <- lmer(scar_div_Juneheight ~ (1|Population/Family) + Transect_ID, data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# is singular

car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# No warnings!!

car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


AIC(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))

AIC(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best model"

```


## Weevil scars: NOT standardized by June height
### lmer
#### Entire gradient: *NOt sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Scar_length_cm ~ (1|Block) + (1|Population/Family) + City_dist,
  data = weevil_both, REML = F)
# NOT singular

car::Anova(lmer(Scar_length_cm ~ (1|Block) + (1|Population/Family) + City_dist,
  data = weevil_both, REML = F))
# nothing significant


### CROSSED RANDOM EFFECTS-----
lmer(Scar_length_cm ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F)
# NOT singular

car::Anova(lmer(Scar_length_cm ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))
# nothing significant


r.squaredGLMM(lmer(Scar_length_cm ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))

# ANy variation within families or populations?
m.1 <- lmer(Scar_length_cm ~ (1|Population/Family), data = weevil_both, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Scar_length_cm ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = weevil_both, REML = F)
# NOT singular

car::Anova(lmer(Scar_length_cm ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = weevil_both, REML = F))
# nothing significant


### CROSSED RANDOM EFFECTS-----
lmer(Scar_length_cm ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = weevil_both, REML = F)
# NOT singular

car::Anova(lmer(Scar_length_cm ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = weevil_both, REML = F))
# nothing significant


r.squaredGLMM(lmer(Scar_length_cm ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = weevil_both, REML = F))

```


#### Urban subtransects: *Transect and interaxn marg sig for city_dist; nothing sig for urb_score
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Scar_length_cm  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
#  singular

car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect and interaxn are marg significant


# Just main effects
car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings

car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect and interaxn marg significant


# Just main effects
car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect marg significant


AIC(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best model"




# ANy variation among families or populations?
m.1 <- lmer(Scar_length_cm ~ (1|Population/Family), data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Scar_length_cm ~ (1|Population/Family) + Transect_ID, data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects either


m.3 <- lmer(Scar_length_cm ~ (1|Population/Family) + Transect_ID, data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Scar_length_cm  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# NOT singular

car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings

car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best model"
```


## Herbivores: RDA
### Examine herbivore distributions
```{r}
library(purrr)
library(tidyr)
library(ggplot2)

herbivores2020_popmeans %>%
dplyr::select(., c(3:13)) %>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram(bins = 20)
# few vars normally distributed


# Aphis asclepiadis
a.ascl_lm <- lm(mean_Aphis_asclepiadis ~ City_dist, herbivores2020_popmeans)
gg_reshist(lm(a.ascl_lm), bins = 20)
diagnostic(residuals(a.ascl_lm))
# definitely transform... very right-skewed

# cube root
par(mfrow=c(2,2))
diagnostic(residuals(lm(mean_Aphis_asclepiadis^(1/3) ~ City_dist, herbivores2020_popmeans)))
gg_reshist(lm(mean_Aphis_asclepiadis^(1/3) ~ City_dist, herbivores2020_popmeans), bins = 20)


# log
par(mfrow=c(2,2))
diagnostic(residuals(lm(log(mean_Aphis_asclepiadis + 1) ~ City_dist, herbivores2020_popmeans)))
gg_reshist(lm(log(mean_Aphis_asclepiadis + 1) ~ City_dist, herbivores2020_popmeans), bins = 20)

manova(cbind(Sepal.Length, Petal.Length) ~ Species, data = iris)
```

### RDA
```{r}

herbpopMeansJuly_PCA <- prcomp(as.matrix(herbivores2020_popmeansJuly[,c(4:15)]))
summary(herbpopMeansJuly_PCA) # 17.3% variation explained by PC1

herbpopMeansAug_PCA <- prcomp(as.matrix(herbivores2020_popmeansAug[,c(4:15)]))
summary(herbpopMeansAug_PCA) # 18.4% variation explained by PC1

# trait_loadings <- herbpopMeansAug_PCA$rotation[,'PC1']






hist(herbivores$Lygaeus_kalmii)

glmer(City_dist ~  (1|Block) + (1|Sample) + (1|Population/Family) + Lygaeus_kalmii,
  data = herbivores, family = 'poisson')


# JULY
herbivores2020_popmeansJuly <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July')

rda_herb_July <- rda(herbivores2020_popmeansJuly %>%
                        dplyr::select(, c(4:14)) ~ herbivores2020_popmeansJuly$City_dist,
                na.action = "na.omit",
                scale = T)

summary(rda_herb_July)
anova(rda_herb_July)
screeplot(rda_herb_July)

RsquareAdj(rda_herb_July)


plot(rda_herb_July, type='n', scaling=1)
orditorp(rda_herb_July, display='sp', cex=0.5, scaling=1, col='blue')
text(rda_herb_July, display='cn', col='red')






# AUGUST
herbivores2020_popmeansAug <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August')

rda_herb_August <- rda(herbivores2020_popmeansAug %>%
                        dplyr::select(, c(4:14)) ~ herbivores2020_popmeansAug$City_dist,
                na.action = "na.omit",
                scale = TRUE)

summary(rda_herb_August)
rda_herb_August

RsquareAdj(rda_herb_August)


plot(rda_herb_August, type='n', scaling=1)
orditorp(rda_herb_August, display='sp', cex=0.5, scaling=1, col='blue')
text(rda_herb_August, display='cn', col='red')
```

## Herbivory
### July
#### lmer
##### Entire gradient: *Sig for City_dist, not urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory.July_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_2020, REML = F)
# is singular...

car::Anova(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_2020, REML = F))
# distance is significant


### CROSSED RANDOM EFFECTS-----
lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_2020, REML = F)
# NOT singular!

car::Anova(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_2020, REML = F))
# distance is significant

summary(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_2020, REML = F))


r.squaredGLMM(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_2020, REML = F))



# ANy variation within families or populations?
m.1 <- lmer(Herbivory.July_mean ~ (1|Population/Family), data = herbivory_both_2020, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory.July_mean ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herbivory_both_2020, REML = F)
# is singular...

car::Anova(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herbivory_both_2020, REML = F))
# not significant


### CROSSED RANDOM EFFECTS-----
lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herbivory_both_2020, REML = F)
#  singular

car::Anova(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herbivory_both_2020, REML = F))
# not significant

summary(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herbivory_both_2020, REML = F))


r.squaredGLMM(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herbivory_both_2020, REML = F))

```


##### Urban subtransects: *Sig for city_dist, not urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance is significant


# Just main effects
car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... distance is significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

lmer(Herbivory.July_mean  ~ (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

lmer(Herbivory.July_mean  ~ (1|Population:Family) + Block + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

# try making a unique family identifier and removing pop
trial1 <- herbivory_both_2020 %>%
  dplyr::filter(., Transect_ID != "Rural") %>%
  unite("Family_Unique", c(Population,Family), remove = FALSE)

lmer(Herbivory.July_mean  ~ (1|Family_Unique) + Transect_ID,
     data = trial1, REML = F)
# still singular, even with block and distance removed...



car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance is significant


# Just main effects
car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... distance is significant


AIC(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though full model has lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Herbivory.July_mean ~ (1|Population/Family), data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Herbivory.July_mean ~ (1|Population/Family) + Transect_ID, data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects either


m.3 <- lmer(Herbivory.July_mean ~ (1|Population/Family) + Transect_ID, data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

lmer(Herbivory.July_mean  ~ (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

lmer(Herbivory.July_mean  ~ (1|Population:Family) + Block + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

# try making a unique family identifier and removing pop
trial1 <- herbivory_both_2020 %>%
  dplyr::filter(., Transect_ID != "Rural") %>%
  unite("Family_Unique", c(Population,Family), remove = FALSE)

lmer(Herbivory.July_mean  ~ (1|Family_Unique) + Transect_ID,
     data = trial1, REML = F)
# still singular, even with block and distance removed...



car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing significant


AIC(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though full model has lower AIC

```


### Sept
#### lmer
##### Entire gradient: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_2020, REML = F)
# is singular...

car::Anova(lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_2020, REML = F))
# nothing is significant

r.squaredGLMM(lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_2020, REML = F))
  

### CROSSED RANDOM EFFECTS-----
lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_2020, REML = F)
# NOT singular!

car::Anova(lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_2020, REML = F))
# distance not significant



# ANy variation within families or populations?
m.1 <- lmer(Herbivory.Sept_mean ~ (1|Population/Family), data = herbivory_both_2020, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herbivory_both_2020, REML = F)
# is singular...

car::Anova(lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herbivory_both_2020, REML = F))
# nothing is significant

r.squaredGLMM(lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herbivory_both_2020, REML = F))
  

### CROSSED RANDOM EFFECTS-----
lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herbivory_both_2020, REML = F)
#  singular

car::Anova(lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herbivory_both_2020, REML = F))
#  not significant


```


##### Urban subtransects: *Sig for city_dist, not urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance is significant


# Just main effects
car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... distance is significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance is significant


# Just main effects
car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... distance is significant


AIC(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though main effects model has lower AIC


# ANy variation among families or populations?
m.1 <- lmer(Herbivory.Sept_mean ~ (1|Population/Family), data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Herbivory.Sept_mean ~ (1|Population/Family) + Transect_ID, data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects either


m.3 <- lmer(Herbivory.Sept_mean ~ (1|Population/Family) + Transect_ID, data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing significant


AIC(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herbivory_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though main effects model has lower AIC

```


## Growth Rate
### lmer
#### Entire gradient: *Not sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F)
# is singular...

lmer(rel_growth_rate ~ (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F)
# still singular


car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F))
# not significant


r.squaredGLMM(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F)
#  singular

lmer(rel_growth_rate ~ (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F)
#  singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F))
# not sig



# ANy variation within families or populations?
m.1 <- lmer(rel_growth_rate ~ (1|Population/Family), data = heights_both_2020, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F)
# is singular...

lmer(rel_growth_rate ~ (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F)
# still singular


car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F))
# not significant


r.squaredGLMM(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F)
#  singular

lmer(rel_growth_rate ~ (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F)
#  singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F))
# not sig

```


#### Urban subtransects: *Not sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

lmer(rel_growth_rate  ~ (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing sig


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular, nothing sig



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

lmer(rel_growth_rate  ~ (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# NOT singular!


car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant

car::Anova(lmer(rel_growth_rate  ~ (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing sig

car::Anova(lmer(rel_growth_rate  ~ (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# NOT SINGULAR!  nothing sig


AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC >2 apart; just main effects lower AIC = best model





# ANy variation among families or populations?
m.1 <- lmer(rel_growth_rate ~ (1|Population/Family), data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(rel_growth_rate ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects either


m.3 <- lmer(rel_growth_rate ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

lmer(rel_growth_rate  ~ (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing sig


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular, nothing sig



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

lmer(rel_growth_rate  ~ (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# NOT singular!


car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant

car::Anova(lmer(rel_growth_rate  ~ (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing sig

car::Anova(lmer(rel_growth_rate  ~ (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# NOT SINGULAR!  nothing sig


AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC >2 apart; just main effects lower AIC = best model

```


## Number of Ramets
### June ramets
#### lmer
##### Entire gradient: *Nothing sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# no warning!

car::Anova(lmer(Ramets_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


r.squaredGLMM(lmer(Ramets_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))

### CROSSED RANDOM EFFECTS-----
lmer(Ramets_June ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# NOT singular!

car::Anova(lmer(Ramets_June ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


# Any variation within families or populations?
m.1 <- lmer(Ramets_June ~ (1|Population/Family), data = heights_both_2020, REML = T)

ranova(m.1)
# YES- marg sig among families
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_June ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# no warning!

car::Anova(lmer(Ramets_June ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


r.squaredGLMM(lmer(Ramets_June ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))

### CROSSED RANDOM EFFECTS-----
lmer(Ramets_June ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# NOT singular!

car::Anova(lmer(Ramets_June ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant

```


##### Urban subtransects: *Nothing sig for city_dist; urb_score sig and transect marg sig
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_June  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# No warnings!!

car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


AIC(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))

AIC(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Ramets_June ~ (1|Population/Family), data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Ramets_June ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects 


m.3 <- lmer(Ramets_June ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_June  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# urb_score significant, transect marg sig


# Just main effects
car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
#  urb_score significant, transect marg sig



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# No warnings!!

car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
#  urb_score significant, transect marg sig


# Just main effects
car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# urb_score significant, transect marg sig
# 
summary(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))


AIC(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))

AIC(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best models" though just main effects lower AIC
```


### Sept ramets
#### lmer
##### Entire gradient: *Sig for city_dist, not for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F)
# is singular...

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F))
# distance is significant


r.squaredGLMM(lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both_2020, REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
#  singular

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both_2020, REML = F), control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# distance is significant


# ANy variation within families or populations?
m.1 <- lmer(Ramets_Sept ~ (1|Population/Family), data = heights_both_2020, REML = T)

ranova(m.1)
# no
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F)
# is singular...

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F))
# not significant


r.squaredGLMM(lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_both_2020, REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
#  singular

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_both_2020, REML = F), control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# not significant


```


##### Urban subtransects: *Sig for city_dist, not for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance significant


AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Ramets_Sept ~ (1|Population/Family), data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Ramets_Sept ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
car::Anova(m.2)
# not among transects 


m.3 <- lmer(Ramets_Sept ~ (1|Population/Family) + Transect_ID, data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```


###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_both_2020 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```

## Survival
### glmer
#### Entire gradient: *Nothing sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(dead_2020 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = survival_2020,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# CONVERGES when I set nAGQ to 0

car::Anova(glmer(dead_2020 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = survival_2020,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(dead_2020 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = survival_2020,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# no problems


car::Anova(glmer(dead_2020 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = survival_2020,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant




# ranova(glmer(Flowered2020 ~ (1|Population/Family), data = reproductive, REML = T, family = binomial(link = "logit")))

# ranova(lmer(Flowered2020 ~ (1|Population/Family), data = reproductive, REML = T))
```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(dead_2020 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = survival_2020,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# CONVERGES when I set nAGQ to 0

car::Anova(glmer(dead_2020 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = survival_2020,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(dead_2020 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = survival_2020,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# no problems


car::Anova(glmer(dead_2020 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = survival_2020,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


```


#### Urban subtransects: *Nothing sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(dead_2020  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# no problems!

car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings

car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
                 family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


AIC(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
                 data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC <2 apart; both "best models" though just main effects lower AIC
```


##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(dead_2020  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# no problems!

car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings

car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
                 family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


AIC(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
                 data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC <2 apart; both "best models" though just main effects lower AIC
```



# Statistics: 2019-2020
## Heights
### Mid June height
#### lmer
##### Entire gradient: *dist not sig for both
###### City_dist
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# dist not significant


r.squaredGLMM(lmer(Total_Height_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Year) +(1|Population:Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
#  singular

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Year) +(1|Population:Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# dist not significant


```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score ,
  data = heights_19_20, REML = F)
# singular

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score ,
  data = heights_19_20, REML = F))
# dist not significant

r.squaredGLMM(lmer(Total_Height_midJune ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score ,
  data = heights_19_20, REML = F))



### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Year) +(1|Population:Family) + Urb_score ,
  data = heights_19_20, REML = F)
#  singular

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Year) +(1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F))
# dist not significant
```

##### Urban subtransects: *transect sig
###### City_dist
```{r}
### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular, transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population:Family) + City_dist + Transect_ID, 
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best models" though just main effects lower AIC

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population:Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Sept height
#### lmer
##### Entire gradient: *sig for city_dist, not for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F,
           control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
#  singular

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F,
           control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance IS significant


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F))
# distance IS  significant

r.squaredGLMM(lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F))

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) +(1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F,
           control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# not singular...

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F,
           control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# not significant


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F))
# not significant

r.squaredGLMM(lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F))

```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC 2 apart; both "best models" though just main effects lower AIC
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# No warnings!!

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


## Relative Growth Rate
### Mid-June through Sept
#### lmer
##### Entire gradient: *Not sig for city_dis or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F)
#  singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F))
# distance NOT significant


r.squaredGLMM(lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F)
# NOT singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F))
# distance NOT significant

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F)
# singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F))
# nothing significant


r.squaredGLMM(lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F)
# NOT singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F))
# nothing significant

```

##### Urban subtransects: *transect sig and interaxn marg sig for both
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC


```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant, interaxn marg sig


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant, interaxn marg sig


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though full model lower AIC

```


## No. Ramets
### Mid June ramets
#### lmer
##### Entire gradient: *NOT sig for city_dist or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))

car::Anova(lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance NOT significant


r.squaredGLMM(lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

### CROSSED RANDOM EFFECTS-----
lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# NOT singular!

car::Anova(lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance NOT significant


```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F)

car::Anova(lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F))
# nothing significant


r.squaredGLMM(lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F)
#  singular

car::Anova(lmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F))
# nothing significant

```

##### Urban subtransects: *transect marg sig for city_dist, totally sig for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect marg significant


# Just main effects
car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular, transect marg significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect marg significant


# Just main effects
car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect marg significant


AIC(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


# Just main effects
car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_midJune  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Sept ramets
#### lmer
##### Entire gradient: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F)
#  singular

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20, REML = F))
# distance not significant


### CROSSED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F)
# NOT singular!

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F))
# distance not  significant

r.squaredGLMM(lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = heights_19_20, REML = F))

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
#  singular...

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# not significant


### CROSSED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F)
# NOT singular!

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F))
# not significant

r.squaredGLMM(lmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = heights_19_20, REML = F))

```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC


```


###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


## Herbivory
### Sept
#### lmer
##### Entire gradient: *Not sig for city_dist; marg sig for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = herbivory_19_20, REML = F)
# is singular...

car::Anova(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = herbivory_19_20, REML = F))
# nothing is significant

r.squaredGLMM(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = herbivory_19_20, REML = F))
  

### CROSSED RANDOM EFFECTS-----
lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = herbivory_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
#  singular

car::Anova(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = herbivory_19_20, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance not significant

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = herbivory_19_20, REML = F)
# is singular...

car::Anova(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = herbivory_19_20, REML = F))
# dist marg significant

r.squaredGLMM(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = herbivory_19_20, REML = F))
  

### CROSSED RANDOM EFFECTS-----
lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = herbivory_19_20, REML = F)
#  singular

car::Anova(lmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = herbivory_19_20, REML = F))
#  dist marg significant

```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothingsignificant


# Just main effects
car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist + Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing is significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
#  singular...

car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing is significant


# Just main effects
car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing is significant


AIC(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though main effects model has lower AIC


```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# NOT singular...

car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing significant


AIC(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though main effects model has lower AIC

```

## Survival
### glmer
#### Entire gradient: *Nothing sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = survival_19_20,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# CONVERGES when I set nAGQ to 0

car::Anova(glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = survival_19_20,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = survival_19_20,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# no problems


car::Anova(glmer(Dead ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist,
  data = survival_19_20,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant

```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = survival_19_20,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# CONVERGES when I set nAGQ to 0

car::Anova(glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = survival_19_20,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = survival_19_20,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# no problems


car::Anova(glmer(Dead ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score,
  data = survival_19_20,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


```


#### Urban subtransects: *Interaxn sig for city_dist but nothing sig for urb_score
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
  data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# no problems!

car::Anova(glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
  data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# interaxn significant


### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
  data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings

car::Anova(glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
  data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# interaxn significant


AIC(glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population:Family) + City_dist * Transect_ID,
                 data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

```


##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
  data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# no problems!

car::Anova(glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
  data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
  data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
  data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings

car::Anova(glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
  data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
                 family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


AIC(glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score * Transect_ID,
                 data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(Dead  ~ (1|Block) + (1|Year) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC <2 apart; both "best models" though just main effects lower AIC
```


# Figures: 2019
## Height
### Regressions
#### Each point is a population mean
##### Entire gradient
```{r}
# JUNE HEIGHT- 1
ggplot(heights_both2019_popmeans, aes(x = City_dist, y = mean_height_earlyJune)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Early June: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) 

ggplot(heights_both2019_popmeans, aes(x = Urb_score, y = mean_height_earlyJune)) + 
  labs(x = 'Urbanization Score', 
    y = "Early June: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) +
  scale_x_reverse()

# JUNE HEIGHT- 2
ggplot(heights_both2019_popmeans, aes(x = City_dist, y = mean_height_midJune)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mid-June: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) 

ggplot(heights_both2019_popmeans, aes(x = Urb_score, y = mean_height_midJune)) + 
  labs(x = 'Urbanization Score', 
    y = "Mid-June: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) +
  scale_x_reverse()


# SEPT HEIGHT
ggplot(heights_both2019_popmeans, aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "September: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) 

ggplot(heights_both2019_popmeans, aes(x = Urb_score, y = mean_height_Sept)) + 
  labs(x = "Urbanization Score", 
    y = "September: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) +
  scale_x_reverse()

```

##### Urban subtransects
```{r}
# JUNE HEIGHT- 1
ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_earlyJune)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Early June: Mean height (cm)") +
  theme_urbansubs_1 +
  xlim(0, 35) 

ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_height_earlyJune)) + 
  labs(x = "Urbanization Score", 
    y = "Early June: Mean height (cm)") +
  theme_urbansubs_1 +
  scale_x_reverse()

# JUNE HEIGHT- 2
ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_midJune)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mid-June: Mean height (cm)") +
  theme_urbansubs_1 +
  xlim(0, 35) 

ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_height_midJune)) + 
  labs(x = "Urbanization Score", 
    y = "Mid-June: Mean height (cm)") +
  theme_urbansubs_1 +
  scale_x_reverse()

# sept HEIGHT
ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean height (cm)") +
  theme_urbansubs_1 +
  xlim(0, 35) 

ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_height_Sept)) + 
  labs(x = "Urbanization Score", 
    y = "Sept: Mean height (cm)") +
  theme_urbansubs_1 +
  scale_x_reverse()

```

## No. of Ramets
### Regressions
#### Each point is a population mean
##### Entire gradient
```{r}
# JUNE RAMETS-1 
ggplot(heights_both2019_popmeans, aes(x = City_dist, y = mean_Ramets_earlyJune)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Early June: Mean No. Ramets") +
  theme_gradient_1 +
  xlim(0, 71) 

ggplot(heights_both2019_popmeans, aes(x = Urb_score, y = mean_Ramets_earlyJune)) + 
  labs(x = "Urbanization Score", 
    y = "Early June: Mean No. Ramets") +
  theme_gradient_1 +
  scale_x_reverse()


# JUNE RAMETS-2
ggplot(heights_both2019_popmeans, aes(x = City_dist, y = mean_Ramets_midJune)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mid-June: Mean No. Ramets") +
  theme_gradient_1 +
  xlim(0, 71) 

ggplot(heights_both2019_popmeans, aes(x = Urb_score, y = mean_Ramets_midJune)) + 
  labs(x = "Urbanization Score", 
    y = "Mid-June: Mean No. Ramets") +
  theme_gradient_1 +
  scale_x_reverse()


# SEPT ramets
ggplot(heights_both2019_popmeans, aes(x = City_dist, y = mean_Ramets_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "September: Mean No. Ramets") +
  theme_gradient_1 +
  xlim(0, 71) 

ggplot(heights_both2019_popmeans, aes(x = Urb_score, y = mean_Ramets_Sept)) + 
  labs(x = "Urbanization Score", 
    y = "September: Mean No. Ramets") +
  theme_gradient_1 +
  scale_x_reverse()


```

##### Urban subtransects
```{r}
# JUNE ramets- 1
ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_Ramets_earlyJune)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Early June: Mean No. Ramets") +
  theme_urbansubs_1 +
  xlim(0, 35)  

ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_Ramets_earlyJune)) + 
  labs(x = "Urbanization Score", 
    y = "Early June: Mean No. Ramets") +
  theme_urbansubs_1 +
  scale_x_reverse()


# JUNE ramets- 2
ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_Ramets_midJune)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mid-June: Mean No. Ramets") +
  theme_urbansubs_1 +
  xlim(0, 35)  

ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_Ramets_midJune)) + 
  labs(x = "Urbanization Score", 
    y = "Mid-June: Mean No. Ramets") +
  theme_urbansubs_1 +
  scale_x_reverse()


# sept ramets
ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_Ramets_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean No. Ramets") +
  theme_urbansubs_1 +
  xlim(0, 35) 

ggplot(heights_both2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_Ramets_Sept)) + 
  labs(x = "Urbanization Score", 
    y = "Sept: Mean No. Ramets") +
  theme_urbansubs_1 +
  scale_x_reverse()


```

## Herbivory
### Regressions
#### Entire gradient
```{r}
ggplot(herbivory2019_popmeans, aes(x = City_dist, y = Herbivory.Sept_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  theme_gradient_1 +
  xlim(0, 71) 

ggplot(herbivory2019_popmeans, aes(x = Urb_score, y = Herbivory.Sept_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mean Herbivory") +
  theme_gradient_1 +
  xlim(0, 71) +
  scale_x_reverse()

```

#### Urban subtransects
```{r}
# sept herbivory
ggplot(herbivory2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = Herbivory.Sept_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  theme_urbansubs_1 +
  xlim(0, 35)    

ggplot(herbivory2019_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = Herbivory.Sept_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mean Herbivory") +
  theme_urbansubs_1 +
  scale_x_reverse()

```

## Survival
Not putting anything here yet... I think I'd have to make a logistic regression plot?
# Figures: 2020
## make themes
```{r}
# Gradient
theme_gradient_1_init <-  theme_bw() +
  theme(text = element_text(size=12))

theme_gradient_1 <-  list(theme_gradient_1_init,
        geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2),
        scale_shape(solid = F),
        geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black'),
        scale_shape_manual(values = c(1, 2, 5),
                           breaks = c("North", "South", "Rural"),
                           labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                           name = "Sample Site Subtransect"),
        scale_color_manual(values = c("black", "#333333", "#666666"),
                           breaks = c("North", "South", "Rural"),
                           labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                           name = "Sample Site Subtransect"))


# Urban subtransects
theme_urbansubs_1 <- list(theme_gradient_1_init,
                geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) ,
                scale_shape(solid = F),
                geom_smooth(aes(linetype = Transect_ID,
                                color = Transect_ID, fill = Transect_ID),
                            size=0.75, method = lm, alpha=.15, se = T) ,
                scale_shape_manual(values = c(1, 2),
                                   breaks = c("North", "South"),
                                   labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                                   name = "Sample Site Subtransect") ,
                scale_color_manual(values = c("red", "blue"),
                                   breaks = c("North", "South"),
                                   labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                                   name = "Sample Site Subtransect") ,
                scale_linetype_manual(values = c("solid", "dashed"),
                                   breaks = c("North", "South"),
                                   labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                                   name = "Sample Site Subtransect") ,
                scale_fill_manual(values = c("red", "blue"),
                                   breaks = c("North", "South"),
                                   labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                                   name = "Sample Site Subtransect"))
```

## Visualize spatial patterns
### Blocks in plot
```{r}
blocks <- ggplot(data =  weevil_both, aes(x = Column, y = Row)) + 
      geom_tile(aes(fill = Block), colour = "black") +
      scale_y_reverse() +
  theme_minimal()
blocks

png(here::here("./Figures_Tables/Spatial_patterns/blocks.png"), width = 800, height = 400)
print(blocks)
dev.off()
```

### Weevil damage
```{r}
# binary: damaged or not during first weevil damage assessment
weevil_matrix_data_binary <- weevil_both[,c("Row", "Column", "Weevil_dam_binary")]

weevil_plot_binary <- ggplot(data = weevil_matrix_data_binary, aes(x = Column, y = Row)) + 
      geom_tile(aes(fill = as.factor(Weevil_dam_binary)), colour = "black") +
      scale_y_reverse() +
  scale_fill_manual(values = c("yellow", "red"),
                      name = "Weevil Damage",
                      labels = c("No", "Yes"))
weevil_plot_binary

png(here::here("./Figures_Tables/Spatial_patterns/weevil_matrix_binary.png"), width = 800, height = 400)
print(weevil_plot_binary)
dev.off()


# quantitative: how long was the scar? during second weevil damage assessment
weevil_matrix_data_quant <- weevil_both[,c("Row", "Column", "Scar_length_mm")]

weevil_plot_quant <- ggplot(data =  weevil_matrix_data_quant, aes(x = Column, y = Row, fill = Scar_length_mm)) + 
      geom_tile(aes(fill = Scar_length_mm), colour = "black") +
      scale_y_reverse()
weevil_plot_quant

# quantitative: how long was the scar? during second weevil damage assessment- ONLY IF HAD SCAR
weevil_matrix_data_quant <- weevil_both[,c("Row", "Column", "Scar_length_mm")]

ggplot(data =  weevil_matrix_data_quant %>% filter(.,Scar_length_mm > 0), aes(x = Column, y = Row, fill = Scar_length_mm)) + 
      geom_tile(aes(fill = Scar_length_mm), colour = "black") +
      scale_y_reverse()


# quantitative: how long was the scar? during second weevil damage assessment- ONLY IF HAD SCAR- STANDARDIZED BY HEIGHT
weevil_matrix_data_standardized <- weevil_both[,c("Row", "Column", "scar_div_Juneheight")]

ggplot(data =  weevil_matrix_data_standardized %>% filter(.,scar_div_Juneheight > 0), aes(x = Column, y = Row, fill = scar_div_Juneheight)) +
  geom_tile(aes(fill = scar_div_Juneheight), colour = "black") +
  scale_fill_gradient(colours = topo.colors(50)) +
  scale_y_reverse() +
  labs(fill = "Scar length per cm height")

# hist(log(weevil_both$scar_div_Juneheight)
# png("weevil_matrix_binary.png", width = 800, height = 400)
# print(weevil_plot_binary)
# dev.off()
```

### Mortality
```{r}
mortality_matrix_data <- dead_2020[,c("Row", "Column", "Dead_June")]

mortality_plot <- ggplot(data =  mortality_matrix_data, aes(x = Column, y = Row)) + 
      geom_tile(aes(fill = as.factor(Dead_June)), colour = "black") +
      scale_y_reverse() +
  scale_fill_manual(values = c("yellow", "red"),
                      name = "Mortality",
                          labels = c("Dead", "Alive")) 


png(here::here("./Figures_Tables/Spatial_patterns/mortality_matrix_binary.png"), width = 800, height = 400)
print(mortality_plot)
dev.off()
```

### Flowering
#### Flowering plants
```{r}
flowering_matrix_data <- reproductive[,c("Row", "Column", "Flowered2020")]

flowering_plot <- ggplot(data =  flowering_matrix_data, aes(x = Column, y = Row)) + 
  geom_tile(aes(fill = as.factor(Flowered2020)), colour = "black") +
  scale_y_reverse() +
  scale_fill_manual(values = c("yellow", "red"),
                      name = "Flowering Plants",
                      labels = c("No", "Yes"))
flowering_plot

png(here::here("./Figures_Tables/Spatial_patterns/flowering_matrix.png"), width = 800, height = 400)
print(flowering_plot)
dev.off()
```


## Look at distribution of pops along gradient
```{r}
ggplot(heights_both2020_popmeans, aes(x=City_dist)) +
  geom_histogram(binwidth=6, color="black", fill="white")

ggplot(heights_both2020_popmeans, aes(x=Urb_score)) +
  geom_histogram(binwidth=0.8, color="black", fill="white")

```

## reproductive
### Plants that flowered: Regressions
#### Percent flowering plants/pop
##### Entire gradient
```{r}
# City_dist
ggplot(flowered2020_popmeans, aes(x = City_dist, y = percent_flowered)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Percent Flowering Plants/Population") +
  theme_gradient_1

# Urb_score
ggplot(flowered2020_popmeans, aes(x = Urb_score, y = percent_flowered)) + 
  labs(x = "Urbanization Score", 
    y = "Percent Flowering Plants/Population") +
  theme_gradient_1 +
  scale_x_reverse()
```

##### Urban subtransects
```{r}
# City_dist
ggplot(flowered2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = percent_flowered)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Percent Flowering Plants/Population") +
  theme_urbansubs_1

# Urb_score
ggplot(flowered2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = percent_flowered)) + 
  labs(x = "Urbanization Score", 
    y = "Percent Flowering Plants/Population") +
  theme_urbansubs_1 +
  scale_x_reverse()

```


#### Mean flower count
##### Entire gradient
```{r}
ggplot(flowering_2020, aes(x = City_dist, y = mean_flower_count)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower count/inflorescence") +
  theme_gradient_1


ggplot(flowering_2020, aes(x = Urb_score, y = mean_flower_count)) + 
  labs(x = "Urbanization Score", 
    y = "Mean flower count/inflorescence") +
  theme_gradient_1 +
  scale_x_reverse()
```


##### Urban subtransects
```{r}
ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_flower_count)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower count/inflorescence") +
  theme_urbansubs_1

ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_flower_count)) + 
  labs(x = "Urbanization Score", 
    y = "Mean flower count/inflorescence") +
  theme_urbansubs_1 +
  scale_x_reverse()
```

#### Total flower count
##### Entire gradient
```{r}

ggplot(flowering_2020, aes(x = City_dist, y = total_flower_count)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Total flower count") +
  theme_gradient_1

ggplot(flowering_2020, aes(x = Urb_score, y = total_flower_count)) + 
  labs(x = "Urbanization Score", 
    y = "Total flower count") +
  theme_gradient_1 +
  scale_x_reverse()
```


##### Urban subtransects
```{r}
ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = total_flower_count)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Total flower count") +
  theme_urbansubs_1

ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = total_flower_count)) + 
  labs(x = "Urbanization Score", 
    y = "Total flower count") +
  theme_urbansubs_1+
  scale_x_reverse()

```


#### Mean flower size
##### Entire gradient
```{r}
ggplot(flowering_2020, aes(x = City_dist, y = Overall_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower size") +
  theme_gradient_1

ggplot(flowering_2020, aes(x = Urb_score, y = Overall_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mean flower size") +
  theme_gradient_1 +
  scale_x_reverse()



# COMBINING INTO ONE FIGURE (do a PCA instead)
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower size") +
  geom_point(aes(x = City_dist, y = Overall_mean), size=2, color = 'orange', data = flowering_2020) +
  geom_point(aes(x = City_dist, y = Flower_mean), size=2, color = 'blue', data = flowering_2020) +
  geom_point(aes(x = City_dist, y = Corolla_mean), size=2, color = 'green', data = flowering_2020) +
  geom_point(aes(x = City_dist, y = Hood_mean), size=2, color = 'purple', data = flowering_2020) +
  # xlim(0, 71) +
  # ylim(0, 120) +
  geom_smooth(aes(x = City_dist, y = Overall_mean), size=0.75, method = lm, alpha=.15, se = T, data = flowering_2020) +
  geom_smooth(aes(x = City_dist, y = Flower_mean), size=0.75, method = lm, alpha=.15, se = T, data = flowering_2020) +
  geom_smooth(aes(x = City_dist, y = Corolla_mean), size=0.75, method = lm, alpha=.15, se = T, data = flowering_2020) +
  geom_smooth(aes(x = City_dist, y = Hood_mean), size=0.75, method = lm, alpha=.15, se = T, data = flowering_2020) +
  theme_bw() 
  # theme(text = element_text(size=12)) +
  # scale_shape_manual(values = c(21, 24),
  #                    breaks = c("June", "September"),
  #                      labels = c("June", "September"),
  #                      name = "Legend") +
  # scale_color_manual(values = c("blue", "orange"),
  #                    breaks = c("June", "September"),
  #                      labels = c("June", "September"),
  #                      name = "Legend") +
  # scale_fill_manual(values = c("blue", "orange"),
  #                    breaks = c("June", "September"),
  #                      labels = c("June", "September"),
  #                      name = "Legend")
```


##### Urban subtransects
```{r}
ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = Overall_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower size") +
  theme_urbansubs_1


ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = Overall_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mean flower size") +
  theme_urbansubs_1 +
  scale_x_reverse()
```



#### Pod count
##### Entire gradient
```{r}
ggplot(flowering_2020, aes(x = City_dist, y = Pods)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Pods") +
  theme_gradient_1

ggplot(flowering_2020, aes(x = Urb_score, y = Pods)) + 
  labs(x = "Urbanization Score", 
    y = "Pods") +
  theme_gradient_1 +
  scale_x_reverse()

```


##### Urban subtransects
```{r}
ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = Pods)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Pods") +
  theme_urbansubs_1


ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = Pods)) + 
  labs(x = "Urbanization Score", 
    y = "Pods") +
  theme_urbansubs_1 +
  scale_x_reverse()
```

#### Peduncles/Inflorescences
##### Entire gradient
```{r}
ggplot(flowering_2020, aes(x = City_dist, y = Peduncles)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Peduncles") +
  theme_gradient_1

ggplot(flowering_2020, aes(x = Urb_score, y = Peduncles)) + 
  labs(x = "Urbanization Score", 
    y = "Peduncles") +
  theme_gradient_1 +
  scale_x_reverse()

```


##### Urban subtransects
```{r}
ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = Peduncles)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Peduncles") +
  theme_urbansubs_1


ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = Peduncles)) + 
  labs(x = "Urbanization Score", 
    y = "Peduncles") +
  theme_urbansubs_1 +
  scale_x_reverse()
```


### Plants that flowered: Boxplots
#### Mean flower count
##### Urban subtransects
```{r}
library(viridis)

flowering_2020 %>%
  filter(Transect_ID != "Rural") %>%
  ggplot( aes(x=Transect_ID, y=mean_flower_count, fill=Transect_ID)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=2, alpha=0.5) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    xlab("")
```

## Height
### Regressions
#### Each point is a population mean
##### Entire gradient
```{r}
# JUNE HEIGHT
## Multiple R-squared:  0.05561
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) +
  ylim(0, 60) 

ggplot(heights_both2020_popmeans, aes(x = Urb_score, y = mean_height_June)) + 
  labs(x = 'Urbanization Score', 
    y = "June: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) +
  ylim(0, 60) +
  scale_x_reverse()


# SEPT HEIGHT
# Multiple R-squared:  0.05979
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "September: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) +
  ylim(0, 120) 

ggplot(heights_both2020_popmeans, aes(x = Urb_score, y = mean_height_Sept)) + 
  labs(x = "Urbanization Score", 
    y = "September: Mean height (cm)") +
  theme_gradient_1 +
  xlim(0, 71) +
  ylim(0, 120) +
  scale_x_reverse()


# COMBINING INTO ONE FIGURE
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean height (cm)") +
  geom_point(aes(x = City_dist, y = mean_height_June, fill = 'June', shape = 'June'), size=2, data = heights_both2020_popmeans) +
  geom_point(aes(x = City_dist, y = mean_height_Sept, fill = 'September', shape = 'September' ), size=2, data = heights_both2020_popmeans) +
 # scale_shape(aes(x = City_dist, y = mean_height_June), solid = T, data = heights_both2020_popmeans)+
 # scale_shape(aes(x = City_dist, y = mean_height_Sept), solid = F, data = heights_both2020_popmeans)+
  xlim(0, 71) +
  ylim(0, 120) +
  geom_smooth(aes(x = City_dist, y = mean_height_June, fill = 'June', color = 'June'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  geom_smooth(aes(x = City_dist, y = mean_height_Sept, fill = 'September', color = 'September'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(21, 24),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_color_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_fill_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") 



ggplot() + 
  labs(x = "Urbanization Score", 
    y = "Mean height (cm)") +
  geom_point(aes(x = Urb_score, y = mean_height_June, fill = 'June', shape = 'June'), size=2, data = heights_both2020_popmeans) +
  geom_point(aes(x = Urb_score, y = mean_height_Sept, fill = 'September', shape = 'September' ), size=2, data = heights_both2020_popmeans) +
 # scale_shape(aes(x = City_dist, y = mean_height_June), solid = T, data = heights_both2020_popmeans)+
 # scale_shape(aes(x = City_dist, y = mean_height_Sept), solid = F, data = heights_both2020_popmeans)+
  # xlim(0, 71) +
  ylim(0, 120) +
  geom_smooth(aes(x = Urb_score, y = mean_height_June, fill = 'June', color = 'June'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  geom_smooth(aes(x = Urb_score, y = mean_height_Sept, fill = 'September', color = 'September'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(21, 24),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_color_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_fill_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_x_reverse()
```

##### Urban subtransects
```{r}
# JUNE HEIGHT
ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  theme_urbansubs_1 +
  xlim(0, 35) +
  ylim(0, 60) 

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_height_June)) + 
  labs(x = "Urbanization Score", 
    y = "June: Mean height (cm)") +
  theme_urbansubs_1 +
  ylim(0, 60) +
  scale_x_reverse()



# sept HEIGHT
ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean height (cm)") +
  theme_urbansubs_1 +
  xlim(0, 35) +
  ylim(0, 120)

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_height_Sept)) + 
  labs(x = "Urbanization Score", 
    y = "Sept: Mean height (cm)") +
  theme_urbansubs_1 +
  ylim(0, 120) +
  scale_x_reverse()

```

#### Each point is a family mean
##### Entire gradient
```{r}
# JUNE HEIGHT
## Multiple R-squared:  0.05561
ggplot(heights_both2020_familymeans, aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(0, 60) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 



# SEPT HEIGHT
# Multiple R-squared:  0.05979
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "September: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(0, 120) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect")




# COMBINING INTO ONE FIGURE
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean height (cm)") +
  geom_point(aes(x = City_dist, y = mean_height_June, fill = 'June', shape = 'June'), size=2, data = heights_both2020_popmeans) +
  geom_point(aes(x = City_dist, y = mean_height_Sept, fill = 'September', shape = 'September' ), size=2, data = heights_both2020_popmeans) +
 # scale_shape(aes(x = City_dist, y = mean_height_June), solid = T, data = heights_both2020_popmeans)+
 # scale_shape(aes(x = City_dist, y = mean_height_Sept), solid = F, data = heights_both2020_popmeans)+
  xlim(0, 71) +
  ylim(0, 120) +
  geom_smooth(aes(x = City_dist, y = mean_height_June, fill = 'June', color = 'June'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  geom_smooth(aes(x = City_dist, y = mean_height_Sept, fill = 'September', color = 'September'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(21, 24),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_color_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_fill_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") 
```

##### Urban subtransects
```{r}
# JUNE HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 60) +
  theme_bw() +
  theme(text = element_text(size=12),
        legend.position = 'none') +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")



# sept HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 120) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```



## Weevil damage
### Standardized by June height
#### Regressions
##### Entire gradient
```{r}
# Multiple R-squared: 0.0008
ggplot(weevil_both2020_popmeans, aes(x = City_dist, y = mean_scar_div_Juneheight)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Weevil scar length/cm") +
  theme_gradient_1


ggplot(weevil_both2020_popmeans, aes(x = Urb_score, y = mean_scar_div_Juneheight)) + 
  labs(x = 'Urbanization Score', 
    y = "Weevil scar length/cm") +
  theme_gradient_1 +
  scale_x_reverse()

```

##### Urban subtransects
```{r}

# R-squared = 0.04079
ggplot(weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_scar_div_Juneheight)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Weevil scar length/cm") +
  theme_urbansubs_1 +
  ylim(0, 0.2) 


ggplot(weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_scar_div_Juneheight)) + 
  labs(x = "Urbanization Score", 
    y = "Weevil scar length/cm") +
  theme_urbansubs_1 +
  ylim(0, 0.2) +
  scale_x_reverse()
```

### NOT Standardized by June height
#### Regressions
##### Entire gradient
```{r}
# Multiple R-squared: 0.003591
ggplot(weevil_both2020_popmeans, aes(x = City_dist, y = mean_scar)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Total weevil scar length") +
  theme_gradient_1

ggplot(weevil_both2020_popmeans, aes(x = Urb_score, y = mean_scar)) + 
  labs(x = "Urbanization Score", 
    y = "Total weevil scar length") +
  theme_gradient_1 +
  scale_x_reverse()
```

##### Urban subtransects
```{r}
ggplot(weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_scar)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Total weevil scar length") +
  theme_urbansubs_1

ggplot(weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_scar)) + 
  labs(x = "Urbanization Score", 
    y = "Total weevil scar length") +
  theme_urbansubs_1+
  scale_x_reverse()
```

## Herbivory
### Regressions
#### Entire gradient
```{r}
# JULY HERBIVORY
## NO TRANSFORMATIONS OR OUTLIERS REMOVED-----
## Multiple R-squared: 0.08834
ggplot(herbivory2020_popmeans, aes(x = City_dist, y = Herbivory.July_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  theme_gradient_1 +
  xlim(0, 71) +
  ylim(0, 15) 

ggplot(herbivory2020_popmeans, aes(x = Urb_score, y = Herbivory.July_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mean Herbivory") +
  theme_gradient_1 +
  ylim(0, 15) +
  scale_x_reverse()



# SEPT HEIGHT-----
# Multiple R-squared:  0.01975
ggplot(herbivory2020_popmeans, aes(x = City_dist, y = Herbivory.Sept_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  theme_gradient_1 +
  xlim(0, 71) 

ggplot(herbivory2020_popmeans, aes(x = Urb_score, y = Herbivory.Sept_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mean Herbivory") +
  theme_gradient_1 +
  xlim(0, 71) +
  scale_x_reverse()


# COMBINING INTO ONE FIGURE-----
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  geom_point(aes(x = City_dist, y = Herbivory.July_mean, fill = 'July', shape = 'July'), size=2, data = herbivory2020_popmeans) +
  geom_point(aes(x = City_dist, y = Herbivory.Sept_mean, fill = 'September', shape = 'September' ), size=2, data = herbivory2020_popmeans) +
 # scale_shape(aes(x = City_dist, y = mean_height_June), solid = T, data = heights_both2020_popmeans)+
 # scale_shape(aes(x = City_dist, y = mean_height_Sept), solid = F, data = heights_both2020_popmeans)+
  xlim(0, 71) +
  # ylim(0, 120) +
  geom_smooth(aes(x = City_dist, y = Herbivory.July_mean, fill = 'July', color = 'July'), size=0.75, method = lm, alpha=.15, se = T, data = herbivory2020_popmeans) +
  geom_smooth(aes(x = City_dist, y = Herbivory.Sept_mean, fill = 'September', color = 'September'), size=0.75, method = lm, alpha=.15, se = T, data = herbivory2020_popmeans) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(21, 24),
                     breaks = c("July", "September"),
                       labels = c("July", "September"),
                       name = "Legend") +
  scale_color_manual(values = c("blue", "orange"),
                     breaks = c("July", "September"),
                       labels = c("July", "September"),
                       name = "Legend") +
  scale_fill_manual(values = c("blue", "orange"),
                     breaks = c("July", "September"),
                       labels = c("July", "September"),
                       name = "Legend") 
```

#### Urban subtransects
```{r}
# JULY HERBIVORY
ggplot(herbivory2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = Herbivory.July_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  theme_urbansubs_1 +
  xlim(0, 35) +
  ylim(0, 15) 

ggplot(herbivory2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = Herbivory.July_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mean Herbivory") +
  theme_urbansubs_1 +
  ylim(0, 15) +
  scale_x_reverse()


# sept herbivory
ggplot(herbivory2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = Herbivory.Sept_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  theme_urbansubs_1 +
  xlim(0, 35) +
  ylim(0, 40)    

ggplot(herbivory2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = Herbivory.Sept_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mean Herbivory") +
  theme_urbansubs_1 +
  ylim(0, 40) +
  scale_x_reverse()

```


## No. of Ramets
### Regressions
#### Each point is a population mean
##### Entire gradient
```{r}
# JUNE RAMETS
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_Ramets_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean No. Ramets") +
  theme_gradient_1 +
  xlim(0, 71) +
  ylim(0, 5)

ggplot(heights_both2020_popmeans, aes(x = Urb_score, y = mean_Ramets_June)) + 
  labs(x = "Urbanization Score", 
    y = "June: Mean No. Ramets") +
  theme_gradient_1 +
  ylim(0, 5) +
  scale_x_reverse()


# SEPT ramets
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_Ramets_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "September: Mean No. Ramets") +
  theme_gradient_1 +
  xlim(0, 71) +
  ylim(0, 4) 

ggplot(heights_both2020_popmeans, aes(x = Urb_score, y = mean_Ramets_Sept)) + 
  labs(x = "Urbanization Score", 
    y = "September: Mean No. Ramets") +
  theme_gradient_1 +
  ylim(0, 4) +
  scale_x_reverse()


# COMBINING INTO ONE FIGURE
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean No. Ramets") +
  geom_point(aes(x = City_dist, y = mean_Ramets_June, fill = 'June', shape = 'June'), size=2, data = heights_both2020_popmeans) +
  geom_point(aes(x = City_dist, y = mean_Ramets_Sept, fill = 'September', shape = 'September' ), size=2, data = heights_both2020_popmeans) +
 # scale_shape(aes(x = City_dist, y = mean_height_June), solid = T, data = heights_both2020_popmeans)+
 # scale_shape(aes(x = City_dist, y = mean_height_Sept), solid = F, data = heights_both2020_popmeans)+
  xlim(0, 71) +
  ylim(0, 5) +
  geom_smooth(aes(x = City_dist, y = mean_Ramets_June, fill = 'June', color = 'June'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  geom_smooth(aes(x = City_dist, y = mean_Ramets_Sept, fill = 'September', color = 'September'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(21, 24),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_color_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_fill_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") 
```

##### Urban subtransects
```{r}
# JUNE ramets
p1 <- ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_Ramets_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean No. Ramets") +
  theme_urbansubs_1 +
  xlim(0, 35) +
  ylim(0, 4.2) 

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_Ramets_June)) + 
  labs(x = "Urbanization Score", 
    y = "June: Mean No. Ramets") +
  theme_urbansubs_1 +
  ylim(0, 4.2) +
  scale_x_reverse()


# sept ramets
p2 <- ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_Ramets_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean No. Ramets") +
  theme_urbansubs_1 +
  xlim(0, 35) +
  ylim(0, 4)

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_Ramets_Sept)) + 
  labs(x = "Urbanization Score", 
    y = "Sept: Mean No. Ramets") +
  theme_urbansubs_1 +
  ylim(0, 4)+
  scale_x_reverse()



library(patchwork)
p1 + p2
```

#### Each point is a family mean
##### Entire gradient
```{r}
# JUNE HEIGHT
ggplot(ramets_2020_familymeans_stats, aes(x = City_dist, y = Ramets_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean No. Ramets") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=1.5) +
  scale_shape(solid = F)+
  geom_errorbar(aes(ymin=Ramets_June-se.June, ymax=Ramets_June+se.June), width = 0.25) +
  xlim(0, 71) +
  ylim(0, 8) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 


# SEPT HEIGHT
ggplot(ramets_2020_familymeans_stats, aes(x = City_dist, y = Ramets_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean No. Ramets") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=1.5) +
  scale_shape(solid = F)+
  geom_errorbar(aes(ymin=Ramets_June-se.Sept, ymax=Ramets_June+se.Sept), width = 0.25) +
  xlim(0, 71) +
  ylim(0, 8) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 

```

##### Urban subtransects
```{r}
# JUNE HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 60) +
  theme_bw() +
  theme(text = element_text(size=12),
        legend.position = 'none') +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")



# sept HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 120) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```



## Growth rate
### Regressions
#### Entire gradient
```{r}
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_rel_growth_rate)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Relative Growth Rate") +
  theme_gradient_1 +
  xlim(0, 71) +
  ylim(-0.01, 0.015) 

ggplot(heights_both2020_popmeans, aes(x = Urb_score, y = mean_rel_growth_rate)) + 
  labs(x = "Urbanization Score", 
    y = "Relative Growth Rate") +
  theme_gradient_1 +
  ylim(-0.01, 0.015)+
  scale_x_reverse()


```

#### Urban subtransects
```{r}
ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_rel_growth_rate)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Relative Growth Rate") +
  theme_urbansubs_1 +
  xlim(0, 35) 

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = mean_rel_growth_rate)) + 
  labs(x = "Urbanization Score", 
    y = "Relative Growth Rate") +
  theme_urbansubs_1 +
  scale_x_reverse()
```

## Survival
### Regressions
#### Entire gradient
```{r}
ggplot(survival2020_popmeans, aes(x = City_dist, y = survival_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mortality") +
  theme_gradient_1 +
  xlim(0, 71) 

ggplot(survival2020_popmeans, aes(x = Urb_score, y = survival_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mortality") +
  theme_gradient_1 +
  scale_x_reverse()

```

#### Urban subtransects
```{r}
ggplot(survival2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = survival_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mortality") +
  theme_urbansubs_1 +
  xlim(0, 35) 

ggplot(survival2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = Urb_score, y = survival_mean)) + 
  labs(x = "Urbanization Score", 
    y = "Mortality") +
  theme_urbansubs_1 +
  scale_x_reverse()
```
