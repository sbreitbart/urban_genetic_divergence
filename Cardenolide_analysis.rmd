# CARDENOLIDE ANALYSIS #
########################

# Set up notebook
## Load libraries
```{r}
library(performance) # Assessment of Regression Models Performance
library(here) # A Simpler Way to Find Your Files
library(tidyverse) # Easily Install and Load the 'Tidyverse'
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics
```


## Import data
```{r}
# cardenolides per population (pooled)
cards <-  read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_cardenolides_clean.csv")) %>%
  dplyr::select(., -1)

```

# Check model assumptions
## Distance from city center
### total cardenolides
```{r}
m1_total_dist <- lm(total ~ City_dist, data = cards)

performance::check_model(m1_total_dist) # looks good!

performance::model_performance(m1_total_dist) # low R2
```

### 6.6
```{r}
m1_66_dist <- lm(X6.6_main ~ City_dist, data = cards)

performance::check_model(m1_66_dist) # looks good!

performance::model_performance(m1_66_dist) # low R2
```

### 15
```{r}
m1_15_dist <- lm(X15_main ~ City_dist, data = cards)

performance::check_model(m1_15_dist) # looks good

performance::model_performance(m1_15_dist) # low R2
```

### 17.6
```{r}
m1_176_dist <- lm(X17.6_main ~ City_dist, data = cards)
test <- lm(log(X17.6_main) ~ City_dist, data = cards)

performance::check_model(m1_176_dist) # looks right skewed... try transformation

performance::check_model(update(m1_176_dist, log(X17.6_main) ~ .)) # bimodal? doesn't look too bad but worth returning to

m2_176_dist <- lm(log(X17.6_main) ~ City_dist, data = cards)

performance::model_performance(m2_176_dist) # low R2
```


## Urbanization score
### total cardenolides
```{r}
m1_total_usc <- lm(total ~ Urb_score, data = cards)

performance::check_model(m1_total_usc) # looks good!

performance::model_performance(m1_total_usc) # very low R2

```

### 6.6
```{r}
m1_66_usc <- lm(X6.6_main ~ Urb_score, data = cards)

performance::check_model(m1_66_usc) # looks good!

performance::model_performance(m1_66_usc) # low R2
```

### 15
```{r}
m1_15_usc <- lm(X15_main ~ Urb_score, data = cards)

performance::check_model(m1_15_usc) # looks good

performance::model_performance(m1_15_usc) # low R2
```

### 17.6
```{r}
m1_176_usc <- lm(X17.6_main ~ Urb_score, data = cards)

performance::check_model(m1_176_usc) # log transform again...
performance::check_model(update(m1_176_usc, log(X17.6_main) ~ .)) # better

m2_176_usc <- lm(log(X17.6_main) ~ Urb_score, data = cards)

performance::model_performance(m2_176_usc) # low R2
```

# Linear Regression with ANOVA tables
## Distance from city center
### total cardenolides
```{r}
car::Anova(m1_total_dist) # marg sig
```

### 6.6
```{r}
car::Anova(m1_66_dist) # marg sig
```

### 15
```{r}
car::Anova(m1_15_dist) # not sig
```


### 17.6
```{r}
car::Anova(m2_176_dist) # not sig
```

## Urbanization score
### total cardenolides
```{r}
car::Anova(m1_total_usc) # not sig
```

### 6.6
```{r}
car::Anova(m1_66_usc) # not sig
```

### 15
```{r}
car::Anova(m1_15_usc) # not sig
```

### 17.6
```{r}
car::Anova(m2_176_usc) # marg sig

# compare with untransformed data...
car::Anova(m1_176_usc) # not sig

```


# Figures
## Distance from city center
```{r}

# make vector of response variables
responses <- c("total", "X6.6_main", "X15_main"
               #, "log(X17.6_main)"
               )

y_labels <- c("Total Cardenolides", "Digitoxin peak 6.6", "Digitoxin peak 15"
              #, "log(Digitoxin peak 17.6)"
              )

make_figures <- function(df, response_vec, y_labels){
  for (i in 1:length(response_vec)) {
    print(
    ggplot(df, aes(x = City_dist, y = df[,response_vec[i]])) +
    geom_point(size = 2) +
    geom_smooth(method = lm) +
    labs(x = "Distance to urban center (km)",
         y = y_labels[i]) +
    xlim(0, 71)  +
    ylim(1.15*min(df[,response_vec[i]], na.rm=T),
         1.15*max(df[,response_vec[i]], na.rm=T)) +  
    theme_light())
  }
}
make_figures(cards, responses, y_labels)


# Total cards
ggplot(cards, aes(x = City_dist, y = total)) +
  geom_point(size = 2) +
  geom_smooth(method = lm) +
  labs(x = "Distance to urban center (km)", 
    y = "Total Cardenolides") +
  xlim(0, 71) +
  ylim(0,0.8)


# 6.6
ggplot(cards, aes(x = City_dist, y = X6.6_main)) +
  geom_point(size = 2) +
  geom_smooth(method = lm) +
  labs(x = "Distance to urban center (km)", 
    y = "Digitoxin peak 6.6") +
  xlim(0, 71) +
  ylim(0,0.6)


# 15
ggplot(cards, aes(x = City_dist, y = X15_main)) +
  geom_point(size = 2) +
  geom_smooth(method = lm) +
  labs(x = "Distance to urban center (km)", 
    y = "Digitoxin peak 15") +
  xlim(0, 71) +
  ylim(0,0.2)


# 17.6
ggplot(cards, aes(x = City_dist, y = log(X17.6_main))) +
  geom_point(size = 2) +
  geom_smooth(method = lm) +
  labs(x = "Distance to urban center (km)", 
    y = "log(Digitoxin peak 17.6)") +
  xlim(0, 71)

```


## Urbanization score
```{r}
# Total cards
ggplot(cards, aes(x = Urb_score, y = total)) +
  geom_point(size = 2) +
  geom_smooth(method = lm) +
  labs(x = "Urbanization Score", 
    y = "Total Cardenolides") +
  xlim(4, -4) +
  ylim(0,0.8)



# 6.6
ggplot(cards, aes(x = Urb_score, y = X6.6_main)) +
  geom_point(size = 2) +
  geom_smooth(method = lm) +
  labs(x = "Urbanization Score", 
    y = "Digitoxin peak 6.6") +
  xlim(4, -4) +
  ylim(0,0.6)


# 15
ggplot(cards, aes(x = Urb_score, y = X15_main)) +
  geom_point(size = 2) +
  geom_smooth(method = lm) +
  labs(x = "Urbanization Score", 
    y = "Digitoxin peak 15") +
  xlim(4, -4) +
  ylim(0,0.2)


# 17.6
ggplot(cards, aes(x = Urb_score, y = log(X17.6_main))) +
  geom_point(size = 2) +
  geom_smooth(method = lm) +
  labs(x = "Urbanization Score", 
    y = "log(Digitoxin peak 17.6") +
  xlim(4, -4) 
```

