---
title: "Multivariate trait correlations"
author: "Sophie Breitbart"
date: "6/6/2022"
output: html_document
---

# Load libraries
```{r}
source("libraries.R")
```

# Import data
## Reproductive traits
```{r}
source(knitr::purl("Reproductive_trait_analyses/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))

# save list of models as reprod_models
reprod_models <- all_models
```

## Defense traits
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_Defense.Rmd", quiet=TRUE))

# save list of models as defense_models
defense_models <- all_models
```

## Growth traits
```{r}
source(knitr::purl("Growth_trait_analyses/Model_diagnostics_Growth.Rmd", quiet=TRUE))

# save list of models as growth_models
growth_models <- all_models
```

# Extract only city_dist/gradient models
## Defense traits
```{r}
defense_city_gr <- defense_models %>%
  purrr::flatten() %>%
  keep(grepl('gr', names(.))) %>%
  keep(grepl('City', names(.)))

names(defense_city_gr) <- c(
"latex_mods"         ,
"herb_early_mods_binomial"    ,
"herb_early_mods_quant"    ,
"herb_late_mods_binomial"     ,
"herb_late_mods_quant"     ,
"weev_mods_binomial" ,
"weev_mods_quant")
```

## Growth traits
```{r}
growth_city_gr <- growth_models %>%
  purrr::flatten() %>%
  keep(grepl('gr', names(.))) %>%
  keep(grepl('City', names(.)))

names(growth_city_gr) <- c(
"ldmc_mods",
"sla_mods",
"heights_early_mods",
"heights_late_mods",
"rgr_mods",
"ramets_early_mods",
"ramets_late_mods" ,
"mortality_mods" 
  )
```

## Reproductive traits
```{r}
reprod_city_gr <- reprod_models %>%
  purrr::flatten() %>%
  keep(grepl('gr', names(.))) %>%
  keep(grepl('City', names(.)))

names(reprod_city_gr) <- c(
"flsucc_mods"          ,
"flowers_mods"         ,
"flsize_mods"          ,
"fltime_mods",
"flstart_mods",
"pods_mods"            ,
"peduncles_mods")
```


## Cardenolide model
```{r}
# cardenolides per population (pooled)
cards <-  read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_cardenolides_clean.csv")) %>%
  dplyr::select(., -1)

cards$Population <- as.character(cards$Population)
```

## Join lists (without cardenolides yet)
```{r}
all <- c(reprod_city_gr,
  growth_city_gr,
  defense_city_gr)
```

# Generate df of BLUPs from each trait
```{r}
blup_list <- function(list){
  
  all_blups <- list[[1]] %>%
    ranef() %>%
    extract2("cond") %>%
    extract2("Population") %>%
    rownames_to_column("Population") %>%
    dplyr::select("Population")
  
  for (i in 1:length(list)){
    
    var_name <- list[[i]][["call"]][["formula"]][[2]] %>%
      toString()
    
    blup <- list[[i]] %>%
      ranef() %>%
      extract2("cond") %>%
      extract2("Population") %>%
      rownames_to_column("Population") %>%
      rename(!!var_name:=2)
      
    all_blups <- join(all_blups, blup, by = "Population")
  }
  return(all_blups)
}

all_blups <- blup_list(all) %>%
# back-transform traits transformed in lmers
  dplyr::mutate(Peduncles =          .[[8]]^(1/3), # inverse of x^3
                LDMC =               .[[9]]^2, # inverse of sqrt(x)
                SLA =                .[[10]]^3, # inverse of x^(1/3)
                Total_height_early = .[[11]]^3, # "
                Total_height_late =  .[[12]]^3, # "
                Rel_growth_rate =    .[[13]]^3, # "
                Latex =              .[[17]]^3, # "
                Herbivory_mean_early=exp(.[[19]]), # inverse of log
                Herbivory_mean_late =exp(.[[21]]), # "
                Scar_length_cm =     exp(.[[23]])) %>% # "
  dplyr::select(-c(8:13, 17, 19, 21, 23)) %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  left_join(., cards[,c(2,10)], by = "Population") %>% # add cardenolides
  dplyr::mutate(cardenolides = total) %>%
  dplyr::select(-total)

oldnames <- colnames(all_blups)
newnames <- c("Population",
             "Flowering (0/1)",
             "Mean Flower Count",
             "Mean Flower Size",
             "Flowering Time",
             "Date of Oldest \nInflorescence",
             "Follicles",
             "Ramets \n(before flowering)",
             "Ramets \n(after flowering)",
             "Seasons Survived",
             "Herbivory (0/1) \n(before flowering)",
             "Herbivory (0/1) \n(after flowering)",
             "R. lineaticollis \ndamage (0/1)",
             "Inflorescences",
             "Leaf Dry Matter \nContent (LDMC)",
             "Specific Leaf Area \n(SLA)",
             "Total Plant Height \n(before flowering)",
             "Total Plant Height \n(after flowering)",
             "Relative Growth \nRate",
             "Latex Exudation",
             "Herbivory (>0) \n(before flowering)",
             "Herbivory (>0) \n(after flowering)",
             "R. lineaticollis \nScar Length",
             "Total Cardenolide \nConcentration"
)

all_blups %<>%
  rename_at(vars(oldnames), ~ newnames) %>%
  # arrange traits by life history category
  dplyr::relocate(Inflorescences, .after = Follicles) %>%
  dplyr::relocate('Herbivory (0/1) \n(before flowering)',
                  .after = 'Latex Exudation') %>%
  dplyr::relocate('Herbivory (0/1) \n(before flowering)',
                  .after = 'Latex Exudation') %>%
  dplyr::relocate(13, .after = 'Relative Growth \nRate') %>%
  dplyr::relocate(12, .after = 'Relative Growth \nRate') %>%
  dplyr::relocate(17, .after = 20) %>%
  dplyr::relocate(23, .after = 17)
```

# Generate correlation matrix
```{r}
# correlations <- rcorr(as.matrix(all_blups[-1])) # take out population column
# 
# # save r values as separate df
# correlations.r <- correlations$r %>%
#   as.data.frame() %>%
#   mutate_all(~ifelse(is.nan(.), NA, .))
# 
# # save p values as separate df
# correlations.p <- correlations$P %>%
#   as.data.frame()

# the variable in col 22 (Herbivory_mean_late) had 1s for each population except for one (which was 0.999). As a result, the correlogram was nearly blank. So I took out the variable and now the results are much more refined.

# save table of r values as separate object
correlations2.r <- as.matrix(all_blups[,c(-1, -22)]) %>%
  rcorr() %>%
  pluck("r") %>%
  as.data.frame() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  mutate(across(where(is.numeric), round, 3)) 

# then export it
correlations2.r %>%
  tibble::rownames_to_column(" ") %>%
   flextable() %>%
  save_as_html(., path = here::here("./correlations/r_values.html"))

# same with p values
correlations2.p <- as.matrix(all_blups[,c(-1, -22)]) %>%
  rcorr() %>%
  pluck("P") %>%
  as.data.frame() %>%
  mutate_all(~ifelse(is.nan(.), NA, .))  %>%
  mutate(across(where(is.numeric), round, 3))

correlations2.p %>%
  tibble::rownames_to_column(" ") %>%
   flextable() %>%
  save_as_html(., path = here::here("./correlations/p_values.html"))

```

# Visualize
## Scatterplot matrix
```{r}

correlations2.r[correlations2.r == 1] <- NA # replace all perfect correlations (1; var A on var A; var B on var B; etc.) with NAs

library(GGally)
ggpairs(correlations2.r) 

dev.copy2pdf(file = here::here("./correlations/scatterplot_matrix_longnames.pdf"),
             width = 30, height = 30)

```

## Scatterplot + bar plot + r values
```{r}
library(PerformanceAnalytics)
chart.Correlation(correlations2.r,
                  histogram = TRUE,
                  method = "pearson")

dev.copy2pdf(file = here::here("./correlations/loess_scatterplot_matrix.pdf"),
             width = 20, height = 20)
```

## Heatmaps
### Show p and r values
```{r}
library(corrplot)
library(colorRamps)

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))

col2 <- colorRampPalette(c("blue","white","red"))

# show with p values
corrplot(
  cor(all_blups[,c(-1, -22)],
             use="complete.obs"),
  method = "color",
  shade.col = NA,
  tl.col = "black",
  tl.srt = 45,
  col = col2(200),
 # addCoef.col = "black",
  # cl.pos = "n",
  order = "original", # change this to AOE for "angular order of the eigenvectors" aka to see colors group with like colors
  diag = FALSE,
  type = "upper",
 cl.length = 5,
 cl.cex = 2,
  # p.mat = cor.mtest(all_blups[,c(-1, -22)], conf.level = 0.95)$p,
  # insig = 'p-value',
  sig.level = -1)

dev.copy2pdf(file = here::here("./correlations/heatmap_with_p_original_new palette.pdf"),
             width = 20, height = 20)

# show with p value asterisks
corrplot(
  cor(all_blups[,c(-1, -22)],
             use="complete.obs"),
  shade.col = NA,
  tl.col = "black",
  tl.srt = 45,
  col = col(200),
  cl.pos = "n",
  order = "original", # change this to AOE for "angular order of the eigenvectors" aka to see colors group with like colors
  diag = FALSE,
  type = "upper",
  p.mat = cor.mtest(all_blups[,c(-1, -22)], conf.level = 0.95)$p,
  sig.level = c(0.001, 0.01, 0.05),
   method = 'color',
   pch.cex = 0.9,
   insig = 'label_sig',
   pch.col = 'grey20')

dev.copy2pdf(file = here::here("./correlations/heatmap_with_p_asterisks_original.pdf"),
             width = 20, height = 20)


# show with r values
corrplot(
  cor(all_blups[,c(-1, -22)],
             use="complete.obs"),
  method = "shade",
  shade.col = NA,
  tl.col = "black",
  tl.srt = 45,
  col = col(200),
  addCoef.col = "black",
  cl.pos = "n",
  order = "original", # change this to AOE for "angular order of the eigenvectors" aka to see colors group with like colors
  diag = FALSE,
  type = "upper")


dev.copy2pdf(file = here::here("./correlations/heatmap_with_r_original.pdf"),
             width = 20, height = 20)
```

### No p or r values
```{r}
# heatmap
library(GGally)
# ggcorr(as.matrix(correlations.r),
#        method = c("everything", "pearson")) # doesn't work. I think it's because herbivory_late is nearly all 1s

# this needs matrix with old variable names- doesn't do well with spaces. So make new r matrix


heatmap_rcorr <- blup_list(all) %>%
# back-transform traits transformed in lmers
  dplyr::mutate(Peduncles =          .[[8]]^(1/3), # inverse of x^3
                LDMC =               .[[9]]^2, # inverse of sqrt(x)
                SLA =                .[[10]]^3, # inverse of x^(1/3)
                Total_height_early = .[[11]]^3, # "
                Total_height_late =  .[[12]]^3, # "
                Rel_growth_rate =    .[[13]]^3, # "
                Latex =              .[[17]]^3, # "
                Herbivory_mean_early=exp(.[[19]]), # inverse of log
                Herbivory_mean_late =exp(.[[21]]), # "
                Scar_length_cm =     exp(.[[23]])) %>% # "
  dplyr::select(-c(8:13, 17, 19, 21, 23)) %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  left_join(., cards[,c(2,10)], by = "Population") %>% # add cardenolides
  dplyr::mutate(cardenolides = total) %>%
  dplyr::select(-total, -Population, -Herbivory_mean_late) %>%
  as.matrix() %>%
  rcorr() %>%
  pluck("r") %>%
  as.data.frame() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  mutate(across(where(is.numeric), round, 3)) 


ggcorr(as.matrix(heatmap_rcorr),
       method = c("everything", "pearson"))

dev.copy2pdf(file = here::here("./correlations/heatmap.pdf"),
             width = 14, height = 14)
```

