---
title: "KSR 2020 Herbivore Ordination"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options: 
  chunk_output_type: console
---

*Background information:*

* Herbivore surveys were done twice: Once in July, once in August.
* The species observed are in the column names. The only species with two columns was the Monarch butterfly:
    + one column for Monarchs that had been on the plant in the past ("mean_Monarch_Quantity_Past") and which refers to empty chrysalis, empty eggs, and chrysalis with a dead butterfly inside, and
    + one column for alive Monarchs present on the plant itself ("mean_Monarch_Quantity_Observed") and which refers to all other Monarch forms (caterpillars, eggs, chrysalises with insects still inside)
* Monarchs notwithstanding, dead herbivores were not counted in the surveys. After Hellinger transformation, though, the mean_Monarch_Quantity_Past column had been converted to all 0's.
* Environmental variables are as follows:
    + To quantify urbanization, both distance from the city center and urbanization score were used, separately.
    + Transect was also used as a variable when analyzing the urban sites ONLY (i.e. excluding rural sites).


**Questions:**

* To what extent is urbanization associated with genetic divergence in phenotypic traits among subpopulations?
* Is proximity to urban corridors related to the levels of genetic divergence among urban subpopulations?


WHEN TOTALLY DONE, type this:
renv::activate()
renv::snapshot()

# Set up notebook
## Load packages
```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(reshape)
library(reshape2)
library(tidyr)
library(ggplot2)
library(ggExtra)
library("ggpubr")
library(devtools)
library(glmmTMB)
library(rpart)
library("tibble", lib.loc="~/R/win-library/3.5")
library(ISLR)
library(DHARMa)
library(MASS)
library(car)
library(data.table)
library(plyr)
library(dplyr)
library(MuMIn)
library(ggplot2)
library(gridExtra)
library(Hmisc)
library(lme4)
library(nlme)
library(reshape)
library(lmerTest)
library(tidyverse)
library(vegan)
library(lindia)
library(e1071)
library(ggpubr)
library(forcats)
library(car)
library(multcomp)
library(lsmeans)
library(ggbiplot)
library(ggplot2)
require(MASS)
require(scales)
require(car)
require(ggplot2)
require(ggiraph)
require(ggiraphExtra)
library(geosphere)
library(vctrs)
library(here)
library(stringi)
```

## Make functions
```{r}
make_Anova <- function(full_model, main_effects_model) {
  
  return(
    list(
      
      print('Full model ANOVA: ', quote = FALSE),
      print(car::Anova(full_model)),
      
      print('Full model R-squared: ', quote = FALSE),
      print(r.squaredGLMM(full_model)),
  
      print('Main effects model ANOVA: ', quote = FALSE),
      print(car::Anova(main_effects_model)),
          
      print('Main effects model R-squared: ', quote = FALSE),
      print(r.squaredGLMM(main_effects_model)),
      
      cat(sep="\n\n"),
      
      print(paste("AIC (full model) =", AIC(full_model)), quote = FALSE),
      print(paste("AIC (main effects model) =", AIC(main_effects_model)), quote = FALSE)
      
      )
    )

}

```

## Import data
```{r}
herbivores <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_herbivores_clean.csv")) %>%
  dplyr::select(., -c(1:2))

```

## Find averages per family & population
```{r}

# Find family means
herbivores2020_familymeans <- herbivores %>%
  group_by(Population, Family, Sample) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      mean_Monarch_Quantity_Past = mean(Monarch_Quantity_Past),
      mean_Monarch_Quantity_Observed = mean(Monarch_Quantity_Observed),
      mean_Tetraopes_tetropthalmus = mean(Tetraopes_tetropthalmus),
      mean_Liriomyza_asclepiadis = mean(Liriomyza_asclepiadis),
      mean_Aphis_nerii = mean(Aphis_nerii),
      mean_Aphis_asclepiadis = mean(Aphis_asclepiadis),
      mean_Myzocallis_asclepiadis = mean(Myzocallis_asclepiadis),
      mean_Euchaetes_egle = mean(Euchaetes_egle),
      mean_Lygaeus_kalmii = mean(Lygaeus_kalmii),
      mean_Labidomera_clivicollis = mean(Labidomera_clivicollis),
      mean_Rhyssomatus_lineaticollis = mean(Rhyssomatus_lineaticollis),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score),
      nPlants=n())
herbivores2020_familymeans <- as.data.frame(herbivores2020_familymeans)


# Find population means
herbivores2020_popmeans <- herbivores2020_familymeans %>%
  group_by(Population, Sample) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      mean_Monarch_Quantity_Past = mean(mean_Monarch_Quantity_Past),
      mean_Monarch_Quantity_Observed = mean(mean_Monarch_Quantity_Observed),
      mean_Tetraopes_tetropthalmus = mean(mean_Tetraopes_tetropthalmus),
      mean_Liriomyza_asclepiadis = mean(mean_Liriomyza_asclepiadis),
      mean_Aphis_nerii = mean(mean_Aphis_nerii),
      mean_Aphis_asclepiadis = mean(mean_Aphis_asclepiadis),
      mean_Myzocallis_asclepiadis = mean(mean_Myzocallis_asclepiadis),
      mean_Euchaetes_egle = mean(mean_Euchaetes_egle),
      mean_Lygaeus_kalmii = mean(mean_Lygaeus_kalmii),
      mean_Labidomera_clivicollis = mean(mean_Labidomera_clivicollis),
      mean_Rhyssomatus_lineaticollis = mean(mean_Rhyssomatus_lineaticollis),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      Urb_score = first(Urb_score))
herbivores2020_popmeans <- as.data.frame(herbivores2020_popmeans)


```
# Ordination
## Does the herbivore community change along the gradient?
## Or does it vary between urban subtransects?
## Answer to both: Not really.
## Set up input data
### Make herbivore subsets per month
```{r}
### JULY
#### All sites
herb2020_July <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July') %>%
  dplyr::select(-c(1:3, 15:17))

herb2020_July.env <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July') %>%
  dplyr::select(c(15:17))

head(herb2020_July)
head(herb2020_July.env)

#### Just urban sites
herb2020_July_urb <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July') %>%
  dplyr::filter(., Transect_ID != 'Rural') %>%
  dplyr::select(-c(1:3, 15:17))

herb2020_July_urb.env <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July') %>%
  dplyr::filter(., Transect_ID != 'Rural') %>%
  dplyr::select(c(15:17))

head(herb2020_July_urb)
head(herb2020_July_urb.env)



### AUGUST
herb2020_Aug <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August') %>%
  dplyr::select(-c(1:3, 15:17))

herb2020_Aug.env <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August') %>%
  dplyr::select(c(15:17))

head(herb2020_Aug)
head(herb2020_Aug.env)

#### Just urban sites
herb2020_Aug_urb <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August') %>%
  dplyr::filter(., Transect_ID != 'Rural') %>%
  dplyr::select(-c(1:3, 15:17))

herb2020_Aug_urb.env <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August') %>%
  dplyr::filter(., Transect_ID != 'Rural') %>%
  dplyr::select(c(15:17))

head(herb2020_Aug_urb)
head(herb2020_Aug_urb.env)
```


### Hellinger-transform the species dataset: gives low weights to rare species
```{r}
## All sites 
herb2020_July.hel <- vegan::decostand(herb2020_July, "hellinger")
herb2020_Aug.hel <- vegan::decostand(herb2020_Aug, "hellinger")
## Just urban
herb2020_July_urb.hel <- vegan::decostand(herb2020_July_urb, "hellinger")
herb2020_Aug_urb.hel <- vegan::decostand(herb2020_Aug_urb, "hellinger")
```

## Initial unconstrained ordination (PCA)
### Plots

**Scaling 1 vs Scaling 2:**

* Scaling 1- distance biplot (object focused): distance between objects are eudlidean distances (objects closer together have similar variable values), angles between vectors of response variables are meaningless. Angles between vectors of response variables and explanatory variables reflect linear correlation.

* Scaling 2- correlation biplot (response variable focused): distances between objects are not approximate Euclidean distances. Angles between all vectors reflect linear correlation.

*Taken directly from [this site](https://fukamilab.github.io/BIO202/06-B-constrained-ordination.html)*

#### Make plotting functions
```{r}

PCA_list <- list(herb2020_July.hel,
                 herb2020_Aug.hel,
                 herb2020_July_urb.hel,
                 herb2020_Aug_urb.hel)


# Triplot: three different entities in the plot: sites, response variables and explanatory variables (arrowheads are on the explanatory variables)
## SCALING 1
makePCAplot_scaling1 <- function(x) {
  plot(vegan::rda(x), scaling=1, main="Triplot PCA matrix - scaling 1")
  spe.sc <- scores(vegan::rda(x), choices=1:2, scaling=1, display="sp")
  arrows(0,0,spe.sc[,1], spe.sc[,2], length=0, lty=1, col='red')
}
lapply(PCA_list, makePCAplot_scaling1)

## SCALING 2
makePCAplot_scaling2 <- function(x) {
  plot(rda(x), main="Triplot PCA matrix - scaling 2")
  spe2.sc <- scores(rda(x), choices=1:2, display="sp") # scores() choices= indicates which axes are to be selected, make sure to specify the scaling if its different than 2 
  arrows(0,0,spe2.sc[,1], spe2.sc[,2], length=0, lty=1, col='red')
}
lapply(PCA_list, makePCAplot_scaling2)

```

> I don't see any clear trends yet: herbivore community doesn't seem to correlate with urbanization (when quantified as distance from the city center OR by urbanization score) NOR does it seem to vary between urban subtransects.

## Constrained ordination (RDA)
### Pre-plot setup
#### July
```{r}
### All sites
#### herbivores ~ City_dist
RDA_July <- rda(herb2020_July.hel ~ City_dist,
                              data=herb2020_July.env )
summary(RDA_July)
screeplot(RDA_July)

rda(herb2020_July.hel)


#### herbivores ~ Urb_score
RDA_July_urbscore <- rda(herb2020_July.hel ~ Urb_score,
                              data = herb2020_July.env )
summary(RDA_July_urbscore)
screeplot(RDA_July_urbscore)


### Just urban sites
#### herbivores ~ City_dist
RDA_July.urb <- rda(herb2020_July_urb.hel ~ City_dist + Transect_ID,
                              data = herb2020_July_urb.env )
summary(RDA_July.urb)
screeplot(RDA_July.urb) 

#### herbivores ~ Urb_score
RDA_July_urbscore.urb <- rda(herb2020_July_urb.hel ~ Urb_score + Transect_ID,
                              data = herb2020_July_urb.env )
summary(RDA_July_urbscore.urb)
screeplot(RDA_July_urbscore.urb)
```

#### August
```{r}
### All sites
#### herbivores ~ City_dist
RDA_Aug <- rda(herb2020_Aug.hel ~ City_dist,
                              data=herb2020_Aug.env )
summary(RDA_Aug)
screeplot(RDA_Aug) 

#### herbivores ~ Urb_score
RDA_Aug_urbscore <- rda(herb2020_Aug.hel ~ Urb_score,
                              data = herb2020_Aug.env )
summary(RDA_Aug_urbscore)
screeplot(RDA_Aug_urbscore)


### Just urban sites
#### herbivores ~ City_dist
RDA_Aug.urb <- rda(herb2020_Aug_urb.hel ~ City_dist + Transect_ID,
                              data = herb2020_Aug_urb.env )
summary(RDA_Aug.urb)
screeplot(RDA_Aug.urb) 

#### herbivores ~ Urb_score
RDA_Aug_urbscore.urb <- rda(herb2020_Aug_urb.hel ~ Urb_score + Transect_ID,
                              data = herb2020_Aug_urb.env )
summary(RDA_Aug_urbscore.urb)
screeplot(RDA_Aug_urbscore.urb)
```

### RDA statistics
#### Canonical coefficients & R-squared values
```{r}
RDA_list <- list(RDA_July,
                 RDA_July_urbscore,
                 RDA_July.urb,
                 RDA_July_urbscore.urb,
                 RDA_Aug,
                 RDA_Aug_urbscore,
                 RDA_Aug.urb,
                 RDA_Aug_urbscore.urb)



## canonical coefficients
canon_coeffs <- lapply(RDA_list, coef)
canon_coeffs

# unadjusted R^2 retreived from the rda result
RsquareAdj(RDA_July              )$r.squared
RsquareAdj(RDA_July_urbscore     )$r.squared
RsquareAdj(RDA_July.urb          )$r.squared
RsquareAdj(RDA_July_urbscore.urb )$r.squared
RsquareAdj(RDA_Aug               )$r.squared
RsquareAdj(RDA_Aug_urbscore      )$r.squared
RsquareAdj(RDA_Aug.urb           )$r.squared
RsquareAdj(RDA_Aug_urbscore.urb  )$r.squared
# values very low... none above 0.06

# for (i in length(RDA_list)) {
#   print RsquareAdj(i)$r.squared
# }

# adjusted R^2
RsquareAdj(RDA_July              )$adj.r.squared
RsquareAdj(RDA_July_urbscore     )$adj.r.squared
RsquareAdj(RDA_July.urb          )$adj.r.squared
RsquareAdj(RDA_July_urbscore.urb )$adj.r.squared
RsquareAdj(RDA_Aug               )$adj.r.squared
RsquareAdj(RDA_Aug_urbscore      )$adj.r.squared
RsquareAdj(RDA_Aug.urb           )$adj.r.squared
RsquareAdj(RDA_Aug_urbscore.urb  )$adj.r.squared
# values very low... none above 0.03

```

#### ANOVA
##### Entire model
```{r}
# ANOVA-like permutation test to assess the significance of constraints
## Entire model: No models significant (except for one marg sig)
anova(RDA_July              , permutations = how(nperm = 9999))
anova(RDA_July_urbscore     , permutations = how(nperm = 9999))
anova(RDA_July.urb          , permutations = how(nperm = 9999))
anova(RDA_July_urbscore.urb , permutations = how(nperm = 9999))
anova(RDA_Aug               , permutations = how(nperm = 9999))
# Reminder: RDA_Aug_urbscore is this model:
# rda(herb2020_Aug.hel ~ Urb_score, data = herb2020_Aug.env)
# (i.e. August herbivores ~ Urbanization score) along ENTIRE gradient
anova(RDA_Aug_urbscore      , permutations = how(nperm = 9999)) # marg sig
anova(RDA_Aug.urb           , permutations = how(nperm = 9999))
anova(RDA_Aug_urbscore.urb  , permutations = how(nperm = 9999))
```
##### Per term
```{r}
## Per term: no explanatory vars significant
### Only doing this for models with >1 explanatory var (otherwise, same as above)
anova(RDA_July.urb              , permutations = how(nperm = 9999), by = "term")
anova(RDA_July_urbscore.urb     , permutations = how(nperm = 9999), by = "term")
anova(RDA_Aug.urb               , permutations = how(nperm = 9999), by = "term")
anova(RDA_Aug_urbscore.urb      , permutations = how(nperm = 9999), by = "term")
```
##### Per margin
```{r}
## Per margin- seem to be very similar to entire model anovas?
anova(RDA_July              , permutations = how(nperm = 9999), by = "margin")
anova(RDA_July_urbscore     , permutations = how(nperm = 9999), by = "margin")
anova(RDA_July.urb          , permutations = how(nperm = 9999), by = "margin")
anova(RDA_July_urbscore.urb , permutations = how(nperm = 9999), by = "margin")
anova(RDA_Aug               , permutations = how(nperm = 9999), by = "margin")
anova(RDA_Aug_urbscore      , permutations = how(nperm = 9999), by = "margin") # marg sig
anova(RDA_Aug.urb           , permutations = how(nperm = 9999), by = "margin")
anova(RDA_Aug_urbscore.urb  , permutations = how(nperm = 9999), by = "margin")

```

### Plots

**Scaling 1 vs Scaling 2:**

* Scaling 1- distance biplot (object focused): distance between objects are eudlidean distances (objects closer together have similar variable values), angles between vectors of response variables are meaningless. Angles between vectors of response variables and explanatory variables reflect linear correlation.

* Scaling 2- correlation biplot (response variable focused): distances between objects are not approximate Euclidean distances. Angles between all vectors reflect linear correlation.

*Taken directly from [this site](https://fukamilab.github.io/BIO202/06-B-constrained-ordination.html)*
#### Plotting RDA functions
```{r}
# Triplot: three different entities in the plot: sites, response variables and explanatory variables (arrowheads are on the explanatory variables)
## SCALING 1
makeRDAplot_scaling1 <- function(x) {
  plot(x, scaling=1, main="Triplot RDA matrix ~ env - scaling 1 - wa scores")
  spe.sc <- scores(x, choices=1:2, scaling=1, display="sp")
  arrows(0,0,spe.sc[,1], spe.sc[,2], length=0, lty=1, col='red')
}
# lapply(RDA_list, makeRDAplot_scaling1)

## SCALING 2
makeRDAplot_scaling2 <- function(x) {
  plot(x, main="Triplot RDA matrix ~ env - scaling 2 - wa scores")
  spe2.sc <- scores(x, choices=1:2, display="sp") # scores() choices= indicates which axes are to be selected, make sure to specify the scaling if its different than 2 
  arrows(0,0,spe2.sc[,1], spe2.sc[,2], length=0, lty=1, col='red')
}
# lapply(RDA_list, makeRDAplot_scaling2)
```

#### July
##### All sites
###### Environmental var: Distance from city center
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_July)

# Scaling 2
makeRDAplot_scaling2(RDA_July)

```

###### Environmental var: Urbanization score
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_July_urbscore)

# Scaling 2
makeRDAplot_scaling2(RDA_July_urbscore)

```

##### Urban sites
###### Environmental var: Distance from city center
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_July.urb)

# Scaling 2
makeRDAplot_scaling2(RDA_July.urb)

```

###### Environmental var: Urbanization score
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_July_urbscore.urb)

# Scaling 2
makeRDAplot_scaling2(RDA_July_urbscore.urb)

```



#### Aug
##### All sites
###### Environmental var: Distance from city center
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_Aug)

# Scaling 2
makeRDAplot_scaling2(RDA_Aug)

```

###### Environmental var: Urbanization score
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_Aug_urbscore)

# Scaling 2
makeRDAplot_scaling2(RDA_Aug_urbscore)

```

##### Urban sites
###### Environmental var: Distance from city center
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_Aug.urb)

# Scaling 2
makeRDAplot_scaling2(RDA_Aug.urb)

```

###### Environmental var: Urbanization score
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_Aug_urbscore.urb)

# Scaling 2
makeRDAplot_scaling2(RDA_Aug_urbscore.urb)

```

# Regression
## Does the abundance of individual herbivore species change along the gradient?
## Or does it vary between urban subtransects?
## Tetraopes tetropthalmus- no & no
### Diagnostics: glmer w/poisson distribution (b/c count data)
#### All sites
```{r}
m1_TT <- glmer(Tetraopes_tetropthalmus ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist 
              , data = herbivores , family = poisson)
res <- simulateResiduals(m1_TT)
plot(res)

# looks good.
```

#### Urban sites
```{r}
m1_TT.urb <- glmer(Tetraopes_tetropthalmus ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) # singular
res <- simulateResiduals(m1_TT.urb)
plot(res)
# looks good
```

### ANOVA
#### All sites
```{r}
car::Anova(m1_TT)
# distance not significant 

r.squaredGLMM(m1_TT)

```


#### Urban sites
```{r}
# FULL MODEL: 

m1_TT.urb
# NOT singular

car::Anova(m1_TT.urb)
# Nothing significant

r.squaredGLMM(m1_TT.urb)
# very small marginal R-sq



# MAIN EFFECTS:
car::Anova(glmer(Tetraopes_tetropthalmus ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# main effects highly sig here?? But I think it's because the model's not converging even though the full model did... anyway you can see from the full model that no effect nor interaxn is anywhere near sig.
```
## Liriomyza asclepiadis- no & no
### Diagnostics: glmer w/poisson distribution (b/c count data)
#### All sites
```{r}
m1_LA <- glmer(Liriomyza_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores , family = poisson)
res <- simulateResiduals(m1_LA)
plot(res)

# KS test, dispersion, outlier significant...
# try neg binomial

m1_LA.nb <- glmmTMB(Liriomyza_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML=F)
res <- simulateResiduals(m1_LA.nb)
plot(res)
# KS test and outlier test still sig but dispersion better

par(mfrow = c(1,3))
plotResiduals(res, herbivores$Liriomyza_asclepiadis)
testDispersion(res)
testZeroInflation(res)
testOutliers(res) # it looks like there are two outliers... upon looking at my range, it's fine. There are no outliers.
testUniformity(res)

simulationOutput <- simulateResiduals(fittedModel = m1_LA.nb, plot = T)
plotResiduals(simulationOutput, herbivores$City_dist)

# I'm going to stick with neg binomial model. The diagnostics look fine to me.
```

#### Urban sites
```{r}
m1_LA.urb <- glmer(Liriomyza_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) # singular
res <- simulateResiduals(m1_LA.urb)
plot(res)
# several issues... trying neg bin transformation


m1_LA.nb <- glmmTMB(Liriomyza_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_LA.nb)
plot(res)
# KS test still sig
# I'm going to stick with neg binomial model. The diagnostics look fine to me.


```

### ANOVA
#### All sites
```{r}

m1_LA.nb
# NOT singular

car::Anova(m1_LA.nb)
# distance NOT significant

r.squaredGLMM(m1_LA.nb)
# very small marginal R-sq
```


#### Urban sites
```{r}
# FULL MODEL:

m1_LA.nb
# NOT singular

car::Anova(m1_LA.nb)
# Nothing significant

r.squaredGLMM(m1_LA.nb)
# very small marginal R-sq



# MAIN EFFECTS:
car::Anova(glmmTMB(Liriomyza_asclepiadis ~
              (1|Block) + (1|Population/Family) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1()))
# nothing significant

r.squaredGLMM(glmmTMB(Liriomyza_asclepiadis ~
              (1|Block) + (1|Population/Family) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1()))
```
## Aphis nerii- perhaps
### Diagnostics: glmer w/poisson distribution (b/c count data)
#### All sites
```{r}
m1_AN <- glmer(Aphis_nerii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores,
              family = poisson)
res <- simulateResiduals(m1_AN)
plot(res)

# KS test significant...
# try neg binomial

m1_AN.nb <- glmmTMB(Aphis_nerii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_AN.nb)
plot(res)
# KS test not sig anymore. Looks good

```

#### Urban sites
```{r}
m1_AN.urb <- glmer(Aphis_nerii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) # singular
res <- simulateResiduals(m1_AN.urb)
plot(res)
# several technical issues with NAs and infinity even though diagnostics seem fine... trying neg bin transformation


m1_AN.urb.nb <- glmmTMB(Aphis_nerii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_AN.urb.nb)
plot(res)
# Looks good.

```

### ANOVA
#### All sites
```{r}

m1_AN.nb
# NOT singular

car::Anova(m1_AN.nb)
# distance NOT significant

r.squaredGLMM(m1_AN.nb)
# very small marginal R-sq
```


#### Urban sites
```{r}
# FULL MODEL:

m1_AN.urb.nb
# NOT singular

car::Anova(m1_AN.urb.nb)
# Nothing significant

r.squaredGLMM(m1_AN.urb.nb)
# pretty good-sized marginal R-sq! Around 0.20!



# MAIN EFFECTS:
car::Anova(glmmTMB(Aphis_nerii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# city_dist is marg significant!

r.squaredGLMM(glmmTMB(Aphis_nerii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# now r-sq closer to 0.07...
```
## Aphis asclepiadis- no and no
### Diagnostics: glmer w/poisson distribution (b/c count data)
#### All sites
```{r}
m1_AA <- glmer(Aphis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores,
              family = poisson)
res <- simulateResiduals(m1_AA)
plot(res)

# KS test significant...
# try neg binomial

m1_AA.nb <- glmmTMB(Aphis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_AA.nb)
plot(res)
# KS test not sig anymore. Looks good

```

#### Urban sites
```{r}
m1_AA.urb <- glmer(Aphis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) # singular
res <- simulateResiduals(m1_AA.urb)
plot(res)
# KS test sig... trying neg bin transformation


m1_AA.urb.nb <- glmmTMB(Aphis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_AA.urb.nb)
plot(res)
# Looks good.

```

### ANOVA
#### All sites
```{r}

m1_AA.nb
# NOT singular

car::Anova(m1_AA.nb)
# distance NOT significant

r.squaredGLMM(m1_AA.nb)
# very small marginal R-sq
```


#### Urban sites
```{r}
# FULL MODEL:

m1_AA.urb.nb
# NOT singular

car::Anova(m1_AA.urb.nb)
# Nothing significant

r.squaredGLMM(m1_AA.urb.nb)
# small r-sq



# MAIN EFFECTS:
car::Anova(glmmTMB(Aphis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# nothing significant

r.squaredGLMM(glmmTMB(Aphis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# very small r-sq.
```
## Myzocallis asclepiadis- no and no
### Diagnostics: glmer w/poisson distribution (b/c count data)
#### All sites
```{r}
m1_MA <- glmer(Myzocallis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores,
              family = poisson)
res <- simulateResiduals(m1_MA)
plot(res)

# KS test significant...
# try neg binomial

m1_MA.nb <- glmmTMB(Myzocallis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_MA.nb)
plot(res)
# KS test not sig anymore. Looks good

```

#### Urban sites
```{r}
m1_MA.urb <- glmer(Myzocallis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) 
res <- simulateResiduals(m1_MA.urb)
plot(res)
# KS test sig... trying neg bin transformation


m1_MA.urb.nb <- glmmTMB(Myzocallis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_MA.urb.nb)
plot(res)
# Looks good.

```

### ANOVA
#### All sites
```{r}

m1_MA.nb
# NOT singular

car::Anova(m1_MA.nb)
# distance NOT significant

r.squaredGLMM(m1_MA.nb)
# very small marginal R-sq
```


#### Urban sites
```{r}
# FULL MODEL:

m1_MA.urb.nb
# NOT singular

car::Anova(m1_MA.urb.nb)
# Nothing significant

r.squaredGLMM(m1_MA.urb.nb)
# small r-sq



# MAIN EFFECTS:
car::Anova(glmmTMB(Myzocallis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# nothing significant

r.squaredGLMM(glmmTMB(Myzocallis_asclepiadis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# very small r-sq.
```
## Euchaetes egle- no and no
### Diagnostics: glmer w/poisson distribution (b/c count data)
#### All sites
```{r}
m1_EE <- glmer(Euchaetes_egle ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores,
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
res <- simulateResiduals(m1_EE)
plot(res)

# several technical issues with NAs and infinity even though diagnostics seem fine... trying neg bin transformation

m1_EE.nb <- glmmTMB(Euchaetes_egle ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_EE.nb)
plot(res)
# Looks good

```

#### Urban sites
```{r}
m1_EE.urb <- glmer(Euchaetes_egle ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) 
res <- simulateResiduals(m1_EE.urb)
plot(res)
# not converging... trying neg bin


m1_EE.urb.nb <- glmmTMB(Euchaetes_egle ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_EE.urb.nb)
plot(res)
# Looks good.

```

### ANOVA
#### All sites
```{r}

m1_EE.nb
# NOT singular

car::Anova(m1_EE.nb)
# distance NOT significant

r.squaredGLMM(m1_EE.nb)
# very small marginal R-sq
```


#### Urban sites
```{r}
# FULL MODEL:

m1_EE.urb.nb
# NOT singular

car::Anova(m1_EE.urb.nb)
# Nothing significant

r.squaredGLMM(m1_EE.urb.nb)
# small r-sq



# MAIN EFFECTS:
car::Anova(glmmTMB(Euchaetes_egle ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# nothing significant

r.squaredGLMM(glmmTMB(Euchaetes_egle ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# very small r-sq.
```
## Lygaeus kalmii- no and no
### Diagnostics: glmer w/poisson distribution (b/c count data)
#### All sites
```{r}
m1_LK <- glmer(Lygaeus_kalmii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores,
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
res <- simulateResiduals(m1_LK)
plot(res)

# singular and KS test significant.. trying neg bin transformation

m1_LK.nb <- glmmTMB(Lygaeus_kalmii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_LK.nb)
plot(res)
# Looks good

```

#### Urban sites
```{r}
m1_LK.urb <- glmer(Lygaeus_kalmii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) 
res <- simulateResiduals(m1_LK.urb)
plot(res)
# singular... trying neg bin


m1_LK.urb.nb <- glmmTMB(Lygaeus_kalmii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_LK.urb.nb)
plot(res)
# Looks good and isn't singular.

```

### ANOVA
#### All sites
```{r}

m1_LK.nb
# NOT singular

car::Anova(m1_LK.nb)
# distance NOT significant

r.squaredGLMM(m1_LK.nb)
# very small marginal R-sq
```


#### Urban sites
```{r}
# FULL MODEL:

m1_LK.urb.nb
# NOT singular

car::Anova(m1_LK.urb.nb)
# Nothing significant

r.squaredGLMM(m1_LK.urb.nb)
# small r-sq



# MAIN EFFECTS:
car::Anova(glmmTMB(Lygaeus_kalmii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# nothing significant

r.squaredGLMM(glmmTMB(Lygaeus_kalmii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# very small r-sq.





##### JUST TRYING OUT GLMER/POISSON MODEL TO SEE IF ANY DIFFERENCE- NOPE
# FULL MODEL:
m1_LK.urb
# NOT singular

car::Anova(m1_LK.urb)
# Nothing significant

r.squaredGLMM(m1_LK.urb)
# small r-sq



# MAIN EFFECTS:
car::Anova(glmer(Lygaeus_kalmii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) )
# nothing significant

r.squaredGLMM(glmer(Lygaeus_kalmii ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) )
# very small r-sq. SINGULAR.

```
## Labidomera clivicollis- no and YES*
### Diagnostics: glmer w/poisson distribution (b/c count data)
#### All sites
```{r}
m1_LC <- glmer(Labidomera_clivicollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores,
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
res <- simulateResiduals(m1_LC)
plot(res)

# looks good... try neg bin transf just in case

m1_LC.nb <- glmmTMB(Labidomera_clivicollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_LC.nb)
plot(res)
# Dispersion test sig... going back to original model

```

#### Urban sites
```{r}
m1_LC.urb <- glmer(Labidomera_clivicollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) 
res <- simulateResiduals(m1_LC.urb)
plot(res)
# not converging... trying neg bin


m1_LC.urb.nb <- glmmTMB(Labidomera_clivicollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_LC.urb.nb)
plot(res)
# Looks good and isn't singular.

```

### ANOVA
#### All sites
```{r}

m1_LC
# NOT singular

car::Anova(m1_LC)
# distance NOT significant

r.squaredGLMM(m1_LC)
# very small marginal R-sq
```


#### Urban sites
```{r}
# FULL MODEL:

m1_LC.urb.nb
# NOT singular

car::Anova(m1_LC.urb.nb)
# City_dist is significant!

r.squaredGLMM(m1_LC.urb.nb)
# relatively moderate r-sqs!



# MAIN EFFECTS:
car::Anova(glmmTMB(Labidomera_clivicollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# city_dist is marg significant

r.squaredGLMM(glmmTMB(Labidomera_clivicollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# very small r-sq.


AIC(m1_LC.urb.nb)
AIC(glmmTMB(Labidomera_clivicollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F))
# AICs <2 apart but just main effects is smaller
```
## Rhyssomatus lineaticollis- no and YES*
### Diagnostics: glmer w/poisson distribution (b/c count data)
#### All sites
```{r}
m1_RL <- glmer(Rhyssomatus_lineaticollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores,
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
res <- simulateResiduals(m1_RL)
plot(res)

# not converging.. try neg bin transf

m1_RL.nb <- glmmTMB(Rhyssomatus_lineaticollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_RL.nb)
plot(res)
# Looks good. Using this model

```

#### Urban sites
```{r}
m1_RL.urb <- glmer(Rhyssomatus_lineaticollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) 
res <- simulateResiduals(m1_RL.urb)
plot(res)
# Looks good.. trying neg bin just in case


m1_RL.urb.nb <- glmmTMB(Rhyssomatus_lineaticollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_RL.urb.nb)
plot(res)
# Convergence issue. Using original model above


# just main effects model:
m1_RL.urb_ME <- glmer(Rhyssomatus_lineaticollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) 
```

### ANOVA
#### All sites
```{r}

m1_RL.nb
# NOT singular

car::Anova(m1_RL.nb)
# distance NOT significant

r.squaredGLMM(m1_RL.nb)
# very small marginal R-sq
```


#### Urban sites
```{r}
# FULL MODEL:

m1_RL.urb
# NOT singular

car::Anova(m1_RL.urb)
# City_dist is marg significant!

r.squaredGLMM(m1_RL.urb)
# relatively moderate r-sqs!



# MAIN EFFECTS:
car::Anova(m1_RL.urb_ME)
summary(m1_RL.urb_ME)
# city_dist is significant!

r.squaredGLMM(glmer(Rhyssomatus_lineaticollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) )
# moderate r-sq.


AIC(m1_RL.urb)
AIC(glmer(Rhyssomatus_lineaticollis ~
              (1|Block) + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))) )
# AICs <2 apart but just main effects is smaller
```

# Regression: Plots
```{r}
ggplot(herbivores2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_Rhyssomatus_lineaticollis)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Total weevil scar length") +
  theme_urbansubs_1


sjPlot::set_theme(
  geom.outline.color = "antiquewhite4", 
  geom.outline.size = 1, 
  geom.label.size = 2,
  title.size = 1.5, 
  base = theme_bw()
)
sjPlot::plot_model(m1_RL.urb, type = "pred", terms = c("City_dist", "Transect_ID"),
                     geom.colors = c("cadetblue", "coral"))

sjPlot::plot_model(m1_RL.urb_ME, type = "pred", terms = c("City_dist", "Transect_ID")) 


```

