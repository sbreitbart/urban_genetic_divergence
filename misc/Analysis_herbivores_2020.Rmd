* Herbivore surveys were done twice: Once in July, once in August.
* The species observed are in the column names. The only species with two columns was the Monarch butterfly:
    + one column for Monarchs that had been on the plant in the past ("mean_Monarch_Quantity_Past") and which refers to empty chrysalis, empty eggs, and chrysalis with a dead butterfly inside, and
    + one column for alive Monarchs present on the plant itself ("mean_Monarch_Quantity_Observed") and which refers to all other Monarch forms (caterpillars, eggs, chrysalises with insects still inside)
* Monarchs notwithstanding, dead herbivores were not counted in the surveys. After Hellinger transformation, though, the mean_Monarch_Quantity_Past column had been converted to all 0's.
* Environmental variables are as follows:
    + To quantify urbanization, both distance from the city center and urbanization score were used, separately.
    + Transect was also used as a variable when analyzing the urban sites ONLY (i.e. excluding rural sites).

# Set up notebook
## Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import data
```{r}
herbivores <- read.csv(here::here("./data/CommonGardenExperiment_2020Data/clean_data/2020_herbivores_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  mutate(Population = factor(Population),
         Family = factor(Family),
         Block = factor(Block))
```

# Ordination
Does the herbivore community change along the gradient?
Or does it vary between urban subtransects?
Answer to both: Not really.
## Set up input data
### Make herbivore subsets per month
```{r}
### JULY
#### All sites
herb2020_July <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July') %>%
  dplyr::select(-c(1:3, 15:17))

herb2020_July.env <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July') %>%
  dplyr::select(c(15:17))

head(herb2020_July)
head(herb2020_July.env)

#### Just urban sites
herb2020_July_urb <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July') %>%
  dplyr::filter(., Transect_ID != 'Rural') %>%
  dplyr::select(-c(1:3, 15:17))

herb2020_July_urb.env <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July') %>%
  dplyr::filter(., Transect_ID != 'Rural') %>%
  dplyr::select(c(15:17))

head(herb2020_July_urb)
head(herb2020_July_urb.env)



### AUGUST
herb2020_Aug <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August') %>%
  dplyr::select(-c(1:3, 15:17))

herb2020_Aug.env <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August') %>%
  dplyr::select(c(15:17))

head(herb2020_Aug)
head(herb2020_Aug.env)

#### Just urban sites
herb2020_Aug_urb <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August') %>%
  dplyr::filter(., Transect_ID != 'Rural') %>%
  dplyr::select(-c(1:3, 15:17))

herb2020_Aug_urb.env <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August') %>%
  dplyr::filter(., Transect_ID != 'Rural') %>%
  dplyr::select(c(15:17))

head(herb2020_Aug_urb)
head(herb2020_Aug_urb.env)
```


### Hellinger-transform the species dataset: gives low weights to rare species
```{r}
## All sites 
herb2020_July.hel <- vegan::decostand(herb2020_July, "hellinger")
herb2020_Aug.hel <- vegan::decostand(herb2020_Aug, "hellinger")
## Just urban
herb2020_July_urb.hel <- vegan::decostand(herb2020_July_urb, "hellinger")
herb2020_Aug_urb.hel <- vegan::decostand(herb2020_Aug_urb, "hellinger")
```

## Initial unconstrained ordination (PCA)
### Plots

**Scaling 1 vs Scaling 2:**

* Scaling 1- distance biplot (object focused): distance between objects are eudlidean distances (objects closer together have similar variable values), angles between vectors of response variables are meaningless. Angles between vectors of response variables and explanatory variables reflect linear correlation.

* Scaling 2- correlation biplot (response variable focused): distances between objects are not approximate Euclidean distances. Angles between all vectors reflect linear correlation.

*Taken directly from [this site](https://fukamilab.github.io/BIO202/06-B-constrained-ordination.html)*

#### Make plotting functions
```{r}

PCA_list <- list(herb2020_July.hel,
                 herb2020_Aug.hel,
                 herb2020_July_urb.hel,
                 herb2020_Aug_urb.hel)


# Triplot: three different entities in the plot: sites, response variables and explanatory variables (arrowheads are on the explanatory variables)
## SCALING 1
makePCAplot_scaling1 <- function(x) {
  plot(vegan::rda(x), scaling=1, main="Triplot PCA matrix - scaling 1")
  spe.sc <- scores(vegan::rda(x), choices=1:2, scaling=1, display="sp")
  arrows(0,0,spe.sc[,1], spe.sc[,2], length=0, lty=1, col='red')
}
lapply(PCA_list, makePCAplot_scaling1)

## SCALING 2
makePCAplot_scaling2 <- function(x) {
  plot(rda(x), main="Triplot PCA matrix - scaling 2")
  spe2.sc <- scores(rda(x), choices=1:2, display="sp") # scores() choices= indicates which axes are to be selected, make sure to specify the scaling if its different than 2 
  arrows(0,0,spe2.sc[,1], spe2.sc[,2], length=0, lty=1, col='red')
}
lapply(PCA_list, makePCAplot_scaling2)

```

> I don't see any clear trends yet: herbivore community doesn't seem to correlate with urbanization (when quantified as distance from the city center OR by urbanization score) NOR does it seem to vary between urban subtransects.

## Constrained ordination (RDA)
### Pre-plot setup
#### July
```{r}
### All sites
#### herbivores ~ City_dist
RDA_July <- rda(herb2020_July.hel ~ City_dist,
                              data=herb2020_July.env )
summary(RDA_July)
screeplot(RDA_July)

rda(herb2020_July.hel)


#### herbivores ~ Urb_score
RDA_July_urbscore <- rda(herb2020_July.hel ~ Urb_score,
                              data = herb2020_July.env )
summary(RDA_July_urbscore)
screeplot(RDA_July_urbscore)


### Just urban sites
#### herbivores ~ City_dist
RDA_July.urb <- rda(herb2020_July_urb.hel ~ City_dist + Transect_ID,
                              data = herb2020_July_urb.env )
summary(RDA_July.urb)
screeplot(RDA_July.urb) 

#### herbivores ~ Urb_score
RDA_July_urbscore.urb <- rda(herb2020_July_urb.hel ~ Urb_score + Transect_ID,
                              data = herb2020_July_urb.env )
summary(RDA_July_urbscore.urb)
screeplot(RDA_July_urbscore.urb)
```

#### August
```{r}
### All sites
#### herbivores ~ City_dist
RDA_Aug <- rda(herb2020_Aug.hel ~ City_dist,
                              data=herb2020_Aug.env )
summary(RDA_Aug)
screeplot(RDA_Aug) 

#### herbivores ~ Urb_score
RDA_Aug_urbscore <- rda(herb2020_Aug.hel ~ Urb_score,
                              data = herb2020_Aug.env )
summary(RDA_Aug_urbscore)
screeplot(RDA_Aug_urbscore)


### Just urban sites
#### herbivores ~ City_dist
RDA_Aug.urb <- rda(herb2020_Aug_urb.hel ~ City_dist + Transect_ID,
                              data = herb2020_Aug_urb.env )
summary(RDA_Aug.urb)
screeplot(RDA_Aug.urb) 

#### herbivores ~ Urb_score
RDA_Aug_urbscore.urb <- rda(herb2020_Aug_urb.hel ~ Urb_score + Transect_ID,
                              data = herb2020_Aug_urb.env )
summary(RDA_Aug_urbscore.urb)
screeplot(RDA_Aug_urbscore.urb)
```

### RDA statistics
#### Canonical coefficients & R-squared values
```{r}
RDA_list <- list(RDA_July,
                 RDA_July_urbscore,
                 RDA_July.urb,
                 RDA_July_urbscore.urb,
                 RDA_Aug,
                 RDA_Aug_urbscore,
                 RDA_Aug.urb,
                 RDA_Aug_urbscore.urb)



## canonical coefficients
canon_coeffs <- lapply(RDA_list, coef)
canon_coeffs

# unadjusted R^2 retreived from the rda result
RsquareAdj(RDA_July              )$r.squared
RsquareAdj(RDA_July_urbscore     )$r.squared
RsquareAdj(RDA_July.urb          )$r.squared
RsquareAdj(RDA_July_urbscore.urb )$r.squared
RsquareAdj(RDA_Aug               )$r.squared
RsquareAdj(RDA_Aug_urbscore      )$r.squared
RsquareAdj(RDA_Aug.urb           )$r.squared
RsquareAdj(RDA_Aug_urbscore.urb  )$r.squared
# values very low... none above 0.06

# for (i in length(RDA_list)) {
#   print RsquareAdj(i)$r.squared
# }

# adjusted R^2
RsquareAdj(RDA_July              )$adj.r.squared
RsquareAdj(RDA_July_urbscore     )$adj.r.squared
RsquareAdj(RDA_July.urb          )$adj.r.squared
RsquareAdj(RDA_July_urbscore.urb )$adj.r.squared
RsquareAdj(RDA_Aug               )$adj.r.squared
RsquareAdj(RDA_Aug_urbscore      )$adj.r.squared
RsquareAdj(RDA_Aug.urb           )$adj.r.squared
RsquareAdj(RDA_Aug_urbscore.urb  )$adj.r.squared
# values very low... none above 0.03

```

#### ANOVA
##### Entire model
```{r}
# ANOVA-like permutation test to assess the significance of constraints
## Entire model: No models significant (except for one marg sig)
anova(RDA_July              , permutations = how(nperm = 9999))
anova(RDA_July_urbscore     , permutations = how(nperm = 9999))
anova(RDA_July.urb          , permutations = how(nperm = 9999))
anova(RDA_July_urbscore.urb , permutations = how(nperm = 9999))
anova(RDA_Aug               , permutations = how(nperm = 9999))
# Reminder: RDA_Aug_urbscore is this model:
# rda(herb2020_Aug.hel ~ Urb_score, data = herb2020_Aug.env)
# (i.e. August herbivores ~ Urbanization score) along ENTIRE gradient
anova(RDA_Aug_urbscore      , permutations = how(nperm = 9999)) # marg sig
anova(RDA_Aug.urb           , permutations = how(nperm = 9999))
anova(RDA_Aug_urbscore.urb  , permutations = how(nperm = 9999))
```
##### Per term
```{r}
## Per term: no explanatory vars significant
### Only doing this for models with >1 explanatory var (otherwise, same as above)
anova(RDA_July.urb              , permutations = how(nperm = 9999), by = "term")
anova(RDA_July_urbscore.urb     , permutations = how(nperm = 9999), by = "term")
anova(RDA_Aug.urb               , permutations = how(nperm = 9999), by = "term")
anova(RDA_Aug_urbscore.urb      , permutations = how(nperm = 9999), by = "term")
```
##### Per margin
```{r}
## Per margin- seem to be very similar to entire model anovas?
anova(RDA_July              , permutations = how(nperm = 9999), by = "margin")
anova(RDA_July_urbscore     , permutations = how(nperm = 9999), by = "margin")
anova(RDA_July.urb          , permutations = how(nperm = 9999), by = "margin")
anova(RDA_July_urbscore.urb , permutations = how(nperm = 9999), by = "margin")
anova(RDA_Aug               , permutations = how(nperm = 9999), by = "margin")
anova(RDA_Aug_urbscore      , permutations = how(nperm = 9999), by = "margin") # marg sig
anova(RDA_Aug.urb           , permutations = how(nperm = 9999), by = "margin")
anova(RDA_Aug_urbscore.urb  , permutations = how(nperm = 9999), by = "margin")

```

### Plots

**Scaling 1 vs Scaling 2:**

* Scaling 1- distance biplot (object focused): distance between objects are eudlidean distances (objects closer together have similar variable values), angles between vectors of response variables are meaningless. Angles between vectors of response variables and explanatory variables reflect linear correlation.

* Scaling 2- correlation biplot (response variable focused): distances between objects are not approximate Euclidean distances. Angles between all vectors reflect linear correlation.

*Taken directly from [this site](https://fukamilab.github.io/BIO202/06-B-constrained-ordination.html)*
#### Plotting RDA functions
```{r}
# Triplot: three different entities in the plot: sites, response variables and explanatory variables (arrowheads are on the explanatory variables)
## SCALING 1
makeRDAplot_scaling1 <- function(x) {
  plot(x, scaling=1, main="Triplot RDA matrix ~ env - scaling 1 - wa scores")
  spe.sc <- scores(x, choices=1:2, scaling=1, display="sp")
  arrows(0,0,spe.sc[,1], spe.sc[,2], length=0, lty=1, col='red')
}
# lapply(RDA_list, makeRDAplot_scaling1)

## SCALING 2
makeRDAplot_scaling2 <- function(x) {
  plot(x, main="Triplot RDA matrix ~ env - scaling 2 - wa scores")
  spe2.sc <- scores(x, choices=1:2, display="sp") # scores() choices= indicates which axes are to be selected, make sure to specify the scaling if its different than 2 
  arrows(0,0,spe2.sc[,1], spe2.sc[,2], length=0, lty=1, col='red')
}
# lapply(RDA_list, makeRDAplot_scaling2)
```

#### July
##### All sites
###### Environmental var: Distance from city center
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_July)

# Scaling 2
makeRDAplot_scaling2(RDA_July)

```

###### Environmental var: Urbanization score
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_July_urbscore)

# Scaling 2
makeRDAplot_scaling2(RDA_July_urbscore)

```

##### Urban sites
###### Environmental var: Distance from city center
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_July.urb)

# Scaling 2
makeRDAplot_scaling2(RDA_July.urb)

```

###### Environmental var: Urbanization score
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_July_urbscore.urb)

# Scaling 2
makeRDAplot_scaling2(RDA_July_urbscore.urb)

```



#### Aug
##### All sites
###### Environmental var: Distance from city center
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_Aug)

# Scaling 2
makeRDAplot_scaling2(RDA_Aug)

```

###### Environmental var: Urbanization score
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_Aug_urbscore)

# Scaling 2
makeRDAplot_scaling2(RDA_Aug_urbscore)

```

##### Urban sites
###### Environmental var: Distance from city center
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_Aug.urb)

# Scaling 2
makeRDAplot_scaling2(RDA_Aug.urb)

```

###### Environmental var: Urbanization score
```{r}
# Scaling 1
makeRDAplot_scaling1(RDA_Aug_urbscore.urb)

# Scaling 2
makeRDAplot_scaling2(RDA_Aug_urbscore.urb)

```

# Regression
Does the abundance of individual herbivore species change along the gradient? Or does it vary between urban subtransects?
## Monarchs
### Diagnostics
#### All sites
```{r}
# DISTANCE FROM CITY CENTER
m1_DP <- glmmTMB(Monarch_Quantity_Observed ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist 
              , data = herbivores , family = poisson) 
res <- simulateResiduals(m1_DP)
plot(res) 




# URBANIZATION SCORE
m2_DP <- glmmTMB(Monarch_Quantity_Observed ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score,
              data = herbivores , 
              family = poisson)
res <- simulateResiduals(m2_DP)
plot(res)
```

#### Urban sites
```{r}
# CITY DISTANCE

# m1_DP.urb <- glmmTMB(Monarch_Quantity_Observed ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist * Transect_ID,
#               data = herbivores %>%
#                 filter(., Transect_ID != "Rural"),
#               family = poisson
#               ) 
# res <- simulateResiduals(m1_DP.urb)
# plot(res)
# # dispersion significant
# testDispersion(res) # overdispersed

# add zero-inflation parameter applying to all observations
m1_DP.urb <- glmmTMB(Monarch_Quantity_Observed ~
                       Block +
              (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              ziformula = ~1,
              REML=F
              )
res <- simulateResiduals(m1_DP.urb)
plot(res) 


# main effects
m1_DP.urb_ME <- glmmTMB(Monarch_Quantity_Observed ~
                          Block +
              (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              ziformula = ~1,
              REML=F
              )

AIC(m1_DP.urb,
    m1_DP.urb_ME) # statistically equivalent but ME mod best


# URBANIZATION SCORE
m2_DP.urb <- glmmTMB(Monarch_Quantity_Observed ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>%
                filter(., Transect_ID != "Rural"),
              family = poisson,
              REML=F
              ) 
res <- simulateResiduals(m1_DP.urb)
plot(res) # looks good!

# main effects
m2_DP.urb_ME <- glmmTMB(Monarch_Quantity_Observed ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>%
                filter(., Transect_ID != "Rural"),
              family = poisson,
              REML=F
              )

AIC(m2_DP.urb,
    m2_DP.urb_ME) # statistically equivalent but ME mod best
```

## Tetraopes tetropthalmus
### Diagnostics
#### All sites
```{r}
# DISTANCE FROM CITY CENTER
m1_TT <- glmmTMB(Tetraopes_tetropthalmus ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist 
              , data = herbivores ,
              family = poisson,
              REML=F) 
res <- simulateResiduals(m1_TT)
plot(res) 




# URBANIZATION SCORE
m2_TT <- glmmTMB(Tetraopes_tetropthalmus ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score 
              , data = herbivores ,
              family = poisson,
              REML=F)
res <- simulateResiduals(m2_TT)
plot(res)

```

#### Urban sites
```{r}
# CITY DISTANCE
m1_TT.urb <- glmmTMB(Tetraopes_tetropthalmus ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson)
res <- simulateResiduals(m1_TT.urb)
plot(res)


# main effects
m1_TT.urb_ME <- glmmTMB(Tetraopes_tetropthalmus ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              REML=F) 

AIC(m1_TT.urb,
    m1_TT.urb_ME) # stat equiv but ME better


# URBANIZATION SCORE
m2_TT.urb <- glmmTMB(Tetraopes_tetropthalmus ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              REML=F)
res <- simulateResiduals(m2_TT.urb)
plot(res) # looks good


m2_TT.urb_ME <- glmmTMB(Tetraopes_tetropthalmus ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = poisson,
              REML=F) 

AIC(m2_TT.urb,
    m2_TT.urb_ME) # stat equiv but ME better
```

## Liriomyza asclepiadis
### Diagnostics
#### All sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_LA <- glmmTMB(Liriomyza_asclepiadis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist,
#               data = herbivores ,
#               family = poisson,
#               REML=F)
# res <- simulateResiduals(m1_LA)
# plot(res)
# # KS test, dispersion, outlier significant...
# # try neg binomial

m1_LA.nb <- glmmTMB(Liriomyza_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML=F)
res <- simulateResiduals(m1_LA.nb)
plot(res)


# URBANIZATION SCORE
# m2_LA <- glmmTMB(Liriomyza_asclepiadis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               Urb_score,
#               data = herbivores ,
#               family = poisson,
#               REML=F)
# res <- simulateResiduals(m2_LA)
# plot(res)
# # KS test, dispersion, outlier significant...
# # try neg binomial

m2_LA.nb <- glmmTMB(Liriomyza_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score,
              data = herbivores ,
              family = nbinom1(),
              REML=F)
res <- simulateResiduals(m2_LA.nb)
plot(res)

```

#### Urban sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_LA.urb <- glmmTMB(Liriomyza_asclepiadis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist * Transect_ID,
#               data = herbivores %>%
#                 filter(., Transect_ID != "Rural"),
#               family = poisson) # singular
# res <- simulateResiduals(m1_LA.urb)
# plot(res)
# # several issues... trying neg bin transformation


m1_LA.urb.nb <- glmmTMB(Liriomyza_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_LA.nb)
plot(res)

# main effects
m1_LA.urb.nb_ME <- glmmTMB(Liriomyza_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m1_LA.urb.nb,
    m1_LA.urb.nb_ME) # stat equiv but ME best



# URBANIZATION SCORE
# m2_LA.urb <- glmmTMB(Liriomyza_asclepiadis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               Urb_score * Transect_ID,
#               data = herbivores %>% 
#                 filter(., Transect_ID != "Rural"),
#               family = poisson,
#               control=glmmTMBControl(optimizer="bobyqa",
#                                  optCtrl=list(maxfun=2e5))) # singular
# res <- simulateResiduals(m2_LA.urb)
# plot(res)
# # several issues... trying neg bin transformation


m2_LA.urb.nb <- glmmTMB(Liriomyza_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_LA.nb)
plot(res)

# main effects
m2_LA.urb.nb_ME <- glmmTMB(Liriomyza_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m2_LA.urb.nb,
    m2_LA.urb.nb_ME) # stat equiv but ME best
```

## Aphis nerii
### Diagnostics
#### All sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_AN <- glmmTMB(Aphis_nerii ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist,
#               data = herbivores,
#               family = poisson)
# res <- simulateResiduals(m1_AN)
# plot(res)

# KS test significant...
# try neg binomial

m1_AN.nb <- glmmTMB(Aphis_nerii ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom2(),
              REML = F)
res <- simulateResiduals(m1_AN.nb)
plot(res)



# URBANIZATION SCORE
m2_AN.nb <- glmmTMB(Aphis_nerii ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score,
              data = herbivores ,
              family = nbinom2(),
              REML = F)
res <- simulateResiduals(m2_AN.nb)
plot(res)
```

#### Urban sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_AN.urb <- glmmTMB(Aphis_nerii ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist * Transect_ID,
#               data = herbivores %>%
#                 filter(., Transect_ID != "Rural"),
#               family = poisson) 
# res <- simulateResiduals(m1_AN.urb)
# plot(res)
# # several issues... try nb


m1_AN.urb.nb <- glmmTMB(Aphis_nerii ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_AN.urb.nb)
plot(res)


# main effects
m1_AN.urb.nb_ME <- glmmTMB(Aphis_nerii ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m1_AN.urb.nb,
    m1_AN.urb.nb_ME) # stat equiv but full mod best


# URBANIZATION SCORE
m2_AN.urb.nb <- glmmTMB(Aphis_nerii ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_AN.urb.nb)
plot(res)


# main effects
m2_AN.urb.nb_ME <- glmmTMB(Aphis_nerii ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m2_AN.urb.nb,
    m2_AN.urb.nb_ME) # stat equiv but ME best
```

## Aphis asclepiadis
### Diagnostics
#### All sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_AA <- glmmTMB(Aphis_asclepiadis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist,
#               data = herbivores,
#               family = poisson)
# res <- simulateResiduals(m1_AA)
# plot(res) # KS test significant... try neg binomial

m1_AA.nb <- glmmTMB(Aphis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_AA.nb)
plot(res)


# URBANIZATION SCORE
m2_AA.nb <- glmmTMB(Aphis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_AA.nb)
plot(res)
```

#### Urban sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_AA.urb <- glmmTMB(Aphis_asclepiadis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist * Transect_ID,
#               data = herbivores %>%
#                 filter(., Transect_ID != "Rural"),
#               family = poisson) # singular
# res <- simulateResiduals(m1_AA.urb)
# plot(res) # KS test sig... trying neg bin transformation


m1_AA.urb.nb <- glmmTMB(Aphis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_AA.urb.nb)
plot(res)


# main effects
m1_AA.urb.nb_ME <- glmmTMB(Aphis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m1_AA.urb.nb,
    m1_AA.urb.nb_ME) # stat equiv but ME best

# URBANIZATION SCORE
m2_AA.urb.nb <- glmmTMB(Aphis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_AA.urb.nb)
plot(res)


# main effects
m2_AA.urb.nb_ME <- glmmTMB(Aphis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m2_AA.urb.nb,
    m2_AA.urb.nb_ME) # stat equiv but ME best
```

## Myzocallis asclepiadis
### Diagnostics
#### All sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_MA <- glmmTMB(Myzocallis_asclepiadis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist,
#               data = herbivores,
#               family = poisson)
# res <- simulateResiduals(m1_MA)
# plot(res) # KS test significant... try neg binomial

m1_MA.nb <- glmmTMB(Myzocallis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_MA.nb)
plot(res) 

# URBANIZATION SCORE
m2_MA.nb <- glmmTMB(Myzocallis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_MA.nb)
plot(res)
```

#### Urban sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_MA.urb <- glmmTMB(Myzocallis_asclepiadis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist * Transect_ID,
#               data = herbivores %>%
#                 filter(., Transect_ID != "Rural"),
#               family = poisson)
# res <- simulateResiduals(m1_MA.urb)
# plot(res) # KS test sig... trying neg bin transformation


m1_MA.urb.nb <- glmmTMB(Myzocallis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_MA.urb.nb)
plot(res)


# main effects
m1_MA.urb.nb_ME <- glmmTMB(Myzocallis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m1_MA.urb.nb,
    m1_MA.urb.nb_ME) # stat equiv but ME best


# URBANIZATION SCORE
# m2_MA.urb <- glmmTMB(Myzocallis_asclepiadis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               Urb_score * Transect_ID,
#               data = herbivores %>%
#                 filter(., Transect_ID != "Rural"),
#               family = poisson)
# res <- simulateResiduals(m2_MA.urb)
# plot(res) # KS test sig... trying neg bin transformation


m2_MA.urb.nb <- glmmTMB(Myzocallis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_MA.urb.nb)
plot(res)

# main effects
m2_MA.urb.nb_ME <- glmmTMB(Myzocallis_asclepiadis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m2_MA.urb.nb,
    m2_MA.urb.nb_ME) # stat equiv but ME best
```

## Euchaetes egle
### Diagnostics
#### All sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_EE <- glmmTMB(Euchaetes_egle ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist,
#               data = herbivores,
#               family = poisson)
# 
# res <- simulateResiduals(m1_EE)
# plot(res) # trying neg bin transformation

m1_EE.nb <- glmmTMB(Euchaetes_egle ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_EE.nb)
plot(res)


# URBANIZATION SCORE
m2_EE.nb <- glmmTMB(Euchaetes_egle ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_EE.nb)
plot(res)

```

#### Urban sites
```{r}
# DISTANCE FROM CITY CENTER
m1_EE.urb.nb <- glmmTMB(Euchaetes_egle ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom2(),
              REML = F)
res <- simulateResiduals(m1_EE.urb.nb)
plot(res)


# main effects
m1_EE.urb.nb_ME <- glmmTMB(Euchaetes_egle ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom2(),
              REML = F)

AIC(m1_EE.urb.nb,
    m1_EE.urb.nb_ME) # stat equiv but ME best


# URBANIZATION SCORE
m2_EE.urb.nb <- glmmTMB(Euchaetes_egle ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_EE.urb.nb)
plot(res)


# main effects
m2_EE.urb.nb_ME <- glmmTMB(Euchaetes_egle ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m1_EE.urb.nb,
    m1_EE.urb.nb_ME) # stat equiv but ME best

```

## Lygaeus kalmii
### Diagnostics
#### All sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_LK <- glmmTMB(Lygaeus_kalmii ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist,
#               data = herbivores,
#               family = poisson)
# res <- simulateResiduals(m1_LK)
# plot(res) # KS test significant.. trying neg bin transformation

m1_LK.nb <- glmmTMB(Lygaeus_kalmii ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_LK.nb)
plot(res)


# URBANIZATION SCORE
m2_LK.nb <- glmmTMB(Lygaeus_kalmii ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score,
              data = herbivores ,
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_LK.nb)
plot(res)
```

#### Urban sites
```{r}
# DISTANCE FROM CITY CENTER
m1_LK.urb.nb <- glmmTMB(Lygaeus_kalmii ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m1_LK.urb.nb)
plot(res)

# main effects
m1_LK.urb.nb_ME <- glmmTMB(Lygaeus_kalmii ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m1_LK.urb.nb,
    m1_LK.urb.nb_ME) # stat equiv but ME best


# URBANIZATION SCORE
m2_LK.urb.nb <- glmmTMB(Lygaeus_kalmii ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)
res <- simulateResiduals(m2_LK.urb.nb)
plot(res)

# main effects
m2_LK.urb.nb_ME <- glmmTMB(Lygaeus_kalmii ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom1(),
              REML = F)

AIC(m2_LK.urb.nb,
    m2_LK.urb.nb_ME) # stat equiv but ME best
```

## Labidomera clivicollis
### Diagnostics
#### All sites
```{r}
# DISTANCE FROM CITY CENTER
# m1_LC <- glmmTMB(Labidomera_clivicollis ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist,
#               data = herbivores,
#               family = poisson)
# res <- simulateResiduals(m1_LC)
# plot(res) # try neg bin transf

m1_LC.nb <- glmmTMB(Labidomera_clivicollis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist,
              data = herbivores ,
              family = nbinom2(),
              REML = F)
res <- simulateResiduals(m1_LC.nb)
plot(res) 



# URBANIZATION SCORE
m2_LC.nb <- glmmTMB(Labidomera_clivicollis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score,
              data = herbivores,
              family = nbinom2())
res <- simulateResiduals(m2_LC.nb)
plot(res) 
```

#### Urban sites
```{r}
# DISTANCE FROM CITY CENTER
m1_LC.urb.nb <- glmmTMB(Labidomera_clivicollis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom2(),
              REML = F)
res <- simulateResiduals(m1_LC.urb.nb)
plot(res) 

# main effects
m1_LC.urb.nb_ME <- glmmTMB(Labidomera_clivicollis ~
              Block + (1|Population/Family) + (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom2(),
              REML = F)

AIC(m1_LC.urb.nb,
    m1_LC.urb.nb_ME) # stat equiv but ME best


# URBANIZATION SCORE
m2_LC.urb.nb <- glmmTMB(Labidomera_clivicollis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom2(),
              REML = F)
res <- simulateResiduals(m2_LC.urb.nb)
plot(res)

# main effects
m2_LC.urb.nb_ME <- glmmTMB(Labidomera_clivicollis ~
              Block + (1|Population/Family) + (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = nbinom2(),
              REML = F)

AIC(m2_LC.urb.nb,
    m2_LC.urb.nb_ME) # stat equiv but ME best
```

## Rhyssomatus lineaticollis
### Diagnostics
#### All sites
```{r}
# use binomial distribution as null and treat data like presence/absence... only 20 non-zero entries and they're only 1s and 2s

# make presence/absence column
herbivores$Rhyssomatus_lineaticollis_bin <- 0
herbivores$Rhyssomatus_lineaticollis_bin[herbivores$Rhyssomatus_lineaticollis > 0] <- 1


# DISTANCE FROM CITY CENTER
# m1_RL <- glmmTMB(Rhyssomatus_lineaticollis_bin ~
#               Block + (1|Population/Family) + (1|Sample) +
#               City_dist,
#               data = herbivores,
#               family = binomial)
# res <- simulateResiduals(m1_RL)
# plot(res) # not converging- try zero-inflated binomial

m1_RL.ZI <- glmmTMB(Rhyssomatus_lineaticollis_bin ~
              (1|Population) +
                Block +
                (1|Sample) +
              City_dist,
              data = herbivores ,
              family = binomial(),
              ziformula=~1,
              REML = F) # not converging... tried taking out block and sample separately, then together... then took out family and finally converged. Could add block and sample back in
res <- simulateResiduals(m1_RL.ZI)
plot(res)


# URBANIZATION SCORE
m2_RL.ZI <- glmmTMB(Rhyssomatus_lineaticollis_bin ~
                      Block +
                      (1|Sample) +
              (1|Population) +
              Urb_score,
              data = herbivores ,
              family = binomial(),
              ziformula=~1,
              REML = F) # not converging... tried taking out block and sample separately, then together... then took out family and finally converged. Could add block and sample back in
res <- simulateResiduals(m2_RL.ZI)
plot(res)
```

#### Urban sites
```{r}
# DISTANCE FROM CITY CENTER
m1_RL.urb <- glmmTMB(Rhyssomatus_lineaticollis_bin ~
           #   Block + 
                (1|Population/Family) + 
           #     (1|Sample) +
              City_dist * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = binomial) # won't converge unless I take out block and sample
res <- simulateResiduals(m1_RL.urb)
plot(res) 
car::Anova(m1_RL.urb)

# main effects model:
m1_RL.urb_ME <- glmmTMB(Rhyssomatus_lineaticollis_bin ~
            #  Block +
                (1|Population/Family) +
            #    (1|Sample) +
              City_dist + Transect_ID,
              data = herbivores %>%
                filter(., Transect_ID != "Rural"),
              family = binomial) # can't get this to converge w/o taking out block and sample

AIC(m1_RL.urb,
    m1_RL.urb_ME) # stat equiv but ME best


# URBANIZATION SCORE
m2_RL.urb <- glmmTMB(Rhyssomatus_lineaticollis_bin ~
              Block +
                (1|Population/Family) +
            #    (1|Sample) +
              Urb_score * Transect_ID,
              data = herbivores %>% 
                filter(., Transect_ID != "Rural"),
              family = binomial) 
res <- simulateResiduals(m2_RL.urb)
plot(res) # won't converge unless I take out sample



# main effects model:
m2_RL.urb_ME <- glmmTMB(Rhyssomatus_lineaticollis_bin ~
              Block + 
                (1|Population/Family) +
            #    (1|Sample) +
              Urb_score + Transect_ID,
              data = herbivores %>%
                filter(., Transect_ID != "Rural"),
              family = poisson) # this works

AIC(m2_RL.urb,
    m2_RL.urb_ME) # stat equiv but ME best
```


# Models for use in analysis
## Monarchs
```{r}
monarch_mods <- list(

## City_dist / gradient
m1_DP ,

## Urbanization score / gradient
m2_DP ,

## City_dist / urban subtransects
m1_DP.urb, # Qualitatively identical model (<2 AIC away)
m1_DP.urb_ME, # Best model

## Urbanization score  / urban subtransects
m2_DP.urb, # Qualitatively identical model (<2 AIC away)
m2_DP.urb_ME # Best model

)

names(monarch_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```

## Tetraopes
```{r}
tetraopes_mods <- list(

## City_dist / gradient
m1_TT.urb ,

## Urbanization score / gradient
m2_TT ,

## City_dist / urban subtransects
m1_TT.urb, # Qualitatively identical model (<2 AIC away)
m1_TT.urb_ME, # Best model

## Urbanization score  / urban subtransects
m2_TT.urb, # Qualitatively identical model (<2 AIC away)
m2_TT.urb_ME # Best model

)

names(tetraopes_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```


## Liriomyza
```{r}
liriomyza_mods <- list(

## City_dist / gradient
m1_LA.urb ,

## Urbanization score / gradient
m2_LA ,

## City_dist / urban subtransects
m1_LA.urb.nb, # Qualitatively identical model (<2 AIC away)
m1_LA.urb.nb_ME, # Best model

## Urbanization score  / urban subtransects
m2_LA.urb.nb, # Qualitatively identical model (<2 AIC away)
m2_LA.urb.nb_ME # Best model

)

names(liriomyza_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```

## Aphis nerii
```{r}
nerii_mods <- list(

## City_dist / gradient
m1_AN.nb ,

## Urbanization score / gradient
m2_AN.nb ,

## City_dist / urban subtransects
m1_AN.urb.nb, # Best model
m1_AN.urb.nb_ME, # Qualitatively identical model (<2 AIC away)

## Urbanization score  / urban subtransects
m2_AN.urb.nb, # Qualitatively identical model (<2 AIC away)
m2_AN.urb.nb_ME # Best model

)

names(nerii_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_best",
                     "City_urbsubs_alt",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```


## Aphis asclepiadis
```{r}
aasclepiadis_mods <- list(

## City_dist / gradient
m1_AA.nb ,

## Urbanization score / gradient
m2_AA.nb ,

## City_dist / urban subtransects
m1_AA.urb.nb, # Qualitatively identical model (<2 AIC away)
m1_AA.urb.nb_ME, # Best model

## Urbanization score  / urban subtransects
m2_AA.urb.nb, # Qualitatively identical model (<2 AIC away)
m2_AA.urb.nb_ME # Best model

)

names(aasclepiadis_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```


## Myzocallis asclepiadis
```{r}
masclepiadis_mods <- list(

## City_dist / gradient
m1_MA.nb ,

## Urbanization score / gradient
m2_MA.nb ,

## City_dist / urban subtransects
m1_MA.urb.nb, # Qualitatively identical model (<2 AIC away)
m1_MA.urb.nb_ME, # Best model

## Urbanization score  / urban subtransects
m2_MA.urb.nb, # Qualitatively identical model (<2 AIC away)
m2_MA.urb.nb_ME # Best model

)

names(masclepiadis_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```

## Euchaetes egle
```{r}
euchaetes_mods <- list(

## City_dist / gradient
m1_EE.nb ,

## Urbanization score / gradient
m2_EE.nb ,

## City_dist / urban subtransects
m1_EE.urb.nb, # Qualitatively identical model (<2 AIC away)
m1_EE.urb.nb_ME, # Best model

## Urbanization score  / urban subtransects
m2_EE.urb.nb, # Qualitatively identical model (<2 AIC away)
m2_EE.urb.nb_ME # Best model

)

names(euchaetes_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```


## Lygaeus kalmii
```{r}
lygaeus_mods <- list(

## City_dist / gradient
m1_LK.nb ,

## Urbanization score / gradient
m2_LK.nb ,

## City_dist / urban subtransects
m1_LK.urb.nb, # Qualitatively identical model (<2 AIC away)
m1_LK.urb.nb_ME, # Best model

## Urbanization score  / urban subtransects
m2_LK.urb.nb, # Qualitatively identical model (<2 AIC away)
m2_LK.urb.nb_ME # Best model

)

names(lygaeus_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```

## Labidomera clivicollis
```{r}
labidomera_mods <- list(

## City_dist / gradient
m1_LC.nb ,

## Urbanization score / gradient
m2_LC.nb ,

## City_dist / urban subtransects
m1_LC.urb.nb, # Qualitatively identical model (<2 AIC away)
m1_LC.urb.nb_ME, # Best model

## Urbanization score  / urban subtransects
m2_LC.urb.nb, # Qualitatively identical model (<2 AIC away)
m2_LC.urb.nb_ME # Best model

)

names(labidomera_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```

## Rhyssomatus lineaticollis
```{r}
rhyssomatus_mods <- list(

## Ci4ty_dist / gradient
m1_RL ,

## Urbanization score / gradient
m1_RL.urb ,

## City_dist / urban subtransects
m1_RL.urb, # Qualitatively identical model (<2 AIC away)
m1_RL.urb_ME, # Best model

## Urbanization score  / urban subtransects
m2_RL.urb, # Qualitatively identical model (<2 AIC away)
m2_RL.urb_ME # Best model

)

names(rhyssomatus_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```

# Export ANOVA
## Monarchs
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(monarch_mods[c(1,4)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/Monarchs_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(monarch_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/Monarchs_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(monarch_mods[3]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/Monarchs_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(monarch_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/Monarchs_urbscore_alt.png"))
```

## tetraopes
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(tetraopes_mods[c(1,4)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/tetraopes_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(tetraopes_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/tetraopes_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(tetraopes_mods[3]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/tetraopes_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(tetraopes_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/tetraopes_urbscore_alt.png"))
```


## liriomyza
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(liriomyza_mods[c(1,4)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/liriomyza_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(liriomyza_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/liriomyza_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(liriomyza_mods[3]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/liriomyza_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(liriomyza_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/liriomyza_urbscore_alt.png"))
```


## Aphis nerii
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(nerii_mods[c(1,3)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/nerii_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(nerii_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/nerii_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(nerii_mods[4]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/nerii_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(nerii_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/nerii_urbscore_alt.png"))
```


## Aphis asclepiadis
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(aasclepiadis_mods[c(1,4)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/aasclepiadis_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(aasclepiadis_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/aasclepiadis_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(aasclepiadis_mods[3]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/aasclepiadis_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(aasclepiadis_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/aasclepiadis_urbscore_alt.png"))
```

## Myzocallis asclepiadis
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(masclepiadis_mods[c(1,4)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/masclepiadis_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(masclepiadis_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/masclepiadis_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(masclepiadis_mods[3]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/masclepiadis_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(masclepiadis_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/masclepiadis_urbscore_alt.png"))
```

## Euchaetes egle
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(euchaetes_mods[c(1,4)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/euchaetes_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(euchaetes_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/euchaetes_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(euchaetes_mods[3]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/euchaetes_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(euchaetes_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/euchaetes_urbscore_alt.png"))
```

## Lygaeus kalmii
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(lygaeus_mods[c(1,4)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/lygaeus_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(lygaeus_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/lygaeus_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(lygaeus_mods[3]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/lygaeus_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(lygaeus_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/lygaeus_urbscore_alt.png"))
```
## Labidomera clivicollis
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(labidomera_mods[c(1,4)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/labidomera_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(labidomera_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/labidomera_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(labidomera_mods[3]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/labidomera_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(labidomera_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/labidomera_urbscore_alt.png"))
```
## Rhyssomatus lineaticollis
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(rhyssomatus_mods[c(1,4)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/rhyssomatus_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(rhyssomatus_mods[c(2,6)]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Best_models/rhyssomatus_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(rhyssomatus_mods[3]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/rhyssomatus_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(rhyssomatus_mods[5]) %>%
  save_as_image(., path = here::here("./Figures_Tables/ANOVA_1yr/2020_Herbivores/Alt_models/rhyssomatus_urbscore_alt.png"))
```
