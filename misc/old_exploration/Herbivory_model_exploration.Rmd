---
title: "Comparing models for herbivory"
author: "Sophie Breitbart"
date: "3/28/2022"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
---

# Set up notebook
## Load libraries

```{r message=FALSE}
library(car)
library(glmmTMB)
library(magrittr)
library(tidyverse)
library(DHARMa)
library(performance)
```

## Import data

```{r}
herbivory <- read.csv(here::here("./data/Joined_annual_data/herbivory.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor)

```

## Explore data
```{r}
hist(herbivory$Herbivory_mean_early, breaks = 50) # lots of zeroes

car::qqPlot(herbivory$Herbivory_mean_early, "norm")
car::qqPlot(herbivory$Herbivory_mean_early, "lnorm")
# these don't fit well
```

# Fit Models
## Basic Model
Model diagnostic plots for this and next chunk are shown individually, instead of in a grid like the others, so that they can be viewed properly.
```{r}
basic_mod <- glmmTMB(Herbivory_mean_early ~
                               (1|Block) +
                               (1|Year) + 
                               (1|Population/Family) +
                                City_dist,
                              data = herbivory,
                              REML = F) # Doesn't converge. Remove block

basic_mod2 <- glmmTMB(Herbivory_mean_early ~
                             #  (1|Block) +
                               (1|Year) + 
                               (1|Population/Family) +
                                City_dist,
                              data = herbivory,
                              REML = F) 

performance::check_model(basic_mod2) # Right-skewed

plot(DHARMa::simulateResiduals(basic_mod2)) # fails KS (Kolmogorov-Smirnov Goodness of Fit Test) and outlier tests
```

## Arcsin(sqrt()) transformation with Gaussian model

```{r}
# First, recode values to within 0:1
herbivory$Herbivory_mean_early_recode <- herbivory$Herbivory_mean_early
herbivory$Herbivory_mean_early_recode[herbivory$Herbivory_mean_early_recode == 1] <- 0.999999
herbivory$Herbivory_mean_early_recode[herbivory$Herbivory_mean_early_recode == 0] <- 0.000001

asin_sqrt_mod <- glmmTMB(asin(sqrt(Herbivory_mean_early_recode)) ~
                               (1|Block) +
                               (1|Year) + 
                                 (1|Population/Family) +
                                 City_dist,
                              data = herbivory,
                              REML = F)

performance::check_model(asin_sqrt_mod,
                         panel = FALSE) # Still right-skewed

plot(DHARMa::simulateResiduals(asin_sqrt_mod)) # fails KS and outlier tests
```

## Binomial Model

```{r}
bin_mod <- glmmTMB(Herbivory_mean_early ~
                                 (1|Block) +
                                 (1|Year) + 
                                 (1|Population/Family) +
                                 City_dist,
                              data = herbivory,
                              family = binomial(),
                              REML = F) # convergence issue. Try removing block

bin_mod2 <- glmmTMB(Herbivory_mean_early ~
                               #  (1|Block) +
                                 (1|Year) + 
                                 (1|Population/Family) +
                                 City_dist,
                              data = herbivory,
                              family = binomial(),
                              REML = F) # convergence issue. Try removing block AND year

bin_mod3 <- glmmTMB(Herbivory_mean_early ~
                               #  (1|Block) +
                               #  (1|Year) + 
                                 (1|Population/Family) +
                                 City_dist,
                              data = herbivory,
                              family = binomial(link = logit),
                              REML = F) # Now it converges.

# Check model assumptions
performance::check_model(bin_mod3) # very right-skewed 
performance::check_overdispersion(bin_mod3) # not overdispersed
performance::check_outliers(bin_mod3) # no outliers

plot(DHARMa::simulateResiduals(bin_mod3)) # fails KS, dispersion, and outlier tests


# zero-inflated binomial
bin_mod4 <- glmmTMB(Herbivory_mean_early ~
                               #  (1|Block) +
                               #  (1|Year) + 
                                 (1|Population/Family) +
                                 City_dist,
                              data = herbivory,
                              family = binomial(link = logit),
                    ziformula = ~1,
                              REML = F) 

# Check model assumptions
performance::check_model(bin_mod4) # very right-skewed, same 
# performance::check_overdispersion(bin_mod4) # can't check
performance::check_outliers(bin_mod4) # no outliers

plot(DHARMa::simulateResiduals(bin_mod4)) # fails KS, dispersion, and outlier tests

# try neg binom
nbin_mod1 <- glmmTMB(Herbivory_mean_early ~
                               #  (1|Block) +
                               #  (1|Year) + 
                                 (1|Population/Family) +
                                 City_dist,
                              data = herbivory,
                              family = nbinom1(),
                              REML = F) # won't converge

nbin_mod2 <- glmmTMB(Herbivory_mean_early ~
                               #  (1|Block) +
                               #  (1|Year) + 
                                 (1|Population/Family) +
                                 City_dist,
                              data = herbivory,
                              family = nbinom2,
                              REML = F) # won't converge
```

## Beta Model
### Regular herbivory values
```{r}
beta_mod <- glmmTMB(Herbivory_mean_early_recode  ~
                      (1|Block) +
                      (1|Year) +
                      (1|Population/Family) +
                      City_dist,
                    data = herbivory,
                    family = beta_family(link="logit"),
                    REML = F)

performance::check_model(beta_mod) # heavy right tail
plot(DHARMa::simulateResiduals(beta_mod)) # fails KS test only


# zero-augmented beta model
beta_mod1 <- glmmTMB(Herbivory_mean_early_recode  ~
                     # (1|Block) +
                      (1|Year) +
                      (1|Population/Family) +
                      City_dist,
                    data = herbivory,
                    ziformula = ~1,
                    family = beta_family(link="logit"),
                    REML = F) # doesn't converge with all effects included

plot(DHARMa::simulateResiduals(beta_mod1)) # fails KS test and residual vs. predicted plot problematic

```

### Inverted herbivory values
```{r}
beta_mod_inv <- glmmTMB((1-Herbivory_mean_early)  ~
                      (1|Block) +
                      (1|Year) +
                      (1|Population/Family) +
                      City_dist,
                    data = herbivory,
                    family = beta_family(link="logit"),
                    REML = F) # Error in eval(family$initialize) : y values must be 0 < y < 1

plot(DHARMa::simulateResiduals(beta_mod_inv)) # fails KS test only


# zero-augmented beta model
beta_mod_inv2 <- glmmTMB((1-Herbivory_mean_early)  ~
                     # (1|Block) +
                      (1|Year) +
                      (1|Population/Family) +
                      City_dist,
                    data = herbivory,
                    ziformula = ~1,
                    family = beta_family(link="logit"),
                    REML = F) # same error as above

```


## Hurdle model

```{r}
# hurdle_mod1 <- glmmTMB(Herbivory_mean_early_recode  ~
#                       (1|Block) +
#                       (1|Year) +
#                       (1|Population/Family) +
#                       City_dist,
#                     data = herbivory,
#                     family = truncated_nbinom1,
#                     ziformula = ~1,
#                     REML = F) # won't run

```

## Manual hurdle model
I create a binary model- was there any herbivory?- then, a quantitative model- how much herbivory, if it was present?

### Binary model
```{r}
# first, create new column with 0/1 indicating any herbivory
herbivory %<>%
  mutate(Herbivory_mean_early_binary = case_when(
    Herbivory_mean_early == 0 ~ 0,
    Herbivory_mean_early > 0 ~ 1)
  )

binary_mod1 <- glmmTMB(Herbivory_mean_early_binary ~
                               (1|Block) +
                               (1|Year) + 
                               (1|Population/Family) +
                                City_dist,
                              data = herbivory,
                       family = binomial,
                              REML = F)

# Check model assumptions
plot(DHARMa::simulateResiduals(binary_mod1)) # looks great
```

### Quantitative model
```{r}
quant_mod1 <- glmmTMB(log(Herbivory_mean_early) ~
                               (1|Block) +
                               (1|Year) + 
                               (1|Population/Family) +
                                City_dist,
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1),
                              REML = F) # log-transformed after looking at untransformed, sqrt, cube root models

# Check model assumptions
plot(DHARMa::simulateResiduals(quant_mod1)) # looks great

performance::check_model(quant_mod1) # looks great
```

# Compare models

```{r}
# AIC(basic_mod2,
#     asin_sqrt_mod,
#     bin_mod4,
#     beta_mod,
#     binary_mod1,
#     quant_mod1)

performance::compare_performance(basic_mod2,
    asin_sqrt_mod,
    bin_mod4,
    beta_mod,
    binary_mod1,
    quant_mod1)

```
