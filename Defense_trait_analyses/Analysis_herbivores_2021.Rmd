
* Herbivore surveys were done twice: Once in July, once in August.
* The species observed are in the column names. The only species with two columns was the Monarch butterfly:
    + one column for Monarchs that had been on the plant in the past ("mean_Monarch_Quantity_Past") and which refers to empty chrysalis, empty eggs, and chrysalis with a dead butterfly inside, and
    + one column for alive Monarchs present on the plant itself ("mean_Monarch_Quantity_Observed") and which refers to all other Monarch forms (caterpillars, eggs, chrysalises with insects still inside)
* Monarchs notwithstanding, dead herbivores were not counted in the surveys. After Hellinger transformation, though, the mean_Monarch_Quantity_Past column had been converted to all 0's.
* Environmental variables are as follows:
    + To quantify urbanization, both distance from the city center and urbanization score were used, separately.
    + Transect was also used as a variable when analyzing the urban sites ONLY (i.e. excluding rural sites).

# Set up notebook
## Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import data
```{r}
herbivores <- read.csv(here::here("./Joined_annual_data/herbivores.csv")) %>%
  dplyr::select(., -1) %>%
  dplyr::mutate_at(vars(c("Population",
                          "Family",
                          "Replicate",
                          "Block",
                          "Transect_ID",
                          "Sample",
                          "Patch_ID",
                          "Urb_Rur",
                          "Year",
                          "Surveyor",
                          "Date")),
                   as.character) %>%
    dplyr::mutate_at(vars(c("Population",
                            "Family",
                            "Replicate",
                            "Block",
                            "Transect_ID",
                            "Sample",
                            "Patch_ID",
                            "Urb_Rur",
                            "Year",
                            "Surveyor",
                          "Date")),
                     as.factor) %>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))
```

## Import final models
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_herbivores.Rmd", quiet=TRUE))

all_models <- list(
monarch_mods          , 
asclepiadis_mods           , 
clivicollis_mods)

names(all_models) <- c(
"monarch_mods"          ,
"asclepiadis_mods"           ,
"clivicollis_mods"         )
```

### Create separate lists of best vs. alt models for city_dist vs urb_score
#### Monarchs
```{r}
## Best
### City_dist
monarch_mods_best_c <- monarch_mods[c(1,4)]

### Urb_score
monarch_mods_best_u <- monarch_mods[c(2,6)]

## Alt
### City_dist
monarch_mods_alt_c <- monarch_mods[3]

### Urb_score
monarch_mods_alt_u <- monarch_mods[5]
```

#### L. asclepiadis
```{r}
## Best
### City_dist
asclepiadis_mods_best_c <- asclepiadis_mods[c(1,4)]

### Urb_score
asclepiadis_mods_best_u <- asclepiadis_mods[c(2,6)]

## Alt
### City_dist
asclepiadis_mods_alt_c <- asclepiadis_mods[3]

### Urb_score
asclepiadis_mods_alt_u <- asclepiadis_mods[5]
```


#### L. clivicollis
```{r}
## Best
### City_dist
clivicollis_mods_best_c <- clivicollis_mods[c(1,3)]

### Urb_score
clivicollis_mods_best_u <- clivicollis_mods[c(2,6)]

## Alt
### City_dist
clivicollis_mods_alt_c <- clivicollis_mods[4]

### Urb_score
clivicollis_mods_alt_u <- clivicollis_mods[5]

```

# Ranova
## Set seed
```{r}
set.seed(45)
```

## Gradient / City_dist
### non-Gaussian models
#### Monarchs
```{r}
# 2020-----
monarch_ranova1 <- glmer.nb(Monarch_Quantity_Observed ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                              dplyr::filter(Year == 2020),
                            na.action = na.exclude)

# performance::check_model(monarch_ranova1)

pb_ranova_2step(monarch_ranova1,
          "Monarch butterfly: 2020",
          "./Defense_trait_analyses/Tables/Ranova/Monarch_2020.docx")

# 2021-----
monarch_ranova2 <- glmer.nb(Monarch_Quantity_Observed ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                              dplyr::filter(Year == 2021),
                            na.action = na.exclude)

# performance::check_model(monarch_ranova2)

pb_ranova_2step(monarch_ranova2,
          "Monarch butterfly: 2021",
          "./Defense_trait_analyses/Tables/Ranova/Monarch_2021.docx")
```

#### L. asclepiadis
```{r}
# 2020-----
asclepiadis_ranova1 <- glmer.nb(Liriomyza_asclepiadis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                              dplyr::filter(Year == 2020),
                            na.action = na.exclude)

# performance::check_model(asclepiadis_ranova1)

pb_ranova_2step(asclepiadis_ranova1,
          "Liriomyza asclepiadis: 2020",
          "./Defense_trait_analyses/Tables/Ranova/asclepiadis_2020.docx")


# 2021-----
asclepiadis_ranova2 <- glmer.nb(Liriomyza_asclepiadis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                              dplyr::filter(Year == 2021),
                            na.action = na.exclude)

# performance::check_model(asclepiadis_ranova2)

pb_ranova_2step(asclepiadis_ranova2,
          "Liriomyza asclepiadis: 2021",
          "./Defense_trait_analyses/Tables/Ranova/asclepiadis_2021.docx")
```

#### L. clivicollis
```{r}
# 2020-----
clivicoll_ranova1 <- glmer.nb(Labidomera_clivicollis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                dplyr::filter(Labidomera_clivicollis < 9 &
                                Year == 2020),
                            na.action = na.exclude)

# performance::check_model(clivicoll_ranova1)

pb_ranova_2step(clivicoll_ranova1,
          "Labidomera clivicollis: 2020",
          "./Defense_trait_analyses/Tables/Ranova/clivicollis_2020.docx")


# 2021-----
clivicoll_ranova2 <- glmer.nb(Labidomera_clivicollis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                dplyr::filter(Year == 2021),
                            na.action = na.exclude)

# performance::check_model(clivicoll_ranova2)

pb_ranova_2step(clivicoll_ranova2,
          "Labidomera clivicollis: 2021",
          "./Defense_trait_analyses/Tables/Ranova/clivicollis_2021.docx")

```

## Urban Subtransects / City_dist
### non-Gaussian models
#### Monarchs
```{r}
# 2020-----
monarchs_ranova1_pb <- glmer.nb(Monarch_Quantity_Observed ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2020),
                            na.action = na.exclude) 

# performance::check_model(monarchs_ranova1_pb)

pb_ranova_transects(monarchs_ranova1_pb,
          "Monarch butterfly: 2020",
          "./Defense_trait_analyses/Tables/Ranova/monarch_2020_transects.docx")


# 2021-----
monarchs_ranova2_pb <- glmer.nb(Monarch_Quantity_Observed ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2021),
                control = glmerControl(optimizer = "Nelder_Mead"),
                            na.action = na.exclude)

# performance::check_model(monarchs_ranova2_pb)

summary(monarchs_ranova2_pb) # again, nearly zero variance among families and pops- on the order of 1x10^-11

pb_ranova_transects(monarchs_ranova2_pb,
          "Monarch butterfly: 2021",
          "./Defense_trait_analyses/Tables/Ranova/monarch_2021_transectstest.docx")

```

#### L. asclepiadis
```{r}
# 2020-----
asclepiadis_ranova1_pb <- glmer.nb(Liriomyza_asclepiadis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2020),
                            na.action = na.exclude,
                            nAGQ = 0) # won't converge w/o this)

# performance::check_model(asclepiadis_ranova1_pb)

pb_ranova_transects(asclepiadis_ranova1_pb,
          "Liriomyza asclepiadis: 2020",
          "./Defense_trait_analyses/Tables/Ranova/asclepiadis_2020_transects.docx")


# 2021-----
asclepiadis_ranova2_pb <- glmer.nb(Liriomyza_asclepiadis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2021),
                            na.action = na.exclude)

# performance::check_model(asclepiadis_ranova2_pb)

pb_ranova_transects(asclepiadis_ranova2_pb,
          "Liriomyza asclepiadis: 2021",
          "./Defense_trait_analyses/Tables/Ranova/asclepiadis_2021_transects.docx")

```

#### L. clivicollis
```{r}
# 2020-----
clivicollis_ranova1_pb <- glmer.nb(Labidomera_clivicollis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2020),
                            na.action = na.exclude)

# performance::check_model(clivicollis_ranova1_pb)

pb_ranova_transects(clivicollis_ranova1_pb,
          "Labidomera clivicollis: 2020",
          "./Defense_trait_analyses/Tables/Ranova/clivicollis_2020_transects.docx")


# 2021-----
clivicollis_ranova2_pb <- glmer.nb(Labidomera_clivicollis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2021),
                nAGQ = 0,
                            na.action = na.exclude)

# performance::check_model(clivicollis_ranova2_pb)

pb_ranova_transects(clivicollis_ranova2_pb,
          "Labidomera clivicollis: 2021",
          "./Defense_trait_analyses/Tables/Ranova/clivicollis_2021_transects.docx")

```

## Recalculate PVE for non-Gaussian models
As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution.
The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection.
These new PVEs will be estimates. This is *not* a perfect solution but it will help us approximate PVE for these variables.
### Q1
```{r}
# main models
monarch_lmer <- lmer(Monarch_Quantity_Observed ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

lasclep_lmer <- lmer(Liriomyza_asclepiadis ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

lclivicoll_lmer <- lmer(Labidomera_clivicollis ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                               dplyr::filter(Year == 2021),
                          na.action = na.exclude)

# get PVE from models
pve_mon <- PVE_lm(monarch_lmer) 
pve_lasclep <- PVE_lm(lasclep_lmer)
pve_lclivi <- PVE_lm(lclivicoll_lmer)

pve_mon_city <- PVE_lm(update(monarch_lmer, .~. + City_dist))
pve_lasclep_city <- PVE_lm(update(lasclep_lmer, .~. + City_dist))
pve_lclivi_city <- PVE_lm(update(lclivicoll_lmer, .~. + City_dist))

pve_mon_urbsc <- PVE_lm(update(monarch_lmer, .~. + Urb_score))
pve_lasclep_urbsc <- PVE_lm(update(lasclep_lmer, .~. + Urb_score))
pve_lclivi_urbsc <- PVE_lm(update(lclivicoll_lmer, .~. + Urb_score))


# make tables
recalc_tab1 <- pve_table_recalc(pve_mon, pve_lasclep, pve_lclivi,
                 "Danaus plexippus",
                 "Liriomyza asclepiadis",
                 "Labidomera clivicollis")

recalc_tab2 <- pve_table_recalc(pve_mon_city, pve_lasclep_city, pve_lclivi_city,
                 "Danaus plexippus",
                 "Liriomyza asclepiadis",
                 "Labidomera clivicollis")

recalc_tab3 <- pve_table_recalc(pve_mon_urbsc, pve_lasclep_urbsc, pve_lclivi_urbsc,
                 "Danaus plexippus",
                 "Liriomyza asclepiadis",
                 "Labidomera clivicollis")

# Export to word
export_recalc(recalc_tab1,
              recalc_tab2,
              recalc_tab3,
              "./Defense_trait_analyses/Tables/Ranova/PVE_nonGaussmods/PVE_nonGaussmods_herbivores_Q1.docx")

```

### Q2
```{r}
# main models
monarch_lmer2 <- update(monarch_lmer,
                             data = herbivores %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"))

lasclep_lmer2 <- update(lasclep_lmer,
                             data = herbivores %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"))

lclivicoll_lmer2 <- update(lclivicoll_lmer,
                             data = herbivores %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"),
                           control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

# get PVE from models
pve_mon2 <- PVE_lm(monarch_lmer2) 
pve_lasclep2 <- PVE_lm(lasclep_lmer2)
pve_lclivi2 <- PVE_lm(lclivicoll_lmer2)

pve_mon_city2 <- PVE_lm(update(monarch_lmer2, .~. + City_dist*Transect_ID))
pve_lasclep_city2 <- PVE_lm(update(lasclep_lmer2, .~. + City_dist*Transect_ID))
pve_lclivi_city2 <- PVE_lm(update(lclivicoll_lmer2, .~. + City_dist*Transect_ID))

pve_mon_urbsc2 <- PVE_lm(update(monarch_lmer2, .~. + Urb_score*Transect_ID))
pve_lasclep_urbsc2 <- PVE_lm(update(lasclep_lmer2, .~. + Urb_score*Transect_ID))
pve_lclivi_urbsc2 <- PVE_lm(update(lclivicoll_lmer2, .~. + Urb_score*Transect_ID))


# make tables
recalc_tab1 <- pve_table_recalc(pve_mon2, pve_lasclep2, pve_lclivi2,
                 "Danaus plexippus",
                 "Liriomyza asclepiadis",
                 "Labidomera clivicollis")

recalc_tab2 <- pve_table_recalc(pve_mon_city2, pve_lasclep_city2, pve_lclivi_city2,
                 "Danaus plexippus",
                 "Liriomyza asclepiadis",
                 "Labidomera clivicollis")

recalc_tab3 <- pve_table_recalc(pve_mon_urbsc2, pve_lasclep_urbsc2, pve_lclivi_urbsc2,
                 "Danaus plexippus",
                 "Liriomyza asclepiadis",
                 "Labidomera clivicollis")

# Export to word
export_recalc(recalc_tab1,
              recalc_tab2,
              recalc_tab3,
              "./Defense_trait_analyses/Tables/Ranova/PVE_nonGaussmods/PVE_nonGaussmods_herbivores_Q2.docx")

```

# ANOVA
## Monarchs
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(monarch_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/monarch_citydist.png"))

lapply(monarch_mods_best_c, MuMIn::r.squaredGLMM)
# lapply(monarch_mods_best_c, r2glmm::r2beta, method = 'sgv',
#                                            data = herbivores)
# can't handle glmmtmb objects... if want partial R2, will have to recreate models manually w/glmer

```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(monarch_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/monarch_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(monarch_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/monarch_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(monarch_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/monarch_urbscore_alt.png"))
```
## L. asclepiadis
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(asclepiadis_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/asclepiadis_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(asclepiadis_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/asclepiadis_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(asclepiadis_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/asclepiadis_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(asclepiadis_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/asclepiadis_urbscore_alt.png"))
```

## L. clivicollis
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(clivicollis_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/clivicollis_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(clivicollis_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/clivicollis_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(clivicollis_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/clivicollis_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(clivicollis_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/clivicollis_urbscore_alt.png"))
```

## Export all best / alt models in separate word docs
### Distance / best
```{r}
all_models_best_c <- list(
monarch_mods_best_c      , 
asclepiadis_mods_best_c     , 
clivicollis_mods_best_c       )


anovas_best_c <- lapply(all_models_best_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_c, "./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/all_anova_herbivores_best_distance.docx")
```

### Distance / alt
```{r}
all_models_alt_c <- list(
monarch_mods_alt_c      , 
asclepiadis_mods_alt_c     , 
clivicollis_mods_alt_c      )

anovas_alt_c <- lapply(all_models_alt_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_c, "./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/all_anova_herbivores_alt_distance.docx")
```

### UrbScore / best
```{r}
all_models_best_u <- list(
monarch_mods_best_u      ,
asclepiadis_mods_best_u     , 
clivicollis_mods_best_u     ) 

anovas_best_u <- lapply(all_models_best_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_u, "./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/all_anova_herbivores_best_urbscore.docx")
```

### UrbScore / alt
```{r}
all_models_alt_u <- list(
monarch_mods_alt_u      , 
asclepiadis_mods_alt_u     , 
clivicollis_mods_alt_u        ) 

anovas_alt_u <- lapply(all_models_alt_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_u, "./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/all_anova_herbivores_alt_urbscore.docx")

```

## Export comparisons of anovas w/1 vs. all years
### Q1
```{r}
# Monarchs-----
compare_anovas(
  update(monarch_mods_best_c[[1]], .~. - City_dist),
  herbivores,
  "2021",
  "Danaus plexippus abundance",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/monarch.docx")

# L. asclepiadis-----
compare_anovas(
  update(asclepiadis_mods_best_c[[1]], .~. - City_dist),
  herbivores,
  "2021",
  "Liriomyza asclepiadis abundance",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/asclepiadis.docx")

# L. clivicollis-----
## doing this manually b/c I need to filter the dataset to exclude values > 9

var_name <- "Labidomera clivicollis abundance"
filepath <- "./Defense_trait_analyses/Tables/Comparing_ANOVA/clivicollis.docx"
last_year <- "2021"

  # city_dist
  anov1.d <- tidy_anova(clivicollis_mods_best_c[[1]]) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_dist <- update(clivicollis_mods_best_c[[1]],
                    .~. - Year,
                    data = herbivores %>%
                dplyr::filter(Labidomera_clivicollis < 9 &
                            Year == last_year))
  
  anov2.d <- tidy_anova(mod_1yr_dist) %>%
    make_flxtable(., var_name)
  
  
  # urb_score
  mod_allyrs_usc <- update(clivicollis_mods_best_c[[1]], .~. + Urb_score - City_dist)
  
  anov1.u <- tidy_anova(mod_allyrs_usc) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_usc <- update(mod_allyrs_usc,
                    .~. - Year,
                     data = herbivores %>%
                dplyr::filter(Labidomera_clivicollis < 9 &
                            Year == last_year))
  
  anov2.u <- tidy_anova(mod_1yr_usc) %>%
    make_flxtable(., var_name)
  
  
  # Export
  word_export <- read_docx()
  
  body_add_par(word_export, "Urbanization = Distance to City Center",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(clivicollis_mods_best_c[[1]])),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.d)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_dist)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.d)
  
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "") 
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, "Urbanization = Urbanization Score",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_allyrs_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.u)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.u)
  
  print(word_export, here::here(filepath))

rm(var_name, filepath, last_year,anov1.d, mod_1yr_dist, anov2.d, mod_allyrs_usc, anov1.u, mod_1yr_usc, anov2.u)



```

### Q2
```{r}
# Monarchs-----
compare_anovas_transects(
  update(monarch_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  herbivores,
  "2021",
  "Danaus plexippus abundance",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/monarch_transects.docx")

# L. asclepiadis-----
compare_anovas_transects(
  update(asclepiadis_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  herbivores,
  "2021",
  "Liriomyza asclepiadis abundance",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/asclepiadis_transects.docx")

# L. clivicollis-----
## doing this manually b/c I need to filter the dataset to exclude values > 20

var_name <- "Labidomera clivicollis abundance"
filepath <- "./Defense_trait_analyses/Tables/Comparing_ANOVA/clivicollis_transects.docx"
last_year <- "2021"

  # City_dist*Transect_ID
  anov1.d <- tidy_anova(clivicollis_mods_best_c[[2]]) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_dist <- update(clivicollis_mods_best_c[[2]],
                    .~. - Year,
                    data = herbivores %>%
                        dplyr::filter(
                          Labidomera_clivicollis < 20 &
                            Year == last_year &
                            Transect_ID != "Rural"))
  
  anov2.d <- tidy_anova(mod_1yr_dist) %>%
    make_flxtable(., var_name)
  
  
  # Urb_score*Transect_ID
  mod_allyrs_usc <- update(clivicollis_mods_best_c[[2]], .~. + Urb_score*Transect_ID - City_dist*Transect_ID + Transect_ID)
  
  anov1.u <- tidy_anova(mod_allyrs_usc) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_usc <- update(mod_allyrs_usc,
                    .~. - Year,
                     data = herbivores %>%
                        dplyr::filter(
                          Labidomera_clivicollis < 20 &
                            Year == last_year &
                            Transect_ID != "Rural"))
  
  anov2.u <- tidy_anova(mod_1yr_usc) %>%
    make_flxtable(., var_name)
  
  
  # Export
  word_export <- read_docx()
  
  body_add_par(word_export, "Urbanization = Distance to City Center",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(herb_e_quant_mods_best_c[[2]])),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.d)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_dist)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.d)
  
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "") 
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, "Urbanization = Urbanization Score",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_allyrs_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.u)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.u)
  
  print(word_export, here::here(filepath))

rm(var_name, filepath, last_year,anov1.d, mod_1yr_dist, anov2.d, mod_allyrs_usc, anov1.u, mod_1yr_usc, anov2.u)

```


# R-sq values
```{r}
# change REML to T
monarch_mods_reml_T <- reml_to_true(monarch_mods)
asclepiadis_mods_reml_T <- reml_to_true(asclepiadis_mods)
clivicollis_mods_reml_T <- reml_to_true(clivicollis_mods)

all_models_reml_T <- list(
monarch_mods_reml_T          , 
asclepiadis_mods_reml_T           , 
clivicollis_mods_reml_T)

names(all_models_reml_T) <- c(
"monarch_mods"          ,
"asclepiadis_mods"           ,
"clivicollis_mods"         )

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Defense_trait_analyses/Tables/Rsquare_herbivores.csv"))


# export as nice tables in word doc
mon_r2 <- make_r2_table(monarch_mods_reml_T)
ascl_r2 <- make_r2_table(asclepiadis_mods_reml_T)
clivi_r2 <- make_r2_table(clivicollis_mods_reml_T)

export_r2(mon_r2, ascl_r2, clivi_r2, 
          "Danaus plexippus",
          "Liriomyza asclepiadis", 
          "Labidomera clivicollis",
          "./Defense_trait_analyses/Tables/R2_herbivores.docx")
```

# Calculate heritability & Qst
Just looking at gradient models- all pops included. 
h2 represents the average heritability across populations after removing the genetic effects due to population differences.
```{r}
# Monarchs-----
VarCorr(
  update(
    monarch_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    monarch_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(0.146429,
            0.069211,
            resid_var)

monarch_mean <- herbivores %>%
  dplyr::summarize(Mean = mean(Monarch_Quantity_Observed,
                               na.rm = T)) %>%
  as.numeric()

qg_monarch <- calc_quantgenvars(0.146429,
                                0.069211,
                                resid_var,
                                monarch_mean,
                                "D. plexippus")


# L. asclepiadis-----
VarCorr(
  update(
    asclepiadis_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    asclepiadis_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(0.31796 ,
            0.14935 ,
            resid_var)

lascelp_mean <- herbivores %>%
  dplyr::summarize(Mean = mean(Liriomyza_asclepiadis ,
                               na.rm = T)) %>%
  as.numeric()

qg_lasclep <- calc_quantgenvars(0.31796 ,
            0.14935 ,
            resid_var,
            lascelp_mean,
            "L. asclepiadis")


# L. clivicollis-----
VarCorr(
  update(
    clivicollis_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    clivicollis_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(0.00011488,
            0.30719353,
            resid_var)


clivicoll_mean <- herbivores %>% dplyr::filter(Labidomera_clivicollis < 9) %>% # as in model
  dplyr::summarize(Mean = mean(Labidomera_clivicollis  ,
                               na.rm = T)) %>%
  as.numeric()

qg_clivicoll <- calc_quantgenvars(0.00011488,
            0.30719353,
            resid_var,
            clivicoll_mean,
            "L. clivicollis")
```


## Combine values into one table and export
```{r}
qg_joined <- list(qg_monarch,
                  qg_lasclep,
                  qg_clivicoll
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Defense_trait_analyses/Tables/quant_gen_herbivores_2021.csv",
          row.names=FALSE)

```