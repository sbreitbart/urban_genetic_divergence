---
title: "KSR 2021 Herbivore Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
editor_options: 
  chunk_output_type: console
---

*Background information:*

* Herbivore surveys were done twice: Once in July, once in August.
* The species observed are in the column names. The only species with two columns was the Monarch butterfly:
    + one column for Monarchs that had been on the plant in the past ("mean_Monarch_Quantity_Past") and which refers to empty chrysalis, empty eggs, and chrysalis with a dead butterfly inside, and
    + one column for alive Monarchs present on the plant itself ("mean_Monarch_Quantity_Observed") and which refers to all other Monarch forms (caterpillars, eggs, chrysalises with insects still inside)
* Monarchs notwithstanding, dead herbivores were not counted in the surveys. After Hellinger transformation, though, the mean_Monarch_Quantity_Past column had been converted to all 0's.
* Environmental variables are as follows:
    + To quantify urbanization, both distance from the city center and urbanization score were used, separately.
    + Transect was also used as a variable when analyzing the urban sites ONLY (i.e. excluding rural sites).


**Questions:**

* To what extent is urbanization associated with genetic divergence in phenotypic traits among subpopulations?
* Is proximity to urban corridors related to the levels of genetic divergence among urban subpopulations?


WHEN TOTALLY DONE, type this:
renv::activate()
renv::snapshot()

# Set up notebook
## Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import data
```{r}
herbivores <- read.csv(here::here("./Joined_annual_data/herbivores.csv")) %>%
  dplyr::select(., -1) %>%
  dplyr::mutate_at(vars(c("Population",
                          "Family",
                          "Replicate",
                          "Block",
                          "Transect_ID",
                          "Sample",
                          "Patch_ID",
                          "Urb_Rur",
                          "Year",
                          "Surveyor",
                          "Date")),
                   as.character) %>%
    dplyr::mutate_at(vars(c("Population",
                            "Family",
                            "Replicate",
                            "Block",
                            "Transect_ID",
                            "Sample",
                            "Patch_ID",
                            "Urb_Rur",
                            "Year",
                            "Surveyor",
                          "Date")),
                     as.factor)

str(herbivores)  


herbivores %<>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))
```

## Import final models
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_herbivores.Rmd", quiet=TRUE))

all_models <- list(
monarch_mods          , 
asclepiadis_mods           , 
clivicollis_mods)

names(all_models) <- c(
"monarch_mods"          ,
"asclepiadis_mods"           ,
"clivicollis_mods"         )
```

### Create separate lists of best vs. alt models for city_dist vs urb_score
#### Monarchs
```{r}
## Best
### City_dist
monarch_mods_best_c <- monarch_mods[c(1,4)]

### Urb_score
monarch_mods_best_u <- monarch_mods[c(2,6)]

## Alt
### City_dist
monarch_mods_alt_c <- monarch_mods[3]

### Urb_score
monarch_mods_alt_u <- monarch_mods[5]
```

#### L. asclepiadis
```{r}
## Best
### City_dist
asclepiadis_mods_best_c <- asclepiadis_mods[c(1,4)]

### Urb_score
asclepiadis_mods_best_u <- asclepiadis_mods[c(2,6)]

## Alt
### City_dist
asclepiadis_mods_alt_c <- asclepiadis_mods[3]

### Urb_score
asclepiadis_mods_alt_u <- asclepiadis_mods[5]
```


#### L. clivicollis
```{r}
## Best
### City_dist
clivicollis_mods_best_c <- clivicollis_mods[c(1,3)]

### Urb_score
clivicollis_mods_best_u <- clivicollis_mods[c(2,6)]

## Alt
### City_dist
clivicollis_mods_alt_c <- clivicollis_mods[4]

### Urb_score
clivicollis_mods_alt_u <- clivicollis_mods[5]

```

# Ranova
## Set seed
```{r}
set.seed(45)
```

## Gradient / City_dist
### non-Gaussian models
#### Monarchs
```{r}
# 2020-----
monarch_ranova1 <- glmer.nb(Monarch_Quantity_Observed ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                              dplyr::filter(Year == 2020),
                              nAGQ = 0, # won't converge w/o this
                            na.action = na.exclude)

# performance::check_model(monarch_ranova1)

pb_ranova_2step(monarch_ranova1,
          "Monarch butterfly: 2020",
          "./Defense_trait_analyses/Tables/Ranova/Monarch_2020.docx")

# 2021-----
monarch_ranova2 <- glmer.nb(Monarch_Quantity_Observed ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                              dplyr::filter(Year == 2021),
                              nAGQ = 0, # won't converge w/o this
                            na.action = na.exclude)

# performance::check_model(monarch_ranova2)

pb_ranova_2step(monarch_ranova2,
          "Monarch butterfly: 2021",
          "./Defense_trait_analyses/Tables/Ranova/Monarch_2021.docx")
```


#### L. asclepiadis
```{r}
# 2020-----
asclepiadis_ranova1 <- glmer.nb(Liriomyza_asclepiadis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                              dplyr::filter(Year == 2020),
                              nAGQ = 0, # won't converge w/o this
                            na.action = na.exclude)

# performance::check_model(asclepiadis_ranova1)

pb_ranova_2step(asclepiadis_ranova1,
          "Liriomyza asclepiadis: 2020",
          "./Defense_trait_analyses/Tables/Ranova/asclepiadis_2020.docx")


# 2021-----
asclepiadis_ranova2 <- glmer.nb(Liriomyza_asclepiadis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                              dplyr::filter(Year == 2021),
                              nAGQ = 0, # won't converge w/o this
                            na.action = na.exclude)

# performance::check_model(asclepiadis_ranova2)

pb_ranova_2step(asclepiadis_ranova2,
          "Liriomyza asclepiadis: 2021",
          "./Defense_trait_analyses/Tables/Ranova/asclepiadis_2021.docx")
```


#### L. clivicollis
```{r}
# 2020-----
clivicoll_ranova1 <- glmer.nb(Labidomera_clivicollis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                dplyr::filter(Labidomera_clivicollis < 9 &
                                Year == 2020),
                              nAGQ = 0, # won't converge w/o this
                            na.action = na.exclude)

# performance::check_model(clivicoll_ranova1)

pb_ranova_2step(clivicoll_ranova1,
          "Labidomera clivicollis: 2020",
          "./Defense_trait_analyses/Tables/Ranova/clivicollis_2020.docx")


# 2021-----
clivicoll_ranova2 <- glmer.nb(Labidomera_clivicollis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivores %>%
                dplyr::filter(Year == 2021),
                              nAGQ = 0, # won't converge w/o this
                            na.action = na.exclude)

# performance::check_model(clivicoll_ranova2)

pb_ranova_2step(clivicoll_ranova2,
          "Labidomera clivicollis: 2021",
          "./Defense_trait_analyses/Tables/Ranova/clivicollis_2021.docx")

```


## Urban Subtransects / City_dist
### non-Gaussian models
#### Monarchs
```{r}
# 2020-----
monarchs_ranova1_pb <- glmer.nb(Monarch_Quantity_Observed ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2020),
                            na.action = na.exclude,
                            nAGQ = 0) # won't converge w/o this)

# performance::check_model(monarchs_ranova1_pb)

pb_ranova_transects(monarchs_ranova1_pb,
          "Monarch butterfly: 2020",
          "./Defense_trait_analyses/Tables/Ranova/monarch_2020_transects.docx")


# 2021-----
monarchs_ranova2_pb <- glmer.nb(Monarch_Quantity_Observed ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2021),
                            na.action = na.exclude,
                            nAGQ = 0) # won't converge w/o this)

# performance::check_model(monarchs_ranova2_pb)

pb_ranova_transects(monarchs_ranova2_pb,
          "Monarch butterfly: 2021",
          "./Defense_trait_analyses/Tables/Ranova/monarch_2021_transects.docx")

```

#### L. asclepiadis
```{r}
# 2020-----
asclepiadis_ranova1_pb <- glmer.nb(Liriomyza_asclepiadis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2020),
                            na.action = na.exclude,
                            nAGQ = 0) # won't converge w/o this)

# performance::check_model(asclepiadis_ranova1_pb)

pb_ranova_transects(asclepiadis_ranova1_pb,
          "Liriomyza asclepiadis: 2020",
          "./Defense_trait_analyses/Tables/Ranova/asclepiadis_2020_transects.docx")


# 2021-----
asclepiadis_ranova2_pb <- glmer.nb(Liriomyza_asclepiadis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2021),
                            na.action = na.exclude,
                            nAGQ = 0) # won't converge w/o this)

# performance::check_model(asclepiadis_ranova2_pb)

pb_ranova_transects(asclepiadis_ranova2_pb,
          "Liriomyza asclepiadis: 2021",
          "./Defense_trait_analyses/Tables/Ranova/asclepiadis_2021_transects.docx")

```

#### L. clivicollis
```{r}

# 2020-----
clivicollis_ranova1_pb <- glmer.nb(Labidomera_clivicollis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2020),
                            na.action = na.exclude,
                            nAGQ = 0) # won't converge w/o this)

# performance::check_model(clivicollis_ranova1_pb)

pb_ranova_transects(clivicollis_ranova1_pb,
          "Labidomera clivicollis: 2020",
          "./Defense_trait_analyses/Tables/Ranova/clivicollis_2020_transects.docx")


# 2021-----
clivicollis_ranova2_pb <- glmer.nb(Labidomera_clivicollis ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                               data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural" &
                                Year == 2021),
                            na.action = na.exclude,
                            nAGQ = 0) # won't converge w/o this)

# performance::check_model(clivicollis_ranova2_pb)

pb_ranova_transects(clivicollis_ranova2_pb,
          "Labidomera clivicollis: 2021",
          "./Defense_trait_analyses/Tables/Ranova/clivicollis_2021_transects.docx")

```

# ANOVA
## Monarchs
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(monarch_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/monarch_citydist.png"))

lapply(monarch_mods_best_c, MuMIn::r.squaredGLMM)
# lapply(monarch_mods_best_c, r2glmm::r2beta, method = 'sgv',
#                                            data = herbivores)
# can't handle glmmtmb objects... if want partial R2, will have to recreate models manually w/glmer

```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(monarch_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/monarch_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(monarch_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/monarch_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(monarch_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/monarch_urbscore_alt.png"))
```
## L. asclepiadis
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(asclepiadis_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/asclepiadis_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(asclepiadis_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/asclepiadis_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(asclepiadis_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/asclepiadis_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(asclepiadis_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/asclepiadis_urbscore_alt.png"))
```

## L. clivicollis
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(clivicollis_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/clivicollis_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(clivicollis_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Best_models/clivicollis_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(clivicollis_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/clivicollis_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(clivicollis_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Herbivores/Alt_models/clivicollis_urbscore_alt.png"))
```

# R-sq values
```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

```

# Calculate heritability & Qst
Just looking at gradient models- all pops included. 
h2 represents the average heritability across populations after removing the genetic effects due to population differences.
```{r}
# Monarchs-----
VarCorr(
  update(
    monarch_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    monarch_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(0.146429,
            0.069211,
            resid_var)

monarch_mean <- herbivores %>%
  dplyr::summarize(Mean = mean(Monarch_Quantity_Observed,
                               na.rm = T)) %>%
  as.numeric()

qg_monarch <- calc_quantgenvars(0.146429,
                                0.069211,
                                resid_var,
                                monarch_mean,
                                "D. plexippus")


# L. asclepiadis-----
VarCorr(
  update(
    asclepiadis_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    asclepiadis_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(0.31796 ,
            0.14935 ,
            resid_var)

lascelp_mean <- herbivores %>%
  dplyr::summarize(Mean = mean(Liriomyza_asclepiadis ,
                               na.rm = T)) %>%
  as.numeric()

qg_lasclep <- calc_quantgenvars(0.31796 ,
            0.14935 ,
            resid_var,
            lascelp_mean,
            "L. asclepiadis")


# L. clivicollis-----
VarCorr(
  update(
    clivicollis_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    clivicollis_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(0.00011488,
            0.30719353,
            resid_var)


clivicoll_mean <- herbivores %>% dplyr::filter(Labidomera_clivicollis < 9) %>% # as in model
  dplyr::summarize(Mean = mean(Labidomera_clivicollis  ,
                               na.rm = T)) %>%
  as.numeric()

qg_clivicoll <- calc_quantgenvars(0.00011488,
            0.30719353,
            resid_var,
            clivicoll_mean,
            "L. clivicollis")
```


## Combine values into one table and export
```{r}
qg_joined <- list(qg_monarch,
                  qg_lasclep,
                  qg_clivicoll
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Defense_trait_analyses/Tables/quant_gen_herbivores_2021.csv",
          row.names=FALSE)

```