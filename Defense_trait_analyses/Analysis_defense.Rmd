# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_Defense.Rmd", quiet=TRUE))
```

# Ranova
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
- NOT doing this for cardenolides because samples were pooled by population
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## Gradient
### Gaussian models
```{r}
############ MEASURED ONLY IN 2020 #############
################################################

# Latex-----
# fit original model
latex_ranova_mod1 <- lmer(Latex_weight_mg^(1/3) ~
                            Block +
                            (1|Population/Family),
                          data = latex,
                          REML = T)

# check diagnostics and transform if necessary
performance::check_model(latex_ranova_mod1)

# export
ranova_2step(latex_ranova_mod1,
             "Latex",
             "./Defense_trait_analyses/Tables/Ranova/latex.docx")


############ MEASURED IN MULTIPLE YEARS ########
################################################
# Herbivory (before flowering) (quantitative)-------
herbiv_e_quant_ranova_mod1 <- lmer(log(Herbivory_mean_early) ~
                                Block +
                               (1|Population/Family),
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1 &
                            Year == 2020),
                              REML = T)

# check diagnostics and transform if necessary
performance::check_model(herbiv_e_quant_ranova_mod1)

# export
ranova_2step(herbiv_e_quant_ranova_mod1,
             "Herbivory before flowering, quantitative: 2020",
             "./Defense_trait_analyses/Tables/Ranova/herbivory_early_quant_2020.docx")


herbiv_e_quant_ranova_mod2 <- lmer(log(Herbivory_mean_early) ~
                               Block +
                               (1|Population/Family),
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1 &
                            Year == 2021),
                              REML = T)

# check diagnostics and transform if necessary
performance::check_model(herbiv_e_quant_ranova_mod2)

# export
ranova_2step(herbiv_e_quant_ranova_mod2,
             "Herbivory before flowering, quantitative: 2021",
             "./Defense_trait_analyses/Tables/Ranova/herbivory_early_quant_2021.docx")


# Herbivory (after flowering) (quantitative)-------
herbiv_l_quant_ranova_mod1 <- lmer(log(Herbivory_mean_late) ~
                                Block +
                               (1|Population/Family),
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_late_binary == 1 &
                            Year == 2020),
                              REML = T)

# check diagnostics and transform if necessary
performance::check_model(herbiv_l_quant_ranova_mod1)

# export
ranova_2step(herbiv_l_quant_ranova_mod1,
             "Herbivory after flowering, quantitative: 2020",
             "./Defense_trait_analyses/Tables/Ranova/herbivory_late_quant_2020.docx")


herbiv_l_quant_ranova_mod2 <- lmer(log(Herbivory_mean_late) ~
                                Block +
                               (1|Population/Family),
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_late_binary == 1 &
                            Year == 2021),
                              REML = T)

# check diagnostics and transform if necessary
performance::check_model(herbiv_l_quant_ranova_mod2)

# export
ranova_2step(herbiv_l_quant_ranova_mod2,
             "Herbivory after flowering, quantitative: 2021",
             "./Defense_trait_analyses/Tables/Ranova/herbivory_late_quant_2021.docx")




# Weevil scar length (quantitative)-----
weev_quant_ranova_mod1 <- lmer(log(Scar_length_cm) ~
                                    Block +
                                   (1|Population/Family), 
                              data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0 &
                                                Year == 2020),
                              REML = T)


# check diagnostics and transform if necessary
performance::check_model(weev_quant_ranova_mod1)

# export
ranova_2step(weev_quant_ranova_mod1,
             "Weevil damage, quantitative: 2020",
             "./Defense_trait_analyses/Tables/Ranova/weevil_quant_2020.docx")


weev_quant_ranova_mod2 <- lmer(log(Scar_length_cm) ~
                                    Block +
                                   (1|Population/Family), 
                              data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0 &
                                                Year == 2021),
                              REML = T)


# check diagnostics and transform if necessary
performance::check_model(weev_quant_ranova_mod2)

# export
ranova_2step(weev_quant_ranova_mod2,
             "Weevil damage, quantitative: 2021",
             "./Defense_trait_analyses/Tables/Ranova/weevil_quant_2021.docx")


```

### non-Gaussian models
```{r}
# Herbivory (before flowering) (Binary)-------
# 2020-----
herb_e_bin_ranova1 <- glmer(Herbivory_mean_early_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(herb_e_bin_ranova1)

pb_ranova_2step(herb_e_bin_ranova1,
          "Herbivory before flowering, binary: 2020",
          "./Defense_trait_analyses/Tables/Ranova/herb_e_bin_2020.docx")



# 2021-----
herb_e_bin_ranova2 <- glmer(Herbivory_mean_early_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Year == 2021),
                 na.action = na.exclude,
                             family = binomial)

# performance::check_model(herb_e_bin_ranova2)

pb_ranova_2step(herb_e_bin_ranova2,
          "Herbivory before flowering, binary: 2021",
          "./Defense_trait_analyses/Tables/Ranova/herb_e_bin_2021.docx")


# Herbivory (after flowering) (Binary)-------
# 2020-----
herb_l_bin_ranova1 <- glmer(Herbivory_mean_late_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                            nAGQ = 0,# won't converge w/o this
                             family = binomial)

# performance::check_model(herb_l_bin_ranova1)

pb_ranova_2step(herb_l_bin_ranova1,
          "Herbivory after flowering, binary: 2020",
          "./Defense_trait_analyses/Tables/Ranova/herb_l_bin_2020.docx")



# 2021-----
herb_l_bin_ranova2 <- glmer(Herbivory_mean_late_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Year == 2021),
                            nAGQ = 0,# won't converge w/o this
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(herb_l_bin_ranova2)

pb_ranova_2step(herb_l_bin_ranova2,
          "Herbivory after flowering, binary: 2021",
          "./Defense_trait_analyses/Tables/Ranova/herb_l_bin_2021.docx")



# Weevil scar length (binary)-----
# 2020-----
weev_bin_ranova1 <- glmer(Scar_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = weevil %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                          family = binomial)

# performance::check_model(weev_bin_ranova1)

pb_ranova_2step(weev_bin_ranova1,
          "Weevil Damage, binary: 2020",
          "./Defense_trait_analyses/Tables/Ranova/weevil_bin_2020.docx")


# 2021-----
weev_bin_ranova2 <- glmer(Scar_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = weevil %>%
                               dplyr::filter(Year == 2021),
                          na.action = na.exclude,
                             family = binomial)

# performance::check_model(weev_bin_ranova2)

pb_ranova_2step(weev_bin_ranova2,
          "Weevil Damage, binary: 2021",
          "./Defense_trait_analyses/Tables/Ranova/weevil_bin_2021.docx")
```

## Urban Subtransects
### Gaussian models
```{r}
############ MEASURED ONLY IN 2020 #############
################################################

# Latex-----
latex_ranova_mod1 <- lmer(Latex_weight_mg^(1/3) ~
                            (1|Population/Family) +
                            Block,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(latex_ranova_mod1)

ranova_transect(latex_ranova_mod1,
                "Latex",
                "./Defense_trait_analyses/Tables/Ranova/latex_transects.docx")


############ MEASURED IN MULTIPLE YEARS ########
################################################
# Herbivory (before flowering)- (quantitative)-------

# 2020-----
herb_e_quant_ranova_mod1 <- lmer(log(Herbivory_mean_early) ~
                                   (1|Population/Family) +
                                   Block,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_early_binary == 1 &
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(herb_e_quant_ranova_mod1)

ranova_transect(herb_e_quant_ranova_mod1,
                "Herbivory before flowering, quantitative: 2020",
                "./Defense_trait_analyses/Tables/Ranova/herb_e_quant_transects_2020.docx")

# 2021-----
herb_e_quant_ranova_mod2 <- lmer(log(Herbivory_mean_early) ~
                                   (1|Population/Family) +
                                   Block,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_early_binary == 1 &
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(herb_e_quant_ranova_mod2)

ranova_transect(herb_e_quant_ranova_mod2,
                "Herbivory before flowering, quantitative: 2021",
                "./Defense_trait_analyses/Tables/Ranova/herb_e_quant_transects_2021.docx")


# Herbivory (after flowering) (quantitative)-------
# 2020-----
herb_l_quant_ranova_mod1 <- lmer(log(Herbivory_mean_late) ~
                                   (1|Population/Family) +
                                   Block,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_late_binary == 1 &
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(herb_l_quant_ranova_mod1)

ranova_transect(herb_l_quant_ranova_mod1,
                "Herbivory after flowering, quantitative: 2020",
                "./Defense_trait_analyses/Tables/Ranova/herb_l_quant_transects_2020.docx")

# 2021-----
herb_l_quant_ranova_mod2 <- lmer(log(Herbivory_mean_late) ~
                                   (1|Population/Family) +
                                   Block,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_late_binary == 1 &
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(herb_l_quant_ranova_mod2)

ranova_transect(herb_l_quant_ranova_mod2,
                "Herbivory after flowering, quantitative: 2021",
                "./Defense_trait_analyses/Tables/Ranova/herb_l_quant_transects_2021.docx")



# Weevil scar length (quantitative)-----
# 2020-----
weev_quant_ranova_mod1 <- lmer(log(Scar_length_cm) ~
                                   (1|Population/Family) +
                                   Block,
                             data = weevil %>%
                      dplyr::filter(
                        Scar_length_cm > 0 &
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(weev_quant_ranova_mod1)

ranova_transect(weev_quant_ranova_mod1,
                "Weevil damage, quantitative: 2020",
                "./Defense_trait_analyses/Tables/Ranova/weevil_quant_transects_2020.docx")

# 2021-----
weev_quant_ranova_mod2 <- lmer(log(Scar_length_cm) ~
                                   (1|Population/Family) +
                                   Block,
                             data = weevil %>%
                      dplyr::filter(
                        Scar_length_cm > 0 &
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(weev_quant_ranova_mod2)

ranova_transect(weev_quant_ranova_mod2,
                "Weevil damage, quantitative: 2021",
                "./Defense_trait_analyses/Tables/Ranova/weevil_quant_transects_2021.docx")


```

### non-Gaussian models
```{r}
# Herbivory (before flowering) (binary)-------
# 2020-----
herb_e_bin_ranova1_pb <- glmer(Herbivory_mean_early_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(herb_e_bin_ranova1_pb)

pb_ranova_transects(herb_e_bin_ranova1_pb,
          "Herbivory before flowering, binary: 2020",
          "./Defense_trait_analyses/Tables/Ranova/herb_e_bin_2020_transects.docx")


# 2021-----
herb_e_bin_ranova2_pb <- glmer(Herbivory_mean_early_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                             family = binomial  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
                       )

# performance::check_model(herb_e_bin_ranova2_pb)

pb_ranova_transects(herb_e_bin_ranova2_pb,
          "Herbivory before flowering, binary: 2021",
          "./Defense_trait_analyses/Tables/Ranova/herb_e_bin_2021_transects.docx")

# Herbivory (after flowering) (binary)-------
# 2020-----
herb_l_bin_ranova1_pb <- glmer(Herbivory_mean_late_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
                             family = binomial ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

# performance::check_model(herb_l_bin_ranova1_pb)

pb_ranova_transects(herb_l_bin_ranova1_pb,
          "Herbivory after flowering, binary: 2020",
          "./Defense_trait_analyses/Tables/Ranova/herb_l_bin_2020_transects.docx")


# 2021-----
herb_l_bin_ranova2_pb <- glmer(Herbivory_mean_late_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                            nAGQ = 0, # won't converge w/o this
                       family = binomial)

# performance::check_model(herb_l_bin_ranova2_pb)

pb_ranova_transects(herb_l_bin_ranova2_pb,
          "Herbivory after flowering, binary: 2021",
          "./Defense_trait_analyses/Tables/Ranova/herb_l_bin_2021_transects.docx")

# Weevil scar length (binary)-----
# 2020-----
weev_bin_ranova1_pb <- glmer(Scar_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = weevil %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
                             family = binomial,
                            nAGQ = 0
                      )

# performance::check_model(weev_bin_ranova1_pb)

pb_ranova_transects(weev_bin_ranova1_pb,
          "Weevil damage, binary: 2020",
          "./Defense_trait_analyses/Tables/Ranova/weevil_bin_2020_transects.docx")


# 2021-----
weev_bin_ranova2_pb <- glmer(Scar_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = weevil %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(herb_l_bin_ranova2_pb)

pb_ranova_transects(weev_bin_ranova2_pb,
          "Weevil damage, binary: 2021",
          "./Defense_trait_analyses/Tables/Ranova/weevil_bin_2021_transects.docx")

```

## Recalculate PVE for non-Gaussian models
As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution.
The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection.
These new PVEs will be estimates. This is *not* a perfect solution but it will help us approximate PVE for these variables.
### Q1
```{r}
# main models
herb_e_bin_lmer <- lmer(Herbivory_mean_early_binary ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

herb_l_bin_lmer <- lmer(Herbivory_mean_late_binary ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = herbivory %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

weev_bin_lmer <- lmer(Scar_binary ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = weevil %>%
                               dplyr::filter(Year == 2021),
                          na.action = na.exclude)

# get PVE from models
pve_hbfb <- PVE_lm(herb_e_bin_lmer) 
pve_hafb <- PVE_lm(herb_l_bin_lmer)
pve_weevb <- PVE_lm(weev_bin_lmer)

pve_hbfb_city <- PVE_lm(update(herb_e_bin_lmer, .~. + City_dist))
pve_hafb_city <- PVE_lm(update(herb_l_bin_lmer, .~. + City_dist))
pve_weevb_city <- PVE_lm(update(weev_bin_lmer, .~. + City_dist))

pve_hbfb_urbsc <- PVE_lm(update(herb_e_bin_lmer, .~. + Urb_score))
pve_hafb_urbsc <- PVE_lm(update(herb_l_bin_lmer, .~. + Urb_score))
pve_weevb_urbsc <- PVE_lm(update(weev_bin_lmer, .~. + Urb_score))


# make tables
recalc_tab1 <- pve_table_recalc(pve_hbfb, pve_hafb, pve_weevb,
                 "Herbivory before flowering (binary)",
                              "Herbivory after flowering (binary)",
                              "Weevil damage (binary)")

recalc_tab2 <- pve_table_recalc(pve_hbfb_city, pve_hafb_city, pve_weevb_city,
                 "Herbivory before flowering (binary)",
                              "Herbivory after flowering (binary)",
                              "Weevil damage (binary)")

recalc_tab3 <- pve_table_recalc(pve_hbfb_urbsc, pve_hafb_urbsc, pve_weevb_urbsc,
                 "Herbivory before flowering (binary)",
                              "Herbivory after flowering (binary)",
                              "Weevil damage (binary)")

# Export to word
export_recalc(recalc_tab1,
              recalc_tab2,
              recalc_tab3,
              "./Defense_trait_analyses/Tables/Ranova/PVE_nonGaussmods/PVE_nonGaussmods_defense_Q1.docx")

```

### Q2
```{r}
# main models
herb_e_bin_lmer2 <- update(herb_e_bin_lmer,
                             data = herbivory %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"))

herb_l_bin_lmer2 <- update(herb_l_bin_lmer,
                             data = herbivory %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"))

weev_bin_lmer2 <- update(weev_bin_lmer,
                             data = weevil %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"))
# get PVE from models
pve_hbfb2 <- PVE_lm(herb_e_bin_lmer2) 
pve_hafb2 <- PVE_lm(herb_l_bin_lmer2)
pve_weevb2 <- PVE_lm(weev_bin_lmer2)

pve_hbfb_city2 <- PVE_lm(update(herb_e_bin_lmer2, .~. + City_dist*Transect_ID))
pve_hafb_city2 <- PVE_lm(update(herb_l_bin_lmer2, .~. + City_dist*Transect_ID))
pve_weevb_city2 <- PVE_lm(update(weev_bin_lmer2, .~. + City_dist*Transect_ID))

pve_hbfb_urbsc2 <- PVE_lm(update(herb_e_bin_lmer2, .~. + Urb_score*Transect_ID))
pve_hafb_urbsc2 <- PVE_lm(update(herb_l_bin_lmer2, .~. + Urb_score*Transect_ID))
pve_weevb_urbsc2 <- PVE_lm(update(weev_bin_lmer2, .~. + Urb_score*Transect_ID))


# make tables
recalc_tab1_Q2 <- pve_table_recalc(pve_hbfb2, pve_hafb2, pve_weevb2,
                 "Herbivory before flowering (binary)",
                              "Herbivory after flowering (binary)",
                              "Weevil damage (binary)")

recalc_tab2_Q2 <- pve_table_recalc(pve_hbfb_city2, pve_hafb_city2, pve_weevb_city2,
                 "Herbivory before flowering (binary)",
                              "Herbivory after flowering (binary)",
                              "Weevil damage (binary)")

recalc_tab3_Q2 <- pve_table_recalc(pve_hbfb_urbsc2, pve_hafb_urbsc2, pve_weevb_urbsc2,
                 "Herbivory before flowering (binary)",
                              "Herbivory after flowering (binary)",
                              "Weevil damage (binary)")

# Export to word
export_recalc(recalc_tab1_Q2,
              recalc_tab2_Q2,
              recalc_tab3_Q2,
              "./Defense_trait_analyses/Tables/Ranova/PVE_nonGaussmods/PVE_nonGaussmods_defense_Q2.docx")
```


## Create figure showing % variance explained per component
Note: Can only do this for gaussian models for Q1. For models with transect as an effect, I can calculate PVE for models testing effect of distance only- not transect. But since I'm not as interested in that, I won't generate those plots now.
```{r}
# this isn't working
# library(XML)
# rawHTML <- XML::readHTMLTable("Defense_trait_analyses/Tables/Ranova/latex.html",
#            # header = c("Variable",
#            #            "Group",
#            #            "Variance",
#            #            "PVE",
#            #            "p")) %>%
#              header = T) %>%
#   as.data.frame() %T>%
#   print()

# can't figure out how to convert these ranova html tables with PVE into df or tibble or anything else with code.
# So I'll just create an excel file combining the data from traits for which I could calculate PVE ("PVE_defense_Q1.xlsx"), including these traits:
# -latex ("latex.html")
# -weevil damage, quantitative ("weevil_quant.html")
# -Herbivory, after flowering: Quantitative ("herbivory_late_quant.html")
# -Herbivory, before flowering: Quantitative ("herbivory_early_quant.html")
# -SLA ("sla.html")
# -LDMC ("ldmc.html")


pve <- read.csv(here::here("./Defense_trait_analyses/Tables/Ranova/pve_defense_Q1.csv")) %>%
  dplyr::rename(Variable = 1) %>%
  # make alphabetical order for plot
   mutate(Variable = fct_reorder(Variable,
                                 desc(Variable)))

library("ggsci")

pve_def <- ggplot(pve,
       aes(
         fill=Group,
         y=PVE,
         x=Variable)
       ) + 
  geom_bar(position="stack",
           stat="identity") +
  scale_fill_discrete(labels = c("Family",
                                 "Population",
                                 "Residual")) +
  scale_fill_tron(alpha = 0.7) +
  theme_pubr() +
  xlab("") +
  ylab("% Variance Explained") +
  coord_flip()
pve_def

ggsave(filename = "pve_def_Q1.png",
         plot = pve_def,
         path = here::here("./Defense_trait_analyses/Figures/PVE/"),
         width = 20,
         height = 6,
         units = "cm")
```

# Anova
## Export all best / alt multi-year models in separate word docs
### Distance / best
```{r}
all_models_best_c <- list(
latex_mods_best_c,
herb_e_bin_mods_best_c,
herb_e_quant_mods_best_c,
herb_l_bin_mods_best_c,
herb_l_quant_mods_best_c,
weev_bin_mods_best_c,
weev_quant_mods_best_c   )


anovas_best_c <- lapply(all_models_best_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_c, "./Defense_trait_analyses/Figures/ANOVA/Best_models/all_anova_Defense_best_distance.docx")
```

### Distance / alt
```{r}
all_models_alt_c <- list(
latex_mods_alt_c,
# herb_e_bin_mods_alt_c, # NONE
herb_e_quant_mods_alt_c,
herb_l_bin_mods_alt_c,
herb_l_quant_mods_alt_c,
weev_bin_mods_alt_c,
weev_quant_mods_alt_c)

anovas_alt_c <- lapply(all_models_alt_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_c, "./Defense_trait_analyses/Figures/ANOVA/Alt_models/all_anova_Defense_alt_distance.docx")
```

### UrbScore / best
```{r}
all_models_best_u <- list(
latex_mods_best_u,
herb_e_bin_mods_best_u,
herb_e_quant_mods_best_u,
herb_l_bin_mods_best_u,
herb_l_quant_mods_best_u,
weev_bin_mods_best_u,
weev_quant_mods_best_u,
mortality_mods_best_u    )

anovas_best_u <- lapply(all_models_best_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_u, "./Defense_trait_analyses/Figures/ANOVA/Best_models/all_anova_Defense_best_urbscore.docx")
```

### UrbScore / alt
```{r}
all_models_alt_u <- list(
# latex_mods_alt_u, # NONE
herb_e_bin_mods_alt_u,
herb_e_quant_mods_alt_u,
herb_l_bin_mods_alt_u,
herb_l_quant_mods_alt_u,
weev_bin_mods_alt_u,
weev_quant_mods_alt_u,
mortality_mods_alt_u    )

anovas_alt_u <- lapply(all_models_alt_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_u, "./Defense_trait_analyses/Figures/ANOVA/Alt_models/all_anova_Defense_alt_urbscore.docx")

```

### Cardenolides (lms, not lmers)
```{r}

```

## Export comparisons of anovas w/1 vs. all years
### Q1
```{r}
# cardenolides-----
# only one year of data for this, and it's pooled by population, so I didn't perform ranova on these models and don't have any others to compare these to.

# latex-----
# only one year of data for this. Compared anovas in "./Defense_trait_analyses/Tables/Ranova/nsim_10/latex.docx" and "./Defense_trait_analyses/Figures/ANOVA/Best_models/all_anova_Defense_best_distance.docx" and "...urbscore.docx" and they're nearly identical- differences probably due to glmer vs. glmmTMB

# herbivory before flowering (binary)-----
compare_anovas(
  update(herb_e_bin_mods_best_c[[1]], .~. - City_dist),
  herbivory,
  "2021",
  "Herbivory before flowering (binary)",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/herbivory_early_binary.docx")

# herbivory before flowering (quantitative)-----
## doing this and other quant mods manually b/c I need to filter the dataset to exclude zeroes

var_name <- "Herbivory before flowering (quantitative)"
filepath <- "./Defense_trait_analyses/Tables/Comparing_ANOVA/herbivory_early_quant.docx"
last_year <- "2021"

  # city_dist
  anov1.d <- tidy_anova(herb_e_quant_mods_best_c[[1]]) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_dist <- update(herb_e_quant_mods_best_c[[1]],
                    .~. - Year,
                    data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1 &
                            Year == last_year))
  
  anov2.d <- tidy_anova(mod_1yr_dist) %>%
    make_flxtable(., var_name)
  
  
  # urb_score
  mod_allyrs_usc <- update(herb_e_quant_mods_best_c[[1]], .~. + Urb_score - City_dist)
  
  anov1.u <- tidy_anova(mod_allyrs_usc) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_usc <- update(mod_allyrs_usc,
                    .~. - Year,
                     data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1 &
                            Year == last_year))
  
  anov2.u <- tidy_anova(mod_1yr_usc) %>%
    make_flxtable(., var_name)
  
  
  # Export
  word_export <- read_docx()
  
  body_add_par(word_export, "Urbanization = Distance to City Center",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(herb_e_quant_mods_best_c[[1]])),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.d)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_dist)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.d)
  
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "") 
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, "Urbanization = Urbanization Score",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_allyrs_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.u)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.u)
  
  print(word_export, here::here(filepath))

rm(var_name, filepath, last_year,anov1.d, mod_1yr_dist, anov2.d, mod_allyrs_usc, anov1.u, mod_1yr_usc, anov2.u)

# herbivory after flowering (binary)-----
compare_anovas(
  update(herb_l_bin_mods_best_c[[1]], .~. - City_dist),
  herbivory,
  "2021",
  "Herbivory after flowering (binary)",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/herbivory_late_binary.docx")

# herbivory after flowering (quantitative)-----

var_name <- "Herbivory after flowering (quantitative)"
filepath <- "./Defense_trait_analyses/Tables/Comparing_ANOVA/herbivory_late_quant.docx"
last_year <- "2021"

  # city_dist
  anov1.d <- tidy_anova(herb_l_quant_mods_best_c[[1]]) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_dist <- update(herb_l_quant_mods_best_c[[1]],
                    .~. - Year,
                    data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_late_binary == 1 &
                            Year == last_year))
  
  anov2.d <- tidy_anova(mod_1yr_dist) %>%
    make_flxtable(., var_name)
  
  
  # urb_score
  mod_allyrs_usc <- update(herb_l_quant_mods_best_c[[1]], .~. + Urb_score - City_dist)
  
  anov1.u <- tidy_anova(mod_allyrs_usc) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_usc <- update(mod_allyrs_usc,
                    .~. - Year,
                     data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_late_binary == 1 &
                            Year == last_year))
  
  anov2.u <- tidy_anova(mod_1yr_usc) %>%
    make_flxtable(., var_name)
  
  
  # Export
  word_export <- read_docx()
  
  body_add_par(word_export, "Urbanization = Distance to City Center",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(herb_l_quant_mods_best_c[[1]])),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.d)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_dist)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.d)
  
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "") 
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, "Urbanization = Urbanization Score",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_allyrs_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.u)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.u)
  
  print(word_export, here::here(filepath))

rm(var_name, filepath, last_year,anov1.d, mod_1yr_dist, anov2.d, mod_allyrs_usc, anov1.u, mod_1yr_usc, anov2.u)


# weevil damage (binary)-----
compare_anovas(
  update(weev_bin_mods_best_c[[1]], .~. - City_dist),
  weevil,
  "2021",
  "Weevil damage (binary)",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/Weevil_damage_binary.docx")

# weevil damage (quantitative)-----

var_name <- "Weevil damage (quantitative)"
filepath <- "./Defense_trait_analyses/Tables/Comparing_ANOVA/Weevil_damage_quant.docx"
last_year <- "2021"

  # city_dist
  anov1.d <- tidy_anova(weev_quant_mods_best_c[[1]]) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_dist <- update(weev_quant_mods_best_c[[1]],
                    .~. - Year,
                    data = weevil %>%
                        dplyr::filter(
                          Scar_length_cm > 0 &
                            Year == last_year))
  
  anov2.d <- tidy_anova(mod_1yr_dist) %>%
    make_flxtable(., var_name)
  
  
  # urb_score
  mod_allyrs_usc <- update(weev_quant_mods_best_c[[1]], .~. + Urb_score - City_dist)
  
  anov1.u <- tidy_anova(mod_allyrs_usc) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_usc <- update(mod_allyrs_usc,
                    .~. - Year,
                     data = weevil %>%
                        dplyr::filter(
                          Scar_length_cm > 0 &
                            Year == last_year))
  
  anov2.u <- tidy_anova(mod_1yr_usc) %>%
    make_flxtable(., var_name)
  
  
  # Export
  word_export <- read_docx()
  
  body_add_par(word_export, "Urbanization = Distance to City Center",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(weev_quant_mods_best_c[[1]])),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.d)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_dist)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.d)
  
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "") 
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, "Urbanization = Urbanization Score",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_allyrs_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.u)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.u)
  
  print(word_export, here::here(filepath))

rm(var_name, filepath, last_year,anov1.d, mod_1yr_dist, anov2.d, mod_allyrs_usc, anov1.u, mod_1yr_usc, anov2.u)


```

### Q2
```{r}
# cardenolides-----
# only one year of data for this, and it's pooled by population, so I didn't perform ranova on these models and don't have any others to compare these to.

# latex-----
# only one year of data for this. Compared anovas in "./Defense_trait_analyses/Tables/Ranova/nsim_10/latex_transects.docx" and "./Defense_trait_analyses/Figures/ANOVA/Best_models/all_anova_Defense_best_distance.docx" and "...urbscore.docx" and they're nearly identical- differences probably due to glmer vs. glmmTMB

# herbivory before flowering (binary)-----
compare_anovas_transects(
  update(herb_e_bin_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  herbivory,
  "2021",
  "Herbivory before flowering (binary)",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/herbivory_early_binary_transects.docx")

# herbivory before flowering (quantitative)-----
## doing this and other quant mods manually b/c I need to filter the dataset to exclude zeroes

var_name <- "Herbivory before flowering (quantitative)"
filepath <- "./Defense_trait_analyses/Tables/Comparing_ANOVA/herbivory_early_quant_transects.docx"
last_year <- "2021"

  # City_dist*Transect_ID
  anov1.d <- tidy_anova(herb_e_quant_mods_best_c[[2]]) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_dist <- update(herb_e_quant_mods_best_c[[2]],
                    .~. - Year,
                    data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1 &
                            Year == last_year &
                            Transect_ID != "Rural"))
  
  anov2.d <- tidy_anova(mod_1yr_dist) %>%
    make_flxtable(., var_name)
  
  
  # Urb_score*Transect_ID
  mod_allyrs_usc <- update(herb_e_quant_mods_best_c[[2]], .~. + Urb_score*Transect_ID - City_dist*Transect_ID + Transect_ID)
  
  anov1.u <- tidy_anova(mod_allyrs_usc) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_usc <- update(mod_allyrs_usc,
                    .~. - Year,
                     data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1 &
                            Year == last_year &
                            Transect_ID != "Rural"))
  
  anov2.u <- tidy_anova(mod_1yr_usc) %>%
    make_flxtable(., var_name)
  
  
  # Export
  word_export <- read_docx()
  
  body_add_par(word_export, "Urbanization = Distance to City Center",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(herb_e_quant_mods_best_c[[2]])),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.d)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_dist)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.d)
  
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "") 
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, "Urbanization = Urbanization Score",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_allyrs_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.u)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.u)
  
  print(word_export, here::here(filepath))

rm(var_name, filepath, last_year,anov1.d, mod_1yr_dist, anov2.d, mod_allyrs_usc, anov1.u, mod_1yr_usc, anov2.u)

# herbivory after flowering (binary)-----
compare_anovas_transects(
  update(herb_l_bin_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  herbivory,
  "2021",
  "Herbivory after flowering (binary)",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/herbivory_late_binary_transects.docx")

# herbivory after flowering (quantitative)-----

var_name <- "Herbivory after flowering (quantitative)"
filepath <- "./Defense_trait_analyses/Tables/Comparing_ANOVA/herbivory_late_quant_transects.docx"
last_year <- "2021"

  # City_dist*Transect_ID
  anov1.d <- tidy_anova(herb_l_quant_mods_best_c[[2]]) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_dist <- update(herb_l_quant_mods_best_c[[2]],
                    .~. - Year,
                    data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_late_binary == 1 &
                            Year == last_year &
                            Transect_ID != "Rural"))
  
  anov2.d <- tidy_anova(mod_1yr_dist) %>%
    make_flxtable(., var_name)
  
  
  # Urb_score*Transect_ID
  mod_allyrs_usc <- update(herb_l_quant_mods_best_c[[2]], .~. + Urb_score*Transect_ID - City_dist*Transect_ID + Transect_ID)
  
  anov1.u <- tidy_anova(mod_allyrs_usc) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_usc <- update(mod_allyrs_usc,
                    .~. - Year,
                     data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_late_binary == 1 &
                            Year == last_year &
                            Transect_ID != "Rural"))
  
  anov2.u <- tidy_anova(mod_1yr_usc) %>%
    make_flxtable(., var_name)
  
  
  # Export
  word_export <- read_docx()
  
  body_add_par(word_export, "Urbanization = Distance to City Center",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(herb_l_quant_mods_best_c[[2]])),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.d)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_dist)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.d)
  
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "") 
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, "Urbanization = Urbanization Score",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_allyrs_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.u)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.u)
  
  print(word_export, here::here(filepath))

rm(var_name, filepath, last_year,anov1.d, mod_1yr_dist, anov2.d, mod_allyrs_usc, anov1.u, mod_1yr_usc, anov2.u)


# weevil damage (binary)-----
compare_anovas_transects(
  update(weev_bin_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  weevil,
  "2021",
  "Weevil damage (binary)",
  "./Defense_trait_analyses/Tables/Comparing_ANOVA/Weevil_damage_binary_transects.docx")

# weevil damage (quantitative)-----

var_name <- "Weevil damage (quantitative)"
filepath <- "./Defense_trait_analyses/Tables/Comparing_ANOVA/Weevil_damage_quant_transects.docx"
last_year <- "2021"

  # City_dist*Transect_ID
  anov1.d <- tidy_anova(weev_quant_mods_best_c[[2]]) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_dist <- update(weev_quant_mods_best_c[[2]],
                    .~. - Year,
                    data = weevil %>%
                        dplyr::filter(
                          Scar_length_cm > 0 &
                            Year == last_year &
                            Transect_ID != "Rural"))
  
  anov2.d <- tidy_anova(mod_1yr_dist) %>%
    make_flxtable(., var_name)
  
  
  # Urb_score*Transect_ID
  mod_allyrs_usc <- update(weev_quant_mods_best_c[[2]], .~. + Urb_score*Transect_ID - City_dist*Transect_ID+ Transect_ID)
  
  anov1.u <- tidy_anova(mod_allyrs_usc) %>%
    make_flxtable(., var_name)
  
  
  mod_1yr_usc <- update(mod_allyrs_usc,
                    .~. - Year,
                     data = weevil %>%
                        dplyr::filter(
                          Scar_length_cm > 0 &
                            Year == last_year &
                            Transect_ID != "Rural"))
  
  anov2.u <- tidy_anova(mod_1yr_usc) %>%
    make_flxtable(., var_name)
  
  
  # Export
  word_export <- read_docx()
  
  body_add_par(word_export, "Urbanization = Distance to City Center",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(weev_quant_mods_best_c[[2]])),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.d)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_dist)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.d)
  
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "") 
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, "Urbanization = Urbanization Score",
               style = "heading 1")
  
  body_add_par(word_export, value = "ANOVA with all years of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_allyrs_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov1.u)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "ANOVA with one year of data")
  body_add_par(word_export, value = paste("Model:", paste(deparse(formula(mod_1yr_usc)),
                                                          collapse = "") %>%
                                            unlist()))
  body_add_flextable(word_export, anov2.u)
  
  print(word_export, here::here(filepath))

rm(var_name, filepath, last_year,anov1.d, mod_1yr_dist, anov2.d, mod_allyrs_usc, anov1.u, mod_1yr_usc, anov2.u)


```

# R-squared values
## lmers
```{r}
# change REML to T for lmers
latex_mods_reml_T      <- reml_to_true(latex_mods)
herb_e_bin_mods_reml_T       <- reml_to_true(herb_early_mods_binomial)
herb_e_quant_mods_reml_T <- reml_to_true(herb_early_mods_quant)
herb_l_bin_mods_reml_T <- reml_to_true(herb_late_mods_binomial)
herb_l_quant_mods_reml_T       <- reml_to_true(herb_late_mods_quant)
weevil_bin_mods_reml_T  <- reml_to_true(weev_mods_binomial)
weevil_quant_mods_reml_T  <- reml_to_true(weev_mods_quant)

all_models_reml_T <- list(
latex_mods_reml_T      ,
herb_e_bin_mods_reml_T       ,
herb_e_quant_mods_reml_T ,
herb_l_bin_mods_reml_T ,
herb_l_quant_mods_reml_T       ,
weevil_bin_mods_reml_T  ,
weevil_quant_mods_reml_T   )

names(all_models_reml_T) <- c(
"latex_mods"         ,
"herb_early_mods_binomial"    ,
"herb_early_mods_quant"    ,
"herb_late_mods_binomial"     ,
"herb_late_mods_quant"     ,
"weev_mods_binomial" ,
"weev_mods_quant")

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Defense_trait_analyses/Tables/Rsquare.csv"))


# export as nice tables in word doc
# these first two throw errors because there's no alt model for urb subs, so I'll manually edit function to suit them
# latex_r2      <- make_r2_table( latex_mods_reml_T    ) 
# herb_e_bin_r2       <- make_r2_table(herb_e_bin_mods_reml_T      ) 

latex_r2 <- lapply(latex_mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      as.data.table() %>%
      melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m", "City_urbsubs_alt.R2m",
                              "Usc_urbsubs.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c", "City_urbsubs_alt.R2c",
                              "Usc_urbsubs.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m", "Distance_Q2_alt.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c", "Distance_Q2_alt.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,
                    Distance_Q2_alt.R2m,
                    Distance_Q2_alt.R2c,
                    
                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,4,2,2))%>%
      add_header_row(
        values = c("",
                   "Best Models", "Alternative Models",
                   "Best Models"),
        colwidths = c(1,4,2,4)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,6,4)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")


herb_e_bin_r2 <- lapply(herb_e_bin_mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      as.data.table() %>%
        melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m",
                              "Usc_urbsubs_best.R2m",  "Usc_urbsubs_alt.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c",
                              "Usc_urbsubs_best.R2c",  "Usc_urbsubs_alt.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m",
                          "UrbScore_Q2_best.R2m", "UrbScore_Q2_alt.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c",
                          "UrbScore_Q2_best.R2c", "UrbScore_Q2_alt.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,
                    
                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c,
                    UrbScore_Q2_alt.R2m,
                    UrbScore_Q2_alt.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,2,2,4)) %>%
      add_header_row(
        values = c("",
                   "Best Models", 
                   "Best Models", "Alternative Models"),
        colwidths = c(1,4,4,2)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,4,6)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")
  

herb_e_quant_r2 <- make_r2_table(herb_e_quant_mods_reml_T) 
herb_l_bin_r2 <- make_r2_table( herb_l_bin_mods_reml_T) 
herb_l_quant_r2       <- make_r2_table(herb_l_quant_mods_reml_T      ) 
weevil_bin_r2  <- make_r2_table(weevil_bin_mods_reml_T) 
weevil_quant_r2  <- make_r2_table( weevil_quant_mods_reml_T ) 

# will do this in 3 docs b/c function accepts 3 tables at a time (something to try tweaking in the future)
# table 1
export_r2(latex_r2    , 
herb_e_bin_r2      ,
herb_e_quant_r2,
          "Latex",
          "Herbivory before flowering (binary)", 
          "Herbivory before flowering (quantitative)",
          "./Defense_trait_analyses/Tables/R2_Defense1.docx")

# table 2
export_r2(
herb_l_bin_r2,
herb_l_quant_r2      ,
weevil_bin_r2 ,
          "Herbivory after flowering (binary)",
          "Herbivory after flowering (quantitative)", 
          "Weevil damage (binary)",
          "./Defense_trait_analyses/Tables/R2_Defense2.docx")

# table 3: will just use code from function
  word_export <- read_docx()
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Weevil damage (quantitative)", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, weevil_quant_r2)
  
  word_export <- body_end_section_landscape(word_export)
  print(word_export, here::here("./Defense_trait_analyses/Tables/R2_Defense3.docx"))
```

## lms (cardenolides)
```{r}



# total / City_dist
card_total_mods[[1]] %>%
  broom::glance() %>%
  dplyr::select(r.squared:adj.r.squared) %>%
  as.data.frame() %>%
  dplyr::mutate(Variable = toString(card_total_mods[[1]]$terms[[2]]),
         Urbanization = toString(card_total_mods[[1]]$terms[[3]]),
         r.squared = round(r.squared, 3),
         adj.r.squared = round(adj.r.squared, 3)) %>%
  dplyr::rename(R2 = 1, 
                R2.adj = 2) %>%
  dplyr::select(Variable, Urbanization, R2, R2.adj) %>%
  
  dplyr::mutate(Variable = case_when(
    str_detect(Variable, "total")~
      "Total Cardenolides",
    str_detect(Variable, "6.6") ~
      "Peak 6.6",
    str_detect(Variable, "15") ~
      "Peak 15",
    str_detect(Variable, "17.6") ~
      "Peak 17.6")) %>%
  
  dplyr::mutate(Urbanization = case_when(
    str_detect(Urbanization, "City_dist")~
      "Distance to City Center",
    str_detect(Urbanization, "Urb_score")~
      "Urbanization score")) %>%
  
  flextable() %>%
  autofit()
```

# Calculate heritability, Qst, and CVA
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"

-not possible for cardenolides because there are no families within pops (were pooled by population)
## Calculate values per trait
```{r}
# Latex-----
update(
    latex_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

latex_mean <- latex %>%
  dplyr::summarize(Mean = mean(Latex_weight_mg,
                               na.rm = T)) %>%
  as.numeric()

qg_latex <- calc_quantgenvars( 0.086644,
                   0.079411,
                   0.387388,
                   latex_mean,
                   "Latex")


# Herbivory, before flowering: Binomial-----

update(
    herb_e_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    herb_e_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

herb_e_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_e_bin <- calc_quantgenvars(  1.8027e-04,
                    2.1094e-05,
                   resid_var,
                   herb_e_bin_mean,
                   "Chance of herbivory (before flowering)")


# Herbivory, before flowering: quantitative-----

update(
    herb_e_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

herb_e_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_early_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_e_quant <- calc_quantgenvars( 0.076138  ,
                    0.068185  ,
                   1.230037 ,
                   herb_e_quant_mean,
                   "Herbivory (before flowering)")

# Herbivory, after flowering: Binomial-----

update(
    herb_l_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    herb_l_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

herb_l_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_l_bin <- calc_quantgenvars(2.3267e-01,
                   6.1084e-05,
                   resid_var,
                   herb_l_bin_mean,
                   "Chance of herbivory (after flowering)")



# Herbivory, after flowering: quantitative-----

update(
    herb_l_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

herb_l_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_late_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_l_quant <- calc_quantgenvars( 1.5181e-01 ,
                   8.5992e-05,
                  1.2381e+00,
                   herb_l_quant_mean,
                   "Herbivory (after flowering)")


# Weevil: Binomial-----

update(
    weev_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    weev_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

weev_bin_mean <- weevil %>%
  dplyr::summarize(Mean = mean(Scar_binary ,
                               na.rm = T)) %>%
  as.numeric()

qg_weev_bin <- calc_quantgenvars(0.54935944  ,
                     0.00015261,
                   resid_var,
                   weev_bin_mean,
                   "Chance of weevil damage")


# Weevil damage: quantitative-----

update(
    weev_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

weev_quant_mean <- weevil %>%
  dplyr::filter(Scar_length_cm > 0) %>%
  dplyr::summarize(Mean = mean(Scar_length_cm,
                               na.rm = T)) %>%
  as.numeric()

qg_weev_quant <- calc_quantgenvars( 0.20088 ,
                  0.10085 ,
                 1.05936 ,
                   weev_quant_mean,
                   "Weevil scar length")

```

## Combine values into one table and export
```{r}
qg_joined <- list(qg_latex,
                  qg_herb_e_bin,
                  qg_herb_e_quant,
                  qg_herb_l_bin,
                  qg_herb_l_quant,
                  qg_weev_bin,
                  qg_weev_quant) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Defense_trait_analyses/Tables/quant_gen_defense.csv",
          row.names=FALSE)

```

