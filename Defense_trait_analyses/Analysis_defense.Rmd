---
title: "Defense Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| Herbivory: Before flowering |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Herbivory: After flowering  | X         | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Quantitative |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Binary       |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Cardenolide Concentration   |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Latex Volume                |           | X         |           |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_Defense.Rmd", quiet=TRUE))
```

# Ranova
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
- Also using Pop/Fam instead of Pop:Fam or Pop/Fam_uniq like I did when making models earlier
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## Gradient / City_dist
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################

# Latex-----
latex_ranova_mod1 <- lmer(Latex_weight_mg^(1/3) ~
                            Block +
                            (1|Population/Family) +
                            City_dist,
                        data = latex,
                        REML = T)

latex_ranova1 <- CreateRanovaOutput(latex_ranova_mod1, "Latex Exudation") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/latex.html"))

############ MEASURED IN MULTIPLE YEARS ########
################################################
# Herbivory (before flowering) (quantitative)-------
herbiv_e_quant_ranova_mod1 <- lmer(log(Herbivory_mean_early) ~
                               Block +
                               Year + 
                               (1|Population/Family) +
                                City_dist,
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1),
                              REML = T)

herbiv_e_quant_ranova1 <- CreateRanovaOutput(herbiv_e_quant_ranova_mod1, "Herbivory, before flowering: Quantitative") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/herbivory_early_quant.html"))

# Herbivory (after flowering) (quantitative)-------
herbiv_l_quant_ranova_mod1 <- lmer(log(Herbivory_mean_late) ~
                               Block +
                               Year + 
                               (1|Population/Family) +
                                City_dist,
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_late_binary == 1),
                              REML = T)

herbiv_l_quant_ranova1 <- CreateRanovaOutput(herbiv_l_quant_ranova_mod1, "Herbivory, after flowering: Quantitative") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/herbivory_late_quant.html"))



# Weevil scar length (quantitative)-----
weev_quant_ranova_mod1 <- lmer(log(Scar_length_cm) ~
                                   Block +
                                   Year +
                                   (1|Population/Family) +
                                   City_dist,
                              data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0),
                              REML = T)


weev_q_ranova1 <- CreateRanovaOutput(weev_quant_ranova_mod1, "Weevil Damage: Quantitative") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/weevil_quant.html"))
```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# NOT PERFECT b/c can't nest family within pop
# Ben Bolker says it should work too: https://stackoverflow.com/questions/69842066/testing-for-the-significance-of-a-random-effect-in-a-mixed-model
# https://github.com/glmmTMB/glmmTMB/issues/456


# Herbivory (before flowering) (Binary)-------

# take out fam
full <- glmer(Herbivory_mean_early_binary ~
                               Block +
                               Year + 
                               (1|Population) +
                                City_dist,
                              data = herbivory,
                       family = binomial,
            na.action = na.exclude # THIS LINE IS IMPORTANT
  )
  

reduced <- update(full, .~. - City_dist)

herbiv_e_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,          
          cl = makeCluster(7))

tidy(herbiv_e_ranova.pop) # p = 0.047





# take out pop
full <- glmer(Herbivory_mean_early_binary ~
                Block + Year + 
                (1|Fam_uniq) + City_dist,
                              data = herbivory,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)

herbiv_e_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
                    cl = makeCluster(7))

tidy(herbiv_e_ranova.fam) # Family: p ~ 0.046




# merge Pop and Fam ranovas
herbiv_e_bin_ranova1 <- CreateRanovaOutput_bootstrap(herbiv_e_ranova.fam, herbiv_e_ranova.pop, "Herbivory, before flowering: Binary") %T>%
  flextable::save_as_html(path = here::here("./Defense_trait_analyses/Tables/Ranova/herbivory_early_binary.html"))



# Herbivory (after flowering) (Binary)-------
# take out fam
full <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Population) + City_dist,
                              data = herbivory,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )
  

reduced <- update(full, .~. - City_dist)

herbiv_l_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,          
          cl = makeCluster(7))

tidy(herbiv_l_ranova.pop) # Pop: p ~ 0.482



# take out pop
full <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Fam_uniq) + City_dist,
                              data = herbivory,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)

herbiv_l_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
                    cl = makeCluster(7))

tidy(herbiv_l_ranova.fam) # Family: p ~ 0.502




# merge Pop and Fam ranovas
herbiv_l_bin_ranova1 <- CreateRanovaOutput_bootstrap(herbiv_l_ranova.fam, herbiv_l_ranova.pop, "Herbivory, after flowering: Binary") %T>%
  flextable::save_as_html(path = here::here("./Defense_trait_analyses/Tables/Ranova/herbivory_late_binary.html"))


# Weevil scar length (binary)-----
# take out fam
full <- glmer(Scar_binary ~
                Block + Year + 
                (1|Population) + City_dist,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - City_dist)

weev_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,          
          cl = makeCluster(7))

tidy(weev_ranova.pop) # Pop: p ~ 0.500





# take out pop
full <- glmer(Scar_binary ~
                 Block + Year + 
                (1|Fam_uniq) + City_dist,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - City_dist)

weev_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
                    cl = makeCluster(7))

tidy(weev_ranova.fam) # Family: p ~ 0.472




# merge Pop and Fam ranovas
weev_bin_ranova1 <- CreateRanovaOutput_bootstrap(weev_ranova.fam, weev_ranova.pop, "Weevil Damage: Binary") %T>%
  flextable::save_as_html(path = here::here("./Defense_trait_analyses/Tables/Ranova/weevil_binary.html"))
```

## Gradient / Urb_score- NOT UPDATED AS OF 5/28/22
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################

# Latex-----
latex_ranova_mod2 <- lmer(Latex_weight_mg ~ (1|Population/Family) + Block + Urb_score,
                        data = latex,
                        REML = T)

latex_ranova1 <- CreateRanovaOutput(latex_ranova_mod2, "Latex Exudation") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/latex.html"))

############ MEASURED IN MULTIPLE YEARS ########
################################################
# **Herbivory (before flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Herbivory (after flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Weevil scar length (binary)-----

## Using bootstrapping for this one too.



# Weevil scar length (quantitative)-----
weev_quant_ranova_mod2 <- lmer(Scar_length_cm^(1/3) ~ Block + Year + (1|Population/Family) + Urb_score,
                              data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0),
                              REML = T)


weev_q_ranova1 <- CreateRanovaOutput(weev_quant_ranova_mod2, "Weevil Damage: Quantitative") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/weevil_quant.html"))
```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# NOT PERFECT b/c can't nest family within pop
# Ben Bolker says it should work too: https://stackoverflow.com/questions/69842066/testing-for-the-significance-of-a-random-effect-in-a-mixed-model
# https://github.com/glmmTMB/glmmTMB/issues/456


# Herbivory (before flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one
 

# Herbivory (after flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one


# Weevil scar length (binary)-----
# take out block and year- doesn't converge with both included
# take out fam
full <- glmer(Scar_binary ~
                # Block + Year + 
                (1|Population) + Urb_score,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - Urb_score)

weev_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000)

tidy(weev_ranova.pop) # Pop: p ~ 0.679





# take out pop
full <- glmer(Scar_binary ~
                # Block + Year + 
                (1|Fam_uniq) + Urb_score,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - Urb_score)

weev_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000)

tidy(weev_ranova.fam) # Family: p ~ 0.661




# merge Pop and Fam ranovas
weev_bin_ranova1 <- CreateRanovaOutput_bootstrap(weev_ranova.fam, weev_ranova.pop, "Weevil Damage: Binary") %T>%
  flextable::save_as_html(path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/weevil_binary.html"))
```

## Urban Subtransects / City_dist
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################


# Latex-----
## test City_dist
latex_ranova_mod1 <- lmer(Latex_weight_mg^(1/3) ~ (1|Population/Family) + Block + City_dist,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
latex_ranova_mod2 <- lmer(Latex_weight_mg^(1/3) ~ (1|Population/Family) + Block + Transect_ID,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)




latex_ranova1 <- CreateRanovaOutput(latex_ranova_mod1, "Latex (Distance)")
latex_ranova2 <- CreateRanovaOutput_Q2(latex_ranova_mod2, "Latex (Transect)")

flextable::save_as_html(latex_ranova1,
                        latex_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/latex_transects.html"))



############ MEASURED IN MULTIPLE YEARS ########
################################################
# Herbivory (before flowering)- (quantitative)-------
## test City_dist
herb_e_quant_ranova_mod1 <- lmer(log(Herbivory_mean_early) ~
                                   (1|Population/Family) +
                                   Year +
                                   Block +
                                   City_dist,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_early_binary == 1 &
                          Transect_ID != "Rural"),
                           REML = T)

## test transect
herb_e_quant_ranova_mod2 <- lmer(log(Herbivory_mean_early) ~
                                 (1|Population/Family) +
                                 Block +
                                 Year +
                                 Transect_ID,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_early_binary == 1 &
                          Transect_ID != "Rural"),
                           REML = F)


herb_e_quant_ranova1 <- CreateRanovaOutput(herb_e_quant_ranova_mod1, "Herbivory, before flowering: Quantitative (Distance)")
herb_e_quant_ranova2 <- CreateRanovaOutput_Q2(herb_e_quant_ranova_mod2, "Herbivory, before flowering: Quantitative (Transect)")

flextable::save_as_html(herb_e_quant_ranova1,
                        herb_e_quant_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/herb_e_quant_transects.html"))


# Herbivory (after flowering) (quantitative)-------
## test City_dist
herb_l_quant_ranova_mod1 <- lmer(log(Herbivory_mean_late) ~
                                   (1|Population/Family) +
                                   Year +
                                   Block +
                                   City_dist,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_late_binary == 1 &
                          Transect_ID != "Rural"),
                           REML = T)

## test transect
herb_l_quant_ranova_mod2 <- lmer(log(Herbivory_mean_late) ~
                                 (1|Population/Family) +
                                 Block +
                                 Year +
                                 Transect_ID,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_late_binary == 1 &
                          Transect_ID != "Rural"),
                           REML = F)


herb_l_quant_ranova1 <- CreateRanovaOutput(herb_l_quant_ranova_mod1, "Herbivory, after flowering: Quantitative (Distance)")
herb_l_quant_ranova2 <- CreateRanovaOutput_Q2(herb_l_quant_ranova_mod2, "Herbivory, after flowering: Quantitative (Transect)")

flextable::save_as_html(herb_l_quant_ranova1,
                        herb_l_quant_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/herb_l_quant_transects.html"))



# Weevil scar length (quantitative)-----

## test City_dist
weev_quant_ranova_mod1 <- lmer(log(Scar_length_cm) ~ (1|Population/Family) + Block + City_dist,
                             data = weevil %>%
                          dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                           REML = T)

## test transect
weev_quant_ranova_mod2 <- lmer(log(Scar_length_cm) ~ (1|Population/Family) + Block + Transect_ID,
                             data = weevil %>%
                          dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                           REML = F)


weev_quant_ranova1 <- CreateRanovaOutput(weev_quant_ranova_mod1, "Weevil Damage: Quantitative (Distance)")
weev_quant_ranova2 <- CreateRanovaOutput_Q2(weev_quant_ranova_mod2, "Weevil Damage: Quantitative (Transect)")

flextable::save_as_html(weev_quant_ranova1,
                        weev_quant_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/weev_quant_transects.html"))
```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# Herbivory (before flowering) (binary)-------
## test city_dist
### take out fam
full <- glmer(Herbivory_mean_early_binary ~
                Block + Year + 
                (1|Population) + City_dist,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- glmer(Herbivory_mean_early_binary ~
                Block + Year + 
                (1|Population),
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

herb_e_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(herb_e_ranova.pop) # Pop: p ~ 0.474


### take out pop
full <- glmer(Herbivory_mean_early_binary ~
                Block + Year + 
                (1|Fam_uniq) + City_dist + Transect_ID,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- glmer(Herbivory_mean_early_binary ~
                Block + Year + 
                (1|Fam_uniq),
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

herb_e_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(herb_e_ranova.fam) # Family: p ~ 0.697



## test transect
test_tr <- glmer(Herbivory_mean_early_binary ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
herb_e_bin_ranova1 <- CreateRanovaOutput_bootstrap(herb_e_ranova.fam, herb_e_ranova.pop, "Herbivory, before flowering: Binary (Distance)")

## test transect
herb_e_bin_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Herbivory, before flowering: Binary (Transect)")

flextable::save_as_html(herb_e_bin_ranova1,
                        herb_e_bin_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/herb_e_binary_transects.html"))



# Herbivory (after flowering) (binary)-------
## test city_dist
### take out fam
full <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Population) + City_dist,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Population),
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

herb_l_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(herb_l_ranova.pop) # Pop: p ~ 0.202


### take out pop
full <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Fam_uniq) + City_dist + Transect_ID,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Fam_uniq),
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

herb_l_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(herb_l_ranova.fam) # Family: p ~ 0.390



## test transect
test_tr <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
herb_l_bin_ranova1 <- CreateRanovaOutput_bootstrap(herb_l_ranova.fam, herb_l_ranova.pop, "Herbivory, after flowering: Binary (Distance)")

## test transect
herb_l_bin_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Herbivory, after flowering: Binary (Transect)")

flextable::save_as_html(herb_l_bin_ranova1,
                        herb_l_bin_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/herb_l_binary_transects.html"))

# Weevil scar length (binary)-----
## test city_dist
### take out fam
full <- glmer(Scar_binary ~
                Block + Year + 
                (1|Population) + City_dist,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  # ,control=glmerControl(optimizer="bobyqa",
  #                           optCtrl=list(maxfun=2e5))
  )

reduced <- glmer(Scar_binary ~
                Block + Year + 
                (1|Population),
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  # ,control=glmerControl(optimizer="bobyqa",
  #                           optCtrl=list(maxfun=2e5))
  )

weev_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(weev_ranova.pop) # Pop: p ~ 0.353


### take out pop
full <- glmer(Scar_binary ~
                Block + Year + 
                (1|Fam_uniq) + City_dist + Transect_ID,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- glmer(Scar_binary ~
                 Block + Year + 
                (1|Fam_uniq),
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

weev_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(weev_ranova.fam) # Family: p ~ 0.633



## test transect
test_tr <- glmer(Scar_binary ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
weev_bin_ranova1 <- CreateRanovaOutput_bootstrap(weev_ranova.fam, weev_ranova.pop, "Weevil Damage: Binary (Distance)")

## test transect
weev_bin_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Weevil Damage: Binary (Transect)")

flextable::save_as_html(weev_bin_ranova1,
                        weev_bin_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/weevil_binary_transects.html"))
```

## Urban Subtransects / Urb_score- NOT UPDATED AS OF 5/28/22
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################


# Latex-----
## test Urb_score
latex_ranova_mod1 <- lmer(Latex_weight_mg^(1/2) ~ (1|Population/Family) + Block + Urb_score,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
latex_ranova_mod2 <- lmer(Latex_weight_mg^(1/2) ~ (1|Population/Family) + Block + Transect_ID,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


latex_ranova1 <- CreateRanovaOutput(latex_ranova_mod1, "Latex (Urbanization Score)")
latex_ranova2 <- CreateRanovaOutput_Q2(latex_ranova_mod2, "Latex (Transect)")

flextable::save_as_html(latex_ranova1,
                        latex_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/latex_transects.html"))



############ MEASURED IN MULTIPLE YEARS ########
################################################
# **Herbivory (before flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Herbivory (after flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Weevil scar length (binary)-----

## Using boostrapping for this one too.



# Weevil scar length (quantitative)-----

## test Urb_score
weev_quant_ranova_mod1 <- lmer(Scar_length_cm^(1/3) ~ (1|Population/Family) + Block + Urb_score,
                             data = weevil %>%
                          dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                           REML = T)

## test transect
weev_quant_ranova_mod2 <- lmer(Scar_length_cm^(1/3) ~ (1|Population/Family) + Block + Transect_ID,
                             data = weevil %>%
                          dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                           REML = F)


weev_quant_ranova1 <- CreateRanovaOutput(weev_quant_ranova_mod1, "Weevil Damage: Quantitative (Urbanization Score)")
weev_quant_ranova2 <- CreateRanovaOutput_Q2(weev_quant_ranova_mod2, "Weevil Damage: Quantitative (Transect)")

flextable::save_as_html(weev_quant_ranova1,
                        weev_quant_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/weev_quant_transects.html"))
```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# Herbivory (before flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one
 

# Herbivory (after flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one


# Weevil scar length (binary)-----
## test Urb_score-----
### take out fam
full <- glmer(Scar_binary ~
                # Block + Year + 
                (1|Population) + Urb_score,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- glmer(Scar_binary ~
                # Block + Year + 
                (1|Population),
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

weev_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(weev_ranova.pop) # Pop: p ~ 0.709


### take out pop
full <- glmer(Scar_binary ~
                # Block + Year + 
                (1|Fam_uniq) + Urb_score,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- glmer(Scar_binary ~
                # Block + Year + 
                (1|Fam_uniq),
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

weev_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(weev_ranova.fam) # Family: p ~ 0.707


## test transect-----
# already done for city_dist above: use this object: test_tr


# merge Pop and Fam ranovas
## test Urb_score
weev_bin_ranova1 <- CreateRanovaOutput_bootstrap(weev_ranova.fam, weev_ranova.pop, "Weevil Damage: Binary (Distance)")

## test transect
weev_bin_ranova2 # created in city_dist chunk above

flextable::save_as_html(weev_bin_ranova1,
                        weev_bin_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/weevil_binary_transects.html"))
```

# Anova
## Latex
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(latex_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/latex_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(latex_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/latex_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(latex_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/latex_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```
## Herbivory- Early: Binomial
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_e_bin_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_bin_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_e_bin_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_bin_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
# NONE
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_e_bin_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_bin_urbscore_alt.png"))
```

## Herbivory- Early: Quantitative
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_e_quant_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_quant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_e_quant_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_quant_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_e_quant_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_quant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_e_quant_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_quant_urbscore_alt.png"))
```


## Herbivory- Late: Binomial
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_l_bin_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_bin_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_l_bin_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_bin_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_l_bin_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_bin_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_l_bin_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_bin_urbscore_alt.png"))
```

## Herbivory- Late: Quantitative
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_l_quant_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_quant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_l_quant_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_quant_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_l_quant_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_quant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_l_quant_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_quant_urbscore_alt.png"))
```


## Weevil Scar- Binomial
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_bin_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_bin_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_bin_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_bin_urbscore_alt.png"))
```


## Weevil Scar- Quantitative
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_quant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_quant_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_quant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_quant_urbscore_alt.png"))
```


# R-squared values
```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  print()

```

# Calculate heritability, Qst, and CVA
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"

```{r}
calc_quantgenvars()


# Latex-----
VarCorr(
  update(
    latex_mods_best_c[[1]], REML = T))

update(
    latex_mods_best_c[[1]], 
    -City_dist,
    REML = T) %>% VarCorr()

Calc_h2_qst(0.087004    ,
                    0.080444    ,
                    0.387433    )


# Herbivory, before flowering: Binomial-----
VarCorr(
  update(
    herb_e_bin_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    herb_e_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(1.0789e-04,
         2.1921e-05,
         resid_var)



# Herbivory, before flowering: quantitative-----
VarCorr(
  update(
    herb_e_quant_mods_best_c[[1]], REML = T))

Calc_h2_qst(0.074737  ,
                    0.080819,
                    1.229989  )

# Herbivory, after flowering: Binomial-----
VarCorr(
  update(
    herb_l_bin_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    herb_l_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(2.6336e-01,
         6.7803e-05,
         resid_var)

# Herbivory, after flowering: quantitative-----
VarCorr(
  update(
    herb_l_quant_mods_best_c[[1]], REML = T))

Calc_h2_qst(1.4860e-01  ,
                    7.7739e-05 ,
                    1.2378e+00  )

# Weevil: Binomial-----
VarCorr(
  update(
    weev_bin_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    weev_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(0.55203099,
         0.00019397,
         resid_var)



# Weevil damage: quantitative-----
VarCorr(
  update(
    weev_quant_mods_best_c[[1]], REML = T))

Calc_h2_qst(0.198485  ,
                    0.091009 ,
                    1.059765  )

```

# Calculate additive genetic coefficient of variation
```{r}
Calc_h2_qst()

# CVA(fam_var,
#     pop_var,
#     resid_var,
#     trait_mean)

# practice example: latex-----
latex_mean <- latex %>%
  dplyr::summarize(Mean = mean(Latex_weight_mg,
                               na.rm = T))

CVA(1.5491,
    1.1931,
    5.2429,
    latex_mean[[1]])
# 
# 
# CVA(1.5410      ,
#     1.2044      ,
#     5.2424,
#     latex_mean[[1]])


# practice example: weevil damage (quant)-----
weev_mean <- weevil %>%
  dplyr::filter(Scar_length_cm > 0) %>%
  dplyr::summarize(Mean = mean(Scar_length_cm,
                               na.rm = T))

CVA(0.13743,
    0.07537,
    0.60462,
    weev_mean[[1]])


# practice example: herbivore attack, before flowering (binomial)------
herbiv_e_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early_binary,
                               na.rm = T))

CVA(1.4560e-04,
    1.5085e-05,
    update(
    herb_e_bin_mods_best_c[[1]], REML = T) %>%
    sigma() ,
    herbiv_e_bin_mean[[1]])

# practice example: herbivore attack, after flowering (binomial)------
herbiv_l_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late_binary,
                               na.rm = T))

CVA(1.0308e-04,
    1.6463e-05,
    update(
    herb_l_bin_mods_best_c[[1]], REML = T) %>%
    sigma() ,
    herbiv_l_bin_mean[[1]])
```

