---
title: "Defense Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| Herbivory: Before flowering |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Herbivory: After flowering  | X         | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Quantitative |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Binary       |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Cardenolide Concentration   |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Latex Volume                |           | X         |           |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_Defense.Rmd", quiet=TRUE))
```

# Ranova
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## Gradient
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################

# Latex-----
# fit original model
latex_ranova_mod1 <- lmer(Latex_weight_mg^(1/3) ~
                            Block +
                            (1|Population/Family),
                          data = latex,
                          REML = T)

# check diagnostics and transform if necessary
performance::check_model(latex_ranova_mod1)

# export
ranova_2step(latex_ranova_mod1,
             "Latex",
             "./Defense_trait_analyses/Tables/Ranova/latex.docx")


############ MEASURED IN MULTIPLE YEARS ########
################################################
# Herbivory (before flowering) (quantitative)-------
herbiv_e_quant_ranova_mod1 <- lmer(log(Herbivory_mean_early) ~
                                Block +
                               (1|Population/Family),
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1 &
                            Year == 2020),
                              REML = T)

# check diagnostics and transform if necessary
performance::check_model(herbiv_e_quant_ranova_mod1)

# export
ranova_2step(herbiv_e_quant_ranova_mod1,
             "Herbivory before flowering, quantitative: 2020",
             "./Defense_trait_analyses/Tables/Ranova/herbivory_early_quant_2020.docx")


herbiv_e_quant_ranova_mod2 <- lmer(log(Herbivory_mean_early) ~
                               Block +
                               (1|Population/Family),
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_early_binary == 1 &
                            Year == 2021),
                              REML = T)

# check diagnostics and transform if necessary
performance::check_model(herbiv_e_quant_ranova_mod2)

# export
ranova_2step(herbiv_e_quant_ranova_mod1,
             "Herbivory before flowering, quantitative: 2021",
             "./Defense_trait_analyses/Tables/Ranova/herbivory_early_quant_2021.docx")


# Herbivory (after flowering) (quantitative)-------
herbiv_l_quant_ranova_mod1 <- lmer(log(Herbivory_mean_late) ~
                                Block +
                               (1|Population/Family),
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_late_binary == 1 &
                            Year == 2020),
                              REML = T)

# check diagnostics and transform if necessary
performance::check_model(herbiv_l_quant_ranova_mod1)

# export
ranova_2step(herbiv_l_quant_ranova_mod1,
             "Herbivory after flowering, quantitative: 2020",
             "./Defense_trait_analyses/Tables/Ranova/herbivory_late_quant_2020.docx")


herbiv_l_quant_ranova_mod2 <- lmer(log(Herbivory_mean_late) ~
                                Block +
                               (1|Population/Family),
                              data = herbivory %>%
                        dplyr::filter(
                          Herbivory_mean_late_binary == 1 &
                            Year == 2021),
                              REML = T)

# check diagnostics and transform if necessary
performance::check_model(herbiv_l_quant_ranova_mod2)

# export
ranova_2step(herbiv_l_quant_ranova_mod1,
             "Herbivory after flowering, quantitative: 2021",
             "./Defense_trait_analyses/Tables/Ranova/herbivory_late_quant_2021.docx")




# Weevil scar length (quantitative)-----
weev_quant_ranova_mod1 <- lmer(log(Scar_length_cm) ~
                                    Block +
                                   (1|Population/Family), 
                              data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0 &
                                                Year == 2020),
                              REML = T)


# check diagnostics and transform if necessary
performance::check_model(weev_quant_ranova_mod1)

# export
ranova_2step(weev_quant_ranova_mod1,
             "Weevil damage, quantitative: 2020",
             "./Defense_trait_analyses/Tables/Ranova/weevil_quant_2020.docx")


weev_quant_ranova_mod2 <- lmer(log(Scar_length_cm) ~
                                    Block +
                                   (1|Population/Family), 
                              data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0 &
                                                Year == 2021),
                              REML = T)


# check diagnostics and transform if necessary
performance::check_model(weev_quant_ranova_mod2)

# export
ranova_2step(weev_quant_ranova_mod1,
             "Weevil damage, quantitative: 2021",
             "./Defense_trait_analyses/Tables/Ranova/weevil_quant_2021.docx")


```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# Herbivory (before flowering) (Binary)-------
# 2020-----
herb_e_bin_ranova1 <- glmer(Herbivory_mean_early_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = herbivory %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(herb_e_bin_ranova1)

pb_ranova(herb_e_bin_ranova1,
          "Herbivory before flowering, binary: 2020",
          "./Defense_trait_analyses/Tables/Ranova/herb_e_bin_2020.docx")



# 2021-----
herb_e_bin_ranova2 <- glmer(Herbivory_mean_early_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = herbivory %>%
                               dplyr::filter(Year == 2021),
                 na.action = na.exclude,
                             family = binomial)

# performance::check_model(herb_e_bin_ranova2)

pb_ranova(herb_e_bin_ranova2,
          "Herbivory before flowering, binary: 2021",
          "./Defense_trait_analyses/Tables/Ranova/herb_e_bin_2021.docx")


# Herbivory (after flowering) (Binary)-------
# 2020-----
herb_l_bin_ranova1 <- glmer(Herbivory_mean_late_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = herbivory %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(herb_l_bin_ranova1)

pb_ranova(herb_l_bin_ranova1,
          "Herbivory after flowering, binary: 2020",
          "./Defense_trait_analyses/Tables/Ranova/herb_l_bin_2020.docx")



# 2021-----
herb_l_bin_ranova2 <- glmer(Herbivory_mean_late_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = herbivory %>%
                               dplyr::filter(Year == 2021),
                            nAGQ = 0, # won't converge w/o this
                 na.action = na.exclude,
                             family = binomial)

# performance::check_model(herb_l_bin_ranova2)

pb_ranova(herb_l_bin_ranova2,
          "Herbivory after flowering, binary: 2021",
          "./Defense_trait_analyses/Tables/Ranova/herb_l_bin_2021.docx")



# Weevil scar length (binary)-----
# 2020-----
weev_bin_ranova1 <- glmer(Scar_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = weevil %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(weev_bin_ranova1)

pb_ranova(weev_bin_ranova1,
          "Weevil Damage, binary: 2020",
          "./Defense_trait_analyses/Tables/Ranova/weevil_bin_2020.docx")


# 2021-----
weev_bin_ranova2 <- glmer(Scar_binary ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = weevil %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(weev_bin_ranova2)

pb_ranova(weev_bin_ranova2,
          "Weevil Damage, binary: 2021",
          "./Defense_trait_analyses/Tables/Ranova/weevil_bin_2021.docx")
```

## Urban Subtransects
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################

# Latex-----
latex_ranova_mod1 <- lmer(Latex_weight_mg^(1/3) ~
                            (1|Population/Family) +
                            Block,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(latex_ranova_mod1)

ranova_transect(latex_ranova_mod1,
                "Latex",
                "./Defense_trait_analyses/Tables/Ranova/latex_transects.docx")


############ MEASURED IN MULTIPLE YEARS ########
################################################
# Herbivory (before flowering)- (quantitative)-------

# 2020-----
herb_e_quant_ranova_mod1 <- lmer(log(Herbivory_mean_early) ~
                                   (1|Population/Family) +
                                   Block,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_early_binary == 1 &
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(herb_e_quant_ranova_mod1)

ranova_transect(herb_e_quant_ranova_mod1,
                "Herbivory before flowering, quantitative: 2020",
                "./Defense_trait_analyses/Tables/Ranova/herb_e_quant_transects_2020.docx")

# 2021-----
herb_e_quant_ranova_mod2 <- lmer(log(Herbivory_mean_early) ~
                                   (1|Population/Family) +
                                   Block,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_early_binary == 1 &
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(herb_e_quant_ranova_mod2)

ranova_transect(herb_e_quant_ranova_mod2,
                "Herbivory before flowering, quantitative: 2021",
                "./Defense_trait_analyses/Tables/Ranova/herb_e_quant_transects_2021.docx")


# Herbivory (after flowering) (quantitative)-------
# 2020-----
herb_l_quant_ranova_mod1 <- lmer(log(Herbivory_mean_late) ~
                                   (1|Population/Family) +
                                   Block,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_late_binary == 1 &
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(herb_l_quant_ranova_mod1)

ranova_transect(herb_l_quant_ranova_mod1,
                "Herbivory after flowering, quantitative: 2020",
                "./Defense_trait_analyses/Tables/Ranova/herb_l_quant_transects_2020.docx")

# 2021-----
herb_l_quant_ranova_mod2 <- lmer(log(Herbivory_mean_late) ~
                                   (1|Population/Family) +
                                   Block,
                             data = herbivory %>%
                      dplyr::filter(
                        Herbivory_mean_late_binary == 1 &
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(herb_l_quant_ranova_mod2)

ranova_transect(herb_l_quant_ranova_mod2,
                "Herbivory after flowering, quantitative: 2021",
                "./Defense_trait_analyses/Tables/Ranova/herb_l_quant_transects_2021.docx")



# Weevil scar length (quantitative)-----
# 2020-----
weev_quant_ranova_mod1 <- lmer(log(Scar_length_cm) ~
                                   (1|Population/Family) +
                                   Block,
                             data = weevil %>%
                      dplyr::filter(
                        Scar_length_cm > 0 &
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(weev_quant_ranova_mod1)

ranova_transect(weev_quant_ranova_mod1,
                "Weevil damage, quantitative: 2020",
                "./Defense_trait_analyses/Tables/Ranova/weevil_quant_transects_2020.docx")

# 2021-----
weev_quant_ranova_mod2 <- lmer(log(Scar_length_cm) ~
                                   (1|Population/Family) +
                                   Block,
                             data = weevil %>%
                      dplyr::filter(
                        Scar_length_cm > 0 &
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(weev_quant_ranova_mod2)

ranova_transect(weev_quant_ranova_mod2,
                "Weevil damage, quantitative: 2021",
                "./Defense_trait_analyses/Tables/Ranova/weevil_quant_transects_2021.docx")


```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# Herbivory (before flowering) (binary)-------
## test city_dist
### take out fam
full <- glmer(Herbivory_mean_early_binary ~
                 Block + Year + 
                (1|Population) + City_dist,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
           #   nAGQ = 0,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  # ,control=glmerControl(optimizer="bobyqa",
  #                           optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - City_dist)


herb_e_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(herb_e_ranova.pop) # Pop: p ~ 0.474

get_pve(full)  # can't compute. This model is singular in glmer but NOT in glmmtmb



### take out pop
full <- glmer(Herbivory_mean_early_binary ~
                Block + Year + 
                (1|Population/Family) + City_dist,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)


herb_e_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(herb_e_ranova.fam) # Family: p ~ 0.474

get_pve(full)  # can't compute. This model is singular in glmer but NOT in glmmtmb


## test transect
test_tr <- glmer(Herbivory_mean_early_binary ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
herb_e_bin_ranova1 <- CreateRanovaOutput_bootstrap(herb_e_ranova.fam, herb_e_ranova.pop, "Herbivory, before flowering: Binary (Distance)")

## test transect
herb_e_bin_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Herbivory, before flowering: Binary (Transect)")

flextable::save_as_html(herb_e_bin_ranova1,
                        herb_e_bin_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/herb_e_binary_transects.html"))



# Herbivory (after flowering) (binary)-------
## test city_dist
### take out fam
full <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Population) + City_dist,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)


herb_l_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(herb_l_ranova.pop) # Pop: p ~ 0.222

get_pve(full)  # can't compute. This model is singular in glmer but NOT in glmmtmb 



### take out pop
full <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Population/Family) + City_dist,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)


herb_l_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(herb_l_ranova.fam) # Family: p ~ 0.222

get_pve(full)  # can't compute. This model is singular in glmer but NOT in glmmtmb


## test transect
test_tr <- glmer(Herbivory_mean_late_binary ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = herbivory %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
herb_l_bin_ranova1 <- CreateRanovaOutput_bootstrap(herb_l_ranova.fam, herb_l_ranova.pop, "Herbivory, after flowering: Binary (Distance)")

## test transect
herb_l_bin_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Herbivory, after flowering: Binary (Transect)")

flextable::save_as_html(herb_l_bin_ranova1,
                        herb_l_bin_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/herb_l_binary_transects.html"))

# Weevil scar length (binary)-----
## test city_dist
### take out fam
full <- glmer(Scar_binary ~
                Block + Year + 
                (1|Population) + City_dist,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  # ,control=glmerControl(optimizer="bobyqa",
  #                           optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - City_dist)


weev_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(weev_ranova.pop) # Pop: p ~ 0.353

get_pve(full) # 1.376



### take out pop
full <- glmer(Scar_binary ~
                Block + Year + 
                (1|Population/Family) + City_dist,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - City_dist)


weev_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(weev_ranova.fam) # Family: p ~ 0.325

get_pve(full) # 9.856



## test transect
test_tr <- glmer(Scar_binary ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
weev_bin_ranova1 <- CreateRanovaOutput_bootstrap(weev_ranova.fam, weev_ranova.pop, "Weevil Damage: Binary (Distance)")

## test transect
weev_bin_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Weevil Damage: Binary (Transect)")

flextable::save_as_html(weev_bin_ranova1,
                        weev_bin_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/weevil_binary_transects.html"))
```

## Create figure showing % variance explained per component
Note: Can only do this for gaussian models for Q1. For models with transect as an effect, I can calculate PVE for models testing effect of distance only- not transect. But since I'm not as interested in that, I won't generate those plots now.
```{r}
# this isn't working
# library(XML)
# rawHTML <- XML::readHTMLTable("Defense_trait_analyses/Tables/Ranova/latex.html",
#            # header = c("Variable",
#            #            "Group",
#            #            "Variance",
#            #            "PVE",
#            #            "p")) %>%
#              header = T) %>%
#   as.data.frame() %T>%
#   print()

# can't figure out how to convert these ranova html tables with PVE into df or tibble or anything else with code.
# So I'll just create an excel file combining the data from traits for which I could calculate PVE ("PVE_defense_Q1.xlsx"), including these traits:
# -latex ("latex.html")
# -weevil damage, quantitative ("weevil_quant.html")
# -Herbivory, after flowering: Quantitative ("herbivory_late_quant.html")
# -Herbivory, before flowering: Quantitative ("herbivory_early_quant.html")
# -SLA ("sla.html")
# -LDMC ("ldmc.html")


pve <- read.csv(here::here("./Defense_trait_analyses/Tables/Ranova/pve_defense_Q1.csv")) %>%
  dplyr::rename(Variable = 1) %>%
  # make alphabetical order for plot
   mutate(Variable = fct_reorder(Variable,
                                 desc(Variable)))

library("ggsci")

pve_def <- ggplot(pve,
       aes(
         fill=Group,
         y=PVE,
         x=Variable)
       ) + 
  geom_bar(position="stack",
           stat="identity") +
  scale_fill_discrete(labels = c("Family",
                                 "Population",
                                 "Residual")) +
  scale_fill_tron(alpha = 0.7) +
  theme_pubr() +
  xlab("") +
  ylab("% Variance Explained") +
  coord_flip()
pve_def

ggsave(filename = "pve_def_Q1.png",
         plot = pve_def,
         path = here::here("./Defense_trait_analyses/Figures/PVE/"),
         width = 20,
         height = 6,
         units = "cm")
```

# Anova
## Latex
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(latex_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/latex_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(latex_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/latex_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(latex_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/latex_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```
## Herbivory- Early: Binomial
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_e_bin_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_bin_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_e_bin_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_bin_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
# NONE
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_e_bin_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_bin_urbscore_alt.png"))
```

## Herbivory- Early: Quantitative
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_e_quant_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_quant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_e_quant_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_quant_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_e_quant_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_quant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_e_quant_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_quant_urbscore_alt.png"))
```


## Herbivory- Late: Binomial
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_l_bin_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_bin_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_l_bin_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_bin_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_l_bin_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_bin_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_l_bin_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_bin_urbscore_alt.png"))
```

## Herbivory- Late: Quantitative
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_l_quant_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_quant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_l_quant_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_quant_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_l_quant_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_quant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_l_quant_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_quant_urbscore_alt.png"))
```


## Weevil Scar- Binomial
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_bin_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_bin_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_bin_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_bin_urbscore_alt.png"))
```


## Weevil Scar- Quantitative
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_quant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_quant_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_quant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_quant_urbscore_alt.png"))
```


# R-squared values
```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  print()

```

# Calculate heritability, Qst, and CVA
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"
## Calculate values per trait
```{r}
# Latex-----
update(
    latex_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

latex_mean <- latex %>%
  dplyr::summarize(Mean = mean(Latex_weight_mg,
                               na.rm = T)) %>%
  as.numeric()

qg_latex <- calc_quantgenvars( 0.086644,
                   0.079411,
                   0.387388,
                   latex_mean,
                   "Latex")


# Herbivory, before flowering: Binomial-----

update(
    herb_e_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    herb_e_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

herb_e_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_e_bin <- calc_quantgenvars(  1.8027e-04,
                    2.1094e-05,
                   resid_var,
                   herb_e_bin_mean,
                   "Chance of herbivory (before flowering)")


# Herbivory, before flowering: quantitative-----

update(
    herb_e_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

herb_e_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_early_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_e_quant <- calc_quantgenvars( 0.076138  ,
                    0.068185  ,
                   1.230037 ,
                   herb_e_quant_mean,
                   "Herbivory (before flowering)")

# Herbivory, after flowering: Binomial-----

update(
    herb_l_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    herb_l_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

herb_l_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_l_bin <- calc_quantgenvars(2.3267e-01,
                   6.1084e-05,
                   resid_var,
                   herb_l_bin_mean,
                   "Chance of herbivory (after flowering)")



# Herbivory, after flowering: quantitative-----

update(
    herb_l_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

herb_l_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_late_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_l_quant <- calc_quantgenvars( 1.5181e-01 ,
                   8.5992e-05,
                  1.2381e+00,
                   herb_l_quant_mean,
                   "Herbivory (after flowering)")


# Weevil: Binomial-----

update(
    weev_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    weev_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

weev_bin_mean <- weevil %>%
  dplyr::summarize(Mean = mean(Scar_binary ,
                               na.rm = T)) %>%
  as.numeric()

qg_weev_bin <- calc_quantgenvars(0.54935944  ,
                     0.00015261,
                   resid_var,
                   weev_bin_mean,
                   "Chance of weevil damage")


# Weevil damage: quantitative-----

update(
    weev_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

weev_quant_mean <- weevil %>%
  dplyr::filter(Scar_length_cm > 0) %>%
  dplyr::summarize(Mean = mean(Scar_length_cm,
                               na.rm = T)) %>%
  as.numeric()

qg_weev_quant <- calc_quantgenvars( 0.20088 ,
                  0.10085 ,
                 1.05936 ,
                   weev_quant_mean,
                   "Weevil scar length")

```

## Combine values into one table and export
```{r}
qg_joined <- list(qg_latex,
                  qg_herb_e_bin,
                  qg_herb_e_quant,
                  qg_herb_l_bin,
                  qg_herb_l_quant,
                  qg_weev_bin,
                  qg_weev_quant) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Defense_trait_analyses/Tables/quant_gen_defense.csv",
          row.names=FALSE)

```

