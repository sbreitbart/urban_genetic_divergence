---
title: "Defense Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| Herbivory: Before flowering |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Herbivory: After flowering  | X         | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Quantitative |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Binary       |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Specific Leaf Area          |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Dry Leaf Matter Content     |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Cardenolide Concentration   |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Latex Volume                |           | X         |           |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import data

```{r}
# SLA & LDMC-----
sla_ldmc <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_sla_ldmc_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.factor)

str(sla_ldmc)
sla_ldmc %<>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))


# LATEX-----
latex <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_latex_clean.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.character) %>%
    dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.factor) %T>%
  str()

latex %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))

str(latex)


# HERBIVORY-----
herbivory <- read.csv(here::here("./Joined_annual_data/herbivory.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

herbivory %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))



# WEEVIL DAMAGE-----
weevil <- read.csv(here::here("./Joined_annual_data/weevil.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

weevil %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))
```

## Import final models
### Create full list
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_Defense.Rmd", quiet=TRUE))

all_models <- list(
ldmc_mods          , # LDMC
sla_mods           , # SLA
latex_mods         , # Latex
herb_early_mods    , # Herbivory: before flowering
herb_late_mods     , # Herbivory: after flowering
weev_mods_binomial , # Weevil scar: binomial (part of hurdle models)
weev_mods_quant)     # Weevil scar: quantitative (part of hurdle models)

names(all_models) <- c(
"ldmc_mods"          ,
"sla_mods"           ,
"latex_mods"         ,
"herb_early_mods"    ,
"herb_late_mods"     ,
"weev_mods_binomial" ,
"weev_mods_quant")
```

### Create separate lists of best vs. alt models for city_dist vs urb_score
#### LDMC
```{r}
## Best
### City_dist
ldmc_mods_best_c <- ldmc_mods[c(1,4)]

### Urb_score
ldmc_mods_best_u <- ldmc_mods[c(2,6)]

## Alt
### City_dist
ldmc_mods_alt_c <- ldmc_mods[3]

### Urb_score
ldmc_mods_alt_u <- ldmc_mods[5]
```

#### SLA
```{r}
## Best
### City_dist
sla_mods_best_c <- sla_mods[c(1,4)]

### Urb_score
sla_mods_best_u <- sla_mods[c(2,6)]

## Alt
### City_dist
sla_mods_alt_c <- sla_mods[3]

### Urb_score
sla_mods_alt_u <- sla_mods[5]
```


#### Latex
```{r}
## Best
### City_dist
latex_mods_best_c <- latex_mods[c(1,4)]

### Urb_score
latex_mods_best_u <- latex_mods[c(2,5)]

## Alt
### City_dist
latex_mods_alt_c <- latex_mods[3]

### Urb_score- NONE

```


#### Herbivory- Early
```{r}
## Best
### City_dist
herb_e_mods_best_c <- herb_early_mods[c(1,3)]

### Urb_score
herb_e_mods_best_u <- herb_early_mods[c(2,6)]

## Alt
### City_dist
herb_e_mods_alt_c <- herb_early_mods[4]

### Urb_score
herb_e_mods_alt_u <- herb_early_mods[5]

```

#### Herbivory- Late
```{r}
## Best
### City_dist
herb_l_mods_best_c <- herb_late_mods[c(1,3)]

### Urb_score
herb_l_mods_best_u <- herb_late_mods[c(2,5)]

## Alt
### City_dist
herb_l_mods_alt_c <- herb_late_mods[4]

### Urb_score- NONE
```


#### Weevil- Binomial
```{r}
## Best
### City_dist
weev_bin_mods_best_c <- weev_mods_binomial[c(1,4)]

### Urb_score
weev_bin_mods_best_u <- weev_mods_binomial[c(2,6)]

## Alt
### City_dist
weev_bin_mods_alt_c <- weev_mods_binomial[3]

### Urb_score
weev_bin_mods_alt_u <- weev_mods_binomial[5]
```

#### Weevil- Quantitative
```{r}
## Best
### City_dist
weev_quant_mods_best_c <- weev_mods_quant[c(1,4)]

### Urb_score
weev_quant_mods_best_u <- weev_mods_quant[c(2,6)]

## Alt
### City_dist
weev_quant_mods_alt_c <- weev_mods_quant[3]

### Urb_score
weev_quant_mods_alt_u <- weev_mods_quant[5]
```


# Ranova
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
- Also using Pop/Fam instead of Pop:Fam or Pop/Fam_uniq like I did when making models earlier
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## Gradient / City_dist
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################
# LDMC-------
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + City_dist,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 1),
                           REML = T)

ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/ldmc.html"))


# SLA-----
sla_ranova_mod1 <- lmer(SLA ~ (1|Population/Family) + (1|Block) + City_dist,
                        data = sla_ldmc,
                        REML = T)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/sla.html"))


# Latex-----
latex_ranova_mod1 <- lmer(Latex_weight_mg ~ (1|Population/Family) + (1|Block) + City_dist,
                        data = latex,
                        REML = T)

latex_ranova1 <- CreateRanovaOutput(latex_ranova_mod1, "Latex Exudation") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/latex.html"))

############ MEASURED IN MULTIPLE YEARS ########
################################################
# **Herbivory (before flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Herbivory (after flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Weevil scar length (binary)-----

## Using boostrapping for this one too.



# Weevil scar length (quantitative)-----
weev_quant_ranova_mod1 <- lmer(Scar_length_cm^(1/3) ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
                              data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0),
                              REML = T)


weev_q_ranova1 <- CreateRanovaOutput(weev_quant_ranova_mod1, "Weevil Damage: Quantitative") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/weevil_quant.html"))
```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# NOT PERFECT b/c can't nest family within pop
# Ben Bolker says it should work too: https://stackoverflow.com/questions/69842066/testing-for-the-significance-of-a-random-effect-in-a-mixed-model
# https://github.com/glmmTMB/glmmTMB/issues/456


# Herbivory (before flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one


# Herbivory (after flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one


# Weevil scar length (binary)-----

# not converging with block and year
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Population/Family) + City_dist,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - City_dist)

weev_ranova <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))


tidy(weev_ranova) # p ~ 0.495





# take out fam
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Population) + City_dist,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - City_dist)

weev_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,          
          cl = makeCluster(7))

tidy(weev_ranova.pop) # Pop: p ~ 0.512





# take out pop
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Fam_uniq) + City_dist,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - City_dist)

weev_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
                    cl = makeCluster(7))

tidy(weev_ranova.fam) # Family: p ~ 0.495






# merge Pop and Fam ranovas
weev_bin_ranova1 <- CreateRanovaOutput_bootstrap(weev_ranova.fam, weev_ranova.pop, "Weevil Damage: Binary") %T>%
  flextable::save_as_html(path = here::here("./Defense_trait_analyses/Tables/Ranova/weevil_binary.html"))
```

### Export all
```{r}
flextable::save_as_html(ldmc_ranova1,
                        sla_ranova1,
                        latex_ranova1,
                        weev_q_ranova1,
                        weev_bin_ranova1,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/all.html"))
```

## Gradient / Urb_score
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################
# LDMC-------
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 1),
                           REML = T)

ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod2, "LDMC") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/ldmc.html"))


# SLA-----
# same output as Pop:Fam_uniq
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Urb_score,
                        data = sla_ldmc,
                        REML = T)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod2, "SLA") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/sla.html"))


# Latex-----
latex_ranova_mod2 <- lmer(Latex_weight_mg ~ (1|Population/Family) + (1|Block) + Urb_score,
                        data = latex,
                        REML = T)

latex_ranova1 <- CreateRanovaOutput(latex_ranova_mod2, "Latex Exudation") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/latex.html"))

############ MEASURED IN MULTIPLE YEARS ########
################################################
# **Herbivory (before flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Herbivory (after flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Weevil scar length (binary)-----

## Using bootstrapping for this one too.



# Weevil scar length (quantitative)-----
weev_quant_ranova_mod2 <- lmer(Scar_length_cm^(1/3) ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
                              data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0),
                              REML = T)


weev_q_ranova1 <- CreateRanovaOutput(weev_quant_ranova_mod2, "Weevil Damage: Quantitative") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/weevil_quant.html"))
```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# NOT PERFECT b/c can't nest family within pop
# Ben Bolker says it should work too: https://stackoverflow.com/questions/69842066/testing-for-the-significance-of-a-random-effect-in-a-mixed-model
# https://github.com/glmmTMB/glmmTMB/issues/456


# Herbivory (before flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one
 

# Herbivory (after flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one


# Weevil scar length (binary)-----
# take out block and year- doesn't converge with both included
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Population/Family) + Urb_score,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - Urb_score)

weev_ranova <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(weev_ranova) # p ~ 0.661





# take out fam
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Population) + Urb_score,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - Urb_score)

weev_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000)

tidy(weev_ranova.pop) # Pop: p ~ 0.679





# take out pop
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Fam_uniq) + Urb_score,
                              data = weevil,
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- update(full, .~. - Urb_score)

weev_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000)

tidy(weev_ranova.fam) # Family: p ~ 0.661




# merge Pop and Fam ranovas
weev_bin_ranova1 <- CreateRanovaOutput_bootstrap(weev_ranova.fam, weev_ranova.pop, "Weevil Damage: Binary") %T>%
  flextable::save_as_html(path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/weevil_binary.html"))
```

### Export all
```{r}
flextable::save_as_html(ldmc_ranova1,
                        sla_ranova1,
                        latex_ranova1,
                        weev_q_ranova1,
                        weev_bin_ranova1,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/all_urbscore.html"))
```

## Urban Subtransects / City_dist
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################
# LDMC-------
## test City_dist
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + City_dist,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test Transect
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC (Distance)")
ldmc_ranova2 <- CreateRanovaOutput_Q2(ldmc_ranova_mod2, "LDMC (Transect)")

flextable::save_as_html(ldmc_ranova1,
                        ldmc_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/ldmc_transects.html"))


# SLA-----
## test City_dist
sla_ranova_mod1 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + City_dist,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA (Distance)")
sla_ranova2 <- CreateRanovaOutput_Q2(sla_ranova_mod2, "SLA (Transect)")

flextable::save_as_html(sla_ranova1,
                        sla_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/sla_transects.html"))


# Latex-----
## test City_dist
latex_ranova_mod1 <- lmer(Latex_weight_mg^(1/2) ~ (1|Population/Family) + (1|Block) + City_dist,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
latex_ranova_mod2 <- lmer(Latex_weight_mg^(1/2) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


latex_ranova1 <- CreateRanovaOutput(latex_ranova_mod1, "Latex (Distance)")
latex_ranova2 <- CreateRanovaOutput_Q2(latex_ranova_mod2, "Latex (Transect)")

flextable::save_as_html(latex_ranova1,
                        latex_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/latex_transects.html"))



############ MEASURED IN MULTIPLE YEARS ########
################################################
# **Herbivory (before flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Herbivory (after flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Weevil scar length (binary)-----

## Using boostrapping for this one too.



# Weevil scar length (quantitative)-----

## test City_dist
weev_quant_ranova_mod1 <- lmer(Scar_length_cm^(1/3) ~ (1|Population/Family) + (1|Block) + City_dist,
                             data = weevil %>%
                          dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                           REML = T)

## test transect
weev_quant_ranova_mod2 <- lmer(Scar_length_cm^(1/3) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = weevil %>%
                          dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                           REML = F)


weev_quant_ranova1 <- CreateRanovaOutput(weev_quant_ranova_mod1, "Weevil Damage: Quantitative (Distance)")
weev_quant_ranova2 <- CreateRanovaOutput_Q2(weev_quant_ranova_mod2, "Weevil Damage: Quantitative (Transect)")

flextable::save_as_html(weev_quant_ranova1,
                        weev_quant_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/weev_quant_transects.html"))
```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# Herbivory (before flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one
 

# Herbivory (after flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one


# Weevil scar length (binary)-----
## test city_dist-----
### take out fam
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Population) + City_dist,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Population),
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

weev_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(weev_ranova.pop) # Pop: p ~ 0.242


### take out pop
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Fam_uniq) + City_dist + Transect_ID,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Fam_uniq),
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

weev_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(weev_ranova.fam) # Family: p ~ 0.523



## test transect-----
test_tr <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Population/Family) + Transect_ID,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
weev_bin_ranova1 <- CreateRanovaOutput_bootstrap(weev_ranova.fam, weev_ranova.pop, "Weevil Damage: Binary (Distance)")

## test transect
weev_bin_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Weevil Damage: Binary (Transect)")

flextable::save_as_html(weev_bin_ranova1,
                        weev_bin_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/weevil_binary_transects.html"))
```

## Urban Subtransects / Urb_score
### Gaussian models use ranova()
```{r}
############ MEASURED ONLY IN 2020 #############
################################################
# LDMC-------
## test Urb_score
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC (Urbanization Score)")
ldmc_ranova2 <- CreateRanovaOutput_Q2(ldmc_ranova_mod2, "LDMC (Transect)")

flextable::save_as_html(ldmc_ranova1,
                        ldmc_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/ldmc_transects.html"))


# SLA-----
## test Urb_score
sla_ranova_mod1 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA (Urbanization Score)")
sla_ranova2 <- CreateRanovaOutput_Q2(sla_ranova_mod2, "SLA (Transect)")

flextable::save_as_html(sla_ranova1,
                        sla_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/sla_transects.html"))


# Latex-----
## test Urb_score
latex_ranova_mod1 <- lmer(Latex_weight_mg^(1/2) ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
latex_ranova_mod2 <- lmer(Latex_weight_mg^(1/2) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


latex_ranova1 <- CreateRanovaOutput(latex_ranova_mod1, "Latex (Urbanization Score)")
latex_ranova2 <- CreateRanovaOutput_Q2(latex_ranova_mod2, "Latex (Transect)")

flextable::save_as_html(latex_ranova1,
                        latex_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/latex_transects.html"))



############ MEASURED IN MULTIPLE YEARS ########
################################################
# **Herbivory (before flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Herbivory (after flowering)-------

## Can't use glmmTMB model: Get this error message:
### Error in ranova(lmer_model) : 'model' should be an lmer-fit: "inherits(model, 'lmerMod')" is not TRUE 

## glmer can't handle beta family. So can't use that model structure either.


# **Weevil scar length (binary)-----

## Using boostrapping for this one too.



# Weevil scar length (quantitative)-----

## test Urb_score
weev_quant_ranova_mod1 <- lmer(Scar_length_cm^(1/3) ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = weevil %>%
                          dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                           REML = T)

## test transect
weev_quant_ranova_mod2 <- lmer(Scar_length_cm^(1/3) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = weevil %>%
                          dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                           REML = F)


weev_quant_ranova1 <- CreateRanovaOutput(weev_quant_ranova_mod1, "Weevil Damage: Quantitative (Urbanization Score)")
weev_quant_ranova2 <- CreateRanovaOutput_Q2(weev_quant_ranova_mod2, "Weevil Damage: Quantitative (Transect)")

flextable::save_as_html(weev_quant_ranova1,
                        weev_quant_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/weev_quant_transects.html"))
```

### Generalized LMM use bootstrapping with pbmodcomp()
```{r}
# Herbivory (before flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one
 

# Herbivory (after flowering)-------
## glmer can't handle beta distribution, and 
## PBmodcomp can't handle GLMMTMB, so will skip this one


# Weevil scar length (binary)-----
## test Urb_score-----
### take out fam
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Population) + Urb_score,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Population),
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

weev_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(weev_ranova.pop) # Pop: p ~ 0.709


### take out pop
full <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Fam_uniq) + Urb_score,
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

reduced <- glmer(Scar_binary ~
                # (1|Block) + (1|Year) + 
                (1|Fam_uniq),
                              data = weevil %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = "binomial"(link = "logit"),
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )

weev_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(weev_ranova.fam) # Family: p ~ 0.707


## test transect-----
# already done for city_dist above: use this object: test_tr


# merge Pop and Fam ranovas
## test Urb_score
weev_bin_ranova1 <- CreateRanovaOutput_bootstrap(weev_ranova.fam, weev_ranova.pop, "Weevil Damage: Binary (Distance)")

## test transect
weev_bin_ranova2 # created in city_dist chunk above

flextable::save_as_html(weev_bin_ranova1,
                        weev_bin_ranova2,
                        path = here::here("./Defense_trait_analyses/Tables/Ranova/Urb_score/weevil_binary_transects.html"))
```

# Anova
## LDMC
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(ldmc_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/LDMC_citydist.png"))

lapply(ldmc_mods_best_c, MuMIn::r.squaredGLMM)

```

#### Urb_score
```{r}
make_all_anovas_tidy(ldmc_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/LDMC_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/LDMC_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/LDMC_urbscore_alt.png"))
```
## SLA
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(sla_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/sla_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(sla_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/sla_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/sla_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/sla_urbscore_alt.png"))
```
## Latex
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(latex_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/latex_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(latex_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/latex_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(latex_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/latex_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```
## Herbivory- Early
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(herb_e_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(herb_e_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_e_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(herb_e_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_urbscore_alt.png"))
```

## Herbivory- Late
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(herb_l_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(herb_l_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(herb_l_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```


## Weevil Scar- Binomial
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(weev_bin_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_bin_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(weev_bin_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_bin_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_bin_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_bin_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_bin_urbscore_alt.png"))
```


## Weevil Scar- Quantitative
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(weev_quant_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_quant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(weev_quant_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_quant_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_quant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(weev_quant_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_quant_urbscore_alt.png"))
```


# R-squared values
```{r}
# took out lists 4 and 5 from all_models- the herbivory ones- because R.squaredGLMM can't intake models with beta family
all_rsq <- lapply(all_models[-c(4:5)], lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

# super low marginal R2 values. Some conditional R2 are higher (some ~0.15) but most low
```

# Calculate heritability & Qst
Just looking at gradient models- all pops included. 
h2 represents the average heritability across populations after removing the genetic effects due to population differences.
```{r}
# LDMC-----
## my final model, used in ANOVA, uses a crossed pop x fam random effect because the nested pop/fam returns NAn in the ANOVA. Here, I'll use the nested version of the final model and use REML = T.
nested_ldmc <- glmmTMB(LDMC ~ (1|Population/Family) + City_dist,
                            data = sla_ldmc %>%
                              dplyr::filter(LDMC < 1.5),
                       REML = T)

VarCorr(nested_ldmc)

Calc_h2_qst(4.3863e-07,
                    3.1813e-03 ,
                    5.5204e-02 )

# SLA-----
## my final model, used in ANOVA, uses a crossed pop x fam random effect because the nested pop/fam returns NAn in the ANOVA. Here, I'll use the nested version of the final model and use REML = T.
nested_sla <- glmmTMB(SLA ~ (1|Block) + (1|Population/Family) + City_dist,
                        data = sla_ldmc,
                        REML = T)
  
VarCorr(nested_sla)

Calc_h2_qst(1.2678e-03  ,
                    9.5834e-05  ,
                    1.1524e+01  )


# Latex-----
VarCorr(
  update(
    latex_mods_best_c[[1]], REML = T))

Calc_h2_qst(1.5491    ,
                    1.1931    ,
                    5.2429    )


# Herbivory: Early-----
VarCorr(
  update(
    herb_e_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    herb_e_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(5.5107e-05,
         9.2087e-06,
         resid_var)

# Herbivory: Late-----
VarCorr(
  update(
    herb_l_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    herb_l_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(2.4607e-01,
         2.4987e-05,
         resid_var)


# Weevil: Binomial-----
VarCorr(
  update(
    weev_bin_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    weev_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(0.54796923,
         0.00017582,
         resid_var)



# Weevil damage: quantitative-----
VarCorr(
  update(
    weev_quant_mods_best_c[[1]], REML = T))

Calc_h2_qst(0.13743  ,
                    0.07537 ,
                    0.60462  )

```
