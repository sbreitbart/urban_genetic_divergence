---
title: "Defense Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import data

```{r}
# SLA & LDMC-----
sla_ldmc <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_sla_ldmc_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.factor)

str(sla_ldmc)
sla_ldmc %<>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))


# LATEX-----
latex <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_latex_clean.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.character) %>%
    dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.factor) %T>%
  str()

latex %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))

str(latex)


# HERBIVORY-----
herbivory <- read.csv(here::here("./Joined_annual_data/herbivory.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

herbivory %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))

herbivory$Herbivory_mean_early_recode <- herbivory$Herbivory_mean_early
herbivory$Herbivory_mean_early_recode[herbivory$Herbivory_mean_early_recode == 1] <- 0.999999
herbivory$Herbivory_mean_early_recode[herbivory$Herbivory_mean_early_recode == 0] <- 0.000001

herbivory$Herbivory_mean_late_recode <- herbivory$Herbivory_mean_late
herbivory$Herbivory_mean_late_recode[herbivory$Herbivory_mean_late_recode == 1] <- 0.999999
herbivory$Herbivory_mean_late_recode[herbivory$Herbivory_mean_late_recode == 0] <- 0.000001


# WEEVIL DAMAGE-----
weevil <- read.csv(here::here("./Joined_annual_data/weevil.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

weevil %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))
```

## Import final models
### Create full list
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_Defense.Rmd", quiet=TRUE))

all_models <- list(
ldmc_mods          , # LDMC
sla_mods           , # SLA
latex_mods         , # Latex
herb_early_mods    , # Herbivory: before flowering
herb_late_mods     , # Herbivory: after flowering
weev_mods_binomial , # Weevil scar: binomial (part of hurdle models)
weev_mods_quant)     # Weevil scar: quantitative (part of hurdle models)

names(all_models) <- c(
"ldmc_mods"          ,
"sla_mods"           ,
"latex_mods"         ,
"herb_early_mods"    ,
"herb_late_mods"     ,
"weev_mods_binomial" ,
"weev_mods_quant")
```

### Create separate lists of best vs. alt models for city_dist vs urb_score
#### LDMC
```{r}
## Best
### City_dist
ldmc_mods_best_c <- ldmc_mods[c(1,4)]

### Urb_score
ldmc_mods_best_u <- ldmc_mods[c(2,6)]

## Alt
### City_dist
ldmc_mods_alt_c <- ldmc_mods[3]

### Urb_score
ldmc_mods_alt_u <- ldmc_mods[5]
```

#### SLA
```{r}
## Best
### City_dist
sla_mods_best_c <- sla_mods[c(1,4)]

### Urb_score
sla_mods_best_u <- sla_mods[c(2,6)]

## Alt
### City_dist
sla_mods_alt_c <- sla_mods[3]

### Urb_score
sla_mods_alt_u <- sla_mods[5]
```


#### Latex
```{r}
## Best
### City_dist
latex_mods_best_c <- latex_mods[c(1,4)]

### Urb_score
latex_mods_best_u <- latex_mods[c(2,5)]

## Alt
### City_dist
latex_mods_alt_c <- latex_mods[3]

### Urb_score- NONE

```


#### Herbivory- Early
```{r}
## Best
### City_dist
herb_e_mods_best_c <- herb_early_mods[c(1,3)]

### Urb_score
herb_e_mods_best_u <- herb_early_mods[c(2,6)]

## Alt
### City_dist
herb_e_mods_alt_c <- herb_early_mods[4]

### Urb_score
herb_e_mods_alt_u <- herb_early_mods[5]

```

#### Herbivory- Late
```{r}
## Best
### City_dist
herb_l_mods_best_c <- herb_late_mods[c(1,3)]

### Urb_score
herb_l_mods_best_u <- herb_late_mods[c(2,5)]

## Alt
### City_dist
herb_l_mods_alt_c <- herb_late_mods[4]

### Urb_score- NONE
```


#### Weevil- Binomial
```{r}
## Best
### City_dist
weev_bin_mods_best_c <- weev_mods_binomial[c(1,4)]

### Urb_score
weev_bin_mods_best_u <- weev_mods_binomial[c(2,6)]

## Alt
### City_dist
weev_bin_mods_alt_c <- weev_mods_binomial[3]

### Urb_score
weev_bin_mods_alt_u <- weev_mods_binomial[5]
```

#### Weevil- Quantitative
```{r}
## Best
### City_dist
weev_quant_mods_best_c <- weev_mods_quant[c(1,4)]

### Urb_score
weev_quant_mods_best_u <- weev_mods_quant[c(2,6)]

## Alt
### City_dist
weev_quant_mods_alt_c <- weev_mods_quant[3]

### Urb_score
weev_quant_mods_alt_u <- weev_mods_quant[5]
```


# Create ggpredict objects
## LDMC
### Gradient
```{r}
# city_dist
ldmc_mods_best_c[1]
ldmc_gradient_01_pred <- ggeffects::ggpredict(ldmc_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
ldmc_mods_best_u[1]
ldmc_gradient_02_pred <- ggeffects::ggpredict(ldmc_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}
# city_dist
ldmc_mods_best_c[2]
ldmc_urbsubs_01_pred <- ggeffects::ggpredict(ldmc_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
ldmc_mods_best_u[2]
ldmc_urbsubs_02_pred <- ggeffects::ggpredict(ldmc_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## SLA
### Gradient
```{r}
# city_dist
sla_mods_best_c[1]
sla_gradient_01_pred <- ggeffects::ggpredict(sla_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
sla_mods_best_u[1] # SQRT-TRANSFORMED
sla_gradient_02_pred <- ggeffects::ggpredict(sla_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
### NOTE: Model has sqrt-transformed response. Back-transforming predictions to original response scale. Standard errors are still on the sqrt-scale.

```

### Urban Subtransects
```{r}
# city_dist
sla_mods_best_c[2]# SQRT-TRANSFORMED
sla_urbsubs_01_pred <- ggeffects::ggpredict(sla_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()
### NOTE: Model has sqrt-transformed response. Back-transforming predictions to original response scale. Standard errors are still on the sqrt-scale.


# urb_score
sla_mods_best_u[2]# SQRT-TRANSFORMED
sla_urbsubs_02_pred <- ggeffects::ggpredict(sla_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
### NOTE: Model has sqrt-transformed response. Back-transforming predictions to original response scale. Standard errors are still on the sqrt-scale.
```

## Latex
### Gradient
```{r}
# city_dist
latex_mods_best_c[1]
latex_gradient_01_pred <- ggeffects::ggpredict(latex_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
latex_mods_best_u[1]
latex_gradient_02_pred <- ggeffects::ggpredict(latex_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
latex_mods_best_c[2]# SQRT-TRANSFORMED
latex_urbsubs_01_pred <- ggeffects::ggpredict(latex_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()
### NOTE: Model has sqrt-transformed response. Back-transforming predictions to original response scale. Standard errors are still on the sqrt-scale.


# urb_score
latex_mods_best_u[2]# SQRT-TRANSFORMED
latex_urbsubs_02_pred <- ggeffects::ggpredict(latex_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
### NOTE: Model has sqrt-transformed response. Back-transforming predictions to original response scale. Standard errors are still on the sqrt-scale.
```

## Herbivory- Early
### Gradient
```{r}
# city_dist
herb_e_mods_best_c[1] # CUBE ROOT-TRANSFORMED
herb_e_gradient_01_pred <- ggeffects::ggpredict(herb_e_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
herb_e_mods_best_u[1]# CUBE ROOT-TRANSFORMED
herb_e_gradient_02_pred <- ggeffects::ggpredict(herb_e_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist

# ggpredict can't interpret the cube root aspect transformation of response var, so I'll manually make new column in herbivory df, then recreate model, then use ggpredict on it

herbivory$Herbivory_mean_early_recode_cuberoot <- herbivory$Herbivory_mean_early_recode^(1/3)

herb_e_ggpred_mod1 <- glmmTMB(Herbivory_mean_early_recode_cuberoot  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
                                data = herbivory %>%
                                dplyr::filter(Transect_ID != "Rural"),
                                family = beta_family(link="logit"),
                                REML = F)



herb_e_mods_best_c[2] # CUBE ROOT-TRANSFORMED
herb_e_urbsubs_01_pred <- ggeffects::ggpredict(herb_e_ggpred_mod1,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
herb_e_ggpred_mod2 <- glmmTMB(Herbivory_mean_early_recode_cuberoot  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
                                data = herbivory %>%
                                dplyr::filter(Transect_ID != "Rural"),
                                family = beta_family(link="logit"),
                                REML = F)


herb_e_mods_best_u[2]# CUBE ROOT-TRANSFORMED
herb_e_urbsubs_02_pred <- ggeffects::ggpredict(herb_e_ggpred_mod2,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```

## Herbivory- Late
### Gradient
```{r}
# city_dist
herb_l_mods_best_c[1] # CUBE ROOT-TRANSFORMED
herb_l_gradient_01_pred <- ggeffects::ggpredict(herb_l_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
herb_l_mods_best_u[1] # CUBE ROOT-TRANSFORMED
herb_l_gradient_02_pred <- ggeffects::ggpredict(herb_l_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist

# ggpredict can't interpret the cube root aspect transformation of response var, so I'll manually make new column in herbivory df, then recreate model, then use ggpredict on it

herbivory$Herbivory_mean_late_recode_cuberoot <- herbivory$Herbivory_mean_late_recode^(1/3)

herb_l_ggpred_mod1 <- glmmTMB(Herbivory_mean_late_recode_cuberoot  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
                                data = herbivory %>%
                                dplyr::filter(Transect_ID != "Rural"),
                                family = beta_family(link="logit"),
                                REML = F)



herb_l_mods_best_c[2] # CUBE ROOT-TRANSFORMED
herb_l_urbsubs_01_pred <- ggeffects::ggpredict(herb_l_ggpred_mod1,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
herb_l_ggpred_mod2 <- glmmTMB(Herbivory_mean_late_recode_cuberoot  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
                                data = herbivory %>%
                                dplyr::filter(Transect_ID != "Rural"),
                                family = beta_family(link="logit"),
                                REML = F)


herb_l_mods_best_u[2]# CUBE ROOT-TRANSFORMED
herb_l_urbsubs_02_pred <- ggeffects::ggpredict(herb_l_ggpred_mod2,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Weevil damage- binary
### Gradient
```{r}
# city_dist
weev_bin_mods_best_c[1]
weev_b_gradient_01_pred <- ggeffects::ggpredict(weev_bin_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
weev_bin_mods_best_u[1]
weev_b_gradient_02_pred <- ggeffects::ggpredict(weev_bin_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
weev_bin_mods_best_c[2]
weev_bin_urbsubs_01_pred <- ggeffects::ggpredict(weev_bin_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
weev_bin_mods_best_u[2]
weev_bin_urbsubs_02_pred <- ggeffects::ggpredict(weev_bin_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Weevil damage- quantitative
### Gradient
```{r}
# city_dist
weev_quant_mods_best_c[1] # CUBE ROOT-TRANSFORMED
weev_q_gradient_01_pred <- ggeffects::ggpredict(weev_quant_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
weev_quant_mods_best_u[1] # CUBE ROOT-TRANSFORMED
weev_q_gradient_02_pred <- ggeffects::ggpredict(weev_quant_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist

# ggpredict can't interpret the cube root aspect transformation of response var, so I'll manually make new column in weevil df, then recreate model, then use ggpredict on it

weevil$Scar_length_cm_cuberoot <- weevil$Scar_length_cm^(1/3)

weev_quant_ggpred_mod1 <- glmmTMB(Scar_length_cm_cuberoot  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist + Transect_ID,
                                data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                                REML = F)



weev_quant_mods_best_c[2] # CUBE ROOT-TRANSFORMED
weev_quant_urbsubs_01_pred <- ggeffects::ggpredict(weev_quant_ggpred_mod1,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
weev_quant_ggpred_mod2 <- glmmTMB(Scar_length_cm_cuberoot  ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
                                data = weevil %>%
                                dplyr::filter(Scar_length_cm > 0 & Transect_ID != "Rural"),
                                REML = F)


weev_quant_mods_best_u[2]# CUBE ROOT-TRANSFORMED
weev_quant_urbsubs_02_pred <- ggeffects::ggpredict(weev_quant_ggpred_mod2,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

# Create plots
## first, create variable associated with replicated aesthetics of figs
```{r}
# Gradient figs
rep_geoms <- c(geom_smooth(aes(x = x,
                    y = predicted),
                color = "#66a182",
                size = 1,
                se = F),
    geom_ribbon(aes(x = x,
                    ymin = predicted - std.error,
                    ymax = predicted + std.error),
                fill = "#66a182",
                alpha = 0.3))

# Transect figs
rep_geoms2 <- c(geom_smooth(
  aes(
    x = x,
    y = predicted,
    color = group),
  size = 1,
  se = F),
  geom_ribbon(aes(
    x = x,
    ymin = predicted - std.error,
    ymax = predicted + std.error,
    fill = group),
    alpha = 0.3),
  scale_colour_brewer(labels = c("Corridor",
                                 "Non-Corridor"),
                      palette = "Set2"),
  scale_fill_brewer(labels = c("Corridor",
                               "Non-Corridor"),
                    palette = "Set2"))
```

## Gradient
### City_dist
```{r}
# LDMC-----
ggpred_Q1.citydist_ldmc <- 
ggplot(ldmc_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Leaf Dry Matter Content") +
  ylim(0.15, 0.18) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(ldmc_mods_best_c[[1]])$p)),
                size = 4.5)

ggpred_Q1.citydist_ldmc



# SLA-----
ggpred_Q1.citydist_sla <- ggplot(sla_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Specific Leaf Area "(cm^2/g))) +
  ylim(18, 26) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(sla_mods_best_c[[1]])$p)),
                size = 4.5)

ggpred_Q1.citydist_sla



# LATEX-----
ggpred_Q1.citydist_latex <- ggplot(latex_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Latex Exudation (mg)") +
  ylim(6, 10) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(latex_mods_best_c[[1]])$p)),
                size = 4.5)

ggpred_Q1.citydist_latex

# herbivory- early-----
ggpred_Q1.citydist_herb_e <- ggplot(herb_e_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Herbivory (Before Flowering) " ^{1/3})) +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(NA, 1))+
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(herb_e_mods_best_c[[1]])$p)),
                size = 4.5)

ggpred_Q1.citydist_herb_e


# herbivory- late-----
ggpred_Q1.citydist_herb_l <- ggplot(herb_l_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Herbivory (After Flowering) " ^{1/3})) +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(NA, 1))+
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(herb_l_mods_best_c[[1]])$p)),
                size = 4.5)

ggpred_Q1.citydist_herb_l


# weevil damage- binary-----
ggpred_Q1.citydist_weev_bin <- ggplot(weev_b_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Weevil Damage Outcome") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0, 1.2),
    breaks = c(0, .25, .5, .75, 1)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(weev_bin_mods_best_c[[1]])$p)),
                size = 4.5)

ggpred_Q1.citydist_weev_bin



# weevil damage- quantitative-----
ggpred_Q1.citydist_weev_quant <- ggplot(weev_q_gradient_01_pred) +
  rep_geoms +
  ylim(1.5, NA) +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Weevil Scar Length (cm) " ^{1/3})) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(weev_quant_mods_best_c[[1]])$p)),
                size = 4.5)

ggpred_Q1.citydist_weev_quant
```

### Urbanization Score
```{r}
# LDMC-----
ggpred_Q1.urbscore_ldmc <- 
ggplot(ldmc_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = "Leaf Dry Matter Content") +
  xlim(4, -4) +
  ylim(0.15, 0.18) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(ldmc_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.urbscore_ldmc



# SLA-----
ggpred_Q1.urbscore_sla <- ggplot(sla_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression("sqrt(Specific Leaf Area) "(cm^2/g))) +
  ylim(19.5, 21.5) +
    xlim(4, -4) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(sla_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.urbscore_sla



# LATEX-----
ggpred_Q1.urbscore_latex <- ggplot(latex_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = "Latex Exudation (mg)") +
    xlim(4, -4) +
  # ylim(6, 10) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(latex_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.urbscore_latex

# herbivory- early-----
ggpred_Q1.urbscore_herb_e <- ggplot(herb_e_gradient_02_pred) +
  rep_geoms +
    xlim(4, -4) +
  labs(x = "Urbanization Score",
       y = expression("Herbivory (Before Flowering) " ^{1/3})) +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(NA, 1))+
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_e_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.urbscore_herb_e


# herbivory- late-----
ggpred_Q1.urbscore_herb_l <- ggplot(herb_l_gradient_02_pred) +
  rep_geoms +
    xlim(4, -4) +
  labs(x = "Urbanization Score",
       y = expression("Herbivory (After Flowering) " ^{1/3})) +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(NA, 1))+
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_l_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.urbscore_herb_l


# weevil damage- binary-----
ggpred_Q1.urbscore_weev_bin <- ggplot(weev_b_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = "Weevil Damage Outcome") +
    xlim(4, -4) +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0, 1.15),
    breaks = c(0, .25, .50, .75, 1)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(weev_bin_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.urbscore_weev_bin



# weevil damage- quantitative-----
ggpred_Q1.urbscore_weev_quant <- ggplot(weev_q_gradient_02_pred) +
  rep_geoms +
  ylim(1.5, NA) +
    xlim(4, -4) +
  labs(x = "Urbanization Score",
       y = expression("Weevil Scar Length (cm) " ^{1/3})) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(weev_quant_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.urbscore_weev_quant
```

## Combine plots into one figure
### Gradient / City_dist
```{r}
gradient_citydist_plots <- ggarrange(
  ggpred_Q1.citydist_ldmc,
  ggpred_Q1.citydist_sla,
  ggpred_Q1.citydist_latex,
  ggpred_Q1.citydist_herb_e,
  ggpred_Q1.citydist_herb_l,
  ggpred_Q1.citydist_weev_bin,
  ggpred_Q1.citydist_weev_quant +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Defense_trait_analyses/Figures/Q1_grad_citydist_Defense.pdf"),
             width = 14, height = 7.5)
```


### Gradient / Urbanization Score
```{r}
gradient_urbscore_plots <- ggarrange(
  ggpred_Q1.urbscore_ldmc,
  ggpred_Q1.urbscore_sla,
  ggpred_Q1.urbscore_latex,
  ggpred_Q1.urbscore_herb_e,
  ggpred_Q1.urbscore_herb_l,
  ggpred_Q1.urbscore_weev_bin,
  ggpred_Q1.urbscore_weev_quant +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Defense_trait_analyses/Figures/Q1_grad_urbscore_Defense.pdf"),
             width = 14, height = 7.5)
```

## Urban Subtransects
### City_dist
```{r}
# LDMC-----
ggpred_Q2.citydist_ldmc <-
ggplot(ldmc_urbsubs_01_pred) +
  labs(x = "Distance to Urban Center (km)",
       y = "Leaf Dry Matter Content",
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 0.19) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.17,
                    label = paste0(" Distance: p = ", tidy_anova(ldmc_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Transect: p = ", tidy_anova(ldmc_mods_best_c[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.citydist_ldmc

# SLA-----
ggpred_Q2.citydist_sla <- 
ggplot(sla_urbsubs_01_pred) +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Specific Leaf Area "(cm^2/g)),
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 22) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.17,
                    label = paste0(" Distance: p = ", tidy_anova(sla_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Transect: p = ", tidy_anova(sla_mods_best_c[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.citydist_sla


# latex-----
ggpred_Q2.citydist_latex <- 
ggplot(latex_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Latex Exudation (g) "^{1/2}),
       color = "Transect",
       fill = "Transect") +
  ylim(6.25, 8.5) +
    xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.17,
                    label = paste0(" Distance: p = ", tidy_anova(latex_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Transect: p = ", tidy_anova(latex_mods_best_c[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.citydist_latex

# herbivory: Before flowering-----
ggpred_Q2.citydist_herb_e <- 
ggplot(herb_e_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Herbivory (Before Flowering) "^{1/3}),
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(NA, 1))+
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(herb_e_mods_best_c[[2]])$p[2])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(herb_e_mods_best_c[[2]])$p[3])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.79,
                    label = paste0(" D x T: p = ", tidy_anova(herb_e_mods_best_c[[2]])$p[4])),
                size = 4.5)

ggpred_Q2.citydist_herb_e

# herbivory: After flowering-----
ggpred_Q2.citydist_herb_l <- 
ggplot(herb_l_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Herbivory (After Flowering) "^{1/3}),
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(NA, 1))+
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(herb_l_mods_best_c[[2]])$p[2])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(herb_l_mods_best_c[[2]])$p[3])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.79,
                    label = paste0(" D x T: p = ", tidy_anova(herb_l_mods_best_c[[2]])$p[4])),
                size = 4.5)

ggpred_Q2.citydist_herb_l


# Weevil damage: Binary-----
ggpred_Q2.citydist_weev_bin <- 
ggplot(weev_bin_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = "Weevil Damage Outcome",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0, 1.2),
    breaks = c(0, .25, .5, .75, 1)
    ) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.17,
                    label = paste0(" Distance: p = ", tidy_anova(weev_bin_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Transect: p = ", tidy_anova(weev_bin_mods_best_c[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.citydist_weev_bin


# Weevil damage: Quantitative-----
ggpred_Q2.citydist_weev_quant <- 
ggplot(weev_quant_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Weevil Scar Length (cm)" ^{1/3}),
       color = "Transect",
       fill = "Transect") +
  ylim(1.4, 2) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.17,
                    label = paste0(" Distance: p = ", tidy_anova(weev_quant_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Transect: p = ", tidy_anova(weev_quant_mods_best_c[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.citydist_weev_quant

```

### Urbanization Score
```{r}

```

## Combine plots into one figure
### Urb Subtransects / City_dist
```{r}
urbsubs_citydist_plots <- ggarrange(
  ggpred_Q2.citydist_ldmc,
  ggpred_Q2.citydist_sla,
  ggpred_Q2.citydist_latex,
  ggpred_Q2.citydist_herb_e,
  ggpred_Q2.citydist_herb_l,
  ggpred_Q2.citydist_weev_bin,
  ggpred_Q2.citydist_weev_quant +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Defense_trait_analyses/Figures/Q2_urbsubs_citydist_Defense.pdf"),
             width = 14, height = 7.5)
```


### Urb Subtransects / Urbanization Score
```{r}
# gradient_urbscore_plots <- ggarrange(
#   ggpred_Q1.urbscore_ldmc,
#   ggpred_Q1.urbscore_sla,
#   ggpred_Q1.urbscore_latex,
#   ggpred_Q1.urbscore_herb_e,
#   ggpred_Q1.urbscore_herb_l,
#   ggpred_Q1.urbscore_weev_bin,
#   ggpred_Q1.urbscore_weev_quant +
#             font("x.text"),
#           ncol = 4,
#           nrow = 2,
#           align = "hv",
#           labels = list("A", "B", "C", "D", "E", "F", "G"),
#           font.label = (size =16),
#           common.legend = T,
#           legend = "top") %T>%
#   plot

dev.copy2pdf(file = here::here("./Defense_trait_analyses/Figures/Q2_urbsubs_urbscore_Defense.pdf"),
             width = 14, height = 7.5)
```

