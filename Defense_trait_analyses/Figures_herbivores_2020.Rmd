# Set up notebook
## Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("Defense_trait_analyses/Analysis_herbivores_2020.Rmd", quiet=TRUE))

```

# Create ggpredict objects
Only doing this for herbivores whose abundance was associated with urbanization and/or subtransect
## Monarchs
### Gradient
```{r}
# city_dist
monarch_gradient_01_pred <- ggeffects::ggpredict(monarch_mods[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
monarch_gradient_02_pred <- ggeffects::ggpredict(monarch_mods[[2]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}
# city_dist
monarch_urbsubs_01_pred <- ggeffects::ggpredict(monarch_mods[[4]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
monarch_urbsubs_02_pred <- ggeffects::ggpredict(monarch_mods[[6]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Labidomera clivicollis
### Gradient
```{r}
# city_dist
labidomera_gradient_01_pred <- ggeffects::ggpredict(labidomera_mods[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
labidomera_gradient_02_pred <- ggeffects::ggpredict(labidomera_mods[[2]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}
# city_dist
labidomera_urbsubs_01_pred <- ggeffects::ggpredict(labidomera_mods[[4]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
labidomera_urbsubs_02_pred <- ggeffects::ggpredict(labidomera_mods[[6]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Rhyssomatus lineaticollis
### Gradient
```{r}
# city_dist
rhyssomatus_gradient_01_pred <- ggeffects::ggpredict(rhyssomatus_mods[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
rhyssomatus_gradient_02_pred <- ggeffects::ggpredict(rhyssomatus_mods[[2]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}
# city_dist
rhyssomatus_urbsubs_01_pred <- ggeffects::ggpredict(rhyssomatus_mods[[4]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
rhyssomatus_urbsubs_02_pred <- ggeffects::ggpredict(rhyssomatus_mods[[6]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```


# Create plots
## first, create variable associated with replicated aesthetics of figs
```{r}
# Gradient figs
rep_geoms <- c(geom_smooth(aes(x = x,
                    y = predicted),
                color = "#66a182",
                size = 1,
                se = F),
    geom_ribbon(aes(x = x,
                    ymin = predicted - std.error,
                    ymax = predicted + std.error),
                fill = "#66a182",
                alpha = 0.3))

# Transect figs
rep_geoms2 <- c(geom_smooth(
  aes(
    x = x,
    y = predicted,
    color = group),
  size = 1,
  se = F),
  geom_ribbon(aes(
    x = x,
    ymin = predicted - std.error,
    ymax = predicted + std.error,
    fill = group),
    alpha = 0.3),
  scale_colour_brewer(labels = c("Corridor",
                                 "Non-Corridor"),
                      palette = "Set2"),
  scale_fill_brewer(labels = c("Corridor",
                               "Non-Corridor"),
                    palette = "Set2"))
```

## Import herbivore images
```{r}
monarch_img <- readPNG("Defense_trait_analyses/images/D_plexippus_phylopic.png") %>%
  rasterGrob(., interpolate=TRUE)

asclepiadis_img <- readPNG("Defense_trait_analyses/images/L_asclepiadis_phylopic.png") %>%
  rasterGrob(., interpolate=TRUE)

clivicollis_img <- readPNG("Defense_trait_analyses/images/L_clivicollis_phylopic.png") %>%
  rasterGrob(., interpolate=TRUE)
```


## Gradient
### City_dist
```{r}
# Monarch-----
ggpred_Q1.citydist_monarch <- 
ggplot(monarch_gradient_01_pred) +
  annotation_custom(monarch_img,
                    xmin=60, xmax=70,
                    ymin=0.7, ymax=0.9) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression(paste(italic(" Danaus plexippus"), " Abundance"))) +
  ylim(NA, 1) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05,
                                   npcy = 0.95,
                    label = paste0(" Distance: p = ", tidy_anova(monarch_mods[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )),
                size = 4.5)

ggpred_Q1.citydist_monarch



# L. clivicollis-----
ggpred_Q1.citydist_clivicollis <- 
ggplot(labidomera_gradient_01_pred) +
  annotation_custom(clivicollis_img,
                    xmin=60, xmax=70,
                    ymin=0.7, ymax=1) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression(paste(italic(" Liriomyza clivicollis"), "Abundance "))) +
  ylim(-1, 1) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(labidomera_mods[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )),
                size = 4.5)

ggpred_Q1.citydist_clivicollis

```

### Urbanization Score
```{r}
# Monarch-----
ggpred_Q1.usc_monarch <- 
ggplot(monarch_gradient_02_pred) +
  annotation_custom(monarch_img,
                    xmin=3, xmax=4,
                    ymin=0.7, ymax=0.9) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression(paste(italic(" Danaus plexippus"), " Abundance"))) +
  ylim(NA, 0.85) +
  xlim(4, -4) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05,
                                   npcy = 0.95,
                    label = paste0(" Urb. Score: p = ", tidy_anova(monarch_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.usc_monarch



# L. asclepiadis-----
ggpred_Q1.usc_asclepiadis <- 
ggplot(asclepiadis_gradient_02_pred) +
  annotation_custom(asclepiadis_img,
                    xmin=3, xmax=4,
                    ymin=2.7, ymax=3) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression(paste(italic(" Liriomyza asclepiadis"), "Abundance " ^{1/2}))) +
  ylim(1.5, 3) +
    xlim(4, -4) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(asclepiadis_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.usc_asclepiadis



# L. clivicollis-----
ggpred_Q1.usc_clivicollis <- 
ggplot(clivicollis_gradient_02_pred) +
  annotation_custom(clivicollis_img,
                    xmin=3, xmax=4,
                    ymin=0.7, ymax=1) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression(paste(italic(" Liriomyza clivicollis"), "Abundance " ^{1/2}))) +
  ylim(-1, 1) +
    xlim(4, -4) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(clivicollis_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.usc_clivicollis

```

## Urban Subtransects
### City_dist
```{r}
# Monarchs-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
monarch_urbsubs_01_pred$group <- factor(monarch_urbsubs_01_pred$group,
                                   levels(monarch_urbsubs_01_pred$group)[c(2,1)])
levels(monarch_urbsubs_01_pred$group)


ggpred_Q2.citydist_monarch <-
ggplot(monarch_urbsubs_01_pred) +
    annotation_custom(monarch_img,
                    xmin=28, xmax=32,
                    ymin=0.8, ymax=1) +
  labs(x = "Distance to Urban Center (km)",
       y = expression(paste(italic(" Danaus plexippus"), " Abundance")),
       color = "Transect",
       fill = "Transect") +
  ylim(-0.5, 1) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(monarch_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(monarch_mods_best_c[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.citydist_monarch

# L. asclepiadis-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
asclepiadis_urbsubs_01_pred$group <- factor(asclepiadis_urbsubs_01_pred$group,
                                   levels(asclepiadis_urbsubs_01_pred$group)[c(2,1)])
levels(asclepiadis_urbsubs_01_pred$group)


ggpred_Q2.citydist_asclepiadis <- 
ggplot(asclepiadis_urbsubs_01_pred) +
    annotation_custom(asclepiadis_img,
                    xmin=28, xmax=32,
                    ymin=2.7, ymax=3) +
  labs(x = "Distance to Urban Center (km)",
              y = expression(atop(paste(italic("Liriomyza asclepiadis")), "Abundance " ^{1/2})),
       color = "Transect",
       fill = "Transect") +
  ylim(1, 3) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(asclepiadis_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(asclepiadis_mods_best_c[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.citydist_asclepiadis


# L. clivicollis-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
clivicollis_urbsubs_01_pred$group <- factor(clivicollis_urbsubs_01_pred$group,
                                   levels(clivicollis_urbsubs_01_pred$group)[c(2,1)])
levels(clivicollis_urbsubs_01_pred$group)


ggpred_Q2.citydist_clivicollis <- 
ggplot(clivicollis_urbsubs_01_pred) +
      annotation_custom(clivicollis_img,
                    xmin=28, xmax=32,
                    ymin=0.8, ymax=1) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = expression(atop(paste("Probability of ", italic("Labidomera")), paste(italic("clivicollis "), "Presence"))),
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(NA, 1))+
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(clivicollis_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(clivicollis_mods_best_c[[2]])$p[2])),
                size = 4.5) 

ggpred_Q2.citydist_clivicollis

```

### Urbanization Score
```{r}
# Monarchs-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
monarch_urbsubs_02_pred$group <- factor(monarch_urbsubs_02_pred$group,
                                   levels(monarch_urbsubs_02_pred$group)[c(2,1)])
levels(monarch_urbsubs_02_pred$group)


ggpred_Q2.usc_monarch <-
ggplot(monarch_urbsubs_02_pred) +
    annotation_custom(monarch_img,
                    xmin=1, xmax=2,
                    ymin=0.8, ymax=1) +
  labs(x = "Urbanization Score",
       y = expression(paste(italic(" Danaus plexippus"), " Abundance")),
       color = "Transect",
       fill = "Transect") +
  ylim(-0.5, 1) +
  xlim(4, -2) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(monarch_mods_best_u[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(monarch_mods_best_u[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.usc_monarch

# L. asclepiadis-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
asclepiadis_urbsubs_02_pred$group <- factor(asclepiadis_urbsubs_02_pred$group,
                                   levels(asclepiadis_urbsubs_02_pred$group)[c(2,1)])
levels(asclepiadis_urbsubs_02_pred$group)


ggpred_Q2.usc_asclepiadis <- 
ggplot(asclepiadis_urbsubs_02_pred) +
    annotation_custom(asclepiadis_img,
                    xmin=1, xmax=2,
                    ymin=2.7, ymax=3) +
  labs(x = "Urbanization Score",
              y = expression(atop(paste(italic("Liriomyza asclepiadis")), "Abundance " ^{1/2})),
       color = "Transect",
       fill = "Transect") +
  ylim(1, 3) +
  xlim(4, -2) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(asclepiadis_mods_best_u[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(asclepiadis_mods_best_u[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.usc_asclepiadis


# L. clivicollis-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
clivicollis_urbsubs_02_pred$group <- factor(clivicollis_urbsubs_02_pred$group,
                                   levels(clivicollis_urbsubs_02_pred$group)[c(2,1)])
levels(clivicollis_urbsubs_02_pred$group)


ggpred_Q2.usc_clivicollis <- 
ggplot(clivicollis_urbsubs_02_pred) +
      annotation_custom(clivicollis_img,
                    xmin=1, xmax=2,
                    ymin=0.8, ymax=1) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = expression(atop(paste("Probability of ", italic("Labidomera")), paste(italic("clivicollis "), "Presence"))),
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(NA, 1))+
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(clivicollis_mods_best_u[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(clivicollis_mods_best_u[[2]])$p[2])),
                size = 4.5) 

ggpred_Q2.usc_clivicollis

```

## Combine plots into one figure
### Gradient / City_dist
```{r}
gradient_citydist_plots <- ggarrange(
  ggpred_Q1.citydist_monarch,
  ggpred_Q1.citydist_asclepiadis,
  ggpred_Q1.citydist_clivicollis +
            font("x.text"),
          ncol = 3,
          nrow = 1,
          align = "hv",
          labels = list("A", "B", "C"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Defense_trait_analyses/Figures/Q1_grad_citydist_herbivores.pdf"),
             width = 14, height = 4)
```


### Gradient / Urbanization Score
```{r}
gradient_urbscore_plots <- ggarrange(
  ggpred_Q2.usc_monarch,
  ggpred_Q2.usc_asclepiadis,
  ggpred_Q2.usc_clivicollis + 
            font("x.text"),
          ncol = 3,
          nrow = 1,
          align = "hv",
          labels = list("A", "B", "C"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Defense_trait_analyses/Figures/Q1_grad_urbscore_herbivores.pdf"),
             width = 14, height = 4)
```

### Urb Subtransects / City_dist
```{r}
urbsubs_citydist_plots <- ggarrange(
  ggpred_Q2.citydist_monarch,
  ggpred_Q2.citydist_asclepiadis,
  ggpred_Q2.citydist_clivicollis+
            font("x.text"),
          ncol = 3,
          nrow = 1,
          align = "hv",
          labels = list("A", "B", "C"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Defense_trait_analyses/Figures/Q2_urbsubs_citydist_herbivores.pdf"),
             width = 14, height = 4)
```


### Urb Subtransects / Urbanization Score
```{r}
urbsubs_urbscore_plots <- ggarrange(
  ggpred_Q2.urbsubs_ldmc,
  ggpred_Q2.urbsubs_sla,
  ggpred_Q2.urbsubs_latex +
            font("x.text"),
          ncol = 3,
          nrow = 1,
          align = "hv",
          labels = list("A", "B", "C"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Defense_trait_analyses/Figures/Q2_urbsubs_urbscore_herbivores.pdf"),
             width = 14, height = 4)
```

