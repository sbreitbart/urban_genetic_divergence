---
title: "Defense Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| Herbivory                   | X         | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Quantitative |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Binary       |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Specific Leaf Area          |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Dry Leaf Matter Content     |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Cardenolide Concentration   |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Latex Volume                |           | X         |           |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook

## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import data

```{r}
# SLA & LDMC-----
sla_ldmc <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_sla_ldmc_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.factor)

str(sla_ldmc)
sla_ldmc %<>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))


# LATEX-----
latex <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_latex_clean.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.character) %>%
    dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.factor) %T>%
  str()

latex %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))

str(latex)


# HERBIVORY-----
herbivory <- read.csv(here::here("./Joined_annual_data/herbivory.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

herbivory %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))



# WEEVIL DAMAGE-----
weevil <- read.csv(here::here("./Joined_annual_data/weevil.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

weevil %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))
```

## Import final models
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_Defense.Rmd", quiet=TRUE))

all_models <- list(
ldmc_mods          , # LDMC
sla_mods           , # SLA
latex_mods         , # Latex
herb_early_mods    , # Herbivory: before flowering
herb_late_mods     , # Herbivory: after flowering
weev_mods_binomial , # Weevil scar: binomial (part of hurdle models)
weev_mods_quant)     # Weevil scar: quantitative (part of hurdle models)

names(all_models) <- c(
"ldmc_mods"          ,
"sla_mods"           ,
"latex_mods"         ,
"herb_early_mods"    ,
"herb_late_mods"     ,
"weev_mods_binomial" ,
"weev_mods_quant")
```

# Anova
## Create functions
```{r}
# GOALS:
# 1. Perform car::Anova() on each model in list
#   -if it's got an interaction, do type III first
#     -if interaxn p-val < 0.1, retain that result
#     -else, move on to type II
# 2. Save anova table w/appropriate SS type as new item in trait's sublist


# function that IDs if there is >= 1 sig interaction in the type III anova
ID_intxn <- function(model){
  model.df <- broom.mixed::tidy(car::Anova(model, type = "III"))
  intxn.df <- model.df[grep(":", model.df$term), "p.value"]
  sig.intxns <- sum(intxn.df <= 0.1)
  return(sig.intxns)
}

# loop over list of lists to perform ID-intxn on all models
all_type3 <- lapply(all_models, lapply, ID_intxn)


# tidy anovas function
tidy_anova <- function(model){
      type.choice <- ifelse(ID_intxn(model) > 0,
                          3,
                          2)
  return(
    car::Anova(model, type = type.choice) %>%
      broom.mixed::tidy() %>%
      as.data.frame() %>%
      dplyr::mutate(Response = as.character(formula(model)[2]),
                    .before = term) %>%
      # dplyr::mutate(Model = paste(n(model)),
      #               .before = term) %>%
      dplyr::mutate(Sites = case_when(
        str_detect(as.character(formula(model)[3]), "Transect_ID") == TRUE ~ "Urban Only",
        str_detect(as.character(formula(model)[3]), "Transect_ID") == FALSE ~ "All"),
                    .before = term) %>%
      dplyr::mutate(Significance = case_when(p.value < 0.001 ~ "***",
                                             p.value < 0.01 ~ "**",
                                             p.value <= 0.05 ~ "*")) %>%
      # dplyr::mutate(., AIC = as.numeric(AIC(model))) %>%
      mutate_if(is.numeric, round, 3)      %>%
      dplyr::mutate(p.value = replace(p.value, Significance == "***", "<0.001"))  %>%
      dplyr::select(., -df) %>%
      dplyr::rename(., Chi_sq = statistic,
                    Predictor = term,
                    p = p.value) %>%
      unite("p", p:Significance, sep = "", na.rm = TRUE) %>%
      dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("City_dist"),
                replacement = c("Distance to City Center")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Urb_score"),
                replacement = c("Urbanization Score")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Transect_ID"),
                replacement = c("Subtransect")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c(":"),
                replacement = c(" x ")) %>%
    dplyr::mutate_if(.,
          is.character,
          str_replace_all,
          pattern = c("Year x Urbanization Score"),
          replacement = c("Urbanization Score x Year"))
  )}

# creates list of list of anova objects
all_anovas <- lapply(all_models, lapply, tidy_anova) %>%
  unlist(recursive = FALSE)

# creates list of list of BEST anova models
best_anovas <- all_anovas[-c(3,5,9, 11, 15, 21, 22, 27, 31, 33, 37, 39)]

# creates list of list of ALTERNATIVE anova models
alt_anovas <- all_anovas[c(3,5,9, 11, 15, 21, 22, 27, 31, 33, 37, 39)]



# Next, adapt this for this project. Take out ch1 vars, decide how I want output to look...
make_all_anovas_tidy <- function(anova_list){
  return(
    lapply(anova_list, tidy_anova) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join) %>%
    replace(., is.na(.), "-") %>%
      flextable::flextable() %>%
      flextable::autofit() %>%
      align(j = c(1, 3), align = "left", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "body") %>%
      align(j = c(2,4,5), align = "center", part = "header") %>%
      flextable::compose(i = 1, j = 4, part = "header",
              value = as_paragraph("Ï‡", as_sup("2"))) %>%
     flextable::compose(i = 1, j = 5, part = "header",
             value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body")
    )
  }

# filter best models, then do this for each trait?
make_all_anovas_tidy(ldmc_mods) 

```

### Herbivory- Early
#### Gradient
##### City_dist
```{r}
car::Anova(herbivory_gr_dist_m5)
# doesn't converge with all terms... 

r.squaredGLMM(herbivory_gr_dist_m5)
```

##### Urb_score
```{r}
car::Anova(ramets_gr_usc_m1)

r.squaredGLMM(ramets_gr_usc_m1)

```

#### Urban subtransects
##### City_dist
```{r}
car::Anova(ramets_urb_dist_m1)
# nothing sig

r.squaredGLMM(ramets_urb_dist_m1)


# just main effects
car::Anova(ramets_urb_dist_m2_ME)
# nothing sig

r.squaredGLMM(ramets_urb_dist_m2_ME)

AIC((ramets_urb_dist_m1),
    (ramets_urb_dist_m2_ME)) # better but <2 AIC from full model
```

##### Urb_score
```{r}
car::Anova(ramets_urb_usc_m1)
# nothing sig

r.squaredGLMM(ramets_urb_usc_m1)


# just main effects
car::Anova(ramets_urb_usc_m2_ME)
# nothing sig

r.squaredGLMM(ramets_urb_usc_m2_ME)

AIC((ramets_urb_usc_m1),
    (ramets_urb_usc_m2_ME)) # better but <2 AIC from full model
```





# ANOVA
## Gradient
### City_dist
```{r}

```

### Urb_score
```{r}

```

## Urban Subtransects
### City_dist
```{r}

```

### Urb_score
```{r}

```