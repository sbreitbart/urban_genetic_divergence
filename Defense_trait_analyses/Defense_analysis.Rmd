---
title: "Defense Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| Herbivory                   | X         | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Quantitative |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Binary       |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Specific Leaf Area          |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Dry Leaf Matter Content     |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Cardenolide Concentration   |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Latex Volume                |           | X         |           |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook

## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import data

```{r}
# SLA & LDMC-----
sla_ldmc <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_sla_ldmc_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.factor)

str(sla_ldmc)
sla_ldmc %<>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))


# LATEX-----
latex <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_latex_clean.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.character) %>%
    dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.factor) %T>%
  str()

latex %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))

str(latex)


# HERBIVORY-----
herbivory <- read.csv(here::here("./Joined_annual_data/herbivory.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

herbivory %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))



# WEEVIL DAMAGE-----
weevil <- read.csv(here::here("./Joined_annual_data/weevil.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

weevil %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))
```

## Import final models
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_Defense.Rmd", quiet=TRUE))

all_models <- list(
ldmc_mods          , # LDMC
sla_mods           , # SLA
latex_mods         , # Latex
herb_early_mods    , # Herbivory: before flowering
herb_late_mods     , # Herbivory: after flowering
weev_mods_binomial , # Weevil scar: binomial (part of hurdle models)
weev_mods_quant)     # Weevil scar: quantitative (part of hurdle models)

names(all_models) <- c(
"ldmc_mods"          ,
"sla_mods"           ,
"latex_mods"         ,
"herb_early_mods"    ,
"herb_late_mods"     ,
"weev_mods_binomial" ,
"weev_mods_quant")
```

## FIGURE OUT HOW TO STRUCTURE REST OF THIS
### Herbivory
#### Gradient
##### City_dist
```{r}
car::Anova(herbivory_gr_dist_m5)
# doesn't converge with all terms... 

r.squaredGLMM(herbivory_gr_dist_m5)
```

##### Urb_score
```{r}
car::Anova(ramets_gr_usc_m1)
# dist not significant

r.squaredGLMM(ramets_gr_usc_m1)

```

#### Urban subtransects
##### City_dist
```{r}
car::Anova(ramets_urb_dist_m1)
# nothing sig

r.squaredGLMM(ramets_urb_dist_m1)


# just main effects
car::Anova(ramets_urb_dist_m2_ME)
# nothing sig

r.squaredGLMM(ramets_urb_dist_m2_ME)

AIC((ramets_urb_dist_m1),
    (ramets_urb_dist_m2_ME)) # better but <2 AIC from full model
```

##### Urb_score
```{r}
car::Anova(ramets_urb_usc_m1)
# nothing sig

r.squaredGLMM(ramets_urb_usc_m1)


# just main effects
car::Anova(ramets_urb_usc_m2_ME)
# nothing sig

r.squaredGLMM(ramets_urb_usc_m2_ME)

AIC((ramets_urb_usc_m1),
    (ramets_urb_usc_m2_ME)) # better but <2 AIC from full model
```





# ANOVA
## Gradient
### City_dist
```{r}

```

### Urb_score
```{r}

```

## Urban Subtransects
### City_dist
```{r}

```

### Urb_score
```{r}

```