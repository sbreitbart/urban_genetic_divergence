---
title: "Defense Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| Herbivory: Before flowering |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Herbivory: After flowering  | X         | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Quantitative |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Weevil damage: Binary       |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+
| Specific Leaf Area          |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Dry Leaf Matter Content     |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Cardenolide Concentration   |           | X         |           |
+-----------------------------+-----------+-----------+-----------+
| Latex Volume                |           | X         |           |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import data

```{r}
# SLA & LDMC-----
sla_ldmc <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_sla_ldmc_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.factor)

str(sla_ldmc)
sla_ldmc %<>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))


# LATEX-----
latex <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_latex_clean.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.character) %>%
    dplyr::mutate_at(vars(c(1:7, 9:12, 15, 18, 21)), as.factor) %T>%
  str()

latex %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))

str(latex)


# HERBIVORY-----
herbivory <- read.csv(here::here("./Joined_annual_data/herbivory.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

herbivory %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))



# WEEVIL DAMAGE-----
weevil <- read.csv(here::here("./Joined_annual_data/weevil.csv")) %>%
  dplyr::select(-1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %T>%
  str()

weevil %<>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))
```

## Import final models
### Create full list
```{r}
source(knitr::purl("Defense_trait_analyses/Model_diagnostics_Defense.Rmd", quiet=TRUE))

all_models <- list(
ldmc_mods          , # LDMC
sla_mods           , # SLA
latex_mods         , # Latex
herb_early_mods    , # Herbivory: before flowering
herb_late_mods     , # Herbivory: after flowering
weev_mods_binomial , # Weevil scar: binomial (part of hurdle models)
weev_mods_quant)     # Weevil scar: quantitative (part of hurdle models)

names(all_models) <- c(
"ldmc_mods"          ,
"sla_mods"           ,
"latex_mods"         ,
"herb_early_mods"    ,
"herb_late_mods"     ,
"weev_mods_binomial" ,
"weev_mods_quant")
```

### Create separate lists of best vs. alt models for city_dist vs urb_score
#### LDMC
```{r}
## Best
### City_dist
ldmc_mods_best_c <- ldmc_mods[c(1,4)]

### Urb_score
ldmc_mods_best_u <- ldmc_mods[c(2,6)]

## Alt
### City_dist
ldmc_mods_alt_c <- ldmc_mods[3]

### Urb_score
ldmc_mods_alt_u <- ldmc_mods[5]
```

#### SLA
```{r}
## Best
### City_dist
sla_mods_best_c <- sla_mods[c(1,4)]

### Urb_score
sla_mods_best_u <- sla_mods[c(2,6)]

## Alt
### City_dist
sla_mods_alt_c <- sla_mods[3]

### Urb_score
sla_mods_alt_u <- sla_mods[5]
```


#### Latex
```{r}
## Best
### City_dist
latex_mods_best_c <- latex_mods[c(1,4)]

### Urb_score
latex_mods_best_u <- latex_mods[c(2,5)]

## Alt
### City_dist
latex_mods_alt_c <- latex_mods[3]

### Urb_score- NONE

```


#### Herbivory- Early
```{r}
## Best
### City_dist
herb_e_mods_best_c <- herb_early_mods[c(1,3)]

### Urb_score
herb_e_mods_best_u <- herb_early_mods[c(2,6)]

## Alt
### City_dist
herb_e_mods_alt_c <- herb_early_mods[4]

### Urb_score
herb_e_mods_alt_u <- herb_early_mods[5]

```

#### Herbivory- Late
```{r}
## Best
### City_dist
herb_l_mods_best_c <- herb_late_mods[c(1,3)]

### Urb_score
herb_l_mods_best_u <- herb_late_mods[c(2,5)]

## Alt
### City_dist
herb_l_mods_alt_c <- herb_late_mods[4]

### Urb_score- NONE
```


#### Weevil- Binomial
```{r}
## Best
### City_dist
weev_bin_mods_best_c <- weev_mods_binomial[c(1,4)]

### Urb_score
weev_bin_mods_best_u <- weev_mods_binomial[c(2,6)]

## Alt
### City_dist
weev_bin_mods_alt_c <- weev_mods_binomial[3]

### Urb_score
weev_bin_mods_alt_u <- weev_mods_binomial[5]
```

#### Weevil- Quantitative
```{r}
## Best
### City_dist
weev_quant_mods_best_c <- weev_mods_quant[c(1,4)]

### Urb_score
weev_quant_mods_best_u <- weev_mods_quant[c(2,6)]

## Alt
### City_dist
weev_quant_mods_alt_c <- weev_mods_quant[3]

### Urb_score
weev_quant_mods_alt_u <- weev_mods_quant[5]
```


# Anova
## Create functions
```{r}
# GOALS:
# 1. Perform car::Anova() on each model in list
#   -if it's got an interaction, do type III first
#     -if interaxn p-val < 0.1, retain that result
#     -else, move on to type II
# 2. Save anova table w/appropriate SS type as new item in trait's sublist


# function that IDs if there is >= 1 sig interaction in the type III anova
ID_intxn <- function(model){
  model.df <- broom.mixed::tidy(car::Anova(model, type = "III"))
  intxn.df <- model.df[grep(":", model.df$term), "p.value"]
  sig.intxns <- sum(intxn.df <= 0.1)
  return(sig.intxns)
}

# loop over list of lists to perform ID-intxn on all models
# all_type3 <- lapply(all_models, lapply, ID_intxn)


# tidy anovas function
tidy_anova <- function(model){
      type.choice <- ifelse(ID_intxn(model) > 0,
                          3,
                          2)
  return(
    car::Anova(model, type = type.choice) %>%
      broom.mixed::tidy() %>%
      as.data.frame() %>%
      dplyr::mutate(Response = as.character(formula(model)[2]),
                    .before = term) %>%
      # dplyr::mutate(Model = paste(n(model)),
      #               .before = term) %>%
      dplyr::mutate(Sites = case_when(
        str_detect(as.character(formula(model)[3]), "Transect_ID") == TRUE ~ "Urban Only",
        str_detect(as.character(formula(model)[3]), "Transect_ID") == FALSE ~ "All"),
                    .before = term) %>%
      dplyr::mutate(Significance = case_when(p.value < 0.001 ~ "***",
                                             p.value < 0.01 ~ "**",
                                             p.value <= 0.05 ~ "*")) %>%
      # dplyr::mutate(., AIC = as.numeric(AIC(model))) %>%
      mutate_if(is.numeric, round, 3)      %>%
      dplyr::mutate(p.value = replace(p.value, Significance == "***", "<0.001"))  %>%
      dplyr::select(., -df) %>%
      dplyr::rename(., Chi_sq = statistic,
                    Predictor = term,
                    p = p.value) %>%
      unite("p", p:Significance, sep = "", na.rm = TRUE) %>%
      dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("City_dist"),
                replacement = c("Distance to City Center")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Urb_score"),
                replacement = c("Urbanization Score")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c("Transect_ID"),
                replacement = c("Subtransect")) %>%
        dplyr::mutate_if(.,
                is.character,
                str_replace_all,
                pattern = c(":"),
                replacement = c(" x ")) %>%
    dplyr::mutate_if(.,
          is.character,
          str_replace_all,
          pattern = c("Year x Urbanization Score"),
          replacement = c("Urbanization Score x Year"))
  )}

# # creates list of list of anova objects
# all_anovas <- lapply(all_models, lapply, tidy_anova) %>%
#   unlist(recursive = FALSE)
# 
# # creates list of list of BEST anova models
# best_anovas <- all_anovas[-c(3,5,9, 11, 15, 21, 22, 27, 31, 33, 37, 39)]
# 
# # creates list of list of ALTERNATIVE anova models
# alt_anovas <- all_anovas[c(3,5,9, 11, 15, 21, 22, 27, 31, 33, 37, 39)]



# Next, create best and alt models for individual lists of traits, then do this for the city_dist models, then urb_score models... put underlines in to separate Qs... export!
make_all_anovas_tidy <- function(anova_list){
  return(
    lapply(anova_list, tidy_anova) %>%
    lapply(., as.data.frame) %>%
    purrr::reduce(full_join) %>%
    replace(., is.na(.), "-") %>%
    dplyr::filter(Predictor != "(Intercept)") %>%
      flextable::flextable() %>% 
      merge_v(j = "Response") %>% 
      merge_v(j = "Sites") %>% 
      valign(valign = "top")%>%
      flextable::autofit() %>%
      align(j = c(1, 3), align = "left", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "header") %>%
      flextable::compose(i = 1, j = 4, part = "header",
              value = as_paragraph("χ", as_sup("2"))) %>%
     flextable::compose(i = 1, j = 5, part = "header",
             value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
      #theme_booktabs()%>%
      flextable::hline(i = 1, part = "body",
        border = officer::fp_border(color = "#666666",
                                    width = 1.5) )
    %>% fix_border_issues()
    
    )
  }

# filter best models, then do this for each trait?
make_all_anovas_tidy(ldmc_mods_best_c) 

```

## LDMC
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(ldmc_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/LDMC_citydist.png"))

lapply(ldmc_mods_best_c, MuMIn::r.squaredGLMM)

```

#### Urb_score
```{r}
make_all_anovas_tidy(ldmc_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/LDMC_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy(ldmc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/LDMC_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(ldmc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/LDMC_urbscore_alt.png"))
```
## SLA
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(sla_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/sla_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(sla_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/sla_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy(sla_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/sla_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(sla_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/sla_urbscore_alt.png"))
```
## Latex
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(latex_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/latex_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(latex_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/latex_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy(latex_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/latex_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```
## Herbivory- Early
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(herb_e_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(herb_e_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_e_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy(herb_e_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(herb_e_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_e_urbscore_alt.png"))
```

## Herbivory- Late
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(herb_l_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(herb_l_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/herb_l_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy(herb_l_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/herb_l_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```


## Weevil Scar- Binomial
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(weev_bin_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_bin_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(weev_bin_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_bin_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy(weev_bin_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_bin_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(weev_bin_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_bin_urbscore_alt.png"))
```


## Weevil Scar- Quantitative
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(weev_quant_mods_best_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_quant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(weev_quant_mods_best_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Best_models/weev_quant_urbscore.png"))
```

### Alt Models
#### City_dist
```{r}
make_all_anovas_tidy(weev_quant_mods_alt_c) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_quant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(weev_quant_mods_alt_u) %>%
  save_as_image(., path = here::here("./Defense_trait_analyses/Figures/ANOVA/Alt_models/weev_quant_urbscore_alt.png"))
```


# R-squared values
```{r}
# took out lists 4 and 5 from all_models- the herbivory ones- because R.squaredGLMM can't intake models with beta family
all_rsq <- lapply(all_models[-c(4:5)], lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

# super low marginal R2 values. Some conditional R2 are higher (some ~0.15) but most low
```


# Ranova
```{r}

```

