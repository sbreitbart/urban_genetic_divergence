# Set up notebook
## Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
library(mvabund)
library(purrr)
```
# First attempt- NOT accounting for pseudoreplication
```{r}
# USED THIS DATASET WITH FIRST RUN-THROUGH
herbivores <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_herbivores_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  mutate(Population = factor(Population),
         Family = factor(Family),
         Block = factor(Block))

```
Using this site's tutorial: https://environmentalcomputing.net/statistics/mvabund/

Your data should be formatted so that each sample is a row and each variable is a column.
```{r}
# Use the just the abundance data (in columns 5 to 11) and convert it to an mvabund object format used by the mvabund package.
Herb_spp <- mvabund(herbivores[, c(10, 12:20)])


# look at the spread of our data
par(mar = c(2, 10, 2, 2)) # adjusts the margins
boxplot(herbivores[, c(10, 12:20)],
        horizontal = TRUE,
        las = 2,
        main = "Abundance")

# It looks like some species of herbivores are much more abundant and variable than others. It’s probably a good idea to check our mean-variance relationship then! We can do this using the meanvar.plot function:
meanvar.plot(Herb_spp)

# the species with high means (on the x axis) also have high variances (y axis).
# We can deal with this relationship by choosing a family of GLMs with an appropriate mean-variance assumption. The default family used by mvabund when fitting multivariate GLMs is negative binomial which assumes a quadratic mean-variance relationship and a log-linear relationship between the response variables and any continuous variables. In [the site's] example, we only have categorical variables so that one’s not too important. If you are unsure of these relationships, don’t worry, we can check our model fit later. [I have quantitative variables too]

# There is a ‘quick and dirty’ built-in plotting function in the mvabund package that allows us to contrast transformed abundances to the predictor variables of our choice. To contrast abundances against urban-rural habitat, we would use:

plot(Herb_spp ~ as.factor(herbivores$Urb_Rur),
     cex.axis = 0.8,
     cex = 0.8)
# at first glance, there don't seem to be any glaring differences in abundance depending on urban/rural habitat type

# Let’s now contrast the species composition across urb/rural habitat type to see if the models support our observations.
# The model syntax below fits our response variable (the mvabund object Herb_spp with the counts of 9 species) to the predictor variable Habitat (urban/rural classification).

mod1 <- manyglm(Herb_spp ~ herbivores$Urb_Rur,
                family = "poisson")

# Before we examine the output, we need to check our model assumptions. We can use the plot function to generate a plot of residuals.

plot(mod1)
# If the model is a good fit, we should see a random scatter of points.
# Looks like it to me.

# We can test the multivariate hypothesis of whether species composition varied across the habitats by using the anova function. This gives an analysis of deviance table where we use likelihood ratio tests and resampled p values to look for a significant effect of Habitat on the community data.

anova(mod1)

# OUTPUT: Analysis of Deviance Table
# Model: Herb_spp ~ herbivores$Urb_Rur
# 
# Multivariate test:
#                    Res.Df Df.diff  Dev Pr(>Dev)    
# (Intercept)          1682                          
# herbivores$Urb_Rur   1681       1 5585    0.001 ***
# ---
# Signif. codes:  
# 0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Arguments:
#  Test statistics calculated assuming uncorrelated response (for faster computation) 
#  P-value calculated using 999 iterations via PIT-trap resampling.


# We can see from this table that there is a significant effect of Urban vs. rural habitat (LRT = 5585, P = 0.001), meaning that the species composition of herbivores clearly differs between the urban/rural classification of population they were sourced from.
# 
# To examine this further, and see which herbivore species are more likely to be found in which habitat type, we can run univariate tests for each species separately.
# 
# This is done by using the p.uni="adjusted" argument in the anova function. The “adjusted” part of the argument refers to the resampling method used to compute the p values, taking into account the correlation between the response variables. This correlation is often found in ecological systems where different species will interact with each other, competing with or facilitating each others’ resource use.

anova(mod1, p.uni = "adjusted")

# Analysis of Deviance Table
# 
# Model: Herb_spp ~ herbivores$Urb_Rur
# 
# Multivariate test:
#                    Res.Df Df.diff  Dev Pr(>Dev)    
# (Intercept)          1682                          
# herbivores$Urb_Rur   1681       1 5585    0.001 ***
# ---
# Signif. codes:  
# 0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Univariate Tests:
#                    Monarch_Quantity_Observed         
#                                          Dev Pr(>Dev)
# (Intercept)                                          
# herbivores$Urb_Rur                     3.969    0.335
#                    Tetraopes_tetropthalmus         
#                                        Dev Pr(>Dev)
# (Intercept)                                        
# herbivores$Urb_Rur                   5.383    0.236
#                    Liriomyza_asclepiadis         
#                                      Dev Pr(>Dev)
# (Intercept)                                      
# herbivores$Urb_Rur                 0.066    0.930
#                    Aphis_nerii          Aphis_asclepiadis
#                            Dev Pr(>Dev)               Dev
# (Intercept)                                              
# herbivores$Urb_Rur    4623.798    0.001            279.81
#                             Myzocallis_asclepiadis
#                    Pr(>Dev)                    Dev
# (Intercept)                                       
# herbivores$Urb_Rur    0.001                480.434
#                             Euchaetes_egle         
#                    Pr(>Dev)            Dev Pr(>Dev)
# (Intercept)                                        
# herbivores$Urb_Rur    0.001        190.794    0.001
#                    Lygaeus_kalmii         
#                               Dev Pr(>Dev)
# (Intercept)                               
# herbivores$Urb_Rur          0.054    0.930
#                    Labidomera_clivicollis         
#                                       Dev Pr(>Dev)
# (Intercept)                                       
# herbivores$Urb_Rur                  0.741    0.804
#                    Rhyssomatus_lineaticollis         
#                                          Dev Pr(>Dev)
# (Intercept)                                          
# herbivores$Urb_Rur                     0.166    0.930
# Arguments:
#  Test statistics calculated assuming uncorrelated response (for faster computation) 
# P-value calculated using 999 iterations via PIT-trap resampling.


# after adjusting for multiple testing, there is an effect of habitat on Lygaeus kalmii only.

```

# Second attempt: Using population means
Because mvabund (specifically, manyglm) can't handle random effects and ultimately my nested study design.
## Import data (includes 2020-2021)
```{r}
herbivores <- read.csv(here::here("./Joined_annual_data/herbivores.csv")) %>%
  dplyr::select(., -1) %>%
  dplyr::mutate_at(vars(c("Population",
                          "Family",
                          "Replicate",
                          "Block",
                          "Transect_ID",
                          "Sample",
                          "Patch_ID",
                          "Urb_Rur",
                          "Year",
                          "Surveyor",
                          "Date")),
                   as.character) %>%
    dplyr::mutate_at(vars(c("Population",
                            "Family",
                            "Replicate",
                            "Block",
                            "Transect_ID",
                            "Sample",
                            "Patch_ID",
                            "Urb_Rur",
                            "Year",
                            "Surveyor",
                          "Date")),
                     as.factor)
```

## Generate BLUPs for each herbivore
### Make function that generates BLUP df from linear mixed model
```{r}
create_BLUP <- function(linear_mixed_mod){
   ranef(
  linear_mixed_mod
)$cond$Population %>%
  tibble::rownames_to_column("Population") %>%
  dplyr::rename(estimate = 2) %>%
  left_join(., herbivores %>% # add city_dist and other variables
              dplyr::select(c(Population,
                            Transect_ID,
                            City_dist,
                            Urb_score)
                            ) %>%
              dplyr::group_by(Population) %>%
              dplyr::summarise(Population  = first(Population),
                               Transect_ID = first(Transect_ID),
                               City_dist   = first(City_dist),
                               Urb_score   = first(Urb_score)))
}
```

### Create BLUP vectors for each herbivore
### Monarchs
```{r}
# Create model and check diagnostics
monarch_mod <- glmmTMB(Monarch_Quantity_Observed ~
                                Block +
                                (1|Population/Family) +
                                Year +
                                Sample,
              data = herbivores,
              family = nbinom2(),
              REML = F)

plot(DHARMa::simulateResiduals(monarch_mod))


# Create BLUP df
monarch_BLUP <- create_BLUP(monarch_mod) %>%
  dplyr::rename(monarch = 2)

```

### Tetraopes_tetropthalmus
```{r}
# Create model and check diagnostics
tetra_mod <- glmmTMB(Tetraopes_tetropthalmus ~
                                Block +
                                (1|Population/Family) +
                                # Year +
                                Sample,
              data = herbivores,
              family = nbinom2(),
              REML = F)

plot(DHARMa::simulateResiduals(tetra_mod))


# Create BLUP df
tetra_BLUP <- create_BLUP(tetra_mod) %>%
  dplyr::rename(tetraopes = 2)

```


### Liriomyza_asclepiadis
```{r}
# Create model and check diagnostics
lirio_mod <- glmmTMB(Liriomyza_asclepiadis ~
                                Block +
                                (1|Population/Family) +
                                Year +
                                Sample,
              data = herbivores,
              family = nbinom1(),
              REML = F)

plot(DHARMa::simulateResiduals(lirio_mod)) # looks good enough


# Create BLUP df
lirio_BLUP <- create_BLUP(lirio_mod)%>%
  dplyr::rename(liriomyza = 2)

```

### Aphis_nerii 
```{r}
# Create model and check diagnostics
nerii_mod <- glmmTMB(Aphis_nerii ~
                                Block +
                                (1|Population/Family) +
                                # Year +
                                Sample,
              data = herbivores,
              family = nbinom2(),
              REML = F)

plot(DHARMa::simulateResiduals(nerii_mod)) # looks good enough


# Create BLUP df
nerii_BLUP <- create_BLUP(nerii_mod)%>%
  dplyr::rename(aphis_nerii = 2)

```

### Aphis_asclepiadis 
```{r}
# Create model and check diagnostics
aascl_mod <- glmmTMB(Aphis_asclepiadis ~
                                Block +
                                (1|Population/Family) +
                                # Year +
                                Sample,
              data = herbivores,
              family = nbinom2(),
              REML = F)

plot(DHARMa::simulateResiduals(aascl_mod)) # looks good enough


# Create BLUP df
aascl_BLUP <- create_BLUP(aascl_mod)%>%
  dplyr::rename(aphis_ascl = 2)

```

### Myzocallis_asclepiadis 
```{r}
# Create model and check diagnostics
masclep_mod <- glmmTMB(Myzocallis_asclepiadis ~
                                Block +
                                (1|Population/Family) +
                                # Year +
                                Sample,
              data = herbivores,
              family = nbinom1(),
              REML = F)

plot(DHARMa::simulateResiduals(masclep_mod)) # looks good enough


# Create BLUP df
masclep_BLUP <- create_BLUP(masclep_mod)%>%
  dplyr::rename(myzocallis = 2)

```



### Euchaetes_egle 
```{r}
# Create model and check diagnostics
euchae_mod <- glmmTMB(Euchaetes_egle ~
                                Block +
                                (1|Population/Family) +
                                # Year +
                                Sample,
              data = herbivores,
              family = nbinom1(),
              REML = F)

plot(DHARMa::simulateResiduals(euchae_mod)) # looks good enough


# Create BLUP df
euchae_BLUP <- create_BLUP(euchae_mod)%>%
  dplyr::rename(euchaetes = 2)

```

### Lygaeus_kalmii
```{r}
# Create model and check diagnostics
lygae_mod <- glmmTMB(Lygaeus_kalmii ~
                                Block +
                                (1|Population/Family) +
                                # Year +
                                Sample,
              data = herbivores,
              family = nbinom2(),
              REML = F)

plot(DHARMa::simulateResiduals(lygae_mod)) # looks good enough


# Create BLUP df
lygae_BLUP <- create_BLUP(lygae_mod)%>%
  dplyr::rename(lygaeus = 2)

```

### Labidomera_clivicollis
```{r}
# Create model and check diagnostics
labid_mod <- glmmTMB(Labidomera_clivicollis ~
                                Block +
                                (1|Population/Family) +
                                Year +
                                Sample,
              data = herbivores,
              family = nbinom2(),
              REML = F)

plot(DHARMa::simulateResiduals(labid_mod))


# Create BLUP df
labid_BLUP <- create_BLUP(labid_mod)%>%
  dplyr::rename(labidomera = 2)

```

### Rhyssomatus_lineaticollis 
```{r}
# Create model and check diagnostics
rhyss_mod <- glmmTMB(Rhyssomatus_lineaticollis ~
                                Block +
                                (1|Population/Family) +
                                # Year +
                                Sample,
              data = herbivores,
              family = nbinom2(),
              REML = F)

plot(DHARMa::simulateResiduals(rhyss_mod)) # looks good enough


# Create BLUP df
rhyss_BLUP <- create_BLUP(rhyss_mod)%>%
  dplyr::rename(rhyssomatus = 2)

```

### Merge into single df
```{r}
all_herbs <- purrr::reduce(list(monarch_BLUP,
                       tetra_BLUP,
                       lirio_BLUP,
                       nerii_BLUP,
                       aascl_BLUP,
                       masclep_BLUP,
                       euchae_BLUP,
                       lygae_BLUP,
                       labid_BLUP,
                       rhyss_BLUP),
              dplyr::left_join,
              by = c('Population',
                     'Transect_ID',
                     'City_dist',
                     'Urb_score'))

# add new col converting transect into urb/rural classes
all_herbs %<>%
  dplyr::mutate(Urb_Rur = case_when(
    Transect_ID == "Rural" ~ "Rural",
    TRUE ~ "Urban"
  ))
```

## Use mvabund with POISSON family (wrong, I think, because these BLUPs aren't counts anymore)
Your data should be formatted so that each sample is a row and each variable is a column.
```{r}
# Use the just the abundance data (in columns 5 to 11) and convert it to an mvabund object format used by the mvabund package.
Herb_spp2 <- mvabund(all_herbs[, c(2, 6:14)])


# look at the spread of our data
par(mar = c(2, 10, 2, 2)) # adjusts the margins
boxplot(all_herbs[, c(2, 6:14)],
        horizontal = TRUE,
        las = 2,
        main = "Abundance")

# It looks like some species of herbivores are much more abundant and variable than others. It’s probably a good idea to check our mean-variance relationship then! We can do this using the meanvar.plot function:
meanvar.plot(Herb_spp2)

# the species with high means (on the x axis) also have high variances (y axis).
# We can deal with this relationship by choosing a family of GLMs with an appropriate mean-variance assumption. The default family used by mvabund when fitting multivariate GLMs is negative binomial which assumes a quadratic mean-variance relationship and a log-linear relationship between the response variables and any continuous variables. In [the site's] example, we only have categorical variables so that one’s not too important. If you are unsure of these relationships, don’t worry, we can check our model fit later. [I have quantitative variables too]

# There is a ‘quick and dirty’ built-in plotting function in the mvabund package that allows us to contrast transformed abundances to the predictor variables of our choice. To contrast abundances against urban-rural habitat, we would use:

plot(Herb_spp2 ~ as.factor(all_herbs$Urb_Rur),
     cex.axis = 0.8,
     cex = 0.8)
# THIS DOESN'T WORK B/C OF NEGATIVE VALUES

# Let’s now contrast the species composition across urb/rural habitat type to see if the models support our observations.
# The model syntax below fits our response variable (the mvabund object Herb_spp with the counts of 9 species) to the predictor variable Habitat (urban/rural classification).

mod1 <- manyglm(Herb_spp2 ~ all_herbs$Urb_Rur,
                family = "poisson")

# Before we examine the output, we need to check our model assumptions. We can use the plot function to generate a plot of residuals.

plot(mod1)
# If the model is a good fit, we should see a random scatter of points.
# Looks like it to me.

# We can test the multivariate hypothesis of whether species composition varied across the habitats by using the anova function. This gives an analysis of deviance table where we use likelihood ratio tests and resampled p values to look for a significant effect of Habitat on the community data.

anova(mod1)

# OUTPUT: Analysis of Deviance Table
# 
# Model: Herb_spp2 ~ all_herbs$Urb_Rur
# 
# Multivariate test:
#                   Res.Df Df.diff   Dev Pr(>Dev)  
# (Intercept)           50                         
# all_herbs$Urb_Rur     49       1 4.794    0.057 .
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Arguments:
#  Test statistics calculated assuming uncorrelated response (for faster computation) 
#  P-value calculated using 999 iterations via PIT-trap resampling.


# We can see from this table that there is a MARGINALLY significant effect of Urban vs. rural habitat (LRT = 4.794, P = 0.057), meaning that the species composition of herbivores weakly differs between the urban/rural classification of population they were sourced from.
# 
# To examine this further, and see which herbivore species are more likely to be found in which habitat type, we can run univariate tests for each species separately.
# 
# This is done by using the p.uni="adjusted" argument in the anova function. The “adjusted” part of the argument refers to the resampling method used to compute the p values, taking into account the correlation between the response variables. This correlation is often found in ecological systems where different species will interact with each other, competing with or facilitating each others’ resource use.

anova_blup <- anova(mod1, p.uni = "adjusted") %T>%
  print()

# Analysis of Deviance Table
# 
# Model: Herb_spp2 ~ all_herbs$Urb_Rur
# 
# Multivariate test:
#                   Res.Df Df.diff   Dev Pr(>Dev)  
# (Intercept)           50                         
# all_herbs$Urb_Rur     49       1 4.794    0.042 *
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Univariate Tests:
#                   monarch          tetraopes          liriomyza
#                       Dev Pr(>Dev)       Dev Pr(>Dev)       Dev
# (Intercept)                                                    
# all_herbs$Urb_Rur   0.084    0.481         0    1.000     0.023
#                            aphis_nerii          aphis_ascl
#                   Pr(>Dev)         Dev Pr(>Dev)        Dev
# (Intercept)                                               
# all_herbs$Urb_Rur    0.481           0    1.000          0
#                            myzocallis          euchaetes         
#                   Pr(>Dev)        Dev Pr(>Dev)       Dev Pr(>Dev)
# (Intercept)                                                      
# all_herbs$Urb_Rur    1.000      3.366    0.100     0.444    0.481
#                   lygaeus          labidomera         
#                       Dev Pr(>Dev)        Dev Pr(>Dev)
# (Intercept)                                           
# all_herbs$Urb_Rur       0    1.000      0.228    0.481
#                   rhyssomatus         
#                           Dev Pr(>Dev)
# (Intercept)                           
# all_herbs$Urb_Rur       0.649    0.481
# Arguments:
#  Test statistics calculated assuming uncorrelated response (for faster computation) 
# P-value calculated using 999 iterations via PIT-trap resampling.


# after adjusting for multiple testing, there is still a marginally significant effect of habitat on all herbivores, but not significant effects on any specific herbivore.


# use city_dist as habitat descriptor
anova_blup2 <- manyglm(Herb_spp2 ~ all_herbs$City_dist,
                       family = "poisson") %>%
  anova() %T>%
  print()

manyglm(Herb_spp2 ~ all_herbs$City_dist,
                       family = "poisson") %>%
  summary() 

# Analysis of Deviance Table
# 
# Model: Herb_spp2 ~ all_herbs$City_dist
# 
# Multivariate test:
#                     Res.Df Df.diff  Dev Pr(>Dev)  
# (Intercept)             50                        
# all_herbs$City_dist     49       1 7.47    0.013 *
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# Arguments:
#  Test statistics calculated assuming uncorrelated response (for faster computation) 
#  P-value calculated using 999 iterations via PIT-trap resampling.


# So there is an effect of distance from the urban center on herbivore abundances?
```


## Use mvabund with gaussian family
```{r}
# Use the just the abundance data (in columns 5 to 11) and convert it to an mvabund object format used by the mvabund package.
Herb_spp2 <- mvabund(all_herbs[-36, c(2, 6:14)]) # row 36 has NAs


# look at the spread of our data
par(mar = c(2, 10, 2, 2)) # adjusts the margins
boxplot(all_herbs[, c(2, 6:14)],
        horizontal = TRUE,
        las = 2,
        main = "Abundance")

# It looks like some species of herbivores are much more abundant and variable than others. It’s probably a good idea to check our mean-variance relationship then! We can do this using the meanvar.plot function:
meanvar.plot(Herb_spp2)

# the species with high means (on the x axis) also have high variances (y axis).
# We can deal with this relationship by choosing a family of GLMs with an appropriate mean-variance assumption. The default family used by mvabund when fitting multivariate GLMs is negative binomial which assumes a quadratic mean-variance relationship and a log-linear relationship between the response variables and any continuous variables. In [the site's] example, we only have categorical variables so that one’s not too important. If you are unsure of these relationships, don’t worry, we can check our model fit later. [I have quantitative variables too]

# There is a ‘quick and dirty’ built-in plotting function in the mvabund package that allows us to contrast transformed abundances to the predictor variables of our choice. To contrast abundances against urban-rural habitat, we would use:

plot(Herb_spp2 ~ as.factor(all_herbs$Urb_Rur),
     cex.axis = 0.8,
     cex = 0.8)
# THIS DOESN'T WORK B/C OF NEGATIVE VALUES

# Let’s now contrast the species composition across urb/rural habitat type to see if the models support our observations.
# The model syntax below fits our response variable (the mvabund object Herb_spp with the counts of 9 species) to the predictor variable Habitat (urban/rural classification).

# CHANGING FROM MANYGLM TO MANYLM B/C REMOVING POISSON FAMILY
mod1 <- manylm(Herb_spp2 ~ Urb_Rur,
               data = all_herbs[-36,])

# Before we examine the output, we need to check our model assumptions. We can use the plot function to generate a plot of residuals.

plot(mod1)
# Does this look ok?

# We can test the multivariate hypothesis of whether species composition varied across the habitats by using the anova function. This gives an analysis of deviance table where we use likelihood ratio tests and resampled p values to look for a significant effect of Habitat on the community data.

anova(mod1)

# OUTPUT: Analysis of Variance Table
# Model: manylm(formula = Herb_spp2 ~ Urb_Rur, data = all_herbs[-36, ])
# 
# Overall test for all response variables
# Test statistics:
#             Res.Df Df.diff val(F) Pr(>F)
# (Intercept)     50                      
# Urb_Rur         49       1  1.791  0.942
# Arguments:
#  Test statistics calculated assuming uncorrelated response (for faster computation) 
#  P-value calculated using 999 iterations via residual (without replacement) resampling.


# We can see from this table that there is NOT an effect of Urban vs. rural habitat, meaning that the species composition of herbivores does not differ between the urban/rural classification of population they were sourced from.
# 
# To examine this further, and see which herbivore species are more likely to be found in which habitat type, we can run univariate tests for each species separately.
# 
# This is done by using the p.uni="adjusted" argument in the anova function. The “adjusted” part of the argument refers to the resampling method used to compute the p values, taking into account the correlation between the response variables. This correlation is often found in ecological systems where different species will interact with each other, competing with or facilitating each others’ resource use.

anova_blup <- anova(mod1, p.uni = "adjusted") %T>%
  print()

# Analysis of Variance Table
# 
# Model: manylm(formula = Herb_spp2 ~ Urb_Rur, data = all_herbs[-36, ])
# 
# Overall test for all response variables
# Test statistics:
#             Res.Df Df.diff val(F) Pr(>F)
# (Intercept)     50                      
# Urb_Rur         49       1  1.791  0.937
# 
# Univariate Tests
# Test statistics:
#             monarch        tetraopes        liriomyza       
#             F value Pr(>F)   F value Pr(>F)   F value Pr(>F)
# (Intercept)                                                 
# Urb_Rur       0.072  0.997         0  1.000     0.081  0.997
#             aphis_nerii        aphis_ascl        myzocallis
#                 F value Pr(>F)    F value Pr(>F)    F value
# (Intercept)                                                
# Urb_Rur               0  1.000          0  1.000      0.927
#                    euchaetes        lygaeus        labidomera
#             Pr(>F)   F value Pr(>F) F value Pr(>F)    F value
# (Intercept)                                                  
# Urb_Rur      0.921     0.544  0.950       0  1.000      0.045
#                    rhyssomatus       
#             Pr(>F)     F value Pr(>F)
# (Intercept)                          
# Urb_Rur      0.997       0.122  0.997
# 
# Arguments: with 999 resampling iterations using residual (without replacement) resampling and uncorrelated response (for faster computation)


# after adjusting for multiple testing, there are still no effects of habitat on any specific herbivore.


# use city_dist as habitat descriptor
anova_blup2 <- manylm(Herb_spp2 ~ City_dist,
               data = all_herbs[-36,]) %>%
  anova() %T>%
  print()

# Analysis of Variance Table
# 
# Model: manylm(formula = Herb_spp2 ~ City_dist, data = all_herbs[-36, 
# Model:     ])
# 
# Overall test for all response variables
# Test statistics:
#             Res.Df Df.diff val(F) Pr(>F)
# (Intercept)     50                      
# City_dist       49       1  3.908  0.675
# Arguments:
#  Test statistics calculated assuming uncorrelated response (for faster computation) 
#  P-value calculated using 999 iterations via residual (without replacement) resampling.

# Still no effect of urbanization on herbivore abundance.
```

