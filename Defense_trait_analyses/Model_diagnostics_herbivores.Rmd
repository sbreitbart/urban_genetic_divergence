# Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

# Import data
```{r}
herbivores_all <- read.csv(here::here("./Joined_annual_data/herbivores.csv")) %>%
  dplyr::select(., -1) %>%
  dplyr::mutate_at(vars(c("Population",
                          "Family",
                          "Replicate",
                          "Block",
                          "Transect_ID",
                          "Sample",
                          "Patch_ID",
                          "Urb_Rur",
                          "Year",
                          "Surveyor",
                          "Date")),
                   as.character) %>%
    dplyr::mutate_at(vars(c("Population",
                            "Family",
                            "Replicate",
                            "Block",
                            "Transect_ID",
                            "Sample",
                            "Patch_ID",
                            "Urb_Rur",
                            "Year",
                            "Surveyor",
                          "Date")),
                     as.factor)

str(herbivores_all)
```

# Create subset
```{r}
# filter out herbivores not surveyed in 2021
# Herbivores surveyed in 2020-2021: Monarchs, L. asclepiadis, L. clivicollis
herbivores <- herbivores_all %>%
  dplyr::select(c(1:7, 10, 13, 19, 22:Surveyor))
```

# Diagnostics
## Monarchs- no transformations
### Gradient
#### City_dist
```{r}
monarch_gr_city_m1 <- glmmTMB(Monarch_Quantity_Observed ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                City_dist,
              data = herbivores,
              family = poisson,
              REML = F) 

#performance::check_model(monarch_gr_city_m1) # looks fine
```

#### Urb_score
```{r}
monarch_gr_usc_m1 <- glmmTMB(Monarch_Quantity_Observed ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score,
              data = herbivores,
              family = poisson,
              REML = F) 

# performance::check_model(monarch_gr_usc_m1) # looks fine
```

### Urban Subtransects
#### City_dist
```{r}
# Full model
monarch_urbsubs_city_m1 <- glmmTMB(Monarch_Quantity_Observed ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                City_dist * Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              REML = F) 

# performance::check_model(monarch_urbsubs_city_m1) # looks fine


# MAIN EFFECTS MODEL
monarch_urbsubs_city_m2 <- glmmTMB(Monarch_Quantity_Observed ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                City_dist + Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              REML = F) 

# performance::check_model(monarch_urbsubs_city_m2) # looks fine

#  
# AIC(monarch_urbsubs_city_m1,
#     monarch_urbsubs_city_m2) # m2 better but <2 AIC apart
```

#### Urb_score
```{r}
# Full model
monarch_urbsubs_usc_m1 <- glmmTMB(Monarch_Quantity_Observed ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score * Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              REML = F) 

# performance::check_model(monarch_urbsubs_usc_m1) # looks fine


# MAIN EFFECTS MODEL
monarch_urbsubs_usc_m2 <- glmmTMB(Monarch_Quantity_Observed ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score + Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              REML = F) 

# performance::check_model(monarch_urbsubs_usc_m2) # looks fine
 
# AIC(monarch_urbsubs_usc_m1,
#     monarch_urbsubs_usc_m2) # m2 better but <2 AIC apart
```


## Liriomyza asclepiadis- sqrt transformation for all mods
### Gradient
#### City_dist
```{r}
# asclepiadis_gr_city_m1 <- glmmTMB(Liriomyza_asclepiadis ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 City_dist,
#               data = herbivores,
#               family = poisson,
#               REML = F) 
# 
# performance::check_model(asclepiadis_gr_city_m1) # try sqrt transformation
# 
# performance::check_model(
#   update(
#     asclepiadis_gr_city_m1, Liriomyza_asclepiadis^(1/2) ~ .
#     )
#   ) # looks good

asclepiadis_gr_city_m1 <- glmmTMB(sqrt(Liriomyza_asclepiadis) ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                City_dist,
              data = herbivores,
              family = poisson,
              REML = F) 

```

#### Urb_score
```{r}
# asclepiadis_gr_usc_m1 <- glmmTMB(Liriomyza_asclepiadis ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 Urb_score,
#               data = herbivores,
#               family = poisson,
#               REML = F) 
# 
# performance::check_model(asclepiadis_gr_usc_m1) # try sqrt transformation
# 
# performance::check_model(
#   update(
#     asclepiadis_gr_usc_m1, Liriomyza_asclepiadis^(1/2) ~ .
#     )
#   ) # looks good


asclepiadis_gr_usc_m1 <- glmmTMB(sqrt(Liriomyza_asclepiadis) ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score,
              data = herbivores,
              family = poisson,
              REML = F) 
```

### Urban Subtransects
#### City_dist
```{r}
# Full model
# asclepiadis_urbsubs_city_m1 <- glmmTMB(Liriomyza_asclepiadis ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 City_dist * Transect_ID,
#               data = herbivores %>%
#                 dplyr::filter(Transect_ID != "Rural"),
#               family = poisson,
#               REML = F) 
# 
# performance::check_model(asclepiadis_urbsubs_city_m1) # try sqrt transformation
# 
# performance::check_model(
#   update(
#     asclepiadis_urbsubs_city_m1, Liriomyza_asclepiadis^(1/2) ~ .
#     )
#   ) # looks good

asclepiadis_urbsubs_city_m1 <- glmmTMB(sqrt(Liriomyza_asclepiadis) ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                City_dist * Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              REML = F) 



# MAIN EFFECTS MODEL
asclepiadis_urbsubs_city_m2 <- glmmTMB(sqrt(Liriomyza_asclepiadis) ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                City_dist + Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              REML = F) 

# performance::check_model(asclepiadis_urbsubs_city_m2) # looks fine
# 
#  
# AIC(asclepiadis_urbsubs_city_m1,
#     asclepiadis_urbsubs_city_m2) # m2 better but <2 AIC apart
```

#### Urb_score
```{r}
# Full model
asclepiadis_urbsubs_usc_m1 <- glmmTMB(Liriomyza_asclepiadis ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score * Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              REML = F)

performance::check_model(asclepiadis_urbsubs_usc_m1) # try sqrt transformation

performance::check_model(
  update(
    asclepiadis_urbsubs_usc_m1, Liriomyza_asclepiadis^(1/2) ~ .
    )
  ) # looks good

asclepiadis_urbsubs_usc_m1 <- glmmTMB(sqrt(Liriomyza_asclepiadis) ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score * Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              REML = F) 



# MAIN EFFECTS MODEL
asclepiadis_urbsubs_usc_m2 <- glmmTMB(sqrt(Liriomyza_asclepiadis) ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score + Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              REML = F) 

performance::check_model(asclepiadis_urbsubs_usc_m2) # looks fine


AIC(asclepiadis_urbsubs_usc_m1,
    asclepiadis_urbsubs_usc_m2) # m2 better but <2 AIC apart
```


## Labidomera clivicollis
### Gradient- sqrt transformations
#### City_dist
```{r}
# clivicollis_gr_city_m1 <- glmmTMB(Labidomera_clivicollis ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 City_dist,
#               data = herbivores,
#               family = poisson,
#               REML = F)

# performance::check_model(clivicollis_gr_city_m1) # try sqrt transformation, though might just be some potential outliers
# 
# performance::check_model(
#   update(
#     clivicollis_gr_city_m1, Labidomera_clivicollis^(1/2) ~ .
#     )
#   ) # helped with homogeneity of variance. I think a few large values are impacting the plots but there are only about 2-4, so it's ok
# 
# # try removing potential outliers
# performance::check_model(glmmTMB(sqrt(Labidomera_clivicollis) ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 City_dist,
#               data = herbivores %>%
#                 dplyr::filter(Labidomera_clivicollis < 9),
#               family = poisson,
#               REML = F))
# 
# 
# # see if ANOVA results change: (they don't; p >>0.3)
# # original model
# car::Anova(clivicollis_gr_city_m1)
# 
# # sqrt transformation
# car::Anova(
#   update(
#     clivicollis_gr_city_m1, sqrt(Labidomera_clivicollis) ~ .))
# 
# # remove potential outliers
# car::Anova(glmmTMB(Labidomera_clivicollis ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 City_dist,
#               data = herbivores %>%
#                 dplyr::filter(Labidomera_clivicollis < 9),
#               family = poisson,
#               REML = F))
# 
# # remove potential outliers & sqrt tranformation
# car::Anova(glmmTMB(sqrt(Labidomera_clivicollis) ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 City_dist,
#               data = herbivores %>%
#                 dplyr::filter(Labidomera_clivicollis < 9),
#               family = poisson,
#               REML = F))
# 
# SO, i'll go with sqrt model.

clivicollis_gr_city_m1 <- glmmTMB(sqrt(Labidomera_clivicollis) ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                City_dist,
              data = herbivores,
              family = poisson,
              REML = F)

```

#### Urb_score
```{r}
# clivicollis_gr_usc_m1 <- glmmTMB(Labidomera_clivicollis ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 Urb_score,
#               data = herbivores,
#               family = poisson,
#               REML = F)
# 
# performance::check_model(clivicollis_gr_usc_m1) # try sqrt transformation, though might just be some potential outliers
# 
# performance::check_model(
#   update(
#     clivicollis_gr_usc_m1, Labidomera_clivicollis^(1/2) ~ .
#     )
#   ) # helped with homogeneity of variance. I think a few large values are impacting the plots but there are only about 2-4
# 
# # try removing potential outliers
# performance::check_model(glmmTMB(sqrt(Labidomera_clivicollis) ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 City_dist,
#               data = herbivores %>%
#                 dplyr::filter(Labidomera_clivicollis < 9),
#               family = poisson,
#               REML = F)) # not much change
# 
# 
# # see if ANOVA results change: (they don't; p >>0.4)
# # original model
# car::Anova(clivicollis_gr_usc_m1)
# 
# # sqrt transformation
# car::Anova(
#   update(
#     clivicollis_gr_usc_m1, sqrt(Labidomera_clivicollis) ~ .))
# 
# # remove potential outliers
# car::Anova(glmmTMB(Labidomera_clivicollis ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 Urb_score,
#               data = herbivores %>%
#                 dplyr::filter(Labidomera_clivicollis < 9),
#               family = poisson,
#               REML = F))
# 
# # remove potential outliers & sqrt tranformation
# car::Anova(glmmTMB(sqrt(Labidomera_clivicollis) ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 Urb_score,
#               data = herbivores %>%
#                 dplyr::filter(Labidomera_clivicollis < 9),
#               family = poisson,
#               REML = F))

# SO, i'll go with sqrt model
clivicollis_gr_usc_m1 <- glmmTMB(sqrt(Labidomera_clivicollis) ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score,
              data = herbivores,
              family = poisson,
              REML = F)

```

### Urban Subtransects- presence/absence mods
#### City_dist
```{r}
# Full model
# clivicollis_urbsubs_city_m1 <- glmmTMB(Labidomera_clivicollis ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 City_dist * Transect_ID,
#               data = herbivores %>%
#                 dplyr::filter(Transect_ID != "Rural"),
#               family = poisson,
#               REML = F)
# 
# performance::check_model(clivicollis_urbsubs_city_m1) # try sqrt transformation
# 
# performance::check_model(
#   update(
#     clivicollis_urbsubs_city_m1, Labidomera_clivicollis^(1/2) ~ .
#     )
#   ) # looks a bit worse... try making mod zero-inflated
# 
# performance::check_model(glmmTMB(Labidomera_clivicollis ~
#                                 (1|Block) +
#                                 (1|Population/Family) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 City_dist * Transect_ID,
#               data = herbivores %>%
#                 dplyr::filter(Transect_ID != "Rural"),
#               family = poisson,
#               ziformula = ~1,
#               REML = F)) #that helped

# I see that if I remove highest value, significant p-value goes from 0.02 to 0.3- major change. So it might be driving the trends. And I think the vast majority of values are 0... so I should use a presence/absence model for these ones

herbivores$LC_binary <- ifelse(herbivores$Labidomera_clivicollis > 0, 1, 0)


clivicollis_urbsubs_city_m1 <- glmmTMB(LC_binary ~
                                (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                City_dist * Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial(),
              REML = F) 

performance::check_model(clivicollis_urbsubs_city_m1) 
plot(simulateResiduals(clivicollis_urbsubs_city_m1)) # looks fine



# MAIN EFFECTS MODEL
clivicollis_urbsubs_city_m2 <- glmmTMB(LC_binary ~
                                # (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                City_dist + Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial(),
              REML = F) # was singular so took out block. now is fine

performance::check_model(clivicollis_urbsubs_city_m2) # looks fine
plot(simulateResiduals(clivicollis_urbsubs_city_m2)) # looks fine

AIC(clivicollis_urbsubs_city_m1,
    clivicollis_urbsubs_city_m2) # m2 better but <2 AIC apart
```

#### Urb_score
```{r}
herbivores %<>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))

clivicollis_urbsubs_usc_m1 <- glmmTMB(LC_binary ~
                                (1|Block) +
                                (1|Fam_uniq) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score * Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial(),
              REML = F) # wasn't converging- nearly 0 variation at the pop level- so I took out pop, inserted all unique families, it converged, and had nearly same AIC as model with Pop/Fam, so I'll just use this as my alternate model because I won't be analyzing it anyway.

# performance::check_model(clivicollis_urbsubs_usc_m1) 
# plot(simulateResiduals(clivicollis_urbsubs_usc_m1)) # looks fine


# MAIN EFFECTS MODEL
# clivicollis_urbsubs_usc_m2 <- glmmTMB(LC_binary ~
#                                 (1|Block) +
#                                 (1|Fam_uniq) +
#                                 (1|Year) +
#                                 (1|Sample) +
#                                 Urb_score + Transect_ID,
#               data = herbivores %>%
#                 dplyr::filter(Transect_ID != "Rural"),
#               family = binomial(),
#               REML = F) 
# 
# performance::check_model(clivicollis_urbsubs_usc_m2) # looks fine
# plot(simulateResiduals(clivicollis_urbsubs_usc_m2)) # looks fine
# 
# AIC(clivicollis_urbsubs_usc_m1,
#     clivicollis_urbsubs_usc_m2) # m2 better but <2 AIC apart

# However, I'll still use m2 with Pop/Fam because it converged. I just wanted to compare both Fam_uniq models to evaluate which had lower AIC.


clivicollis_urbsubs_usc_m2 <- glmmTMB(LC_binary ~
                                # (1|Block) +
                                (1|Population/Family) +
                                (1|Year) +
                                (1|Sample) +
                                Urb_score + Transect_ID,
              data = herbivores %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial(),
              REML = F) # won't run unless I take out block

performance::check_model(clivicollis_urbsubs_usc_m2) # looks fine
plot(simulateResiduals(clivicollis_urbsubs_usc_m2)) # looks fine
```

# Models for use in analysis
## Monarchs
```{r}
monarch_mods <- list(

## City_dist / gradient
monarch_gr_city_m1 ,

## Urbanization score / gradient
monarch_gr_usc_m1 ,

## City_dist / urban subtransects
monarch_urbsubs_city_m1, # Qualitatively identical model (<2 AIC away)
monarch_urbsubs_city_m2, # Best model

## Urbanization score  / urban subtransects
monarch_urbsubs_usc_m1, # Qualitatively identical model (<2 AIC away)
monarch_urbsubs_usc_m2 # Best model

)

names(monarch_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```

## L. asclepiadis
```{r}
asclepiadis_mods <- list(

## City_dist / gradient
asclepiadis_gr_city_m1 ,

## Urbanization score / gradient
asclepiadis_gr_usc_m1 ,

## City_dist / urban subtransects
asclepiadis_urbsubs_city_m1, # Qualitatively identical model (<2 AIC away)
asclepiadis_urbsubs_city_m2, # Best model

## Urbanization score  / urban subtransects
asclepiadis_urbsubs_usc_m1, # Qualitatively identical model (<2 AIC away)
asclepiadis_urbsubs_usc_m2 # Best model

)

names(asclepiadis_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```

## L. clivicollis
```{r}
clivicollis_mods <- list(

## City_dist / gradient
clivicollis_gr_city_m1 ,

## Urbanization score / gradient
clivicollis_gr_usc_m1 ,

## City_dist / urban subtransects
clivicollis_urbsubs_city_m1, # Qualitatively identical model (<2 AIC away)
clivicollis_urbsubs_city_m2, # Best model

## Urbanization score  / urban subtransects
clivicollis_urbsubs_usc_m1, # Qualitatively identical model (<2 AIC away)
clivicollis_urbsubs_usc_m2 # Best model

)

names(clivicollis_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```