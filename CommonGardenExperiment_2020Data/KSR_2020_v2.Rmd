---
title: "KSR_2020"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console

---
# Set up notebook
## Load packages
```{r}
library(dplyr)
library(reshape)
library(reshape2)
library(tidyr)
library(ggplot2)
library(ggExtra)
library("ggpubr")
library(devtools)
library(rpart)
library("tibble", lib.loc="~/R/win-library/3.5")
library(ISLR)
library(MASS)
library(car)
library(data.table)
library(plyr)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(Hmisc)
library(lme4)
library(nlme)
library(reshape)
library(lmerTest)
library(tidyverse)
library(vegan)
library(lindia)
library(e1071)
library(ggpubr)
library(forcats)
library(car)
library(multcomp)
library(lsmeans)
library(ggbiplot)
library(ggplot2)
require(MASS)
require(scales)
require(car)
require(ggplot2)
require(ggiraph)
require(ggiraphExtra)
library(geosphere)
library(vctrs)
library(here)
```

## Add functions
```{r}
diagnostic<-function(x){
  plot(x)
  hist(x)
  qqnorm(x)
  qqline(x,lty=2, col="Red")

  skew<-function(x){
    m3<-sum((x-mean(x))^3)/length(x)
    s3<-sqrt(var(x))^3
    m3/s3}

  kurtosis<-function(x){
    m4<-sum((x-mean(x))^4)/length(x)
    s4<-var(x)^2
    m4/s4-3}

  print(paste("Kurtosis=", kurtosis(x), sep=""))
  print(paste("Skew=", skew(x), sep=""))
}

# diagnostic(x)
```

## Import KSR field data
```{r, import}
# 2019 data-----
data_clean_2019 <- read.csv(here("./CommonGardenExperiment_2019Data/clean_data/clean_data_2019KSR.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",")

# 2020 data-----
heights_both <- read.csv(here("./CommonGardenExperiment_2020Data/clean_data/2020_heights_clean.csv")) %>%
  dplyr::select(., -1)

herbivory_both <- read.csv(here("./CommonGardenExperiment_2020Data/clean_data/2020_herbivory_clean.csv")) %>%
  dplyr::select(., -1)

survival <- read.csv(here("./CommonGardenExperiment_2020Data/clean_data/2020_survival_clean.csv")) %>%
  dplyr::select(., -1)

weevil_both <- read.csv(here("./CommonGardenExperiment_2020Data/clean_data/2020_weevil_damage_clean.csv")) %>%
  dplyr::select(., -1)

herbivores <- read.csv(here("./CommonGardenExperiment_2020Data/clean_data/2020_insect_herbivores_clean.csv")) %>%
  dplyr::select(., -1)

reproductive <- read.csv(here("./CommonGardenExperiment_2020Data/clean_data/2020_reproductive_clean.csv")) %>%
  dplyr::select(., -1)
flowering_2020 <- read.csv(here("./CommonGardenExperiment_2020Data/clean_data/2020_floweringplants_clean.csv")) %>%
  dplyr::select(., -1)

```

## Clean data
### survival
#### Find which plants had grown at season start --> make new survival_both df
Isn't a foolproof method for assessing overwinter mortality, but will tell which plants had no visible growth during first data collection in June
```{r}
# Make new column signifying if pots contained zero alive plants, or at least one- 0 or 1
## First, copy first height column associaed with first ramet (if 0, that means pot was empty/had no alive ramets)

survival_overwinter <- heights_both[,c(1:10)]
survival_overwinter$Mortality_binary <- survival_overwinter$Total_Height_June

## Now change all instances of >0 to 1. If >=0, then at least one ramet present.
survival_overwinter <- survival_overwinter %>%
  mutate(., Mortality_binary = ifelse((Mortality_binary == 0 & Ramets_June < 1), "1", "0"))

### make new binary mortality column factor
survival_overwinter$Mortality_binary <- as.factor(survival_overwinter$Mortality_binary)

# check appropriate columns are factors
str(survival_overwinter)


# extract mortality column from survival_overwinter df and add to survival df
survival_both <- left_join(survival, survival_overwinter, by = c("Row", "Column", "Block", "Population", "Family", "Replicate"))
# rename cols
survival_both <- dplyr::rename(survival_both, Dead_Sept = Dead)
survival_both <- dplyr::rename(survival_both, Dead_June = Mortality_binary)
survival_both <- dplyr::rename(survival_both, Comment_Sept = Comment)
# get rid of date columns & June height and # ramets cols
survival_both <- survival_both[,-c(8, 11:13)]
# reorder cols
survival_both <- survival_both[, c(1:6, 10,9,8,7)]
```

#### find plants deemed dead during both data collection assessments and years
```{r}
# these plants were DEAD for all data collections in 2020
dead_2020 <- survival_both %>% filter(., Dead_June == 1 & Dead_Sept == 1)

# shows which plants were dead or alive throughout all data collections in 2020
survival_both <- transform(survival_both, dead_2020 = ifelse(Dead_June == 1 & Dead_Sept == 1, 1,0))

# these plants were dead for all data collections in 2019
dead_2019 <- data_clean_2019 %>% filter(., (Dead_DC1 == 'yes' | Dead_DC1 == 'maybe' | Dead_DC1 == 'nothing there') & Dead_DC2 == 1 & Dead_DC3 == 1)

# these plants were dead either throughout 2019 OR 2020
dead_either_2019or2020_fullyear <- full_join(dead_2019[,c(1:6, 9:11)], dead_2020, by = c("Row", "Column", "Block", "Population", "Family", "Replicate")) %>%
  dplyr::select( 2,3,7:9, 14:16)

# these plants were dead throughout 2019 AND 2020
# # THESE ARE THE PLANTS THAT HAVE BEEN DEAD FROM THE START, PRESUMABLY
dead_bothyears <- inner_join(dead_2019[,c(1:6, 9:11)], dead_2020[,c(1:7,9)],  by = c("Row", "Column", "Block", "Population", "Family", "Replicate")) 

# new df to see which plants I thought were dead in 2019 but really weren't in 2020
# SO: should be in dead2019 but NOT in dead2020
zombies <- anti_join(dead_2019, dead_2020, by = c("Row", "Column"))

```

#### Remove plants that were dead since early 2019 from ALL dfs
```{r}
# remove dead_bothyears plants from 2020 dataset
heights_both <- anti_join(heights_both, dead_bothyears, by = c("Row", "Column"))
herbivory_both <- anti_join(herbivory_both, dead_bothyears, by = c("Row", "Column"))
survival_2020 <- anti_join(survival_both, dead_bothyears, by = c("Row", "Column"))
weevil_both <- anti_join(weevil_both, dead_bothyears, by = c("Row", "Column"))
herbivores <- anti_join(herbivores, dead_bothyears, by = c("Row", "Column"))
reproductive <- anti_join(reproductive, dead_bothyears, by = c("Row", "Column"))
```

### heights: Calculate relative growth rate
```{r}

# some plants had heights of 0 in June, Sept, or both:
## If they were 0 in June but >0 in September: June = 1, since ln(1)=0.
# If they were >0 in June but 0 in September: Sept = 1.
# If June = 0 and Sept = 0, it will be NA.
heights_both <- heights_both %>% dplyr::mutate(.,
                              rel_growth_rate = case_when(
                                Total_Height_June > 0 & Total_Height_Sept > 0 ~ (log(Total_Height_Sept) - log(Total_Height_June))/ date_diff,
                                Total_Height_June > 0 & Total_Height_Sept == 0  ~ (1 - log(Total_Height_June)) / date_diff,
                                Total_Height_June == 0 & Total_Height_Sept > 0  ~ (log(Total_Height_Sept) - 1) / date_diff))


```
### weevil damage: standardize weevil scar length by total height
```{r}
# add June height so I can standardize weevil scar length by total height
weevil_both <- weevil_both %>%
  left_join(., heights_both[,-c(7, 9:15)], by = c("Row", "Column", "Block", "Population", "Family", "Replicate")) %>%
  mutate(Scar_length_cm = Scar_length_mm / 10) %>%
  
# standardize weevil scar length by total height
## value may be over 1 because 1) oftentimes there were multiple scars per ramet on different sides, and 2) height was measured in June and scars in July, so the plants were likely taller when scars were measured
  mutate(scar_div_Juneheight = Scar_length_cm / (Total_Height_June)) %>%
  dplyr::select(., -Scar_length_mm)

```

### herbivory: calculate average herbivory
```{r}
# Clean columns to get average herbivory
# JULY------
### Replace non-numeric entries with NA and remove dashes (which symbolize no leaf) 
herbivory_both$Herbivory.July_mean <- herbivory_both_alive$Herbivory.July

herbivory_both$Herbivory.July_mean <- gsub('too small', NA, herbivory_both$Herbivory.July_mean)

# converts plants we weren't able to assess to NA (from 0)- represents either a lack of plant or no leaves
herbivory_both <- herbivory_both %>%
    mutate(Herbivory.July_mean = na_if(Herbivory.July_mean, "0"))

herbivory_both$Herbivory.July_mean <- gsub('-', "", herbivory_both$Herbivory.July_mean)

herbivory_both$Herbivory.July_mean <- gsub(' ', "", herbivory_both$Herbivory.July_mean)


library(stringi)
### Calculate mean herbivory for ramet 1 in new column
herbivory_both$Herbivory.July_mean <- sapply(strsplit(as.character(herbivory_both$Herbivory.July_mean), ",", fixed=T), function(x) mean(as.numeric(x)))

# SEPT------
### Replace non-numeric entries with NA and remove dashes (which symbolize no leaf) 
herbivory_both$Herbivory.Sept_mean <- herbivory_both$Herbivory.Sept

herbivory_both$Herbivory.Sept_mean <- gsub('too small', NA, herbivory_both$Herbivory.Sept_mean)

# converts plants we weren't able to assess to NA (from 0)- represents either a lack of plant or no leaves
herbivory_both <- herbivory_both %>%
    mutate(Herbivory.Sept_mean = na_if(Herbivory.Sept_mean, "0"))

herbivory_both$Herbivory.Sept_mean <- gsub('-', "", herbivory_both$Herbivory.Sept_mean)

herbivory_both$Herbivory.Sept_mean <- gsub(' ', "", herbivory_both$Herbivory.Sept_mean)


library(stringi)
### Calculate mean herbivory for ramet 1 in new column
herbivory_both$Herbivory.Sept_mean <- sapply(strsplit(as.character(herbivory_both$Herbivory.Sept_mean), ",", fixed=T), function(x) mean(as.numeric(x)))
```

## Add transect data (e.g. city_dist values)
### Add City_dist values with Haversine formula
```{r}
# import data
Distances <- read.csv(here("./CommonGardenExperiment_2019Data/raw_data/Transect_Milkweed_HaversineData_forjoining.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",")

# Ref lat and longs are for Yonge & Dundas intersection in downtown Toronto
Distances$Ref_Lat <- "43.656327"
Distances$Ref_Long <- "-79.380904"

# Make lat/long cols numeric
Distances$Latitude <- as.numeric(as.character(Distances$Latitude))
Distances$Longitude <- as.numeric(as.character(Distances$Longitude))
Distances$Ref_Lat <- as.numeric(as.character(Distances$Ref_Lat))
Distances$Ref_Long <- as.numeric(as.character(Distances$Ref_Long))

# Find distances from Yonge/Dundas to sample sites (in meters)
Distances <- Distances %>% mutate(CTD_m = distHaversine(cbind(Longitude, Latitude), cbind(Ref_Long, Ref_Lat)))

# conver to km
Distances$City_dist <- Distances$CTD / 1000

# drop ref lat, long, and city_dist (in m) cols
Distances <- Distances[,-c(7:9)]

```

### Add transect data to all dfs via merge
```{r}
# Add distances to city center
heights_both <- merge(x = heights_both, y = Distances, by = "Population", all.x = TRUE)
herbivory_both <- merge(x = herbivory_both, y = Distances, by = "Population", all.x = TRUE)
survival_2020 <- merge(x = survival_2020, y = Distances, by = "Population", all.x = TRUE)
weevil_both <- merge(x = weevil_both, y = Distances, by = "Population", all.x = TRUE)
herbivores <- merge(herbivores, Distances, by = "Population", all.x = TRUE)
reproductive <- merge(x = reproductive, y = Distances, by = "Population", all.x = TRUE)
 





# add column combining both urban subtransects
reproductive$Urb_Rur <- reproductive$Transect_ID
reproductive$Urb_Rur <- revalue(reproductive$Urb_Rur, c("North"="Urban", "South"="Urban"))


```

# Find averages per family & population
## reproductive
### Binary: flowering success
```{r}

# Find family means
flowered2020_familymeans <- reproductive_alive2020 %>%
  dplyr::select(., c(1:6, 78:86)) %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      sum_flowered_indivs = sum(as.integer(Flowered2020)),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      nPlants=n())
# for some reason, sum_flowered_indivs isn't outputting what I want, so doing this
flowered2020_familymeans <- as.data.frame(flowered2020_familymeans) %>% 
  mutate(.,sum_flowered_indivs2 = sum_flowered_indivs - sum_replicates ) %>%
  dplyr::select(., -sum_flowered_indivs) %>%
  dplyr::rename(., sum_flowered_indivs = sum_flowered_indivs2)
flowered2020_familymeans
  
    


# Find population means
flowered2020_popmeans <- flowered2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      sum_flowered_indivs = sum(as.integer(sum_flowered_indivs)),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID)) %>%
  as.data.frame(flowered2020_popmeans) %>%
  
# add percent flowered column
  mutate(., percent_flowered = sum_flowered_indivs / sum_replicates)

# remove pops with only 1 rep?




# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```


## Height
```{r}

# Add transect data via merge
heights_both <- merge(heights_both, Distances, by = "Population", all.x = TRUE)


# Find family means
heights_both2020_familymeans <- heights_both %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      sum_height_June = sum(Total_Height_June),
      sum_height_Sept = sum(Total_Height_Sept),
      mean_Ramets_June = mean(Ramets_June),
      mean_Ramets_Sept = mean(Ramets_Sept),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      mean_rel_growth_rate = mean(rel_growth_rate),
      nPlants=n())
## divide total height by num. plants/pop
heights_both2020_familymeans$mean_height_June <- heights_both2020_familymeans$sum_height_June / heights_both2020_familymeans$sum_replicates

heights_both2020_familymeans$mean_height_Sept <- heights_both2020_familymeans$sum_height_Sept / heights_both2020_familymeans$sum_replicates


# Find population means
heights_both2020_popmeans <- heights_both2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      sum_height_June = sum(sum_height_June),
      sum_height_Sept = sum(sum_height_Sept),
      mean_Ramets_June = mean(mean_Ramets_June),
      mean_Ramets_Sept = mean(mean_Ramets_Sept),
      mean_height_June = mean(mean_height_June),
      mean_height_Sept = mean(mean_height_Sept),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      mean_rel_growth_rate = mean(mean_rel_growth_rate))



# Use SummarySE to get stats per family & population
## HEIGHTS
intermediate1 <- summarySE(heights_both, measurevar="Total_Height_June", groupvars=c("Population", "Family"), na.rm=TRUE)

intermediate2 <- summarySE(heights_both, measurevar="Total_Height_Sept", groupvars=c("Population", "Family"), na.rm=TRUE)

heights_2020_familymeans_stats <- left_join(intermediate1, intermediate2, by = c("Population", "Family"), suffix = c(".July", ".Sept"))


# Use SummarySE to get stats per family & population
## no. ramets
intermediate1 <- summarySE(heights_both, measurevar="Ramets_June", groupvars=c("Population", "Family"), na.rm=TRUE)

intermediate2 <- summarySE(heights_both, measurevar="Ramets_Sept", groupvars=c("Population", "Family"), na.rm=TRUE)

ramets_2020_familymeans_stats <- left_join(intermediate1, intermediate2, by = c("Population", "Family"), suffix = c(".June", ".Sept"))

# Add transect data via merge
ramets_2020_familymeans_stats <- merge(ramets_2020_familymeans_stats, Distances, by = "Population", all.x = TRUE)



SSE_pops_height_2020 <- summarySE(intermediates, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)

```


## Weevil scar lengths
```{r}

# Add transect data via merge
weevil_both <- merge(weevil_both, Distances, by = "Population", all.x = TRUE)


# Find family means
weevil_both2020_familymeans <- weevil_both %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      mean_scar_div_Juneheight = mean(scar_div_Juneheight, na.rm = TRUE),
      mean_scar = mean(Scar_length_cm),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      nPlants=n())


# Find population means
weevil_both2020_popmeans <- weevil_both2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      mean_scar_div_Juneheight = mean(mean_scar_div_Juneheight, na.rm = TRUE),
      mean_scar = mean(mean_scar),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID))



# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```

## Herbivores
```{r}

# Find family means
herbivores2020_familymeans <- herbivores %>%
  group_by(Population, Family, Sample) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      mean_Monarch_Quantity_Past = mean(Monarch_Quantity_Past),
      mean_Monarch_Quantity_Observed = mean(Monarch_Quantity_Observed),
      mean_Tetraopes_tetropthalmus = mean(Tetraopes_tetropthalmus),
      mean_Liriomyza_asclepiadis = mean(Liriomyza_asclepiadis),
      mean_Aphis_nerii = mean(Aphis_nerii),
      mean_Aphis_asclepiadis = mean(Aphis_asclepiadis),
      mean_Myzocallis_asclepiadis = mean(Myzocallis_asclepiadis),
      mean_Euchaetes_egle = mean(Euchaetes_egle),
      mean_Lygaeus_kalmii = mean(Lygaeus_kalmii),
      mean_Labidomera_clivicollis = mean(Labidomera_clivicollis),
      mean_Rhyssomatus_lineaticollis = mean(Rhyssomatus_lineaticollis),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      nPlants=n())
herbivores2020_familymeans <- as.data.frame(herbivores2020_familymeans)


# Find population means
herbivores2020_popmeans <- herbivores2020_familymeans %>%
  group_by(Population, Sample) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      mean_Monarch_Quantity_Past = mean(mean_Monarch_Quantity_Past),
      mean_Monarch_Quantity_Observed = mean(mean_Monarch_Quantity_Observed),
      mean_Tetraopes_tetropthalmus = mean(mean_Tetraopes_tetropthalmus),
      mean_Liriomyza_asclepiadis = mean(mean_Liriomyza_asclepiadis),
      mean_Aphis_nerii = mean(mean_Aphis_nerii),
      mean_Aphis_asclepiadis = mean(mean_Aphis_asclepiadis),
      mean_Myzocallis_asclepiadis = mean(mean_Myzocallis_asclepiadis),
      mean_Euchaetes_egle = mean(mean_Euchaetes_egle),
      mean_Lygaeus_kalmii = mean(mean_Lygaeus_kalmii),
      mean_Labidomera_clivicollis = mean(mean_Labidomera_clivicollis),
      mean_Rhyssomatus_lineaticollis = mean(mean_Rhyssomatus_lineaticollis),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID))
herbivores2020_popmeans <- as.data.frame(herbivores2020_popmeans)


# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```


## Herbivory
```{r}
# Add transect data via merge
herbivory_both_alive <- merge(herbivory_both_alive, Distances, by = "Population", all.x = TRUE)

# Find family means
herbivory2020_familymeans <- herbivory_both_alive %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      Herbivory.July_mean = mean(Herbivory.July_mean, na.rm = T),
      Herbivory.Sept_mean = mean(Herbivory.Sept_mean, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      nPlants=n())
herbivory2020_familymeans <- as.data.frame(herbivory2020_familymeans)


# Find population means
herbivory2020_popmeans <- herbivory2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      Herbivory.July_mean = mean(Herbivory.July_mean, na.rm = T),
      Herbivory.Sept_mean = mean(Herbivory.Sept_mean, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID))
herbivory2020_popmeans <- as.data.frame(herbivory2020_popmeans)


# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```



## Survival
```{r}
# Add transect data via merge
survival_2020 <- merge(survival_2020, Distances, by = "Population", all.x = TRUE)

# Find family means
survival2020_familymeans <- survival_2020 %>%
  group_by(Population, Family) %>%
    dplyr::summarise(
      sum_replicates = n_distinct(Replicate),
      survival_mean = mean(dead_2020, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID),
      nPlants=n())
survival2020_familymeans <- as.data.frame(survival2020_familymeans)


# Find population means
survival2020_popmeans <- survival2020_familymeans %>%
  group_by(Population) %>%
    dplyr::summarise(
      sum_replicates = sum(sum_replicates),
      survival_mean = mean(survival_mean, na.rm = T),
      City_dist = first(City_dist),
      Transect_ID = first(Transect_ID))
survival2020_popmeans <- as.data.frame(survival2020_popmeans)


# Use SummarySE to get stats per family & population

### NOT TRANSFORMED
# SSE_fams_height_2020 <- summarySE(DC7_2020_heights, measurevar="Total_Height", groupvars=c("Population", "Family"), na.rm=TRUE)
# SSE_fams_height_2020 <- merge(x = SSE_fams_height_2020, y = Distances, by = "Population", all.x = TRUE)
# 
# SSE_pops_height_2020 <- summarySE(SSE_fams_height_2020, measurevar="Total_Height", groupvars=c("Population"), na.rm=TRUE)
# ## removing pops with only 1 representative (4 pops)
# SSE_pops_height_2020 <- merge(x = SSE_pops_height_2020 %>% filter(N > 1), y = Distances, by = "Population", all.x = TRUE)


```


# Visualize spatial patterns
## Blocks in plot
```{r}
blocks <- ggplot(data =  weevil_both, aes(x = Column, y = Row)) + 
      geom_tile(aes(fill = Block), colour = "black") +
      scale_y_reverse() +
  theme_minimal()
blocks

png("blocks.png", width = 800, height = 400)
print(blocks)
dev.off()
```

## Weevil damage
```{r}
# binary: damaged or not during first weevil damage assessment
weevil_matrix_data_binary <- weevil_both[,c("Row", "Column", "Weevil_dam_binary")]

weevil_plot_binary <- ggplot(data =  weevil_matrix_data_binary, aes(x = Column, y = Row)) + 
      geom_tile(aes(fill = Weevil_dam_binary), colour = "black") +
      scale_y_reverse() +
  scale_fill_manual(values = c("yellow", "red"),
                      name = "Weevil Damage",
                      labels = c("No", "Yes"))

weevil_plot_binary


# quantitative: how long was the scar? during second weevil damage assessment
weevil_matrix_data_quant <- weevil_both[,c("Row", "Column", "Scar_length_mm")]

weevil_plot_quant <- ggplot(data =  weevil_matrix_data_quant, aes(x = Column, y = Row, fill = Scar_length_mm)) + 
      geom_tile(aes(fill = Scar_length_mm), colour = "black") +
      scale_y_reverse()
weevil_plot_quant

# quantitative: how long was the scar? during second weevil damage assessment- ONLY IF HAD SCAR
weevil_matrix_data_quant <- weevil_both[,c("Row", "Column", "Scar_length_mm")]

ggplot(data =  weevil_matrix_data_quant %>% filter(.,Scar_length_mm > 0), aes(x = Column, y = Row, fill = Scar_length_mm)) + 
      geom_tile(aes(fill = Scar_length_mm), colour = "black") +
      scale_y_reverse()


# quantitative: how long was the scar? during second weevil damage assessment- ONLY IF HAD SCAR- STANDARDIZED BY HEIGHT
weevil_matrix_data_standardized <- weevil_both[,c("Row", "Column", "scar_div_Juneheight")]

ggplot(data =  weevil_matrix_data_standardized %>% filter(.,scar_div_Juneheight > 0), aes(x = Column, y = Row, fill = scar_div_Juneheight)) +
  geom_tile(aes(fill = scar_div_Juneheight), colour = "black") +
  scale_fill_gradientn(colours = topo.colors(50)) +
  scale_y_reverse() +
  labs(fill = "Scar length per cm height")

# hist(log(weevil_both$scar_div_Juneheight)
# png("weevil_matrix_binary.png", width = 800, height = 400)
# print(weevil_plot_binary)
# dev.off()
```

## Mortality
```{r}
mortality_matrix_data <- dead_2020[,c("Row", "Column", "Dead_June")]

mortality_plot <- ggplot(data =  mortality_matrix_data, aes(x = Column, y = Row)) + 
      geom_tile(aes(fill = Dead_June), colour = "black") +
      scale_y_reverse() +
      scale_fill_discrete(name = "Mortality", labels = c("Dead", "Alive"))


png("mortality_matrix.png", width = 800, height = 400)
print(mortality_plot)
dev.off()
```

## Flowering
### Flowering plants
```{r}
flowering_matrix_data <- reproductive[,c("Row", "Column", "Flowered2020")]

flowering_plot <- ggplot(data =  flowering_matrix_data, aes(x = Column, y = Row)) + 
  geom_tile(aes(fill = Flowered2020), colour = "black") +
  scale_y_reverse() +
  scale_fill_manual(values = c("yellow", "red"),
                      name = "Flowering Plants",
                      labels = c("No", "Yes"))
flowering_plot

png("flowering_matrix.png", width = 800, height = 400)
print(flowering_plot)
dev.off()
```



# Statistics
## reproductive
### Plants that flowered
#### Flowering success
##### Sig difference between urb vs rural? (Odds ratio)
```{r}
# # How many plants flowered per subtransect? using 2019 alive plants
# tib1 <- reproductive %>%
#   filter(Alive_DC1 != '0')%>%
#   group_by(Flowered2020, Urb_Rur) %>%
#   tally()
# tib1
# 
# 
# Flowered_ttest <- matrix(c(21, 3, 556, 282), nrow = 2,
#                          dimnames = list(
#                            c("Urban", "Rural"),
#                            c("Flowered", "Didn't Flower")))
# 
# fisher.test(Flowered_ttest, alternative = "two.sided")
# # odds ratio = 3.5464
# # p = 0.02859
# # medium effect size


# How many plants flowered per subtransect? using 2020 alive plants
reproductive_alive2020 <- anti_join(reproductive, dead_2020, by = c("Row", "Column"))

tib2 <- reproductive_alive2020 %>%
  group_by(Flowered2020, Urb_Rur) %>%
  tally()
tib2


Flowered_ttest2 <- matrix(c(
  as.integer(tib2[3,3]),
  as.integer(tib2[4,3]),
  as.integer(tib2[1,3]),
  as.integer(tib2[2,3])),
  nrow = 2,
  dimnames = list(
    c("Urban", "Rural"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest2, alternative = "two.sided")
# odds ratio = 3.5148
# p = 0.0445
# medium effect size

chisq.test(Flowered_ttest2)
# X-squared = 3.7416, df = 1, p-value = 0.05307





# How many populations had at least one plant flower per subtransect? using 2020 alive plants
reproductive_alive2020 <- anti_join(reproductive, dead_2020, by = c("Row", "Column"))

tib3 <- reproductive_alive2020[,c(1:6, 78:86)] %>%
  group_by(Population, Flowered2020, Urb_Rur) %>%
  dplyr::summarise(Pops = n_distinct(Population),
                   Urb_Rur = first(Urb_Rur)) %>%
  group_by(Population, Urb_Rur) %>%
  dplyr::summarise(Flowered = sum(as.integer(Flowered2020)),
                   Urb_Rur = first(Urb_Rur)) %>%
  group_by(Urb_Rur, Flowered) %>%
  dplyr::summarise(Pops = n_distinct(Population))
  
tib3
# Flowered = 1: Didn't flower
# Flowered = 3: Did flower



Flowered_ttest3 <- matrix(c(
  as.integer(tib3[2,3]),
  as.integer(tib3[4,3]),
  as.integer(tib3[3,3]),
  as.integer(tib3[2,3])),
  nrow = 2,
  dimnames = list(
    c("Urban", "Rural"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest3, alternative = "two.sided")
# odds ratio = 3.5750
# p = 0.1006 (NOT SIGNIFICANT; CAN'T REJECT NULL)
# medium effect size


chisq.test(Flowered_ttest3)
# X-squared = 2.0551, df = 1, p-value = 0.1517
```



##### Sig difference between urb:north vs urb:south? (Odds ratio)
```{r}
# How many plants flowered per subtransect? using 2020 alive plants
reproductive_alive2020 <- anti_join(reproductive, dead_2020, by = c("Row", "Column"))

tib4 <- reproductive_alive2020 %>%
  filter(., Transect_ID != 'Rural') %>%
  group_by(Flowered2020, Transect_ID) %>%
  tally()
tib4


Flowered_ttest4 <- matrix(c(
  as.integer(tib4[3,3]),
  as.integer(tib4[4,3]),
  as.integer(tib4[1,3]),
  as.integer(tib4[2,3])),
  nrow = 2,
  dimnames = list(
    c("North", "South"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest4, alternative = "two.sided")
# odds ratio = 0.7970 (inverted = 1.2547)
# p = 0.6618 (CAN'T REJECT THE NULL)
# negligible effect size

chisq.test(Flowered_ttest4)
# X-squared = 0.081128, df = 1, p-value = 0.7758






# How many populations had at least one plant flower per subtransect? using 2020 alive plants
reproductive_alive2020 <- anti_join(reproductive, dead_2020, by = c("Row", "Column"))

tib5 <- reproductive_alive2020[,c(1:6, 78:86)] %>%
  filter(., Transect_ID != "Rural") %>%
  group_by(Population, Flowered2020, Transect_ID) %>%
  dplyr::summarise(Pops = n_distinct(Population),
                   Transect_ID = first(Transect_ID)) %>%
  group_by(Population, Transect_ID) %>%
  dplyr::summarise(Flowered = sum(as.integer(Flowered2020)),
                   Transect_ID = first(Transect_ID)) %>%
  group_by(Transect_ID, Flowered) %>%
  dplyr::summarise(Pops = n_distinct(Population))
  
tib5
# Flowered = 1: Didn't flower
# Flowered = 3: Did flower



Flowered_ttest5 <- matrix(c(
  as.integer(tib5[2,3]),
  as.integer(tib5[4,3]),
  as.integer(tib5[3,3]),
  as.integer(tib5[2,3])),
  nrow = 2,
  dimnames = list(
    c("North", "South"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest5, alternative = "two.sided")
# odds ratio = 0.4737 (reciprocal = 2.1110)
# p = 0.4521 (NOT SIGNIFICANT; CAN'T REJECT NULL)
# small effect size

chisq.test(Flowered_ttest5)
# X-squared = 0.41878, df = 1, p-value = 0.5175
```


##### Block effect?
```{r}
glmer(Flowered2020 ~ Block + (1|Population/Family),
  data = reproductive_alive2020,
  family = binomial,
  nAGQ=1,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

car::Anova(glmer(Flowered2020 ~ Block + (1|Population/Family),
  data = reproductive_alive2020,
  family = binomial,
  nAGQ=1,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# Block is significant, so yes, the number of plants that flowered DID significantly vary by block.

summary(glmer(Flowered2020 ~ Block + (1|Population/Family),
  data = reproductive_alive2020,
  family = binomial,
  nAGQ=1,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
```

#### Flower count
##### Mean flower count/inflorescence
###### Sig difference along gradient?
####### lm
```{r}
# compute mean flower count
flowering_2020$mean_flower_count <- NA
flowering_2020 <- flowering_2020 %>%
  rowwise() %>% 
  dplyr::mutate(., mean_flower_count = mean(c(Flower_count_I1,
                                     Flower_count_I2,
                                     Flower_count_I3),
                                     na.rm = TRUE))


# diagnostics: can I use a parametric test?
# using lm instead of glm w/poisson bc these are means, not integers
flowercount_2020_lm_gradient <- lm(mean_flower_count ~ City_dist, data = flowering_2020)

summary(flowercount_2020_lm_gradient, na.rm = T)
par(mfrow=c(2,2))
plot(flowercount_2020_lm_gradient, na.rm = T)

gg_reshist(flowercount_2020_lm_gradient, bins=15)

diagnostic(residuals(flowercount_2020_lm_gradient))
## looks good



# ANOVA
car::Anova(flowercount_2020_lm_gradient)
# distance is sig!
summary(flowercount_2020_lm_gradient)


```

####### lmer
```{r}
### NESTED RANDOM EFFECTS-----
flowercount_2020_lmer_gradient <- lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020)
# is singular

# ANOVA
car::Anova(flowercount_2020_lmer_gradient)
# distance is sig

library(MuMIn)
r.squaredGLMM(flowercount_2020_lmer_gradient)


### CROSSED RANDOM EFFECTS-----
lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020)
# singular

car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020))
# distance is sig


# ANy variation among families or populations?
ranova(lmer(mean_flower_count ~ (1|Population/Family), data = flowering_2020, REML = T))
# no... is singular
```


###### Sig difference btwn urban subtransects?
####### lm
```{r}
# diagnostics: can I use a parametric test?
# using lm instead of glm w/poisson bc these are means, not integers
flowercount_2020_lm_subtr <- lm(mean_flower_count ~ City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))

summary(flowercount_2020_lm_subtr, na.rm = T)
par(mfrow=c(2,2))
plot(flowercount_2020_lm_subtr, na.rm = T)
## looks good!

gg_reshist(flowercount_2020_lm_subtr, bins=15)

diagnostic(residuals(flowercount_2020_lm_subtr))


# try a sqrt transformation
gg_reshist( lm(mean_flower_count^(1/2) ~ City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")), bins=10)

diagnostic(residuals(lm(mean_flower_count^(1/2) ~ City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))))
# I'll go with this



# ANOVA
## sqrt transformation
car::Anova(lm(mean_flower_count^(1/2) ~ City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
AIC(lm(mean_flower_count^(1/2) ~ City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig

car::Anova(lm(mean_flower_count^(1/2) ~ City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
summary(lm(mean_flower_count^(1/2) ~ City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig
AIC(lm(mean_flower_count^(1/2) ~ City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))




## no transformation
car::Anova(lm(mean_flower_count ~ City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig

car::Anova(lm(mean_flower_count ~ City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig
```

####### lmer
```{r}
### NESTED RANDOM EFFECTS-----
flowercount_2020_lmer_subtr <- lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
# is singular

# ANOVA
car::Anova(flowercount_2020_lmer_subtr)
# nothing sig
AIC(flowercount_2020_lmer_subtr)

car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig

r.squaredGLMM(flowercount_2020_lmer_subtr)
# is this worth doing, since I have two regression lines?

AIC(lmer(mean_flower_count ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))


### CROSSED RANDOM EFFECTS-----
lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
# is singular

# ANOVA
car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
# nothing sig


car::Anova(lmer(mean_flower_count ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
# nothing sig



# ANy variation among families or populations?
ranova(lmer(mean_flower_count ~ (1|Population/Family), data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = T))
# no... is singular
car::Anova(lmer(mean_flower_count ~ (1|Population/Family) + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# no... is singular

```
##### Total flower count
###### Sig difference along gradient?
####### glm
```{r}
# compute total flower count
flowering_2020 <- flowering_2020 %>%
  rowwise() %>% 
  dplyr::mutate(., total_flower_count = sum(c(Flower_count_I1,
                                     Flower_count_I2,
                                     Flower_count_I3),
                                     na.rm = TRUE))


# diagnostics: can I use a parametric test?
# using glm w/poisson bc these are integers & counts
flowercountsum_2020_glm_gradient <- glm(total_flower_count ~ City_dist, data = flowering_2020, family = 'poisson')

summary(flowercountsum_2020_glm_gradient, na.rm = T)
par(mfrow=c(2,2))
plot(flowercountsum_2020_glm_gradient, na.rm = T)

diagnostic(residuals(flowercountsum_2020_glm_gradient))
## looks good though the residuals vs leverage plot is iffy... points 20 and 14 are both rural points and are highly influential



# ANOVA
car::Anova(flowercountsum_2020_glm_gradient)
# distance is sig!
```

####### glmer
```{r}
### nested RANDOM EFFECTS-----
flowercountsum_2020_glmer_gradient <- glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020, family = 'poisson')
# is singular...


# ANOVA
car::Anova(flowercountsum_2020_glmer_gradient)
# distance is marginally sig

r.squaredGLMM(flowercountsum_2020_glmer_gradient)


### CROSSED RANDOM EFFECTS-----
glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, family = 'poisson')
# NOT singular!


# ANOVA
car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, family = 'poisson')
)
# distance is marginally sig




# ANy variation among families or populations?
# ranova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020, family = 'poisson'))
```

###### Sig difference btwn urban subtransects?
####### glm
```{r}
# diagnostics: can I use a parametric test?
# using lm instead of glm w/poisson bc these are means, not integers
flowercountsum_2020_glm_subtr <- glm(total_flower_count ~ City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))

summary(flowercountsum_2020_glm_subtr, na.rm = T)
par(mfrow=c(2,2))
plot(flowercountsum_2020_glm_subtr, na.rm = T)
## looks good

diagnostic(residuals(flowercountsum_2020_glm_subtr))



# ANOVA
car::Anova(flowercountsum_2020_glm_subtr)
AIC(flowercountsum_2020_glm_subtr)
# nothing sig

car::Anova(glm(total_flower_count ~ City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig
summary(glm(total_flower_count ~ City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
AIC(glm(total_flower_count ~ City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))


```


####### glmer
```{r}
### NESTED RANDOM EFFECTS-----
flowercountsum_2020_glmer_subtr <- glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
                                     data = flowering_2020 %>% filter(Transect_ID != "Rural"))
# singular

# ANOVA
car::Anova(flowercountsum_2020_glmer_subtr)
AIC(flowercountsum_2020_glmer_subtr)
# nothing sig


car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig

car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# nothing sig



### CROSSED RANDOM EFFECTS-----
glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
# singular

# ANOVA
car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
AIC(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
# nothing sig


car::Anova(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
# nothing sig
AIC(glmer(total_flower_count ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)

```

#### Flower size
##### Mean flower size/inflorescence
###### lmer
####### gradient

```{r}
### NESTED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020)
# is singular

# ANOVA
car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020)
)
# distance not sig

library(MuMIn)
r.squaredGLMM(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist, data = flowering_2020)
)


### CROSSED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020)
# singular

car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist, data = flowering_2020))
# distance not sig


# ANy variation among families or populations?
ranova(lmer(Overall_mean ~ (1|Population/Family), data = flowering_2020, REML = T))
# no
```


####### urban subtransects
```{r}
### NESTED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
# is singular

# remove block?
lmer(Overall_mean ~ (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
# is singular

# ANOVA
car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# transect AND distance sig, and interaxn is marginally sig

car::Anova(lmer(Overall_mean ~  (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# still singular, now everything marginally sig

AIC(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)

car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))
# both main effects sig

r.squaredGLMM(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
# very high r-sq...is this worth doing, since I have two regression lines?

AIC(lmer(Overall_mean ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural")))


### CROSSED RANDOM EFFECTS-----
lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
# is singular

# ANOVA
car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
# nothing sig


car::Anova(lmer(Overall_mean ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"))
)
# transect AND distance sig, and interaxn is marginally sig



# ANy variation among families or populations?
ranova(lmer(Overall_mean ~ (1|Population/Family), data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = T))
# no
car::Anova(lmer(Overall_mean ~ (1|Population/Family) + Transect_ID, data = flowering_2020 %>% filter(Transect_ID != "Rural"), REML = F))
# YES... variance DOES differ by subtransect... is singular

```
### All plants
#### Regressions (is urbanization related to flowering?)
##### lm (pop means)
###### Entire gradient
####### diagnostics
```{r}
flowering_2020_lm_gradient <- lm(percent_flowered ~ City_dist, data = flowered2020_popmeans)

summary(flowering_2020_lm_gradient, na.rm = T)
par(mfrow=c(2,2))
plot(flowering_2020_lm_gradient, na.rm = T)

hist(flowered2020_popmeans$percent_flowered)
ggqqplot(flowered2020_popmeans$percent_flowered)
## Data points don't fit in envelope well at all.

gg_reshist(flowering_2020_lm_gradient, bins=20)
# definitely right-skewed

diagnostic(residuals(flowering_2020_lm_gradient))



# try a transformation----------------
gg_reshist(
  lm(percent_flowered^0.5 ~ City_dist, data = flowered2020_popmeans),
  bins=20)
par(mfrow=c(2,2))
plot(lm(percent_flowered^0.5 ~  City_dist, data = flowered2020_popmeans))
diagnostic(residuals(lm(percent_flowered^0.5 ~  City_dist, data = flowered2020_popmeans)))
# better... 

gg_reshist(
  lm(percent_flowered^(1/3) ~  City_dist, data = flowered2020_popmeans),
  bins=20)
par(mfrow=c(2,2))
plot(lm(percent_flowered^(1/3) ~  City_dist, data = flowered2020_popmeans))
diagnostic(residuals(lm(percent_flowered^(1/3) ~  City_dist, data = flowered2020_popmeans)))
# better... going with this one


# too strong
gg_reshist(
  lm(log(percent_flowered + 1) ~ City_dist, data = flowered2020_popmeans),
  bins=20)
par(mfrow=c(2,2))
plot(lm(log(percent_flowered + 1) ~ City_dist, data = flowered2020_popmeans))
diagnostic(residuals(lm(log(percent_flowered + 1) ~ City_dist, data = flowered2020_popmeans)))

# too strong
gg_reshist(
  lm((1/(percent_flowered+1)) ~ City_dist, data = flowered2020_popmeans),
  bins=20)
par(mfrow=c(2,2))
plot(lm((1/(percent_flowered+1)) ~ City_dist, data = flowered2020_popmeans))
diagnostic(residuals(lm((1/(percent_flowered+1)) ~ City_dist, data = flowered2020_popmeans)))



# Adding cube root column to df
flowered2020_popmeans$percent_flowered_cubert <- flowered2020_popmeans$percent_flowered^(1/3)
```

####### ANOVA
```{r}
car::Anova(lm(percent_flowered_cubert ~ City_dist, data = flowered2020_popmeans))
summary(lm(percent_flowered_cubert ~ City_dist, data = flowered2020_popmeans))
# not significant

```

###### Urban subtransects
####### diagnostics
```{r}
flowering_2020_lm_subtr <- lm(percent_flowered ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural"))

summary(flowering_2020_lm_subtr, na.rm = T)
par(mfrow=c(2,2))
plot(flowering_2020_lm_subtr, na.rm = T)

bptest(flowering_2020_lm_subtr)
gg_reshist(flowering_2020_lm_subtr, bins=20)
# definitely right-skewed

diagnostic(residuals(flowering_2020_lm_subtr))




# try a transformation----------------
gg_reshist(
  lm(percent_flowered^0.5 ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")),
  bins=20)
par(mfrow=c(2,2))
plot(lm(percent_flowered^0.5 ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")))
diagnostic(residuals(lm(percent_flowered^0.5 ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural"))))
# better... going with this one


gg_reshist(
  lm(percent_flowered^(1/3) ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")),
  bins=20)
par(mfrow=c(2,2))
plot(lm(percent_flowered^(1/3) ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")))
diagnostic(residuals(lm(percent_flowered^(1/3) ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural"))))
# kurtosis got worse... now it looks bimodal

# Adding square root column to df
flowered2020_popmeans$percent_flowered_sqrt <- flowered2020_popmeans$percent_flowered^(1/2)
```

####### ANOVA
```{r}
# full model
car::Anova(lm(percent_flowered^0.5 ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")))
summary(lm(percent_flowered^0.5 ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")))
AIC(lm(percent_flowered^0.5 ~ City_dist * Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")))
# not significant


# just main effects
car::Anova(lm(percent_flowered^0.5 ~ City_dist + Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")))
summary(lm(percent_flowered^0.5 ~ City_dist + Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")))
AIC(lm(percent_flowered^0.5 ~ City_dist + Transect_ID, data = flowered2020_popmeans %>% filter(Transect_ID != "Rural")))
# not significant
# AIC <2 less than full model... this is the best model

```



##### glmer
###### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Flowered2020 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = reproductive_alive2020,
  family = binomial,
  nAGQ=0)

car::Anova(glmer(Flowered2020 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = reproductive_alive2020,
  family = binomial,
  nAGQ=0))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(Flowered2020 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = reproductive_alive2020,
  family = binomial,
  nAGQ=0)

car::Anova(glmer(Flowered2020 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = reproductive_alive2020,
  family = binomial,
  nAGQ=0))
# nothing significant


# ranova(glmer(Flowered2020 ~ (1|Population/Family), data = reproductive_alive2020, REML = T, family = binomial))

# ranova(lmer(Flowered2020 ~ (1|Population/Family), data = reproductive_alive2020, REML = T))
```

###### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Flowered2020  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = reproductive_alive2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# is singular w/the glmerControl added; doesn't converge without it!

car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = reproductive_alive2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
  data = reproductive_alive2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = reproductive_alive2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings!!

car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = reproductive_alive2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = reproductive_alive2020 %>% dplyr::filter(., Transect_ID != "Rural"),
                 family = binomial,
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


AIC(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
                 data = reproductive_alive2020 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial,
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(Flowered2020  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = reproductive_alive2020 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial,
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC <2 apart; both "best models" though just main effects lower AIC
```

## Heights
### June height
#### lm
##### Gradient
###### Diagnostics
```{r}
height_June_2020_lm_gradient <- lm(mean_height_June ~ City_dist, data = heights_both2020_popmeans)

summary(height_June_2020_lm_gradient, na.rm = T)
par(mfrow=c(2,2))
plot(height_June_2020_lm_gradient, na.rm = T)

hist(heights_both2020_popmeans$mean_height_June)
ggqqplot(heights_both2020_popmeans$mean_height_June)
## looks good!

gg_reshist(height_June_2020_lm_gradient, bins=20)

diagnostic(residuals(height_June_2020_lm_gradient))

# no transformation needed.
```


###### ANOVA
```{r}
car::Anova(height_June_2020_lm_gradient)
## distance marginally significant

summary(height_June_2020_lm_gradient)

```
##### Urban subtransects
###### Diagnostics
```{r}
height_June_2020_lm_subtr <- lm(mean_height_June ~ City_dist * Transect_ID, data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural"))

summary(height_June_2020_lm_subtr, na.rm = T)
par(mfrow=c(2,2))
plot(height_June_2020_lm_subtr, na.rm = T)
## looks good!

gg_reshist(height_June_2020_lm_subtr, bins=20)

diagnostic(residuals(height_June_2020_lm_subtr))

# no transformation needed.
```


###### ANOVA
```{r}
# FULL MODEL
car::Anova(height_June_2020_lm_subtr)
## distance marginally significant
summary(height_June_2020_lm_subtr)
AIC(height_June_2020_lm_subtr)


# MAIN EFFECTS ONLY
car::Anova(lm(mean_height_June ~ City_dist + Transect_ID,
              data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural")))
## distance marginally significant
summary(lm(mean_height_June ~ City_dist + Transect_ID,
              data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural")))
AIC(lm(mean_height_June ~ City_dist + Transect_ID,
              data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural")))


# AIC within 2 for both models (both are "best")
```
#### lmer
##### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F)
# is singular...

car::Anova(lmer(Total_Height_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F))
# distance is marginally significant


r.squaredGLMM(lmer(Total_Height_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_June ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_June ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F))
# distance is marginally significant




# ANy variation within families or populations?
m.1 <- lmer(Total_Height_June ~ (1|Population/Family), data = heights_both, REML = T)

ranova(m.1)
# YES for within families
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_June  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_June  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_June ~ (1|Population/Family), data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families

m.2 <- lmer(Total_Height_June ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects though


m.3 <- lmer(Total_Height_June ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

### Sept height
#### lm
##### Gradient
###### Diagnostics
```{r}
height_Sept_2020_lm_gradient <- lm(mean_height_Sept ~ City_dist, data = heights_both2020_popmeans)

summary(height_Sept_2020_lm_gradient, na.rm = T)
par(mfrow=c(2,2))
plot(height_Sept_2020_lm_gradient, na.rm = T)

hist(heights_both2020_popmeans$mean_height_Sept)
ggqqplot(heights_both2020_popmeans$mean_height_Sept)
## looks good!

gg_reshist(height_Sept_2020_lm_gradient, bins=20)

diagnostic(residuals(height_Sept_2020_lm_gradient))

# no transformation needed.
```


###### ANOVA
```{r}
car::Anova(height_Sept_2020_lm_gradient)
## distance marginally significant

summary(height_Sept_2020_lm_gradient)

```

##### Urban subtransects
###### Diagnostics
```{r}
height_Sept_2020_lm_subtr <- lm(mean_height_Sept ~ City_dist * Transect_ID, data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural"))

summary(height_Sept_2020_lm_subtr, na.rm = T)
par(mfrow=c(2,2))
plot(height_Sept_2020_lm_subtr, na.rm = T)
## looks good!

gg_reshist(height_Sept_2020_lm_subtr, bins=20)

diagnostic(residuals(height_Sept_2020_lm_subtr))

# no transformation needed.
```


###### ANOVA
```{r}
# FULL MODEL
car::Anova(height_Sept_2020_lm_subtr)
## distance marginally significant
summary(height_Sept_2020_lm_subtr)
AIC(height_Sept_2020_lm_subtr)


# MAIN EFFECTS ONLY
car::Anova(lm(mean_height_Sept ~ City_dist + Transect_ID,
              data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural")))
## distance marginally significant
summary(lm(mean_height_Sept ~ City_dist + Transect_ID,
              data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural")))
AIC(lm(mean_height_Sept ~ City_dist + Transect_ID,
              data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural")))


# AIC within 2 for both models (both are "best")
```

#### lmer
##### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F)
# is singular...

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F))
# distance is marginally significant


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F))
# distance is marginally significant

r.squaredGLMM(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F))

# ANy variation within families or populations?
m.1 <- lmer(Total_Height_Sept ~ (1|Population/Family), data = heights_both, REML = T)

ranova(m.1)
# YES for among families (marginally sig)
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_Sept ~ (1|Population/Family), data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families (marg sig)

m.2 <- lmer(Total_Height_Sept ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects though


m.3 <- lmer(Total_Height_Sept ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```


## Weevil scars: standardized by June height
### lm
#### Gradient
##### Diagnostics
```{r}
wvlscars_2020_lm_gradient <- lm(mean_scar_div_Juneheight ~ City_dist, data = weevil_both2020_popmeans)

summary(wvlscars_2020_lm_gradient, na.rm = T)
par(mfrow=c(2,2))
plot(wvlscars_2020_lm_gradient, na.rm = T)

hist(weevil_both2020_popmeans$mean_scar_div_Juneheight)
ggqqplot(weevil_both2020_popmeans$mean_scar_div_Juneheight)
## looks great!

gg_reshist(wvlscars_2020_lm_gradient, bins=20)

diagnostic(residuals(wvlscars_2020_lm_gradient))

# no transformation needed.
```


##### ANOVA
```{r}
car::Anova(wvlscars_2020_lm_gradient)
## nothing significant

summary(wvlscars_2020_lm_gradient)

```
#### Urban subtransects
##### Diagnostics
```{r}
wvlscars_2020_lm_subtr <- lm(mean_scar_div_Juneheight ~ City_dist * Transect_ID, data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"))

summary(wvlscars_2020_lm_subtr, na.rm = T)
par(mfrow=c(2,2))
plot(wvlscars_2020_lm_subtr, na.rm = T)
## looks good!

gg_reshist(wvlscars_2020_lm_subtr, bins=20)

diagnostic(resid(wvlscars_2020_lm_subtr))

# no transformation needed.
```


##### ANOVA
```{r}
# FULL MODEL
car::Anova(wvlscars_2020_lm_subtr)
## nothing significant
summary(wvlscars_2020_lm_subtr)
AIC(wvlscars_2020_lm_subtr)


# MAIN EFFECTS ONLY
car::Anova(lm(mean_scar_div_Juneheight ~ City_dist + Transect_ID,
              data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")))
## distance marginally significant
summary(lm(mean_scar_div_Juneheight ~ City_dist + Transect_ID,
              data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")))
AIC(lm(mean_scar_div_Juneheight ~ City_dist + Transect_ID,
              data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")))


# AIC within 2 for both models (both are "best")
```
### lmer
#### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(scar_div_Juneheight ~ (1|Block) + (1|Population/Family) + City_dist,
  data = weevil_both, REML = F)
# is singular...

car::Anova(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population/Family) + City_dist,
  data = weevil_both, REML = F))
# nothing significant


### CROSSED RANDOM EFFECTS-----
lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F)
# NOT singular!

car::Anova(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))
# nothing significant
summary(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))


r.squaredGLMM(lmer(scar_div_Juneheight ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))


# ANy variation within families or populations?
m.1 <- lmer(scar_div_Juneheight ~ (1|Population/Family), data = weevil_both, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

#### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# is singular

car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(scar_div_Juneheight  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best model"



# ANy variation among families or populations?
m.1 <- lmer(scar_div_Juneheight ~ (1|Population/Family), data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no, is singular

m.2 <- lmer(scar_div_Juneheight ~ (1|Population/Family) + Transect_ID, data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects though


m.3 <- lmer(scar_div_Juneheight ~ (1|Population/Family) + Transect_ID, data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevildivheight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

## Weevil scars: NOT standardized by June height
### lm
#### Gradient
##### Diagnostics
```{r}
wvlscars2_2020_lm_gradient <- lm(mean_scar ~ City_dist, data = weevil_both2020_popmeans)

summary(wvlscars2_2020_lm_gradient, na.rm = T)
par(mfrow=c(2,2))
plot(wvlscars2_2020_lm_gradient, na.rm = T)

hist(weevil_both2020_popmeans$mean_scar)
ggqqplot(weevil_both2020_popmeans$mean_scar)
## looks great!

gg_reshist(wvlscars2_2020_lm_gradient, bins=20)

diagnostic(residuals(wvlscars2_2020_lm_gradient))

# no transformation needed.
```


##### ANOVA
```{r}
car::Anova(wvlscars2_2020_lm_gradient)
## nothing significant

summary(wvlscars2_2020_lm_gradient)

```
#### Urban subtransects
##### Diagnostics
```{r}
wvlscars2_2020_lm_subtr <- lm(mean_scar ~ City_dist * Transect_ID, data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"))

summary(wvlscars2_2020_lm_subtr, na.rm = T)
par(mfrow=c(2,2))
plot(wvlscars2_2020_lm_subtr, na.rm = T)
## looks good!

gg_reshist(wvlscars2_2020_lm_subtr, bins=20)

diagnostic(resid(wvlscars2_2020_lm_subtr))
# minor transformation could be good


# trying a sqrt transformation
diagnostic(resid(lm(mean_scar^(1/2) ~ City_dist * Transect_ID, data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"))))
gg_reshist((lm(mean_scar^(1/2) ~ City_dist * Transect_ID, data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"))), bins = 20)
plot(lm(mean_scar^(1/2) ~ City_dist * Transect_ID, data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")), na.rm = T)
## looks good, will use this

weevil_both2020_popmeans$mean_scar_sqrt <- (weevil_both2020_popmeans$mean_scar)^(1/2)

```


##### ANOVA
```{r}
# FULL MODEL
car::Anova(lm(mean_scar_sqrt ~ City_dist * Transect_ID, data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")))
## nothing significant
summary(lm(mean_scar_sqrt ~ City_dist * Transect_ID, data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")))
AIC(lm(mean_scar_sqrt ~ City_dist * Transect_ID, data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")))


# MAIN EFFECTS ONLY
car::Anova(lm(mean_scar_sqrt ~ City_dist + Transect_ID,
              data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")))
## nothing significant
summary(lm(mean_scar_sqrt ~ City_dist + Transect_ID,
              data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")))
AIC(lm(mean_scar_sqrt ~ City_dist + Transect_ID,
              data = weevil_both2020_popmeans %>% filter(Transect_ID != "Rural")))


# AIC within 2 for both models (both are "best")
```
### lmer
#### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Scar_length_cm ~ (1|Block) + (1|Population/Family) + City_dist,
  data = weevil_both, REML = F)
# NOT singular

car::Anova(lmer(Scar_length_cm ~ (1|Block) + (1|Population/Family) + City_dist,
  data = weevil_both, REML = F))
# nothing significant


### CROSSED RANDOM EFFECTS-----
lmer(Scar_length_cm ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F)
# NOT singular

car::Anova(lmer(Scar_length_cm ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))
# nothing significant


r.squaredGLMM(lmer(Scar_length_cm ~ (1|Block) + (1|Population:Family) + City_dist,
  data = weevil_both, REML = F))

# ANy variation within families or populations?
m.1 <- lmer(Scar_length_cm ~ (1|Population/Family), data = weevil_both, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

#### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Scar_length_cm  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# NOT singular

car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings

car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Scar_length_cm  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best model"




# ANy variation among families or populations?
m.1 <- lmer(Scar_length_cm ~ (1|Population/Family), data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Scar_length_cm ~ (1|Population/Family) + Transect_ID, data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects either


m.3 <- lmer(Scar_length_cm ~ (1|Population/Family) + Transect_ID, data = weevil_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_Weevil_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

## Herbivores: RDA
### Examine herbivore distributions
```{r}
library(purrr)
library(tidyr)
library(ggplot2)

herbivores2020_popmeans %>%
dplyr::select(., c(3:13)) %>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram(bins = 20)
# few vars normally distributed


# Aphis asclepiadis
a.ascl_lm <- lm(mean_Aphis_asclepiadis ~ City_dist, herbivores2020_popmeans)
gg_reshist(lm(a.ascl_lm), bins = 20)
diagnostic(residuals(a.ascl_lm))
# definitely transform... very right-skewed

# cube root
par(mfrow=c(2,2))
diagnostic(residuals(lm(mean_Aphis_asclepiadis^(1/3) ~ City_dist, herbivores2020_popmeans)))
gg_reshist(lm(mean_Aphis_asclepiadis^(1/3) ~ City_dist, herbivores2020_popmeans), bins = 20)


# log
par(mfrow=c(2,2))
diagnostic(residuals(lm(log(mean_Aphis_asclepiadis + 1) ~ City_dist, herbivores2020_popmeans)))
gg_reshist(lm(log(mean_Aphis_asclepiadis + 1) ~ City_dist, herbivores2020_popmeans), bins = 20)

manova(cbind(Sepal.Length, Petal.Length) ~ Species, data = iris)
```

### RDA
```{r}

herbpopMeansJuly_PCA <- prcomp(as.matrix(herbivores2020_popmeansJuly[,c(4:15)]))
summary(herbpopMeansJuly_PCA) # 17.3% variation explained by PC1

herbpopMeansAug_PCA <- prcomp(as.matrix(herbivores2020_popmeansAug[,c(4:15)]))
summary(herbpopMeansAug_PCA) # 18.4% variation explained by PC1

# trait_loadings <- herbpopMeansAug_PCA$rotation[,'PC1']






hist(herbivores$Lygaeus_kalmii)

glmer(City_dist ~  (1|Block) + (1|Sample) + (1|Population/Family) + Lygaeus_kalmii,
  data = herbivores, family = 'poisson')


# JULY
herbivores2020_popmeansJuly <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'July')

rda_herb_July <- rda(herbivores2020_popmeansJuly %>%
                        dplyr::select(, c(4:14)) ~ herbivores2020_popmeansJuly$City_dist,
                na.action = "na.omit",
                scale = TRUE)

summary(rda_herb_July)

RsquareAdj(rda_herb_July)


plot(rda_herb_July, type='n', scaling=1)
orditorp(rda_herb_July, display='sp', cex=0.5, scaling=1, col='blue')
text(rda_herb_July, display='cn', col='red')






# AUGUST

herbivores2020_popmeansAug <- herbivores2020_popmeans %>%
  dplyr::filter(., Sample == 'August')

rda_herb_August <- rda(herbivores2020_popmeansAug %>%
                        dplyr::select(, c(4:14)) ~ herbivores2020_popmeansAug$City_dist,
                na.action = "na.omit",
                scale = TRUE)

summary(rda_herb_August)
rda_herb_August

RsquareAdj(rda_herb_August)


plot(rda_herb_August, type='n', scaling=1)
orditorp(rda_herb_August, display='sp', cex=0.5, scaling=1, col='blue')
text(rda_herb_August, display='cn', col='red')
```

## Herbivory
### July
#### lm
##### Gradient
###### Diagnostics
```{r}
herbivory_July_2020_lm_gradient <- lm(Herbivory.July_mean ~ City_dist, data = herbivory2020_popmeans)

summary(herbivory_July_2020_lm_gradient, na.rm = T)
par(mfrow=c(2,2))
plot(herbivory_July_2020_lm_gradient, na.rm = T)

hist(herbivory2020_popmeans$Herbivory.July_mean)
ggqqplot(herbivory2020_popmeans$Herbivory.July_mean)
## looks good!

gg_reshist(herbivory_July_2020_lm_gradient, bins=20)

diagnostic(residuals(herbivory_July_2020_lm_gradient))

# no transformation needed. but there is an outlier... see what ANOVA output looks like w/o it
lm(Herbivory.July_mean ~ City_dist, data = herbivory2020_popmeans %>% filter(Herbivory.July_mean < 10))

gg_reshist(lm(Herbivory.July_mean ~ City_dist, data = herbivory2020_popmeans %>% filter(Herbivory.July_mean < 10)), bins=10)

diagnostic(residuals(lm(Herbivory.July_mean ~ City_dist, data = herbivory2020_popmeans %>% filter(Herbivory.July_mean < 10))))
# try sqrt transformation still


diagnostic(residuals(lm(Herbivory.July_mean^(1/2) ~ City_dist, data = herbivory2020_popmeans %>% filter(Herbivory.July_mean < 10))))

gg_reshist(lm(Herbivory.July_mean^(1/2) ~ City_dist, data = herbivory2020_popmeans %>% filter(Herbivory.July_mean < 10)), bins = 10)
# looks fine

```


###### ANOVA
```{r}
car::Anova(herbivory_July_2020_lm_gradient)
## distance significant!

summary(herbivory_July_2020_lm_gradient)


# remove outlier & sqrt it:
car::Anova(lm(Herbivory.July_mean^(1/2) ~ City_dist, data = herbivory2020_popmeans %>% filter(Herbivory.July_mean < 10)))
## distance marginally significant

summary(lm(Herbivory.July_mean^(1/2) ~ City_dist, data = herbivory2020_popmeans %>% filter(Herbivory.July_mean < 10)))

```

##### Urban subtransects
###### Diagnostics
```{r}
herbivory_July_2020_lm_subtr <- lm(Herbivory.July_mean ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural"))

summary(herbivory_July_2020_lm_subtr, na.rm = T)
par(mfrow=c(2,2))
plot(herbivory_July_2020_lm_subtr, na.rm = T)
## looks good!

gg_reshist(herbivory_July_2020_lm_subtr, bins=20)

diagnostic(residuals(herbivory_July_2020_lm_subtr))

# no transformation needed.
```


###### ANOVA
```{r}
# FULL MODEL
car::Anova(herbivory_July_2020_lm_subtr)
## nothing significant
summary(herbivory_July_2020_lm_subtr)
AIC(herbivory_July_2020_lm_subtr)


# MAIN EFFECTS ONLY
car::Anova(lm(Herbivory.July_mean ~ City_dist + Transect_ID,
              data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))
## nothing significant
AIC(lm(Herbivory.July_mean ~ City_dist + Transect_ID,
              data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))


# AIC within 2 for both models (both are "best")
```
#### lmer
##### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory.July_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_alive, REML = F)
# is singular...

car::Anova(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_alive, REML = F))
# distance is significant


### CROSSED RANDOM EFFECTS-----
lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_alive, REML = F)
# NOT singular!

car::Anova(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_alive, REML = F))
# distance is significant

summary(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_alive, REML = F))


r.squaredGLMM(lmer(Herbivory.July_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_alive, REML = F))



# ANy variation within families or populations?
m.1 <- lmer(Herbivory.July_mean ~ (1|Population/Family), data = herbivory_both_alive, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance is significant


# Just main effects
car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... distance is significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

lmer(Herbivory.July_mean  ~ (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

lmer(Herbivory.July_mean  ~ (1|Population:Family) + Block + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

# try making a unique family identifier and removing pop
trial1 <- herbivory_both_alive %>%
  dplyr::filter(., Transect_ID != "Rural") %>%
  unite("Family_Unique", c(Population,Family), remove = FALSE)

lmer(Herbivory.July_mean  ~ (1|Family_Unique) + Transect_ID,
     data = trial1, REML = F)
# still singular, even with block and distance removed...



car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance is significant


# Just main effects
car::Anova(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... distance is significant


AIC(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory.July_mean  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though full model has lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Herbivory.July_mean ~ (1|Population/Family), data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Herbivory.July_mean ~ (1|Population/Family) + Transect_ID, data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects either


m.3 <- lmer(Herbivory.July_mean ~ (1|Population/Family) + Transect_ID, data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivoryJuly_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

### Sept
#### lm
##### Gradient
###### Diagnostics
```{r}
herbivory_Sept_2020_lm_gradient <- lm(Herbivory.Sept_mean ~ City_dist, data = herbivory2020_popmeans)

summary(herbivory_Sept_2020_lm_gradient, na.rm = T)
par(mfrow=c(2,2))
plot(herbivory_Sept_2020_lm_gradient, na.rm = T)

hist(herbivory2020_popmeans$Herbivory.Sept_mean)
ggqqplot(herbivory2020_popmeans$Herbivory.Sept_mean)
## looks good except for some outliers... or maybe it's just right-skewed?

boxplot.stats(herbivory2020_popmeans$Herbivory.Sept_mean)
# 4 outliers... I think I should keep them

gg_reshist(herbivory_Sept_2020_lm_gradient, bins=20)

diagnostic(residuals(herbivory_Sept_2020_lm_gradient))

# no transformation needed.

```


###### ANOVA
```{r}
car::Anova(herbivory_Sept_2020_lm_gradient)
## nothing significant

summary(herbivory_Sept_2020_lm_gradient)




# just going to see what happens if I remove the 4 outliers and then do anova...
herbivory_Sept_2020_lm_gradient_nooutliers <- lm(Herbivory.Sept_mean ~ City_dist, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20))

gg_reshist(herbivory_Sept_2020_lm_gradient_nooutliers, bins = 20)
diagnostic(residuals(herbivory_Sept_2020_lm_gradient_nooutliers))

car::Anova(herbivory_Sept_2020_lm_gradient_nooutliers)
# same results





# BUT WAIT: When I don't remove the outliers, the Sept herbivory is predicted by the number of replicates... which I think means that the low replicate pops are driving the herbivory trends...
plot(Herbivory.Sept_mean ~ sum_replicates, herbivory2020_popmeans)
car::Anova(lm(Herbivory.Sept_mean ~ sum_replicates, herbivory2020_popmeans))

# when I remove the outliers, the issue goes away
plot(Herbivory.Sept_mean ~ sum_replicates, herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20))
car::Anova(lm(Herbivory.Sept_mean ~ sum_replicates, herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20)))
```

##### Urban subtransects
###### Diagnostics
```{r}
herbivory_Sept_2020_lm_subtr <- lm(Herbivory.Sept_mean ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural"))

summary(herbivory_Sept_2020_lm_subtr, na.rm = T)
par(mfrow=c(2,2))
plot(herbivory_Sept_2020_lm_subtr, na.rm = T)
## looks good except for a couple outliers

boxplot.stats(herbivory2020_popmeans$Herbivory.Sept_mean[which(herbivory2020_popmeans$Transect_ID != "Rural")])
# 2 outliers

gg_reshist(herbivory_Sept_2020_lm_subtr, bins=20)

diagnostic(residuals(herbivory_Sept_2020_lm_subtr))

# try with transformation to reduce right skew, try without any transformation, and try ANOVA just w/removed outliers.


# SQRT TRANSFORMATION
gg_reshist(lm(Herbivory.Sept_mean^(1/2) ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")), bins = 25)

diagnostic(residuals(lm(Herbivory.Sept_mean^(1/2) ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural"))))
# looks good as far as diagnostics go...


# REMOVE OUTLIERS
lm(Herbivory.Sept_mean ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20 & Transect_ID != "Rural"))

gg_reshist(lm(Herbivory.Sept_mean ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20 & Transect_ID != "Rural")), bins = 20)

diagnostic(residuals(lm(Herbivory.Sept_mean ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20 & Transect_ID != "Rural"))
))
# looks fine
```


###### ANOVA
```{r}
# all three options have same result: nothing significant
# NO TRANSFORMATION--------
# FULL MODEL
car::Anova(herbivory_Sept_2020_lm_subtr)
## nothing significant
summary(herbivory_Sept_2020_lm_subtr)
AIC(herbivory_Sept_2020_lm_subtr)


# MAIN EFFECTS ONLY
car::Anova(lm(Herbivory.Sept_mean ~ City_dist + Transect_ID,
              data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))
summary(lm(Herbivory.Sept_mean ~ City_dist + Transect_ID,
              data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))
## nothing significant
AIC(lm(Herbivory.Sept_mean ~ City_dist + Transect_ID,
              data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))


# AIC within 2 for both models (both are "best")
# SQRT TRANSFORMATION--------
# FULL MODEL
car::Anova(lm(Herbivory.Sept_mean^(1/2) ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))
## nothing significant
summary(lm(Herbivory.Sept_mean^(1/2) ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))
AIC(lm(Herbivory.Sept_mean^(1/2) ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))


# MAIN EFFECTS ONLY
car::Anova(lm(Herbivory.Sept_mean^(1/2) ~ City_dist + Transect_ID, data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))
## nothing significant
AIC(lm(Herbivory.Sept_mean^(1/2) ~ City_dist + Transect_ID, data = herbivory2020_popmeans %>% filter(Transect_ID != "Rural")))


# AIC within 2 for both models (both are "best")

# REMOVED OUTLIERS--------

lm(Herbivory.Sept_mean ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20 & Transect_ID != "Rural"))

# FULL MODEL
car::Anova(lm(Herbivory.Sept_mean ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20 & Transect_ID != "Rural")))
## nothing significant
summary(lm(Herbivory.Sept_mean ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20 & Transect_ID != "Rural")))
AIC(lm(Herbivory.Sept_mean ~ City_dist * Transect_ID, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20 & Transect_ID != "Rural")))


# MAIN EFFECTS ONLY
car::Anova(lm(Herbivory.Sept_mean ~ City_dist + Transect_ID, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20 & Transect_ID != "Rural"))
)
## nothing significant
AIC(lm(Herbivory.Sept_mean ~ City_dist + Transect_ID, data = herbivory2020_popmeans %>% filter(Herbivory.Sept_mean < 20 & Transect_ID != "Rural")))


# AIC within 2 for both models (both are "best")

```
#### lmer
##### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_alive, REML = F)
# is singular...

car::Anova(lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_alive, REML = F))
# nothing is significant

r.squaredGLMM(lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herbivory_both_alive, REML = F))
  

### CROSSED RANDOM EFFECTS-----
lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_alive, REML = F)
# NOT singular!

car::Anova(lmer(Herbivory.Sept_mean ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herbivory_both_alive, REML = F))
# distance not significant



# ANy variation within families or populations?
m.1 <- lmer(Herbivory.Sept_mean ~ (1|Population/Family), data = herbivory_both_alive, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance is significant


# Just main effects
car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... distance is significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular...

car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance is significant


# Just main effects
car::Anova(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... distance is significant


AIC(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Herbivory.Sept_mean  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though main effects model has lower AIC


# ANy variation among families or populations?
m.1 <- lmer(Herbivory.Sept_mean ~ (1|Population/Family), data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Herbivory.Sept_mean ~ (1|Population/Family) + Transect_ID, data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects either


m.3 <- lmer(Herbivory.Sept_mean ~ (1|Population/Family) + Transect_ID, data = herbivory_both_alive %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_HerbivorySept_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)

```

## Growth Rate
### lm- haven't completed. worth doing if all I'm using the means for is a fig?
#### Gradient
##### Diagnostics
```{r}
# growthrate_2020_lm_gradient <- lm(mean_rel_growth_rate ~ City_dist, data = heights_both2020_popmeans)
# 
# summary(growthrate_2020_lm_gradient, na.rm = T)
# par(mfrow=c(2,2))
# plot(growthrate_2020_lm_gradient, na.rm = T)
# # pop 54 is an outlier bc there's only one replicate there...
# 
# hist(heights_both2020_popmeans$mean_rel_growth_rate)
# ggqqplot(heights_both2020_popmeans$mean_rel_growth_rate)
# ## looks good!
# 
# gg_reshist(growthrate_2020_lm_gradient, bins=20)
# 
# diagnostic(residuals(growthrate_2020_lm_gradient))
# 
# # no transformation needed.
```


##### ANOVA
```{r}
# car::Anova(height_June_2020_lm_gradient)
# ## distance marginally significant
# 
# summary(height_June_2020_lm_gradient)

```
#### Urban subtransects
##### Diagnostics
```{r}
# height_June_2020_lm_subtr <- lm(mean_height_June ~ City_dist * Transect_ID, data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural"))
# 
# summary(height_June_2020_lm_subtr, na.rm = T)
# par(mfrow=c(2,2))
# plot(height_June_2020_lm_subtr, na.rm = T)
# ## looks good!
# 
# gg_reshist(height_June_2020_lm_subtr, bins=20)
# 
# diagnostic(residuals(height_June_2020_lm_subtr))
# 
# # no transformation needed.
```


##### ANOVA
```{r}
# # FULL MODEL
# car::Anova(height_June_2020_lm_subtr)
# ## distance marginally significant
# summary(height_June_2020_lm_subtr)
# AIC(height_June_2020_lm_subtr)
# 
# 
# # MAIN EFFECT- HS ONLY
# car::Anova(lm(mean_height_June ~ City_dist + Transect_ID,
#               data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural")))
# ## distance marginally significant
# summary(lm(mean_height_June ~ City_dist + Transect_ID,
#               data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural")))
# AIC(lm(mean_height_June ~ City_dist + Transect_ID,
#               data = heights_both2020_popmeans %>% filter(Transect_ID != "Rural")))
# 
# 
# # AIC within 2 for both models (both are "best")
```
### lmer
#### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F)
# is singular...

lmer(rel_growth_rate ~ (1|Population/Family) + City_dist,
  data = heights_both, REML = F)
# still singular


car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F))
# not significant


r.squaredGLMM(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F)
#  singular

lmer(rel_growth_rate ~ (1|Population:Family) + City_dist,
  data = heights_both, REML = F)
#  singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F))
# not sig



# ANy variation within families or populations?
m.1 <- lmer(rel_growth_rate ~ (1|Population/Family), data = heights_both, REML = T)

ranova(m.1)
# nope
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

#### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

lmer(rel_growth_rate  ~ (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing sig


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular, nothing sig



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

lmer(rel_growth_rate  ~ (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# NOT singular!


car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant

car::Anova(lmer(rel_growth_rate  ~ (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular... nothing sig

car::Anova(lmer(rel_growth_rate  ~ (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# NOT SINGULAR!  nothing sig


AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC >2 apart; just main effects lower AIC = best model





# ANy variation among families or populations?
m.1 <- lmer(rel_growth_rate ~ (1|Population/Family), data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(rel_growth_rate ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects either


m.3 <- lmer(rel_growth_rate ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_growthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

## Number of Ramets
### June ramets
#### lmer
##### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# no warning!

car::Anova(lmer(Ramets_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


r.squaredGLMM(lmer(Ramets_June ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))

### CROSSED RANDOM EFFECTS-----
lmer(Ramets_June ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# NOT singular!

car::Anova(lmer(Ramets_June ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


# Any variation within families or populations?
m.1 <- lmer(Ramets_June ~ (1|Population/Family), data = heights_both, REML = T)

ranova(m.1)
# YES- marg sig among families
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_June  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# No warnings!!

car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# nothing significant


AIC(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))

AIC(lmer(Ramets_June  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Ramets_June ~ (1|Population/Family), data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Ramets_June ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects 


m.3 <- lmer(Ramets_June ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_JuneRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

### Sept ramets
#### lmer
##### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F)
# is singular...

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F))
# distance is significant


r.squaredGLMM(lmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_both, REML = F))


### CROSSED RANDOM EFFECTS-----
lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
#  singular

car::Anova(lmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_both, REML = F), control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
# distance is significant


# ANy variation within families or populations?
m.1 <- lmer(Ramets_Sept ~ (1|Population/Family), data = heights_both, REML = T)

ranova(m.1)
# no
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

##### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance significant


# Just main effects
car::Anova(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# distance significant


AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Ramets_Sept ~ (1|Population/Family), data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# no

m.2 <- lmer(Ramets_Sept ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = F, control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
car::Anova(m.2)
# not among transects 


m.3 <- lmer(Ramets_Sept ~ (1|Population/Family) + Transect_ID, data = heights_both %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/Chapter2_KSR/Figures_Tables/ranova_PVE/2020_SeptRamets_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```


## Survival
### glmer
#### Entire gradient: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(dead_2020 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = survival_2020,
  family = binomial,
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# CONVERGES when I set nAGQ to 0

car::Anova(glmer(dead_2020 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = survival_2020,
  family = binomial,
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(dead_2020 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = survival_2020,
  family = binomial,
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# no problems


car::Anova(glmer(dead_2020 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = survival_2020,
  family = binomial,
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant




# ranova(glmer(Flowered2020 ~ (1|Population/Family), data = reproductive_alive2020, REML = T, family = binomial))

# ranova(lmer(Flowered2020 ~ (1|Population/Family), data = reproductive_alive2020, REML = T))
```

#### Urban subtransects: ANOVA
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(dead_2020  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# no problems!

car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings

car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial,
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),
                 family = binomial,
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


AIC(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
                 data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial,
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(dead_2020  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = survival_2020 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial,
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC <2 apart; both "best models" though just main effects lower AIC
```


# Figures
## reproductive
### Plants that flowered: Regressions
#### Percent flowering plants/pop
##### Entire gradient
```{r}
ggplot(flowered2020_popmeans, aes(x = City_dist, y = percent_flowered)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Percent Flowering Plants/Population") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 

```

##### Urban subtransects
```{r}
ggplot(flowered2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = percent_flowered)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Percent Flowering Plants/Population") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```


#### Mean flower count
##### Entire gradient
```{r}
ggplot(flowering_2020, aes(x = City_dist, y = mean_flower_count)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower count/inflorescence") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 

```


##### Urban subtransects
```{r}
ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_flower_count)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower count/inflorescence") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```

#### Total flower count
##### Entire gradient
```{r}
ggplot(flowering_2020, aes(x = City_dist, y = total_flower_count)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Total flower count") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 



```


##### Urban subtransects
```{r}
ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = total_flower_count)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Total flower count") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```


#### Mean flower size
##### Entire gradient
```{r}
ggplot(flowering_2020, aes(x = City_dist, y = Overall_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower size") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 



# COMBINING INTO ONE FIGURE (do a PCA instead)
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower size") +
  geom_point(aes(x = City_dist, y = Overall_mean), size=2, color = 'orange', data = flowering_2020) +
  geom_point(aes(x = City_dist, y = Flower_mean), size=2, color = 'blue', data = flowering_2020) +
  geom_point(aes(x = City_dist, y = Corolla_mean), size=2, color = 'green', data = flowering_2020) +
  geom_point(aes(x = City_dist, y = Hood_mean), size=2, color = 'purple', data = flowering_2020) +
  # xlim(0, 71) +
  # ylim(0, 120) +
  geom_smooth(aes(x = City_dist, y = Overall_mean), size=0.75, method = lm, alpha=.15, se = T, data = flowering_2020) +
  geom_smooth(aes(x = City_dist, y = Flower_mean), size=0.75, method = lm, alpha=.15, se = T, data = flowering_2020) +
  geom_smooth(aes(x = City_dist, y = Corolla_mean), size=0.75, method = lm, alpha=.15, se = T, data = flowering_2020) +
  geom_smooth(aes(x = City_dist, y = Hood_mean), size=0.75, method = lm, alpha=.15, se = T, data = flowering_2020) +
  theme_bw() 
  # theme(text = element_text(size=12)) +
  # scale_shape_manual(values = c(21, 24),
  #                    breaks = c("June", "September"),
  #                      labels = c("June", "September"),
  #                      name = "Legend") +
  # scale_color_manual(values = c("blue", "orange"),
  #                    breaks = c("June", "September"),
  #                      labels = c("June", "September"),
  #                      name = "Legend") +
  # scale_fill_manual(values = c("blue", "orange"),
  #                    breaks = c("June", "September"),
  #                      labels = c("June", "September"),
  #                      name = "Legend")
```


##### Urban subtransects
```{r}
ggplot(flowering_2020 %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = Overall_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean flower size") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```



### Plants that flowered: Boxplots
#### Mean flower count
##### Urban subtransects
```{r}
library(viridis)

flowering_2020 %>%
  filter(Transect_ID != "Rural") %>%
  ggplot( aes(x=Transect_ID, y=mean_flower_count, fill=Transect_ID)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    geom_jitter(color="black", size=2, alpha=0.5) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    xlab("")
```

#### Plants that flowered: Older figures (may not want to use)
```{r}

# Basic scatterplot 
ggplot(DC2_2020, aes(x=City_dist, y=Flowered2020)) +
  geom_jitter(aes(colour = Transect_ID, shape = Flowered2020))

# Basic bar graph
ggplot(DC2_flowering_2020, aes(x=Urb_Rur)) + 
  geom_bar(color = 'black', fill = 'grey' ) +
  ylim(0,24) +
  labs(x = "Sample Site Environment",
       y = "2020 Flowering Plants") +
  theme(legend.position = 'None',
        text = element_text(size=14),
        axis.text = element_text(size = 13)) 
# +  geom_text(aes(label=unique(Urb_Rur)), position=position_dodge(width=0.9))

## splitting subtransect
ggplot(DC2_flowering_2020, aes(x=Urb_Rur, fill=Transect_ID )) + 
  geom_bar( ) +
  ylim(0,24) +
  labs(x = "Sample Site Environment",
       y = "2020 Flowering Plants") +
  scale_fill_discrete(name  ="Sample Site Subtransect",
                      breaks = c("North", "South", "Rural"),
                      labels=c("Urban: Non-Corridor", "Urban: Corridor", "Rural"))


```

## Height
### Regressions
#### Each point is a population mean
##### Entire gradient
```{r}
# JUNE HEIGHT
## Multiple R-squared:  0.05561
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(0, 60) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 



# SEPT HEIGHT
# Multiple R-squared:  0.05979
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "September: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(0, 120) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect")




# COMBINING INTO ONE FIGURE
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean height (cm)") +
  geom_point(aes(x = City_dist, y = mean_height_June, fill = 'June', shape = 'June'), size=2, data = heights_both2020_popmeans) +
  geom_point(aes(x = City_dist, y = mean_height_Sept, fill = 'September', shape = 'September' ), size=2, data = heights_both2020_popmeans) +
 # scale_shape(aes(x = City_dist, y = mean_height_June), solid = T, data = heights_both2020_popmeans)+
 # scale_shape(aes(x = City_dist, y = mean_height_Sept), solid = F, data = heights_both2020_popmeans)+
  xlim(0, 71) +
  ylim(0, 120) +
  geom_smooth(aes(x = City_dist, y = mean_height_June, fill = 'June', color = 'June'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  geom_smooth(aes(x = City_dist, y = mean_height_Sept, fill = 'September', color = 'September'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(21, 24),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_color_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_fill_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") 
```

##### Urban subtransects
```{r}
# JUNE HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 60) +
  theme_bw() +
  theme(text = element_text(size=12),
        legend.position = 'none') +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")



# sept HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 120) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```







##### OLD 
```{r}
###### gradient ########

# get p-val and r-sq
modsum1 <- lm(Total_Height ~ City_dist, SSE_pops_height_2020)
modsum <- summary(modsum1)
r2 = modsum$adj.r.squared 
r2 # = 0.0004816329
my.p = modsum$coefficients[2,4]
my.p # = 0.3171817

# Means w/error bars scatterplot w/regression line
heights_mean_plot1 <- ggplot(SSE_pops_height_2020, aes(x=City_dist, y=Total_Height)) + 
  geom_point(stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=Total_Height-se, ymax=Total_Height+se), width = 0.5) +
    geom_smooth(color = "red", method = lm,  se = FALSE) +
  theme(text = element_text(size=14)) +
  labs(x = "Distance to Urban Center (km)",
    y="Cumulative \n Ramet Length (cm)")  +
  ylim(0,150)





###### Urban subtransects ########

## subset of only urban subtransects:
SSE_pops_height_2020_urban <- SSE_pops_height_2020 %>% filter(Transect_ID != 'Rural')

# get p-val and r-sq
modsum1 <- lm(Total_Height ~ City_dist, SSE_pops_height_2020_urban)
modsum <- summary(modsum1)
r2 = modsum$adj.r.squared 
r2 # = 0.01678901
my.p = modsum$coefficients[2,4]
my.p # = 0.2229868

## With error bars
heights_mean_urban_plot1 <- ggplot(SSE_pops_height_2020_urban, aes(x=City_dist, y=Total_Height, color= Transect_ID)) + 
  geom_point(aes(colour=Transect_ID, shape=Transect_ID, fill=Transect_ID), size = 3, stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin=Total_Height-se, ymax=Total_Height+se), width = 0.5) +
    geom_smooth( method = lm, se = F) +
  theme(text = element_text(size=14),
        legend.position = c(0.65, 0.9),
        legend.direction = "horizontal") +
  labs(x = "Distance to Urban Center (km)",
    y="Cumulative \n Ramet Length (cm)") +
  scale_shape_discrete(name  ="Sample Site Subtransect",
                       breaks = c("North", "South"),
                       labels=c("Urban: Non-Corridor", "Urban: Corridor")) +
  scale_colour_discrete(name  ="Sample Site Subtransect",
                        breaks = c("North", "South"),
                        labels=c("Urban: Non-Corridor", "Urban: Corridor")) +
  scale_fill_discrete(name  ="Sample Site Subtransect",
                        breaks = c("North", "South"),
                        labels=c("Urban: Non-Corridor", "Urban: Corridor"))
```

#### Each point is a family mean
##### Entire gradient
```{r}
# JUNE HEIGHT
## Multiple R-squared:  0.05561
ggplot(heights_both2020_familymeans, aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(0, 60) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 



# SEPT HEIGHT
# Multiple R-squared:  0.05979
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "September: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(0, 120) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect")




# COMBINING INTO ONE FIGURE
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean height (cm)") +
  geom_point(aes(x = City_dist, y = mean_height_June, fill = 'June', shape = 'June'), size=2, data = heights_both2020_popmeans) +
  geom_point(aes(x = City_dist, y = mean_height_Sept, fill = 'September', shape = 'September' ), size=2, data = heights_both2020_popmeans) +
 # scale_shape(aes(x = City_dist, y = mean_height_June), solid = T, data = heights_both2020_popmeans)+
 # scale_shape(aes(x = City_dist, y = mean_height_Sept), solid = F, data = heights_both2020_popmeans)+
  xlim(0, 71) +
  ylim(0, 120) +
  geom_smooth(aes(x = City_dist, y = mean_height_June, fill = 'June', color = 'June'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  geom_smooth(aes(x = City_dist, y = mean_height_Sept, fill = 'September', color = 'September'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(21, 24),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_color_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_fill_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") 
```

##### Urban subtransects
```{r}
# JUNE HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 60) +
  theme_bw() +
  theme(text = element_text(size=12),
        legend.position = 'none') +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")



# sept HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 120) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```



## Weevil damage
### Standardized by June height
#### Regressions
##### Entire gradient
```{r}
# Multiple R-squared: 0.0008
ggplot(weevil_both2020_popmeans, aes(x = City_dist, y = mean_scar_div_Juneheight)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Weevil scar length/cm") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  # xlim(0, 71) +
  # ylim(0, 120) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect")

```

##### Urban subtransects
```{r}

# R-squared = 0.04079
ggplot(weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_scar_div_Juneheight)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Weevil scar length/cm") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  # xlim(0, 35) +
  ylim(0, 0.2) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```

### NOT Standardized by June height
#### Regressions
##### Entire gradient
```{r}
# Multiple R-squared: 0.003591
ggplot(weevil_both2020_popmeans, aes(x = City_dist, y = mean_scar)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Total weevil scar length") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  # xlim(0, 71) +
  # ylim(0, 120) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect")

```

##### Urban subtransects
```{r}
ggplot(weevil_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_scar)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Total weevil scar length") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  # xlim(0, 35) +
  # ylim(0, 0.2) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```

## Herbivory
### Regressions
#### Entire gradient
```{r}
# JULY HERBIVORY
## NO TRANSFORMATIONS OR OUTLIERS REMOVED-----
## Multiple R-squared: 0.08834
ggplot(herbivory2020_popmeans, aes(x = City_dist, y = Herbivory.July_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(0, 15) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 

## OUTLIER REMOVED & SQRT IN ANOVA-----
## Multiple R-squared: 
ggplot(herbivory2020_popmeans %>% filter(Herbivory.July_mean < 10), aes(x = City_dist, y = Herbivory.July_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "July: Mean Herbivory") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  #ylim(0, 15) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 










# SEPT HEIGHT-----
# Multiple R-squared:  0.01975
ggplot(herbivory2020_popmeans, aes(x = City_dist, y = Herbivory.Sept_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  # ylim(0, 120) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect")




# COMBINING INTO ONE FIGURE-----
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  geom_point(aes(x = City_dist, y = Herbivory.July_mean, fill = 'July', shape = 'July'), size=2, data = herbivory2020_popmeans) +
  geom_point(aes(x = City_dist, y = Herbivory.Sept_mean, fill = 'September', shape = 'September' ), size=2, data = herbivory2020_popmeans) +
 # scale_shape(aes(x = City_dist, y = mean_height_June), solid = T, data = heights_both2020_popmeans)+
 # scale_shape(aes(x = City_dist, y = mean_height_Sept), solid = F, data = heights_both2020_popmeans)+
  xlim(0, 71) +
  # ylim(0, 120) +
  geom_smooth(aes(x = City_dist, y = Herbivory.July_mean, fill = 'July', color = 'July'), size=0.75, method = lm, alpha=.15, se = T, data = herbivory2020_popmeans) +
  geom_smooth(aes(x = City_dist, y = Herbivory.Sept_mean, fill = 'September', color = 'September'), size=0.75, method = lm, alpha=.15, se = T, data = herbivory2020_popmeans) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(21, 24),
                     breaks = c("July", "September"),
                       labels = c("July", "September"),
                       name = "Legend") +
  scale_color_manual(values = c("blue", "orange"),
                     breaks = c("July", "September"),
                       labels = c("July", "September"),
                       name = "Legend") +
  scale_fill_manual(values = c("blue", "orange"),
                     breaks = c("July", "September"),
                       labels = c("July", "September"),
                       name = "Legend") 
```

#### Urban subtransects
```{r}
# JULY HERBIVORY

ggplot(herbivory2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = Herbivory.July_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 15) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")



# sept herbivory

ggplot(herbivory2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = Herbivory.Sept_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean Herbivory") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 40) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```


## No. of Ramets
### Regressions
#### Each point is a population mean
##### Entire gradient
```{r}
# JUNE RAMETS
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_Ramets_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean No. Ramets") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=1.5) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(0, 5) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 



# SEPT ramets
ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_Ramets_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "September: Mean No. Ramets") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(0, 4) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect")




# COMBINING INTO ONE FIGURE
ggplot() + 
  labs(x = "Distance to urban center (km)", 
    y = "Mean No. Ramets") +
  geom_point(aes(x = City_dist, y = mean_Ramets_June, fill = 'June', shape = 'June'), size=2, data = heights_both2020_popmeans) +
  geom_point(aes(x = City_dist, y = mean_Ramets_Sept, fill = 'September', shape = 'September' ), size=2, data = heights_both2020_popmeans) +
 # scale_shape(aes(x = City_dist, y = mean_height_June), solid = T, data = heights_both2020_popmeans)+
 # scale_shape(aes(x = City_dist, y = mean_height_Sept), solid = F, data = heights_both2020_popmeans)+
  xlim(0, 71) +
  ylim(0, 5) +
  geom_smooth(aes(x = City_dist, y = mean_Ramets_June, fill = 'June', color = 'June'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  geom_smooth(aes(x = City_dist, y = mean_Ramets_Sept, fill = 'September', color = 'September'), size=0.75, method = lm, alpha=.15, se = T, data = heights_both2020_popmeans) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(21, 24),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_color_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") +
  scale_fill_manual(values = c("blue", "orange"),
                     breaks = c("June", "September"),
                       labels = c("June", "September"),
                       name = "Legend") 
```

##### Urban subtransects
```{r}
# JUNE ramets
p1 <- ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_Ramets_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean No. Ramets") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 4.2) +
  theme_bw() +
  theme(text = element_text(size=12),
        legend.position = 'none') +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")



# sept ramets
p2 <- ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_Ramets_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean No. Ramets") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 4) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")


library(patchwork)
p1 + p2
```


#### Each point is a family mean
##### Entire gradient
```{r}
# JUNE HEIGHT
ggplot(ramets_2020_familymeans_stats, aes(x = City_dist, y = Ramets_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean No. Ramets") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=1.5) +
  scale_shape(solid = F)+
  geom_errorbar(aes(ymin=Ramets_June-se.June, ymax=Ramets_June+se.June), width = 0.25) +
  xlim(0, 71) +
  ylim(0, 8) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 


# SEPT HEIGHT
ggplot(ramets_2020_familymeans_stats, aes(x = City_dist, y = Ramets_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean No. Ramets") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=1.5) +
  scale_shape(solid = F)+
  geom_errorbar(aes(ymin=Ramets_June-se.Sept, ymax=Ramets_June+se.Sept), width = 0.25) +
  xlim(0, 71) +
  ylim(0, 8) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 

```

##### Urban subtransects
```{r}
# JUNE HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_June)) + 
  labs(x = "Distance to urban center (km)", 
    y = "June: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 60) +
  theme_bw() +
  theme(text = element_text(size=12),
        legend.position = 'none') +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")



# sept HEIGHT

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_height_Sept)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Sept: Mean height (cm)") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  ylim(0, 120) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")
```



## Growth rate
### Regressions
#### Entire gradient
```{r}

ggplot(heights_both2020_popmeans, aes(x = City_dist, y = mean_rel_growth_rate)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Relative Growth Rate") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  ylim(-0.01, 0.015) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 


```

#### Urban subtransects
```{r}

ggplot(heights_both2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = mean_rel_growth_rate)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Relative Growth Rate") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  # ylim(0, 15) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")

```



## Survival
### Regressions
#### Entire gradient
```{r}
# normal plot
ggplot(survival2020_popmeans, aes(x = City_dist, y = survival_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mortality") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  # ylim(-0.01, 0.015) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") 

# points sized by # replicates/pop
ggplot(survival2020_popmeans, aes(x = City_dist, y = survival_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mortality") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID, size= sum_replicates)) +
  scale_shape(solid = F)+
  xlim(0, 71) +
  # ylim(-0.01, 0.015) +
  geom_smooth(size=0.75, method = lm, alpha=.15, se = T, color = 'black') +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2, 5),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("black", "#333333", "#666666"),
                     breaks = c("North", "South", "Rural"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                       name = "Sample Site Subtransect")
```

#### Urban subtransects
```{r}

ggplot(survival2020_popmeans %>% filter(Transect_ID != "Rural"), aes(x = City_dist, y = survival_mean)) + 
  labs(x = "Distance to urban center (km)", 
    y = "Mortality") +
  geom_point(aes(color = Transect_ID, shape = Transect_ID), size=2) +
  scale_shape(solid = F)+
  geom_smooth(aes(linetype = Transect_ID, color = Transect_ID, fill = Transect_ID),size=0.75, method = lm, alpha=.15, se = T) +
  xlim(0, 35) +
  # ylim(0, 15) +
  theme_bw() +
  theme(text = element_text(size=12)) +
  scale_shape_manual(values = c(1, 2),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_color_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_linetype_manual(values = c("solid", "dashed"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect") +
  scale_fill_manual(values = c("red", "blue"),
                     breaks = c("North", "South"),
                       labels = c("Urban: Non-Corridor", "Urban: Corridor"),
                       name = "Sample Site Subtransect")

```


