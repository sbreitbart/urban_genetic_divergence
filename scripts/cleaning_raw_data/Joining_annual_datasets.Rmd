---
title: "Joining Annual Datasets"
author: "Sophie Breitbart"
date: "2/24/2022"
output: html_document
---

In this script, datasets from each year are merged so that (almost) each trait has its own full dataset. I also remove some (14) rows that have the same Population, Family, and Replicate ID (in pairs of 2 rows each). These duplication errors probably occurred while plant pots were being labelled and/or recorded during the first field season.

# Create duplicate data table
```{r}
# Row 7,  Col 39: 19  5 3
# Row 20, Col 6 : 19  5 3
# 
# Row 1,  Col 41: 23  1 5
# Row 5,  Col 12: 23  1 5
# 
# Row 14, Col 37: 35  4 2
# Row 21, Col 33: 35  4 2
# 
# Row 14, Col 12:	35	3	1
# Row 21, Col 25:	35	3	1
# 
# Row 14, Col 43:	41	1	2
# Row 16, Col 13:	41	1	2
# 
# Row 12, Col 29:	41	1	3
# Row 15, Col 3	: 41	1	3
# 
# Row 11, Col 43:	41	1	4
# Row 13, Col 4	: 41	1	4

repeats <- data.frame(Population  = c(19, 23, 35, 35, 41, 41, 41),
                      Family =      c(5, 1, 4, 3, 1, 1, 1),
                      Replicate =   c(3, 5, 2, 1, 2, 3, 4)
                      )
```


# Import data
## 2019
```{r}
data_2019 <- read.csv(here::here("./CommonGardenExperiment_2019Data/clean_data/clean_data_2019KSR.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -c(1:2)) %>%
  anti_join(., repeats)

```

## 2020
```{r}
# DEFENSE
herbivory_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_herbivory_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  anti_join(., repeats)

weevil_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_weevil_damage_clean.csv")) %>%
  dplyr::select(., -c(1:2, 13)) %>%
  anti_join(., repeats)



# REPRODUCTIVE
reproductive_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_reproductive_clean.csv")) %>%
  dplyr::select(., -c(1:2, 12)) %>%
  anti_join(., repeats)

flowering_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_floweringplants_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  anti_join(., repeats)




# GROWTH
heights_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_heights_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  anti_join(., repeats)

survival_2020 <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_survival_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  anti_join(., repeats)
```

## 2021
```{r}
# DEFENSE
herbivory_2021 <- read.csv(here::here("./CommonGardenExperiment_2021Data/clean_data/2021_herbivory_clean.csv")) %>%
  dplyr::select(., -c(1, 21)) %>%
  anti_join(., repeats)

weevil_2021 <- read.csv(here::here("./CommonGardenExperiment_2021Data/clean_data/2021_weevil_damage_clean.csv")) %>%
  dplyr::select(., -c(1, 18)) %>%
  anti_join(., repeats)



# REPRODUCTIVE
reproductive_2021 <- read.csv(here::here("./CommonGardenExperiment_2021Data/clean_data/2021_reproductive_clean.csv")) %>%
  dplyr::select(., -c(1, 16)) %>%
  anti_join(., repeats)

flowering_2021 <- read.csv(here::here("./CommonGardenExperiment_2021Data/clean_data/2021_floweringplants_clean.csv")) %>%
  dplyr::select(-1) %>%
  anti_join(., repeats)



# GROWTH
heights_2021 <- read.csv(here::here("./CommonGardenExperiment_2021Data/clean_data/2021_heights_clean.csv")) %>%
  dplyr::select(., -c(1, 22)) %>%
  anti_join(., repeats)

survival_2021 <- read.csv(here::here("./CommonGardenExperiment_2021Data/clean_data/2021_survival_clean.csv")) %>%
  dplyr::select(., -c(1, 12)) %>%
  anti_join(., repeats)
```


# Join datasets
## Herbivory
```{r}
# make copy of data_2019 with consistent colnames
herb_2019 <- data_2019 %>%
  dplyr::select(., c(1:6, 18:19, 21, 32, 35:41)) %>%
  dplyr::filter(., Dead_2019 == 0) %>%
  dplyr::rename(., Dead = Dead_2019,
                Herbivory_mean_late = Herbivory_mean_DC3) %>%
  dplyr::mutate(Year = "2019") %>%
  dplyr::mutate_at(vars(Herbivory_mean_late), as.character) %>%
  dplyr::mutate_at(vars(Herbivory_mean_late), as.numeric) %>%
  dplyr::mutate_at(vars(Population, Family, Replicate), as.factor)
str(herb_2019)

# copy of 2020 data w/consistent colnames
herb_2020 <- herbivory_2020 %>%
  dplyr::select(., -c(8:9, 11:13, 18)) %>%
  dplyr::rename(., Herbivory_mean_late = Herbivory.Sept_mean) %>%
  dplyr::rename(., Herbivory_mean_early = Herbivory.July_mean) %>%
  dplyr::rename(., Herbivory_late = Herbivory.Sept) %>%
  dplyr::rename(., Herbivory_early = Herbivory.July) %>%
  dplyr::mutate(Year = "2020")%>%
  dplyr::mutate_at(vars(Herbivory_mean_early,
                        Herbivory_mean_late), as.character) %>%
  dplyr::mutate_at(vars(Herbivory_mean_early,
                        Herbivory_mean_late), as.numeric) %>%
  dplyr::mutate_at(vars(Population, Family, Replicate), as.factor)

# copy of 2021 data w/consistent colnames
herb_2021 <- herbivory_2021 %>%
  dplyr::select(., -c(1, 8:9, 12, 15:17)) %>%
  dplyr::rename(., Herbivory_mean_late = Herbivory.late_mean) %>%
  dplyr::rename(., Herbivory_mean_early = Herbivory.early_mean) %>%
  dplyr::rename(., Herbivory_late = Herbivory.late) %>%
  dplyr::rename(., Herbivory_early = Herbivory.early) %>%
  dplyr::mutate(Year = "2021")%>%
  dplyr::mutate_at(vars(Herbivory_mean_late), as.character) %>%
  dplyr::mutate_at(vars(Herbivory_mean_late), as.numeric) %>%
  dplyr::mutate_at(vars(Population, Family, Replicate), as.factor)


# combine yearly dfs
herbivory_19_20_21 <- rbind.fill(herb_2019, herb_2020, herb_2021) %>%
  dplyr::select(-c(10, 15, 19, 24:25)) %>%
  dplyr::select(c(1:6, 9, 19, 16, 10:15, 7:8, 17:18, 20))
```

## Weevil damage
```{r}
# not measured in 2019

weev_2020 <- weevil_2020 %>%
    dplyr::rename(., Total_Height_early = Total_Height_June) %>%
    dplyr::rename(., scar_div_earlyheight = scar_div_Juneheight)

weevil_20_21 <- rbind.fill(weev_2020, weevil_2021[,-c(8:13)])
```

## Reproductive traits
```{r}
# not measured in 2019
reproductive_2020 %<>%
  dplyr::rename(., Flowered = Flowered2020) %>%
  dplyr::select(-7)

reproductive_2021 %<>%
  dplyr::rename(., Flowered = Flowered2021) %>%
  dplyr::select(-c(9:13))

reprod_20_21 <- rbind.fill(reproductive_2020, reproductive_2021)

```

## Flowering
```{r}
# not measured in 2019
flowering_2020 %<>%
  dplyr::rename(., Flowered = Flowered2020) %>%
  dplyr::select(-"X") %>%
  dplyr::select(-c(7, 12, 13))

flowering_2021 %<>%
  dplyr::rename(., Flowered = Flowered2021) %>%
  dplyr::select(-"X")

flowering_20_21 <- rbind.fill(flowering_2020, flowering_2021)
```

## Height
```{r}
# make copy of data_2019 with consistent colnames
height_2019 <- data_2019 %>%
  dplyr::select(., c(1:6, 18:19, 25:41)) %>%
  dplyr::filter(., Dead_2019 == 0) %>%
  dplyr::rename(., Dead = Dead_2019,
                Ramets_veryearly = Num_Ramets_DC1,
                Ramets_early = Num_Ramets_DC2,
                Ramets_late = Num_Ramets_DC3,
                Total_Height_late = Total_height_DC3) %>%
  # make height measurements (first 2) in cm, not mm
  dplyr::mutate(Total_Height_veryearly = Total_Height_DC1/100,
                Total_Height_early = Total_Height_DC2/100,
                Year = "2019") %>%
  dplyr::mutate_at(vars(rel_growth_rate), as.character) %>%
  dplyr::mutate_at(vars(rel_growth_rate), as.numeric) %>%
  dplyr::mutate_at(vars(Population, Family, Replicate, Year), as.factor) %>%
  dplyr::select(-c("Dead","Total_Height_DC1","Total_Height_DC2"))

str(height_2019)


# copy of 2020 data w/consistent colnames
height_2020 <- heights_2020 %>%
  dplyr::select(., -c(7,9,11,16)) %>%
  dplyr::rename(., Ramets_early = Ramets_June,
                Total_Height_early = Total_Height_June,
                Ramets_late = Ramets_Sept,
                Total_Height_late = Total_Height_Sept) %>%
  dplyr::mutate(Year = "2020") %>%
  dplyr::mutate_at(vars(Population, Family, Replicate, Year), as.factor)%>%
  dplyr::mutate_at(vars(rel_growth_rate), as.character) %>%
  dplyr::mutate_at(vars(rel_growth_rate), as.numeric)

str(height_2020)

# copy of 2021 data w/consistent colnames
height_2021 <- heights_2021 %>%
  dplyr::select(., -c(8:11, 14:16)) %>%
  # dplyr::rename(., Ramets_early = Ramets_June,
  #               Total_Height_early = Total_Height_June,
  #               Ramets_late = Ramets_Sept,
  #               Total_Height_late = Total_Height_Sept) %>%
  dplyr::mutate(Year = "2021") %>%
  dplyr::mutate_at(vars(Population, Family, Replicate, Year), as.factor)%>%
  dplyr::mutate_at(vars(rel_growth_rate), as.character) %>%
  dplyr::mutate_at(vars(rel_growth_rate), as.numeric)

str(height_2021)


# combine yearly dfs
heights_19_20_21 <- rbind.fill(height_2019, height_2020, height_2021)
```

## Survival
```{r}
## first make copy of data_clean_2019 with colnames that match heights_both_2020's
surv_2019 <- data_clean_2019 %>%
  dplyr::select(., c(1:6, 14:16, 25, 32, 35:41)) %>%
  dplyr::rename(., Dead = Dead_2019                )
surv_2019$Year = 2019

# copy of 2020 data w/colnames that match 2019's
surv_2020 <- survival_2020 %>%
  dplyr::select(., -c(12)) %>%
  dplyr::rename(., Dead = dead_2020 # doing thisto compare btwn years
                )
surv_2020$Year = 2020

# combine yearly dfs
survival_19_20 <- rbind.fill(surv_2019, surv_2020)

# rm(surv_2019, surv_2020)

survival_19_20$Population <- as.factor(survival_19_20$Population)
survival_19_20$Family <- as.factor(survival_19_20$Family)
survival_19_20$Block <- as.factor(survival_19_20$Block)
survival_19_20$Year <- as.factor(survival_19_20$Year)

```

# Export
```{r}
write.csv(herbivory_19_20_21,
          here::here("./Joined_annual_data/herbivory.csv"))

write.csv(weevil_20_21,
          here::here("./Joined_annual_data/weevil.csv"))

write.csv(reprod_20_21,
          here::here("./Joined_annual_data/reproductive.csv"))

write.csv(flowering_20_21,
          here::here("./Joined_annual_data/flowering.csv"))

write.csv(heights_19_20_21,
          here::here("./Joined_annual_data/heights.csv"))
```
