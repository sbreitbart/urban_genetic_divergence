# Load libraries
```{r}
library(cowplot)
library(magick)



devtools::install_github('oswaldosantos/ggsn')

```

# Import data
```{r}
sites <- read.csv(here::here("./CommonGardenExperiment_2019Data/clean_data/clean_haversine_Distances.csv"), sep = ",", header = TRUE) %>%
  dplyr::select(-X)


urb_scores <- read.csv(
  here::here("./CommonGardenExperiment_2020Data/raw_data/Urbanization_Score/Urbanization_Scores_Table.csv"),  header=T, na.strings=c("","NA")) %>%
  dplyr::select(Patch_ID, Urb_score, City_dist, Transect)


sites %<>% 
  dplyr::inner_join(.,
                    urb_scores,
                    by = c("Pop_ID" = "Patch_ID")) 

```

# Make map
```{r}
# Make basemap of sampling sites-----
mylocation <- c(-80.19, 43.2, -79.2, 43.81)
base_map <- ggmap(get_map(location = mylocation,
                          maptype = 'terrain',
                          source = 'stamen'))
cols1 <- c("North" = "#FDE725FF",
           "South" = "#21908CFF", 
           "Rural" = "#660099")

map1 <- base_map +
  geom_point(data = sites,
             mapping = aes(x = Longitude, y = Latitude,
                           fill=Transect, shape=Transect),
             color = "black", size=3) +
  labs(x = 'Longitude', y = 'Latitude') +
  ggsn::scalebar(x.min = -80.19, x.max = -79.25,
           y.min = 43.25, y.max = 43.8,
           dist = 10, dist_unit = "km",
           st.bottom = FALSE, st.color = "black",
           transform = TRUE, model = 'WGS84',
           st.dist=.03) +
  theme(legend.position = c(0.75, 0.35),
        legend.background = element_rect(fill = "white",colour = "black"),
        legend.box.margin = margin(6, 6, 6, 6),
        legend.text = element_text(size=12),
        legend.title = element_text(size = 14),
        axis.text=element_text(size=12),
        axis.title=element_text(size=14)) +
  scale_fill_manual(values = cols1,
                    breaks = c("North", "South", "Rural"),
                    labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                    name = "Sample Site Subtransect") +
  scale_shape_manual(values = c(23,24,21),
                     breaks = c("North", "South", "Rural"),
                     labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                     name = "Sample Site Subtransect") 


north2(map1, x = .59, y = .2, scale = 0.11, symbol = 1)



# widen and add KSR pin-----

KSR_point <- data.frame(long = 44.026961,
                        lat = -79.541771)

mylocation_wider <- c(-80.3, 43.2, -79.1, 44.1)
base_map_full <- ggmap(get_map(location = mylocation_wider,
                          maptype = 'terrain',
                          source = 'stamen'))


map1_wider <- base_map_full +
  geom_point(data = sites,
             mapping = aes(x = Longitude, y = Latitude,
                           fill=Transect, shape=Transect),
             color = "black", size=3) + 
  
  # Add KSR point
  geom_label_repel(data = KSR_point,
    aes(lat, long),
    label = "Koffler Scientific\n Reserve",
     nudge_x = 0.18,
     nudge_y = -0.08,
    size = 4 ,
    fontface = "italic",
    segment.color = 'gray'
   ) +
  
  geom_star(data = KSR_point, 
             mapping = aes(x = lat, y = long),
             color = "black", fill = "orangered",
             size = 5 ) +

  labs(x = 'Longitude', y = 'Latitude') +

  ggsn::scalebar(x.min = -80.3, x.max = -79.85,
           y.min = 44.05, y.max = 44.1,
           height = 0.4, st.dist= 0.5,
           dist = 15, dist_unit = "km",
           st.bottom = TRUE, st.color = "black",
           st.size = 4,
           transform = TRUE, model = 'WGS84'
           ) +
  theme(#legend.position = c(0.32, 0.65),
        legend.position = c(0.75, 0.15),
        legend.background = element_rect(fill = "white",colour = "black"),
        legend.box.margin = margin(4,4,4,4),
        legend.text = element_text(size=11),
        legend.title = element_text(size = 12),
        axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
  scale_fill_manual(values = cols1,
                    breaks = c("North", "South", "Rural"),
                    labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                    name = "Sample Site Subtransect") +
  scale_shape_manual(values = c(23,24,21),
                     breaks = c("North", "South", "Rural"),
                     labels = c("Urban: Non-Corridor", "Urban: Corridor", "Rural"),
                     name = "Sample Site Subtransect") 
# map1_wider


ggsn::north2(map1_wider, x = .29, y = .8,
       scale = 0.11, symbol = 1)


# Export
dev.copy2pdf(file = here::here("./Figures_Tables/map/map.pdf"),
             width = 7, height = 5)
```

# Create inset of point in North America
```{r}

# # install.packages("maps")
# library(maps)
# 
# us = map_data("state")
# ca = map_data("world", "Canada")
# 
# xlim = c(-110,-100)
# ylim = c(40,60)
# dat_grid = expand.grid(x = xlim[1]:xlim[2], y = ylim[1]:ylim[2])
# 
# ggplot(aes(x=x,
#            y=y),
#            data=dat_grid) +
#   geom_polygon(data=us,
#                aes(x=long, y=lat, group=group), colour="black", fill="lightgrey") + 
#   geom_polygon(data=ca,
#                aes(x=long, y=lat, group=group), colour="black", fill="lightgrey") +
#   theme_pubclean()




mylocation_inset <- c(-95, 30, -60, 50)
base_map_inset <- ggmap(get_map(location = mylocation_inset,
                          maptype = 'toner-lite',
                          source = 'stamen',
                          color = "bw"))


map1_inset <- base_map_inset +
  
  # Add KSR point
  geom_star(data = KSR_point, 
             mapping = aes(x = lat, y = long),
             color = "black", fill = "orangered",
             size = 7 ) +

  labs(x = 'Longitude', y = 'Latitude') +

  theme(legend.position = "none",
        axis.text=element_text(size=12),
        axis.title=element_text(size=12)) +
    theme_void()
map1_inset


```

# Add inset to first map
```{r}

map1_wider +
    inset(ggplotGrob(map1_inset),
        xmin = -80,
        xmax = -80.25,
        ymin = 43.8,
        ymax = 44
    )

```

