# Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

# Import data
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_1yr_mods.Rmd", quiet=TRUE))

```

# Create tables with ANOVA results from all one-year models (lmers)
## Q1
### City_dist
#### Create 1-yr ANOVA table
```{r}
# perform tidy_anova on all list items (i.e., models)
anova_table_city <- all_1yr_mods %>% 
  lapply(., tidy_anova) %>%

# merge all items
  purrr::reduce(full_join
               # , all = T
                ) %>%

# make flextable
  dplyr::rename(Variable = 1) %>%
  dplyr::select(-Sites) %>%
  dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
      "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory after flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "poll")~
      "Pollinaria removed",
    str_detect(Variable, "Julian_first")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"
    )) 

anova_table_city %>%
  flextable() %>%
  theme_box() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 3:4, align = "center", part = "all") %>%
  hline(j = ~Variable, border = NULL, part = "body") %>%
  flextable::compose(i = 1, j = 3, part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  bold(i = ~ p <= 0.05, j = 4) %>%
  padding(padding = 3) %>%
  autofit() %T>%
  
# Export
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Citydist.docx"))
```

### Urb_score
#### Create 1-yr ANOVA table
```{r}
anova_table_usc <- all_1yr_mods.u %>% 
  lapply(., tidy_anova) %>%

  reduce(full_join
       #  , all = T
         ) %>%

  dplyr::rename(Variable = 1) %>%
  dplyr::select(-Sites) %>%
  dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory after flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "poll")~
      "Pollinaria removed",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "first_foll")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality" ))

anova_table_usc %>%
  flextable() %>%
  theme_box() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 3:4, align = "center", part = "all") %>%
  hline(j = ~Variable, border = NULL, part = "body") %>%
  flextable::compose(i = 1, j = 3, part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  bold(i = ~ p <= 0.05, j = 4) %>%
  padding(padding = 3) %>%
  autofit() %T>%
  
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Urbscore.docx"))
```

### Combine city_dist and Urb_score, remove block
```{r}
full_join(
  anova_table_city %>%
  dplyr::filter(Predictor == "Distance to City Center"),

  anova_table_usc %>%
  dplyr::filter(Predictor == "Urbanization Score")) %>%
  
  dplyr::rename("Chisq" = "Chi_sq") %>%
  
  pivot_wider(names_from = "Predictor", 
              values_from = c(Chisq, p)) %>%
  
  dplyr::rename("Dist_Chisq" = 2,
                "Usc_Chisq" = 3,
                "Dist_p" = 4,
                "Usc_p" = 5
                ) %>%
  dplyr::select(1,2,4,3,5) %>%
  flextable() %>%
  theme_box() %>%
  flextable::bold(i = ~ Dist_p <= 0.05, j = 3) %>%
  flextable::bold(i = ~ Usc_p <= 0.05, j = 5) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:5, align = "center", part = "body") %>%
  merge_h(i = 1, part = "header") %>%
  align(i = 2, align = "center", part = "header") %>%
  align(i = 1, align = "left", part = "header") %>%
  vline(j = 3, part = "all") %>%
  hline(border = NULL, part = "body") %>%
  flextable::compose(i = 2, j = c(2,4), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 2, part = "header",
                     value = as_paragraph("Distance")) %>%
  flextable::compose(i = 1, j = 4, part = "header",
                     value = as_paragraph("Urbanization Score")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %T>%
  
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_DistAndUrbsc_Q1.docx"))

```

### Combine city_dist and Urb_score, remove block, AND add N(indivs) and N(pops)
#### Get N and number of populations for each model
```{r}
obs_table <- map_dfr(all_1yr_mods,
                     ~ data.frame(
                       indivs = summary(.x)$nobs,
                       formula = toString(summary(.x)$call[2]),
                       pops = toString(summary(.x)$ngrps$cond['Population'])
                     )) %>%
  dplyr::mutate(Model = row_number(),
                Variable = str_extract(formula, "^[^~]+")) %>%
  dplyr::select(Model,
                Variable,
                indivs,
                pops) %>%
    dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory after flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "poll")~
      "Pollinaria removed",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "Julian_first")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"
    
    
    ))

```

#### Add Ns to table
```{r}
full_join(
  anova_table_city %>%
  dplyr::filter(Predictor == "Distance to City Center"),

  anova_table_usc %>%
  dplyr::filter(Predictor == "Urbanization Score")) %>%
  
  dplyr::rename("Chisq" = "Chi_sq") %>%
  
  pivot_wider(names_from = "Predictor", 
              values_from = c(Chisq, p)) %>%
  
  dplyr::rename("Dist_Chisq" = 2,
                "Usc_Chisq" = 3,
                "Dist_p" = 4,
                "Usc_p" = 5
                ) %>%
  dplyr::select(1,2,4,3,5) %>%
  dplyr::full_join(.,
                   obs_table %>%
                     dplyr::select(-Model),
                   by = "Variable")%>%
  flextable() %>%
  theme_box() %>%
  flextable::bold(i = ~ Dist_p <= 0.05, j = 3) %>%
  flextable::bold(i = ~ Usc_p <= 0.05, j = 5) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:7, align = "center", part = "body") %>%
  merge_h(i = 1, part = "header") %>%
  align(i = 2, align = "center", part = "header") %>%
  align(i = 1, align = "left", part = "header") %>%
  vline(j = 3, part = "all") %>%
  hline(border = NULL, part = "body") %>%
  flextable::compose(i = 2, j = c(2,4), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 2, part = "header",
                     value = as_paragraph("Distance")) %>%
  flextable::compose(i = 1, j = 4, part = "header",
                     value = as_paragraph("Urbanization Score")) %>%
  flextable::compose(i = 1, j = 6, part = "header",
                     value = as_paragraph("Individuals")) %>%
  flextable::compose(i = 1, j = 7, part = "header",
                     value = as_paragraph("Populations")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %T>%
  
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_DistAndUrbsc_Q1_with_Ns.docx"))

```

### Export block effects separately
```{r}
full_join(
  anova_table_city %>%
  dplyr::filter(Predictor == "Block") %>%
    dplyr::mutate("Block" = "BlockD"),

  anova_table_usc %>%
  dplyr::filter(Predictor == "Block") %>%
    dplyr::mutate("Block" = "BlockU")) %>%
  
  dplyr::select(-Predictor)%>%

  dplyr::rename("Chisq" = "Chi_sq") %>%
  
  pivot_wider(names_from = "Block", 
              values_from = c(Chisq, p)) %>%

  dplyr::select(1,2,4,3,5) %>%
  flextable() %>%
  theme_box() %>%
  flextable::bold(i = ~ p_BlockD <= 0.05, j = 3) %>%
  flextable::bold(i = ~ p_BlockU <= 0.05, j = 5) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:5, align = "center", part = "all") %>%
  hline(border = NULL, part = "body") %>%
  flextable::compose(i = 1, j = c(2,4), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  merge_h(i = 2, part = "header") %>%
  flextable::compose(i = 2, j = 2, part = "header",
                     value = as_paragraph("Distance")) %>%
  flextable::compose(i = 2, j = 4, part = "header",
                     value = as_paragraph("Urbanization Score")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %T>%
  
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Block_Q1.docx"))

```


## Q2
### City_dist
#### Create 1-yr ANOVA table
```{r}
# STEP 3: perform tidy_anova on all list items (i.e., models)
anova_table_city2 <- all_1yr_mods_tr %>% 
  lapply(., tidy_anova) %>%

# STEP 4: merge all items
  reduce(full_join
      #   , all = T
         )%>%

# STEP 5: make flextable
  dplyr::rename(Variable = 1) %>%
  dplyr::select(-Sites) %>% 
  dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory after flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "poll")~
      "Pollinaria removed",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "Julian_first")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"
    ))

anova_table_city2 %>%
  flextable() %>%
  theme_box() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 3:4, align = "center", part = "all") %>%
  hline(j = ~Variable, border = NULL, part = "body") %>%
  flextable::compose(i = 1, j = 3, part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  bold(i = ~ p <= 0.05, j = 4) %>%
  padding(padding = 3) %>%
  autofit() %T>%
  
# STEP 6: Export
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Citydist_transects.docx"))
```

### Urb_score
#### Create 1-yr ANOVA table
```{r}
# STEP 3: perform tidy_anova on all list items (i.e., models)
anova_table_usc2 <- all_1yr_mods.u_tr %>% 
  lapply(., tidy_anova) %>%

# STEP 4: merge all items
  reduce(full_join
       #  , all = T
         ) %>%

# STEP 5: make flextable
  dplyr::rename(Variable = 1) %>%
  dplyr::select(-Sites) %>%
  dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory after flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "poll")~
      "Pollinaria removed",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "Julian_first")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"
    ))

anova_table_usc2 %>%
  flextable() %>%
  theme_box() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 3:4, align = "center", part = "all") %>%
  hline(j = ~Variable, border = NULL, part = "body") %>%
  flextable::compose(i = 1, j = 3, part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  bold(i = ~ p <= 0.05, j = 4) %>%
  padding(padding = 3) %>%
  autofit() %T>%
  
# STEP 6: Export
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Urbscore_transects.docx"))
```

### Remove block & make tables in same style as for Q1 but separate city_dist and urb_score tables because they're larger now
```{r}
anova_table_city2_simpler <- anova_table_city2 %>%
  dplyr::filter(Predictor != "Block" &
                Predictor != "(Intercept)" &
                Predictor != "Sample")


anova_table_usc2_simpler <- anova_table_usc2 %>%
  dplyr::filter(Predictor != "Block" &
                Predictor != "(Intercept)" &
                Predictor != "Sample") 
  
# CITY_DIST
anova_table_city2_simpler %>%
  dplyr::rename("Chisq" = "Chi_sq") %>%

  pivot_wider(names_from = "Predictor", 
              values_from = c(Chisq, p)) %>%
  
  dplyr::rename("dist_chisq" = 2,
                "sub_chisq" = 3,
                "intx_chisq" = 4,
                "dist_p" = 5,
                "sub_p" = 6,
                "intx_p" = 7
                ) %>%
  dplyr::select(1,2,5,3,6,4,7) %>%
  flextable() %>%
  theme_box() %>%
  flextable::bold(i = ~ dist_p <= 0.05, j = 3) %>%
  flextable::bold(i = ~ sub_p <= 0.05, j = 5) %>%
  flextable::bold(i = ~ intx_p <= 0.05, j = 7) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:7, align = "center", part = "all") %>%
  merge_h(i = 1, part = "header") %>%
  align(i = 2, align = "center", part = "header") %>%
  align(i = 1, align = "left", part = "header") %>%
  vline(j = c(3, 5), part = "all") %>%
  hline(border = NULL, part = "body") %>%
  flextable::compose(i = 2, j = c(2,4,6), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 2, part = "header",
                     value = as_paragraph("Distance")) %>%
  flextable::compose(i = 1, j = 4, part = "header",
                     value = as_paragraph("Subtransect")) %>% 
  flextable::compose(i = 1, j = 6, part = "header",
                     value = as_paragraph("D x S")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %T>%
  
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Dist_Q2.docx"))




# URB_SCORE
anova_table_usc2_simpler %>%
  dplyr::rename("Chisq" = "Chi_sq") %>%

  pivot_wider(names_from = "Predictor", 
              values_from = c(Chisq, p)) %>%
  
  dplyr::rename("usc_chisq" = 2,
                "sub_chisq" = 3,
                "intx_chisq" = 4,
                "usc_p" = 5,
                "sub_p" = 6,
                "intx_p" = 7
                ) %>%
  dplyr::select(1,2,5,3,6,4,7) %>%
  flextable() %>%
  theme_box() %>%
  flextable::bold(i = ~ usc_p <= 0.05, j = 3) %>%
  flextable::bold(i = ~ sub_p <= 0.05, j = 5) %>%
  flextable::bold(i = ~ intx_p <= 0.05, j = 7) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:7, align = "center", part = "all") %>%
  merge_h(i = 1, part = "header") %>%
  align(i = 2, align = "center", part = "header") %>%
  align(i = 1, align = "left", part = "header") %>%
  vline(j = c(3, 5), part = "all") %>%
  hline(border = NULL, part = "body") %>%
  flextable::compose(i = 2, j = c(2,4,6), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 2, part = "header",
                     value = as_paragraph("Urbanization Score")) %>%
  flextable::compose(i = 1, j = 4, part = "header",
                     value = as_paragraph("Subtransect")) %>% 
  flextable::compose(i = 1, j = 6, part = "header",
                     value = as_paragraph("U x S")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %T>%
  
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Urbsc_Q2.docx"))

```

### Repeat the above block AND add N(indivs) and N(pops)
#### Get N and number of populations for each model
##### City_dist
```{r}
obs_table2 <- map_dfr(all_1yr_mods_tr,
                     ~ data.frame(
                       indivs = summary(.x)$nobs,
                       formula = toString(summary(.x)$call[2]),
                       pops = toString(summary(.x)$ngrps$cond['Population'])
                     )) %>%
  dplyr::mutate(Model = row_number(),
                Variable = str_extract(formula, "^[^~]+")) %>%
  dplyr::select(Model,
                Variable,
                indivs,
                pops) %>%
    dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory after flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "poll")~
      "Pollinaria removed",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "Julian_first")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"
    ))

```

##### Urb_score (the same, anyway)
```{r}
obs_table2_usc <- map_dfr(all_1yr_mods.u_tr,
                     ~ data.frame(
                       indivs = summary(.x)$nobs,
                       formula = toString(summary(.x)$call[2]),
                       pops = toString(summary(.x)$ngrps$cond['Population'])
                     )) %>%
  dplyr::mutate(Model = row_number(),
                Variable = str_extract(formula, "^[^~]+")) %>%
  dplyr::select(Model,
                Variable,
                indivs,
                pops) %>%
    dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory after flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "poll")~
      "Pollinaria removed",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "Julian_first")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"
    ))

```

#### Add Ns to table
##### City_dist
```{r}
anova_table_city2_simpler %>%
  dplyr::rename("Chisq" = "Chi_sq") %>%

  pivot_wider(names_from = "Predictor", 
              values_from = c(Chisq, p)) %>%
  
  dplyr::rename("dist_chisq" = 2,
                "sub_chisq" = 3,
                "intx_chisq" = 4,
                "dist_p" = 5,
                "sub_p" = 6,
                "intx_p" = 7
                ) %>%
  dplyr::select(1,2,5,3,6,4,7) %>%

  dplyr::full_join(.,
                   obs_table2 %>%
                     dplyr::select(-Model),
                   by = "Variable")%>%
  flextable() %>%
  theme_box() %>%
  flextable::bold(i = ~ dist_p <= 0.05, j = 3) %>%
  flextable::bold(i = ~ sub_p <= 0.05, j = 5) %>%
  flextable::bold(i = ~ intx_p <= 0.05, j = 7) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:9, align = "center", part = "all") %>%
  merge_h(i = 1, part = "header") %>%
  align(i = 2, align = "center", part = "header") %>%
  align(i = 1, align = "left", part = "header") %>%
  vline(j = c(3, 5, 7), part = "all") %>%
  hline(border = NULL, part = "body") %>%
  flextable::compose(i = 2, j = c(2,4,6), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 2, part = "header",
                     value = as_paragraph("Distance")) %>%
  flextable::compose(i = 1, j = 4, part = "header",
                     value = as_paragraph("Subtransect")) %>% 
  flextable::compose(i = 1, j = 6, part = "header",
                     value = as_paragraph("D x S")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  flextable::compose(i = 1, j = 8, part = "header",
                     value = as_paragraph("Individuals")) %>%
  flextable::compose(i = 1, j = 9, part = "header",
                     value = as_paragraph("Populations")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %T>%
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Dist_Q2_with_Ns.docx"))

```

##### Urb_score
```{r}
anova_table_usc2_simpler %>%
  dplyr::rename("Chisq" = "Chi_sq") %>%

  pivot_wider(names_from = "Predictor", 
              values_from = c(Chisq, p)) %>%
  
  dplyr::rename("dist_chisq" = 2,
                "sub_chisq" = 3,
                "intx_chisq" = 4,
                "dist_p" = 5,
                "sub_p" = 6,
                "intx_p" = 7
                ) %>%
  dplyr::select(1,2,5,3,6,4,7) %>%

  dplyr::full_join(.,
                   obs_table2 %>%
                     dplyr::select(-Model),
                   by = "Variable")%>%
  flextable() %>%
  theme_box() %>%
  flextable::bold(i = ~ dist_p <= 0.05, j = 3) %>%
  flextable::bold(i = ~ sub_p <= 0.05, j = 5) %>%
  flextable::bold(i = ~ intx_p <= 0.05, j = 7) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:9, align = "center", part = "all") %>%
  merge_h(i = 1, part = "header") %>%
  align(i = 2, align = "center", part = "header") %>%
  align(i = 1, align = "left", part = "header") %>%
  vline(j = c(3, 5, 7), part = "all") %>%
  hline(border = NULL, part = "body") %>%
  flextable::compose(i = 2, j = c(2,4,6), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 2, part = "header",
                     value = as_paragraph("Urbanization Score")) %>%
  flextable::compose(i = 1, j = 4, part = "header",
                     value = as_paragraph("Subtransect")) %>% 
  flextable::compose(i = 1, j = 6, part = "header",
                     value = as_paragraph("D x S")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  flextable::compose(i = 1, j = 8, part = "header",
                     value = as_paragraph("Individuals")) %>%
  flextable::compose(i = 1, j = 9, part = "header",
                     value = as_paragraph("Populations")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %T>%
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Usc_Q2_with_Ns.docx"))

```

### Export block effects separately
```{r}
full_join(
  anova_table_city2 %>%
  dplyr::filter(Predictor == "Block") %>%
    dplyr::mutate("Block" = "BlockD"),

  anova_table_usc2 %>%
  dplyr::filter(Predictor == "Block") %>%
    dplyr::mutate("Block" = "BlockU")) %>%
  
  dplyr::select(-Predictor)%>%

  dplyr::rename("Chisq" = "Chi_sq") %>%
  
  pivot_wider(names_from = "Block", 
              values_from = c(Chisq, p)) %>%

  dplyr::select(1,2,4,3,5) %>%
  flextable() %>%
  theme_box() %>%
  flextable::bold(i = ~ p_BlockD <= 0.05, j = 3) %>%
  flextable::bold(i = ~ p_BlockU <= 0.05, j = 5) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:5, align = "center", part = "all") %>%
  hline(border = NULL, part = "body") %>%
  flextable::compose(i = 1, j = c(2,4), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  merge_h(i = 2, part = "header") %>%
  flextable::compose(i = 2, j = 2, part = "header",
                     value = as_paragraph("Distance")) %>%
  flextable::compose(i = 2, j = 4, part = "header",
                     value = as_paragraph("Urbanization Score")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %T>%
  
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_Block_Q2.docx"))

```

# Create tables with ANOVA results from cardenolide models (lms)
## Q1, City_dist & Urb_score
### Create 1-yr ANOVA table (only 1 year of data anyway)
Not doing this for Q2 since sample size so small
```{r}

# anova on all list items (i.e., models)
flatten(all_card_models) %>% 
  lapply(., tidy_anova_cards) %>%

# merge all items
  reduce(full_join, all = T) %>%

# make flextable
  flextable() %>%
  #theme_box() %>%
  merge_v(j = ~Variable) %>% 
  hline(i = c(2,4,6), part = "body" ) %>%
  align(j = 3:6, align = "center", part = "all") %>%
  flextable::compose(i = 1, j = 6, part = "header",
                         value = as_paragraph(as_i("p"))) %>%
  bold(i = ~ p <= 0.05, j = 6) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %T>%
  
# STEP 6: Export
  flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/ANOVA_1yr/ANOVA_1yr_cardenolides.docx"))
```
