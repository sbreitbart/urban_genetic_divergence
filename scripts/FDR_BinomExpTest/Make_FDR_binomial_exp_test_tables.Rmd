# Load libraries
```{r}
source("libraries.R")
```

# Import data
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_1yr_mods.Rmd", quiet=TRUE))

# ONLY FOR Q1 for Cardenolides

# Best Models' p-values
## City_dist
card1 <- city_dist_list[["X6.6_main"]][[2]][["Pr(>F)"]][1] %>% as.character()

card2 <- city_dist_list[["X15_main"]][[2]][["Pr(>F)"]][1] %>% as.character()

card3 <- city_dist_list[["X17.6_main"]][[2]][["Pr(>F)"]][1] %>% as.character()

card4 <- city_dist_list[["total"]][[2]][["Pr(>F)"]][1] %>% as.character()

card_df <- data_frame(
  variable = c("cardenolide_6.6", "cardenolide_15", "cardenolide_17.6", "cardenolide_Total"),
  p = c(card1, card2, card3, card4))



## Urb_score
card1_u <- urb_score_list[["X6.6_main"]][[2]][["Pr(>F)"]][1] %>% as.character()

card2_u <- urb_score_list[["X15_main"]][[2]][["Pr(>F)"]][1] %>% as.character()

card3_u <- urb_score_list[["X17.6_main"]][[2]][["Pr(>F)"]][1] %>% as.character()

card4_u <- urb_score_list[["total"]][[2]][["Pr(>F)"]][1] %>% as.character()

card_df_u <- data_frame(
  variable = c("cardenolide_6.6", "cardenolide_15", "cardenolide_17.6", "cardenolide_Total"),
  p = c(card1_u, card2_u, card3_u, card4_u))
```

# Control the false discovery rate
The methods Holm, Hochberg, Hommel, and Bonferroni control the family-wise error rate.  These methods attempt to limit the probability of even one false discovery (a type I error, incorrectly rejecting the null hypothesis when there is no real effect), and so are all relatively strong (conservative).

The methods BH (Benjaminiâ€“Hochberg, which is the same as FDR in R) and BY control the false discovery rate.  These methods attempt to control the expected proportion of false discoveries.

(From this site: https://rcompanion.org/rcompanion/f_01.html)
## Extract p values where predictor = city_dist, then put into df
```{r}
# merge lists
# city_dist
all_best_mods <- do.call(c, list(best_growth_mods,
                                 best_defense_mods,
                                 best_repro_mods,
                                 best_herbivore_mods))

# urb_score
all_best_mods_u <- do.call(c, list(best_growth_mods_u,
                                 best_defense_mods_u,
                                 best_repro_mods_u,
                                 best_herbivore_mods_u))


# Question 1-----
extract_p_Q1 <- function(model){
 response_var <- tidy_anova(model) %>%
    dplyr::filter(Predictor == "Distance to City Center" | Predictor == "Urbanization Score") %>%
    dplyr::select(Response) %>%
  as.character()
    
  pval <- tidy_anova(model) %>%
    dplyr::filter(Predictor == "Distance to City Center" | Predictor == "Urbanization Score") %>%
    dplyr::select(p) %>%
  as.character()
  
  output_vector <- as.vector(c(response_var, pval))
  
  return(output_vector)
  
}

# city_dist
all_pvalues_Q1 <- sapply(all_1yr_mods,
                         extract_p_Q1) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename("variable" = 1,
                "p" = 2) %>%
  # add in cardenolide p values
  full_join(card_df, by = c("variable", "p")) %>%
  # order df by p-value
  dplyr::arrange(-desc(p)) %>%
# remove asterisk from a p-value
  dplyr::mutate(p = str_replace(
    p,
    "\\*",
    "")) %>%
  dplyr::mutate(p = as.numeric(p))


# urb_score
all_pvalues_Q1_u <- sapply(all_1yr_mods.u,
                         extract_p_Q1) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename("variable" = 1,
                "p" = 2) %>%
  # add in cardenolide p values
  full_join(card_df_u, by = c("variable", "p")) %>%
  # order df by p-value
  dplyr::arrange(-desc(p)) %>%
# remove asterisk from a p-value
  dplyr::mutate(p = str_replace(
    p,
    "\\*",
    "")) %>%
  dplyr::mutate(p = as.numeric(p))




# Question 2-----
extract_p_Q2 <- function(model){
 response_var <- tidy_anova(model) %>%
    dplyr::filter(row_number()==n()) %>% # take last row = either interaction or subtransect
    dplyr::select(Response) %>%
  as.character()
    
  pval <- tidy_anova(model) %>%
    dplyr::filter(row_number()==n()) %>% # take last row = either interaction or subtransect
    dplyr::select(p) %>%
  as.character()
  
  output_vector <- as.vector(c(response_var, pval))
  
  return(output_vector)
  
}


# city_dist
all_pvalues_Q2 <- sapply(all_1yr_mods_tr,
                         extract_p_Q2) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename("variable" = 1,
                "p" = 2) %>%
  # order df by p-value
  dplyr::arrange(-desc(p)) %>%
# remove asterisks from p-values
  dplyr::mutate(p = str_replace(
    p,
    "[*]{1,3}",
    "")) %>%
  dplyr::mutate(p = as.numeric(p))




# Urb_score
all_pvalues_Q2_u <- sapply(all_1yr_mods.u_tr,
                         extract_p_Q2) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename("variable" = 1,
                "p" = 2) %>%
  # order df by p-value
  dplyr::arrange(-desc(p)) %>%
# remove asterisks from p-values
  dplyr::mutate(p = str_replace(
    p,
    "[*]{1,3}",
    "")) %>%
  # remove < from p-values (for p < 0.001)
  dplyr::mutate(p = str_replace(
    p,
    "<",
    "")) %>%
  dplyr::mutate(p = as.numeric(p))
```
  
## FDR tests: Q1
### City_dist
```{r}
all_pvalues_Q1 %<>%

# Perform p-value adjustment and add to df-----

# Adjustment procedures that give strong control of the family-wise error rate are the Bonferroni, Holm, Hochberg, and Hommel procedures.

# Adjustments that control for the false discovery rate, which is the expected proportion of false discoveries among the rejected hypotheses, are the Benjamini and Hochberg, and Benjamini, Hochberg, and Yekutieli procedures.
  dplyr::mutate(
    Bonferroni = p.adjust(
      p,
      method = "bonferroni"), # usually too conservative
    BH = p.adjust(
      p,
      method = "BH"), # Benjamini-Hochberg procedure- what I want (tests for FDR)
    Holm = p.adjust(
      p,
      method = "holm"),
    Hochberg = p.adjust(
      p,
      method = "hochberg"),
    Hommel = p.adjust(
      p,
      method = "hommel"),
    BY = p.adjust(
      p,
      method = "BY")  # stands for Benjamini, Hochberg, and Yekutieli procedure- what I want (tests for FDR)
    )

```


### Urb_score
```{r}
all_pvalues_Q1_u %<>%

# Perform p-value adjustment and add to df-----

# Adjustment procedures that give strong control of the family-wise error rate are the Bonferroni, Holm, Hochberg, and Hommel procedures.

# Adjustments that control for the false discovery rate, which is the expected proportion of false discoveries among the rejected hypotheses, are the Benjamini and Hochberg, and Benjamini, Hochberg, and Yekutieli procedures.
  dplyr::mutate(
    Bonferroni = p.adjust(
      p,
      method = "bonferroni"), # usually too conservative
    BH = p.adjust(
      p,
      method = "BH"), # Benjamini-Hochberg procedure- what I want (tests for FDR)
    Holm = p.adjust(
      p,
      method = "holm"),
    Hochberg = p.adjust(
      p,
      method = "hochberg"),
    Hommel = p.adjust(
      p,
      method = "hommel"),
    BY = p.adjust(
      p,
      method = "BY")  # stands for Benjamini, Hochberg, and Yekutieli procedure- what I want (tests for FDR)
    )

```

## FDR tests: Q2
### City_dist
```{r}
all_pvalues_Q2 %<>%
# Perform p-value adjustment and add to df
  dplyr::mutate(
    Bonferroni = p.adjust(
      p,
      method = "bonferroni"), # usually too conservative
    BH = p.adjust(
      p,
      method = "BH"), # Benjamini-Hochberg procedure- what I want (tests for FDR)
    Holm = p.adjust(
      p,
      method = "holm"),
    Hochberg = p.adjust(
      p,
      method = "hochberg"),
    Hommel = p.adjust(
      p,
      method = "hommel"),
    BY = p.adjust(
      p,
      method = "BY"))  # stands for Benjamini, Hochberg, and Yekutieli procedure- what I want (tests for FDR)

```

### Urb_score
```{r}
all_pvalues_Q2_u %<>%
# Perform p-value adjustment and add to df-----
  dplyr::mutate(
    Bonferroni = p.adjust(
      p,
      method = "bonferroni"), # usually too conservative
    BH = p.adjust(
      p,
      method = "BH"), # Benjamini-Hochberg procedure- what I want (tests for FDR)
    Holm = p.adjust(
      p,
      method = "holm"),
    Hochberg = p.adjust(
      p,
      method = "hochberg"),
    Hommel = p.adjust(
      p,
      method = "hommel"),
    BY = p.adjust(
      p,
      method = "BY"))  # stands for Benjamini, Hochberg, and Yekutieli procedure- what I want (tests for FDR)

```

## Export
### Create neat tables
```{r}
make_FDR_table <- function(p_val_df){
  return(
    p_val_df %>%
  dplyr::select(1:2, "Bonferroni", "BH", "BY") %>%
    dplyr::mutate(p = round(p, 3),
                  Bonferroni = round(Bonferroni, 3),
                  BH = round(BH, 3),
                  BY = round(BY, 3)) %>%
  dplyr::rename("Original p" = "p",
                "Variable" = "variable",
                "Benjamini-\nHochberg" = "BH",
                "Benjamini-\nHochberg-\nYekutieli" = "BY") %>%
     dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory after flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # cardenolides
    str_detect(Variable, "6.6")~
      "Cardenolide peak 6.6",
    str_detect(Variable, "Total")~
      "Total cardenolides",
    str_detect(Variable, "15")~
      "Cardenolide peak 15",
    str_detect(Variable, "17.6")~
      "Cardenolide peak 17.6",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "Julian_first")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality" )) %>%
  flextable() %>%
  flextable::align(j = 2:5, align = "center", part = "all") %>%
  hline( border = NULL, part = "body") %>%
    width(j = 1, width = 3, unit = "in") %>%
    width(j = c(2:5), width = 1, unit = "in") %>%
 # autofit() %>%
    flextable::padding(padding = 3)
  )
}

FDR_tab1 <- make_FDR_table(all_pvalues_Q1)
FDR_tab2 <- make_FDR_table(all_pvalues_Q1_u)
FDR_tab3 <- make_FDR_table(all_pvalues_Q2)
FDR_tab4 <- make_FDR_table(all_pvalues_Q2_u)

```

### Export to word
```{r}

 word_export <- read_docx()
  
  body_add_par(word_export, value = "All populations & Urbanization = Distance from City Center", style = "heading 1")
  body_add_flextable(word_export, (FDR_tab1))
  
  body_add_break(word_export)

  body_add_par(word_export, value = "All populations & Urbanization = Urbanization Score", style = "heading 1")
  body_add_flextable(word_export, (FDR_tab2))
  
  body_add_break(word_export)
  
  body_add_par(word_export, value = "Urban populations & Urbanization = Distance from City Center", style = "heading 1")
  body_add_flextable(word_export, (FDR_tab3))
  
  body_add_break(word_export)

  body_add_par(word_export, value = "Urban populations & Urbanization = Urbanization Score", style = "heading 1")
  body_add_flextable(word_export, (FDR_tab4))

  print(word_export, here::here("./Figures_Tables/False_discovery_rate/FDR_p_all.docx"))
```

# Perform binomial expansion test
## Make trait list for use in all tables
```{r}
traits = c(
  # growth traits 1-9
  "G1",  "G2",   "G3",   "G4",   "G5",   "G6",   "G7",   "G8",
  # herbivore community abundances 1-3
  "H1",   "H2",   "H3",
  # Defense traits 1-7
  "D1",  "D2",   "D3",   "D4",   "D5",   "D6",   "D7",
  # Reproduction traits 1-8
  "R1",  "R2",   "R3",   "R4",   "R5",   "R6",   "R7",   "R8")
```

## Q1
### Table 1
#### Get data
```{r}
# changing all instances of "p<0.001" to 0.001

binom_t1 <- data.frame(
  
  trait = traits,
  
  p_pop = c(
      # growth traits
    0.257,
    0.189 ,
    0.3805,
    0.186,
    0.429,
    0.364,
    0.5,
    0.5,
    # Herbivore community
    0.4765,
    0.2665,
    0.1255,
    # Defense traits
    0.5,
    0.5,
    0.4955,
    0.5,
    0.0165,
    0.4995,
    0.136,
    # Reproductive traits
    0.5,
    0.5,
    0.1345,
    0.5,
    0.014,
    0.5,
    0.035,
    0.1805),
  
  p_fam = c(
    # Growth traits
    0.001,
    0.009,
    0.5,
    0.189,
    0.001,
    0.001,
    0.394,
    0.5,
    # Herbivore community
    0.5,
    0.5,
    0.0395,
    # Defense traits
    0.49,
    0.5,
    0.004,
    0.2605,
    0.077,
    0.0305,
    0.138,
    # Reproductive traits
    0.5,
    0.001,
    0.37,
    0.5,
    0.3025,
    0.5,
    0.4965,
    0.5
    )
  )


```

#### Perform tests
##### Population
```{r}
t1_pop_succ <- as.numeric(nrow(binom_t1[binom_t1$p_pop <= 0.05, ]))
t1_pop_trials <- as.numeric(nrow(binom_t1))
prob_succ <- 0.05 # critical p-value

t1_results_pop <- binom.test(t1_pop_succ, t1_pop_trials, prob_succ, "two.sided")

t1_results_pop$p.value # p-value: 0.1386324
t1_results_pop$estimate # probability of success: 0.1153846  
```

##### Family
```{r}
t1_fam_succ <- as.numeric(nrow(binom_t1[binom_t1$p_fam <= 0.05, ]))
t1_fam_trials <- as.numeric(nrow(binom_t1))
prob_succ <- 0.05 # critical p-value

t1_results_fam <- binom.test(t1_fam_succ, t1_fam_trials, prob_succ, "two.sided")

t1_results_fam$p.value # p-value: 2.703918e-05 
t1_results_fam$estimate # probability of success: 0.3076923 
```

### Table 2
#### Get data
```{r}
# changing all instances of "p<0.001" to 0.001

binom_t2 <- data.frame(
  
  trait = traits,
  
  p_pop = c(
    # Growth traits
    0.303,
    0.205,
    0.424,
    0.185,
    0.485,
    0.437,
    0.5,
    0.5,
    # Herbivore community
    0.5,
    0.2705,
    0.1295,
    # Defense traits
    0.5,
    0.5,
    0.4945,
    0.5,
    0.0155,
    0.5,
    0.1335,
    # Reproductive traits
    0.5,
    0.4765,
    0.141,
    0.5,
    0.0145,
    0.5,
    0.035,
    0.326
),
  
  p_fam = c(
    # Growth traits
    0.001,
    0.0085,
    0.5,
    0.1885,
    0.001,
    0.001,
    0.377,
    0.5,
    # Herbivore community
    0.5,
    0.5,
    0.038,
    # Defense traits
    0.5,
    0.5,
    0.008,
    0.241,
    0.076,
    0.032,
    0.153,
    # Reproductive traits
    0.5,
    0.001,
    0.374,
    0.5,
    0.3025,
    0.5,
    0.5,
    0.5
    )
  )
```

#### Perform tests
##### Population
```{r}
t2_pop_succ <- as.numeric(nrow(binom_t2[binom_t2$p_pop <= 0.05, ]))
t2_pop_trials <- as.numeric(nrow(binom_t2))
prob_succ <- 0.05 # critical p-value

t2_results_pop <- binom.test(t2_pop_succ, t2_pop_trials, prob_succ, "two.sided")

t2_results_pop$p.value # p-value: 0.1386324 
t2_results_pop$estimate # probability of success: 0.1153846  
```

##### Family
```{r}
t2_fam_succ <- as.numeric(nrow(binom_t2[binom_t2$p_fam <= 0.05, ]))
t2_fam_trials <- as.numeric(nrow(binom_t2))
prob_succ <- 0.05 # critical p-value

t2_results_fam <- binom.test(t2_fam_succ, t2_fam_trials, prob_succ, "two.sided")

t2_results_fam$p.value # p-value: 2.703918e-05 
t2_results_fam$estimate # probability of success: 0.3076923 
```

### Table 3
#### Get data
```{r}
# changing all instances of "p<0.001" to 0.001

binom_t3 <- data.frame(
  
   trait = traits,
  
  p_pop = c(
    # Growth traits
     0.2485,
     0.175,
     0.346,
     0.1825,
     0.427,
     0.368,
     0.5,
     0.5,
     # Herbivore community
     0.5,
     0.2745,
     0.152,
     # Defense traits
     0.5,
     0.5,
     0.4865,
     0.5,
     0.0415,
     0.5,
     0.119,
     # Reproductive traits
     0.5,
     0.5,
     0.181,
     0.5,
     0.015,
     0.5,
     0.04,
     0.403
),
  
  p_fam = c(
    # Growth traits
    0.001,
    0.009,
    0.5,
    0.192,
    0.001,
    0.001,
    0.3755,
    0.5,
    # Herbivore community
    0.5,
    0.5,
    0.0365,
    # Defense traits
    0.5,
    0.5,
    0.0085,
    0.244,
    0.0835,
    0.0305,
    0.1475,
    # Reproductive traits
    0.5,
    0.001,
    0.358,
    0.5,
    0.3005,
    0.5,
    0.5,
    0.5
    )
  )

```

#### Perform tests
##### Population
```{r}
t3_pop_succ <- as.numeric(nrow(binom_t3[binom_t3$p_pop <= 0.05, ]))
t3_pop_trials <- as.numeric(nrow(binom_t3))
prob_succ <- 0.05 # critical p-value

t3_results_pop <- binom.test(t3_pop_succ, t3_pop_trials, prob_succ, "two.sided")

t3_results_pop$p.value # p-value: 0.1386324 
t3_results_pop$estimate # probability of success: 0.1153846  
```

##### Family
```{r}
t3_fam_succ <- as.numeric(nrow(binom_t3[binom_t3$p_fam <= 0.05, ]))
t3_fam_trials <- as.numeric(nrow(binom_t3))
prob_succ <- 0.05 # critical p-value

t3_results_fam <- binom.test(t3_fam_succ, t3_fam_trials, prob_succ, "two.sided")

t3_results_fam$p.value # p-value: 2.703918e-05 
t3_results_fam$estimate # probability of success: 0.3076923 
```

## Q2
### Table 1
#### Get data
```{r}
# changing all instances of "p<0.001" to 0.001

binom_t1 <- data.frame(
  
  trait = traits,
  
  p_pop = c(
      # Growth traits
0.5,
0.5,
0.4115,
0.5,
0.5,
0.5,
0.2435,
0.5,
# Herbivore community
0.5,
0.5,
0.4566,
# Defense traits
0.5,
0.5,
0.4895,
0.5,
0.055,
0.5,
0.0715,
# Reproductive traits
0.5,
0.5,
0.1245,
0.5,
0.3675,
0.5,
0.125,
0.2745
),
  
  p_fam = c(
    # Growth traits
    0.0025,
0.0035,
0.459,
0.0235,
0.001,
0.001,
0.5,
0.5,
# Herbivore community
0.5,
0.5,
0.0085,
# Defense traits
0.5,
0.5,
0.2875,
0.1495,
0.04,
0.049,
0.029,
# Reproductive traits
0.5,
0.001,
0.286,
0.5,
0.0505,
0.5,
0.001,
0.5
    )
  )


```

#### Perform tests
##### Population
```{r}
t1_pop_succ <- as.numeric(nrow(binom_t1[binom_t1$p_pop <= 0.05, ]))
t1_pop_trials <- as.numeric(nrow(binom_t1))
prob_succ <- 0.05 # critical p-value

t1_results_pop2 <- binom.test(t1_pop_succ, t1_pop_trials, prob_succ, "two.sided")

t1_results_pop2$p.value # p-value: 0.6393936
t1_results_pop2$estimate # probability of success: 0
```

##### Family
```{r}
t1_fam_succ <- as.numeric(nrow(binom_t1[binom_t1$p_fam <= 0.05, ]))
t1_fam_trials <- as.numeric(nrow(binom_t1))
prob_succ <- 0.05 # critical p-value

t1_results_fam2 <- binom.test(t1_fam_succ, t1_fam_trials, prob_succ, "two.sided")

t1_results_fam2$p.value # p-value: 1.86962e-08
t1_results_fam2$estimate # probability of success: 0.4230769 
```

### Table 2
#### Get data
```{r}
# changing all instances of "p<0.001" to 0.001

binom_t2 <- data.frame(
  
  trait = traits,
  
  p_pop = c(
   # Growth traits
0.375,
0.411,
0.323,
0.5,
0.5,
0.5,
0.3135,
0.5,
# Herbivore community
0.5,
0.5,
0.4385,
# Defense traits
0.5,
0.5,
0.4885,
0.5,
0.239,
0.5,
0.1025,
# Reproductive traits
0.5,
0.5,
0.179,
0.5,
0.437,
0.5,
0.1675,
0.5

),
  
  p_fam = c(
    # Growth traits
0.003,
0.004,
0.454,
0.023,
0.001,
0.001,
0.5,
0.5,
# Herbivore community
0.5,
0.5,
0.01,
# Defense traits
0.5,
0.5,
0.2985,
0.1945,
0.036,
0.053,
0.027,
# Reproductive traits
0.5,
0.001,
0.26,
0.5,
0.0465,
0.5,
0.001,
0.5
    )
  )
```

#### Perform tests
##### Population
```{r}
t2_pop_succ <- as.numeric(nrow(binom_t2[binom_t2$p_pop <= 0.05, ]))
t2_pop_trials <- as.numeric(nrow(binom_t2))
prob_succ <- 0.05 # critical p-value

t2_results_pop2 <- binom.test(t2_pop_succ, t2_pop_trials, prob_succ, "two.sided")

t2_results_pop2$p.value # p-value: 0.6393936
t2_results_pop2$estimate # probability of success: 0
```

##### Family
```{r}
t2_fam_succ <- as.numeric(nrow(binom_t2[binom_t2$p_fam <= 0.05, ]))
t2_fam_trials <- as.numeric(nrow(binom_t2))
prob_succ <- 0.05 # critical p-value

t2_results_fam2 <- binom.test(t2_fam_succ, t2_fam_trials, prob_succ, "two.sided")

t2_results_fam2$p.value # p-value: 1.86962e-08
t2_results_fam2$estimate # probability of success: 0.4230769 
```

## Export
```{r}
# Q1 results

q1.t1 <- "Trait ~ (1 | Population/Family) + Block"
q1.t2 <- "Trait ~ (1 | Population/Family) + Block + Distance to City Center"
q1.t3 <- "Trait ~ (1 | Population/Family) + Block + Urbanization Score"

q2.t1 <- "Trait ~ (1 | Population/Family) + Block + Distance to City Center*Transect"
q2.t2 <- "Trait ~ (1 | Population/Family) + Block + Urbanization Score*Transect"

binomial_results_q1 <- data.frame(
  
  Question = 1,
  
  Model = c(q1.t1, q1.t1,
            q1.t2, q1.t2,
            q1.t3, q1.t3),
  
  Table = c(1,1,2,2,3,3),
  
  Group = c("Population", "Family",
            "Population", "Family",
            "Population", "Family"),
  
  Probability = c(round(t1_results_pop$estimate, 3),
                  round(t1_results_fam$estimate, 3),
                  round(t2_results_pop$estimate, 3),
                  round(t2_results_fam$estimate, 3),
                  round(t3_results_pop$estimate, 3),
                  round(t3_results_fam$estimate, 3)),
  
  p = c(round(t1_results_pop$p.value, 3),
        round(t1_results_fam$p.value, 3),
        round(t2_results_pop$p.value, 3),
        round(t2_results_fam$p.value, 3),
        round(t3_results_pop$p.value, 3),
        round(t3_results_fam$p.value, 3))
  
)


# Q2 results
binomial_results_q2 <- data.frame(
  
  Question = 2,
  
  Model = c(q2.t1, q2.t1,
            q2.t2, q2.t2),
  
  Table = c(1,1,2,2),
  
  Group = c("Population", "Family",
            "Population", "Family"),
  
  Probability = c(round(t1_results_pop2$estimate, 3),
                  round(t1_results_fam2$estimate, 3),
                  round(t2_results_pop2$estimate, 3),
                  round(t2_results_fam2$estimate, 3)),
  
  p = c(round(t1_results_pop2$p.value, 3),
        round(t1_results_fam2$p.value, 3),
        round(t2_results_pop2$p.value, 3),
        round(t2_results_fam2$p.value, 3))
  
)


# merge tables
binomial_results <- rbind(binomial_results_q1,
                          binomial_results_q2)

binomial_results$p[binomial_results$p == 0] <- "<0.001"

write.csv(binomial_results,
          here::here("./Figures_Tables/Binomial_Exp_Test/binomialtest_results.csv"))

binomial_results %>%
  flextable() %>%
  merge_at(., i = 1:6, j = 1, part = "body") %>%
  merge_at(., i = 7:10, j = 1, part = "body") %>%
   merge_at(., i = 1:2, j = 2, part = "body") %>%
  merge_at(., i = 3:4, j = 2, part = "body") %>%
  merge_at(., i = 5:6, j = 2, part = "body") %>%
  merge_at(., i = 7:8, j = 2, part = "body") %>%
  merge_at(., i = 9:10, j = 2, part = "body") %>%
  merge_at(., i = 1:2, j = 3, part = "body") %>%
  merge_at(., i = 3:4, j = 3, part = "body") %>%
  merge_at(., i = 5:6, j = 3, part = "body") %>%
  merge_at(., i = 7:8, j = 3, part = "body") %>%
  merge_at(., i = 9:10, j = 3, part = "body") %>%
  theme_box() %>% 
  align(., j = c(1, 3, 5:6), align = "center", part = "all") %>%
  autofit() %>% 
  width(., j = 2, width = 2.5, unit = "in") %>%
  fix_border_issues() %>%
  save_as_docx(path =  here::here("./Figures_Tables/Binomial_Exp_Test/binomialtest_results.docx"))
```