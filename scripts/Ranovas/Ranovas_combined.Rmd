# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import ranova tables
these values were generated in:
-scripts/Ranovas/Ranovas_growth.Rmd (etc. for rest of similarly-named files)...

manually extracted, then organized into these word docs:
-Figures_Tables\ranova_PVE\ranovas_allyears.docx
-Figures_Tables\ranova_PVE\ranovas_allyears_transects.docx

...then placed into csvs for import into R and manipulation: 

### Q1
```{r}
ran1 <- read.csv(here::here("./Figures_Tables/ranova_PVE/ranovas_allyears_Table1.csv"),
                 blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::rename("Variable" = 1)


ran2 <- read.csv(here::here("./Figures_Tables/ranova_PVE/ranovas_allyears_Table2.csv"),
                 blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::rename("Variable" = 1)
```

### Q2
```{r}
ran3 <- read.csv(here::here("./Figures_Tables/ranova_PVE/ranovas_allyears_transects_Table1.csv"),
                 blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::rename("Variable" = 1) %>%
  dplyr::select(Variable:Urbanization)

```

## Reshape tables
### Q1, table 1
```{r}
ran1 %<>%
  pivot_wider(names_from = "Group",
              values_from = c("Chisq", "p", "PVE"),
              names_glue = "{Group}_{.value}") %>%
  dplyr::select(1,2,4,6,3,5,7) 


# If p-value column cell != <0.001, round it to 3 digits
ran1$UrbScore_Family_p <- ifelse(ran1$UrbScore_Family_p == "<0.001",
                        ran1$UrbScore_Family_p,
                        round(as.numeric(ran1$UrbScore_Family_p), 3))


ran1$UrbScore_Population_p <- ifelse(ran1$UrbScore_Population_p == "<0.001",
                        ran1$UrbScore_Population_p,
                        round(as.numeric(ran1$UrbScore_Population_p), 3))
```

### Q1, table 2
```{r}
ran2 %<>%
  pivot_wider(names_from = c("Group", "Urbanization"),
              values_from = c("Chisq", "p", "PVE"),
                names_glue = "{Urbanization}_{Group}_{.value}") %>%
  dplyr::select(1,2,6,10,3,7,11,4,8,12,5,9,13)

# If p-value column cell != <0.001, round it to 3 digits
ran2$Distance_Population_p <- ifelse(ran2$Distance_Population_p == "<0.001",
                        ran2$Distance_Population_p,
                        round(as.numeric(ran2$Distance_Population_p), 3))

ran2$Distance_Family_p <- ifelse(ran2$Distance_Family_p == "<0.001",
                        ran2$Distance_Family_p,
                        round(as.numeric(ran2$Distance_Family_p), 3))


ran2$UrbScore_Family_p <- ifelse(ran2$UrbScore_Family_p == "<0.001",
                        ran2$UrbScore_Family_p,
                        round(as.numeric(ran2$UrbScore_Family_p), 3))

ran2$UrbScore_Population_p <- ifelse(ran2$UrbScore_Population_p == "<0.001",
                        ran2$UrbScore_Population_p,
                        round(as.numeric(ran2$UrbScore_Population_p), 3))
```

### Q2, table 1
```{r}
ran3 %<>%
  pivot_wider(names_from = c("Group", "Urbanization"),
              values_from = c("Chisq", "p", "PVE"),
                names_glue = "{Urbanization}_{Group}_{.value}") %>%
  dplyr::select(1,2,6,10,3,7,11,4,8,12,5,9,13)

# If p-value column cell != <0.001, round it to 3 digits
ran3$Distance_Population_p <- ifelse(ran3$Distance_Population_p == "<0.001",
                        ran3$Distance_Population_p,
                        round(as.numeric(ran3$Distance_Population_p), 3))

ran3$Distance_Family_p <- ifelse(ran3$Distance_Family_p == "<0.001",
                        ran3$Distance_Family_p,
                        round(as.numeric(ran3$Distance_Family_p), 3))


ran3$UrbScore_Family_p <- ifelse(ran3$UrbScore_Family_p == "<0.001",
                        ran3$UrbScore_Family_p,
                        round(as.numeric(ran3$UrbScore_Family_p), 3))

ran3$UrbScore_Population_p <- ifelse(ran3$UrbScore_Population_p == "<0.001",
                        ran3$UrbScore_Population_p,
                        round(as.numeric(ran3$UrbScore_Population_p), 3))
```

## Make nice tables & export
### Q1, table 1
```{r}
ran1 %>%
  flextable() %>%
  flextable::bold(i = ~ Population_p <= 0.05, j = 3) %>%
  flextable::bold(i = ~ Family_p <= 0.05, j = 6) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:7, align = "center", part = "body") %>%
  merge_h(i = 1, part = "header") %>%
  align(i = 2, align = "center", part = "header") %>%
  hline(border = NULL, part = "body") %>%
  vline(j = 4, part = "all") %>%
  flextable::compose(i = 2, j = c(2,5), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  flextable::compose(i = 1, j = 2, part = "header",
                     value = as_paragraph("Population")) %>%
  flextable::compose(i = 1, j = 5, part = "header",
                     value = as_paragraph("Family")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/ranova_PVE/ranovas_allyears_Table1_reproducible.docx"))
```


### Q1, table 2
```{r}
ran2 %>%
  flextable() %>%
  flextable::bold(i = ~ Distance_Population_p <= 0.05, j = 3) %>%
  flextable::bold(i = ~ Distance_Family_p <= 0.05, j = 6) %>%  
  flextable::bold(i = ~ UrbScore_Population_p <= 0.05, j = 9) %>%
  flextable::bold(i = ~ UrbScore_Family_p <= 0.05, j = 12) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:12, align = "center", part = "all") %>%
  align(i = 1:2, align = "left", part = "header") %>%
  hline(border = NULL, part = "body") %>%
  vline(j = c(4,7,10), part = "all") %>%
  flextable::compose(i = 3, j = c(2,5,8,11), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  merge_h(i = 2, part = "header") %>%
  merge_h(i = 1, part = "header") %>%
  flextable::compose(i = 1, j = 8, part = "header",
                     value = as_paragraph("Urbanization Score")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/ranova_PVE/ranovas_allyears_Table2_reproducible.docx"),
               pr_section = prop_section(
  page_size = page_size(
    orient = "landscape",
    width = 14, height = 11
  ),
  type = "continuous",
  page_margins = page_mar()
))
```


### Q2, table 1
```{r}
ran3 %>%
  flextable() %>%
  flextable::bold(i = ~ Distance_Population_p <= 0.05, j = 3) %>%
  flextable::bold(i = ~ Distance_Family_p <= 0.05, j = 6) %>%  
  flextable::bold(i = ~ UrbScore_Population_p <= 0.05, j = 9) %>%
  flextable::bold(i = ~ UrbScore_Family_p <= 0.05, j = 12) %>%
  ftExtra::separate_header() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 2:12, align = "center", part = "all") %>%
  align(i = 1:2, align = "left", part = "header") %>%
  hline(border = NULL, part = "body") %>%
  vline(j = c(4,7,10), part = "all") %>%
  flextable::compose(i = 3, j = c(2,5,8,11), part = "header",
                     value = as_paragraph("χ", as_sup("2"))) %>%
  merge_h(i = 2, part = "header") %>%
  merge_h(i = 1, part = "header") %>%
  flextable::compose(i = 1, j = 8, part = "header",
                     value = as_paragraph("Urbanization Score")) %>%
  flextable::compose(i = 1, j = 1, part = "header",
                     value = as_paragraph(" ")) %>%
  padding(padding = 3) %>%
  fix_border_issues(part = "all") %>%
  autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/ranova_PVE/ranovas_allyears_transects_Table1_reproducible.docx"),
               pr_section = prop_section(
  page_size = page_size(
    orient = "landscape",
    width =13, height = 11
  ),
  type = "continuous",
  page_margins = page_mar()
))
```