# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
### Create full list
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_Growth.Rmd", quiet=TRUE))
```

# Ranova
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## gaussian distribution models
### Gradient
```{r}
# LDMC-------
ldmc_ranova_mod1 <- lmer((LDMC)^(1/3) ~
                           (1|Population/Family) ,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 0.7),
                           REML = T)

# Check diagnostics and transform if necessary
performance::check_model(ldmc_ranova_mod1)

# export
ranova_2step(ldmc_ranova_mod1,
             "LDMC",
             "./Figures_Tables/ranova_PVE/Growth/ldmc.docx")


# SLA-----
sla_ranova_mod1 <- lmer(SLA^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = sla_ldmc %>%
                          dplyr::filter(is.na(SLA) == F),
                        REML = T)

# check diagnostics and transform if necessary
performance::check_model(sla_ranova_mod1)

# export
ranova_2step(sla_ranova_mod1,
             "SLA",
             "./Figures_Tables/ranova_PVE/Growth/sla.docx")


# Rel growth rate-----
# 2019--------
rgr_ranova_mod1 <- lmer((rel_growth_rate^(1/3))*100 ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2019),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod1)

# export
ranova_2step(rgr_ranova_mod1,
             "Relative growth rate: 2019",
             "./Figures_Tables/ranova_PVE/Growth/rgr_2019.docx")


# 2020--------
rgr_ranova_mod2 <- lmer((rel_growth_rate^(1/3))*100 ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2020),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod2)

# export
ranova_2step(rgr_ranova_mod2,
             "Relative growth rate: 2020",
             "./Figures_Tables/ranova_PVE/Growth/rgr_2020.docx")


# 2021--------
rgr_ranova_mod3 <- lmer((rel_growth_rate^(1/3))*100 ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2021),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod3)

# export
ranova_2step(rgr_ranova_mod3,
             "Relative growth rate: 2021",
             "./Figures_Tables/ranova_PVE/Growth/rgr_2021.docx")



# Total_Height_early-----
# 2019-----
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2019),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod1)

# export
ranova_2step(heights_e_ranova_mod1,
             "Height, before flowering: 2019",
             "./Figures_Tables/ranova_PVE/Growth/heights_early_2019.docx")


# 2020-----
heights_e_ranova_mod2 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2020),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod2)

# export
ranova_2step(heights_e_ranova_mod2,
             "Height, before flowering: 2020",
             "./Figures_Tables/ranova_PVE/Growth/heights_early_2020.docx")


# 2021-----
heights_e_ranova_mod3 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2021),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod3)

# export
ranova_2step(heights_e_ranova_mod3,
             "Height, before flowering: 2021",
             "./Figures_Tables/ranova_PVE/Growth/heights_early_2021.docx")



# Total_Height_late-----
# 2019-----
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2019),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod1)

# export
ranova_2step(heights_l_ranova_mod1,
             "Height, after flowering: 2019",
             "./Figures_Tables/ranova_PVE/Growth/heights_late_2019.docx")


# 2020-----
heights_l_ranova_mod2 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2020),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod2)

# export
ranova_2step(heights_l_ranova_mod2,
             "Height, after flowering: 2020",
             "./Figures_Tables/ranova_PVE/Growth/heights_late_2020.docx")


# 2021-----
heights_l_ranova_mod3 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2021),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod3)

# export
ranova_2step(heights_l_ranova_mod3,
             "Height, after flowering: 2021",
             "./Figures_Tables/ranova_PVE/Growth/heights_late_2021.docx")


```

### Urban subtransects
```{r}
# LDMC-------
ldmc_ranova_mod1 <- lmer(LDMC^(1/3) ~
                           (1|Population/Family) +
                           Block,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural" & LDMC < 0.7),
                           REML = T)


# check diagnostics and transform if necessary
performance::check_model(ldmc_ranova_mod1)

ranova_transect(ldmc_ranova_mod1,
                "LDMC",
                "./Figures_Tables/ranova_PVE/Growth/ldmc_transects.docx")


# SLA-----
sla_ranova_mod1 <- lmer((SLA)^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(sla_ranova_mod1)

ranova_transect(sla_ranova_mod1,
                "SLA",
                "./Figures_Tables/ranova_PVE/Growth/sla_transects.docx")


# Rel growth rate-----
# 2019-----
rgr_ranova_mod1 <- lmer((rel_growth_rate^(1/3))*100 ~
                          (1|Population/Family) +
                          Block ,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2019),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod1)

ranova_transect(rgr_ranova_mod1,
                "Relative growth rate: 2019",
                "./Figures_Tables/ranova_PVE/Growth/rgr_transects_2019.docx")


# 2020-----
rgr_ranova_mod2 <- lmer((rel_growth_rate^(1/3))*100 ~
                          (1|Population/Family) +
                          Block ,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod2)

ranova_transect(rgr_ranova_mod2,
                "Relative growth rate: 2020",
                "./Figures_Tables/ranova_PVE/Growth/rgr_transects_2020.docx")


# 2021-----
rgr_ranova_mod3 <- lmer((rel_growth_rate^(1/3))*100 ~
                          (1|Population/Family) +
                          Block ,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod3)

ranova_transect(rgr_ranova_mod3,
                "Relative growth rate: 2021",
                "./Figures_Tables/ranova_PVE/Growth/rgr_transects_2021.docx")


# Total_Height_early-----
# 2019-----
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2019),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod1)

ranova_transect(heights_e_ranova_mod1,
                "Height before flowering: 2019",
                "./Figures_Tables/ranova_PVE/Growth/heights_e_transects_2019.docx")


# 2020-----
heights_e_ranova_mod2 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod2)

ranova_transect(heights_e_ranova_mod2,
                "Height before flowering: 2020",
                "./Figures_Tables/ranova_PVE/Growth/heights_e_transects_2020.docx")


# 2021-----
heights_e_ranova_mod3 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod3)

ranova_transect(heights_e_ranova_mod3,
                "Height before flowering: 2021",
                "./Figures_Tables/ranova_PVE/Growth/heights_e_transects_2021.docx")

# Total_Height_late-----
# 2019-----
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2019),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod1)

ranova_transect(heights_l_ranova_mod1,
                "Height after flowering: 2019",
                "./Figures_Tables/ranova_PVE/Growth/heights_l_transects_2019.docx")


# 2020-----
heights_l_ranova_mod2 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod2)

ranova_transect(heights_l_ranova_mod2,
                "Height after flowering: 2020",
                "./Figures_Tables/ranova_PVE/Growth/heights_l_transects_2020.docx")


# 2021-----
heights_l_ranova_mod3 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod3)

ranova_transect(heights_l_ranova_mod3,
                "Height after flowering: 2021",
                "./Figures_Tables/ranova_PVE/Growth/heights_l_transects_2021.docx")

```

## non-gaussian models
### Gradient
```{r}
# Number of ramets (early)-------
# 2019-----
ramets_e_ranova1 <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2019),
                            na.action = na.exclude,
                     #      
                             family = poisson)

# performance::check_model(ramets_e_ranova1)

pb_ranova_2step(ramets_e_ranova1,
          "Ramets before flowering: 2019",
           "./Figures_Tables/ranova_PVE/Growth/ramets_early_2019.docx")


# 2020-----
ramets_e_ranova2 <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                        #   
                             family = poisson)

# performance::check_model(ramets_e_ranova2)

pb_ranova_2step(ramets_e_ranova2,
          "Ramets before flowering: 2020",
          "./Figures_Tables/ranova_PVE/Growth/ramets_early_2020.docx")


# 2021-----
ramets_e_ranova3 <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                       #     
                             family = poisson)

# performance::check_model(ramets_e_ranova3)
# summary(ramets_e_ranova3)
# insight::get_variance_random(ramets_e_ranova3)
pb_ranova_2step(ramets_e_ranova3,
          "Ramets before flowering: 2021",
          "./Figures_Tables/ranova_PVE/Growth/ramets_early_2021.docx")


# Number of ramets (LATE)-------
# 2019-----
ramets_l_ranova1 <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2019),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(ramets_l_ranova1)

pb_ranova_2step(ramets_l_ranova1,
          "Ramets after flowering: 2019",
          "./Figures_Tables/ranova_PVE/Growth/ramets_late_2019.docx")


# 2020-----
ramets_l_ranova2 <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                       #   
                             family = poisson)

# performance::check_model(ramets_l_ranova2)

pb_ranova_2step(ramets_l_ranova2,
          "Ramets after flowering: 2020",
          "./Figures_Tables/ranova_PVE/Growth/ramets_late_2020.docx")


# 2021-----
ramets_l_ranova3 <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                      #    
                             family = poisson)

# performance::check_model(ramets_l_ranova3)

pb_ranova_2step(ramets_l_ranova3,
          "Ramets after flowering: 2021",
          "./Figures_Tables/ranova_PVE/Growth/ramets_late_2021.docx")



# Mortality-------
# 2019-----
mortality_ranova1 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2019),
                            na.action = na.exclude, # ,control=glmerControl(optimizer="bobyqa",
  #                           optCtrl=list(maxfun=2e5)),
                           
                             family = binomial)

# performance::check_model(mortality_ranova1)

pb_ranova_2step(mortality_ranova1,
          "Mortality: 2019",
          "./Figures_Tables/ranova_PVE/Growth/mortality_2019.docx")

# 2020-----
mortality_ranova2 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
  control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)),                             family = binomial)

# performance::check_model(mortality_ranova2)

pb_ranova_2step(mortality_ranova2,
          "Mortality: 2020",
          "./Figures_Tables/ranova_PVE/Growth/mortality_2020.docx")


# 2021-----
mortality_ranova3 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2021),

                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(mortality_ranova3)

pb_ranova_2step(mortality_ranova3,
          "Mortality: 2021",
          "./Figures_Tables/ranova_PVE/Growth/mortality_2021.docx")

# 2022-----
mortality_ranova4 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(mortality_ranova4)

pb_ranova_2step(mortality_ranova4,
          "Mortality: 2022",
          "./Figures_Tables/ranova_PVE/Growth/mortality_2022.docx")


```

### Urb subs
```{r}
# Ramets (before flowering)-------
# 2019-----
ramets_e_ranova1_pb <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2019),
                            na.action = na.exclude,
  control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)),                              family = poisson)

# performance::check_model(ramets_e_ranova1_pb)

pb_ranova_transects(ramets_e_ranova1_pb,
          "Ramets before flowering: 2019",
          "./Figures_Tables/ranova_PVE/Growth/ramets_early_2019_transects.docx")



# 2020-----
ramets_e_ranova2_pb <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
  control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)),                              family = poisson)

# performance::check_model(ramets_e_ranova2_pb)

pb_ranova_transects(ramets_e_ranova2_pb,
          "Ramets before flowering: 2020",
          "./Figures_Tables/ranova_PVE/Growth/ramets_early_2020_transects.docx")


# 2021-----
ramets_e_ranova3_pb <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                              control = glmerControl(optimizer = "Nelder_Mead"),
                            family = poisson)

# performance::check_model(ramets_e_ranova3_pb)

pb_ranova_transects(ramets_e_ranova3_pb,
          "Ramets before flowering: 2021",
          "./Figures_Tables/ranova_PVE/Growth/ramets_early_2021_transects.docx")


# Ramets (after flowering)-------
# 2019-----
ramets_l_ranova1_pb <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2019),
                            na.action = na.exclude,
                     
                             family = poisson)

# performance::check_model(ramets_l_ranova1_pb)

pb_ranova_transects(ramets_l_ranova1_pb,
          "Ramets after flowering: 2019",
          "./Figures_Tables/ranova_PVE/Growth/ramets_late_2019_transects.docx")



# 2020-----
ramets_l_ranova2_pb <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
                     
                             family = poisson)

# performance::check_model(ramets_l_ranova2_pb)

pb_ranova_transects(ramets_l_ranova2_pb,
          "Ramets after flowering: 2020",
          "./Figures_Tables/ranova_PVE/Growth/ramets_late_2020_transects.docx")


# 2021-----
ramets_l_ranova3_pb <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                     
                             family = poisson)

# performance::check_model(ramets_l_ranova3_pb)

pb_ranova_transects(ramets_l_ranova3_pb,
          "Ramets after flowering: 2021",
          "./Figures_Tables/ranova_PVE/Growth/ramets_late_2021_transects.docx")



# Mortality-------
# 2019-----
surv_ranova1_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2019),
                            na.action = na.exclude,
                     
                             family = binomial)

# performance::check_model(surv_ranova1_pb)

pb_ranova_transects(surv_ranova1_pb,
          "Mortality: 2019",
          "./Figures_Tables/ranova_PVE/Growth/mortality_2019_transects.docx")


# 2020-----
surv_ranova2_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
                     
                             family = binomial)

# performance::check_model(surv_ranova2_pb)

pb_ranova_transects(surv_ranova2_pb,
          "Mortality: 2020",
          "./Figures_Tables/ranova_PVE/Growth/mortality_2020_transects.docx")


# 2021-----
surv_ranova3_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                
                             family = binomial)

# performance::check_model(surv_ranova3_pb)

pb_ranova_transects(surv_ranova3_pb,
          "Mortality: 2021",
          "./Figures_Tables/ranova_PVE/Growth/mortality_2021_transects.docx")


# 2022-----
surv_ranova4_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2022),
                            na.action = na.exclude,
                     
                             family = binomial)

# performance::check_model(surv_ranova4_pb)

pb_ranova_transects(surv_ranova4_pb,
          "Mortality: 2022",
          "./Figures_Tables/ranova_PVE/Growth/mortality_2022_transects.docx")


```

## Recalculate PVE for non-Gaussian models
As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution.
The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection.
These new PVEs will be estimates. This is *not* a perfect solution but it will help us approximate PVE for these variables.
### Q1
```{r}
# main models
ramets_e_lmer <- lmer(Ramets_early ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

ramets_l_lmer <- lmer(Ramets_late ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

survival_lmer <- lmer(as.numeric(Dead) ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2022),
                          na.action = na.exclude)

# get PVE from models
pve_rbf <- PVE_lm(ramets_e_lmer) 
pve_raf <- PVE_lm(ramets_l_lmer)
pve_surv <- PVE_lm(survival_lmer)

pve_rbf_city <- PVE_lm(update(ramets_e_lmer, .~. + City_dist))
pve_raf_city <- PVE_lm(update(ramets_l_lmer, .~. + City_dist))
pve_surv_city <- PVE_lm(update(survival_lmer, .~. + City_dist))

pve_rbf_urbsc <- PVE_lm(update(ramets_e_lmer, .~. + Urb_score))
pve_raf_urbsc <- PVE_lm(update(ramets_l_lmer, .~. + Urb_score))
pve_surv_urbsc <- PVE_lm(update(survival_lmer, .~. + Urb_score))


# make tables
recalc_tab1 <- pve_table_recalc(pve_rbf, pve_raf, pve_surv,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

recalc_tab2 <- pve_table_recalc(pve_rbf_city, pve_raf_city, pve_surv_city,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

recalc_tab3 <- pve_table_recalc(pve_rbf_urbsc, pve_raf_urbsc, pve_surv_urbsc,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

# Export to word
export_recalc(recalc_tab1,
              recalc_tab2,
              recalc_tab3,
              "./Figures_Tables/ranova_PVE/Growth/PVE_nonGaussmods/PVE_nonGaussmods_growth_Q1.docx")

```

### Q2
```{r}
# main models
ramets_e_lmer2 <- update(ramets_e_lmer,
                             data = heights %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"))

ramets_l_lmer2 <- update(ramets_l_lmer,
                             data = heights %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"))

survival_lmer2 <- update(survival_lmer,
                             data = survival %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))
# get PVE from models
pve_rbf2 <- PVE_lm(ramets_e_lmer2) 
pve_raf2 <- PVE_lm(ramets_l_lmer2)
pve_surv2 <- PVE_lm(survival_lmer2)

pve_rbf_city2 <- PVE_lm(update(ramets_e_lmer2, .~. + City_dist*Transect_ID))
pve_raf_city2 <- PVE_lm(update(ramets_l_lmer2, .~. + City_dist*Transect_ID))
pve_surv_city2 <- PVE_lm(update(survival_lmer2, .~. + City_dist*Transect_ID))

pve_rbf_urbsc2 <- PVE_lm(update(ramets_e_lmer2, .~. + Urb_score*Transect_ID))
pve_raf_urbsc2 <- PVE_lm(update(ramets_l_lmer2, .~. + Urb_score*Transect_ID))
pve_surv_urbsc2 <- PVE_lm(update(survival_lmer2, .~. + Urb_score*Transect_ID))


# make tables
recalc_tab1_Q2 <- pve_table_recalc(pve_rbf2, pve_raf2, pve_surv2,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

recalc_tab2_Q2 <- pve_table_recalc(pve_rbf_city2, pve_raf_city2, pve_surv_city2,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

recalc_tab3_Q2 <- pve_table_recalc(pve_rbf_urbsc2, pve_raf_urbsc2, pve_surv_urbsc2,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

# Export to word
export_recalc(recalc_tab1_Q2,
              recalc_tab2_Q2,
              recalc_tab3_Q2,
              "./Figures_Tables/ranova_PVE/Growth/PVE_nonGaussmods/PVE_nonGaussmods_growth_Q2.docx")
```



## Create figure showing % variance explained per component
Note: Can only do this for gaussian models for Q1. For models with transect as an effect, I can calculate PVE for models testing effect of distance only- not transect. But since I'm not as interested in that, I won't generate those plots now.
```{r}

# can't figure out how to convert these ranova html tables with PVE into df or tibble or anything else with code.
# So I'll just create an excel file combining the data from traits for which I could calculate PVE ("PVE_growth_Q1.xlsx"), including these traits:
# -relative growth rate ("rgr.html")
# -LDMC ("ldmc.html")
# -SLA ("sla.html")
# -Height (before flowering) ("heights_early.html")
# -Height (after flowering) ("heights_late.html")



pve <- read.csv(here::here("./Figures_Tables/ranova_PVE/Growth/pve_growth_Q1.csv")) %>%
  dplyr::rename(Variable = 1) %>%
  # make alphabetical order for plot
   mutate(Variable = fct_reorder(Variable,
                                 desc(Variable)))

library("ggsci")

pve_growth <- ggplot(pve,
       aes(
         fill=Group,
         y=PVE,
         x=Variable)
       ) + 
  geom_bar(position="stack",
           stat="identity") +
  scale_fill_discrete(labels = c("Family",
                                 "Population",
                                 "Residual")) +
  scale_fill_tron(alpha = 0.7) +
  theme_pubr() +
  xlab("") +
  ylab("% Variance Explained") +
  coord_flip()
pve_growth

ggsave(filename = "pve_growth_Q1.png",
         plot = pve_growth,
         path = here::here("./Growth_trait_analyses/Figures/PVE/"),
         width = 20,
         height = 8,
         units = "cm")
```
