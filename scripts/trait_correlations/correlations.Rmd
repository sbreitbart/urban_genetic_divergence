# Load libraries
```{r}
source("libraries.R")
library(GGally)
library(corrplot)
library(colorRamps)
```

# Import data (multi-year models)
## Reproductive traits
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))

# save list of models as reprod_models
reprod_models <- all_models
```

## Defense traits
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_Defense.Rmd", quiet=TRUE))

# save list of models as defense_models
defense_models <- all_models
```

## Growth traits
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_Growth.Rmd", quiet=TRUE))

# save list of models as growth_models
growth_models <- all_models
```

# Extract only city_dist/gradient models
## Defense traits
```{r}
defense_city_gr <- defense_models %>%
  purrr::flatten() %>%
  keep(grepl('gr', names(.))) %>%
  keep(grepl('City', names(.)))

names(defense_city_gr) <- c(
"latex_mods"         ,
"herb_early_mods_binomial"    ,
"herb_early_mods_quant"    ,
"herb_late_mods_binomial"     ,
"herb_late_mods_quant"     ,
"weev_mods_binomial" ,
"weev_mods_quant")
```

## Growth traits
```{r}
growth_city_gr <- growth_models %>%
  purrr::flatten() %>%
  keep(grepl('gr', names(.))) %>%
  keep(grepl('City', names(.)))

names(growth_city_gr) <- c(
"ldmc_mods",
"sla_mods",
"heights_early_mods",
"heights_late_mods",
"rgr_mods",
"ramets_early_mods",
"ramets_late_mods" ,
"mortality_mods" 
  )
```

## Reproductive traits
```{r}
reprod_city_gr <- reprod_models %>%
  purrr::flatten() %>%
  keep(grepl('gr', names(.))) %>%
  keep(grepl('City', names(.)))

names(reprod_city_gr) <- c(
"flsucc_mods"          ,
"flowers_mods"         ,
"flsize_mods"          ,
"fltime_mods",
"flstart_mods",
"poll_mods"            ,
"pods_mods"            ,
"firstpods_mods"            ,
"peduncles_mods")
```


## Cardenolide model
```{r}
# cardenolides per population (pooled)
cards <-  read.csv(here::here("./data/CommonGardenExperiment_2020Data/clean_data/2020_cardenolides_clean.csv")) %>%
  dplyr::select(., -1)

cards$Population <- as.character(cards$Population)
```

## Join lists (without cardenolides yet)
```{r}
all <- c(reprod_city_gr,
  growth_city_gr,
  defense_city_gr)
```

# Generate df of BLUPs from each trait
```{r}
blup_list <- function(list){
  
  all_blups <- list[[1]] %>%
    ranef() %>%
    extract2("cond") %>%
    extract2("Population") %>%
    rownames_to_column("Population") %>%
    dplyr::select("Population")
  
  for (i in 1:length(list)){
    
    var_name <- list[[i]][["call"]][["formula"]][[2]] %>%
      toString()
    
    blup <- list[[i]] %>%
      ranef() %>%
      extract2("cond") %>%
      extract2("Population") %>%
      rownames_to_column("Population") %>%
      rename(!!var_name:=2)
      
    all_blups <- join(all_blups, blup, by = "Population")
  }
  return(all_blups)
}

all_blups <- blup_list(all) %>%
# back-transform traits transformed in lmers
  dplyr::mutate(mean_poll =          .[[7]]^2, # inverse of sqrt(x)
                LDMC =               .[[11]]^2, # inverse of sqrt(x)
                SLA =                exp(.[[12]] + 1), # inverse of log, adding 1 to avoid -Inf
                Total_height_early = .[[13]]^3, # inverse of x^(1/3)
                Total_height_late =  .[[14]]^3, # "
                Rel_growth_rate =    .[[15]]^3, # "
                Latex =              .[[19]]^3, # "
                Herbivory_mean_early=exp(.[[21]] + 1), # inverse of log, adding 1 to avoid -Inf
                Herbivory_mean_late =exp(.[[23]] + 1), # "
                Scar_length_cm =     exp(.[[25]] + 1)) %>% # "
  dplyr::select(-c(7,11:15, 19, 21, 23, 25)) %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  left_join(., cards[,c(2,10)], by = "Population") %>% # add cardenolides
  dplyr::mutate(cardenolides = total) %>%
  dplyr::select(-total)

oldnames <- colnames(all_blups)
newnames <- c("Population",
             "Flowering success",
             "Flowers per inflorescence",
             "Flower size",
             "Flowering duration",
             "Date of first flower",
             "Follicles",
             "Date of first follicle",
             "Inflorescences",
             "Ramets \n before flowering",
             "Ramets \n after flowering",
             "Mortality",
             "Herbivory before flowering\n (binary)",
             "Herbivory after flowering\n (binary)",
             "Milkweed stem weevil\n damage (binary)",
             "Pollinaria removed",
             "LDMC",
             "SLA",
             "Height before flowering",
             "Height after flowering",
             "Relative growth rate",
             "Latex exudation",
             "Herbivory before flowering\n (quantitative)",
             "Herbivory after flowering\n (quantitative)",
             "Milkweed stem weevil\n damage (quantitative)",
             "Total cardenolide \nconcentration"
)

all_blups %<>%
  rename_at(vars(oldnames), ~ newnames) %>%
  # arrange traits by life history category
  dplyr::relocate('Latex exudation',
                  .before = 'Herbivory before flowering\n (binary)') %>%
  dplyr::relocate('Herbivory before flowering\n (quantitative)',
                  .after = 'Herbivory before flowering\n (binary)') %>%
  dplyr::relocate('Herbivory after flowering\n (quantitative)',
                  .after = 'Herbivory after flowering\n (binary)') %>%
  dplyr::relocate('Milkweed stem weevil\n damage (quantitative)',
                  .after = 'Milkweed stem weevil\n damage (binary)') %>%
  dplyr::relocate('Total cardenolide \nconcentration',
                  .after = 'Milkweed stem weevil\n damage (quantitative)')
```

# Generate correlation matrix
## Population-level trait correlations
```{r}
correlations <- rcorr(as.matrix(all_blups[-1])) # take out population column

# save r values as separate df
correlations.r <- correlations$r %>%
  as.data.frame() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  mutate(across(where(is.numeric), round, 3))

# save p values as separate df
correlations.p <- correlations$P %>%
  as.data.frame() %>%
  mutate(across(where(is.numeric), round, 3))


# then export it
correlations.r %>%
  tibble::rownames_to_column(" ") %>%
   flextable() %>%
  save_as_html(., path = here::here("./Figures_Tables/correlations/r_values.html"))


correlations.p %>%
  tibble::rownames_to_column(" ") %>%
   flextable() %>%
  save_as_html(., path = here::here("./Figures_Tables/correlations/p_values.html"))

```

## Individual-level trait correlations
### combine all data into one df
```{r}
## cardenolides excluded because we only have population-level values

# prep dfs
weevil %<>%
  dplyr::select(-Total_Height_early,
                -scar_div_earlyheight) %>%
  dplyr::mutate(Row = as.factor(Row))

survival %<>%
  dplyr::mutate(Row = as.factor(Row))

sla_ldmc %<>%
  dplyr::select(-c(9:23, 26)) %>%
  dplyr::mutate(Year = "2020") %>%
  dplyr::mutate(Row = as.factor(Row))

reproduc %<>%
  dplyr::mutate(Row = as.factor(Row))

herbivory %<>%
  dplyr::select(-c(16:19)) %>%
  dplyr::mutate(Row = as.factor(Row))

heights %<>%
  dplyr::select(-c(7:10, 14, 23, 26:27)) %>%
  dplyr::mutate(Row = as.factor(Row),
                Column = as.factor(Column))

flowering %<>%
  dplyr::select(-c(8:9, 11, 14:Flower_mean)) %>%
  dplyr::mutate(Row = as.factor(Row),
                Column = as.factor(Column))

latex %<>%
  dplyr::select(-c(8:13)) %>%
  dplyr::mutate(Year = "2020") %>%
  dplyr::mutate(Row = as.factor(Row))

cols_to_join_by = c("Population", "Row", "Column", "Block", "Family", "Replicate", "Year")


# join all
all_data <- full_join(weevil,
                      survival,
                      by = cols_to_join_by) %>%
  full_join(.,
            sla_ldmc,
            by = cols_to_join_by) %>%
  full_join(.,
            reproduc,
            by = cols_to_join_by) %>%
  full_join(.,
            herbivory,
            by = cols_to_join_by) %>%
  dplyr::mutate(Column = as.factor(Column)) %>%
  full_join(.,
            latex,
            by = cols_to_join_by) %>%
  full_join(.,
            flowering,
            by = cols_to_join_by) %>%
  full_join(.,
            heights,
            by = cols_to_join_by) %>%

# remove unnecessary cols
  dplyr::select(-starts_with(c("Patch",
                               "Latit",
                               "Longit",
                               "Transect",
                               "CTD",
                               "City",
                               "Urb_",
                               "Pop_",
                               "Fam_",
                               "Comment"
                               ))) %>%
  dplyr::select(-c(1:6, 
                   "Year", "Date", "Weevil_dam_binary",
                   "total_flower_count"))
```

### Make names identical to population-level matrix
```{r}
oldnames_indiv <- colnames(all_data)
newnames_indiv <- c(
  "Milkweed stem weevil\n damage (quantitative)",
  "Milkweed stem weevil\n damage (binary)",
  "Mortality",
  "SLA",
  "LDMC",
  "Flowering success",
  "Herbivory after flowering\n (quantitative)",
  "Herbivory before flowering\n (quantitative)",
  "Herbivory before flowering\n (binary)",
  "Herbivory after flowering\n (binary)",
  "Latex exudation",
  "Flowering duration", 
  "Follicles",
  "Inflorescences",          
  "Flower size",
  "Flowers per inflorescence",
  "Pollinaria removed",   
  "Date of first flower",
  "Date of first follicle",
  "Ramets \n before flowering",
  "Ramets \n after flowering",
  "Height after flowering",
  "Relative growth rate",
  "Height before flowering")

all_data %<>%
  rename_at(vars(oldnames_indiv), ~ newnames_indiv)

# arrange traits by life history category
colnames_new_order <- c(
  "Flowering success",
  "Flowers per inflorescence",
  "Flower size",
  "Flowering duration",
  "Date of first flower",
  "Follicles",
  "Date of first follicle",
  "Inflorescences",
  "Ramets \n before flowering",
  "Ramets \n after flowering",
  "Mortality",
  "Latex exudation",
  "Herbivory before flowering\n (binary)",
  "Herbivory before flowering\n (quantitative)",
  "Herbivory after flowering\n (binary)",
  "Herbivory after flowering\n (quantitative)",
  "Milkweed stem weevil\n damage (binary)",
  "Milkweed stem weevil\n damage (quantitative)",
  "Pollinaria removed",
  "LDMC",
  "SLA",
  "Height before flowering",
  "Height after flowering",
  "Relative growth rate"
)

# Reorder columns in the data frame
all_data %<>%
  dplyr::select(all_of(colnames_new_order))

```


### generate correlations
```{r}

correlations_indiv <- rcorr(as.matrix(all_data))

# save r values as separate df
correlations.r_indiv <- correlations_indiv$r %>%
  as.data.frame() %>%
  mutate_all(~ifelse(is.nan(.), NA, .)) %>%
  mutate(across(where(is.numeric), round, 3))

# save p values as separate df
correlations.p_indiv <- correlations_indiv$P %>%
  as.data.frame() %>%
  mutate(across(where(is.numeric), round, 3))


# then export it
correlations.r_indiv %>%
  tibble::rownames_to_column(" ") %>%
   flextable() %>%
  save_as_html(., path = here::here("./Figures_Tables/correlations/r_values_indivs.html"))


correlations.p_indiv %>%
  tibble::rownames_to_column(" ") %>%
   flextable() %>%
  save_as_html(., path = here::here("./Figures_Tables/correlations/p_values_indivs.html"))

```

# Visualize
## Scatterplot matrix
### Population-level trait correlations
```{r}

# correlations.r[correlations.r == 1] <- NA # replace all perfect correlations (1; var A on var A; var B on var B; etc.) with NAs

ggpairs(correlations.r) 

dev.copy2pdf(file = here::here("./Figures_Tables/correlations/scatterplot_matrix_longnames.pdf"),
             width = 45, height = 45)

```

### Individual-level trait correlations
```{r}
ggpairs(correlations.r_indiv) 

dev.copy2pdf(file = here::here("./Figures_Tables/correlations/scatterplot_matrix_longnames_indivs.pdf"),
             width = 45, height = 45)

```

## Heatmaps
### Color palettes
```{r}

col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))

col2 <- colorRampPalette(c("blue","white","red"))
```

### Population-level trait correlations
```{r}
# show with p values
corrplot(
  cor(all_blups[,c(-1)], # remove population col
             use="complete.obs"),
  method = "color",
  shade.col = NA,
  tl.col = "black",
  tl.cex = 0.25,
  tl.srt = 45,
  col = col2(200),
  # addCoef.col = "black", # add correlation coefficients
  order = "original",
  diag = FALSE,
  type = "upper",
  cl.length = 5,
  cl.cex = 0.5,
  cl.ratio = 0.2,
  cl.align.text = "l",
  # p.mat = cor.mtest(all_blups[,c(-1)], conf.level = 0.95)$p,
  # insig = 'p-value',
  sig.level = -1)

dev.copy2pdf(file = here::here("./Figures_Tables/correlations/heatmap_original.pdf"),
             width = 5, height = 5)




# show with p value asterisks
corrplot(
  cor(all_blups[,c(-1)],
             use="complete.obs"),
  method = "color",
  shade.col = NA,
  tl.col = "black",
  tl.cex = 0.25,
  tl.srt = 45,
  col = col2(200),
  order = "original",
  diag = FALSE,
  type = "upper",
  p.mat = cor.mtest(all_blups[,c(-1)], conf.level = 0.95)$p,
  sig.level = c(0.001, 0.01, 0.05),
  pch.cex = 0.7,
  insig = 'label_sig',
  pch.col = 'grey20',
  cl.length = 5,
  cl.cex = 0.5,
 # cl.ratio = 0.2,
  cl.align.text = "l")

dev.copy2pdf(file = here::here("./Figures_Tables/correlations/heatmap_with_p_asterisks.pdf"),
             width = 5, height = 5)


# show with r values
corrplot(
  cor(all_blups[,c(-1)],
             use="complete.obs"),
  method = "color",
  shade.col = NA,
  tl.col = "black",
  tl.cex = 0.25,
  tl.srt = 45,
  col = col2(200),
  number.cex = 0.25,
  addCoef.col = "black",
 # cl.pos = "n",
  pch.cex = 0.7,
  order = "original", 
  diag = FALSE,
  type = "upper",
  cl.length = 5,
  cl.cex = 0.5,
  cl.ratio = 0.2,
  cl.align.text = "l")


dev.copy2pdf(file = here::here("./Figures_Tables/correlations/heatmap_with_r.pdf"),
             width = 5, height = 5)
```

### Individual-level trait correlations
```{r}
# show with p values

all_data %<>%
  dplyr::mutate_if(is.factor,
                   as.numeric) %>%
  dplyr::mutate_if(is.difftime,
                   as.numeric)

cor1 <- cor(all_data,
      use="pairwise.complete.obs")
cor1[is.na(cor1)] <- 0


corrplot(
  cor1,
  method = "color",
  shade.col = NA,
  tl.col = "black",
  tl.cex = 0.25,
  tl.srt = 45,
  col = col2(200),
  order = "original",
  diag = FALSE,
  type = "upper",
  cl.length = 5,
  cl.cex = 0.5,
  cl.ratio = 0.2,
  cl.align.text = "l",
  sig.level = -1)

dev.copy2pdf(file = here::here("./Figures_Tables/correlations/heatmap_original_indivs.pdf"),
             width = 5, height = 5)




# show with p value asterisks
corrplot(
  cor1,
  method = "color",
  shade.col = NA,
  tl.col = "black",
  tl.cex = 0.25,
  tl.srt = 45,
  col = col2(200),
  order = "original",
  diag = FALSE,
  type = "upper",
  p.mat = cor.mtest(all_data %>%
        dplyr::mutate_if(is.factor, as.numeric),
        conf.level = 0.95)$p,
  sig.level = c(0.001, 0.01, 0.05),
  pch.cex = 0.7,
  insig = 'label_sig',
  pch.col = 'grey20',
  cl.length = 5,
  cl.cex = 0.5,
  cl.align.text = "l")

dev.copy2pdf(file = here::here("./Figures_Tables/correlations/heatmap_with_p_asterisks_indivs.pdf"),
             width = 5, height = 5)


# show with r values
corrplot(
  cor1,
  method = "color",
  shade.col = NA,
  tl.col = "black",
  tl.cex = 0.25,
  tl.srt = 45,
  col = col2(200),
  number.cex = 0.25,
  addCoef.col = "black",
  pch.cex = 0.7,
  order = "original", 
  diag = FALSE,
  type = "upper",
  cl.length = 5,
  cl.cex = 0.5,
  cl.ratio = 0.2,
  cl.align.text = "l")


dev.copy2pdf(file = here::here("./Figures_Tables/correlations/heatmap_with_r_indivs.pdf"),
             width = 5, height = 5)
```
