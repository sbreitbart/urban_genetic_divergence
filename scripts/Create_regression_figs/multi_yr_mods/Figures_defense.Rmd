# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import data & models
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_defense.Rmd", quiet=TRUE))
```

# Create ggpredict objects (lmers)
## Latex
### Gradient
```{r}
# ggpredict can't read ^(1/3) so I'll manually cube-root transform latex column, then read that into ggpredict objects

latex$Latex_weight_mg_cuberoot <- latex$Latex_weight_mg^(1/3)

ggpred_latex1 <- glmmTMB(Latex_weight_mg_cuberoot ~
                            Block +
                            (1|Population/Family) +
                            City_dist,
                        data = latex,
                        REML = F)

ggpred_latex2 <- update(ggpred_latex1, .~. -City_dist + Urb_score)

# city_dist
latex_mods_best_c[1]
latex_gradient_01_pred <- ggeffects::ggpredict(ggpred_latex1,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
latex_mods_best_u[1]
latex_gradient_02_pred <- ggeffects::ggpredict(ggpred_latex2,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# ggpredict can't read ^(1/3) so I'll manually cube-root transform latex column, then read that into ggpredict objects

ggpred_latex3 <- glmmTMB(Latex_weight_mg_cuberoot ~
                            Block +
                            (1|Population/Family) +
                            City_dist + Transect_ID,
                        data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                        REML = F)

ggpred_latex4 <- glmmTMB(Latex_weight_mg_cuberoot ~
                            Block +
                            (1|Population/Family) +
                            Urb_score * Transect_ID,
                        data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                        REML = F)

# city_dist
latex_mods_best_c[2]
latex_urbsubs_01_pred <- ggeffects::ggpredict(ggpred_latex3,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
latex_mods_best_u[2]
latex_urbsubs_02_pred <- ggeffects::ggpredict(ggpred_latex4,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Herbivory- Early- binary
### Gradient
```{r}
# city_dist
herb_e_bin_mods_best_c[1] 
herb_e_bin_gradient_01_pred <- ggeffects::ggpredict(herb_e_bin_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
herb_e_bin_mods_best_u[1]
herb_e_bin_gradient_02_pred <- ggeffects::ggpredict(herb_e_bin_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
herb_e_bin_mods_best_c[2]
herb_e_bin_urbsubs_01_pred <- ggeffects::ggpredict(herb_e_bin_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
herb_e_bin_mods_best_u[2]
herb_e_bin_urbsubs_02_pred <- ggeffects::ggpredict(herb_e_bin_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```

## Herbivory- Early- quantitative
### Gradient
```{r}
# city_dist
herb_e_quant_mods_best_c[1] # log-transformed
herb_e_quant_gradient_01_pred <- ggeffects::ggpredict(herb_e_quant_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
herb_e_quant_mods_best_u[1] # log-transformed
herb_e_quant_gradient_02_pred <- ggeffects::ggpredict(herb_e_quant_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
herb_e_quant_mods_best_c[2] # log-transformed
herb_e_quant_urbsubs_01_pred <- ggeffects::ggpredict(herb_e_quant_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
herb_e_quant_mods_best_u[2] # log-transformed
herb_e_quant_urbsubs_02_pred <- ggeffects::ggpredict(herb_e_quant_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```

## Herbivory- Late- binary
### Gradient
```{r}
# city_dist
herb_l_bin_mods_best_c[1] 
herb_l_bin_gradient_01_pred <- ggeffects::ggpredict(herb_l_bin_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
herb_l_bin_mods_best_u[1]
herb_l_bin_gradient_02_pred <- ggeffects::ggpredict(herb_l_bin_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
herb_l_bin_mods_best_c[2]
herb_l_bin_urbsubs_01_pred <- ggeffects::ggpredict(herb_l_bin_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
herb_l_bin_mods_best_u[2]
herb_l_bin_urbsubs_02_pred <- ggeffects::ggpredict(herb_l_bin_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```

## Herbivory- Late- quantitative
### Gradient
```{r}
# city_dist
herb_l_quant_mods_best_c[1] # log-transformed
herb_l_quant_gradient_01_pred <- ggeffects::ggpredict(herb_l_quant_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
herb_l_quant_mods_best_u[1] # log-transformed
herb_l_quant_gradient_02_pred <- ggeffects::ggpredict(herb_l_quant_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
herb_l_quant_mods_best_c[2] # log-transformed
herb_l_quant_urbsubs_01_pred <- ggeffects::ggpredict(herb_l_quant_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
herb_l_quant_mods_best_u[2] # log-transformed
herb_l_quant_urbsubs_02_pred <- ggeffects::ggpredict(herb_l_quant_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```
## Weevil damage- binary
### Gradient
```{r}
# city_dist
weev_bin_mods_best_c[1]
weev_b_gradient_01_pred <- ggeffects::ggpredict(weev_bin_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
weev_bin_mods_best_u[1]
weev_b_gradient_02_pred <- ggeffects::ggpredict(weev_bin_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
weev_bin_mods_best_c[2]
weev_bin_urbsubs_01_pred <- ggeffects::ggpredict(weev_bin_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
weev_bin_mods_best_u[2]
weev_bin_urbsubs_02_pred <- ggeffects::ggpredict(weev_bin_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Weevil damage- quantitative
### Gradient
```{r}
# city_dist
weev_quant_mods_best_c[1] # log-TRANSFORMED
weev_q_gradient_01_pred <- ggeffects::ggpredict(weev_quant_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
weev_quant_mods_best_u[1] # log-TRANSFORMED
weev_q_gradient_02_pred <- ggeffects::ggpredict(weev_quant_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
weev_quant_mods_best_c[2]  # log-TRANSFORMED
weev_quant_urbsubs_01_pred <- ggeffects::ggpredict(weev_urbsubs_dist_m2_quant,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
weev_quant_mods_best_u[2] # log-TRANSFORMED
weev_quant_urbsubs_02_pred <- ggeffects::ggpredict(weev_quant_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

# Create regression plots (lmers)
## Gradient
### City_dist
```{r}
# LATEX-----
ggpred_Q1.citydist_latex <- ggplot(latex_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Latex exudation (mg) " ^{1/3})) +
  # ylim(1.8, 2.2) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ",
                                   tidy_anova(latex_mods_best_c[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_latex


# herbivory, early- binary-----
ggpred_Q1.citydist_herb_e_bin <- ggplot(herb_e_bin_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of herbivory \n (before flowering)") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.6, 1),
    breaks = c(.6, .7, 0.8, 0.9, 1)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(herb_e_bin_mods_best_c[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_herb_e_bin



# herbivory, early- quantitative-----
ggpred_Q1.citydist_herb_e_quant <- ggplot(herb_e_quant_gradient_01_pred) +
  rep_geoms +
  ylim(0, 0.05) +
  labs(x = "Distance to Urban Center (km)",
       y = "log(Herbivory before flowering)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.15, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(herb_e_quant_mods_best_c[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_herb_e_quant


# herbivory, late- binary-----
ggpred_Q1.citydist_herb_l_bin <- ggplot(herb_l_bin_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of herbivory \n (after flowering)") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.8, 1),
    breaks = c(.8, 0.9, 1)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(herb_l_bin_mods_best_c[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_herb_l_bin



# herbivory, late- quantitative-----
ggpred_Q1.citydist_herb_l_quant <- ggplot(herb_l_quant_gradient_01_pred) +
  rep_geoms +
  ylim(0, 0.1) +
  labs(x = "Distance to Urban Center (km)",
       y = "log(Herbivory after flowering)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(herb_l_quant_mods_best_c[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_herb_l_quant


# weevil damage- binary-----
ggpred_Q1.citydist_weev_bin <- ggplot(weev_b_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of weevil damage") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.25, 0.75),
    breaks = c(0.25, .5, .75)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(weev_bin_mods_best_c[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_weev_bin



# weevil damage- quantitative-----
ggpred_Q1.citydist_weev_quant <- ggplot(weev_q_gradient_01_pred) +
  rep_geoms +
  ylim(2, NA) +
  labs(x = "Distance to Urban Center (km)",
       y = "Weevil scar length (cm)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.15, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(weev_quant_mods_best_c[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_weev_quant
```

### Urbanization Score
```{r}
# LATEX-----
ggpred_Q1.urbscore_latex <- ggplot(latex_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression("Latex exudation (mg) " ^{1/3})) +
    xlim(4, -4) +
   ylim(NA, 2.2) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(latex_mods_best_u[[1]]) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_latex

# herbivory, early- binary-----
ggpred_Q1.urbscore_herb_e_bin <- ggplot(herb_e_bin_gradient_02_pred) +
  rep_geoms +
      xlim(4, -4) +
labs(x = "Urbanization Score",
       y = "Chance of herbivory \n (before flowering)") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.7, 0.9),
    breaks = c(0.7, 0.8, 0.9)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_e_bin_mods_best_u[[1]]) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_herb_e_bin



# herbivory, early- quantitative-----
ggpred_Q1.urbscore_herb_e_quant <- ggplot(herb_e_quant_gradient_02_pred) +
  rep_geoms +
      xlim(4, -4) +
  ylim(0, 0.04) +
  labs(x = "Urbanization Score",
       y = "log(Herbivory before flowering)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.15, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_e_quant_mods_best_u[[1]]) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_herb_e_quant


# herbivory, late- binary-----
ggpred_Q1.urbscore_herb_l_bin <- ggplot(herb_l_bin_gradient_02_pred) +
  rep_geoms +
      xlim(4, -4) +
labs(x = "Urbanization Score",
       y = "Chance of herbivory \n (after flowering)") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.8, 1),
    breaks = c(0.8, 0.9, 1)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_l_bin_mods_best_u[[1]]) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_herb_l_bin



# herbivory, late- quantitative-----
ggpred_Q1.urbscore_herb_l_quant <- ggplot(herb_l_quant_gradient_02_pred) +
  rep_geoms +
      xlim(4, -4) +
  ylim(0, 0.1) +
  labs(x = "Urbanization Score",
       y = "log(Herbivory after flowering)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_l_quant_mods_best_u[[1]]) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_herb_l_quant


# weevil damage- binary-----
ggpred_Q1.urbscore_weev_bin <- ggplot(weev_b_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = "Chance of weevil damage") +
    xlim(4, -4) +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.4, 0.7),
    breaks = c(0.4, 0.5, 0.6, 0.7)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(weev_bin_mods_best_u[[1]]) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_weev_bin



# weevil damage- quantitative-----
ggpred_Q1.urbscore_weev_quant <- ggplot(weev_q_gradient_02_pred) +
  rep_geoms +
  ylim(2, 5) +
  xlim(4, -4) +
  labs(x = "Urbanization Score",
       y = "Weevil scar length (cm)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(weev_quant_mods_best_u[[1]]) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_weev_quant
```

## Urban Subtransects
### City_dist
```{r}
# latex-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
latex_urbsubs_01_pred$group <- factor(latex_urbsubs_01_pred$group,
                                   levels(latex_urbsubs_01_pred$group)[c(2,1)])
levels(latex_urbsubs_01_pred$group)

ggpred_Q2.citydist_latex <- 
ggplot(latex_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Latex exudation (g) "^{1/3}),
       color = "Transect",
       fill = "Transect") +
  ylim(1.7, 2.2) +
    xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(latex_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(latex_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_latex

# herbivory, before flowering: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_e_bin_urbsubs_01_pred$group <- factor(herb_e_bin_urbsubs_01_pred$group,
                                   levels(herb_e_bin_urbsubs_01_pred$group)[c(2,1)])
levels(herb_e_bin_urbsubs_01_pred$group)


ggpred_Q2.citydist_herb_e_bin <- 
ggplot(herb_e_bin_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of herbivory \n (before flowering)",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.5, 1),
    breaks = c(0.5, .75, 1)
    ) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.2,
                    label = paste0(" Distance: p = ", tidy_anova(herb_e_bin_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.13,
                    label = paste0(" Transect: p = ", tidy_anova(herb_e_bin_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.06,
                    label = paste0(" D x T: p = ", tidy_anova(herb_e_bin_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center x Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_herb_e_bin


# herbivory, before flowering: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_e_quant_urbsubs_01_pred$group <- factor(herb_e_quant_urbsubs_01_pred$group,
                                   levels(herb_e_quant_urbsubs_01_pred$group)[c(2,1)])
levels(herb_e_quant_urbsubs_01_pred$group)


ggpred_Q2.citydist_herb_e_quant <- 
ggplot(herb_e_quant_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = ("log(Herbivory, before flowering)"),
       color = "Transect",
       fill = "Transect") +
  ylim(0, 0.1) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.95,
                    label = paste0(" Distance: p = ", tidy_anova(herb_e_quant_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.87,
                    label = paste0(" Transect: p = ", tidy_anova(herb_e_quant_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)+
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.8,
                    label = paste0(" D x T: p = ", tidy_anova(herb_e_quant_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center x Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_herb_e_quant

# herbivory, after flowering: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_l_bin_urbsubs_01_pred$group <- factor(herb_l_bin_urbsubs_01_pred$group,
                                   levels(herb_l_bin_urbsubs_01_pred$group)[c(2,1)])
levels(herb_l_bin_urbsubs_01_pred$group)


ggpred_Q2.citydist_herb_l_bin <- 
ggplot(herb_l_bin_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of herbivory \n (after flowering)",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.8, 1),
    breaks = c(0.8, 0.9, 1)
    ) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.15,
                    label = paste0(" Distance: p = ", tidy_anova(herb_l_bin_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Transect: p = ", tidy_anova(herb_l_bin_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.citydist_herb_l_bin


# herbivory, after flowering: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_l_quant_urbsubs_01_pred$group <- factor(herb_l_quant_urbsubs_01_pred$group,
                                   levels(herb_l_quant_urbsubs_01_pred$group)[c(2,1)])
levels(herb_l_quant_urbsubs_01_pred$group)


ggpred_Q2.citydist_herb_l_quant <- 
ggplot(herb_l_quant_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = ("log(Herbivory, after flowering)"),
       color = "Transect",
       fill = "Transect") +
  ylim(0, 0.1) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.14,
                    label = paste0(" Distance: p = ", tidy_anova(herb_l_quant_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.06,
                    label = paste0(" Transect: p = ", tidy_anova(herb_l_quant_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_herb_l_quant

# Weevil damage: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
weev_bin_urbsubs_01_pred$group <- factor(weev_bin_urbsubs_01_pred$group,
                                   levels(weev_bin_urbsubs_01_pred$group)[c(2,1)])
levels(weev_bin_urbsubs_01_pred$group)


ggpred_Q2.citydist_weev_bin <- 
ggplot(weev_bin_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of weevil damage",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.25, 0.7),
    breaks = c(0.3, 0.4, 0.5, 0.6, 0.7)
    ) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.15,
                    label = paste0(" Distance: p = ", tidy_anova(weev_bin_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Transect: p = ", tidy_anova(weev_bin_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_weev_bin


# Weevil damage: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
weev_quant_urbsubs_01_pred$group <- factor(weev_quant_urbsubs_01_pred$group,
                                   levels(weev_quant_urbsubs_01_pred$group)[c(2,1)])
levels(weev_quant_urbsubs_01_pred$group)


ggpred_Q2.citydist_weev_quant <- 
ggplot(weev_quant_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = "Weevil scar length (cm)",
       color = "Transect",
       fill = "Transect") +
  ylim(2,5) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.96,
                    label = paste0(" Distance: p = ", tidy_anova(weev_quant_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.89,
                    label = paste0(" Transect: p = ", tidy_anova(weev_quant_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_weev_quant

```

### Urbanization Score
```{r}
# latex-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
latex_urbsubs_02_pred$group <- factor(latex_urbsubs_02_pred$group,
                                   levels(latex_urbsubs_02_pred$group)[c(2,1)])
levels(latex_urbsubs_02_pred$group)

ggpred_Q2.urbsubs_latex <- 
ggplot(latex_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = expression("Latex exudation (g) "^{1/3}),
       color = "Transect",
       fill = "Transect") +
  ylim(1.2, NA) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05,
                                   npcy = 0.22,
                    label = paste0(" Urb. Score: p = ", tidy_anova(latex_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.15,
                    label = paste0(" Transect: p = ", tidy_anova(latex_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" U x T: p = ", tidy_anova(latex_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score x Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_latex



# herbivory, before flowering: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_e_bin_urbsubs_02_pred$group <- factor(herb_e_bin_urbsubs_02_pred$group,
                                   levels(herb_e_bin_urbsubs_02_pred$group)[c(2,1)])
levels(herb_e_bin_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_herb_e_bin <- 
ggplot(herb_e_bin_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = "Chance of herbivory \n (before flowering)",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.7, 0.9),
    breaks = c(0.7, 0.8, 0.9)
    ) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.15,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_e_bin_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Transect: p = ", tidy_anova(herb_e_bin_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.urbsubs_herb_e_bin


# herbivory, before flowering: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_e_quant_urbsubs_02_pred$group <- factor(herb_e_quant_urbsubs_02_pred$group,
                                   levels(herb_e_quant_urbsubs_02_pred$group)[c(2,1)])
levels(herb_e_quant_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_herb_e_quant <- 
ggplot(herb_e_quant_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = ("log(Herbivory, before flowering)"),
       color = "Transect",
       fill = "Transect") +
  ylim(0, 0.1) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.95,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_e_quant_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(herb_e_quant_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)+
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.81,
                    label = paste0(" U x T: p = ", tidy_anova(herb_e_quant_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score x Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_herb_e_quant

# herbivory, after flowering: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_l_bin_urbsubs_02_pred$group <- factor(herb_l_bin_urbsubs_02_pred$group,
                                   levels(herb_l_bin_urbsubs_02_pred$group)[c(2,1)])
levels(herb_l_bin_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_herb_l_bin <- 
ggplot(herb_l_bin_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = "Chance of herbivory \n (after flowering)",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.8, 1),
    breaks = c(0.8, 0.9, 1)
    ) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.12,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_l_bin_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.05,
                    label = paste0(" Transect: p = ", tidy_anova(herb_l_bin_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.urbsubs_herb_l_bin


# herbivory, after flowering: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_l_quant_urbsubs_02_pred$group <- factor(herb_l_quant_urbsubs_02_pred$group,
                                   levels(herb_l_quant_urbsubs_02_pred$group)[c(2,1)])
levels(herb_l_quant_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_herb_l_quant <- 
ggplot(herb_l_quant_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = ("log(Herbivory, after flowering)"),
       color = "Transect",
       fill = "Transect") +
  ylim(0, 0.1) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.14,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb_l_quant_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.06,
                    label = paste0(" Transect: p = ", tidy_anova(herb_l_quant_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_herb_l_quant

# Weevil damage: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
weev_bin_urbsubs_02_pred$group <- factor(weev_bin_urbsubs_02_pred$group,
                                   levels(weev_bin_urbsubs_02_pred$group)[c(2,1)])
levels(weev_bin_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_weev_bin <- 
ggplot(weev_bin_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = "Chance of weevil damage",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.3, 0.7),
    breaks = c(0.3, 0.4, 0.5, 0.6, 0.7)
    ) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.12,
                    label = paste0(" Urb. Score: p = ", tidy_anova(weev_bin_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.05,
                    label = paste0(" Transect: p = ", tidy_anova(weev_bin_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_weev_bin


# Weevil damage: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
weev_quant_urbsubs_02_pred$group <- factor(weev_quant_urbsubs_02_pred$group,
                                   levels(weev_quant_urbsubs_02_pred$group)[c(2,1)])
levels(weev_quant_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_weev_quant <- 
ggplot(weev_quant_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = "Weevil scar length (cm)",
       color = "Transect",
       fill = "Transect") +
 ylim(1, 5) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.17,
                    label = paste0(" Urb. Score: p = ", tidy_anova(weev_quant_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Transect: p = ", tidy_anova(weev_quant_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_weev_quant

```

## Combine plots into one figure
### Gradient / City_dist
```{r}
gradient_citydist_plots <- ggarrange(
  ggpred_Q1.citydist_latex,
  ggpred_Q1.citydist_herb_e_bin,
  ggpred_Q1.citydist_herb_e_quant,
  ggpred_Q1.citydist_herb_l_bin,
  ggpred_Q1.citydist_herb_l_quant,
  ggpred_Q1.citydist_weev_bin,
  ggpred_Q1.citydist_weev_quant +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/multi_yr_mods/Defense/Q1_grad_citydist_Defense.pdf"),
             width = 14, height = 7.5)
```


### Gradient / Urbanization Score
```{r}
gradient_urbscore_plots <- ggarrange(
  ggpred_Q1.urbscore_latex,
  ggpred_Q1.urbscore_herb_e_bin,
  ggpred_Q1.urbscore_herb_e_quant,
  ggpred_Q1.urbscore_herb_l_bin,
  ggpred_Q1.urbscore_herb_l_quant,
  ggpred_Q1.urbscore_weev_bin,
  ggpred_Q1.urbscore_weev_quant +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/multi_yr_mods/Defense/Q1_grad_urbscore_Defense.pdf"),
             width = 14, height = 7.5)
```

### Urb Subtransects / City_dist
```{r}
urbsubs_citydist_plots <- ggarrange(
  ggpred_Q2.citydist_latex,
  ggpred_Q2.citydist_herb_e_bin,
  ggpred_Q2.citydist_herb_e_quant,
  ggpred_Q2.citydist_herb_l_bin,
  ggpred_Q2.citydist_herb_l_quant,
  ggpred_Q2.citydist_weev_bin,
  ggpred_Q2.citydist_weev_quant +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/multi_yr_mods/Defense/Q2_urbsubs_citydist_Defense.pdf"),
             width = 14.5, height = 8)
```


### Urb Subtransects / Urbanization Score
```{r}
urbsubs_urbscore_plots <- ggarrange(
  ggpred_Q2.urbsubs_latex,
  ggpred_Q2.urbsubs_herb_e_bin,
  ggpred_Q2.urbsubs_herb_e_quant,
  ggpred_Q2.urbsubs_herb_l_bin,
  ggpred_Q2.urbsubs_herb_l_quant,
  ggpred_Q2.urbsubs_weev_bin,
  ggpred_Q2.urbsubs_weev_quant +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/multi_yr_mods/Defense/Q2_urbsubs_urbscore_Defense.pdf"),
             width = 14.5, height = 8)
```

# Create regression plots (lms for cardenolides)
## City_dist
```{r warning=FALSE, message=FALSE}
# Total cards
cd_total <- ggplot(cards, aes(x = City_dist, y = total)) +
  # geom_point(size = 2,
  #            shape = 1) +
  geom_smooth(method = "lm",
                color = "#66a182",
                fill = "#66a182",
                size = 1,
                alpha = 0.3) +
  labs(x = "Distance to Urban Center (km)",
    y = "Total Cardenolides") +
  xlim(0, 71) +
  ylim(0,0.8) +
  theme_1() +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0("p = ", round(city_dist_list[["total"]][[2]][["Pr(>F)"]][1], 3))),
                size = 4.5)
cd_total



# 6.6
cd_66 <- ggplot(cards, aes(x = City_dist, y = X6.6_main)) +
  # geom_point(size = 2,
  #            shape = 1) +
  geom_smooth(method = "lm",
                color = "#66a182",
                fill = "#66a182",
                size = 1,
                alpha = 0.3) +
  labs(x = "Distance to Urban Center (km)",
    y = "Digitoxin peak 6.6") +
  xlim(0, 71) +
  ylim(0,0.6) +
  theme_1() +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0("p = ", round(city_dist_list[["X6.6_main"]][[2]][["Pr(>F)"]][1], 3))),
                size = 4.5)


# 15
cd_15 <-ggplot(cards, aes(x = City_dist, y = X15_main)) +
  # geom_point(size = 2,
  #            shape = 1) +
  geom_smooth(method = "lm",
                color = "#66a182",
                fill = "#66a182",
                size = 1,
                alpha = 0.3) +
  labs(x = "Distance to Urban Center (km)",
    y = "Digitoxin peak 15") +
  xlim(0, 71) +
  ylim(0,0.2) +
  theme_1() +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0("p = ", round(city_dist_list[["X15_main"]][[2]][["Pr(>F)"]][1], 3))),
                size = 4.5)


# 17.6
cd_176 <- ggplot(cards, aes(x = City_dist, y = log(X17.6_main))) +
  # geom_point(size = 2,
  #            shape = 1) +
  geom_smooth(method = "lm",
                color = "#66a182",
                fill = "#66a182",
                size = 1,
                alpha = 0.3) +
  labs(x = "Distance to Urban Center (km)",
    y = "log(Digitoxin peak 17.6)") +
  xlim(0, 71) +
  theme_1() +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0("p = ", round(city_dist_list[["X17.6_main"]][[2]][["Pr(>F)"]][1], 3))),
                size = 4.5)


# arrange plots in grid
cards_citydist_plots <- ggarrange(cd_total,
                                  cd_66,
                                  cd_15,
                                  cd_176 +
                                    font("x.text"), 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2,
          align = "hv",
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/multi_yr_mods/Defense/Q1_citydist_Cardenolides.pdf"),
             width = 8, height = 6)

```


## Urbanization score
```{r warning=FALSE, message=FALSE}
# Total cards
us_total <- ggplot(cards, aes(x = Urb_score, y = total)) +
  # geom_point(size = 2,
  #            shape = 1) +
  geom_smooth(method = "lm",
                color = "#66a182",
                fill = "#66a182",
                size = 1,
                alpha = 0.3) +
  theme_1() +
  labs(x = "Urbanization Score", 
    y = "Total Cardenolides") +
  xlim(4, -4) +
  ylim(0,0.4) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0("p = ", round(urb_score_list[["total"]][[2]][["Pr(>F)"]][1], 3))),
                size = 4.5)



# 6.6
us_66 <- ggplot(cards, aes(x = Urb_score, y = X6.6_main)) +
  # geom_point(size = 2,
  #            shape = 1) +
  geom_smooth(method = "lm",
                color = "#66a182",
                fill = "#66a182",
                size = 1,
                alpha = 0.3) +
  theme_1() +
  labs(x = "Urbanization Score", 
    y = "Digitoxin peak 6.6") +
  xlim(4, -4) +
  ylim(0,0.3)+
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0("p = ", round(urb_score_list[["X6.6_main"]][[2]][["Pr(>F)"]][1], 3))),
                size = 4.5)


# 15
us_15 <- ggplot(cards, aes(x = Urb_score, y = X15_main)) +
  # geom_point(size = 2,
  #            shape = 1) +
  geom_smooth(method = "lm",
                color = "#66a182",
                fill = "#66a182",
                size = 1,
                alpha = 0.3) +
  theme_1() +
  labs(x = "Urbanization Score", 
    y = "Digitoxin peak 15") +
  xlim(4, -4) +
  ylim(0,0.1)+
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0("p = ", round(urb_score_list[["X15_main"]][[2]][["Pr(>F)"]][1], 3))),
                size = 4.5)


# 17.6
us_176 <- ggplot(cards, aes(x = Urb_score, y = log(X17.6_main))) +
  # geom_point(size = 2,
  #            shape = 1) +
  geom_smooth(method = "lm",
                color = "#66a182",
                fill = "#66a182",
                size = 1,
                alpha = 0.3) +
  theme_1() +
  labs(x = "Urbanization Score", 
    y = "log(Digitoxin peak 17.6)") +
  xlim(4, -4) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0("p = ", round(urb_score_list[["X17.6_main"]][[2]][["Pr(>F)"]][1], 3))),
                size = 4.5)


# arrange plots in grid
cards_urbscore_plots <- ggarrange(us_total, us_66, us_15, us_176 +
                                    font("x.text"), 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2,
          align = "hv",
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/multi_yr_mods/Defense/Q1_urbscore_Cardenolides.pdf"),
             width = 8, height = 6)
```


# Create boxplots
## Weevil damage
```{r}

ggpredict(weev_urbsubs_dist_m2_quant,
          terms = c("Transect_ID")) %>%
  plot(colors = "bw")


```


# Find estimated marginal means at terminii (lmers)
## Gradient
### City_dist
#### Herbivory: Before flowering (binary)
```{r}
herb_e_bin_gradient_01_pred <- ggeffects::ggpredict(herb_e_bin_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

Calc_percent_change(herb_e_bin_gradient_01_pred) # 8.9%

```

#### Herbivory: After flowering (binary)
```{r}
herb_l_bin_gradient_01_pred <- ggeffects::ggpredict(herb_l_bin_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

Calc_percent_change(herb_l_bin_gradient_01_pred) # -2%

```

## Urban Subtransects
### City_dist
#### Herbivory: Before flowering- Binary
```{r}
herb_e_urbsubs_bin_01_pred <- ggeffects::ggpredict(herb_e_bin_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

Calc_percent_change_urbsubs_intxn(herb_e_urbsubs_bin_01_pred)
# [1] "Percent change from suburban to urban terminus along corridor subtransect: -3.9%"
# [1] "Percent change from suburban to urban terminus along non-corridor subtransect: 15.1%"

```

#### Herbivory: Before flowering- Quantitative
```{r}
herb_e_quant_urbsubs_01_pred <- ggeffects::ggpredict(herb_e_quant_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# PERCENT CHANGE, suburban to urban terminus:
Calc_percent_change_urbsubs(herb_e_quant_urbsubs_01_pred) # 47.9%
```

#### Herbivory: After flowering- Quantitative
```{r}
herb_l_quant_urbsubs_01_pred <- ggeffects::ggpredict(herb_l_quant_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

Calc_percent_change_transects(herb_l_quant_urbsubs_01_pred)
# "Percent change from non-corridor to corridor subtransect: -10.3%"

```

#### Weevil damage: Quantitative
```{r}
Calc_percent_change_transects(weev_quant_urbsubs_01_pred) # "Percent change from non-corridor to corridor subtransect: 20.9%"
```

# Find estimated marginal means at terminii (lms for cardenolides)
```{r}
# total cards
m1 <- lm(total ~ City_dist, cards)
summary(m1)
## estimate at x = 0 (urban terminus): mx + b = 0 + b = 0.358397
## estimate at x = 67 (rural terminus): (67)*(-0.001820) + 0.358397 = 0.236457
## percent change, rur to urb: 
#### percent_change <- ((urb_mean - rur_mean) / rur_mean) * 100
percent_change <- (((0.358397 - 0.236457) / 0.236457) * 100) %T>%
  print()


# peak 6.6
m2 <- lm(X6.6_main ~ City_dist, cards)
summary(m2)
## estimate at x = 0 (urban terminus): mx + b = 0 + b = 0.2619764  
## estimate at x = 67 (rural terminus): (67)*(-0.0015764) + 0.2619764 = 0.1563576
## percent change, rur to urb: 
#### percent_change <- ((urb_mean - rur_mean) / rur_mean) * 100
percent_change <- (((0.2619764 - 0.1563576) / 0.1563576) * 100) %T>%
  print()
```

