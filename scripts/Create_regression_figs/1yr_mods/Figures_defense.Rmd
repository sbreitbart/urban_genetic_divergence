# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import data & models
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_1yr_mods.Rmd", quiet=TRUE))
```

# Create ggpredict objects (lmers)
## Latex (same as multi-yr mods since 1 year of data)
### Gradient
```{r}
# ggpredict can't read ^(1/3) so I'll manually cube-root transform latex column, then read that into ggpredict objects

latex$Latex_weight_mg_cuberoot <- latex$Latex_weight_mg^(1/3)

ggpred_latex1 <- glmmTMB(Latex_weight_mg_cuberoot ~
                            Block +
                            (1|Population/Family) +
                            City_dist,
                        data = latex,
                        REML = F)

ggpred_latex2 <- update(ggpred_latex1, .~. -City_dist + Urb_score)

# city_dist
latex_mods_best_c[1]
latex_gradient_01_pred <- ggeffects::ggpredict(ggpred_latex1,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
latex_mods_best_u[1]
latex_gradient_02_pred <- ggeffects::ggpredict(ggpred_latex2,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# ggpredict can't read ^(1/3) so I'll manually cube-root transform latex column, then read that into ggpredict objects

ggpred_latex3 <- glmmTMB(Latex_weight_mg_cuberoot ~
                            Block +
                            (1|Population/Family) +
                            City_dist + Transect_ID,
                        data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                        REML = F)

ggpred_latex4 <- glmmTMB(Latex_weight_mg_cuberoot ~
                            Block +
                            (1|Population/Family) +
                            Urb_score * Transect_ID,
                        data = latex %>%
                          dplyr::filter(Transect_ID != "Rural"),
                        REML = F)

# city_dist
latex_mods_best_c[2]
latex_urbsubs_01_pred <- ggeffects::ggpredict(ggpred_latex3,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
latex_mods_best_u[2]
latex_urbsubs_02_pred <- ggeffects::ggpredict(ggpred_latex4,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Herbivory- Early- binary
### Gradient
```{r}
# city_dist
def.m2
herb_e_bin_gradient_01_pred <- ggeffects::ggpredict(def.m2,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
def.m2_u
herb_e_bin_gradient_02_pred <- ggeffects::ggpredict(def.m2_u,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
def.tr.m2
herb_e_bin_urbsubs_01_pred <- ggeffects::ggpredict(def.tr.m2,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
def.tr.m2_u
herb_e_bin_urbsubs_02_pred <- ggeffects::ggpredict(def.tr.m2_u,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```

## Herbivory- Early- quantitative
### Gradient
```{r}
# city_dist
def.m3 # log-transformed
herb_e_quant_gradient_01_pred <- ggeffects::ggpredict(def.m3,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
def.m3_u # log-transformed
herb_e_quant_gradient_02_pred <- ggeffects::ggpredict(def.m3_u,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
def.tr.m3 # log-transformed
herb_e_quant_urbsubs_01_pred <- ggeffects::ggpredict(def.tr.m3,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
def.tr.m3_u # log-transformed
herb_e_quant_urbsubs_02_pred <- ggeffects::ggpredict(def.tr.m3_u,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```

## Herbivory- Late- binary
### Gradient
```{r}
# city_dist
def.m4
herb_l_bin_gradient_01_pred <- ggeffects::ggpredict(def.m4,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
def.m4_u
herb_l_bin_gradient_02_pred <- ggeffects::ggpredict(def.m4_u,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
def.tr.m4
herb_l_bin_urbsubs_01_pred <- ggeffects::ggpredict(def.tr.m4,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
def.tr.m4_u
herb_l_bin_urbsubs_02_pred <- ggeffects::ggpredict(def.tr.m4_u,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```

## Herbivory- Late- quantitative
### Gradient
```{r}
# city_dist
def.m5 # log-transformed
herb_l_quant_gradient_01_pred <- ggeffects::ggpredict(def.m5,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
def.m5_u # log-transformed
herb_l_quant_gradient_02_pred <- ggeffects::ggpredict(def.m5_u,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
def.tr.m5 # log-transformed
herb_l_quant_urbsubs_01_pred <- ggeffects::ggpredict(def.tr.m5,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
def.tr.m5_u # log-transformed
herb_l_quant_urbsubs_02_pred <- ggeffects::ggpredict(def.tr.m5_u,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```

## Weevil damage- binary
### Gradient
```{r}
# city_dist
def.m6
weev_b_gradient_01_pred <- ggeffects::ggpredict(def.m6,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
def.m6_u
weev_b_gradient_02_pred <- ggeffects::ggpredict(def.m6_u,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
def.tr.m6
weev_bin_urbsubs_01_pred <- ggeffects::ggpredict(def.tr.m6,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
def.tr.m6_u
weev_bin_urbsubs_02_pred <- ggeffects::ggpredict(def.tr.m6_u,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Weevil damage- quantitative
### Gradient
```{r}
# city_dist
def.m7 # log-TRANSFORMED
weev_q_gradient_01_pred <- ggeffects::ggpredict(def.m7,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
def.m7_u # log-TRANSFORMED
weev_q_gradient_02_pred <- ggeffects::ggpredict(def.m7_u,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
def.tr.m7 # log-TRANSFORMED
weev_quant_urbsubs_01_pred <- ggeffects::ggpredict(def.tr.m7,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
def.tr.m7_u # log-TRANSFORMED
weev_quant_urbsubs_02_pred <- ggeffects::ggpredict(def.tr.m7_u,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

# Create regression plots (lmers)
## Gradient
### City_dist
```{r}
# LATEX-----
ggpred_Q1.citydist_latex <- ggplot(latex_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Latex exudation (mg) " ^{1/3})) +
  # ylim(1.8, 2.2) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ",
                                   tidy_anova(latex_mods_best_c[[1]]) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)


ggpred_Q1.citydist_latex


# herbivory, early- binary-----
ggpred_Q1.citydist_herb_e_bin <- ggplot(herb_e_bin_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of herbivory \n (before flowering)") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1)
  #  limits = c(0.6, 1),
 #   breaks = c(.6, .7, 0.8, 0.9, 1)
  ) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(def.m2) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_herb_e_bin



# herbivory, early- quantitative-----
ggpred_Q1.citydist_herb_e_quant <- ggplot(herb_e_quant_gradient_01_pred) +
  rep_geoms +
  ylim(0, 0.05) +
  labs(x = "Distance to Urban Center (km)",
       y = "log(Herbivory before flowering)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(def.m3) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_herb_e_quant


# herbivory, late- binary-----
ggpred_Q1.citydist_herb_l_bin <- ggplot(herb_l_bin_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of herbivory \n (after flowering)") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.98, 1),
    breaks = c(0.98, 0.99, 1)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(def.m4) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_herb_l_bin



# herbivory, late- quantitative-----
ggpred_Q1.citydist_herb_l_quant <- ggplot(herb_l_quant_gradient_01_pred) +
  rep_geoms +
 # ylim(0, 0.1) +
  labs(x = "Distance to Urban Center (km)",
       y = "log(Herbivory after flowering)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(def.m5) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_herb_l_quant


# weevil damage- binary-----
ggpred_Q1.citydist_weev_bin <- ggplot(weev_b_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of weevil damage") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.6, 0.9),
    breaks = c(0.6, 0.7, 0.8, 0.9)
    ) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(def.m6) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_weev_bin



# weevil damage- quantitative-----
ggpred_Q1.citydist_weev_quant <- ggplot(weev_q_gradient_01_pred) +
  rep_geoms +
  ylim(3, 10) +
  labs(x = "Distance to Urban Center (km)",
       y = "Weevil scar length (cm)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(def.m7) %>%
                                     dplyr::filter(Predictor == "Distance to City Center") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.citydist_weev_quant
```

### Urbanization Score
```{r}
# LATEX-----
ggpred_Q1.urbscore_latex <- ggplot(latex_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression("Latex exudation (mg) " ^{1/3})) +
    xlim(4, -4) +
   ylim(NA, 2.2) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(latex_mods_best_u[[1]]) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_latex

# herbivory, early- binary-----
ggpred_Q1.urbscore_herb_e_bin <- ggplot(herb_e_bin_gradient_02_pred) +
  rep_geoms +
      xlim(4, -4) +
labs(x = "Urbanization Score",
       y = "Chance of herbivory \n (before flowering)") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.4, 0.7)
  #  breaks = c(0.7, 0.8, 0.9)
    ) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.m2_u) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_herb_e_bin



# herbivory, early- quantitative-----
ggpred_Q1.urbscore_herb_e_quant <- ggplot(herb_e_quant_gradient_02_pred) +
  rep_geoms +
      xlim(4, -4) +
  ylim(0, 0.04) +
  labs(x = "Urbanization Score",
       y = "log(Herbivory before flowering)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.m3_u) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_herb_e_quant


# herbivory, late- binary-----
ggpred_Q1.urbscore_herb_l_bin <- ggplot(herb_l_bin_gradient_02_pred) +
  rep_geoms +
      xlim(4, -4) +
labs(x = "Urbanization Score",
       y = "Chance of herbivory \n (after flowering)") +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.985, 1),
    breaks = c(0.98,0.99, 1)) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.m4_u) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_herb_l_bin



# herbivory, late- quantitative-----
ggpred_Q1.urbscore_herb_l_quant <- ggplot(herb_l_quant_gradient_02_pred) +
  rep_geoms +
      xlim(4, -4) +
  ylim(0.015, 0.04) +
  labs(x = "Urbanization Score",
       y = "log(Herbivory after flowering)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.m5_u) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_herb_l_quant


# weevil damage- binary-----
ggpred_Q1.urbscore_weev_bin <- ggplot(weev_b_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = "Chance of weevil damage") +
    xlim(4, -4) +
    scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
     limits = c(0.6, 0.9),
     breaks = c(0.6, 0.7, 0.8, 0.9)
    ) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.m6_u) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_weev_bin



# weevil damage- quantitative-----
ggpred_Q1.urbscore_weev_quant <- ggplot(weev_q_gradient_02_pred) +
  rep_geoms +
  ylim(3.5, NA) +
  xlim(4, -4) +
  labs(x = "Urbanization Score",
       y = "Weevil scar length (cm)") +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.m7_u) %>%
                                     dplyr::filter(Predictor == "Urbanization Score") %>%
                                     dplyr::select(p)
                                   )
                    ),
                size = 4.5)

ggpred_Q1.urbscore_weev_quant
```

## Urban Subtransects
### City_dist
```{r}
# latex-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
latex_urbsubs_01_pred$group <- factor(latex_urbsubs_01_pred$group,
                                   levels(latex_urbsubs_01_pred$group)[c(2,1)])
levels(latex_urbsubs_01_pred$group)

ggpred_Q2.citydist_latex <- 
ggplot(latex_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Latex exudation (g) "^{1/3}),
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 2.2) +
    xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(latex_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(latex_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_latex

# herbivory, before flowering: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_e_bin_urbsubs_01_pred$group <- factor(herb_e_bin_urbsubs_01_pred$group,
                                   levels(herb_e_bin_urbsubs_01_pred$group)[c(2,1)])
levels(herb_e_bin_urbsubs_01_pred$group)


ggpred_Q2.citydist_herb_e_bin <- 
ggplot(herb_e_bin_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of herbivory \n (before flowering)",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.28, 1)
   # breaks = c(0.5, .75, 1)
    ) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(def.tr.m2) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m2) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.citydist_herb_e_bin


# herbivory, before flowering: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_e_quant_urbsubs_01_pred$group <- factor(herb_e_quant_urbsubs_01_pred$group,
                                   levels(herb_e_quant_urbsubs_01_pred$group)[c(2,1)])
levels(herb_e_quant_urbsubs_01_pred$group)


ggpred_Q2.citydist_herb_e_quant <- 
ggplot(herb_e_quant_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = ("log(Herbivory, before flowering)"),
       color = "Transect",
       fill = "Transect") +
  ylim(0, 0.06) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(def.tr.m3) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m3) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.79,
                    label = paste0(" D x T: p = ", tidy_anova(def.tr.m3) %>%
dplyr::filter(Predictor == "Distance to City Center x Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_herb_e_quant

# herbivory, after flowering: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_l_bin_urbsubs_01_pred$group <- factor(herb_l_bin_urbsubs_01_pred$group,
                                   levels(herb_l_bin_urbsubs_01_pred$group)[c(2,1)])
levels(herb_l_bin_urbsubs_01_pred$group)


ggpred_Q2.citydist_herb_l_bin <- 
ggplot(herb_l_bin_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of herbivory \n (after flowering)",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.9, 1),
    breaks = c(0.9, 0.95, 1)
    ) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.6,
                    label = paste0(" Distance: p = ", tidy_anova(def.tr.m4) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.51,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m4_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.citydist_herb_l_bin


# herbivory, after flowering: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_l_quant_urbsubs_01_pred$group <- factor(herb_l_quant_urbsubs_01_pred$group,
                                   levels(herb_l_quant_urbsubs_01_pred$group)[c(2,1)])
levels(herb_l_quant_urbsubs_01_pred$group)


ggpred_Q2.citydist_herb_l_quant <- 
ggplot(herb_l_quant_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = ("log(Herbivory, after flowering)"),
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 0.055) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(def.tr.m5) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m5) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_herb_l_quant

# Weevil damage: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
weev_bin_urbsubs_01_pred$group <- factor(weev_bin_urbsubs_01_pred$group,
                                   levels(weev_bin_urbsubs_01_pred$group)[c(2,1)])
levels(weev_bin_urbsubs_01_pred$group)


ggpred_Q2.citydist_weev_bin <- 
ggplot(weev_bin_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = "Chance of weevil damage",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.45, 1),
    breaks = c(0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)
    ) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(def.tr.m6) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m6) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_weev_bin


# Weevil damage: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
weev_quant_urbsubs_01_pred$group <- factor(weev_quant_urbsubs_01_pred$group,
                                   levels(weev_quant_urbsubs_01_pred$group)[c(2,1)])
levels(weev_quant_urbsubs_01_pred$group)


ggpred_Q2.citydist_weev_quant <- 
ggplot(weev_quant_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = "Weevil scar length (cm)",
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 10.8) +
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(def.tr.m7) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m7) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_weev_quant

```

### Urbanization Score
```{r}
# latex-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
latex_urbsubs_02_pred$group <- factor(latex_urbsubs_02_pred$group,
                                   levels(latex_urbsubs_02_pred$group)[c(2,1)])
levels(latex_urbsubs_02_pred$group)

ggpred_Q2.urbsubs_latex <- 
ggplot(latex_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = expression("Latex exudation (g) "^{1/3}),
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 2.8) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(latex_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(latex_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.79,
                    label = paste0(" U x T: p = ", tidy_anova(latex_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score x Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_latex



# herbivory, before flowering: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_e_bin_urbsubs_02_pred$group <- factor(herb_e_bin_urbsubs_02_pred$group,
                                   levels(herb_e_bin_urbsubs_02_pred$group)[c(2,1)])
levels(herb_e_bin_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_herb_e_bin <- 
ggplot(herb_e_bin_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = "Chance of herbivory \n (before flowering)",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
     limits = c(NA, 0.9),
    # breaks = c(0.7, 0.8, 0.9)
    ) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.tr.m2_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m2_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.urbsubs_herb_e_bin


# herbivory, before flowering: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_e_quant_urbsubs_02_pred$group <- factor(herb_e_quant_urbsubs_02_pred$group,
                                   levels(herb_e_quant_urbsubs_02_pred$group)[c(2,1)])
levels(herb_e_quant_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_herb_e_quant <- 
ggplot(herb_e_quant_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = ("log(Herbivory, before flowering)"),
       color = "Transect",
       fill = "Transect") +
  ylim(0, 0.04) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.tr.m3_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m3_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_herb_e_quant

# herbivory, after flowering: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_l_bin_urbsubs_02_pred$group <- factor(herb_l_bin_urbsubs_02_pred$group,
                                   levels(herb_l_bin_urbsubs_02_pred$group)[c(2,1)])
levels(herb_l_bin_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_herb_l_bin <- 
ggplot(herb_l_bin_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = "Chance of herbivory \n (after flowering)",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(0.97, 1),
    breaks = c(0.97, 0.98, 0.99, 1)
    ) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.15,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.tr.m4_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.06,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m4_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.urbsubs_herb_l_bin


# herbivory, after flowering: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
herb_l_quant_urbsubs_02_pred$group <- factor(herb_l_quant_urbsubs_02_pred$group,
                                   levels(herb_l_quant_urbsubs_02_pred$group)[c(2,1)])
levels(herb_l_quant_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_herb_l_quant <- 
ggplot(herb_l_quant_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = ("log(Herbivory, after flowering)"),
       color = "Transect",
       fill = "Transect") +
  ylim(0, 0.1) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.tr.m5_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m5_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.79,
                    label = paste0(" U x T: p = ", tidy_anova(def.tr.m5_u) %>%
dplyr::filter(Predictor == "Urbanization Score x Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_herb_l_quant

# Weevil damage: Binary-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
weev_bin_urbsubs_02_pred$group <- factor(weev_bin_urbsubs_02_pred$group,
                                   levels(weev_bin_urbsubs_02_pred$group)[c(2,1)])
levels(weev_bin_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_weev_bin <- 
ggplot(weev_bin_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = "Chance of weevil damage",
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(labels = scales::percent_format(
    scale = 100,
    accuracy = 1),
    limits = c(NA, 1),
    breaks = c(0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)
    ) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.23,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.tr.m6_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.14,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m6_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.05,
                    label = paste0(" U x T: p = ", tidy_anova(def.tr.m6_u) %>%
dplyr::filter(Predictor == "Urbanization Score x Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_weev_bin


# Weevil damage: Quantitative-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
weev_quant_urbsubs_02_pred$group <- factor(weev_quant_urbsubs_02_pred$group,
                                   levels(weev_quant_urbsubs_02_pred$group)[c(2,1)])
levels(weev_quant_urbsubs_02_pred$group)


ggpred_Q2.urbsubs_weev_quant <- 
ggplot(weev_quant_urbsubs_02_pred) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = "Weevil scar length (cm)",
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 10.8) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(def.tr.m7_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(def.tr.m7_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.urbsubs_weev_quant

```

## Combine plots into one figure
### Gradient / City_dist
```{r}
ggarrange(
  addborder(ggpred_Q1.citydist_latex, "defense"),
  addborder(ggpred_Q1.citydist_herb_e_bin, "defense"),
  addborder(ggpred_Q1.citydist_herb_e_quant, "defense"),
  addborder(ggpred_Q1.citydist_herb_l_bin, "defense"),
  addborder(ggpred_Q1.citydist_herb_l_quant, "defense"),
  addborder(ggpred_Q1.citydist_weev_bin, "defense"),
  addborder(ggpred_Q1.citydist_weev_quant, "defense") +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/1yr_mods/Defense/Q1_grad_citydist_Defense.pdf"),
             width = 14, height = 7.5)
```


### Gradient / Urbanization Score
```{r}
ggarrange(
  addborder(ggpred_Q1.urbscore_latex, "defense"),
  addborder(ggpred_Q1.urbscore_herb_e_bin, "defense"),
  addborder(ggpred_Q1.urbscore_herb_e_quant, "defense"),
  addborder(ggpred_Q1.urbscore_herb_l_bin, "defense"),
  addborder(ggpred_Q1.urbscore_herb_l_quant, "defense"),
  addborder(ggpred_Q1.urbscore_weev_bin, "defense"),
  addborder(ggpred_Q1.urbscore_weev_quant, "defense") +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/1yr_mods/Defense/Q1_grad_urbscore_Defense.pdf"),
             width = 14, height = 7.5)
```

### Urb Subtransects / City_dist
```{r}
ggarrange(
  addborder(ggpred_Q2.citydist_latex, "defense"),
  addborder(ggpred_Q2.citydist_herb_e_bin, "defense"),
  addborder(ggpred_Q2.citydist_herb_e_quant, "defense"),
  addborder(ggpred_Q2.citydist_herb_l_bin, "defense"),
  addborder(ggpred_Q2.citydist_herb_l_quant, "defense"),
  addborder(ggpred_Q2.citydist_weev_bin, "defense"),
  addborder(ggpred_Q2.citydist_weev_quant, "defense") +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/1yr_mods/Defense/Q2_urbsubs_citydist_Defense.pdf"),
             width = 14.5, height = 8)
```

### Urb Subtransects / Urbanization Score
```{r}
ggarrange(
  addborder(ggpred_Q2.urbsubs_latex, "defense"),
  addborder(ggpred_Q2.urbsubs_herb_e_bin, "defense"),
  addborder(ggpred_Q2.urbsubs_herb_e_quant, "defense"),
  addborder(ggpred_Q2.urbsubs_herb_l_bin, "defense"),
  addborder(ggpred_Q2.urbsubs_herb_l_quant, "defense"),
  addborder(ggpred_Q2.urbsubs_weev_bin, "defense"),
  addborder(ggpred_Q2.urbsubs_weev_quant, "defense") +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/1yr_mods/Defense/Q2_urbsubs_urbscore_Defense.pdf"),
             width = 14.5, height = 8)
```

# Create regression plots (lms for cardenolides)
These are already in multi_yr_mods folder
# Find estimated marginal means at terminii (lmers)
## Gradient
### City_dist
#### Herbivory: Before flowering (binary)
```{r}
Calc_percent_change(herb_e_bin_gradient_01_pred) # 25.8%

```

#### Herbivory: After flowering (quant)
```{r}
Calc_percent_change(herb_l_quant_gradient_01_pred) # 23.3%

```

## Urban Subtransects
### City_dist
#### Weevil damage: Binary
```{r}
Calc_percent_change_urbsubs(weev_bin_urbsubs_01_pred) # "Percent change from suburban to urban terminus: -19.1%"
```

# Find estimated marginal means at terminii (lms for cardenolides)
These are already in multi_yr_mods folder
