# Set up notebook
## Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import data
```{r}
herbivores <- read.csv(here::here("./data/Joined_annual_data/herbivores.csv")) %>%
  dplyr::select(., -1) %>%
  dplyr::mutate_at(vars(c("Population",
                          "Family",
                          "Replicate",
                          "Block",
                          "Transect_ID",
                          "Sample",
                          "Patch_ID",
                          "Urb_Rur",
                          "Year",
                          "Surveyor",
                          "Date")),
                   as.character) %>%
    dplyr::mutate_at(vars(c("Population",
                            "Family",
                            "Replicate",
                            "Block",
                            "Transect_ID",
                            "Sample",
                            "Patch_ID",
                            "Urb_Rur",
                            "Year",
                            "Surveyor",
                          "Date")),
                     as.factor)

str(herbivores)  


herbivores %<>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))


# Take mean of two sampling events
herbivores %<>%
  dplyr::group_by(Population, Row, Column, Block, Family, Replicate, Year) %>%
  dplyr::summarise(Monarch_Quantity_Observed = mean(Monarch_Quantity_Observed, na.rm = T),
                   Liriomyza_asclepiadis = mean(Liriomyza_asclepiadis, na.rm = T),
                   Labidomera_clivicollis = mean(Labidomera_clivicollis, na.rm = T),
                   Transect_ID = first(Transect_ID),
                   City_dist = first(City_dist),
                   Urb_Rur = first(Urb_Rur),
                   Urb_score = first(Urb_score),
                   Fam_uniq = first(Fam_uniq))
                   
```

## Import final models
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_1yr_mods.Rmd", quiet=TRUE))
```

# Create ggpredict objects
## Monarchs
### Gradient
```{r}
# city_dist
herb.m1
monarch_gradient_01_pred <- ggeffects::ggpredict(herb.m1,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
herb.m1_u
monarch_gradient_02_pred <- ggeffects::ggpredict(herb.m1_u,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}
# city_dist
herb.tr.m1
monarch_urbsubs_01_pred <- ggeffects::ggpredict(herb.tr.m1,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
herb.tr.m1_u
monarch_urbsubs_02_pred <- ggeffects::ggpredict(herb.tr.m1_u,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## L. asclepiadis
### Gradient
```{r}
# city_dist
herb.m2
asclepiadis_gradient_01_pred <- ggeffects::ggpredict(herb.m2,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
herb.m2_u
asclepiadis_gradient_02_pred <- ggeffects::ggpredict(herb.m2_u,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()


```

### Urban Subtransects
```{r}
# city_dist
herb.tr.m2
asclepiadis_urbsubs_01_pred <- ggeffects::ggpredict(herb.tr.m2,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
herb.tr.m2_u
asclepiadis_urbsubs_02_pred <- ggeffects::ggpredict(herb.tr.m2_u,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")

```

## L. clivicollis
### Gradient
```{r}
# city_dist
herb.m3
clivicollis_gradient_01_pred <- ggeffects::ggpredict(herb.m3,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 


# urb_score
herb.m3_u
clivicollis_gradient_02_pred <- ggeffects::ggpredict(herb.m3_u,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
herb.tr.m3
clivicollis_urbsubs_01_pred <- ggeffects::ggpredict(herb.tr.m3,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()


# urb_score
herb.tr.m3_u
clivicollis_urbsubs_02_pred <- ggeffects::ggpredict(herb.tr.m3_u,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

# Create plots
## Import herbivore images
```{r}
monarch_img <- readPNG("scripts/Create_regression_figs/herbivore_images/D_plexippus_phylopic.png") %>%
  rasterGrob(., interpolate=TRUE)

asclepiadis_img <- readPNG("scripts/Create_regression_figs/herbivore_images/L_asclepiadis_phylopic.png") %>%
  rasterGrob(., interpolate=TRUE)

clivicollis_img <- readPNG("scripts/Create_regression_figs/herbivore_images/L_clivicollis_phylopic.png") %>%
  rasterGrob(., interpolate=TRUE)
```

## Gradient
### City_dist
```{r}
# Monarch-----
ggpred_Q1.citydist_monarch <- 
ggplot(monarch_gradient_01_pred) +
  annotation_custom(monarch_img,
                    xmin=60, xmax=70,
                    ymin=0.6, ymax=0.68) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression(paste(italic(" Danaus plexippus"), " Abundance"))) +
  ylim(0.15, 0.68) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(herb.m1) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q1.citydist_monarch



# L. asclepiadis-----
ggpred_Q1.citydist_asclepiadis <- 
ggplot(asclepiadis_gradient_01_pred) +
  annotation_custom(asclepiadis_img,
                    xmin=60, xmax=70,
                    ymin=2.5, ymax=2.72) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression(paste(italic(" Liriomyza asclepiadis"), " Abundance"))) +
  ylim(1.15, 2.72) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(herb.m2) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q1.citydist_asclepiadis



# L. clivicollis-----
ggpred_Q1.citydist_clivicollis <- 
ggplot(clivicollis_gradient_01_pred) +
  annotation_custom(clivicollis_img,
                    xmin=60, xmax=70,
                    ymin=0.088, ymax=0.102) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression(paste(italic(" Labidomera clivicollis"), " Abundance"))) +
   ylim(-0.01, 0.1) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(herb.m3)%>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q1.citydist_clivicollis

```

### Urbanization Score
```{r}
# Monarch-----
ggpred_Q1.usc_monarch <- 
ggplot(monarch_gradient_02_pred) +
  annotation_custom(monarch_img,
                    xmin=3, xmax=4,
                    ymin=0.55, ymax=0.62) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression(paste(italic(" Danaus plexippus"), " Abundance"))) +
  ylim(0.15, 0.62) +
  xlim(4, -4) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb.m1_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q1.usc_monarch



# L. asclepiadis-----
ggpred_Q1.usc_asclepiadis <- 
ggplot(asclepiadis_gradient_02_pred) +
  annotation_custom(asclepiadis_img,
                    xmin=3, xmax=4,
                    ymin=2.5, ymax=2.75) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression(paste(italic(" Liriomyza asclepiadis"), " Abundance"))) +
  ylim(1, 2.75) +
    xlim(4, -4) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb.m2_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q1.usc_asclepiadis



# L. clivicollis-----
ggpred_Q1.usc_clivicollis <- 
ggplot(clivicollis_gradient_02_pred) +
  annotation_custom(clivicollis_img,
                    xmin=3, xmax=4,
                    ymin=0.068, ymax=0.08) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression(paste(italic(" Labidomera clivicollis"), " Abundance"))) +
  ylim(-0.007, NA) +
    xlim(4, -4) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb.m3_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q1.usc_clivicollis

```

## Urban Subtransects
### City_dist
```{r}
# Monarchs-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
monarch_urbsubs_01_pred$group <- factor(monarch_urbsubs_01_pred$group,
                                   levels(monarch_urbsubs_01_pred$group)[c(2,1)])
levels(monarch_urbsubs_01_pred$group)


ggpred_Q2.citydist_monarch <-
ggplot(monarch_urbsubs_01_pred) +
    annotation_custom(monarch_img,
                    xmin=28, xmax=32,
                    ymin=0.74, ymax=0.83) +
  labs(x = "Distance to Urban Center (km)",
       y = expression(paste(italic(" Danaus plexippus"), " Abundance")),
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 0.85) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(herb.tr.m1) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Subtransect: p = ", tidy_anova(herb.tr.m1) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.citydist_monarch



# L. asclepiadis-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
asclepiadis_urbsubs_01_pred$group <- factor(asclepiadis_urbsubs_01_pred$group,
                                   levels(asclepiadis_urbsubs_01_pred$group)[c(2,1)])
levels(asclepiadis_urbsubs_01_pred$group)


ggpred_Q2.citydist_asclepiadis <- 
ggplot(asclepiadis_urbsubs_01_pred) +
    annotation_custom(asclepiadis_img,
                    xmin=28, xmax=32,
                    ymin=2.36, ymax=2.55) +
  labs(x = "Distance to Urban Center (km)",
              y = expression(atop(paste(italic("Liriomyza asclepiadis")), " Abundance")),
       color = "Transect",
       fill = "Transect") +
  ylim(1, 2.55) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(herb.tr.m2) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Subtransect: p = ", tidy_anova(herb.tr.m2) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.citydist_asclepiadis


# L. clivicollis-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
clivicollis_urbsubs_01_pred$group <- factor(clivicollis_urbsubs_01_pred$group,
levels(clivicollis_urbsubs_01_pred$group)[c(2,1)])

levels(clivicollis_urbsubs_01_pred$group)


ggpred_Q2.citydist_clivicollis <- 
ggplot(clivicollis_urbsubs_01_pred) +
      annotation_custom(clivicollis_img,
                    xmin=28, xmax=32,
                    ymin=0.13, ymax=0.15) +
  labs(x = "Distance to Urban Center (km)",
       y = expression(atop(paste(italic("Labidomera clivicollis "), "Presence"))),
       color = "Transect",
       fill = "Transect") +
  ylim(NA,0.15) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(herb.tr.m3) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Subtransect: p = ", tidy_anova(herb.tr.m3) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.citydist_clivicollis

```

### Urbanization Score
```{r}
# Monarchs-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
monarch_urbsubs_02_pred$group <- factor(monarch_urbsubs_02_pred$group,
                                   levels(monarch_urbsubs_02_pred$group)[c(2,1)])
levels(monarch_urbsubs_02_pred$group)


ggpred_Q2.usc_monarch <-
ggplot(monarch_urbsubs_02_pred) +
    annotation_custom(monarch_img,
                    xmin=1, xmax=2,
                    ymin=0.87, ymax=1) +
  labs(x = "Urbanization Score",
       y = expression(paste(italic(" Danaus plexippus"), " Abundance")),
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 1) +
  xlim(4, -2) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb.tr.m1_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5)  +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Subtransect: p = ", tidy_anova(herb.tr.m1_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)  +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.79,
                    label = paste0(" U x S: p = ",
                                   tidy_anova(herb.tr.m1_u) %>%
dplyr::filter(Predictor == "Urbanization Score x Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.usc_monarch



# L. asclepiadis-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
asclepiadis_urbsubs_02_pred$group <- factor(asclepiadis_urbsubs_02_pred$group,
                                   levels(asclepiadis_urbsubs_02_pred$group)[c(2,1)])
levels(asclepiadis_urbsubs_02_pred$group)


ggpred_Q2.usc_asclepiadis <- 
ggplot(asclepiadis_urbsubs_02_pred) +
    annotation_custom(asclepiadis_img,
                    xmin=1, xmax=2,
                    ymin=2.5, ymax=2.75) +
  labs(x = "Urbanization Score",
              y = expression(atop(paste(italic("Liriomyza asclepiadis")), " Abundance")),
       color = "Transect",
       fill = "Transect") +
  ylim(1, 2.75) +
  xlim(4, -2) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb.tr.m2_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Subtransect: p = ", tidy_anova(herb.tr.m2_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5) 

ggpred_Q2.usc_asclepiadis


# L. clivicollis-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
clivicollis_urbsubs_02_pred$group <- factor(clivicollis_urbsubs_02_pred$group,
                                   levels(clivicollis_urbsubs_02_pred$group)[c(2,1)])
levels(clivicollis_urbsubs_02_pred$group)


ggpred_Q2.usc_clivicollis <- 
ggplot(clivicollis_urbsubs_02_pred) +
      annotation_custom(clivicollis_img,
                    xmin=1, xmax=2,
                    ymin=0.13, ymax=0.15) +
  rep_geoms2 +
  labs(x = "Urbanization Score",
       y = expression(atop(paste(italic("Labidomera clivicollis "), "Presence"))),
       color = "Transect",
       fill = "Transect") +
  ylim(0, 0.15) +
  xlim(4, -2) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(herb.tr.m3_u) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
                size = 4.5)  +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Subtransect: p = ", tidy_anova(herb.tr.m3_u) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
                size = 4.5)

ggpred_Q2.usc_clivicollis

```

## Combine plots into one figure
### Gradient / City_dist
```{r}
ggarrange(
  addborder(ggpred_Q1.citydist_monarch, "herbivores"),
  addborder(ggpred_Q1.citydist_asclepiadis, "herbivores"),
  addborder(ggpred_Q1.citydist_clivicollis, "herbivores") +
            font("x.text"),
          ncol = 3,
          nrow = 1,
          align = "hv",
          labels = list("a", "b", "c"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/1yr_mods/Defense/Q1_grad_citydist_herbivores.pdf"),
             width = 14, height = 4)
```


### Gradient / Urbanization Score
```{r}
ggarrange(
  addborder(ggpred_Q1.usc_monarch, "herbivores"),
  addborder(ggpred_Q1.usc_asclepiadis, "herbivores"),
  addborder(ggpred_Q1.usc_clivicollis, "herbivores") + 
            font("x.text"),
          ncol = 3,
          nrow = 1,
          align = "hv",
          labels = list("a", "b", "c"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/1yr_mods/Defense/Q1_grad_urbscore_herbivores.pdf"),
             width = 14, height = 4)
```

### Urb Subtransects / City_dist
```{r}
ggarrange(
  addborder(ggpred_Q2.citydist_monarch, "herbivores"),
  addborder(ggpred_Q2.citydist_asclepiadis, "herbivores"),
  addborder(ggpred_Q2.citydist_clivicollis, "herbivores")+
            font("x.text"),
          ncol = 3,
          nrow = 1,
          align = "hv",
          labels = list("a", "b", "c"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/1yr_mods/Defense/Q2_urbsubs_citydist_herbivores.pdf"),
             width = 14, height = 4)
```


### Urb Subtransects / Urbanization Score
```{r}
ggarrange(
  addborder(ggpred_Q2.usc_monarch, "herbivores"),
  addborder(ggpred_Q2.usc_asclepiadis, "herbivores"),
  addborder(ggpred_Q2.usc_clivicollis, "herbivores") +
            font("x.text"),
          ncol = 3,
          nrow = 1,
          align = "hv",
          labels = list("a", "b", "c"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Figures_Tables/Regressions/1yr_mods/Defense/Q2_urbsubs_urbscore_herbivores.pdf"),
             width = 14, height = 4)
```
