# Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

# Import data
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_1yr_mods.Rmd", quiet=TRUE))

```

# Calculate R-squared values
## Multi-year models
### Reproduction
```{r}

# change REML to T
flsucc_mods_reml_T     <- reml_to_true(flsucc_mods     ) 
flowers_mods_reml_T    <- reml_to_true(flowers_mods     ) 
flsize_mods_reml_T     <- reml_to_true(flsize_mods      ) 
fltime_mods_reml_T     <- reml_to_true(fltime_mods      ) 
flstart_mods_reml_T    <- reml_to_true(flstart_mods     ) 
pods_mods_reml_T       <- reml_to_true(pods_mods       ) 
first_pods_mods_reml_T <- reml_to_true(first_pods_mods  ) 
peduncles_mods_reml_T  <- reml_to_true(peduncles_mods   ) 
poll_mods_reml_T       <- reml_to_true(poll_mods   ) 


all_models_reml_T <- list(
flsucc_mods_reml_T      , 
flowers_mods_reml_T     , 
flsize_mods_reml_T      , 
fltime_mods_reml_T      , 
flstart_mods_reml_T      ,
poll_mods_reml_T    , 
pods_mods_reml_T        , 
first_pods_mods_reml_T  , 
peduncles_mods_reml_T ) 

names(all_models_reml_T) <- c(
"flsucc_mods"          ,
"flowers_mods"         ,
"flsize_mods"          ,
"fltime_mods",
"flstart_mods",
"poll_mods",
"pods_mods"            ,
"first_pods_mods",
"peduncles_mods")


# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

sink(here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Reproduction/Rsquared.txt"))
print(all_rsq)
sink()


# export as nice tables in word doc
flsucc_r2      <- make_r2_table( flsucc_mods_reml_T    ) 
flowers_r2       <- make_r2_table(flowers_mods_reml_T      )
flsize_r2 <- make_r2_table(flsize_mods_reml_T) 
flstart_r2  <- make_r2_table(flstart_mods_reml_T )
poll_r2  <- make_r2_table(poll_mods_reml_T )


## these models don't have an alternative model for urb score/ urbsubs and will use this table format
make_r2_table_modif1 <- function(mods_reml_T){
  
  return(
    lapply(mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      data.table::as.data.table() %>%
      data.table::melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m", "City_urbsubs_alt.R2m",
                              "Usc_urbsubs_best.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c", "City_urbsubs_alt.R2c",
                              "Usc_urbsubs_best.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m", "Distance_Q2_alt.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c", "Distance_Q2_alt.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,
                    Distance_Q2_alt.R2m,
                    Distance_Q2_alt.R2c,
                    
                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,4,2,2))%>%
      add_header_row(
        values = c("",
                   "Best Models", "Alternative Models",
                   "Best Models"),
        colwidths = c(1,4,2,4)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,6,4)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")
  )
}

fltime_r2 <- make_r2_table_modif1(fltime_mods_reml_T)
pods_r2  <- make_r2_table_modif1(pods_mods_reml_T)
first_pods_r2  <- make_r2_table_modif1(first_pods_mods_reml_T )
peduncles_r2  <- make_r2_table_modif1(peduncles_mods_reml_T )


# will do this in 3 docs b/c function accepts 3 tables at a time (something to try tweaking in the future)
# table 1
export_r2(flsucc_r2,
flowers_r2,
flsize_r2,
          "Flowering success",
          "Flowers per inflorescence", 
          "Flower size",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Reproduction/R2_Reproduction1.docx")

# table 2
export_r2(
fltime_r2,
flstart_r2      ,
pods_r2 ,
          "Flowering time",
          "Date of first flower", 
          "Follicles",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Reproduction/R2_Reproduction2.docx")

# table 3
export_r2(
poll_r2,
first_pods_r2,
peduncles_r2 ,
          "Flowering time",
          "Date of first flower", 
          "Follicles",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Reproduction/R2_Reproduction3.docx") 
```

### Defense
### lmers
```{r}
# change REML to T for lmers
latex_mods_reml_T          <- reml_to_true(latex_mods)
herb_e_bin_mods_reml_T       <- reml_to_true(herb_early_mods_binomial)
herb_e_quant_mods_reml_T   <- reml_to_true(herb_early_mods_quant)
herb_l_bin_mods_reml_T     <- reml_to_true(herb_late_mods_binomial)
herb_l_quant_mods_reml_T       <- reml_to_true(herb_late_mods_quant)
weevil_bin_mods_reml_T       <- reml_to_true(weev_mods_binomial)
weevil_quant_mods_reml_T  <- reml_to_true(weev_mods_quant)

all_models_reml_T <- list(
latex_mods_reml_T      ,
herb_e_bin_mods_reml_T       ,
herb_e_quant_mods_reml_T ,
herb_l_bin_mods_reml_T ,
herb_l_quant_mods_reml_T       ,
weevil_bin_mods_reml_T  ,
weevil_quant_mods_reml_T   )

names(all_models_reml_T) <- c(
"latex_mods"         ,
"herb_early_mods_binomial"    ,
"herb_early_mods_quant"    ,
"herb_late_mods_binomial"     ,
"herb_late_mods_quant"     ,
"weev_mods_binomial" ,
"weev_mods_quant")

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Defense/Rsquare.csv"))


# export as nice tables in word doc
# these first two throw errors because there's no alt model for urb subs, so I'll manually edit function to suit them
# latex_r2      <- make_r2_table( latex_mods_reml_T    ) 
# herb_e_bin_r2       <- make_r2_table(herb_e_bin_mods_reml_T      ) 

latex_r2 <- lapply(latex_mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      as.data.table() %>%
      melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m", "City_urbsubs_alt.R2m",
                              "Usc_urbsubs.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c", "City_urbsubs_alt.R2c",
                              "Usc_urbsubs.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m", "Distance_Q2_alt.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c", "Distance_Q2_alt.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,
                    Distance_Q2_alt.R2m,
                    Distance_Q2_alt.R2c,
                    
                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,4,2,2))%>%
      add_header_row(
        values = c("",
                   "Best Models", "Alternative Models",
                   "Best Models"),
        colwidths = c(1,4,2,4)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,6,4)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")


herb_e_bin_r2 <- lapply(herb_e_bin_mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      as.data.table() %>%
        melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m",
                              "Usc_urbsubs_best.R2m",  "Usc_urbsubs_alt.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c",
                              "Usc_urbsubs_best.R2c",  "Usc_urbsubs_alt.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m",
                          "UrbScore_Q2_best.R2m", "UrbScore_Q2_alt.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c",
                          "UrbScore_Q2_best.R2c", "UrbScore_Q2_alt.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,
                    
                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c,
                    UrbScore_Q2_alt.R2m,
                    UrbScore_Q2_alt.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,2,2,4)) %>%
      add_header_row(
        values = c("",
                   "Best Models", 
                   "Best Models", "Alternative Models"),
        colwidths = c(1,4,4,2)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,4,6)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")
  

herb_e_quant_r2 <- make_r2_table(herb_e_quant_mods_reml_T) 
herb_l_bin_r2 <- make_r2_table( herb_l_bin_mods_reml_T) 
herb_l_quant_r2       <- make_r2_table(herb_l_quant_mods_reml_T      ) 
weevil_bin_r2  <- make_r2_table(weevil_bin_mods_reml_T) 
weevil_quant_r2  <- make_r2_table( weevil_quant_mods_reml_T ) 

# will do this in 3 docs b/c function accepts 3 tables at a time (something to try tweaking in the future)
# table 1
export_r2(latex_r2    , 
herb_e_bin_r2      ,
herb_e_quant_r2,
          "Latex",
          "Herbivory before flowering (binary)", 
          "Herbivory before flowering (quantitative)",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_Defense1.docx")

# table 2
export_r2(
herb_l_bin_r2,
herb_l_quant_r2      ,
weevil_bin_r2 ,
          "Herbivory after flowering (binary)",
          "Herbivory after flowering (quantitative)", 
          "Weevil damage (binary)",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_Defense2.docx")

# table 3: will just use code from function
  word_export <- read_docx()
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Weevil damage (quantitative)", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, weevil_quant_r2)
  
  word_export <- body_end_section_landscape(word_export)
  print(word_export, here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_Defense3.docx"))
```

### lms (cardenolides)
```{r}
make_card_rsq_table <- function(card_model){
  
  return(
    card_model %>%
  broom::glance() %>%
  dplyr::select(r.squared:adj.r.squared) %>%
  as.data.frame() %>%
  dplyr::mutate(Variable = toString(card_model$terms[[2]]),
         Urbanization = toString(card_model$terms[[3]]),
         r.squared = round(r.squared, 3),
         adj.r.squared = round(adj.r.squared, 3)) %>%
  dplyr::rename(R2 = 1, 
                R2.adj = 2) %>%
  dplyr::select(Variable, Urbanization, R2, R2.adj) %>%
  
  dplyr::mutate(Variable = case_when(
    str_detect(Variable, "total")~
      "Total Cardenolides",
    str_detect(Variable, "6.6") ~
      "Glycosylated Aspecioside",
    str_detect(Variable, "15") ~
      "Labriformin",
    str_detect(Variable, "17.6") ~
      "Cardenolide 17.6")) %>%
  
  dplyr::mutate(Urbanization = case_when(
    str_detect(Urbanization, "City_dist")~
      "Distance to City Center",
    str_detect(Urbanization, "Urb_score")~
      "Urbanization Score"))
  )
}

lapply(flatten(all_card_models), make_card_rsq_table) %>%
  reduce(full_join, all = T) %>%
  flextable() %>%
  autofit() %>%
  theme_box() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 3:4, align = "center", part = "all") %>%
  hline(j = ~Variable, border = NULL, part = "body") %>%
  flextable::compose(i = 1, j = 3, part = "header",
                     value = as_paragraph("R", as_sup("2"))) %>%  flextable::compose(i = 1, j = 4, part = "header",
                     value = as_paragraph("R", as_sup("2"), as_sub("adj"))) %>%
  padding(padding = 3) %>%
    flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_cardenolides.docx"))
```


### Herbivores
```{r}
# change REML to T
monarch_mods_reml_T <- reml_to_true(monarch_mods)
asclepiadis_mods_reml_T <- reml_to_true(asclepiadis_mods)
clivicollis_mods_reml_T <- reml_to_true(clivicollis_mods)

all_models_reml_T <- list(
monarch_mods_reml_T          , 
asclepiadis_mods_reml_T           , 
clivicollis_mods_reml_T)

names(all_models_reml_T) <- c(
"monarch_mods"          ,
"asclepiadis_mods"           ,
"clivicollis_mods"         )

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Defense/Rsquare_herbivores.csv"))


# export as nice tables in word doc
mon_r2 <- make_r2_table(monarch_mods_reml_T)
ascl_r2 <- make_r2_table(asclepiadis_mods_reml_T)
clivi_r2 <- make_r2_table(clivicollis_mods_reml_T)

export_r2(mon_r2, ascl_r2, clivi_r2, 
          "Danaus plexippus",
          "Liriomyza asclepiadis", 
          "Labidomera clivicollis",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_herbivores.docx")
```


### Growth
```{r}
# change REML to T
ldmc_mods_reml_T      <- reml_to_true(ldmc_mods)
sla_mods_reml_T       <- reml_to_true(sla_mods)
heights_e_mods_reml_T <- reml_to_true(heights_early_mods)
heights_l_mods_reml_T <- reml_to_true(heights_late_mods)
rgr_mods_reml_T       <- reml_to_true(rgr_mods)
ramets_e_mods_reml_T  <- reml_to_true(ramets_early_mods)
ramets_l_mods_reml_T  <- reml_to_true(ramets_late_mods)
mortality_mods_reml_T <- reml_to_true(mortality_mods)

all_models_reml_T <- list(
ldmc_mods_reml_T      ,
sla_mods_reml_T       ,
heights_e_mods_reml_T ,
heights_l_mods_reml_T ,
rgr_mods_reml_T       ,
ramets_e_mods_reml_T  ,
ramets_l_mods_reml_T  ,
mortality_mods_reml_T )

names(all_models_reml_T) <- c(
"ldmc_mods"      ,
"sla_mods"       ,
"heights_e_mods" ,
"heights_l_mods" ,
"rgr_mods"       ,
"ramets_e_mods"  ,
"ramets_l_mods"  ,
"mortality_mods" )

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Growth/Rsquare.csv"))



# export as nice tables in word doc
ldmc_r2      <- make_r2_table( ldmc_mods_reml_T    ) 
sla_r2       <- make_r2_table(sla_mods_reml_T      ) 
heights_e_r2 <- make_r2_table(heights_e_mods_reml_T) 
heights_l_r2 <- make_r2_table( heights_l_mods_reml_T) 
rgr_r2       <- make_r2_table(rgr_mods_reml_T      ) 
ramets_e_r2  <- make_r2_table(ramets_e_mods_reml_T) 
ramets_l_r2  <- make_r2_table( ramets_l_mods_reml_T ) 
morality_r2  <- make_r2_table( mortality_mods_reml_T) 

# will do this in 3 docs b/c function accepts 3 tables at a time (something to try tweaking in the future)
# table 1
export_r2(ldmc_r2    , 
sla_r2      ,
heights_e_r2,
          "LDMC",
          "SLA", 
          "Height before flowering",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Growth/R2_growth1.docx")
# table 2
export_r2(
heights_l_r2,
rgr_r2      ,
ramets_e_r2 ,
          "Height after flowering",
          "Relative growth rate", 
          "Ramets before flowering",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Growth/R2_growth2.docx")

# table 3: will just use code from function
  word_export <- read_docx()
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Ramets, after flowering", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, ramets_l_r2)
  
  body_add_break(word_export)
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Mortality", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, morality_r2)
  
  word_export <- body_end_section_landscape(word_export)
  print(word_export, here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Growth/R2_growth3.docx"))
```

### Export all Rsq tables into one docx
```{r}

make_full_R2_table <- function(list1, list2, list3,
                               list4, list5, list6,
                               list7, list8, list9,
                                list10, list11, list12,
                                list13, list14, list15,
                                list16, list17, list18,
                                list19 , list20, list21,
                                list22, list23, list24,
                                list25, list26 #, list27
                               ){
      
  make_1_table <- function(list1){
    
      lapply(list1, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      dplyr::select(-contains("alt")) %>%
      dplyr::rename("Type" = 1) %>%
      dplyr::filter(row_number()==n()) %>%
      data.table::as.data.table() %>%
      data.table::melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m",
                              "Usc_urbsubs_best.R2m", 
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c",
                              "Usc_urbsubs_best.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(Type,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,

                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c)
    }

  full_table <- lapply(list(list1, list2, list3,
                               list4, list5, list6,
                               list7, list8, list9,
                                list10, list11, list12,
                                list13, list14, list15,
                                list16, list17, list18,
                                list19 , list20, list21,
                                list22, list23, list24,
                                 list25, list26 #, list27
                            ),
                       make_1_table) %>%
    reduce(full_join, all = T) %>%
      dplyr::mutate(Variable = c(list1[[1]]$call[[2]][[2]],
                                 list2[[1]]$call[[2]][[2]],
                                 list3[[1]]$call[[2]][[2]],
                                 list4[[1]]$call[[2]][[2]],
                                 list5[[1]]$call[[2]][[2]],
                                 list6[[1]]$call[[2]][[2]],
                                 list7[[1]]$call[[2]][[2]],
                                 list8[[1]]$call[[2]][[2]],
                                 list9[[1]]$call[[2]][[2]],
                                 list10[[1]]$call[[2]][[2]],
                                 list11[[1]]$call[[2]][[2]],
                                 list12[[1]]$call[[2]][[2]],
                                 list13[[1]]$call[[2]][[2]],
                                 list14[[1]]$call[[2]][[2]],
                                 list15[[1]]$call[[2]][[2]],
                                 list16[[1]]$call[[2]][[2]],
                                 list17[[1]]$call[[2]][[2]],
                                 list18[[1]]$call[[2]][[2]],
                                 list19[[1]]$call[[2]][[2]] ,
                                 list20[[1]]$call[[2]][[2]],
                                 list21[[1]]$call[[2]][[2]],
                                 list22[[1]]$call[[2]][[2]],
                                 list23[[1]]$call[[2]][[2]],
                                 list24[[1]]$call[[2]][[2]],
                                  list25[[1]]$call[[2]][[2]],
                                  list26[[1]]$call[[2]][[2]]#,
                          #       list27[[1]]$call[[2]][[2]]
                                 )) %>%
      dplyr::relocate(Variable) %>%
  dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "poll")~
      "Pollinaria removed",
    str_detect(Variable, "Julian_first")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"
    
    
    )) %>%
        add_row(
      # adding the monarch row this way because otherwise this function breaks when I try to add it, not sure why
      Variable = "Danaus plexippus abundance",
            Type = "trigamma",
            Distance_Q1.R2m = 0,  Distance_Q1.R2c = 0,  Distance_Q2_best.R2m = 0,  Distance_Q2_best.R2c = 0,  UrbScore_Q1.R2m = 0,  UrbScore_Q1.R2c = 0,  UrbScore_Q2_best.R2m = 0,  UrbScore_Q2_best.R2c = 0,
            .before = 17) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4"),
        colwidths = c(2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(2,2,2,2,2))%>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(2,4,4)) %>%
      theme_box() %>%
      align(j = c(2:10), align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9), i = 4,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(4,6,8,10), i = 4,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit()
    
  return(full_table) 
  
}



make_full_R2_table(
  # defense
                   latex_mods_reml_T        ,
                  herb_e_bin_mods_reml_T   ,
                  herb_e_quant_mods_reml_T ,
                  herb_l_bin_mods_reml_T   ,
                  herb_l_quant_mods_reml_T ,
                  weevil_bin_mods_reml_T   ,
                  weevil_quant_mods_reml_T ,
  # reproductive traits
                   flsucc_mods_reml_T   ,
                   flowers_mods_reml_T    ,
                   flsize_mods_reml_T     ,
                   fltime_mods_reml_T     ,
                   flstart_mods_reml_T    ,
                   pods_mods_reml_T       ,
                   first_pods_mods_reml_T ,
                   peduncles_mods_reml_T ,
                   poll_mods_reml_T      ,
  #                  
  # # herbivores
  #                  monarch_mods_reml_T,
                    asclepiadis_mods_reml_T,
                    clivicollis_mods_reml_T,
  # # growth traits
                   ldmc_mods_reml_T     ,
                   sla_mods_reml_T      ,
                   heights_e_mods_reml_T,
                   heights_l_mods_reml_T,
                   rgr_mods_reml_T      ,
                   ramets_e_mods_reml_T ,
                   ramets_l_mods_reml_T ,
                   mortality_mods_reml_T) %T>%
  save_as_docx(path = here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Rsquared_all.docx"),
              pr_section = prop_section(
                page_size = page_size(
                  orient = "landscape",
                  width = 16, height = 15),
                type = "continuous",
                page_margins = page_mar()))
```


## 1-year models
Not doing for cardenolides because same as multi-year mods

Excluding alternative models because my workflow to create 1yr models involved taking best models only
### Create function that makes REML = T one-year models
```{r}
# these functions are too general because the lapply to export all rsquared values see that the data = mod_allyrs_df... need to be specific with each model regarding the year and df & pops included (i.e., exclude rural for Q2)
make_REML_T <- function(mod_1yr,
                             last_year,
                             mod_allyrs_df){
  return(
    update(mod_1yr,
           .~. ,
           data = mod_allyrs_df %>%
             dplyr::filter(Year == last_year),
           REML = T
           )
    )
    
}

make_REML_T_q2 <- function(mod_1yr,
                             last_year,
                             mod_allyrs_df){
  return(
    update(mod_1yr,
           .~. ,
           data = mod_allyrs_df %>%
             dplyr::filter(Year == last_year &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}
#### Reproduction ########
##########################

# DF = reproduc, Year = 2022
make_REML_T_repr1 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = reproduc %>%
             dplyr::filter(Year == "2022"),
           REML = T
           )
    )
    
}

# DF = reproduc, Year = 2022
make_REML_T_repr1_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = reproduc %>%
             dplyr::filter(Year == "2022" &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}


# DF = flowering, Year = 2022
make_REML_T_repr2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = flowering %>%
             dplyr::filter(Year == "2022"),
           REML = T
           )
    )
    
}

# DF = flowering, Year = 2022
make_REML_T_repr2_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = flowering %>%
             dplyr::filter(Year == "2022" &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}


#### Defense ########
#####################

# DF = herbivory, Year = 2021
make_REML_T_def1 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivory %>%
             dplyr::filter(Year == "2021"),
           REML = T
           )
    )
    
}

# DF = herbivory, Year = 2021
make_REML_T_def1_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivory %>%
             dplyr::filter(Year == "2021" &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}


# DF = herbivory, Year = 2021, herb early binary
make_REML_T_def2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivory %>%
             dplyr::filter(Year == "2021" &
                                   Herbivory_mean_early_binary == 1),
           REML = T
           )
    )
    
}

# DF = herbivory, Year = 2021, herb early binary
make_REML_T_def2_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivory %>%
             dplyr::filter(Year == "2021" &
                                   Herbivory_mean_early_binary == 1 &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}


# DF = herbivory, Year = 2021, herb late binary
make_REML_T_def3 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivory %>%
             dplyr::filter(Year == "2021"&
                                   Herbivory_mean_late_binary == 1),
           REML = T
           )
    )
    
}

# DF = herbivory, Year = 2021, herb late binary
make_REML_T_def3_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivory %>%
             dplyr::filter(Year == "2021"&
                                   Herbivory_mean_late_binary == 1 &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}


# DF = weevil, Year = 2021
make_REML_T_def4 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = weevil %>%
             dplyr::filter(Year == "2021"),
           REML = T
           )
    )
    
}

# DF = weevil, Year = 2021
make_REML_T_def4_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = weevil %>%
             dplyr::filter(Year == "2021" &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}


# DF = weevil, Year = 2021, binary
make_REML_T_def5 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = weevil %>%
             dplyr::filter(Year == "2021" &
                                   Scar_length_cm > 0),
           REML = T
           )
    )
    
}

# DF = weevil, Year = 2021, binary
make_REML_T_def5_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = weevil %>%
             dplyr::filter(Year == "2021" &
                                   Scar_length_cm > 0 &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}


#### Herbivores ########
########################

# DF = herbivory, Year = 2021
make_REML_T_herb1 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivores %>%
             dplyr::filter(Year == "2021"),
           REML = T
           )
  )
}

# DF = herbivory, Year = 2021
make_REML_T_herb1_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivores %>%
             dplyr::filter(Year == "2021" &
                             Transect_ID != "Rural"),
           REML = T
           )
  )
}

  
# DF = herbivory, Year = 2021, filtered for clivicollis >9
make_REML_T_herb2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivores %>%
             dplyr::filter(Year == "2021" &
                             Labidomera_clivicollis < 9),
           REML = T
           )
    )
    
}
  
# DF = herbivory, Year = 2021, filtered for clivicollis >9
make_REML_T_herb2_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivores %>%
             dplyr::filter(Year == "2021" &
                             Labidomera_clivicollis < 9 &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}

# labidomera/urb_score/Q2 didnâ€™t converge with 2021 data so I used 2020 data
# DF = herbivory, Urb score, Year = 2020, filtered for clivicollis >9
make_REML_T_herb2_q2_urbscore <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = herbivores %>%
             dplyr::filter(Year == "2020" &
                             Labidomera_clivicollis < 9 &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}


##### Growth ########
#####################

# DF = heights, Year = 2021
make_REML_T_grow1 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = heights %>%
             dplyr::filter(Year == "2021"),
           REML = T
           )
    )
    
}

# DF = heights, Year = 2021
make_REML_T_grow1_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = heights %>%
             dplyr::filter(Year == "2021" &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}

# DF = survival, Year = 2022
make_REML_T_grow2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = survival %>%
             dplyr::filter(Year == "2022"),
           REML = T
           )
    )
    
}

# DF = survival, Year = 2022
make_REML_T_grow2_q2 <- function(mod_1yr){
  return(
    update(mod_1yr,
           .~. ,
           data = survival %>%
             dplyr::filter(Year == "2022" &
                             Transect_ID != "Rural"),
           REML = T
           )
    )
    
}

```

### Reproduction
```{r}

# change REML to T
flsucc_mods_reml_T <- append(
  
  lapply(
    list(repr.m1, repr.m1_u),
   make_REML_T_repr1),
   
  lapply(
     list(repr.tr.m1, repr.tr.m1_u),
  make_REML_T_repr1_q2)
  )


flowers_mods_reml_T  <- append(
  
  lapply(
    list(repr.m2, repr.m2_u),
   make_REML_T_repr2),
  
  lapply(
    list(repr.tr.m2, repr.tr.m2_u),
  make_REML_T_repr2_q2)
  )

flsize_mods_reml_T     <- append(
  
  lapply(
    list(repr.m3, repr.m3_u),
   make_REML_T_repr2),
  
  lapply(
    list(repr.tr.m3, repr.tr.m3_u),
  make_REML_T_repr2_q2)
  )

fltime_mods_reml_T <- append(
  
  lapply(
    list(repr.m4, repr.m4_u),
   make_REML_T_repr2),
  
  lapply(
    list(repr.tr.m4, repr.tr.m4_u),
  make_REML_T_repr2_q2)
  )

flstart_mods_reml_T  <- append(
  
  lapply(
    list(repr.m5, repr.m5_u),
   make_REML_T_repr2),
  
  lapply(
    list(repr.tr.m5, repr.tr.m5_u),
  make_REML_T_repr2_q2)
  )

pods_mods_reml_T  <- append(
  
  lapply(
    list(repr.m6, repr.m6_u),
   make_REML_T_repr2),
  
  lapply(
    list(repr.tr.m6, repr.tr.m6_u),
  make_REML_T_repr2_q2)
  )

first_pods_mods_reml_T <- append(
  
  lapply(
    list(repr.m7, repr.m7_u),
   make_REML_T_repr2),
  
  lapply(
    list(repr.tr.m7, repr.tr.m7_u),
  make_REML_T_repr2_q2)
  )

peduncles_mods_reml_T <- append(
  
  lapply(
    list(repr.m8, repr.m8_u),
   make_REML_T_repr2),
  
  lapply(
    list(repr.tr.m8, repr.tr.m8_u),
  make_REML_T_repr2_q2)
  )

poll_mods_reml_T <- append(
  
  lapply(
    list(repr.m9, repr.m9_u),
   make_REML_T_repr2),
  
  lapply(
    list(repr.tr.m9, repr.tr.m9_u),
  make_REML_T_repr2_q2)
  )


all_models_reml_T <- list(
flsucc_mods_reml_T      , 
flowers_mods_reml_T     , 
flsize_mods_reml_T      , 
fltime_mods_reml_T      , 
flstart_mods_reml_T     , 
poll_mods_reml_T ,
pods_mods_reml_T        , 
first_pods_mods_reml_T  , 
peduncles_mods_reml_T   ) 

names(all_models_reml_T) <- c(
"flsucc_mods"          ,
"flowers_mods"         ,
"flsize_mods"          ,
"fltime_mods",
"flstart_mods",
"poll_mods",
"pods_mods"            ,
"first_pods_mods",
"peduncles_mods")

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

sink(here::here("./Figures_Tables/Rsquared/1yr_mods/Reproduction/Rsquared.txt"))
print(all_rsq)
sink()

```

### Defense
```{r}
# change REML to T for lmers
latex_mods_reml_T          <- reml_to_true(list(latex_mods_best_c[[1]],
                                             latex_mods_best_u[[1]],
                                             latex_mods_best_c[[2]],
                                             latex_mods_best_u[[2]]))


herb_e_bin_mods_reml_T <- append(
  
  lapply(
    list(def.m2, def.m2_u),
   make_REML_T_def1),
   
  lapply(
     list(def.tr.m2, def.tr.m2_u),
  make_REML_T_def1_q2)
  )
  

herb_e_quant_mods_reml_T <- append(
  
  lapply(
    list(def.m3, def.m3_u),
   make_REML_T_def2),
   
  lapply(
     list(def.tr.m3, def.tr.m3_u),
  make_REML_T_def2_q2)
  )


herb_l_bin_mods_reml_T   <- append(
  
  lapply(
    list(def.m4, def.m4_u),
   make_REML_T_def1),
   
  lapply(
     list(def.tr.m4, def.tr.m4_u),
  make_REML_T_def1_q2)
  )


herb_l_quant_mods_reml_T <- append(
  
  lapply(
    list(def.m5, def.m5_u),
   make_REML_T_def3),
   
  lapply(
     list(def.tr.m5, def.tr.m5_u),
  make_REML_T_def3_q2)
  )


weevil_bin_mods_reml_T   <- append(
  
  lapply(
    list(def.m6, def.m6_u),
   make_REML_T_def4),
   
  lapply(
     list(def.tr.m6, def.tr.m6_u),
  make_REML_T_def4_q2)
  )


weevil_quant_mods_reml_T <- append(
  
  lapply(
    list(def.m7, def.m7_u),
   make_REML_T_def5),
   
  lapply(
     list(def.tr.m7, def.tr.m7_u),
  make_REML_T_def5_q2)
  )


all_models_reml_T <- list(
latex_mods_reml_T      ,
herb_e_bin_mods_reml_T       ,
herb_e_quant_mods_reml_T ,
herb_l_bin_mods_reml_T ,
herb_l_quant_mods_reml_T       ,
weevil_bin_mods_reml_T  ,
weevil_quant_mods_reml_T   )

names(all_models_reml_T) <- c(
"latex_mods"         ,
"herb_early_mods_binomial"    ,
"herb_early_mods_quant"    ,
"herb_late_mods_binomial"     ,
"herb_late_mods_quant"     ,
"weev_mods_binomial" ,
"weev_mods_quant")

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Figures_Tables/Rsquared/1yr_mods/Defense/Rsquare.csv"))


```

### 2021 Herbivores
```{r}
# change REML to T
# both monarch and liriomyza models won't give trigamma r2 when I try to export so I'll get rsq values for these the same way I do with labidomera clivicollis
monarch_mods_reml_T <- append(
  
  lapply(
    list(herb.m1, herb.m1_u),
   make_REML_T_herb1),
   
  lapply(
     list(herb.tr.m1, herb.tr.m1_u),
  make_REML_T_herb1_q2)
  )
  


asclepiadis_mods_reml_T <-  append(
  
  lapply(
    list(herb.m2, herb.m2_u),
   make_REML_T_herb1),
   
  lapply(
     list(herb.tr.m2, herb.tr.m2_u),
  make_REML_T_herb1_q2)
  )

# these won't append. will do separately 
clivicollis_mods_reml_T <- append(
  
  lapply(
    list(herb.m3, herb.m3_u),
   make_REML_T_herb2),
   
  make_REML_T_herb2_q2(herb.tr.m3)  )

clivicollis_mods_reml_T %<>% append( 
    make_REML_T_herb2_q2_urbscore(herb.tr.m3_u))



# getting rsq separately
# D. plexippus
DP_r2 <- rbind(
  data.frame(r.squaredGLMM(monarch_mods_reml_T[[1]])),
  data.frame(r.squaredGLMM(monarch_mods_reml_T[[2]])),
  data.frame(r.squaredGLMM(monarch_mods_reml_T[[3]])),
  data.frame(r.squaredGLMM(monarch_mods_reml_T[[4]])))%>%
  as.data.frame() %>%
  dplyr::mutate(Model = c("1", "1", "1", 
                          "2", "2", "2", 
                          "3", "3", "3", 
                          "4", "4", "4"),
                Species = "Danaus plexippus") %>%
  tibble::rownames_to_column("Type")
  
  # L. asclepiadis
LA_r2 <- rbind(
  data.frame(r.squaredGLMM(asclepiadis_mods_reml_T[[1]])),
  data.frame(r.squaredGLMM(asclepiadis_mods_reml_T[[2]])),
  data.frame(r.squaredGLMM(asclepiadis_mods_reml_T[[3]])),
  data.frame(r.squaredGLMM(asclepiadis_mods_reml_T[[4]]))) %>%
  as.data.frame() %>%
  dplyr::mutate(Model = c("1", "1", "1", 
                          "2", "2", "2", 
                          "3", "3", "3", 
                          "4", "4", "4"),
                Species = "Liriomyza asclepiadis") %>%
  tibble::rownames_to_column("Type")
  

    
  # L. clivicollis
LC_r2 <- rbind(
  data.frame(r.squaredGLMM(clivicollis_mods_reml_T[[1]])),
  data.frame(r.squaredGLMM(clivicollis_mods_reml_T[[2]])),
  data.frame(r.squaredGLMM(make_REML_T_herb2_q2(herb.tr.m3) )),
  data.frame(r.squaredGLMM(make_REML_T_herb2_q2_urbscore(herb.tr.m3_u)))) %>%
  as.data.frame() %>%
  dplyr::mutate(Model = c("1", "1", "1", 
                          "2", "2", "2", 
                          "3", "3", "3", 
                          "4", "4", "4"),
                Species = "Labidomera clivicollis") %>%
  tibble::rownames_to_column("Type")
 
herbivores_r2 <- rbind(DP_r2, LA_r2, LC_r2)

# 
# all_models_reml_T <- list(
# monarch_mods_reml_T          , 
# asclepiadis_mods_reml_T   #        , 
# #clivicollis_mods_reml_T
# )
# 
# names(all_models_reml_T) <- c(
# "monarch_mods"          ,
# "asclepiadis_mods"   #        ,
# #"clivicollis_mods" 
#         )

# export to csv
# all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
#   unlist(recursive = FALSE) %T>%
#   write.csv(here::here("./Figures_Tables/Rsquared/1yr_mods/Defense/Rsquare_herbivores.csv"))

herbivores_r2 %>%
  write.csv(here::here("./Figures_Tables/Rsquared/1yr_mods/Defense/Rsquare_herbivores.csv"))
```

### Growth
```{r}
# change REML to T
ldmc_mods_reml_T      <- reml_to_true(list(ldmc_mods_best_c[[1]],
                                           ldmc_mods_best_u[[1]],
                                           ldmc_mods_best_c[[2]],
                                           ldmc_mods_best_u[[2]]))
  
sla_mods_reml_T       <-  reml_to_true(list(sla_mods_best_c[[1]],
                                            sla_mods_best_u[[1]],
                                            sla_mods_best_c[[2]],
                                            sla_mods_best_u[[2]]))
  
heights_e_mods_reml_T <- append(
  
  lapply(
    list(grow.m3, grow.m3_u),
   make_REML_T_grow1),
   
  lapply(
     list(grow.tr.m3, grow.tr.m3_u),
  make_REML_T_grow1_q2)
  )
  

heights_l_mods_reml_T <- append(
  
  lapply(
    list(grow.m4, grow.m4_u),
   make_REML_T_grow1),
   
  lapply(
     list(grow.tr.m4, grow.tr.m4_u),
  make_REML_T_grow1_q2)
  )

rgr_mods_reml_T       <- append(
  
  lapply(
    list(grow.m5, grow.m5_u),
   make_REML_T_grow1),
   
  lapply(
     list(grow.tr.m5, grow.tr.m5_u),
  make_REML_T_grow1_q2)
  )
  
ramets_e_mods_reml_T  <- append(
  
  lapply(
    list(grow.m6, grow.m6_u),
   make_REML_T_grow1),
   
  lapply(
     list(grow.tr.m6, grow.tr.m6_u),
  make_REML_T_grow1_q2)
  )

ramets_l_mods_reml_T  <- append(
  
  lapply(
    list(grow.m7, grow.m7_u),
   make_REML_T_grow1),
   
  lapply(
     list(grow.tr.m7, grow.tr.m7_u),
  make_REML_T_grow1_q2)
  )


mortality_mods_reml_T <- append(
  
  lapply(
    list(grow.m8, grow.m8_u),
   make_REML_T_grow2),
   
  lapply(
     list(grow.tr.m8, grow.tr.m8_u),
  make_REML_T_grow2_q2)
  )


all_models_reml_T <- list(
ldmc_mods_reml_T      ,
sla_mods_reml_T       ,
heights_e_mods_reml_T ,
heights_l_mods_reml_T ,
rgr_mods_reml_T       ,
ramets_e_mods_reml_T  ,
ramets_l_mods_reml_T  ,
mortality_mods_reml_T )

names(all_models_reml_T) <- c(
"ldmc_mods"      ,
"sla_mods"       ,
"heights_e_mods" ,
"heights_l_mods" ,
"rgr_mods"       ,
"ramets_e_mods"  ,
"ramets_l_mods"  ,
"mortality_mods" )

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) #%T>%
  # write.csv(here::here("./Figures_Tables/Rsquared/1yr_mods/Growth/Rsquare.csv")) # this isn't working

sink(here::here("./Figures_Tables/Rsquared/1yr_mods/Growth/Rsquare.csv"))
print(all_rsq)
sink()

```

### Export all Rsq tables into one docx
```{r}

make_full_R2_table <- function(list1, list2, list3,
                               list4, list5, list6,
                               list7, list8, list9,
                                list10, list11, list12,
                                list13, list14, list15,
                                list16, list17, list18,
                                list19 , list20, list21,
                                list22, list23, list24#,
                               # list25, list26, list27
                               ){
      
  make_1_table <- function(list1){
    
      lapply(list1, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
   #   dplyr::select(-contains("alt")) %>%
      dplyr::rename("Type" = 1) %>%
      dplyr::filter(row_number()==n()) %>%
      data.table::as.data.table() %>%
      data.table::melt(.,
           measure = patterns("R2m",         
                              "R2m.1",
                              "R2m.2",
                              "R2m.3", 
                              "R2c",          
                              "R2c.1",
                              "R2c.2",
                              "R2c.3"),
           value.name = c("Distance_Q1.R2m",      
                          "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",     
                          "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(Type,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,

                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c) %>%
      dplyr::filter(row_number()==1)
    }

  full_table <- lapply(list(list1, list2, list3,
                            list4, list5, list6,
                            list7, list8, list9,
                            list10, list11, list12,
                            list13, list14, list15, 
                            list16, list17, list18,
                            list19 , list20, list21,
                            list22, list23, list24#,
                           # list25 , list26, list27
                      ), make_1_table) %>%
    reduce(full_join, all = T) %>%
      dplyr::mutate(Variable = c(list1[[1]]$call[[2]][[2]],
                                 list2[[1]]$call[[2]][[2]],
                                 list3[[1]]$call[[2]][[2]],
                                 list4[[1]]$call[[2]][[2]],
                                 list5[[1]]$call[[2]][[2]],
                                 list6[[1]]$call[[2]][[2]],
                                 list7[[1]]$call[[2]][[2]],
                                 list8[[1]]$call[[2]][[2]],
                                 list9[[1]]$call[[2]][[2]],
                                 list10[[1]]$call[[2]][[2]],
                                 list11[[1]]$call[[2]][[2]],
                                 list12[[1]]$call[[2]][[2]],
                                 list13[[1]]$call[[2]][[2]],
                                 list14[[1]]$call[[2]][[2]],
                                 list15[[1]]$call[[2]][[2]],
                                 list16[[1]]$call[[2]][[2]],
                                 list17[[1]]$call[[2]][[2]],
                                 list18[[1]]$call[[2]][[2]],
                                 list19[[1]]$call[[2]][[2]],
                                 list20[[1]]$call[[2]][[2]],
                                 list21[[1]]$call[[2]][[2]],
                                 list22[[1]]$call[[2]][[2]],
                                 list23[[1]]$call[[2]][[2]],
                                 list24[[1]]$call[[2]][[2]]#,
                                 # list25[[1]]$call[[2]][[2]],
                                 # list26[[1]]$call[[2]][[2]],
                                 # list27[[1]]$call[[2]][[2]]
                                 )) %>%
      dplyr::relocate(Variable) %>%
  dplyr::mutate(Variable = case_when(

    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
      "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory after flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",

    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "poll")~
      "Pollinaria removed",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "Julian_first_foll")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",

    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",

    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_growth_rate")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"


    )) %>%
    add_row(
      # adding the herbivore rows this way because otherwise this function breaks when I try to add them, not sure why
      Variable = "Danaus plexippus abundance",
            Type = "trigamma",
            Distance_Q1.R2m = 0,  Distance_Q1.R2c = 0,  Distance_Q2_best.R2m = 0,  Distance_Q2_best.R2c = 0,  UrbScore_Q1.R2m = 0,  UrbScore_Q1.R2c = 0,  UrbScore_Q2_best.R2m = 0,  UrbScore_Q2_best.R2c = 0,
            .after = 15) %>%
        add_row(
      Variable = "Liriomyza asclepiadis abundance",
            Type = "trigamma",
            Distance_Q1.R2m = 0.013,  Distance_Q1.R2c = 0.029,  Distance_Q2_best.R2m = 0.013,  Distance_Q2_best.R2c = 0.029,  UrbScore_Q1.R2m = 0.011,  UrbScore_Q1.R2c = 0.028,  UrbScore_Q2_best.R2m = 0.011,  UrbScore_Q2_best.R2c = 0.028,
            .after = 16) %>%
        add_row(
      Variable = "Labidomera clivicollis abundance",
            Type = "trigamma",
            Distance_Q1.R2m = 0,  Distance_Q1.R2c = 0,  Distance_Q2_best.R2m = 0,  Distance_Q2_best.R2c = 0,  UrbScore_Q1.R2m = 0,  UrbScore_Q1.R2c = 0,  UrbScore_Q2_best.R2m = 0.001,  UrbScore_Q2_best.R2c = 0.008,
            .after = 17) %>%
       flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4"),
        colwidths = c(2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(2,2,2,2,2))%>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(2,4,4)) %>%
      theme_box() %>%
      align(j = c(2:10), align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9), i = 4,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(4,6,8,10), i = 4,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit()

  return(full_table) 
  
}



make_full_R2_table(
  # defense
                   latex_mods_reml_T        ,
                  herb_e_bin_mods_reml_T   ,
                  herb_e_quant_mods_reml_T ,
                  herb_l_bin_mods_reml_T   ,
                  herb_l_quant_mods_reml_T ,
                  weevil_bin_mods_reml_T   ,
                  weevil_quant_mods_reml_T ,
  
  # reproductive traits
                    flsucc_mods_reml_T   ,  
                   flowers_mods_reml_T    ,
                   flsize_mods_reml_T     ,
                   fltime_mods_reml_T     ,
                   flstart_mods_reml_T    ,
                   poll_mods_reml_T       ,
                   pods_mods_reml_T       ,
                   first_pods_mods_reml_T ,
                   peduncles_mods_reml_T ,
                   
  # herbivores
                   #  monarch_mods_reml_T,
                    # asclepiadis_mods_reml_T,
                    # clivicollis_mods_reml_T,
  # growth traits
                    ldmc_mods_reml_T     ,
                    sla_mods_reml_T      ,
                    heights_e_mods_reml_T,
                    heights_l_mods_reml_T,
                    rgr_mods_reml_T      ,
                    ramets_e_mods_reml_T ,
                    ramets_l_mods_reml_T ,
                    mortality_mods_reml_T
                   ) %T>%
  save_as_docx(path = here::here("./Figures_Tables/Rsquared/1yr_mods/Rsquared_all.docx"),
              pr_section = prop_section(
                page_size = page_size(
                  orient = "landscape",
                  width = 16, height = 15),
                type = "continuous",
                page_margins = page_mar()))
```