# Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

# Import data
## Models
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_1yr_mods.Rmd", quiet=TRUE))

```

## Ranova tables
these values were generated in:
-scripts/Ranovas_anovas_per_category/R_anovas_growth.Rmd (etc. for rest of similarly-named files)...

manually extracted, then organized into these word docs:
-Figures_Tables\ranova_PVE\ranovas_allyears.docx
-Figures_Tables\ranova_PVE\ranovas_allyears_transects.docx

...then placed into csvs for import into R and manipulation: 

### Q1
```{r}
ran1 <- read.csv(here::here("./Figures_Tables/ranova_PVE/ranovas_allyears_Table1.csv"),
                 blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::rename("Variable" = 1)


ran2 <- read.csv(here::here("./Figures_Tables/ranova_PVE/ranovas_allyears_Table2.csv"),
                 blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::rename("Variable" = 1)
```

### Q2
```{r}
ran3 <- read.csv(here::here("./Figures_Tables/ranova_PVE/ranovas_allyears_transects_Table1.csv"),
                 blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::rename("Variable" = 1) %>%
  dplyr::select(Variable:Urbanization)

```

# Calculate heritability, Qst, and CVA (Quantitative genetic parameters)
-not possible for cardenolides because there are no families within pops (were pooled by population)
## Multi-year models
### Defense
```{r}
# Latex-----
update(
    latex_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

latex_mean <- latex %>%
  dplyr::summarize(Mean = mean(Latex_weight_mg,
                               na.rm = T)) %>%
  as.numeric()

qg_latex <- calc_quantgenvars( 0.086644,
                   0.079411,
                   0.387388,
                   latex_mean,
                   "Latex exudation")


# Herbivory, before flowering: Binomial-----

update(
    herb_e_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    herb_e_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

herb_e_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_e_bin <- calc_quantgenvars(  1.8027e-04,
                    2.1094e-05,
                   resid_var,
                   herb_e_bin_mean,
                   "Herbivory before flowering (binary)")


# Herbivory, before flowering: quantitative-----

update(
    herb_e_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

herb_e_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_early_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_e_quant <- calc_quantgenvars( 0.076138  ,
                    0.068185  ,
                   1.230037 ,
                   herb_e_quant_mean,
                   "Herbivory before flowering (quantitative)")

# Herbivory, after flowering: Binomial-----

update(
    herb_l_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    herb_l_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

herb_l_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_l_bin <- calc_quantgenvars(2.3267e-01,
                   6.1084e-05,
                   resid_var,
                   herb_l_bin_mean,
                   "Herbivory after flowering (binary)")



# Herbivory, after flowering: quantitative-----

update(
    herb_l_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

herb_l_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_late_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_l_quant <- calc_quantgenvars( 1.5181e-01 ,
                   8.5992e-05,
                  1.2381e+00,
                   herb_l_quant_mean,
                   "Herbivory after flowering (quantitative)")


# Weevil: Binomial-----

update(
    weev_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    weev_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

weev_bin_mean <- weevil %>%
  dplyr::summarize(Mean = mean(Scar_binary ,
                               na.rm = T)) %>%
  as.numeric()

qg_weev_bin <- calc_quantgenvars(0.54935944  ,
                     0.00015261,
                   resid_var,
                   weev_bin_mean,
                   "Weevil damage (binary)")


# Weevil damage: quantitative-----

update(
    weev_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

weev_quant_mean <- weevil %>%
  dplyr::filter(Scar_length_cm > 0) %>%
  dplyr::summarize(Mean = mean(Scar_length_cm,
                               na.rm = T)) %>%
  as.numeric()

qg_weev_quant <- calc_quantgenvars( 0.20088 ,
                  0.10085 ,
                 1.05936 ,
                   weev_quant_mean,
                   "Weevil damage (quantitative)")

```

### Reproduction
```{r}
# Flowering success-----
update(
    flsucc_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
     flsucc_mods_best_c[[1]], REML = T) %>%
    sigma()

flsucc_mean <- reproduc %>%
  dplyr::summarize(Mean = mean(Flowered ,
                               na.rm = T)) %>%
  as.numeric() # can't calculate this because it's 0s x 1s... will be 0

qg_flsucc <- calc_quantgenvars( 0.70759 ,
                   0.54422 ,
                   resid_var,
                   NA,
                   "Flowering success")


# Mean flowers/inflor -----
update(
    flowers_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flowers_mean <- flowering %>%
  dplyr::summarize(Mean = mean(mean_flower_count ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     flowers_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flowers <- calc_quantgenvars(0.085598,
                   0.129033,
                   resid_var,
                   flowers_mean,
                   "Flowers per inflorescence")


# Mean flower size/inflorescence -----
update(
    flsize_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flsize_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Overall_mean ,
                               na.rm = T)) %>%
  as.numeric()

qg_flsize <- calc_quantgenvars( 2.1742  ,
                   1.7583  ,
                   4.6466  ,
                   flsize_mean,
                   "Flower size")


# Flowering time -----
update(
    fltime_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

fltime_mean <- flowering %>%
  dplyr::summarize(Mean = mean(flowering_time_num ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     fltime_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_fltime <- calc_quantgenvars( 4.8319e-05,
                   1.7015e-01,
                   resid_var,
                   fltime_mean,
                   "Flowering duration")


# Flowering start -----
update(
    flstart_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flstart_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_oldest_inflor ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     flstart_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flstart <- calc_quantgenvars(0.148087,
                   0.074724,
                   resid_var,
                   flstart_mean,
                   "Date of first flower")


# Pods -----
update(
    pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Pods,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_pods <- calc_quantgenvars( 0.18623 ,
                   0.13145 ,
                   resid_var,
                   pods_mean,
                   "Follicles")


# Date of first mature pod -----
update(
    first_pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

first_pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_first_follicle,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     first_pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_first_pods <- calc_quantgenvars( 0.038666,
                   0.035260,
                   resid_var,
                   first_pods_mean,
                   "Date of first follicle")


# Peduncles -----
update(
    peduncles_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

peduncles_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Peduncles,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     peduncles_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_peduncles <- calc_quantgenvars( 0.19237 ,
                   0.25009 ,
                   resid_var,
                   peduncles_mean,
                   "Inflorescences")


```

### Herbivores
```{r}
# Monarchs-----
VarCorr(
  update(
    monarch_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    monarch_mods_best_c[[1]], REML = T) %>%
    sigma()

monarch_mean <- herbivores %>%
  dplyr::summarize(Mean = mean(Monarch_Quantity_Observed,
                               na.rm = T)) %>%
  as.numeric()

qg_monarch <- calc_quantgenvars(0.146429,
                                0.069211,
                                resid_var,
                                monarch_mean,
                                "D. plexippus abundance")


# L. asclepiadis-----
VarCorr(
  update(
    asclepiadis_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    asclepiadis_mods_best_c[[1]], REML = T) %>%
    sigma()


lascelp_mean <- herbivores %>%
  dplyr::summarize(Mean = mean(Liriomyza_asclepiadis ,
                               na.rm = T)) %>%
  as.numeric()

qg_lasclep <- calc_quantgenvars(0.31796 ,
            0.14935 ,
            resid_var,
            lascelp_mean,
            "L. asclepiadis abundance")


# L. clivicollis-----
VarCorr(
  update(
    clivicollis_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    clivicollis_mods_best_c[[1]], REML = T) %>%
    sigma()


clivicoll_mean <- herbivores %>% 
  dplyr::filter(Labidomera_clivicollis < 9) %>% # as in model
  dplyr::summarize(Mean = mean(Labidomera_clivicollis  ,
                               na.rm = T)) %>%
  as.numeric()

qg_clivicoll <- calc_quantgenvars(0.00011488,
            0.30719353,
            resid_var,
            clivicoll_mean,
            "L. clivicollis abundance")
```

### Growth
```{r}
# LDMC-----
update(
    ldmc_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ldmc_mean <- sla_ldmc %>%
  dplyr::filter(LDMC < 1) %>% # as done in model
  dplyr::summarize(Mean = mean(LDMC,
                               na.rm = T)) %>%
  as.numeric()

qg_ldmc <- calc_quantgenvars( 9.4956e-06,
                   2.2071e-05,
                   0.387388,
                   5.8581e-02,
                   "LDMC")


# SLA-----
update(
    sla_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

sla_mean <- sla_ldmc %>%
  dplyr::summarize(Mean = mean(SLA,
                               na.rm = T)) %>%
  as.numeric()

qg_sla <- calc_quantgenvars(4.5386e-06,
                   9.5195e-06,
                    4.0241e-01,
                   sla_mean,
                   "SLA")


# heights, early-----

update(
    heights_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_early,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_e <- calc_quantgenvars(0.36591,
                                  0.15034 ,
                                  1.12547 ,
                   heights_e_mean,
                   "Height before flowering")


# heights, late-----

update(
    heights_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_late,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_l <- calc_quantgenvars(0.49420 ,
                                  0.22338  ,
                                  1.56537  ,
                   heights_l_mean,
                   "Height after flowering")

# RGR-----
update(
    rgr_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

rgr_mean <- heights %>%
  dplyr::summarize(Mean = mean(rel_growth_rate,
                               na.rm = T)) %>%
  as.numeric()
 
qg_rgr <- calc_quantgenvars( 3.8967e-06 ,
                             2.6174e-03 ,
                            5.5405e-02,
                   rgr_mean,
                   "Relative growth rate")

# Ramets, early-----
update(
    ramets_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_early,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_early_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_e <- calc_quantgenvars( 0.247111,
                             0.080902,
                            resid_var,
                   ramets_e_mean,
                   "Ramets before flowering")

# Ramets, late-----
update(
    ramets_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_late,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_late_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_l <- calc_quantgenvars( 0.187996,
                             0.052465,
                            resid_var,
                   ramets_l_mean,
                   "Ramets after flowering")


# Survival-----
update(
    mortality_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

surv_mean <- survival %>%
  as.data.frame %>%
  dplyr::summarize(Mean = mean(as.numeric(Dead),
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     mortality_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_survival <- calc_quantgenvars(6.6969e-08,
                   1.3094e-05,
                   resid_var ,
                   surv_mean,
                   "Mortality")
```

### Combine values into one table and export
```{r}
qgen_list1_multi <- list(

  # Defense
  qg_latex,
  qg_herb_e_bin,
  qg_herb_e_quant,
  qg_herb_l_bin,
  qg_herb_l_quant,
  qg_weev_bin,
  qg_weev_quant,
    
  # Reproduction
  qg_flsucc,
  qg_flowers,
  qg_flsize,
  qg_fltime,
  qg_flstart,
  qg_pods,
  qg_first_pods,
  qg_peduncles,
  
  # Herbivores
  qg_monarch,
  qg_lasclep,
  qg_clivicoll,
  
  # Growth
  qg_ldmc,
  qg_sla,
  qg_heights_e,
  qg_heights_l,
  qg_rgr,
  qg_ramets_e,
  qg_ramets_l,
  qg_survival
                  ) 

qgen_list1_multi %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  dplyr::rename(Variable = 1) %>%
  flextable() %>%
  flextable::compose(part = "header", i = 1, j = 2,
         value = as_paragraph("h",
                              as_sup("2"))) %>%
  flextable::compose(part = "header", i = 1, j = 3,
         value = as_paragraph("Q",
                              as_sub("ST"))) %>%
  flextable::compose(part = "header", i = 1, j = 4,
         value = as_paragraph("CV",
                              as_sub("A"))) %>%
  theme_box() %>%
  flextable::align(j = 2:4, align = "center", part = "all") %>%
  autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/Quant_gen/Quant_gen_multi_yr_mods.docx"))

```

## 1-year models
I have to add in data because 1yr mods imported save formula without actual df names and filtered year, like this: 
data = mod_allyrs_df %>% dplyr::filter(Year == last_year)
### Q1
#### Defense
```{r}
# Latex-----
# same as multi-yr mods

# Herbivory, before flowering: Binomial-----

update(
    def.m2, 
    .~. -City_dist, # omitting city_dist
    data = herbivory %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    def.m2,
    data = herbivory %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()

herb_e_bin_mean <- herbivory %>%
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_e_bin <- calc_quantgenvars(0.10383492,
                   0.00025825,
                   resid_var,
                   herb_e_bin_mean,
                   "Herbivory before flowering (binary)")


# Herbivory, before flowering: quantitative-----

update(
    def.m3,
    .~. -City_dist, # omitting city_dist
    data = herbivory %>%
      dplyr::filter(Year == "2021" &
                      Herbivory_mean_early_binary == 1),
    REML = T) %>% VarCorr()

herb_e_quant_mean <- herbivory %>%
  dplyr::filter(Year == "2021" & Herbivory_mean_early_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_e_quant <- calc_quantgenvars(3.3249e-09,
                   2.5094e-04,
                   1.3468e+00 ,
                   herb_e_quant_mean,
                   "Herbivory before flowering (quantitative)")

# Herbivory, after flowering: Binomial-----

update(
    def.m4, 
    .~. -City_dist, # omitting city_dist
    data = herbivory %>% dplyr::filter(Year == "2021"),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    def.m4,
    data = herbivory %>% dplyr::filter(Year == "2021"),
    REML = T) %>%
    sigma()

herb_l_bin_mean <- herbivory %>%
  dplyr::filter(Year == "2021") %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_l_bin <- calc_quantgenvars(
                   0.64569141,
                   0.00011296,
                   resid_var,
                   herb_l_bin_mean,
                   "Herbivory after flowering (binary)")


# Herbivory, after flowering: quantitative-----

update(
    def.m5,
    .~. -City_dist, # omitting city_dist
    data = herbivory %>%
      dplyr::filter(Year == "2021" &
                      Herbivory_mean_late_binary == 1),
    REML = T) %>% VarCorr()

herb_l_quant_mean <- herbivory %>% 
  dplyr::filter(Year == "2021" & Herbivory_mean_late_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_l_quant <- calc_quantgenvars(1.7105e-01 ,
                  6.8415e-05,
                  1.1502e+00,
                   herb_l_quant_mean,
                   "Herbivory after flowering (quantitative)")


# Weevil: Binomial-----

update(
    def.m6, 
    .~. -City_dist, # omitting city_dist
    data = weevil %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    def.m6, 
    data = weevil %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()

weev_bin_mean <- weevil %>%
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Scar_binary ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_weev_bin <- calc_quantgenvars(0.5139583  ,
                   0.0001328,
                   resid_var,
                   weev_bin_mean,
                   "Weevil damage (binary)")


# Weevil damage: quantitative-----

update(
    def.m7, 
    .~. -City_dist, # omitting city_dist
    data = weevil %>% dplyr::filter(Year == "2021" &
                                   Scar_length_cm > 0),
    REML = T) %>% VarCorr()

weev_quant_mean <- weevil %>%
  dplyr::filter(Year == "2021" & Scar_length_cm > 0) %>%
  dplyr::summarize(Mean = mean(Scar_length_cm,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_weev_quant <- calc_quantgenvars( 0.20666  ,
                  0.15005,
                  1.00045,
                   weev_quant_mean,
                   "Weevil damage (quantitative)")

```

#### Reproduction
```{r}
# Flowering success-----
update(
    repr.m1,
    .~. -City_dist, # omitting city_dist
    data = reproduc %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    repr.m1,
    data = reproduc %>% dplyr::filter(Year == 2022),
    REML = T) %>% sigma()

flsucc_mean <- reproduc %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Flowered ,
                               na.rm = T)) %>%
  as.numeric() # can't calculate this because it's 0s x 1s... will be 0

qg_1yr_flsucc <- calc_quantgenvars(
                   0.25975  ,
                   0.51146  ,
                   resid_var,
                   NA,
                   "Flowering success")


# Mean flowers/inflor -----
update(
    repr.m2,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

flowers_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(mean_flower_count ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    repr.m2,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_flowers <- calc_quantgenvars(
                   5.1344e-05,
                   1.3615e-01,
                   resid_var,
                   flowers_mean,
                   "Flowers per Inflorescence")


# Mean flower size/inflorescence -----
update(
    repr.m3,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

flsize_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Overall_mean ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_flsize <- calc_quantgenvars( 1.0523    ,
                   1.3941    ,
                   4.8971    ,
                   flsize_mean,
                   "Flower size")


# Flowering time -----
update(
    repr.m4,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

fltime_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(flowering_time_num ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m4,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_fltime <- calc_quantgenvars(
                   2.1588e-05,
                   4.8254e-05,
                   resid_var,
                   fltime_mean,
                   "Flowering duration")


# Flowering start -----
update(
    repr.m5,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

flstart_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Julian_oldest_inflor -170,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m5, 
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_flstart <- calc_quantgenvars(1.4040e-01,
                   2.5568e-05,
                   resid_var,
                   flstart_mean,
                   "Date of first flower")


# Pods -----
update(
    repr.m6,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

pods_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Pods,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m6,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_pods <- calc_quantgenvars(5.1750e-05,
                   6.5619e-05 ,
                   resid_var,
                   pods_mean,
                   "Follicles")


# Date of first mature pod -----
update(
    repr.m7,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

first_pods_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Julian_first_follicle - 200,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m7,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_first_pods <- calc_quantgenvars( 0.364919,
                   0.035549,
                   resid_var,
                   first_pods_mean,
                   "Date of first follicle")


# Peduncles -----
update(
    repr.m8,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

peduncles_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Peduncles,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m8,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_peduncles <- calc_quantgenvars(6.5948e-05,
                   2.2317e-01 ,
                   resid_var,
                   peduncles_mean,
                   "Inflorescences")


```

#### Herbivores
```{r}
# Monarchs-----
VarCorr(
  update(
    herb.m1, 
     .~. -City_dist, # omitting city_dist
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T))

# residual variance:
resid_var <- update(
    herb.m1,
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()

monarch_mean <- herbivores %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Monarch_Quantity_Observed,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_monarch <- calc_quantgenvars(0.17212 ,
                                0.16350 ,
                                resid_var,
                                monarch_mean,
                                "D. plexippus abundance")


# L. asclepiadis-----
VarCorr(
  update(
    herb.m2, 
     .~. -City_dist, # omitting city_dist
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T))

# residual variance:
resid_var <- update(
    herb.m2,
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()


lascelp_mean <- herbivores %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Liriomyza_asclepiadis ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_lasclep <- calc_quantgenvars(0.31791  ,
            0.18936  ,
            resid_var,
            lascelp_mean,
            "L. asclepiadis abundance")


# L. clivicollis-----
VarCorr(
  update(
    herb.m3, 
     .~. -City_dist, # omitting city_dist
    data = herbivores %>% dplyr::filter(Year == 2021& Labidomera_clivicollis < 9),
    REML = T))

# residual variance:
resid_var <- update(
    herb.m3,
    data = herbivores %>% dplyr::filter(Year == 2021& Labidomera_clivicollis < 9),
    REML = T) %>%
    sigma()


clivicoll_mean <- herbivores %>% 
  dplyr::filter(Year == 2021 & Labidomera_clivicollis < 9) %>%
  dplyr::summarize(Mean = mean(Labidomera_clivicollis  ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_clivicoll <- calc_quantgenvars(9.7757e-05,
            4.1090e-01,
            resid_var,
            clivicoll_mean,
            "L. clivicollis abundance")
```


#### Growth
```{r}
# LDMC-----
# same as multi-yr mods (only 1 year)


# SLA-----
# same as multi-yr mods (only 1 year)

# heights, early-----

update(
    grow.m3, 
    .~. -City_dist, # omitting city_dist
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

heights_e_mean <- heights %>%
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Total_Height_early,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_heights_e <- calc_quantgenvars(0.51437 ,
                                  0.18437  ,
                                  1.60275  ,
                   heights_e_mean,
                   "Height before flowering")


# heights, late-----

update(
    grow.m4, 
    .~. -City_dist, # omitting city_dist
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

heights_l_mean <- heights %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Total_Height_late,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_heights_l <- calc_quantgenvars(0.55987  ,
                                  0.26137   ,
                                  2.08706   ,
                   heights_l_mean,
                   "Height after flowering")

# RGR-----
update(
   grow.m5, 
    .~. -City_dist, # omitting city_dist
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

rgr_mean <- heights %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(rel_growth_rate,
                               na.rm = T)) %>%
  as.numeric()
 
qg_1yr_rgr <- calc_quantgenvars(6.2247e-03,
                             4.4362e-06 ,
                            6.0391e-02,
                   rgr_mean,
                   "Relative growth rate")

# Ramets, early-----
update(
    grow.m6, 
    .~. -City_dist, # omitting city_dist
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

ramets_e_mean <- heights %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Ramets_early,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    grow.m6,
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()
 
qg_1yr_ramets_e <- calc_quantgenvars( 0.296370,
                             0.055885,
                            resid_var,
                   ramets_e_mean,
                   "Ramets before flowering")

# Ramets, late-----
update(
  grow.m7,
  .~. -City_dist, # omitting city_dist
  data = heights %>% dplyr::filter(Year == 2021),
  REML = T) %>% VarCorr()

ramets_l_mean <- heights %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Ramets_late,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    grow.m7,
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()
 
qg_1yr_ramets_l <- calc_quantgenvars( 0.272657,
                             0.072276,
                            resid_var,
                   ramets_l_mean,
                   "Ramets after flowering")


# Survival-----
update(
    grow.m8, 
    .~. -City_dist, # omitting city_dist
    data = survival %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

surv_mean <- survival %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(as.numeric(Dead),
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     grow.m8,
     data = survival %>% dplyr::filter(Year == 2022),
     REML = T) %>%
    sigma()

qg_1yr_survival <- calc_quantgenvars(0.32267 ,
                   0.25963,
                   resid_var ,
                   surv_mean,
                   "Mortality")
```

#### Combine values into one table and export
```{r}
qgen_list1 <- list(
  
  # Defense
  qg_latex, # same as multi-yr mods (only 1 year)
  qg_1yr_herb_e_bin,
  qg_1yr_herb_e_quant,
  qg_1yr_herb_l_bin,
  qg_1yr_herb_l_quant,
  qg_1yr_weev_bin,
  qg_1yr_weev_quant,
  
  # Reproduction
  qg_1yr_flsucc,
  qg_1yr_flowers,
  qg_1yr_flsize,
  qg_1yr_fltime,
  qg_1yr_flstart,
  qg_1yr_pods,
  qg_1yr_first_pods,
  qg_1yr_peduncles,
  
  # Herbivores
  qg_1yr_monarch, 
  qg_1yr_lasclep, 
  qg_1yr_clivicoll,
  
  # Growth
  qg_ldmc, # same as multi-yr mods (only 1 year)
  qg_sla, # same as multi-yr mods (only 1 year)
  qg_1yr_heights_e,
  qg_1yr_heights_l,
  qg_1yr_rgr,
  qg_1yr_ramets_e,
  qg_1yr_ramets_l,
  qg_1yr_survival
                  )


qgen_list1 %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  dplyr::rename(Variable = 1) %>%
  flextable() %>%
  flextable::compose(part = "header", i = 1, j = 2,
         value = as_paragraph("h",
                              as_sup("2"))) %>%
  flextable::compose(part = "header", i = 1, j = 3,
         value = as_paragraph("Q",
                              as_sub("ST"))) %>%
  flextable::compose(part = "header", i = 1, j = 4,
         value = as_paragraph("CV",
                              as_sub("A"))) %>%
  theme_box() %>%
  flextable::align(j = 2:4, align = "center", part = "all") %>%
  autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/Quant_gen/Quant_gen_1yrmods_Q1.docx"))

```


#### Take p-values from ranova and append to qgen table
```{r}
# keep only p-values for distance
qgen_ranova1 <- ran2 %>%
  dplyr::select(1, p_Population_Distance, p_Family_Distance) 

qgen_list1 %>% 
  bind_rows() %>%
  dplyr::rename(Variable = trait) %>%
  dplyr::mutate(Variable = str_replace(Variable,
                                       "Flowers per Inflorescence",
                                       "Flowers per inflorescence")) %>%
  full_join(., qgen_ranova1) %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  dplyr::select(Variable,
                h2, cva, p_Family_Distance,
                qst, p_Population_Distance) %>%
  flextable() %>%
  hline(border = NULL, part = "body") %>%
  flextable::bold(i = ~ p_Family_Distance <= 0.05, j = 4) %>%
  flextable::bold(i = ~ p_Population_Distance <= 0.05, j = 6) %>%
  flextable::compose(part = "header", i = 1, j = 2,
         value = as_paragraph("h",
                              as_sup("2"))) %>%
  flextable::compose(part = "header", i = 1, j = 5,
         value = as_paragraph("Q",
                              as_sub("ST"))) %>%
  flextable::compose(part = "header", i = 1, j = 3,
         value = as_paragraph("CV",
                              as_sub("A"))) %>%
  flextable::compose(part = "header", i = 1, j = 4,
         value = as_paragraph("p (Family)")) %>%
  flextable::compose(part = "header", i = 1, j = 6,
         value = as_paragraph("p (Population)")) %>%
  flextable::align(j = 2:6, align = "center", part = "all") %>%
  autofit() %>%
    padding(padding = 3) %>%
  save_as_docx(path = here::here("./Figures_Tables/Quant_gen/Quant_gen_1yrmods_Q1_withAnova.docx"))
```

### Q2
#### Defense
```{r}
# Latex-----
update(
    latex_mods_best_c[[2]], 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    REML = T) %>% VarCorr()

latex_mean <- latex %>%
  dplyr::filter(Transect_ID != "Rural") %>%
  dplyr::summarize(Mean = mean(Latex_weight_mg,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_latex <- calc_quantgenvars(0.11109 ,
                   0.07477 ,
                   0.39446 ,
                   latex_mean ,
                   "Latex exudation")

# Herbivory, before flowering: Binomial-----

update(
    def.tr.m2, 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = herbivory %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    def.tr.m2,
    data = herbivory %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>%
    sigma()

herb_e_bin_mean <- herbivory %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2021) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_e_bin <- calc_quantgenvars(5.6520e-05,
                   1.7935e-05,
                   resid_var,
                   herb_e_bin_mean,
                   "Herbivory before flowering (binary)")


# Herbivory, before flowering: quantitative-----

update(
    def.tr.m3,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = herbivory %>%
      dplyr::filter(Transect_ID != "Rural" & Year == "2021" &
                      Herbivory_mean_early_binary == 1),
    REML = T) %>% VarCorr()

herb_e_quant_mean <- herbivory %>%
  dplyr::filter(Transect_ID != "Rural" & Year == "2021" & Herbivory_mean_early_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_e_quant <- calc_quantgenvars(2.7951e-05,
                   4.7939e-05,
                   1.3214e+00 ,
                   herb_e_quant_mean,
                   "Herbivory before flowering (quantitative)")

# Herbivory, after flowering: Binomial-----
update(
    def.tr.m4, 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = herbivory %>% dplyr::filter(Transect_ID != "Rural" & Year == "2021"),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    def.tr.m4,
    data = herbivory %>% dplyr::filter(Transect_ID != "Rural" & Year == "2021"),
    REML = T) %>%
    sigma()

herb_l_bin_mean <- herbivory %>%
  dplyr::filter(Transect_ID != "Rural" & Year == "2021") %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_l_bin <- calc_quantgenvars(
                   0.95620931,
                   0.00010324,
                   resid_var,
                   herb_l_bin_mean,
                   "Herbivory after flowering (binary)")


# Herbivory, after flowering: quantitative-----

update(
    def.tr.m5,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = herbivory %>%
      dplyr::filter(Transect_ID != "Rural" & Year == "2021" &
                      Herbivory_mean_late_binary == 1),
    REML = T) %>% VarCorr()

herb_l_quant_mean <- herbivory %>% 
  dplyr::filter(Transect_ID != "Rural" & Year == "2021" & Herbivory_mean_late_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_l_quant <- calc_quantgenvars(2.2161e-01,
                  5.4731e-05,
                  1.1407e+00,
                   herb_l_quant_mean,
                   "Herbivory after flowering (quantitative)")


# Weevil: Binomial-----

update(
    def.tr.m6, 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = weevil %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    def.tr.m6, 
    data = weevil %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>%
    sigma()

weev_bin_mean <- weevil %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2021) %>%
  dplyr::summarize(Mean = mean(Scar_binary ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_weev_bin <- calc_quantgenvars(0.57194927  ,
                   0.00014846,
                   resid_var,
                   weev_bin_mean,
                   "Weevil damage (binary)")


# Weevil damage: quantitative-----

update(
    def.tr.m7, 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = weevil %>% dplyr::filter(Transect_ID != "Rural" & Year == "2021" &
                                   Scar_length_cm > 0),
    REML = T) %>% VarCorr()

weev_quant_mean <- weevil %>%
  dplyr::filter(Transect_ID != "Rural" & Year == "2021" & Scar_length_cm > 0) %>%
  dplyr::summarize(Mean = mean(Scar_length_cm,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_weev_quant <- calc_quantgenvars( 0.29391   ,
                  0.19662 ,
                  0.96289 ,
                   weev_quant_mean,
                   "Weevil damage (quantitative)")

```

#### Reproduction
```{r}
# Flowering success-----
update(
    repr.tr.m1,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = reproduc %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    repr.tr.m1,
    data = reproduc %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% sigma()

flsucc_mean <- reproduc %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2022) %>%
  dplyr::summarize(Mean = mean(Flowered ,
                               na.rm = T)) %>%
  as.numeric() # can't calculate this because it's 0s x 1s... will be 0

qg_1yr_flsucc <- calc_quantgenvars(
                   0.57545   ,
                   0.33486   ,
                   resid_var,
                   NA,
                   "Flowering success")


# Mean flowers/inflor -----
update(
    repr.tr.m2,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% VarCorr()

flowers_mean <- flowering %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2022) %>%
  dplyr::summarize(Mean = mean(mean_flower_count ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    repr.tr.m2,
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_flowers <- calc_quantgenvars(
                   4.9237e-05,
                   1.6405e-01,
                   resid_var,
                   flowers_mean,
                   "Flowers per Inflorescence")


# Mean flower size/inflorescence -----
update(
    repr.tr.m3,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% VarCorr()

flsize_mean <- flowering %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2022) %>%
  dplyr::summarize(Mean = mean(Overall_mean ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_flsize <- calc_quantgenvars( 2.253345    ,
                   0.016595    ,
                   4.789023    ,
                   flsize_mean,
                   "Flower size")


# Flowering time -----
update(
    repr.tr.m4,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% VarCorr()

fltime_mean <- flowering %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2022) %>%
  dplyr::summarize(Mean = mean(flowering_time_num ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.tr.m4,
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_fltime <- calc_quantgenvars(
                   5.0568e-05,
                   1.2136e-01,
                   resid_var,
                   fltime_mean,
                   "Flowering duration")


# Flowering start -----
update(
    repr.tr.m5,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% VarCorr()

flstart_mean <- flowering %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2022) %>%
  dplyr::summarize(Mean = mean(Julian_oldest_inflor -170,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.tr.m5, 
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_flstart <- calc_quantgenvars(1.6379e-01,
                   3.9259e-05,
                   resid_var,
                   flstart_mean,
                   "Date of first flower")


# Pods -----
update(
    repr.tr.m6,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% VarCorr()

pods_mean <- flowering %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2022) %>%
  dplyr::summarize(Mean = mean(Pods,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.tr.m6,
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_pods <- calc_quantgenvars(9.7742e-05,
                   2.0408e-05 ,
                   resid_var,
                   pods_mean,
                   "Follicles")


# Date of first mature pod -----
update(
    repr.tr.m7,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% VarCorr()

first_pods_mean <- flowering %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2022) %>%
  dplyr::summarize(Mean = mean(Julian_first_follicle - 200,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.tr.m7,
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_first_pods <- calc_quantgenvars( 0.326643,
                   0.047126,
                   resid_var,
                   first_pods_mean,
                   "Date of first follicle")


# Peduncles -----
update(
    repr.tr.m8,
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% VarCorr()

peduncles_mean <- flowering %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2022) %>%
  dplyr::summarize(Mean = mean(Peduncles,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.tr.m8,
    data = flowering %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_peduncles <- calc_quantgenvars(0.41362 ,
                   0.50963  ,
                   resid_var,
                   peduncles_mean,
                   "Inflorescences")


```

#### Herbivores
```{r}
# Monarchs-----
VarCorr(
  update(
    herb.tr.m1, 
     .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = herbivores %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T))

# residual variance:
resid_var <- update(
    herb.tr.m1,
    data = herbivores %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>%
    sigma()

monarch_mean <- herbivores %>% 
  dplyr::filter(Transect_ID != "Rural" & Year == 2021) %>%
  dplyr::summarize(Mean = mean(Monarch_Quantity_Observed,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_monarch <- calc_quantgenvars(0.00019631 ,
                                0.13860512 ,
                                resid_var,
                                monarch_mean,
                                "D. plexippus abundance")


# L. asclepiadis-----
VarCorr(
  update(
    herb.tr.m2, 
     .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = herbivores %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T))

# residual variance:
resid_var <- update(
    herb.tr.m2,
    data = herbivores %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>%
    sigma()


lascelp_mean <- herbivores %>% 
  dplyr::filter(Transect_ID != "Rural" & Year == 2021) %>%
  dplyr::summarize(Mean = mean(Liriomyza_asclepiadis ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_lasclep <- calc_quantgenvars(0.40251   ,
            0.11654  ,
            resid_var,
            lascelp_mean,
            "L. asclepiadis abundance")


# L. clivicollis-----
VarCorr(
  update(
    herb.tr.m3, 
     .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = herbivores %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021& Labidomera_clivicollis < 9),
    REML = T))

# residual variance:
resid_var <- update(
    herb.tr.m3,
    data = herbivores %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021& Labidomera_clivicollis < 9),
    REML = T) %>%
    sigma()


clivicoll_mean <- herbivores %>% 
  dplyr::filter(Transect_ID != "Rural" & Year == 2021 & Labidomera_clivicollis < 9) %>%
  dplyr::summarize(Mean = mean(Labidomera_clivicollis  ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_clivicoll <- calc_quantgenvars(0.00075799,
            0.16164025,
            resid_var,
            clivicoll_mean,
            "L. clivicollis abundance")
```


#### Growth
```{r}
# LDMC-----
update(
    ldmc_mods_best_c[[2]], 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    REML = T) %>% VarCorr()

ldmc_mean <- sla_ldmc %>%
  dplyr::filter(Transect_ID != "Rural") %>%
  dplyr::summarize(Mean = mean(LDMC,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_ldmc <- calc_quantgenvars(0.0073648 ,
                   0.0051877 ,
                   0.0591275 ,
                   ldmc_mean ,
                   "LDMC")


# SLA-----
update(
    sla_mods_best_c[[2]], 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    REML = T) %>% VarCorr()

sla_mean <- sla_ldmc %>%
  dplyr::filter(Transect_ID != "Rural") %>%
  dplyr::summarize(Mean = mean(SLA,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_sla <- calc_quantgenvars(5.5926e-06 ,
                   1.3719e-05 ,
                   3.8839e-01 ,
                   sla_mean ,
                   "SLA")

# heights, early-----
update(
    grow.tr.m3, 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = heights %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>% VarCorr()

heights_e_mean <- heights %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2021) %>%
  dplyr::summarize(Mean = mean(Total_Height_early,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_heights_e <- calc_quantgenvars(0.543825 ,
                                  0.040434  ,
                                  1.624786  ,
                   heights_e_mean,
                   "Height before flowering")


# heights, late-----
update(
    grow.tr.m4, 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = heights %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>% VarCorr()

heights_l_mean <- heights %>% 
  dplyr::filter(Transect_ID != "Rural" & Year == 2021) %>%
  dplyr::summarize(Mean = mean(Total_Height_late,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_heights_l <- calc_quantgenvars(0.664790  ,
                                  0.033848   ,
                                  2.096064   ,
                   heights_l_mean,
                   "Height after flowering")

# RGR-----
update(
   grow.tr.m5, 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = heights %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>% VarCorr()

rgr_mean <- heights %>% 
  dplyr::filter(Transect_ID != "Rural" & Year == 2021) %>%
  dplyr::summarize(Mean = mean(rel_growth_rate,
                               na.rm = T)) %>%
  as.numeric()
 
qg_1yr_rgr <- calc_quantgenvars(5.4888e-06,
                                4.2560e-03,
                                6.0832e-02,
                   rgr_mean,
                   "Relative growth rate")

# Ramets, early-----
update(
    grow.tr.m6, 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = heights %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>% VarCorr()

ramets_e_mean <- heights %>% 
  dplyr::filter(Transect_ID != "Rural" & Year == 2021) %>%
  dplyr::summarize(Mean = mean(Ramets_early,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    grow.tr.m6,
    data = heights %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>%
    sigma()
 
qg_1yr_ramets_e <- calc_quantgenvars( 0.310442,
                             0.066217,
                            resid_var,
                   ramets_e_mean,
                   "Ramets before flowering")

# Ramets, late-----
update(
  grow.tr.m7,
  .~. -City_dist, # omitting city_dist
  data = heights %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
  REML = T) %>% VarCorr()

ramets_l_mean <- heights %>% 
  dplyr::filter(Transect_ID != "Rural" & Year == 2021) %>%
  dplyr::summarize(Mean = mean(Ramets_late,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    grow.tr.m7,
    data = heights %>% dplyr::filter(Transect_ID != "Rural" & Year == 2021),
    REML = T) %>%
    sigma()
 
qg_1yr_ramets_l <- calc_quantgenvars( 0.28857556,
                             0.00007192,
                            resid_var,
                   ramets_l_mean,
                   "Ramets after flowering")


# Survival-----
update(
    grow.tr.m8, 
    .~. -City_dist*Transect_ID, # omitting city_dist & transect
    data = survival %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
    REML = T) %>% VarCorr()

surv_mean <- survival %>%
  dplyr::filter(Transect_ID != "Rural" & Year == 2022) %>%
  dplyr::summarize(Mean = mean(as.numeric(Dead),
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     grow.tr.m8,
     data = survival %>% dplyr::filter(Transect_ID != "Rural" & Year == 2022),
     REML = T) %>%
    sigma()

qg_1yr_survival <- calc_quantgenvars(0.56265  ,
                   0.19897 ,
                   resid_var ,
                   surv_mean,
                   "Mortality")
```

#### Combine values into one table and export
```{r}
qgen_list2 <- list(
  
  # Defense
  qg_1yr_latex,
  qg_1yr_herb_e_bin,
  qg_1yr_herb_e_quant,
  qg_1yr_herb_l_bin,
  qg_1yr_herb_l_quant,
  qg_1yr_weev_bin,
  qg_1yr_weev_quant,
  
  # Reproduction
  qg_1yr_flsucc,
  qg_1yr_flowers,
  qg_1yr_flsize,
  qg_1yr_fltime,
  qg_1yr_flstart,
  qg_1yr_pods,
  qg_1yr_first_pods,
  qg_1yr_peduncles,
  
  # Herbivores
  qg_1yr_monarch, 
  qg_1yr_lasclep, 
  qg_1yr_clivicoll,
  
  # Growth
  qg_1yr_ldmc,
  qg_1yr_sla, 
  qg_1yr_heights_e,
  qg_1yr_heights_l,
  qg_1yr_rgr,
  qg_1yr_ramets_e,
  qg_1yr_ramets_l,
  qg_1yr_survival
                  )

qgen_list2 %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  dplyr::rename(Variable = 1) %>%
  flextable() %>%
  flextable::compose(part = "header", i = 1, j = 2,
         value = as_paragraph("h",
                              as_sup("2"))) %>%
  flextable::compose(part = "header", i = 1, j = 3,
         value = as_paragraph("Q",
                              as_sub("ST"))) %>%
  flextable::compose(part = "header", i = 1, j = 4,
         value = as_paragraph("CV",
                              as_sub("A"))) %>%
  theme_box() %>%
  flextable::align(j = 2:4, align = "center", part = "all") %>%
  autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/Quant_gen/Quant_gen_1yrmods_Q2.docx"))

```

#### Take p-values from ranova (Distance to CC ONLY- not urb score) and append to qgen table
```{r}
# keep only p-values for distance
qgen_ranova2 <- ran3 %>%
  dplyr::filter(Urbanization == "Distance") %>%
  dplyr::select(1, p, Group) %>%
  pivot_wider(names_from = c("Group"),
              values_from = c("p"))

qgen_list2 %>% 
  bind_rows() %>%
  dplyr::rename(Variable = trait) %>%
  dplyr::mutate(Variable = str_replace(Variable,
                                       "Flowers per Inflorescence",
                                       "Flowers per inflorescence")) %>%
  full_join(., qgen_ranova2) %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  dplyr::select(Variable,
                h2, cva, Family,
                qst, Population) %>%
  flextable() %>%
  hline(border = NULL, part = "body") %>%
  flextable::bold(i = ~ Family <= 0.05, j = 4) %>%
  flextable::bold(i = ~ Population <= 0.05, j = 6) %>%
  flextable::compose(part = "header", i = 1, j = 2,
         value = as_paragraph("h",
                              as_sup("2"))) %>%
  flextable::compose(part = "header", i = 1, j = 5,
         value = as_paragraph("Q",
                              as_sub("ST"))) %>%
  flextable::compose(part = "header", i = 1, j = 3,
         value = as_paragraph("CV",
                              as_sub("A"))) %>%
  flextable::compose(part = "header", i = 1, j = 4,
         value = as_paragraph("p (Family)")) %>%
  flextable::compose(part = "header", i = 1, j = 6,
         value = as_paragraph("p (Population)")) %>%
  flextable::align(j = 2:6, align = "center", part = "all") %>%
  autofit() %>%
    padding(padding = 3) %>%
  save_as_docx(path = here::here("./Figures_Tables/Quant_gen/Quant_gen_1yrmods_Q2_withAnova.docx"))
```