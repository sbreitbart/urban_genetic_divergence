# Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

# Import data
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_1yr_mods.Rmd", quiet=TRUE))

```

# Calculate heritability, Qst, and CVA (Quantitative genetic parameters)

Just including gradient models (all pops included).

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"

-not possible for cardenolides because there are no families within pops (were pooled by population)
## Multi-year models
### Defense
```{r}
# Latex-----
update(
    latex_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

latex_mean <- latex %>%
  dplyr::summarize(Mean = mean(Latex_weight_mg,
                               na.rm = T)) %>%
  as.numeric()

qg_latex <- calc_quantgenvars( 0.086644,
                   0.079411,
                   0.387388,
                   latex_mean,
                   "Latex exudation")


# Herbivory, before flowering: Binomial-----

update(
    herb_e_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    herb_e_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

herb_e_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_e_bin <- calc_quantgenvars(  1.8027e-04,
                    2.1094e-05,
                   resid_var,
                   herb_e_bin_mean,
                   "Herbivory before flowering (binary)")


# Herbivory, before flowering: quantitative-----

update(
    herb_e_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

herb_e_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_early_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_e_quant <- calc_quantgenvars( 0.076138  ,
                    0.068185  ,
                   1.230037 ,
                   herb_e_quant_mean,
                   "Herbivory before flowering (quantitative)")

# Herbivory, after flowering: Binomial-----

update(
    herb_l_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    herb_l_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

herb_l_bin_mean <- herbivory %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_l_bin <- calc_quantgenvars(2.3267e-01,
                   6.1084e-05,
                   resid_var,
                   herb_l_bin_mean,
                   "Herbivory after flowering (binary)")



# Herbivory, after flowering: quantitative-----

update(
    herb_l_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

herb_l_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_late_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late,
                               na.rm = T)) %>%
  as.numeric()

qg_herb_l_quant <- calc_quantgenvars( 1.5181e-01 ,
                   8.5992e-05,
                  1.2381e+00,
                   herb_l_quant_mean,
                   "Herbivory after flowering (quantitative)")


# Weevil: Binomial-----

update(
    weev_bin_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    weev_bin_mods_best_c[[1]], REML = T) %>%
    sigma()

weev_bin_mean <- weevil %>%
  dplyr::summarize(Mean = mean(Scar_binary ,
                               na.rm = T)) %>%
  as.numeric()

qg_weev_bin <- calc_quantgenvars(0.54935944  ,
                     0.00015261,
                   resid_var,
                   weev_bin_mean,
                   "Weevil damage (binary)")


# Weevil damage: quantitative-----

update(
    weev_quant_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

weev_quant_mean <- weevil %>%
  dplyr::filter(Scar_length_cm > 0) %>%
  dplyr::summarize(Mean = mean(Scar_length_cm,
                               na.rm = T)) %>%
  as.numeric()

qg_weev_quant <- calc_quantgenvars( 0.20088 ,
                  0.10085 ,
                 1.05936 ,
                   weev_quant_mean,
                   "Weevil damage (quantitative)")

```

### Reproduction
```{r}
# Flowering success-----
update(
    flsucc_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
     flsucc_mods_best_c[[1]], REML = T) %>%
    sigma()

flsucc_mean <- reproduc %>%
  dplyr::summarize(Mean = mean(Flowered ,
                               na.rm = T)) %>%
  as.numeric() # can't calculate this because it's 0s x 1s... will be 0

qg_flsucc <- calc_quantgenvars( 0.70759 ,
                   0.54422 ,
                   resid_var,
                   NA,
                   "Flowering success")


# Mean flowers/inflor -----
update(
    flowers_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flowers_mean <- flowering %>%
  dplyr::summarize(Mean = mean(mean_flower_count ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     flowers_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flowers <- calc_quantgenvars(0.085598,
                   0.129033,
                   resid_var,
                   flowers_mean,
                   "Flowers per inflorescence")


# Mean flower size/inflorescence -----
update(
    flsize_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flsize_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Overall_mean ,
                               na.rm = T)) %>%
  as.numeric()

qg_flsize <- calc_quantgenvars( 2.1742  ,
                   1.7583  ,
                   4.6466  ,
                   flsize_mean,
                   "Flower size")


# Flowering time -----
update(
    fltime_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

fltime_mean <- flowering %>%
  dplyr::summarize(Mean = mean(flowering_time_num ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     fltime_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_fltime <- calc_quantgenvars( 4.8319e-05,
                   1.7015e-01,
                   resid_var,
                   fltime_mean,
                   "Flowering duration")


# Flowering start -----
update(
    flstart_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flstart_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_oldest_inflor ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     flstart_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flstart <- calc_quantgenvars(0.148087,
                   0.074724,
                   resid_var,
                   flstart_mean,
                   "Date of first flower")


# Pods -----
update(
    pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Pods,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_pods <- calc_quantgenvars( 0.18623 ,
                   0.13145 ,
                   resid_var,
                   pods_mean,
                   "Follicles")


# Date of first mature pod -----
update(
    first_pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

first_pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_first_follicle,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     first_pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_first_pods <- calc_quantgenvars( 0.038666,
                   0.035260,
                   resid_var,
                   first_pods_mean,
                   "Date of first follicle")


# Peduncles -----
update(
    peduncles_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

peduncles_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Peduncles,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     peduncles_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_peduncles <- calc_quantgenvars( 0.19237 ,
                   0.25009 ,
                   resid_var,
                   peduncles_mean,
                   "Inflorescences")


```

### Herbivores
```{r}
# Monarchs-----
VarCorr(
  update(
    monarch_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    monarch_mods_best_c[[1]], REML = T) %>%
    sigma()

monarch_mean <- herbivores %>%
  dplyr::summarize(Mean = mean(Monarch_Quantity_Observed,
                               na.rm = T)) %>%
  as.numeric()

qg_monarch <- calc_quantgenvars(0.146429,
                                0.069211,
                                resid_var,
                                monarch_mean,
                                "D. plexippus abundance")


# L. asclepiadis-----
VarCorr(
  update(
    asclepiadis_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    asclepiadis_mods_best_c[[1]], REML = T) %>%
    sigma()


lascelp_mean <- herbivores %>%
  dplyr::summarize(Mean = mean(Liriomyza_asclepiadis ,
                               na.rm = T)) %>%
  as.numeric()

qg_lasclep <- calc_quantgenvars(0.31796 ,
            0.14935 ,
            resid_var,
            lascelp_mean,
            "L. asclepiadis abundance")


# L. clivicollis-----
VarCorr(
  update(
    clivicollis_mods_best_c[[1]], REML = T))

# residual variance:
resid_var <- update(
    clivicollis_mods_best_c[[1]], REML = T) %>%
    sigma()


clivicoll_mean <- herbivores %>% 
  dplyr::filter(Labidomera_clivicollis < 9) %>% # as in model
  dplyr::summarize(Mean = mean(Labidomera_clivicollis  ,
                               na.rm = T)) %>%
  as.numeric()

qg_clivicoll <- calc_quantgenvars(0.00011488,
            0.30719353,
            resid_var,
            clivicoll_mean,
            "L. clivicollis abundance")
```

### Growth
```{r}
# LDMC-----
update(
    ldmc_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ldmc_mean <- sla_ldmc %>%
  dplyr::filter(LDMC < 1) %>% # as done in model
  dplyr::summarize(Mean = mean(LDMC,
                               na.rm = T)) %>%
  as.numeric()

qg_ldmc <- calc_quantgenvars( 9.4956e-06,
                   2.2071e-05,
                   0.387388,
                   5.8581e-02,
                   "LDMC")


# SLA-----
update(
    sla_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

sla_mean <- sla_ldmc %>%
  dplyr::summarize(Mean = mean(SLA,
                               na.rm = T)) %>%
  as.numeric()

qg_sla <- calc_quantgenvars(4.5386e-06,
                   9.5195e-06,
                    4.0241e-01,
                   sla_mean,
                   "SLA")


# heights, early-----

update(
    heights_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_early,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_e <- calc_quantgenvars(0.36591,
                                  0.15034 ,
                                  1.12547 ,
                   heights_e_mean,
                   "Height before flowering")


# heights, late-----

update(
    heights_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_late,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_l <- calc_quantgenvars(0.49420 ,
                                  0.22338  ,
                                  1.56537  ,
                   heights_l_mean,
                   "Height after flowering")

# RGR-----
update(
    rgr_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

rgr_mean <- heights %>%
  dplyr::summarize(Mean = mean(rel_growth_rate,
                               na.rm = T)) %>%
  as.numeric()
 
qg_rgr <- calc_quantgenvars( 3.8967e-06 ,
                             2.6174e-03 ,
                            5.5405e-02,
                   rgr_mean,
                   "Relative growth rate")

# Ramets, early-----
update(
    ramets_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_early,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_early_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_e <- calc_quantgenvars( 0.247111,
                             0.080902,
                            resid_var,
                   ramets_e_mean,
                   "Ramets before flowering")

# Ramets, late-----
update(
    ramets_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_late,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_late_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_l <- calc_quantgenvars( 0.187996,
                             0.052465,
                            resid_var,
                   ramets_l_mean,
                   "Ramets after flowering")


# Survival-----
update(
    mortality_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

surv_mean <- survival %>%
  as.data.frame %>%
  dplyr::summarize(Mean = mean(as.numeric(Dead),
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     mortality_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_survival <- calc_quantgenvars(6.6969e-08,
                   1.3094e-05,
                   resid_var ,
                   surv_mean,
                   "Mortality")
```

### Combine values into one table and export
```{r}
list(

  # Defense
  qg_latex,
  qg_herb_e_bin,
  qg_herb_e_quant,
  qg_herb_l_bin,
  qg_herb_l_quant,
  qg_weev_bin,
  qg_weev_quant,
    
  # Reproduction
  qg_flsucc,
  qg_flowers,
  qg_flsize,
  qg_fltime,
  qg_flstart,
  qg_pods,
  qg_first_pods,
  qg_peduncles,
  
  # Herbivores
  qg_monarch,
  qg_lasclep,
  qg_clivicoll,
  
  # Growth
  qg_ldmc,
  qg_sla,
  qg_heights_e,
  qg_heights_l,
  qg_rgr,
  qg_ramets_e,
  qg_ramets_l,
  qg_survival
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  dplyr::rename(Variable = 1) %>%
  flextable() %>%
  flextable::compose(part = "header", i = 1, j = 2,
         value = as_paragraph("h",
                              as_sup("2"))) %>%
  flextable::compose(part = "header", i = 1, j = 3,
         value = as_paragraph("Q",
                              as_sub("ST"))) %>%
  flextable::compose(part = "header", i = 1, j = 4,
         value = as_paragraph("CV",
                              as_sub("A"))) %>%
  theme_box() %>%
  flextable::align(j = 2:4, align = "center", part = "all") %>%
  autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/Quant_gen/Quant_gen_multi_yr_mods.docx"))

```

## 1-year models
I have to add in data because 1yr mods imported save formula without actual df names and filtered year, like this: 
data = mod_allyrs_df %>% dplyr::filter(Year == last_year)
### Defense
```{r}
# Latex-----
# same as multi-yr mods

# Herbivory, before flowering: Binomial-----

update(
    def.m2, 
    .~. -City_dist, # omitting city_dist
    data = herbivory %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    def.m2,
    data = herbivory %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()

herb_e_bin_mean <- herbivory %>%
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_e_bin <- calc_quantgenvars(0.10383492,
                   0.00025825,
                   resid_var,
                   herb_e_bin_mean,
                   "Herbivory before flowering (binary)")


# Herbivory, before flowering: quantitative-----

update(
    def.m3,
    .~. -City_dist, # omitting city_dist
    data = herbivory %>%
      dplyr::filter(Year == "2021" &
                      Herbivory_mean_early_binary == 1),
    REML = T) %>% VarCorr()

herb_e_quant_mean <- herbivory %>%
  dplyr::filter(Year == "2021" & Herbivory_mean_early_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_early,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_e_quant <- calc_quantgenvars(3.3249e-09,
                   2.5094e-04,
                   1.3468e+00 ,
                   herb_e_quant_mean,
                   "Herbivory before flowering (quantitative)")

# Herbivory, after flowering: Binomial-----

update(
    def.m4, 
    .~. -City_dist, # omitting city_dist
    data = herbivory %>% dplyr::filter(Year == "2021"),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    def.m4,
    data = herbivory %>% dplyr::filter(Year == "2021"),
    REML = T) %>%
    sigma()

herb_l_bin_mean <- herbivory %>%
  dplyr::filter(Year == "2021") %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late_binary,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_l_bin <- calc_quantgenvars(
                   0.64569141,
                   0.00011296,
                   resid_var,
                   herb_l_bin_mean,
                   "Herbivory after flowering (binary)")


# Herbivory, after flowering: quantitative-----

update(
    def.m5,
    .~. -City_dist, # omitting city_dist
    data = herbivory %>%
      dplyr::filter(Year == "2021" &
                      Herbivory_mean_late_binary == 1),
    REML = T) %>% VarCorr()

herb_l_quant_mean <- herbivory %>% 
  dplyr::filter(Year == "2021" & Herbivory_mean_late_binary == 1) %>%
  dplyr::summarize(Mean = mean(Herbivory_mean_late,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_herb_l_quant <- calc_quantgenvars(1.7105e-01 ,
                  6.8415e-05,
                  1.1502e+00,
                   herb_l_quant_mean,
                   "Herbivory after flowering (quantitative)")


# Weevil: Binomial-----

update(
    def.m6, 
    .~. -City_dist, # omitting city_dist
    data = weevil %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    def.m6, 
    data = weevil %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()

weev_bin_mean <- weevil %>%
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Scar_binary ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_weev_bin <- calc_quantgenvars(0.5139583  ,
                   0.0001328,
                   resid_var,
                   weev_bin_mean,
                   "Weevil damage (binary)")


# Weevil damage: quantitative-----

update(
    def.m7, 
    .~. -City_dist, # omitting city_dist
    data = weevil %>% dplyr::filter(Year == "2021" &
                                   Scar_length_cm > 0),
    REML = T) %>% VarCorr()

weev_quant_mean <- weevil %>%
  dplyr::filter(Year == "2021" & Scar_length_cm > 0) %>%
  dplyr::summarize(Mean = mean(Scar_length_cm,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_weev_quant <- calc_quantgenvars( 0.20666  ,
                  0.15005,
                  1.00045,
                   weev_quant_mean,
                   "Weevil damage (quantitative)")

```

### Reproduction
```{r}
# Flowering success-----
update(
    repr.m1,
    .~. -City_dist, # omitting city_dist
    data = reproduc %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
    repr.m1,
    data = reproduc %>% dplyr::filter(Year == 2022),
    REML = T) %>% sigma()

flsucc_mean <- reproduc %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Flowered ,
                               na.rm = T)) %>%
  as.numeric() # can't calculate this because it's 0s x 1s... will be 0

qg_1yr_flsucc <- calc_quantgenvars(
                   0.25975  ,
                   0.51146  ,
                   resid_var,
                   NA,
                   "Flowering success")


# Mean flowers/inflor -----
update(
    repr.m2,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

flowers_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(mean_flower_count ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    repr.m2,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_flowers <- calc_quantgenvars(
                   5.1344e-05,
                   1.3615e-01,
                   resid_var,
                   flowers_mean,
                   "Flowers per Inflorescence")


# Mean flower size/inflorescence -----
update(
    repr.m3,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

flsize_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Overall_mean ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_flsize <- calc_quantgenvars( 1.0523    ,
                   1.3941    ,
                   4.8971    ,
                   flsize_mean,
                   "Flower size")


# Flowering time -----
update(
    repr.m4,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

fltime_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(flowering_time_num ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m4,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_fltime <- calc_quantgenvars(
                   2.1588e-05,
                   4.8254e-05,
                   resid_var,
                   fltime_mean,
                   "Flowering duration")


# Flowering start -----
update(
    repr.m5,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

flstart_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Julian_oldest_inflor ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m5, 
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_flstart <- calc_quantgenvars(1.4040e-01,
                   2.5568e-05,
                   resid_var,
                   flstart_mean,
                   "Date of first flower")


# Pods -----
update(
    repr.m6,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

pods_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Pods,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m6,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_pods <- calc_quantgenvars(5.1750e-05,
                   6.5619e-05 ,
                   resid_var,
                   pods_mean,
                   "Follicles")


# Date of first mature pod -----
update(
    repr.m7,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

first_pods_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Julian_first_follicle,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m7,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_first_pods <- calc_quantgenvars( 0.01910748,
                   0.00002707,
                   resid_var,
                   first_pods_mean,
                   "Date of first follicle")


# Peduncles -----
update(
    repr.m8,
    .~. -City_dist, # omitting city_dist
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

peduncles_mean <- flowering %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(Peduncles,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
    repr.m8,
    data = flowering %>% dplyr::filter(Year == 2022),
    REML = T) %>%
    sigma()

qg_1yr_peduncles <- calc_quantgenvars(6.5948e-05,
                   2.2317e-01 ,
                   resid_var,
                   peduncles_mean,
                   "Inflorescences")


```

### Herbivores
```{r}
# Monarchs-----
VarCorr(
  update(
    herb.m1, 
     .~. -City_dist, # omitting city_dist
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T))

# residual variance:
resid_var <- update(
    herb.m1,
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()

monarch_mean <- herbivores %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Monarch_Quantity_Observed,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_monarch <- calc_quantgenvars(0.17212 ,
                                0.16350 ,
                                resid_var,
                                monarch_mean,
                                "D. plexippus abundance")


# L. asclepiadis-----
VarCorr(
  update(
    herb.m2, 
     .~. -City_dist, # omitting city_dist
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T))

# residual variance:
resid_var <- update(
    herb.m2,
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()


lascelp_mean <- herbivores %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Liriomyza_asclepiadis ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_lasclep <- calc_quantgenvars(0.31791  ,
            0.18936  ,
            resid_var,
            lascelp_mean,
            "L. asclepiadis abundance")


# L. clivicollis-----
VarCorr(
  update(
    herb.m3, 
     .~. -City_dist, # omitting city_dist
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T))

# residual variance:
resid_var <- update(
    herb.m3,
    data = herbivores %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()


clivicoll_mean <- herbivores %>% 
  dplyr::filter(Year == 2021 & Labidomera_clivicollis < 9) %>%
  dplyr::summarize(Mean = mean(Labidomera_clivicollis  ,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_clivicoll <- calc_quantgenvars(9.7757e-05,
            4.1090e-01,
            resid_var,
            clivicoll_mean,
            "L. clivicollis abundance")
```


### Growth
```{r}
# LDMC-----
# same as multi-yr mods (only 1 year)


# SLA-----
# same as multi-yr mods (only 1 year)

# heights, early-----

update(
    grow.m3, 
    .~. -City_dist, # omitting city_dist
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

heights_e_mean <- heights %>%
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Total_Height_early,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_heights_e <- calc_quantgenvars(0.51437 ,
                                  0.18437  ,
                                  1.60275  ,
                   heights_e_mean,
                   "Height before flowering")


# heights, late-----

update(
    grow.m4, 
    .~. -City_dist, # omitting city_dist
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

heights_l_mean <- heights %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Total_Height_late,
                               na.rm = T)) %>%
  as.numeric()

qg_1yr_heights_l <- calc_quantgenvars(0.55987  ,
                                  0.26137   ,
                                  2.08706   ,
                   heights_l_mean,
                   "Height after flowering")

# RGR-----
update(
   grow.m5, 
    .~. -City_dist, # omitting city_dist
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

rgr_mean <- heights %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(rel_growth_rate,
                               na.rm = T)) %>%
  as.numeric()
 
qg_1yr_rgr <- calc_quantgenvars(6.2247e-03,
                             4.4362e-06 ,
                            6.0391e-02,
                   rgr_mean,
                   "Relative growth rate")

# Ramets, early-----
update(
    grow.m6, 
    .~. -City_dist, # omitting city_dist
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>% VarCorr()

ramets_e_mean <- heights %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Ramets_early,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    grow.m6,
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()
 
qg_1yr_ramets_e <- calc_quantgenvars( 0.296370,
                             0.055885,
                            resid_var,
                   ramets_e_mean,
                   "Ramets before flowering")

# Ramets, late-----
update(
  grow.m7,
  .~. -City_dist, # omitting city_dist
  data = heights %>% dplyr::filter(Year == 2021),
  REML = T) %>% VarCorr()

ramets_l_mean <- heights %>% 
  dplyr::filter(Year == 2021) %>%
  dplyr::summarize(Mean = mean(Ramets_late,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    grow.m7,
    data = heights %>% dplyr::filter(Year == 2021),
    REML = T) %>%
    sigma()
 
qg_1yr_ramets_l <- calc_quantgenvars( 0.272657,
                             0.072276,
                            resid_var,
                   ramets_l_mean,
                   "Ramets after flowering")


# Survival-----
update(
    grow.m8, 
    .~. -City_dist, # omitting city_dist
    data = survival %>% dplyr::filter(Year == 2022),
    REML = T) %>% VarCorr()

surv_mean <- survival %>%
  dplyr::filter(Year == 2022) %>%
  dplyr::summarize(Mean = mean(as.numeric(Dead),
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     grow.m8,
     data = survival %>% dplyr::filter(Year == 2022),
     REML = T) %>%
    sigma()

qg_1yr_survival <- calc_quantgenvars(0.32267 ,
                   0.25963,
                   resid_var ,
                   surv_mean,
                   "Mortality")
```

### Combine values into one table and export
```{r}
list(
  
  # Defense
  qg_latex, # same as multi-yr mods (only 1 year)
  qg_1yr_herb_e_bin,
  qg_1yr_herb_e_quant,
  qg_1yr_herb_l_bin,
  qg_1yr_herb_l_quant,
  qg_1yr_weev_bin,
  qg_1yr_weev_quant,
  
  # Reproduction
  qg_1yr_flsucc,
  qg_1yr_flowers,
  qg_1yr_flsize,
  qg_1yr_fltime,
  qg_1yr_flstart,
  qg_1yr_pods,
  qg_1yr_first_pods,
  qg_1yr_peduncles,
  
  # Herbivores
  qg_1yr_monarch, 
  qg_1yr_lasclep, 
  qg_1yr_clivicoll,
  
  # Growth
  qg_ldmc, # same as multi-yr mods (only 1 year)
  qg_sla, # same as multi-yr mods (only 1 year)
  qg_1yr_heights_e,
  qg_1yr_heights_l,
  qg_1yr_rgr,
  qg_1yr_ramets_e,
  qg_1yr_ramets_l,
  qg_1yr_survival
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  dplyr::rename(Variable = 1) %>%
  flextable() %>%
  flextable::compose(part = "header", i = 1, j = 2,
         value = as_paragraph("h",
                              as_sup("2"))) %>%
  flextable::compose(part = "header", i = 1, j = 3,
         value = as_paragraph("Q",
                              as_sub("ST"))) %>%
  flextable::compose(part = "header", i = 1, j = 4,
         value = as_paragraph("CV",
                              as_sub("A"))) %>%
  theme_box() %>%
  flextable::align(j = 2:4, align = "center", part = "all") %>%
  autofit() %>%
  save_as_docx(path = here::here("./Figures_Tables/Quant_gen/Quant_gen_1yrmods.docx"))

```


# Calculate R-squared values
## Multi-year models
### Reproduction
```{r}

# change REML to T
flsucc_mods_reml_T     <- reml_to_true(flsucc_mods     ) 
flowers_mods_reml_T    <- reml_to_true(flowers_mods     ) 
flsize_mods_reml_T     <- reml_to_true(flsize_mods      ) 
fltime_mods_reml_T     <- reml_to_true(fltime_mods      ) 
flstart_mods_reml_T    <- reml_to_true(flstart_mods     ) 
pods_mods_reml_T       <- reml_to_true(pods_mods       ) 
first_pods_mods_reml_T <- reml_to_true(first_pods_mods  ) 
peduncles_mods_reml_T  <- reml_to_true(peduncles_mods   ) 


all_models_reml_T <- list(
flsucc_mods_reml_T      , 
flowers_mods_reml_T     , 
flsize_mods_reml_T      , 
fltime_mods_reml_T      , 
flstart_mods_reml_T     , 
pods_mods_reml_T        , 
first_pods_mods_reml_T  , 
peduncles_mods_reml_T   ) 

names(all_models_reml_T) <- c(
"flsucc_mods"          ,
"flowers_mods"         ,
"flsize_mods"          ,
"fltime_mods",
"flstart_mods",
"pods_mods"            ,
"first_pods_mods",
"peduncles_mods")


# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

sink(here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Reproduction/Rsquared.txt"))
print(all_rsq)
sink()


# export as nice tables in word doc
flsucc_r2      <- make_r2_table( flsucc_mods_reml_T    ) 
flowers_r2       <- make_r2_table(flowers_mods_reml_T      )
flsize_r2 <- make_r2_table(flsize_mods_reml_T) 
flstart_r2  <- make_r2_table(flstart_mods_reml_T )


## these models don't have an alternative model for urb score/ urbsubs and will use this table format
make_r2_table_modif1 <- function(mods_reml_T){
  
  return(
    lapply(mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      data.table::as.data.table() %>%
      data.table::melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m", "City_urbsubs_alt.R2m",
                              "Usc_urbsubs_best.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c", "City_urbsubs_alt.R2c",
                              "Usc_urbsubs_best.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m", "Distance_Q2_alt.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c", "Distance_Q2_alt.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,
                    Distance_Q2_alt.R2m,
                    Distance_Q2_alt.R2c,
                    
                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,4,2,2))%>%
      add_header_row(
        values = c("",
                   "Best Models", "Alternative Models",
                   "Best Models"),
        colwidths = c(1,4,2,4)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,6,4)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")
  )
}

fltime_r2 <- make_r2_table_modif1(fltime_mods_reml_T)
pods_r2  <- make_r2_table_modif1(pods_mods_reml_T)
first_pods_r2  <- make_r2_table_modif1(first_pods_mods_reml_T )
peduncles_r2  <- make_r2_table_modif1(peduncles_mods_reml_T )


# will do this in 3 docs b/c function accepts 3 tables at a time (something to try tweaking in the future)
# table 1
export_r2(flsucc_r2,
flowers_r2,
flsize_r2,
          "Flowering success",
          "Flowers per inflorescence", 
          "Flower size",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Reproduction/R2_Reproduction1.docx")

# table 2
export_r2(
fltime_r2,
flstart_r2      ,
pods_r2 ,
          "Flowering time",
          "Date of first flower", 
          "Follicles",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Reproduction/R2_Reproduction2.docx")

# table 3: will just use code from function
  word_export <- read_docx()
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Date of first follicle", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, first_pods_r2)
  
  body_add_break(word_export)

  body_add_par(word_export, value = paste("R-squared estimates for",  "Inflorescences", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, peduncles_r2)
  
  word_export <- body_end_section_landscape(word_export)
  print(word_export, here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Reproduction/R2_Reproduction3.docx"))
```

### Defense
### lmers
```{r}
# change REML to T for lmers
latex_mods_reml_T          <- reml_to_true(latex_mods)
herb_e_bin_mods_reml_T       <- reml_to_true(herb_early_mods_binomial)
herb_e_quant_mods_reml_T   <- reml_to_true(herb_early_mods_quant)
herb_l_bin_mods_reml_T     <- reml_to_true(herb_late_mods_binomial)
herb_l_quant_mods_reml_T       <- reml_to_true(herb_late_mods_quant)
weevil_bin_mods_reml_T       <- reml_to_true(weev_mods_binomial)
weevil_quant_mods_reml_T  <- reml_to_true(weev_mods_quant)

all_models_reml_T <- list(
latex_mods_reml_T      ,
herb_e_bin_mods_reml_T       ,
herb_e_quant_mods_reml_T ,
herb_l_bin_mods_reml_T ,
herb_l_quant_mods_reml_T       ,
weevil_bin_mods_reml_T  ,
weevil_quant_mods_reml_T   )

names(all_models_reml_T) <- c(
"latex_mods"         ,
"herb_early_mods_binomial"    ,
"herb_early_mods_quant"    ,
"herb_late_mods_binomial"     ,
"herb_late_mods_quant"     ,
"weev_mods_binomial" ,
"weev_mods_quant")

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Defense/Rsquare.csv"))


# export as nice tables in word doc
# these first two throw errors because there's no alt model for urb subs, so I'll manually edit function to suit them
# latex_r2      <- make_r2_table( latex_mods_reml_T    ) 
# herb_e_bin_r2       <- make_r2_table(herb_e_bin_mods_reml_T      ) 

latex_r2 <- lapply(latex_mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      as.data.table() %>%
      melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m", "City_urbsubs_alt.R2m",
                              "Usc_urbsubs.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c", "City_urbsubs_alt.R2c",
                              "Usc_urbsubs.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m", "Distance_Q2_alt.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c", "Distance_Q2_alt.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,
                    Distance_Q2_alt.R2m,
                    Distance_Q2_alt.R2c,
                    
                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,4,2,2))%>%
      add_header_row(
        values = c("",
                   "Best Models", "Alternative Models",
                   "Best Models"),
        colwidths = c(1,4,2,4)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,6,4)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")


herb_e_bin_r2 <- lapply(herb_e_bin_mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      as.data.table() %>%
        melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m",
                              "Usc_urbsubs_best.R2m",  "Usc_urbsubs_alt.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c",
                              "Usc_urbsubs_best.R2c",  "Usc_urbsubs_alt.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m",
                          "UrbScore_Q2_best.R2m", "UrbScore_Q2_alt.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c",
                          "UrbScore_Q2_best.R2c", "UrbScore_Q2_alt.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,
                    
                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c,
                    UrbScore_Q2_alt.R2m,
                    UrbScore_Q2_alt.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,2,2,4)) %>%
      add_header_row(
        values = c("",
                   "Best Models", 
                   "Best Models", "Alternative Models"),
        colwidths = c(1,4,4,2)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,4,6)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")
  

herb_e_quant_r2 <- make_r2_table(herb_e_quant_mods_reml_T) 
herb_l_bin_r2 <- make_r2_table( herb_l_bin_mods_reml_T) 
herb_l_quant_r2       <- make_r2_table(herb_l_quant_mods_reml_T      ) 
weevil_bin_r2  <- make_r2_table(weevil_bin_mods_reml_T) 
weevil_quant_r2  <- make_r2_table( weevil_quant_mods_reml_T ) 

# will do this in 3 docs b/c function accepts 3 tables at a time (something to try tweaking in the future)
# table 1
export_r2(latex_r2    , 
herb_e_bin_r2      ,
herb_e_quant_r2,
          "Latex",
          "Herbivory before flowering (binary)", 
          "Herbivory before flowering (quantitative)",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_Defense1.docx")

# table 2
export_r2(
herb_l_bin_r2,
herb_l_quant_r2      ,
weevil_bin_r2 ,
          "Herbivory after flowering (binary)",
          "Herbivory after flowering (quantitative)", 
          "Weevil damage (binary)",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_Defense2.docx")

# table 3: will just use code from function
  word_export <- read_docx()
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Weevil damage (quantitative)", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, weevil_quant_r2)
  
  word_export <- body_end_section_landscape(word_export)
  print(word_export, here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_Defense3.docx"))
```

### lms (cardenolides)
```{r}
make_card_rsq_table <- function(card_model){
  
  return(
    card_model %>%
  broom::glance() %>%
  dplyr::select(r.squared:adj.r.squared) %>%
  as.data.frame() %>%
  dplyr::mutate(Variable = toString(card_model$terms[[2]]),
         Urbanization = toString(card_model$terms[[3]]),
         r.squared = round(r.squared, 3),
         adj.r.squared = round(adj.r.squared, 3)) %>%
  dplyr::rename(R2 = 1, 
                R2.adj = 2) %>%
  dplyr::select(Variable, Urbanization, R2, R2.adj) %>%
  
  dplyr::mutate(Variable = case_when(
    str_detect(Variable, "total")~
      "Total Cardenolides",
    str_detect(Variable, "6.6") ~
      "Peak 6.6",
    str_detect(Variable, "15") ~
      "Peak 15",
    str_detect(Variable, "17.6") ~
      "Peak 17.6")) %>%
  
  dplyr::mutate(Urbanization = case_when(
    str_detect(Urbanization, "City_dist")~
      "Distance to City Center",
    str_detect(Urbanization, "Urb_score")~
      "Urbanization Score"))
  )
}

lapply(flatten(all_card_models), make_card_rsq_table) %>%
  reduce(full_join, all = T) %>%
  flextable() %>%
  autofit() %>%
  theme_box() %>%
  merge_v(j = ~Variable) %>% 
  align(j = 3:4, align = "center", part = "all") %>%
  hline(j = ~Variable, border = NULL, part = "body") %>%
  flextable::compose(i = 1, j = 3, part = "header",
                     value = as_paragraph("R", as_sup("2"))) %>%  flextable::compose(i = 1, j = 4, part = "header",
                     value = as_paragraph("R", as_sup("2"), as_sub("adj"))) %>%
  padding(padding = 3) %>%
    flextable::save_as_docx(.,
                          path = here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_cardenolides.docx"))
```


### Herbivores
```{r}
# change REML to T
monarch_mods_reml_T <- reml_to_true(monarch_mods)
asclepiadis_mods_reml_T <- reml_to_true(asclepiadis_mods)
clivicollis_mods_reml_T <- reml_to_true(clivicollis_mods)

all_models_reml_T <- list(
monarch_mods_reml_T          , 
asclepiadis_mods_reml_T           , 
clivicollis_mods_reml_T)

names(all_models_reml_T) <- c(
"monarch_mods"          ,
"asclepiadis_mods"           ,
"clivicollis_mods"         )

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Defense/Rsquare_herbivores.csv"))


# export as nice tables in word doc
mon_r2 <- make_r2_table(monarch_mods_reml_T)
ascl_r2 <- make_r2_table(asclepiadis_mods_reml_T)
clivi_r2 <- make_r2_table(clivicollis_mods_reml_T)

export_r2(mon_r2, ascl_r2, clivi_r2, 
          "Danaus plexippus",
          "Liriomyza asclepiadis", 
          "Labidomera clivicollis",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Defense/R2_herbivores.docx")
```


### Growth
```{r}
# change REML to T
ldmc_mods_reml_T      <- reml_to_true(ldmc_mods)
sla_mods_reml_T       <- reml_to_true(sla_mods)
heights_e_mods_reml_T <- reml_to_true(heights_early_mods)
heights_l_mods_reml_T <- reml_to_true(heights_late_mods)
rgr_mods_reml_T       <- reml_to_true(rgr_mods)
ramets_e_mods_reml_T  <- reml_to_true(ramets_early_mods)
ramets_l_mods_reml_T  <- reml_to_true(ramets_late_mods)
mortality_mods_reml_T <- reml_to_true(mortality_mods)

all_models_reml_T <- list(
ldmc_mods_reml_T      ,
sla_mods_reml_T       ,
heights_e_mods_reml_T ,
heights_l_mods_reml_T ,
rgr_mods_reml_T       ,
ramets_e_mods_reml_T  ,
ramets_l_mods_reml_T  ,
mortality_mods_reml_T )

names(all_models_reml_T) <- c(
"ldmc_mods"      ,
"sla_mods"       ,
"heights_e_mods" ,
"heights_l_mods" ,
"rgr_mods"       ,
"ramets_e_mods"  ,
"ramets_l_mods"  ,
"mortality_mods" )

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Growth/Rsquare.csv"))



# export as nice tables in word doc
ldmc_r2      <- make_r2_table( ldmc_mods_reml_T    ) 
sla_r2       <- make_r2_table(sla_mods_reml_T      ) 
heights_e_r2 <- make_r2_table(heights_e_mods_reml_T) 
heights_l_r2 <- make_r2_table( heights_l_mods_reml_T) 
rgr_r2       <- make_r2_table(rgr_mods_reml_T      ) 
ramets_e_r2  <- make_r2_table(ramets_e_mods_reml_T) 
ramets_l_r2  <- make_r2_table( ramets_l_mods_reml_T ) 
morality_r2  <- make_r2_table( mortality_mods_reml_T) 

# will do this in 3 docs b/c function accepts 3 tables at a time (something to try tweaking in the future)
# table 1
export_r2(ldmc_r2    , 
sla_r2      ,
heights_e_r2,
          "LDMC",
          "SLA", 
          "Height before flowering",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Growth/R2_growth1.docx")
# table 2
export_r2(
heights_l_r2,
rgr_r2      ,
ramets_e_r2 ,
          "Height after flowering",
          "Relative growth rate", 
          "Ramets before flowering",
          "./Figures_Tables/Rsquared/Multi_yr_mods/Growth/R2_growth2.docx")

# table 3: will just use code from function
  word_export <- read_docx()
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Ramets, after flowering", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, ramets_l_r2)
  
  body_add_break(word_export)
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Mortality", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, morality_r2)
  
  word_export <- body_end_section_landscape(word_export)
  print(word_export, here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Growth/R2_growth3.docx"))
```

### Export all Rsq tables into one docx
```{r}

make_full_R2_table <- function(list1, list2, list3,
                               list4, list5, list6,
                               list7, list8, list9,
                               list10, list11, list12,
                               list13, list14, list15,
                               list16, list17, list18,
                               list19 , list20, list21,
                               list22, list23, list24,
                               list25 , list26
                               ){
      
  make_1_table <- function(list1){
    
      lapply(list1, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      dplyr::select(-contains("alt")) %>%
      dplyr::rename("Type" = 1) %>%
      dplyr::filter(row_number()==n()) %>%
      data.table::as.data.table() %>%
      data.table::melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m",
                              "Usc_urbsubs_best.R2m", 
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c",
                              "Usc_urbsubs_best.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(Type,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,

                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c)
    }

  full_table <- lapply(list(list1, list2, list3,
                               list4, list5, list6,
                               list7, list8, list9,
                               list10, list11, list12,
                               list13, list14, list15,
                               list16, list17, list18,
                               list19 , list20, list21,
                               list22, list23, list24,
                                list25 , list26),
                       make_1_table) %>%
    reduce(full_join, all = T) %>%
      dplyr::mutate(Variable = c(list1[[1]]$call[[2]][[2]],
                                 list2[[1]]$call[[2]][[2]],
                                 list3[[1]]$call[[2]][[2]],
                                 list4[[1]]$call[[2]][[2]],
                                 list5[[1]]$call[[2]][[2]],
                                 list6[[1]]$call[[2]][[2]],
                                 list7[[1]]$call[[2]][[2]],
                                 list8[[1]]$call[[2]][[2]],
                                 list9[[1]]$call[[2]][[2]],
                                 list10[[1]]$call[[2]][[2]],
                                 list11[[1]]$call[[2]][[2]],
                                 list12[[1]]$call[[2]][[2]],
                                 list13[[1]]$call[[2]][[2]],
                                 list14[[1]]$call[[2]][[2]],
                                 list15[[1]]$call[[2]][[2]],
                                 list16[[1]]$call[[2]][[2]],
                                 list17[[1]]$call[[2]][[2]],
                                 list18[[1]]$call[[2]][[2]],
                                 list19[[1]]$call[[2]][[2]] ,
                                 list20[[1]]$call[[2]][[2]],
                                 list21[[1]]$call[[2]][[2]],
                                 list22[[1]]$call[[2]][[2]],
                                 list23[[1]]$call[[2]][[2]],
                                 list24[[1]]$call[[2]][[2]],
                                 list25[[1]]$call[[2]][[2]],
                                 list26[[1]]$call[[2]][[2]]
                                 )) %>%
      dplyr::relocate(Variable) %>%
  dplyr::mutate(Variable = case_when(
    
    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",
    
    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "Julian_first")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",
    
    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",
    
    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "Total_Height_early")~
      "Height before flowering",
    str_detect(Variable, "Total_Height_late")~
      "Height after flowering",
    str_detect(Variable, "rel_gr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"
    
    
    )) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4"),
        colwidths = c(2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(2,2,2,2,2))%>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(2,4,4)) %>%
      theme_box() %>%
      align(j = c(2:10), align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9), i = 4,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(4,6,8,10), i = 4,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit()
    
  return(full_table) 
  
}



make_full_R2_table(
  # defense
                   latex_mods_reml_T        ,
                  herb_e_bin_mods_reml_T   ,
                  herb_e_quant_mods_reml_T ,
                  herb_l_bin_mods_reml_T   ,
                  herb_l_quant_mods_reml_T ,
                  weevil_bin_mods_reml_T   ,
                  weevil_quant_mods_reml_T ,
  # reproductive traits
                   flsucc_mods_reml_T   ,  
                   flowers_mods_reml_T    ,
                   flsize_mods_reml_T     ,
                   fltime_mods_reml_T     ,
                   flstart_mods_reml_T    ,
                   pods_mods_reml_T       ,
                   first_pods_mods_reml_T ,
                   peduncles_mods_reml_T ,
                   
  # herbivores
                   monarch_mods_reml_T,
                   asclepiadis_mods_reml_T,
                   clivicollis_mods_reml_T,
  # growth traits
                   ldmc_mods_reml_T     ,
                   sla_mods_reml_T      ,
                   heights_e_mods_reml_T,
                   heights_l_mods_reml_T,
                   rgr_mods_reml_T      ,
                   ramets_e_mods_reml_T ,
                   ramets_l_mods_reml_T ,
                   mortality_mods_reml_T) %T>%
  save_as_docx(path = here::here("./Figures_Tables/Rsquared/Multi_yr_mods/Rsquared_all.docx"),
              pr_section = prop_section(
                page_size = page_size(
                  orient = "landscape",
                  width = 16, height = 15),
                type = "continuous",
                page_margins = page_mar()))
```


## 1-year models
Not doing for cardenolides because same as multi-year mods

Excluding alternative models because my workflow to create 1yr models involved taking best models only
### Create function that makes REML = T one-year models
```{r}
# this function is too general because the lapply to export all rsquared values see that the data = mod_allyrs_df... need to be specific with each model regarding the year and df
make_1yrmod_REML <- function(orig_mod,
                             last_year,
                             mod_allyrs_df){
  return(
    update(orig_mod,
           .~. - Year,
           data = mod_allyrs_df %>%
             dplyr::filter(Year == last_year),
           REML = T
           )
    )
    
}


#### Reproduction ########
##########################

# DF = reproduc, Year = 2022
make_1yrmod_REML_repr1 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = reproduc %>%
             dplyr::filter(Year == "2022"),
           REML = T
           )
    )
    
}

# DF = flowering, Year = 2022
make_1yrmod_REML_repr2 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = flowering %>%
             dplyr::filter(Year == "2022"),
           REML = T
           )
    )
    
}



#### Defense ########
#####################

# DF = herbivory, Year = 2021
make_1yrmod_REML_def1 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = herbivory %>%
             dplyr::filter(Year == "2021"),
           REML = T
           )
    )
    
}

# DF = herbivory, Year = 2021, herb early binary
make_1yrmod_REML_def2 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = herbivory %>%
             dplyr::filter(Year == "2021" &
                                   Herbivory_mean_early_binary == 1),
           REML = T
           )
    )
    
}

# DF = herbivory, Year = 2021, herb late binary
make_1yrmod_REML_def3 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = herbivory %>%
             dplyr::filter(Year == "2021"&
                                   Herbivory_mean_late_binary == 1),
           REML = T
           )
    )
    
}

# DF = weevil, Year = 2021
make_1yrmod_REML_def4 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = weevil %>%
             dplyr::filter(Year == "2021"),
           REML = T
           )
    )
    
}

# DF = weevil, Year = 2021, binary
make_1yrmod_REML_def5 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = weevil %>%
             dplyr::filter(Year == "2021" &
                                   Scar_length_cm > 0),
           REML = T
           )
    )
    
}
#### Herbivores ########
########################

# DF = herbivory, Year = 2021
make_1yrmod_REML_herb1 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = herbivores %>%
             dplyr::filter(Year == "2021"),
           REML = T
           )
  )
}
  
# DF = herbivory, Year = 2021, filtered for clivicollis >9
make_1yrmod_REML_herb2 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = herbivores %>%
             dplyr::filter(Year == "2021" &
                             Labidomera_clivicollis < 9),
           REML = T
           )
    )
    
}
##### Growth ########
#####################

# DF = heights, Year = 2021
make_1yrmod_REML_grow1 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = heights %>%
             dplyr::filter(Year == "2021"),
           REML = T
           )
    )
    
}

# DF = survival, Year = 2022
make_1yrmod_REML_grow2 <- function(orig_mod){
  return(
    update(orig_mod,
           .~. - Year,
           data = survival %>%
             dplyr::filter(Year == "2022"),
           REML = T
           )
    )
    
}


```

### Reproduction
```{r}

# change REML to T
flsucc_mods_reml_T <- lapply(
  list(repr.m1, repr.m1_u, repr.tr.m1, repr.tr.m1_u),
  make_1yrmod_REML_repr1)

flowers_mods_reml_T    <- lapply(
  list(repr.m2, repr.m2_u, repr.tr.m2, repr.tr.m2_u),
  make_1yrmod_REML_repr2)

flsize_mods_reml_T     <- lapply(
  list(repr.m3, repr.m3_u, repr.tr.m3, repr.tr.m3_u),
  make_1yrmod_REML_repr2)

fltime_mods_reml_T     <- lapply(
  list(repr.m4, repr.m4_u, repr.tr.m4, repr.tr.m4_u),
  make_1yrmod_REML_repr2)

flstart_mods_reml_T    <- lapply(
  list(repr.m5, repr.m5_u, repr.tr.m5, repr.tr.m5_u),
  make_1yrmod_REML_repr2)

pods_mods_reml_T       <- lapply(
  list(repr.m6, repr.m6_u, repr.tr.m6, repr.tr.m6_u),
  make_1yrmod_REML_repr2)

first_pods_mods_reml_T <- lapply(
  list(repr.m7, repr.m7_u, repr.tr.m7, repr.tr.m7_u),
  make_1yrmod_REML_repr2)

peduncles_mods_reml_T  <-lapply(
  list(repr.m8, repr.m8_u, repr.tr.m8, repr.tr.m8_u),
  make_1yrmod_REML_repr2)


all_models_reml_T <- list(
flsucc_mods_reml_T      , 
flowers_mods_reml_T     , 
flsize_mods_reml_T      , 
fltime_mods_reml_T      , 
flstart_mods_reml_T     , 
pods_mods_reml_T        , 
first_pods_mods_reml_T  , 
peduncles_mods_reml_T   ) 

names(all_models_reml_T) <- c(
"flsucc_mods"          ,
"flowers_mods"         ,
"flsize_mods"          ,
"fltime_mods",
"flstart_mods",
"pods_mods"            ,
"first_pods_mods",
"peduncles_mods")


# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

sink(here::here("./Figures_Tables/Rsquared/1yr_mods/Reproduction/Rsquared.txt"))
print(all_rsq)
sink()

```

### Defense
```{r}
# change REML to T for lmers
latex_mods_reml_T          <- reml_to_true(list(latex_mods_best_c[[1]],
                                             latex_mods_best_u[[1]],
                                             latex_mods_best_c[[2]],
                                             latex_mods_best_u[[2]]))

herb_e_bin_mods_reml_T <- lapply(
  list(def.m2, def.m2_u, def.tr.m2, def.tr.m2_u),
  make_1yrmod_REML_def1)

herb_e_quant_mods_reml_T <- lapply(
  list(def.m3, def.m3_u, def.tr.m3, def.tr.m3_u),
  make_1yrmod_REML_def2)

herb_l_bin_mods_reml_T   <- lapply(
  list(def.m4, def.m4_u, def.tr.m4, def.tr.m4_u),
  make_1yrmod_REML_def1)

herb_l_quant_mods_reml_T <- lapply(
  list(def.m5, def.m5_u, def.tr.m5, def.tr.m5_u),
  make_1yrmod_REML_def3)

weevil_bin_mods_reml_T   <- lapply(
  list(def.m6, def.m6_u, def.tr.m6, def.tr.m6_u),
  make_1yrmod_REML_def4)

weevil_quant_mods_reml_T <- lapply(
  list(def.m7, def.m7_u, def.tr.m7, def.tr.m7_u),
  make_1yrmod_REML_def5)


all_models_reml_T <- list(
latex_mods_reml_T      ,
herb_e_bin_mods_reml_T       ,
herb_e_quant_mods_reml_T ,
herb_l_bin_mods_reml_T ,
herb_l_quant_mods_reml_T       ,
weevil_bin_mods_reml_T  ,
weevil_quant_mods_reml_T   )

names(all_models_reml_T) <- c(
"latex_mods"         ,
"herb_early_mods_binomial"    ,
"herb_early_mods_quant"    ,
"herb_late_mods_binomial"     ,
"herb_late_mods_quant"     ,
"weev_mods_binomial" ,
"weev_mods_quant")

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Figures_Tables/Rsquared/1yr_mods/Defense/Rsquare.csv"))


```

### 2021 Herbivores
```{r}
# change REML to T
monarch_mods_reml_T <- lapply(
  list(herb.m1, herb.m1_u, herb.tr.m1, herb.tr.m1_u),
  make_1yrmod_REML_herb1)

asclepiadis_mods_reml_T <- lapply(
  list(herb.m2, herb.m2_u, herb.tr.m2, herb.tr.m2_u),
  make_1yrmod_REML_herb1)

clivicollis_mods_reml_T <- lapply(
  list(herb.m3, herb.m3_u, herb.tr.m3, herb.tr.m3_u),
  make_1yrmod_REML_herb2)

all_models_reml_T <- list(
monarch_mods_reml_T          , 
asclepiadis_mods_reml_T           , 
clivicollis_mods_reml_T)

names(all_models_reml_T) <- c(
"monarch_mods"          ,
"asclepiadis_mods"           ,
"clivicollis_mods"         )

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Figures_Tables/Rsquared/1yr_mods/Defense/Rsquare_herbivores.csv"))

```

### Growth
```{r}
# change REML to T
ldmc_mods_reml_T      <- reml_to_true(list(ldmc_mods_best_c[[1]],
                                           ldmc_mods_best_u[[1]],
                                           ldmc_mods_best_c[[2]],
                                           ldmc_mods_best_u[[2]]))
  
sla_mods_reml_T       <-  reml_to_true(list(sla_mods_best_c[[1]],
                                            sla_mods_best_u[[1]],
                                            sla_mods_best_c[[2]],
                                            sla_mods_best_u[[2]]))
  
heights_e_mods_reml_T <- lapply(
  list(grow.m3, grow.m3_u, grow.tr.m3, grow.tr.m3_u),
  make_1yrmod_REML_grow1)

heights_l_mods_reml_T <- lapply(
  list(grow.m4, grow.m4_u, grow.tr.m4, grow.tr.m4_u),
  make_1yrmod_REML_grow1)

rgr_mods_reml_T       <- lapply(
  list(grow.m5, grow.m5_u, grow.tr.m5, grow.tr.m5_u),
  make_1yrmod_REML_grow1)
  
ramets_e_mods_reml_T  <- lapply(
  list(grow.m6, grow.m6_u, grow.tr.m6, grow.tr.m6_u),
  make_1yrmod_REML_grow1)

ramets_l_mods_reml_T  <- lapply(
  list(grow.m7, grow.m7_u, grow.tr.m7, grow.tr.m7_u),
  make_1yrmod_REML_grow1)

mortality_mods_reml_T <- lapply(
  list(grow.m8, grow.m8_u, grow.tr.m8, grow.tr.m8_u),
  make_1yrmod_REML_grow2)


all_models_reml_T <- list(
ldmc_mods_reml_T      ,
sla_mods_reml_T       ,
heights_e_mods_reml_T ,
heights_l_mods_reml_T ,
rgr_mods_reml_T       ,
ramets_e_mods_reml_T  ,
ramets_l_mods_reml_T  ,
mortality_mods_reml_T )

names(all_models_reml_T) <- c(
"ldmc_mods"      ,
"sla_mods"       ,
"heights_e_mods" ,
"heights_l_mods" ,
"rgr_mods"       ,
"ramets_e_mods"  ,
"ramets_l_mods"  ,
"mortality_mods" )

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) #%T>%
  # write.csv(here::here("./Figures_Tables/Rsquared/1yr_mods/Growth/Rsquare.csv")) # this isn't working

sink(here::here("./Figures_Tables/Rsquared/1yr_mods/Growth/Rsquare.csv"))
print(all_rsq)
sink()

```

### Export all Rsq tables into one docx
```{r}

make_full_R2_table <- function(list1, list2, list3,
                               list4, list5, list6,
                               list7, list8, list9,
                                list10, list11, list12,
                                list13, list14, list15,
                                list16, list17, list18,
                                list19 , list20, list21,
                                list22, list23, list24,
                                list25, list26
                               ){
      
  make_1_table <- function(list1){
    
      lapply(list1, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
   #   dplyr::select(-contains("alt")) %>%
      dplyr::rename("Type" = 1) %>%
      dplyr::filter(row_number()==n()) %>%
      data.table::as.data.table() %>%
      data.table::melt(.,
           measure = patterns("R2m",         
                              "R2m.1",
                              "R2m.2",
                              "R2m.3", 
                              "R2c",          
                              "R2c.1",
                              "R2c.2",
                              "R2c.3"),
           value.name = c("Distance_Q1.R2m",      
                          "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",     
                          "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(Type,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,

                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c) %>%
      dplyr::filter(row_number()==1)
    }

  full_table <- lapply(list(list1, list2, list3,
                               list4, list5, list6,
                               list7, list8, list9,
                                list10, list11, list12,
                                list13, list14, list15, 
                                list16, list17, list18,
                                list19 , list20, list21,
                                list22, list23, list24,
                                  list25 , list26
                      ), make_1_table) %>%
    reduce(full_join, all = T) %>%
      dplyr::mutate(Variable = c(list1[[1]]$call[[2]][[2]],
                                 list2[[1]]$call[[2]][[2]],
                                 list3[[1]]$call[[2]][[2]],
                                 list4[[1]]$call[[2]][[2]],
                                 list5[[1]]$call[[2]][[2]],
                                 list6[[1]]$call[[2]][[2]],
                                 list7[[1]]$call[[2]][[2]],
                                 list8[[1]]$call[[2]][[2]],
                                 list9[[1]]$call[[2]][[2]],
                                 list10[[1]]$call[[2]][[2]],
                                 list11[[1]]$call[[2]][[2]],
                                 list12[[1]]$call[[2]][[2]],
                                 list13[[1]]$call[[2]][[2]],
                                 list14[[1]]$call[[2]][[2]],
                                 list15[[1]]$call[[2]][[2]],
                                 list16[[1]]$call[[2]][[2]],
                                 list17[[1]]$call[[2]][[2]],
                                 
                          #       list17[[1]]$call[[2]][[2]],
                                 
                                 list19[[1]]$call[[2]][[2]],
                                 list20[[1]]$call[[2]][[2]],
                                 list21[[1]]$call[[2]][[2]],
                                 list22[[1]]$call[[2]][[2]],
                                 list23[[1]]$call[[2]][[2]],
                                 list24[[1]]$call[[2]][[2]],
                                 list25[[1]]$call[[2]][[2]],
                                 list26[[1]]$call[[2]][[2]]
                                 )) %>%
      dplyr::relocate(Variable) %>%
  dplyr::mutate(Variable = case_when(

    # Defense
    str_detect(Variable, "Latex")~
      "Latex exudation",
    str_detect(Variable, "Herbivory_mean_early_binary") ~
      "Herbivory before flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_early)") ~
                 "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Herbivory_mean_late_binary")~
      "Herbivory after flowering (binary)",
    str_detect(Variable, "(Herbivory_mean_late)")~
      "Herbivory before flowering (quantitative)",
    str_detect(Variable, "Scar_binary")~
      "Weevil damage (binary)",
    str_detect(Variable, "Scar_length_cm")~
      "Weevil damage (quantitative)",

    # Reproduction
    str_detect(Variable, "Flowered")~
      "Flowering success",
    str_detect(Variable, "mean_flower_c")~
      "Flowers per Inflorescence",
    str_detect(Variable, "Overall")~
      "Flower size",
    str_detect(Variable, "flowering_time")~
      "Flowering duration",
    str_detect(Variable, "Julian_oldest_inflor")~
      "Date of first flower",
    str_detect(Variable, "Pods")~
      "Follicles",
    str_detect(Variable, "first_foll")~
      "Date of first follicle",
    str_detect(Variable, "Peduncles")~
      "Inflorescences",

    # Herbivores
    str_detect(Variable, "Monarch")~
      "Danaus plexippus abundance",
    str_detect(Variable, "asclep")~
      "Liriomyza asclepiadis abundance",
    str_detect(Variable, "clivi")~
      "Labidomera clivicollis abundance",

    # Growth
    str_detect(Variable, "LDMC")~
      "LDMC",
    str_detect(Variable, "SLA")~
      "SLA",
    str_detect(Variable, "heights_e_cuberoot")~
      "Height before flowering",
    str_detect(Variable, "heights_l_cuberoot")~
      "Height after flowering",
    str_detect(Variable, "rgr")~
      "Relative growth rate",
    str_detect(Variable, "Ramets_early")~
      "Ramets before flowering",
    str_detect(Variable, "Ramets_late")~
      "Ramets after flowering",
    str_detect(Variable, "Dead")~
      "Mortality"


    )) %>%
    add_row(
      # adding the clivicollis row this way because otherwise this function breaks when I try to add it, not sure why. All the values are 0 though... could be related?
      Variable = "Labidomera clivicollis abundance",
            Type = "trigamma",
            Distance_Q1.R2m = 0,  Distance_Q1.R2c = 0,  Distance_Q2_best.R2m = 0,  Distance_Q2_best.R2c = 0,  UrbScore_Q1.R2m = 0,  UrbScore_Q1.R2c = 0,  UrbScore_Q2_best.R2m = 0,  UrbScore_Q2_best.R2c = 0,
            .before = 18) %>%
    
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4"),
        colwidths = c(2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(2,2,2,2,2))%>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(2,4,4)) %>%
      theme_box() %>%
      align(j = c(2:10), align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9), i = 4,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(4,6,8,10), i = 4,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit()

  return(full_table) 
  
}



make_full_R2_table(
  # defense
                   latex_mods_reml_T        ,
                  herb_e_bin_mods_reml_T   ,
                  herb_e_quant_mods_reml_T ,
                  herb_l_bin_mods_reml_T   ,
                  herb_l_quant_mods_reml_T ,
                  weevil_bin_mods_reml_T   ,
                  weevil_quant_mods_reml_T ,
  # reproductive traits
                    flsucc_mods_reml_T   ,  
                   flowers_mods_reml_T    ,
                   flsize_mods_reml_T     ,
                   fltime_mods_reml_T     ,
                   flstart_mods_reml_T    ,
                   pods_mods_reml_T       ,
                   first_pods_mods_reml_T ,
                   peduncles_mods_reml_T ,
                   
  # herbivores
                    monarch_mods_reml_T,
                    asclepiadis_mods_reml_T,
                    clivicollis_mods_reml_T,
  # growth traits
                    ldmc_mods_reml_T     ,
                    sla_mods_reml_T      ,
                    heights_e_mods_reml_T,
                    heights_l_mods_reml_T,
                    rgr_mods_reml_T      ,
                    ramets_e_mods_reml_T ,
                    ramets_l_mods_reml_T ,
                    mortality_mods_reml_T
                   ) %T>%
  save_as_docx(path = here::here("./Figures_Tables/Rsquared/1yr_mods/Rsquared_all.docx"),
              pr_section = prop_section(
                page_size = page_size(
                  orient = "landscape",
                  width = 16, height = 15),
                type = "continuous",
                page_margins = page_mar()))
```

