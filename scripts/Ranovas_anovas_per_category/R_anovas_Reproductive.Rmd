# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("scripts/Model_diagnostics/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))
```

# Ranova
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## gaussian distribution models
### Gradient
```{r}
# mean flower size-----
# 2020-----
flsize_ranova_mod1 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod1)

# export
ranova_2step(flsize_ranova_mod1,
             "Flower size: 2020",
             "./Figures_Tables/ranova_PVE/Reproduction/flower_size_2020.docx")


# 2021-----
flsize_ranova_mod2 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod2)

# export
ranova_2step(flsize_ranova_mod2,
             "Flower size: 2021",
             "./Figures_Tables/ranova_PVE/Reproduction/flower_size_2021.docx")



# 2022-----
flsize_ranova_mod3 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2022),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod3)

# export
ranova_2step(flsize_ranova_mod3,
             "Flower size: 2022",
             "./Figures_Tables/ranova_PVE/Reproduction/flower_size_2022.docx")

# pollinaria removed-----
# 2020-----
poll_ranova_mod1 <- lmer(sqrt(mean_poll) ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(poll_ranova_mod1)

# export
ranova_2step(poll_ranova_mod1,
             "Pollinaria removed: 2020",
             "./Figures_Tables/ranova_PVE/Reproduction/poll_rem_2020.docx")


# 2021-----
poll_ranova_mod2 <- lmer(sqrt(mean_poll) ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(poll_ranova_mod2)

# export
ranova_2step(poll_ranova_mod2,
             "Pollinaria removed: 2021",
             "./Figures_Tables/ranova_PVE/Reproduction/poll_rem_2021.docx")



# 2022-----
poll_ranova_mod3 <- lmer(sqrt(mean_poll) ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2022),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(poll_ranova_mod3)

# export
ranova_2step(poll_ranova_mod3,
             "Pollinaria removed: 2022",
             "./Figures_Tables/ranova_PVE/Reproduction/poll_rem_2022.docx")
```

### Urban subtransects
```{r}
# mean flower size-----
# 2020-----
flsize_ranova_mod1 <- lmer(Overall_mean ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod1)

ranova_transect(flsize_ranova_mod1,
                "Flower size: 2020",
                "./Figures_Tables/ranova_PVE/Reproduction/flsize_transects_2020.docx")



# 2021-----
flsize_ranova_mod2 <- lmer(Overall_mean ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod2)

ranova_transect(flsize_ranova_mod2,
                "Flower size: 2021",
                "./Figures_Tables/ranova_PVE/Reproduction/flsize_transects_2021.docx")


# 2022-----
flsize_ranova_mod3 <- lmer(Overall_mean ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2022),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod3)

ranova_transect(flsize_ranova_mod3,
                "Flower size: 2022",
                "./Figures_Tables/ranova_PVE/Reproduction/flsize_transects_2022.docx")


# mean Pollinaria removed-----
# 2020-----
poll_ranova_mod1 <- lmer(sqrt(mean_poll) ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(poll_ranova_mod1)

ranova_transect(poll_ranova_mod1,
                "Pollinaria removed: 2020",
                "./Figures_Tables/ranova_PVE/Reproduction/poll_transects_2020.docx")



# 2021-----
poll_ranova_mod2 <- lmer(sqrt(mean_poll) ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(poll_ranova_mod2)

ranova_transect(poll_ranova_mod2,
                "Pollinaria removed: 2021",
                "./Figures_Tables/ranova_PVE/Reproduction/poll_transects_2021.docx")


# 2022-----
poll_ranova_mod3 <- lmer(sqrt(mean_poll) ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2022),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(poll_ranova_mod3)

ranova_transect(poll_ranova_mod3,
                "Pollinaria removed: 2022",
                "./Figures_Tables/ranova_PVE/Reproduction/poll_transects_2022.docx")

```

## non-gaussian models
### Gradient
```{r}
# I think I should disregard some 2020 results b/c so few plants flowered that year
############################################
# Flowering success----- 
# 2020-----
flsucc_ranova1 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2020),

                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova1)

pb_ranova_2step(flsucc_ranova1,
          "Flowering success: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_success_2020.docx")

# 2021-----
flsucc_ranova2 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2021),
                
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova2)

pb_ranova_2step(flsucc_ranova2,
          "Flowering success: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_success_2021.docx")

# 2022-----
flsucc_ranova3 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2022),
                 
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova3)

pb_ranova_2step(flsucc_ranova3,
          "Flowering success: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_success_2022.docx")


# Flowers/inflor-----
# 2020-----
flowers_ranova1 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                     
                            na.action = na.exclude)

# performance::check_model(flowers_ranova1)

pb_ranova_2step(flowers_ranova1,
          "Mean flower count: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/flowercount_2020.docx")

# 2021-----
flowers_ranova2 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                         
                            na.action = na.exclude)

# performance::check_model(flowers_ranova2)

pb_ranova_2step(flowers_ranova2,
          "Mean flower count: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/flowercount_2021.docx")

# 2022-----
flowers_ranova3 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                     
                            na.action = na.exclude)

# performance::check_model(flowers_ranova3)

pb_ranova_2step(flowers_ranova3,
          "Mean flower count: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/flowercount_2022.docx")

# Flowering time-----
# 2020-----
fltime_ranova1 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                    
                            na.action = na.exclude)

# performance::check_model(fltime_ranova1)

pb_ranova_2step(fltime_ranova1,
          "Flowering duration: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/flowertime_2020.docx")



# 2021-----
fltime_ranova2 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                     
                            na.action = na.exclude)

# performance::check_model(fltime_ranova2)

pb_ranova_2step(fltime_ranova2,
          "Flowering duration: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/flowertime_2021.docx")




# 2022-----
fltime_ranova3 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                    
                            na.action = na.exclude)

# performance::check_model(fltime_ranova3)

pb_ranova_2step(fltime_ranova3,
          "Flowering duration: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/flowertime_2022.docx")

# Flowering start-----
# 2020-----
flstart_ranova1 <- glmer(Julian_oldest_inflor-170 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova1)
summary(flstart_ranova1)

pb_ranova_2step(flstart_ranova1,
          "Flowering start: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_start_2020.docx")

# 2021-----
flstart_ranova2 <- glmer(Julian_oldest_inflor-170 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova2)

pb_ranova_2step(flstart_ranova2,
          "Flowering start: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_start_2021.docx")

# 2022-----
flstart_ranova3 <- glmer(Julian_oldest_inflor-170 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova3)

pb_ranova_2step(flstart_ranova3,
          "Flowering start: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_start_2022.docx")


# Pods-----
# 2020-----
pods_ranova1 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude)

# performance::check_model(pods_ranova1)

pb_ranova_2step(pods_ranova1,
          "Follicles: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/pods_2020.docx")


# 2021-----
pods_ranova2 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

# performance::check_model(pods_ranova2)

pb_ranova_2step(pods_ranova2,
          "Follicles: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/pods_2021.docx")

# 2022-----
pods_ranova3 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                   
                            na.action = na.exclude)

# performance::check_model(pods_ranova3)

pb_ranova_2step(pods_ranova3,
          "Follicles: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/pods_2022.docx")


# Date of first follicle-----

# copied from transects chunk below:
summary(flowering$Julian_first_follicle) # min is 201. I've been having issues getting these models to not be singular, and subtracting 200 from the response helps a lot. I think the issue is that the numbers are so big and could have the min subtracted to keep the range from ~1-45 vs. 201-245.

# 2020-----
firstpod_ranova1 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(firstpod_ranova1)

pb_ranova_2step(firstpod_ranova1,
          "First follicle: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/first_pods_2020.docx")


# 2021-----
firstpod_ranova2 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021 &
                                is.na(Julian_first_follicle) == FALSE),
                           na.action = na.exclude,
                             family = poisson)

# performance::check_model(firstpod_ranova2)

pb_ranova_2step(firstpod_ranova2,
          "First follicle: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/first_pods_2021.docx")

# 2022-----
# when I remove population (which summary shows has a variance of 0), the model isn't singular anymore. I think that's the key here
firstpod_ranova3 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022 & is.na(Julian_first_follicle) == FALSE),
                           na.action = na.exclude,
                          family = poisson)

# performance::check_model(firstpod_ranova3)

summary(firstpod_ranova3)

pb_ranova_2step(firstpod_ranova3,
          "First follicle: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/first_pods_2022.docx")

# Peduncles-----
# 2020-----
peduncles_ranova1 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova1)

pb_ranova_2step(peduncles_ranova1,
          "Inflorescences: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/peduncles_2020.docx")


# 2021-----
peduncles_ranova2 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                  
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova2)

pb_ranova_2step(peduncles_ranova2,
          "Inflorescences: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/peduncles_2021.docx")


# 2022-----
peduncles_ranova3 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova3)

pb_ranova_2step(peduncles_ranova3,
          "Inflorescences: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/peduncles_2022.docx")

```

### Urb subtransects
```{r}
# Flowering success-----
# 2020-----
flsucc_ranova1 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova1)

pb_ranova_transects(flsucc_ranova1,
          "Flowering success: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_success_2020_transects.docx")

# 2021-----
flsucc_ranova2 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                  
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova2)

pb_ranova_transects(flsucc_ranova2,
          "Flowering success: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_success_2021_transects.docx")

# 2022-----
flsucc_ranova3 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                 
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova3)

pb_ranova_transects(flsucc_ranova3,
          "Flowering success: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_success_2022_transects.docx")


# Flowers/inflor-----
# 2020-----
flowers_ranova1 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude)

# performance::check_model(flowers_ranova1)

pb_ranova_transects(flowers_ranova1,
          "Mean flower count: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/flowercount_2020_transects.docx")

# 2021-----
flowers_ranova2 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                 
                            na.action = na.exclude)

# performance::check_model(flowers_ranova2)

pb_ranova_transects(flowers_ranova2,
          "Mean flower count: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/flowercount_2021_transects.docx")

# 2022-----
flowers_ranova3 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                 
                            na.action = na.exclude)

# performance::check_model(flowers_ranova3)

pb_ranova_transects(flowers_ranova3,
          "Mean flower count: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/flowercount_2022_transects.docx")


# Flowering time-----
# 2020-----
fltime_ranova1 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                            na.action = na.exclude  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

# performance::check_model(fltime_ranova1)

pb_ranova_transects(fltime_ranova1,
          "Flowering duration: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/flowertime_2020_transects.docx")



# 2021-----
fltime_ranova2 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                  
                           na.action = na.exclude)

# performance::check_model(fltime_ranova2)

pb_ranova_transects(fltime_ranova2,
          "Flowering duration: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/flowertime_2021_transects.docx")


# 2022-----
fltime_ranova3 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                            na.action = na.exclude  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

# performance::check_model(fltime_ranova3)

pb_ranova_transects(fltime_ranova3,
          "Flowering duration: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/flowertime_2022_transects.docx")


# Flowering start-----
# 2020-----
flstart_ranova1 <- glmer(Julian_oldest_inflor ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova1)

pb_ranova_transects(flstart_ranova1,
          "Flowering start: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_start_2020_transects.docx")


# 2021-----
flstart_ranova2 <- glmer(Julian_oldest_inflor ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova2)

pb_ranova_transects(flstart_ranova2,
          "Flowering start: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_start_2021_transects.docx")

# 2022-----
flstart_ranova3 <- glmer(Julian_oldest_inflor ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
               
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova3)

pb_ranova_transects(flstart_ranova3,
          "Flowering start: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/flowering_start_2022_transects.docx")



# Pods-----
# 2020-----
pods_ranova1 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude)

# performance::check_model(pods_ranova1)

pb_ranova_transects(pods_ranova1,
          "Pods: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/pods_2020_transects.docx")

# 2021-----
pods_ranova2 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                
                            na.action = na.exclude)

# performance::check_model(pods_ranova2)

pb_ranova_transects(pods_ranova2,
          "Pods: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/pods_2021_transects.docx")

# 2022-----
pods_ranova3 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
               
                            na.action = na.exclude)

# performance::check_model(pods_ranova3)

pb_ranova_transects(pods_ranova3,
          "Pods: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/pods_2022_transects.docx")


# Date of first follicle-----
# 2020-----

summary(flowering$Julian_first_follicle) # min is 201. I've been having issues getting these models to not be singular, and subtracting 200 from the response helps a lot. I think the issue is that the numbers are so big and could have the min subtracted to keep the range from ~1-45 vs. 201-245.


firstpod_ranova <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                    dplyr::filter(is.na(Julian_first_follicle) == F &
                                               Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude,
                             family = poisson) # singular but I think it's because it's a tiny sample size

# performance::check_model(firstpod_ranova)

pb_ranova_transects(firstpod_ranova,
          "Date of first follicle: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/Date_first_follicle_2020_transects.docx")


# 2021-----
firstpod_ranova2 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                    dplyr::filter(is.na(Julian_first_follicle) == F &
                                    Transect_ID != "Rural" &
                                    Year == 2021),
               
                    na.action = na.exclude,
                             family = poisson)

# performance::check_model(firstpod_ranova2)

pb_ranova_transects(firstpod_ranova2,
          "Date of first follicle: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/Date_first_follicle_2021_transects.docx")

# 2022-----
firstpod_ranova3 <- glmer((Julian_first_follicle-200) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>% 
                            dplyr::filter(
                              is.na(Julian_first_follicle) == F &
                                Transect_ID != "Rural" &
                                Year == 2022),
                          na.action = na.exclude,
                    # add more iterations
                control=glmerControl(optCtrl=list(maxfun=2e5)),
                family = poisson)

# performance::check_model(firstpod_ranova3)

pb_ranova_transects(firstpod_ranova3,
          "Date of first follicle: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/Date_first_follicle_2022_transects_test.docx")



# Peduncles-----
# 2020-----
peduncles_ranova1 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
             
                             na.action = na.exclude)

performance::check_model(peduncles_ranova1)

pb_ranova_transects(peduncles_ranova1,
          "Peduncles: 2020",
          "./Figures_Tables/ranova_PVE/Reproduction/peduncles_2020_transects.docx")


# 2021-----
peduncles_ranova2 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021), 
                
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova2)

pb_ranova_transects(peduncles_ranova2,
          "Peduncles: 2021",
          "./Figures_Tables/ranova_PVE/Reproduction/peduncles_2021_transects.docx")

# 2022-----
peduncles_ranova3 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                           na.action = na.exclude)

# performance::check_model(peduncles_ranova3)



pb_ranova_transects(peduncles_ranova3,
          "Peduncles: 2022",
          "./Figures_Tables/ranova_PVE/Reproduction/peduncles_2022_transects.docx")

```

## Recalculate PVE for non-Gaussian models
As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution.
The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection.
These new PVEs will be estimates. This is *not* a perfect solution but it will help us approximate PVE for these variables.
### Q1
```{r}
# main models
flsucc_lmer <- lmer(as.numeric(Flowered) ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude)

flowers_lmer <- lmer(mean_flower_count ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude)

fltime_lmer <- update(flowers_lmer,
                      as.numeric(flowering_time) ~.)

flstart_lmer <- update(flowers_lmer,
                      Julian_oldest_inflor ~.)

pods_lmer <- update(flowers_lmer,
                      Pods ~.)

firstpod_lmer <- update(flowers_lmer,
                      Julian_first_follicle ~.)

peduncles_lmer <- update(flowers_lmer,
                      Peduncles ~.)

# get PVE from models
pve_flsucc    <- PVE_lm(flsucc_lmer) 
pve_flowers   <- PVE_lm(flowers_lmer)
pve_fltime    <- PVE_lm(fltime_lmer)
pve_flstart   <- PVE_lm(flstart_lmer) 
pve_pods      <- PVE_lm(pods_lmer)
pve_firstpod  <- PVE_lm(firstpod_lmer)
pve_peduncles <- PVE_lm(peduncles_lmer)


pve_flsucc_city     <- PVE_lm(update(flsucc_lmer, .~. + City_dist))
pve_flowers_city    <- PVE_lm(update(flowers_lmer, .~. + City_dist))
pve_fltime_city     <- PVE_lm(update(fltime_lmer, .~. + City_dist))
pve_flstart_city    <- PVE_lm(update(flstart_lmer, .~. + City_dist))
pve_pods_city       <- PVE_lm(update(pods_lmer, .~. + City_dist))
pve_firstpod_city   <- PVE_lm(update(firstpod_lmer, .~. + City_dist))
pve_peduncles_city  <- PVE_lm(update(peduncles_lmer, .~. + City_dist))


pve_flsucc_urbsc    <- PVE_lm(update(flsucc_lmer, .~. + Urb_score))
pve_flowers_urbsc   <- PVE_lm(update(flowers_lmer, .~. + Urb_score))
pve_fltime_urbsc    <- PVE_lm(update(fltime_lmer, .~. + Urb_score))
pve_flstart_urbsc   <- PVE_lm(update(flstart_lmer, .~. + Urb_score))
pve_pods_urbsc      <- PVE_lm(update(pods_lmer, .~. + Urb_score))
pve_firstpod_urbsc  <- PVE_lm(update(firstpod_lmer, .~. + Urb_score))
pve_peduncles_urbsc <- PVE_lm(update(peduncles_lmer, .~. + Urb_score))



# make tables
recalc_tab1.1 <- pve_table_recalc(pve_flsucc,
                                  pve_flowers,
                                  pve_fltime,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab1.2 <- pve_table_recalc(pve_flstart,
                                  pve_pods, 
                                  pve_firstpod,
                 "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab1.3 <- pve_peduncles %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()
  
  
recalc_tab2.1 <- pve_table_recalc(pve_flsucc_city,
                                  pve_flowers_city, 
                                  pve_fltime_city,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab2.2 <- pve_table_recalc(pve_flstart_city,
                                  pve_pods_city, 
                                  pve_firstpod_city,
                 "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab2.3 <- pve_peduncles_city %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()


recalc_tab3.1 <- pve_table_recalc(pve_flsucc_urbsc,
                                  pve_flowers_urbsc,
                                  pve_fltime_urbsc,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab3.2 <- pve_table_recalc(pve_flstart_urbsc,
                                  pve_pods_urbsc, 
                                  pve_firstpod_urbsc,
                  "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab3.3 <- pve_peduncles_urbsc %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()


# Export to word
  word_export <- read_docx()
  
  body_add_par(word_export,
               value = "As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution. The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection. These new PVEs will be estimates. This is not a perfect solution but it will help us approximate PVE for these variables.")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 1: Test for variance among families and populations")
  body_add_flextable(word_export, recalc_tab1.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab1.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab1.3)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 2: Assess how much variance is explained by urbanization")
  body_add_par(word_export, value = "Urbanization = Distance to the City Center")
  body_add_flextable(word_export, recalc_tab2.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab2.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab2.3)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 3: Assess how much variance is explained by urbanization")
  body_add_par(word_export, value = "Urbanization = Urbanization Score")
  body_add_flextable(word_export, recalc_tab3.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab3.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab3.3)  
  
  print(word_export, here::here("./Figures_Tables/ranova_PVE/Reproduction/PVE_nonGaussmods/PVE_nonGaussmods_reproduction_Q1.docx"))

```

### Q2
```{r}
# main models
flsucc_lmer2 <- update(flsucc_lmer,
                             data = reproduc %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

flowers_lmer2 <- update(flowers_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

fltime_lmer2 <- update(fltime_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

flstart_lmer2 <- update(flstart_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

pods_lmer2 <- update(pods_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

firstpod_lmer2 <- update(firstpod_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

peduncles_lmer2 <- update(peduncles_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

# get PVE from models
pve_flsucc2    <- PVE_lm(flsucc_lmer2) 
pve_flowers2   <- PVE_lm(flowers_lmer2)
pve_fltime2    <- PVE_lm(fltime_lmer2)
pve_flstart2   <- PVE_lm(flstart_lmer2) 
pve_pods2      <- PVE_lm(pods_lmer2)
pve_firstpod2  <- PVE_lm(firstpod_lmer2)
pve_peduncles2 <- PVE_lm(peduncles_lmer2)


pve_flsucc_city2     <- PVE_lm(update(flsucc_lmer2, .~. + City_dist*Transect_ID))
pve_flowers_city2    <- PVE_lm(update(flowers_lmer2, .~. + City_dist*Transect_ID))
pve_fltime_city2     <- PVE_lm(update(fltime_lmer2, .~. + City_dist*Transect_ID))
pve_flstart_city2    <- PVE_lm(update(flstart_lmer2, .~. + City_dist*Transect_ID))
pve_pods_city2       <- PVE_lm(update(pods_lmer2, .~. + City_dist*Transect_ID))
pve_firstpod_city2   <- PVE_lm(update(firstpod_lmer2, .~. + City_dist*Transect_ID))
pve_peduncles_city2  <- PVE_lm(update(peduncles_lmer2, .~. + City_dist*Transect_ID))


pve_flsucc_urbsc2    <- PVE_lm(update(flsucc_lmer2, .~. + Urb_score*Transect_ID))
pve_flowers_urbsc2   <- PVE_lm(update(flowers_lmer2, .~. + Urb_score*Transect_ID))
pve_fltime_urbsc2    <- PVE_lm(update(fltime_lmer2, .~. + Urb_score*Transect_ID))
pve_flstart_urbsc2   <- PVE_lm(update(flstart_lmer2, .~. + Urb_score*Transect_ID))
pve_pods_urbsc2      <- PVE_lm(update(pods_lmer2, .~. + Urb_score*Transect_ID))
pve_firstpod_urbsc2  <- PVE_lm(update(firstpod_lmer2, .~. + Urb_score*Transect_ID))
pve_peduncles_urbsc2 <- PVE_lm(update(peduncles_lmer2, .~. + Urb_score*Transect_ID))



# make tables
recalc_tab1.1 <- pve_table_recalc(pve_flsucc2,
                                  pve_flowers2,
                                  pve_fltime2,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab1.2 <- pve_table_recalc(pve_flstart2,
                                  pve_pods2, 
                                  pve_firstpod2,
                 "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab1.3 <- pve_peduncles2 %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()
  
  
recalc_tab2.1 <- pve_table_recalc(pve_flsucc_city2,
                                  pve_flowers_city2, 
                                  pve_fltime_city2,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab2.2 <- pve_table_recalc(pve_flstart_city2,
                                  pve_pods_city2, 
                                  pve_firstpod_city2,
                 "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab2.3 <- pve_peduncles_city2 %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()


recalc_tab3.1 <- pve_table_recalc(pve_flsucc_urbsc2,
                                  pve_flowers_urbsc2,
                                  pve_fltime_urbsc2,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab3.2 <- pve_table_recalc(pve_flstart_urbsc2,
                                  pve_pods_urbsc2, 
                                  pve_firstpod_urbsc2,
                  "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab3.3 <- pve_peduncles_urbsc2 %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()


# Export to word
  word_export <- read_docx()
  
  body_add_par(word_export,
               value = "As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution. The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection. These new PVEs will be estimates. This is not a perfect solution but it will help us approximate PVE for these variables.")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 1: Test for variance among families and populations")
  body_add_flextable(word_export, recalc_tab1.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab1.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab1.3)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 2: Assess how much variance is explained by urbanization")
  body_add_par(word_export, value = "Urbanization = Distance to the City Center")
  body_add_flextable(word_export, recalc_tab2.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab2.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab2.3)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 3: Assess how much variance is explained by urbanization")
  body_add_par(word_export, value = "Urbanization = Urbanization Score")
  body_add_flextable(word_export, recalc_tab3.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab3.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab3.3)  
  
  print(word_export, here::here("./Figures_Tables/ranova_PVE/Reproduction/PVE_nonGaussmods/PVE_nonGaussmods_reproduction_Q2.docx"))

```

# Anova
## Export all best / alt multi-year models in separate word docs
### Distance / best
```{r}
all_models_best_c <- list(
flsucc_mods_best_c      , # flowering success
flowers_mods_best_c     , # mean flowers/inflor
flsize_mods_best_c      , # mean flower size
fltime_mods_best_c      , # flowering time
flstart_mods_best_c     , # flowering start
poll_mods_best_c        , # pollinaria removed
pods_mods_best_c        , # pods (follicles)
first_pods_mods_best_c  , # first pods (follicles)
peduncles_mods_best_c   ) # peduncles (inflorescences)


anovas_best_c <- lapply(all_models_best_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_c, "./Figures_Tables/ANOVA_multi_yr/Reproduction/all_anova_repro_best_distance.docx")
```

### Distance / alt
```{r}
all_models_alt_c <- list(
flsucc_mods_alt_c      , # flowering success
flowers_mods_alt_c     , # mean flowers/inflor
flsize_mods_alt_c      , # mean flower size
fltime_mods_alt_c      , # flowering time
flstart_mods_alt_c     , # flowering start
poll_mods_alt_c        , # pollinaria removed
pods_mods_alt_c        , # pods (follicles)
first_pods_mods_alt_c   , # first pods (follicles)
peduncles_mods_alt_c   ) # peduncles (inflorescences)

anovas_alt_c <- lapply(all_models_alt_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_c, "./Figures_Tables/ANOVA_multi_yr/Reproduction/all_anova_repro_alt_distance.docx")
```

### UrbScore / best
```{r}
all_models_best_u <- list(
flsucc_mods_best_u      , # flowering success
flowers_mods_best_u     , # mean flowers/inflor
flsize_mods_best_u      , # mean flower size
fltime_mods_best_u      , # flowering time
flstart_mods_best_u     , # flowering start
poll_mods_best_u        , # pollinaria removed
pods_mods_best_u        , # pods (follicles)
first_pods_mods_best_u  , # first pods (follicles)
peduncles_mods_best_u   ) # peduncles (inflorescences)

anovas_best_u <- lapply(all_models_best_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_u, "./Figures_Tables/ANOVA_multi_yr/Reproduction/all_anova_repro_best_urbscore.docx")
```

### UrbScore / alt
```{r}
all_models_alt_u <- list(
flsucc_mods_alt_u      , # flowering success
flowers_mods_alt_u     , # mean flowers/inflor
flsize_mods_alt_u      , # mean flower size
# fltime_mods_alt_u      , # flowering time - NONE
flstart_mods_alt_u,     # flowering start
poll_mods_alt_u )     # pollinaria removed
# pods_mods_alt_u        , # pods (follicles) - NONE
#first_pods_mods_alt_u ) # , # first pods (follicles) - NONE
# peduncles_mods_alt_u   ) # peduncles (inflorescences) - NONE

anovas_alt_u <- lapply(all_models_alt_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_u, "./Figures_Tables/ANOVA_multi_yr/Reproduction/all_anova_repro_alt_urbscore.docx")

```
