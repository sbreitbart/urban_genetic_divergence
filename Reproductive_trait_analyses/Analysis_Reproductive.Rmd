---
title: "Reproductive Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

NOTES:

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| All reproductive traits     |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("Reproductive_trait_analyses/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))
```

# Ranova
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## gaussian distribution models
### Gradient
```{r}
# mean flower size-----
# 2020-----
flsize_ranova_mod1 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod1)

# export
ranova_2step(flsize_ranova_mod1,
             "Flower size: 2020",
             "./Reproductive_trait_analyses/Tables/Ranova/flower_size_2020.docx")


# 2021-----
flsize_ranova_mod2 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod2)

# export
ranova_2step(flsize_ranova_mod2,
             "Flower size: 2021",
             "./Reproductive_trait_analyses/Tables/Ranova/flower_size_2021.docx")



# 2022-----
flsize_ranova_mod3 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2022),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod3)

# export
ranova_2step(flsize_ranova_mod3,
             "Flower size: 2022",
             "./Reproductive_trait_analyses/Tables/Ranova/flower_size_2022.docx")
```

### Urban subtransects
```{r}
# mean flower size-----
## test City_dist
flsize_ranova_mod1 <- lmer(Overall_mean ~ (1|Population/Family) + Block + City_dist,
                             data = flowering %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test Transect
flsize_ranova_mod2 <- lmer(Overall_mean ~ (1|Population/Family) + Block + Transect_ID,
                             data = flowering %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


flsize_ranova1 <- CreateRanovaOutput(flsize_ranova_mod1, "Flower size (Distance)")
flsize_ranova2 <- CreateRanovaOutput_Q2(flsize_ranova_mod2, "Flower size (Transect)")

flextable::save_as_html(flsize_ranova1,
                        flsize_ranova2,
                        path = here::here("./Reproductive_trait_analyses/Tables/Ranova/flsize_transects.html"))


```

## non-gaussian models- use pbmodcomp()
### Gradient
```{r}
# Flowering success----- 
## TRYING TO DO ON SERVER

# take out fam
full <- glmer(Flowered ~
                             Block +
                             Year +
                             (1|Population) +
                             City_dist,
  data = reproduc,
  family = binomial(link = "logit"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flsucc_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(rep("localhost", 8)))

tidy(flsucc_ranova.pop) # p = 0.966

# variance
get_pve(flsucc_ranova.pop) # 10.218



# test fam
full <- glmer(Flowered ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist,
  data = reproduc,
  family = binomial(link = "logit"),
  nAGQ = 0, # model won't converge otherwise. I tested the difference nAGQ = 0 vs the default (>0) makes in the model above and the difference was negligible: the p-value changed by 0.003 so I think it's ok to use here, since the p-values are nowhere near 0.1 or lower.
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flsucc_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(rep("localhost", 8)))

tidy(flsucc_ranova.fam) # Family: p ~ 0.769

# variance
get_pve(flsucc_ranova.fam) # 19.013



# merge Pop and Fam ranovas
flsucc_ranova1 <- CreateRanovaOutput_bootstrap(
  flsucc_ranova.fam, 
  flsucc_ranova.pop,
  "Flowering success") %T>%
  flextable::save_as_html(path = here::here("./Reproductive_trait_analyses/Tables/Ranova/flowering_success.html"))


# Flowers/plant-----
## TRYING TO DO ON SERVER

# take out fam
# ADDED NAGQ = 0 BC DIDN'T CONVERGE OTHERWISE
full <- glmer.nb(total_flower_count ~
                             Block +
                             Year +
                             (1|Population) +
                             City_dist,
  data = flowering,
  nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flowers_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 100,
          cl = makeCluster(rep("localhost", 8)))

tidy(flowers_ranova.pop) # p = 0.212 at nsim = 100

# variance
get_pve(flowers_ranova.pop) # can't compute b/c singular



# test fam
full <- glmer.nb(total_flower_count ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist,
  data = flowering,
  nAGQ = 0, # model won't converge otherwise. I tested the difference nAGQ = 0 vs the default (>0) makes in the model above and the difference was negligible: the p-value changed by 0.003 so I think it's ok to use here, since the p-values are nowhere near 0.1 or lower.
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flowers_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(rep("localhost", 8)))

tidy(flowers_ranova.fam) # Family: p ~ 0.187 at nsim = 100

# variance
get_pve(flowers_ranova.fam) # NA since singular


# merge Pop and Fam ranovas
flowers_ranova1 <- CreateRanovaOutput_bootstrap(
  flowers_ranova.fam, 
  flowers_ranova.pop,
  "Flower count") %T>%
  flextable::save_as_html(path = here::here("./Reproductive_trait_analyses/Tables/Ranova/flower_count.html"))

# Flowering time-----
## TRYING TO DO ON SERVER

# take out fam
# ADDED NAGQ = 0 BC DIDN'T CONVERGE OTHERWISE
full <- glmer.nb(as.numeric(flowering_time) ~
                             Block +
                             Year +
                             (1|Population) +
                             City_dist,
  data = flowering,
   nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

fltime_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 100,
          cl = makeCluster(rep("localhost", 8)))

tidy(fltime_ranova.pop) # p = 0.688 at nsim = 100

# variance
get_pve(fltime_ranova.pop) # 100- but warning msg says:
# Warning message:
# Can't calculate model's distribution-specific variance.
#   Results are not reliable.



# test fam
full <- glmer.nb(as.numeric(flowering_time) ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist,
  data = flowering,
   nAGQ = 0, # model won't converge otherwise. I tested the difference nAGQ = 0 vs the default (>0) makes in the model above and the difference was negligible: the p-value changed by 0.003 so I think it's ok to use here, since the p-values are nowhere near 0.1 or lower.
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

fltime_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(rep("localhost", 8)))

tidy(fltime_ranova.fam) # Family: p ~ 0.682

# variance
get_pve(fltime_ranova.fam) # can't compute b'c singular


# merge Pop and Fam ranovas
fltime_ranova1 <- CreateRanovaOutput_bootstrap(
  fltime_ranova.fam, 
  fltime_ranova.pop,
  "Flower count") %T>%
  flextable::save_as_html(path = here::here("./Reproductive_trait_analyses/Tables/Ranova/flower_start.html"))


# Flowering start-----
## TRYING TO DO ON SERVER

# take out fam
# ADDED NAGQ = 0 BC DIDN'T CONVERGE OTHERWISE
full <- glmer(Julian_oldest_inflor ~
                     Block +
                            Year +
                             (1|Population) +
                             City_dist,
  data = flowering,
  family = poisson,
   nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flstart_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 100,
          cl = makeCluster(rep("localhost", 8)))

tidy(flstart_ranova.pop) # p = 0.706 at nsim = 100

# variance
get_pve(flstart_ranova.pop) # NA bc singular



# test fam
full <- glmer(Julian_oldest_inflor ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist,
  data = flowering,
  family = poisson,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flstart_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 8)))

tidy(flstart_ranova.fam) # Family: p ~ 0.706 at sim = 10 

# variance
get_pve(flstart_ranova.fam) # NA bc singular


# merge Pop and Fam ranovas
flstart_ranova1 <- CreateRanovaOutput_bootstrap(
  flstart_ranova.fam, 
  flstart_ranova.pop,
  "Flower count") %T>%
  flextable::save_as_html(path = here::here("./Reproductive_trait_analyses/Tables/Ranova/flower_start.html"))


# Pods-----
## TRYING TO DO ON SERVER

# take out fam
full <- glmer.nb(Pods ~
                     Block +
                            Year +
                             (1|Population) +
                             City_dist,
  data = flowering,
#   nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

pods_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 8)))

tidy(pods_ranova.pop) # p = 0.920 at nsim = 10

# variance
get_pve(pods_ranova.pop) # 0.807



# test fam
full <- glmer.nb(Pods ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist,
  data = flowering,
  nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

pods_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 100,
          cl = makeCluster(rep("localhost", 8)))

tidy(pods_ranova.fam) # Family: p ~ 1 at sim = 100

# variance
get_pve(pods_ranova.fam) # NA b/c singular


# merge Pop and Fam ranovas
pods_ranova1 <- CreateRanovaOutput_bootstrap(
  pods_ranova.fam, 
  pods_ranova.pop,
  "Flower count") %T>%
  flextable::save_as_html(path = here::here("./Reproductive_trait_analyses/Tables/Ranova/pods.html"))


# Date of first follicle-----
## TRYING TO DO ON SERVER

# take out fam
full <- glmer(Julian_first_follicle^2 ~
                     Block +
                            Year +
                             (1|Population) +
                             City_dist,
  data = flowering,
  family = poisson,
   nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

first_pods_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 100,
          cl = makeCluster(rep("localhost", 8)))

tidy(first_pods_ranova.pop) # p = 0.0962 at nsim = 100

# variance
get_pve(first_pods_ranova.pop) # 98.596



# test fam
full <- glmer(Julian_first_follicle^2 ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist,
  data = flowering,
  family = poisson,
  nAGQ = 0, 
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

first_pods_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 100,
          cl = makeCluster(rep("localhost", 8)))

tidy(first_pods_ranova.fam) # Family: p ~ 0.375 at sim = 100

# variance
get_pve(first_pods_ranova.fam) # 99.419


# merge Pop and Fam ranovas
first_pods_ranova1 <- CreateRanovaOutput_bootstrap(
  first_pods_ranova.fam, 
  first_pods_ranova.pop,
  "Flower count") %T>%
  flextable::save_as_html(path = here::here("./Reproductive_trait_analyses/Tables/Ranova/first_pods.html"))


# Peduncles-----
## TRYING TO DO ON SERVER

# take out fam
full <- glmer.nb(Peduncles ~
                     Block +
                            Year +
                             (1|Population) +
                             City_dist,
  data = flowering,
  # nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

peduncles_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1,
          cl = makeCluster(rep("localhost", 8)))

tidy(peduncles_ranova.pop) # p = 0.512 at nsim = 5

# variance
get_pve(peduncles_ranova.pop) # 15.658



# test fam
full <- glmer.nb(Peduncles ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist,
  data = flowering,
 # nAGQ = 0, 
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

peduncles_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 8)))

tidy(peduncles_ranova.fam) # Family: p ~ 0.519 w/nsim = 10

# variance
get_pve(peduncles_ranova.fam) # 20.343


# merge Pop and Fam ranovas
peduncles_ranova1 <- CreateRanovaOutput_bootstrap(
  peduncles_ranova.fam, 
  peduncles_ranova.pop,
  "Inflorescences") %T>%
  flextable::save_as_html(path = here::here("./Reproductive_trait_analyses/Tables/Ranova/peduncles.html"))

```

### Urb subtransects
```{r}
# Flowering success-----

## test city_dist
### take out fam
full <- glmer(Flowered ~
                 Block +
                Year +
                (1|Population) +
                City_dist,
              data = reproduc %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flsucc_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1,
          cl = makeCluster(rep("localhost", 6)))

tidy(flsucc_ranova.pop) # p = 0.519 w/nsim = 1

# variance
get_pve(flsucc_ranova.pop) # 10.173



# test fam
full <- glmer(Flowered ~
                 Block +
                Year +
                (1|Population/Family) +
                City_dist,
              nAGQ = 0,
              data = reproduc %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flsucc_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 100,
          cl = makeCluster(rep("localhost", 6)))

tidy(flsucc_ranova.fam) # Family: p ~ 0.278 w/nsim = 100

# variance
get_pve(flsucc_ranova.fam) # 21.784


## test transect
test_tr <-  glmer(Flowered ~
                 Block +
                Year +
                (1|Population/Family) +
                Transect_ID,
              data = reproduc %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)


# merge Pop and Fam ranovas
## test City_dist
flsucc_ranova1 <- CreateRanovaOutput_bootstrap(
  flsucc_ranova.fam,
  flsucc_ranova.pop,
  "Flowering success (Distance)")

## test transect
flsucc_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Flowering success (Transect)")

flextable::save_as_html(flsucc_ranova1,
                        flsucc_ranova2,
                        path = here::here("./Reproductive_trait_analyses/Tables/Ranova/Flowering_success_transects.html"))


# Flowers per plant-----

## test city_dist
### take out fam
full <- glmer.nb(total_flower_count ~
                 Block +
                Year +
                (1|Population) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
             # nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flowers_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(flowers_ranova.pop) # p = 0.136 w/nsim = 10

# variance
get_pve(flowers_ranova.pop) # NA b/c singular



# test fam
full <- glmer.nb(total_flower_count ~
                 Block +
                Year +
                (1|Population/Family) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
#     ,control=glmerControl(optimizer="bobyqa",
#                             optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flowers_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(flowers_ranova.fam) # Family: p ~ 0.136 w/nsim = 10

# variance
get_pve(flowers_ranova.fam) # NA b/c singular


## test transect
test_tr <-  glmer.nb(total_flower_count ~
                 Block +
                Year +
                (1|Population/Family) +
                Transect_ID,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)


# merge Pop and Fam ranovas
## test City_dist
flowers_ranova1 <- CreateRanovaOutput_bootstrap(
  flowers_ranova.fam,
  flowers_ranova.pop,
  "Flower count (Distance)")

## test transect
flowers_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Flower count (Transect)")

flextable::save_as_html(flowers_ranova1,
                        flowers_ranova2,
                        path = here::here("./Reproductive_trait_analyses/Tables/Ranova/Flower_count_transects.html"))


# Flowering time-----

## test city_dist
### take out fam
full <- glmer.nb(as.numeric(flowering_time) ~
                 Block +
                Year +
                (1|Population) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

fltime_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(fltime_ranova.pop) # p = 0.121 w/nsim = 10

# variance
get_pve(fltime_ranova.pop) # Warning message:
# Can't calculate model's distribution-specific variance.
#   Results are not reliable.



# test fam
full <- glmer.nb(as.numeric(flowering_time) ~
                 Block +
                Year +
                (1|Population/Family) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

fltime_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(fltime_ranova.fam) # Family: p ~ 0.121 w/nsim = 10

# variance
get_pve(fltime_ranova.fam) # NA bc singular


## test transect
test_tr <-  glmer.nb(as.numeric(flowering_time) ~
                 Block +
                Year +
                (1|Population/Family) +
                Transect_ID,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)


# merge Pop and Fam ranovas
## test City_dist
fltime_ranova1 <- CreateRanovaOutput_bootstrap(
  fltime_ranova.fam,
  fltime_ranova.pop,
  "Flowering time (Distance)")

## test transect
fltime_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Flowering time (Transect)")

flextable::save_as_html(fltime_ranova1,
                        fltime_ranova2,
                        path = here::here("./Reproductive_trait_analyses/Tables/Ranova/Flowering_time_transects.html"))

# Flowering start-----

## test city_dist
### take out fam
full <- glmer(Julian_oldest_inflor ~
                 Block +
                Year +
                (1|Population) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
     #         nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flstart_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(flstart_ranova.pop) # p = 0.133 w/nsim =10

# variance
get_pve(flstart_ranova.pop) # NA b/c singular



# test fam
full <- glmer(Julian_oldest_inflor ~
                 Block +
                Year +
                (1|Population/Family) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
   #           nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

flstart_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(flstart_ranova.fam) # Family: p ~ 0.133 w/nsim = 10

# variance
get_pve(flstart_ranova.fam) # NA bc singular


## test transect
test_tr <-  glmer(Julian_oldest_inflor ~
                 Block +
                Year +
                (1|Population/Family) +
                Transect_ID,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)


# merge Pop and Fam ranovas
## test City_dist
flstart_ranova1 <- CreateRanovaOutput_bootstrap(
  flstart_ranova.fam,
  flstart_ranova.pop,
  "Flowering start (Distance)")

## test transect
flstart_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Flowering start (Transect)")

flextable::save_as_html(flstart_ranova1,
                        flstart_ranova2,
                        path = here::here("./Reproductive_trait_analyses/Tables/Ranova/Flowering_start_transects.html"))

# Pods-----

## test city_dist
### take out fam
full <- glmer.nb(Pods ~
                 Block +
                Year +
                (1|Population) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

Pods_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(Pods_ranova.pop) # p = 0.139 w/nsim = 10

# variance
get_pve(Pods_ranova.pop) # 5.031



# test fam
full <- glmer.nb(Pods ~
                 Block +
                Year +
                (1|Population/Family) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

Pods_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(Pods_ranova.fam) # Family: p ~ 0.139 w/nsim = 10

# variance
get_pve(Pods_ranova.fam) # NA bc singular


## test transect
test_tr <-  glmer.nb(Pods ~
                 Block +
                Year +
                (1|Population/Family) +
                Transect_ID,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)


# merge Pop and Fam ranovas
## test City_dist
Pods_ranova1 <- CreateRanovaOutput_bootstrap(
  Pods_ranova.fam,
  Pods_ranova.pop,
  "Pods (Distance)")

## test transect
Pods_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Pods (Transect)")

flextable::save_as_html(Pods_ranova1,
                        Pods_ranova2,
                        path = here::here("./Reproductive_trait_analyses/Tables/Ranova/Pods_transects.html"))

# Date of first follicle-----

## test city_dist
### take out fam
full <- glmer(Julian_first_follicle^3 ~
                 Block +
                Year +
                (1|Population) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

first_pods_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 100,
          cl = makeCluster(rep("localhost", 6)))

tidy(first_pods_ranova.pop) # p = 0.0269 w/nsim = 100

# variance
get_pve(first_pods_ranova.pop) # 99.996


# test fam
full <- glmer(Julian_first_follicle^3 ~
                 Block +
                Year +
                (1|Population/Family) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
              nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

first_pods_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 100,
          cl = makeCluster(rep("localhost", 6)))

tidy(first_pods_ranova.fam) # Family: p ~ 0.0458

# variance
get_pve(first_pods_ranova.fam) # NA bc singular



## test transect
test_tr <-  glmer(Julian_first_follicle^3 ~
                 Block +
                Year +
                (1|Population/Family) +
                Transect_ID,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = poisson,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)


# merge Pop and Fam ranovas
## test City_dist
first_pods_ranova1 <- CreateRanovaOutput_bootstrap(
  first_pods_ranova.fam,
  first_pods_ranova.pop,
  "Date of first follicle (Distance)")

## test transect
first_pods_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Date of first follicle (Transect)")

flextable::save_as_html(first_pods_ranova1,
                        first_pods_ranova2,
                        path = here::here("./Reproductive_trait_analyses/Tables/Ranova/Date_first_follicle_transects.html"))

# Peduncles-----

## test city_dist
### take out fam
full <- glmer.nb(Peduncles ~
                 Block +
                Year +
                (1|Population) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

Peduncles_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(Peduncles_ranova.pop) # p = 0.127 w/nsim = 10

# variance
get_pve(Peduncles_ranova.pop) #  12.776



# test fam
full <- glmer.nb(Peduncles ~
                 Block +
                Year +
                (1|Population/Family) +
                City_dist,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

Peduncles_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 10,
          cl = makeCluster(rep("localhost", 6)))

tidy(Peduncles_ranova.fam) # Family: p ~ 0.134 w/nsim = 10

# variance
get_pve(Peduncles_ranova.fam) # 15.581


## test transect
test_tr <-  glmer.nb(Peduncles ~
                 Block +
                Year +
                (1|Population/Family) +
                Transect_ID,
              data = flowering %>%
                dplyr::filter(Transect_ID != "Rural"),
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)


# merge Pop and Fam ranovas
## test City_dist
Peduncles_ranova1 <- CreateRanovaOutput_bootstrap(
  Peduncles_ranova.fam,
  Peduncles_ranova.pop,
  "Mortality (Distance)")

## test transect
Peduncles_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Mortality (Transect)")

flextable::save_as_html(Peduncles_ranova1,
                        Peduncles_ranova2,
                        path = here::here("./Reproductive_trait_analyses/Tables/Ranova/Mortality_transects.html"))
```

# Anova
## Flowering success
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_urbscore_alt.png"))
```

## Total flowers/plant
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_urbscore_alt.png"))
```


## Mean flower size/inflorescence
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowerSize_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```


## Flowering time
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_urbscore_alt.png"))
```


## Flowering start
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_citydist.png"))
```

#### Urb_score
```{r}
# working with 3 dfs instead of 2, so tweaking function to reflect his

lapply(flstart_mods_best_u, tidy_anova) %>%
      lapply(., as.data.frame) %>%
      purrr::reduce(full_join) %>%
      replace(., is.na(.), "-") %>%
      dplyr::filter(Predictor != "(Intercept)") %>%
  dplyr::mutate(Sites = ifelse(row_number() == 5, "Urban Only",Sites)) %>%
    dplyr::mutate(Sites = ifelse(row_number() == 6, "Urban Only",Sites)) %>%
      dplyr::mutate(Sites = ifelse(row_number() == 7, "Urban Only",Sites)) %>%

      flextable::flextable() %>% 
      merge_v(j = "Response") %>% 
    #  merge_v(j = "Sites") %>% 
      valign(valign = "top") %>%
      flextable::autofit() %>%
      merge_at(i = 1:2, j = 2) %>% 
      merge_at(i = 3:4, j = 2) %>% 
      merge_at(i = 5:7, j = 2) %>% 
      align(j = c(1, 3), align = "left", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "header") %>%
      flextable::compose(i = 1, j = 4, part = "header",
                         value = as_paragraph("Ï‡", as_sup("2"))) %>%
      flextable::compose(i = 1, j = 5, part = "header",
                         value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
      #theme_booktabs()%>%
      fix_border_issues() %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringstart_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```



## Pods
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_urbscore_alt.png"))
```


## Date of first mature pod
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/first_Pods_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/first_Pods_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/first_Pods_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/first_Pods_urbscore_alt.png"))
```

## Peduncles
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Peduncles_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```

# R-squared values
```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

sink(here::here("./Reproductive_trait_analyses/Tables/Rsquare.txt"))
print(all_rsq)
sink()

# copied/pasted this into an excel file w/same name in same location and used text import wizard to separate data into neat columns
```

# Calculate heritability, Qst, and CVA
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"
## Calculate values per trait
```{r}
# Flowering success-----
update(
    flsucc_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
     flsucc_mods_best_c[[1]], REML = T) %>%
    sigma()

flsucc_mean <- reproduc %>%
  dplyr::summarize(Mean = mean(Flowered ,
                               na.rm = T)) %>%
  as.numeric() # can't calculate this because it's 0s x 1s... will be 0

qg_flsucc <- calc_quantgenvars( 0.70759 ,
                   0.54422 ,
                   resid_var,
                   NA,
                   "Flowering Success")


# Total flowers/plant -----
update(
    flowers_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flowers_mean <- flowering %>%
  dplyr::summarize(Mean = mean(total_flower_count ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     flowers_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flowers <- calc_quantgenvars( 9.2837e-05,
                   1.3463e-01,
                   resid_var,
                   flowers_mean,
                   "Total flowers/plant")


# Mean flower size/inflorescence -----
update(
    flsize_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flsize_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Overall_mean ,
                               na.rm = T)) %>%
  as.numeric()

qg_flsize <- calc_quantgenvars( 2.1742  ,
                   1.7583  ,
                   4.6466  ,
                   flsize_mean,
                   "Flower size")


# Flowering time -----
update(
    fltime_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

fltime_mean <- flowering %>%
  dplyr::summarize(Mean = mean(flowering_time_num ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     fltime_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_fltime <- calc_quantgenvars( 4.8319e-05,
                   1.7015e-01,
                   resid_var,
                   fltime_mean,
                   "Flowering Duration")


# Flowering start -----
update(
    flstart_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flstart_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_oldest_inflor ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     flstart_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flstart <- calc_quantgenvars( 4.0594e-07,
                   4.8286e-06,
                   resid_var,
                   flstart_mean,
                   "Flowering Start")


# Pods -----
update(
    pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Pods,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_pods <- calc_quantgenvars( 0.18623 ,
                   0.13145 ,
                   resid_var,
                   pods_mean,
                   "Follicles")


# Date of first mature pod -----
update(
    first_pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

first_pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_first_follicle,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     first_pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_first_pods <- calc_quantgenvars( 0.058337,
                   0.016403,
                   resid_var,
                   first_pods_mean,
                   "Date of first follicle 2 in")


# Peduncles -----
update(
    peduncles_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

peduncles_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Peduncles,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     peduncles_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_peduncles <- calc_quantgenvars( 0.19237 ,
                   0.25009 ,
                   resid_var,
                   peduncles_mean,
                   "Peduncles (Inflorescences)")


```

## Combine values into one table and export
```{r}
qg_joined <- list(
  qg_flsucc,
  qg_flowers,
  qg_flsize,
  qg_fltime,
  qg_flstart,
  qg_pods,
  qg_first_pods,
  qg_peduncles
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Reproductive_trait_analyses/Tables/quant_gen_reproduc.csv",
          row.names=FALSE)

```

