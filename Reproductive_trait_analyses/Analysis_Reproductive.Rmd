---
title: "Reproductive Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

NOTES:

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| All reproductive traits     |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("Reproductive_trait_analyses/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))
```

# Ranova- RETURN HERE
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
- Also using Pop/Fam instead of Pop:Fam or Pop/Fam_uniq like I did when making models earlier
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## Gradient / City_dist
# Anova
## Flowering success
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_urbscore_alt.png"))
```

## Total flowers/plant
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_urbscore_alt.png"))
```


## Mean flower size/inflorescence
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowerSize_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```


## Flowering time
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_urbscore_alt.png"))
```


## Flowering start
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_citydist.png"))
```

#### Urb_score
```{r}
# working with 3 dfs instead of 2, so tweaking function to reflect his

lapply(flstart_mods_best_u, tidy_anova) %>%
      lapply(., as.data.frame) %>%
      purrr::reduce(full_join) %>%
      replace(., is.na(.), "-") %>%
      dplyr::filter(Predictor != "(Intercept)") %>%
  dplyr::mutate(Sites = ifelse(row_number() == 5, "Urban Only",Sites)) %>%
    dplyr::mutate(Sites = ifelse(row_number() == 6, "Urban Only",Sites)) %>%
      dplyr::mutate(Sites = ifelse(row_number() == 7, "Urban Only",Sites)) %>%

      flextable::flextable() %>% 
      merge_v(j = "Response") %>% 
    #  merge_v(j = "Sites") %>% 
      valign(valign = "top") %>%
      flextable::autofit() %>%
      merge_at(i = 1:2, j = 2) %>% 
      merge_at(i = 3:4, j = 2) %>% 
      merge_at(i = 5:7, j = 2) %>% 
      align(j = c(1, 3), align = "left", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "header") %>%
      flextable::compose(i = 1, j = 4, part = "header",
                         value = as_paragraph("Ï‡", as_sup("2"))) %>%
      flextable::compose(i = 1, j = 5, part = "header",
                         value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
      #theme_booktabs()%>%
      fix_border_issues() %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringstart_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```



## Pods
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_urbscore_alt.png"))
```


## Peduncles
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Peduncles_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```

# Odds Ratio
## Flowering success: Compare urb vs rural populations (NS)
```{r}
Flowering_pops <- reproduc %>%
  dplyr::group_by(Population, Year, Urb_Rur) %>%
  dplyr::summarise(Pop_flowered = sum(Flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_cumulative <- Flowering_pops %>%
  dplyr::group_by(Population, Urb_Rur) %>%
  dplyr::summarise(Pop_flowered = sum(Pop_flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_urbrur_cumulative <- Flowering_pops_cumulative %>%
  dplyr::group_by(Urb_Rur) %>%
  dplyr::summarise(Pops_flowered = sum(Pop_flowered),
                   Pops_total = n_distinct(Population)
                   ) %T>%
  print()


Flowered_ttest2 <- matrix(c(
  as.integer(Flowering_pops_urbrur_cumulative[1,2]),
  
  as.integer(Flowering_pops_urbrur_cumulative[2,2]),
  
  as.integer(Flowering_pops_urbrur_cumulative[1,3]) - as.integer(Flowering_pops_urbrur_cumulative[1,2]),
  
  as.integer(Flowering_pops_urbrur_cumulative[2,3]) - as.integer(Flowering_pops_urbrur_cumulative[2,2])
  ),
  
  nrow = 2,
  dimnames = list(
    c("Rural", "Urban"),
    c("Flowered", "Didn't Flower"))) %T>%
  print()

fisher.test(Flowered_ttest2, alternative = "two.sided")
# odds ratio = 2.136676 
# p = 0.34
# Small effect size

chisq.test(Flowered_ttest2)
# X-squared = 0.5472, df = 1, p-value = 0.4595

```


## Flowering success: Compare corridor vs non-corridor pops (NS)
```{r}
Flowering_pops_urban <- reproduc %>%
  dplyr::group_by(Population, Year, Transect_ID) %>%
  dplyr::filter(Transect_ID != "Rural") %>%
  dplyr::summarise(Pop_flowered = sum(Flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_urban_cumulative <- Flowering_pops_urban %>%
  dplyr::group_by(Population, Transect_ID) %>%
  dplyr::summarise(Pop_flowered = sum(Pop_flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_transects_cumulative <- Flowering_pops_urban_cumulative %>%
  dplyr::group_by(Transect_ID) %>%
  dplyr::summarise(Pops_flowered = sum(Pop_flowered),
                   Pops_total = n_distinct(Population)
                   ) %T>%
  print()


Flowered_ttest2 <- matrix(c(
  as.integer(Flowering_pops_transects_cumulative[1,2]),
  
  as.integer(Flowering_pops_transects_cumulative[2,2]),
  
  as.integer(Flowering_pops_transects_cumulative[1,3]) - as.integer(Flowering_pops_transects_cumulative[1,2]),
  
  as.integer(Flowering_pops_transects_cumulative[2,3]) - as.integer(Flowering_pops_transects_cumulative[2,2])
  ),
  
  nrow = 2,
  dimnames = list(
    c("Non-Corridor", "Corridor"),
    c("Flowered", "Didn't Flower"))) %T>%
  print()

fisher.test(Flowered_ttest2, alternative = "two.sided")
# odds ratio = 0.8501017  
# p = 1
# Small effect size

chisq.test(Flowered_ttest2)
# X-squared = 1.3188e-31, df = 1, p-value = 1

```

# R-squared values
```{r}
# took out lists 4 and 5 from all_models- the herbivory ones- because R.squaredGLMM can't intake models with beta family
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)
```
# Calculate heritability, Qst, and CVA- UPDATE
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"
## Calculate values per trait
```{r}
# # Latex-----
# update(
#     latex_mods_best_c[[1]], 
#     .~. -City_dist, # omitting city_dist
#     REML = T) %>% VarCorr()
# 
# latex_mean <- latex %>%
#   dplyr::summarize(Mean = mean(Latex_weight_mg,
#                                na.rm = T)) %>%
#   as.numeric()
# 
# qg_latex <- calc_quantgenvars( 0.086644,
#                    0.079411,
#                    0.387388,
#                    latex_mean,
#                    "Latex")
# 
# 
# # Herbivory, before flowering: Binomial-----
# 
# update(
#     herb_e_bin_mods_best_c[[1]], 
#     .~. -City_dist, # omitting city_dist
#     REML = T) %>% VarCorr()
# 
# # residual variance:
# resid_var <- update(
#     herb_e_bin_mods_best_c[[1]], REML = T) %>%
#     sigma()
# 
# herb_e_bin_mean <- herbivory %>%
#   dplyr::summarize(Mean = mean(Herbivory_mean_early_binary,
#                                na.rm = T)) %>%
#   as.numeric()
# 
# qg_herb_e_bin <- calc_quantgenvars(  1.8027e-04,
#                     2.1094e-05,
#                    resid_var,
#                    herb_e_bin_mean,
#                    "Chance of herbivory (before flowering)")
# 
# 
# # Herbivory, before flowering: quantitative-----
# 
# update(
#     herb_e_quant_mods_best_c[[1]], 
#     .~. -City_dist, # omitting city_dist
#     REML = T) %>% VarCorr()
# 
# herb_e_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_early_binary == 1) %>%
#   dplyr::summarize(Mean = mean(Herbivory_mean_early,
#                                na.rm = T)) %>%
#   as.numeric()
# 
# qg_herb_e_quant <- calc_quantgenvars( 0.076138  ,
#                     0.068185  ,
#                    1.230037 ,
#                    herb_e_quant_mean,
#                    "Herbivory (before flowering)")
# 
# # Herbivory, after flowering: Binomial-----
# 
# update(
#     herb_l_bin_mods_best_c[[1]], 
#     .~. -City_dist, # omitting city_dist
#     REML = T) %>% VarCorr()
# 
# # residual variance:
# resid_var <- update(
#     herb_l_bin_mods_best_c[[1]], REML = T) %>%
#     sigma()
# 
# herb_l_bin_mean <- herbivory %>%
#   dplyr::summarize(Mean = mean(Herbivory_mean_late_binary,
#                                na.rm = T)) %>%
#   as.numeric()
# 
# qg_herb_l_bin <- calc_quantgenvars(2.3267e-01,
#                    6.1084e-05,
#                    resid_var,
#                    herb_l_bin_mean,
#                    "Chance of herbivory (after flowering)")
# 
# 
# 
# # Herbivory, after flowering: quantitative-----
# 
# update(
#     herb_l_quant_mods_best_c[[1]], 
#     .~. -City_dist, # omitting city_dist
#     REML = T) %>% VarCorr()
# 
# herb_l_quant_mean <- herbivory %>% dplyr::filter(Herbivory_mean_late_binary == 1) %>%
#   dplyr::summarize(Mean = mean(Herbivory_mean_late,
#                                na.rm = T)) %>%
#   as.numeric()
# 
# qg_herb_l_quant <- calc_quantgenvars( 1.5181e-01 ,
#                    8.5992e-05,
#                   1.2381e+00,
#                    herb_l_quant_mean,
#                    "Herbivory (after flowering)")
# 
# 
# # Weevil: Binomial-----
# 
# update(
#     weev_bin_mods_best_c[[1]], 
#     .~. -City_dist, # omitting city_dist
#     REML = T) %>% VarCorr()
# 
# # residual variance:
# resid_var <- update(
#     weev_bin_mods_best_c[[1]], REML = T) %>%
#     sigma()
# 
# weev_bin_mean <- weevil %>%
#   dplyr::summarize(Mean = mean(Scar_binary ,
#                                na.rm = T)) %>%
#   as.numeric()
# 
# qg_weev_bin <- calc_quantgenvars(0.54935944  ,
#                      0.00015261,
#                    resid_var,
#                    weev_bin_mean,
#                    "Chance of weevil damage")
# 
# 
# # Weevil damage: quantitative-----
# 
# update(
#     weev_quant_mods_best_c[[1]], 
#     .~. -City_dist, # omitting city_dist
#     REML = T) %>% VarCorr()
# 
# weev_quant_mean <- weevil %>%
#   dplyr::filter(Scar_length_cm > 0) %>%
#   dplyr::summarize(Mean = mean(Scar_length_cm,
#                                na.rm = T)) %>%
#   as.numeric()
# 
# qg_weev_quant <- calc_quantgenvars( 0.20088 ,
#                   0.10085 ,
#                  1.05936 ,
#                    weev_quant_mean,
#                    "Weevil scar length")

```

## Combine values into one table and export
```{r}
qg_joined <- list(
  # qg_latex,
  #                 qg_herb_e_bin,
  #                 qg_herb_e_quant,
  #                 qg_herb_l_bin,
  #                 qg_herb_l_quant,
  #                 qg_weev_bin,
  #                 qg_weev_quant
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Reproductive_trait_analyses/Tables/quant_gen_defense.csv",
          row.names=FALSE)

```

