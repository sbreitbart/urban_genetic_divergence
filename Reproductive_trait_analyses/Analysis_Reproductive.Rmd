---
title: "Reproductive Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

NOTES:

+-----------------------------+-----------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data | 2022 Data |
+=============================+:=========:+:=========:+:=========:+:=========:+
| All reproductive traits     |           | X         | X         | X         |
+-----------------------------+-----------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("Reproductive_trait_analyses/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))
```

# Ranova
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## gaussian distribution models
### Gradient
```{r}
# mean flower size-----
# 2020-----
flsize_ranova_mod1 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod1)

# export
ranova_2step(flsize_ranova_mod1,
             "Flower size: 2020",
             "./Reproductive_trait_analyses/Tables/Ranova/flower_size_2020.docx")


# 2021-----
flsize_ranova_mod2 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod2)

# export
ranova_2step(flsize_ranova_mod2,
             "Flower size: 2021",
             "./Reproductive_trait_analyses/Tables/Ranova/flower_size_2021.docx")



# 2022-----
flsize_ranova_mod3 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2022),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod3)

# export
ranova_2step(flsize_ranova_mod3,
             "Flower size: 2022",
             "./Reproductive_trait_analyses/Tables/Ranova/flower_size_2022.docx")
```

### Urban subtransects
```{r}
# mean flower size-----
# 2020-----
flsize_ranova_mod1 <- lmer(Overall_mean ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod1)

ranova_transect(flsize_ranova_mod1,
                "Flower size: 2020",
                "./Reproductive_trait_analyses/Tables/Ranova/flsize_transects_2020.docx")



# 2021-----
flsize_ranova_mod2 <- lmer(Overall_mean ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod2)

ranova_transect(flsize_ranova_mod2,
                "Flower size: 2021",
                "./Reproductive_trait_analyses/Tables/Ranova/flsize_transects_2021.docx")


# 2022-----
flsize_ranova_mod3 <- lmer(Overall_mean ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2022),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod3)

ranova_transect(flsize_ranova_mod3,
                "Flower size: 2022",
                "./Reproductive_trait_analyses/Tables/Ranova/flsize_transects_2022.docx")

```

## non-gaussian models
### Gradient
```{r}
# I think I should disregard some 2020 results b/c so few plants flowered that year
############################################
# Flowering success----- 
# 2020-----
flsucc_ranova1 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2020),

                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova1)

pb_ranova_2step(flsucc_ranova1,
          "Flowering success: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2020.docx")

# 2021-----
flsucc_ranova2 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2021),
                
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova2)

pb_ranova_2step(flsucc_ranova2,
          "Flowering success: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2021.docx")

# 2022-----
flsucc_ranova3 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2022),
                 
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova3)

pb_ranova_2step(flsucc_ranova3,
          "Flowering success: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2022.docx")


# Flowers/inflor-----
# 2020-----
flowers_ranova1 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                     
                            na.action = na.exclude)

# performance::check_model(flowers_ranova1)

pb_ranova_2step(flowers_ranova1,
          "Mean flower count: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2020.docx")

# 2021-----
flowers_ranova2 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                         
                            na.action = na.exclude)

# performance::check_model(flowers_ranova2)

pb_ranova_2step(flowers_ranova2,
          "Mean flower count: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2021.docx")

# 2022-----
flowers_ranova3 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                     
                            na.action = na.exclude)

# performance::check_model(flowers_ranova3)

pb_ranova_2step(flowers_ranova3,
          "Mean flower count: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2022.docx")

# Flowering time-----
# 2020-----
fltime_ranova1 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                    
                            na.action = na.exclude)

# performance::check_model(fltime_ranova1)

pb_ranova_2step(fltime_ranova1,
          "Flowering duration: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2020.docx")



# 2021-----
fltime_ranova2 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                     
                            na.action = na.exclude)

# performance::check_model(fltime_ranova2)

pb_ranova_2step(fltime_ranova2,
          "Flowering duration: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2021.docx")




# 2022-----
fltime_ranova3 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                    
                            na.action = na.exclude)

# performance::check_model(fltime_ranova3)

pb_ranova_2step(fltime_ranova3,
          "Flowering duration: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2022.docx")

# Flowering start-----
# 2020-----
flstart_ranova1 <- glmer(Julian_oldest_inflor-170 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova1)
summary(flstart_ranova1)

pb_ranova_2step(flstart_ranova1,
          "Flowering start: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2020.docx")

# 2021-----
flstart_ranova2 <- glmer(Julian_oldest_inflor-170 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova2)

pb_ranova_2step(flstart_ranova2,
          "Flowering start: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2021.docx")

# 2022-----
flstart_ranova3 <- glmer(Julian_oldest_inflor-170 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova3)

pb_ranova_2step(flstart_ranova3,
          "Flowering start: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2022.docx")


# Pods-----
# 2020-----
pods_ranova1 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude)

# performance::check_model(pods_ranova1)

pb_ranova_2step(pods_ranova1,
          "Follicles: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2020.docx")


# 2021-----
pods_ranova2 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

# performance::check_model(pods_ranova2)

pb_ranova_2step(pods_ranova2,
          "Follicles: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2021.docx")

# 2022-----
pods_ranova3 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                   
                            na.action = na.exclude)

# performance::check_model(pods_ranova3)

pb_ranova_2step(pods_ranova3,
          "Follicles: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2022.docx")


# Date of first follicle-----

# copied from transects chunk below:
summary(flowering$Julian_first_follicle) # min is 201. I've been having issues getting these models to not be singular, and subtracting 200 from the response helps a lot. I think the issue is that the numbers are so big and could have the min subtracted to keep the range from ~1-45 vs. 201-245.

# 2020-----
firstpod_ranova1 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(firstpod_ranova1)

pb_ranova_2step(firstpod_ranova1,
          "First follicle: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/first_pods_2020.docx")


# 2021-----
firstpod_ranova2 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021 &
                                is.na(Julian_first_follicle) == FALSE),
                           na.action = na.exclude,
                             family = poisson)

# performance::check_model(firstpod_ranova2)

pb_ranova_2step(firstpod_ranova2,
          "First follicle: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/first_pods_2021.docx")

# 2022-----
firstpod_ranova3 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                               is.na(Julian_first_follicle) == FALSE),
                           na.action = na.exclude,
                          family = poisson)

# performance::check_model(firstpod_ranova3)

pb_ranova_2step(firstpod_ranova3,
          "First follicle: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/first_pods_2022.docx")

# Peduncles-----
# 2020-----
peduncles_ranova1 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova1)

pb_ranova_2step(peduncles_ranova1,
          "Inflorescences: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2020.docx")


# 2021-----
peduncles_ranova2 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                  
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova2)

pb_ranova_2step(peduncles_ranova2,
          "Inflorescences: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2021.docx")


# 2022-----
peduncles_ranova3 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova3)

pb_ranova_2step(peduncles_ranova3,
          "Inflorescences: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2022.docx")

```

### Urb subtransects
```{r}
# Flowering success-----

# 2020-----
flsucc_ranova1 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova1)

pb_ranova_transects(flsucc_ranova1,
          "Flowering success: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2020_transects.docx")

# 2021-----
flsucc_ranova2 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                  
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova2)

pb_ranova_transects(flsucc_ranova2,
          "Flowering success: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2021_transects.docx")

# 2022-----
flsucc_ranova3 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                 
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova3)

pb_ranova_transects(flsucc_ranova3,
          "Flowering success: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2022_transects.docx")


# Flowers/inflor-----
# 2020-----
flowers_ranova1 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude)

# performance::check_model(flowers_ranova1)

pb_ranova_transects(flowers_ranova1,
          "Mean flower count: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2020_transects.docx")

# 2021-----
flowers_ranova2 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                 
                            na.action = na.exclude)

# performance::check_model(flowers_ranova2)

pb_ranova_transects(flowers_ranova2,
          "Mean flower count: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2021_transects.docx")

# 2022-----
flowers_ranova3 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                 
                            na.action = na.exclude)

# performance::check_model(flowers_ranova3)

pb_ranova_transects(flowers_ranova3,
          "Mean flower count: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2022_transects.docx")


# Flowering time-----
# 2020-----
fltime_ranova1 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                            na.action = na.exclude  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

# performance::check_model(fltime_ranova1)

pb_ranova_transects(fltime_ranova1,
          "Flowering duration: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2020_transects.docx")



# 2021-----
fltime_ranova2 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                  
                           na.action = na.exclude)

# performance::check_model(fltime_ranova2)

pb_ranova_transects(fltime_ranova2,
          "Flowering duration: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2021_transects.docx")


# 2022-----
fltime_ranova3 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                            na.action = na.exclude  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

# performance::check_model(fltime_ranova3)

pb_ranova_transects(fltime_ranova3,
          "Flowering duration: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2022_transects.docx")


# Flowering start-----
# 2020-----
flstart_ranova1 <- glmer(Julian_oldest_inflor ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova1)

pb_ranova_transects(flstart_ranova1,
          "Flowering start: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2020_transects.docx")


# 2021-----
flstart_ranova2 <- glmer(Julian_oldest_inflor ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova2)

pb_ranova_transects(flstart_ranova2,
          "Flowering start: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2021_transects.docx")

# 2022-----
flstart_ranova3 <- glmer(Julian_oldest_inflor ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
               
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova3)

pb_ranova_transects(flstart_ranova3,
          "Flowering start: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2022_transects.docx")



# Pods-----
# 2020-----
pods_ranova1 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude)

# performance::check_model(pods_ranova1)

pb_ranova_transects(pods_ranova1,
          "Pods: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2020_transects.docx")

# 2021-----
pods_ranova2 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                
                            na.action = na.exclude)

# performance::check_model(pods_ranova2)

pb_ranova_transects(pods_ranova2,
          "Pods: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2021_transects.docx")

# 2022-----
pods_ranova3 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
               
                            na.action = na.exclude)

# performance::check_model(pods_ranova3)

pb_ranova_transects(pods_ranova3,
          "Pods: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2022_transects.docx")


# Date of first follicle-----
# 2020-----

summary(flowering$Julian_first_follicle) # min is 201. I've been having issues getting these models to not be singular, and subtracting 200 from the response helps a lot. I think the issue is that the numbers are so big and could have the min subtracted to keep the range from ~1-45 vs. 201-245.


firstpod_ranova <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                    dplyr::filter(is.na(Julian_first_follicle) == F &
                                               Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude,
                             family = poisson) # singular but I think it's because it's a tiny sample size

# performance::check_model(firstpod_ranova)

pb_ranova_transects(firstpod_ranova,
          "Date of first follicle: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/Date_first_follicle_2020_transects.docx")


# 2021-----
firstpod_ranova2 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                    dplyr::filter(is.na(Julian_first_follicle) == F &
                                    Transect_ID != "Rural" &
                                    Year == 2021),
               
                    na.action = na.exclude,
                             family = poisson)

# performance::check_model(firstpod_ranova2)

pb_ranova_transects(firstpod_ranova2,
          "Date of first follicle: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/Date_first_follicle_2021_transects.docx")

# 2022-----
firstpod_ranova3 <- glmer((Julian_first_follicle-200) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>% 
                            dplyr::filter(
                              is.na(Julian_first_follicle) == F &
                                Transect_ID != "Rural" &
                                Year == 2022),
                          na.action = na.exclude,
                    # add more iterations
                control=glmerControl(optCtrl=list(maxfun=2e5)),
                family = poisson)

# performance::check_model(firstpod_ranova3)

pb_ranova_transects(firstpod_ranova3,
          "Date of first follicle: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/Date_first_follicle_2022_transects_test.docx")



# Peduncles-----
# 2020-----
peduncles_ranova1 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
             
                             na.action = na.exclude)

performance::check_model(peduncles_ranova1)

pb_ranova_transects(peduncles_ranova1,
          "Peduncles: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2020_transects.docx")


# 2021-----
peduncles_ranova2 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021), 
                
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova2)

pb_ranova_transects(peduncles_ranova2,
          "Peduncles: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2021_transects.docx")

# 2022-----
peduncles_ranova3 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                           na.action = na.exclude)

# performance::check_model(peduncles_ranova3)



pb_ranova_transects(peduncles_ranova3,
          "Peduncles: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2022_transects.docx")

```

# Anova
## Flowering success
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_urbscore_alt.png"))
```

## Mean Flowers/inflor
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_urbscore_alt.png"))
```


## Mean flower size/inflorescence
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowerSize_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```


## Flowering time
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_urbscore_alt.png"))
```


## Flowering start
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_citydist.png"))
```

#### Urb_score
```{r}
# working with 3 dfs instead of 2, so tweaking function to reflect his

lapply(flstart_mods_best_u, tidy_anova) %>%
      lapply(., as.data.frame) %>%
      purrr::reduce(full_join) %>%
      replace(., is.na(.), "-") %>%
      dplyr::filter(Predictor != "(Intercept)") %>%
  dplyr::mutate(Sites = ifelse(row_number() == 5, "Urban Only",Sites)) %>%
    dplyr::mutate(Sites = ifelse(row_number() == 6, "Urban Only",Sites)) %>%
      dplyr::mutate(Sites = ifelse(row_number() == 7, "Urban Only",Sites)) %>%

      flextable::flextable() %>% 
      merge_v(j = "Response") %>% 
    #  merge_v(j = "Sites") %>% 
      valign(valign = "top") %>%
      flextable::autofit() %>%
      merge_at(i = 1:2, j = 2) %>% 
      merge_at(i = 3:4, j = 2) %>% 
      merge_at(i = 5:7, j = 2) %>% 
      align(j = c(1, 3), align = "left", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "header") %>%
      flextable::compose(i = 1, j = 4, part = "header",
                         value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 1, j = 5, part = "header",
                         value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
      #theme_booktabs()%>%
      fix_border_issues() %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringstart_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```



## Pods
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_urbscore_alt.png"))
```


## Date of first mature pod
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/first_Pods_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/first_Pods_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/first_Pods_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/first_Pods_urbscore_alt.png"))
```

## Peduncles
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Peduncles_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```

# R-squared values
```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

sink(here::here("./Reproductive_trait_analyses/Tables/Rsquaretest.txt"))
print(all_rsq)
sink()

# copied/pasted this into an excel file w/same name in same location and used text import wizard to separate data into neat columns
```

# Calculate heritability, Qst, and CVA
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"
## Calculate values per trait
```{r}
# Flowering success-----
update(
    flsucc_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
     flsucc_mods_best_c[[1]], REML = T) %>%
    sigma()

flsucc_mean <- reproduc %>%
  dplyr::summarize(Mean = mean(Flowered ,
                               na.rm = T)) %>%
  as.numeric() # can't calculate this because it's 0s x 1s... will be 0

qg_flsucc <- calc_quantgenvars( 0.70759 ,
                   0.54422 ,
                   resid_var,
                   NA,
                   "Flowering Success")


# Mean flowers/inflor -----
update(
    flowers_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flowers_mean <- flowering %>%
  dplyr::summarize(Mean = mean(mean_flower_count ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     flowers_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flowers <- calc_quantgenvars(0.085598,
                   0.129033,
                   resid_var,
                   flowers_mean,
                   "Mean flowers/inflor")


# Mean flower size/inflorescence -----
update(
    flsize_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flsize_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Overall_mean ,
                               na.rm = T)) %>%
  as.numeric()

qg_flsize <- calc_quantgenvars( 2.1742  ,
                   1.7583  ,
                   4.6466  ,
                   flsize_mean,
                   "Flower size")


# Flowering time -----
update(
    fltime_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

fltime_mean <- flowering %>%
  dplyr::summarize(Mean = mean(flowering_time_num ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     fltime_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_fltime <- calc_quantgenvars( 4.8319e-05,
                   1.7015e-01,
                   resid_var,
                   fltime_mean,
                   "Flowering Duration")


# Flowering start -----
update(
    flstart_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flstart_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_oldest_inflor ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     flstart_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flstart <- calc_quantgenvars( 4.0594e-07,
                   4.8286e-06,
                   resid_var,
                   flstart_mean,
                   "Flowering Start")


# Pods -----
update(
    pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Pods,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_pods <- calc_quantgenvars( 0.18623 ,
                   0.13145 ,
                   resid_var,
                   pods_mean,
                   "Follicles")


# Date of first mature pod -----
update(
    first_pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

first_pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_first_follicle,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     first_pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_first_pods <- calc_quantgenvars( 0.058337,
                   0.016403,
                   resid_var,
                   first_pods_mean,
                   "Date of first follicle 2 in")


# Peduncles -----
update(
    peduncles_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

peduncles_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Peduncles,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     peduncles_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_peduncles <- calc_quantgenvars( 0.19237 ,
                   0.25009 ,
                   resid_var,
                   peduncles_mean,
                   "Peduncles (Inflorescences)")


```

## Combine values into one table and export
```{r}
qg_joined <- list(
  qg_flsucc,
  qg_flowers,
  qg_flsize,
  qg_fltime,
  qg_flstart,
  qg_pods,
  qg_first_pods,
  qg_peduncles
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Reproductive_trait_analyses/Tables/quant_gen_reproduc.csv",
          row.names=FALSE)

```