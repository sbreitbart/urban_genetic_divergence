# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("Reproductive_trait_analyses/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))
```

# Ranova
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## gaussian distribution models
### Gradient
```{r}
# mean flower size-----
# 2020-----
flsize_ranova_mod1 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod1)

# export
ranova_2step(flsize_ranova_mod1,
             "Flower size: 2020",
             "./Reproductive_trait_analyses/Tables/Ranova/flower_size_2020.docx")


# 2021-----
flsize_ranova_mod2 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod2)

# export
ranova_2step(flsize_ranova_mod2,
             "Flower size: 2021",
             "./Reproductive_trait_analyses/Tables/Ranova/flower_size_2021.docx")



# 2022-----
flsize_ranova_mod3 <- lmer(Overall_mean ~
                             Block +
                             (1|Population/Family), 
                           data = flowering %>%
                             dplyr::filter(Year == 2022),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod3)

# export
ranova_2step(flsize_ranova_mod3,
             "Flower size: 2022",
             "./Reproductive_trait_analyses/Tables/Ranova/flower_size_2022.docx")
```

### Urban subtransects
```{r}
# mean flower size-----
# 2020-----
flsize_ranova_mod1 <- lmer(Overall_mean ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod1)

ranova_transect(flsize_ranova_mod1,
                "Flower size: 2020",
                "./Reproductive_trait_analyses/Tables/Ranova/flsize_transects_2020.docx")



# 2021-----
flsize_ranova_mod2 <- lmer(Overall_mean ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod2)

ranova_transect(flsize_ranova_mod2,
                "Flower size: 2021",
                "./Reproductive_trait_analyses/Tables/Ranova/flsize_transects_2021.docx")


# 2022-----
flsize_ranova_mod3 <- lmer(Overall_mean ~
                                   (1|Population/Family) +
                                   Block,
                             data = flowering %>%
                      dplyr::filter(
                          Transect_ID != "Rural" &
                          Year == 2022),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(flsize_ranova_mod3)

ranova_transect(flsize_ranova_mod3,
                "Flower size: 2022",
                "./Reproductive_trait_analyses/Tables/Ranova/flsize_transects_2022.docx")

```

## non-gaussian models
### Gradient
```{r}
# I think I should disregard some 2020 results b/c so few plants flowered that year
############################################
# Flowering success----- 
# 2020-----
flsucc_ranova1 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2020),

                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova1)

pb_ranova_2step(flsucc_ranova1,
          "Flowering success: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2020.docx")

# 2021-----
flsucc_ranova2 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2021),
                
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova2)

pb_ranova_2step(flsucc_ranova2,
          "Flowering success: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2021.docx")

# 2022-----
flsucc_ranova3 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2022),
                 
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova3)

pb_ranova_2step(flsucc_ranova3,
          "Flowering success: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2022.docx")


# Flowers/inflor-----
# 2020-----
flowers_ranova1 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                     
                            na.action = na.exclude)

# performance::check_model(flowers_ranova1)

pb_ranova_2step(flowers_ranova1,
          "Mean flower count: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2020.docx")

# 2021-----
flowers_ranova2 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                         
                            na.action = na.exclude)

# performance::check_model(flowers_ranova2)

pb_ranova_2step(flowers_ranova2,
          "Mean flower count: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2021.docx")

# 2022-----
flowers_ranova3 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                     
                            na.action = na.exclude)

# performance::check_model(flowers_ranova3)

pb_ranova_2step(flowers_ranova3,
          "Mean flower count: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2022.docx")

# Flowering time-----
# 2020-----
fltime_ranova1 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                    
                            na.action = na.exclude)

# performance::check_model(fltime_ranova1)

pb_ranova_2step(fltime_ranova1,
          "Flowering duration: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2020.docx")



# 2021-----
fltime_ranova2 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                     
                            na.action = na.exclude)

# performance::check_model(fltime_ranova2)

pb_ranova_2step(fltime_ranova2,
          "Flowering duration: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2021.docx")




# 2022-----
fltime_ranova3 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                    
                            na.action = na.exclude)

# performance::check_model(fltime_ranova3)

pb_ranova_2step(fltime_ranova3,
          "Flowering duration: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2022.docx")

# Flowering start-----
# 2020-----
flstart_ranova1 <- glmer(Julian_oldest_inflor-170 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova1)
summary(flstart_ranova1)

pb_ranova_2step(flstart_ranova1,
          "Flowering start: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2020.docx")

# 2021-----
flstart_ranova2 <- glmer(Julian_oldest_inflor-170 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova2)

pb_ranova_2step(flstart_ranova2,
          "Flowering start: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2021.docx")

# 2022-----
flstart_ranova3 <- glmer(Julian_oldest_inflor-170 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova3)

pb_ranova_2step(flstart_ranova3,
          "Flowering start: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2022.docx")


# Pods-----
# 2020-----
pods_ranova1 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude)

# performance::check_model(pods_ranova1)

pb_ranova_2step(pods_ranova1,
          "Follicles: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2020.docx")


# 2021-----
pods_ranova2 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

# performance::check_model(pods_ranova2)

pb_ranova_2step(pods_ranova2,
          "Follicles: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2021.docx")

# 2022-----
pods_ranova3 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                   
                            na.action = na.exclude)

# performance::check_model(pods_ranova3)

pb_ranova_2step(pods_ranova3,
          "Follicles: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2022.docx")


# Date of first follicle-----

# copied from transects chunk below:
summary(flowering$Julian_first_follicle) # min is 201. I've been having issues getting these models to not be singular, and subtracting 200 from the response helps a lot. I think the issue is that the numbers are so big and could have the min subtracted to keep the range from ~1-45 vs. 201-245.

# 2020-----
firstpod_ranova1 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(firstpod_ranova1)

pb_ranova_2step(firstpod_ranova1,
          "First follicle: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/first_pods_2020.docx")


# 2021-----
firstpod_ranova2 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021 &
                                is.na(Julian_first_follicle) == FALSE),
                           na.action = na.exclude,
                             family = poisson)

# performance::check_model(firstpod_ranova2)

pb_ranova_2step(firstpod_ranova2,
          "First follicle: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/first_pods_2021.docx")

# 2022-----
# when I remove population (which summary shows has a variance of 0), the model isn't singular anymore. I think that's the key here
firstpod_ranova3 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022 & is.na(Julian_first_follicle) == FALSE),
                           na.action = na.exclude,
                          family = poisson)

# performance::check_model(firstpod_ranova3)

summary(firstpod_ranova3)

pb_ranova_2step(firstpod_ranova3,
          "First follicle: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/first_pods_2022.docx")

# Peduncles-----
# 2020-----
peduncles_ranova1 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova1)

pb_ranova_2step(peduncles_ranova1,
          "Inflorescences: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2020.docx")


# 2021-----
peduncles_ranova2 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2021),
                  
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova2)

pb_ranova_2step(peduncles_ranova2,
          "Inflorescences: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2021.docx")


# 2022-----
peduncles_ranova3 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova3)

pb_ranova_2step(peduncles_ranova3,
          "Inflorescences: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2022.docx")

```

### Urb subtransects
```{r}
# Flowering success-----
# 2020-----
flsucc_ranova1 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova1)

pb_ranova_transects(flsucc_ranova1,
          "Flowering success: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2020_transects.docx")

# 2021-----
flsucc_ranova2 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                  
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova2)

pb_ranova_transects(flsucc_ranova2,
          "Flowering success: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2021_transects.docx")

# 2022-----
flsucc_ranova3 <- glmer(Flowered ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                 
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(flsucc_ranova3)

pb_ranova_transects(flsucc_ranova3,
          "Flowering success: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_success_2022_transects.docx")


# Flowers/inflor-----
# 2020-----
flowers_ranova1 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude)

# performance::check_model(flowers_ranova1)

pb_ranova_transects(flowers_ranova1,
          "Mean flower count: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2020_transects.docx")

# 2021-----
flowers_ranova2 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                 
                            na.action = na.exclude)

# performance::check_model(flowers_ranova2)

pb_ranova_transects(flowers_ranova2,
          "Mean flower count: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2021_transects.docx")

# 2022-----
flowers_ranova3 <- glmer.nb(mean_flower_count ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                 
                            na.action = na.exclude)

# performance::check_model(flowers_ranova3)

pb_ranova_transects(flowers_ranova3,
          "Mean flower count: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowercount_2022_transects.docx")


# Flowering time-----
# 2020-----
fltime_ranova1 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                            na.action = na.exclude  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

# performance::check_model(fltime_ranova1)

pb_ranova_transects(fltime_ranova1,
          "Flowering duration: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2020_transects.docx")



# 2021-----
fltime_ranova2 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                  
                           na.action = na.exclude)

# performance::check_model(fltime_ranova2)

pb_ranova_transects(fltime_ranova2,
          "Flowering duration: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2021_transects.docx")


# 2022-----
fltime_ranova3 <- glmer.nb(as.numeric(flowering_time) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                            na.action = na.exclude  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))

# performance::check_model(fltime_ranova3)

pb_ranova_transects(fltime_ranova3,
          "Flowering duration: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowertime_2022_transects.docx")


# Flowering start-----
# 2020-----
flstart_ranova1 <- glmer(Julian_oldest_inflor ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova1)

pb_ranova_transects(flstart_ranova1,
          "Flowering start: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2020_transects.docx")


# 2021-----
flstart_ranova2 <- glmer(Julian_oldest_inflor ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova2)

pb_ranova_transects(flstart_ranova2,
          "Flowering start: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2021_transects.docx")

# 2022-----
flstart_ranova3 <- glmer(Julian_oldest_inflor ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
               
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(flstart_ranova3)

pb_ranova_transects(flstart_ranova3,
          "Flowering start: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/flowering_start_2022_transects.docx")



# Pods-----
# 2020-----
pods_ranova1 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude)

# performance::check_model(pods_ranova1)

pb_ranova_transects(pods_ranova1,
          "Pods: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2020_transects.docx")

# 2021-----
pods_ranova2 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021),
                
                            na.action = na.exclude)

# performance::check_model(pods_ranova2)

pb_ranova_transects(pods_ranova2,
          "Pods: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2021_transects.docx")

# 2022-----
pods_ranova3 <- glmer.nb(Pods ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
               
                            na.action = na.exclude)

# performance::check_model(pods_ranova3)

pb_ranova_transects(pods_ranova3,
          "Pods: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/pods_2022_transects.docx")


# Date of first follicle-----
# 2020-----

summary(flowering$Julian_first_follicle) # min is 201. I've been having issues getting these models to not be singular, and subtracting 200 from the response helps a lot. I think the issue is that the numbers are so big and could have the min subtracted to keep the range from ~1-45 vs. 201-245.


firstpod_ranova <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                    dplyr::filter(is.na(Julian_first_follicle) == F &
                                               Transect_ID != "Rural" &
                                               Year == 2020),
                 
                            na.action = na.exclude,
                             family = poisson) # singular but I think it's because it's a tiny sample size

# performance::check_model(firstpod_ranova)

pb_ranova_transects(firstpod_ranova,
          "Date of first follicle: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/Date_first_follicle_2020_transects.docx")


# 2021-----
firstpod_ranova2 <- glmer(Julian_first_follicle-200 ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                    dplyr::filter(is.na(Julian_first_follicle) == F &
                                    Transect_ID != "Rural" &
                                    Year == 2021),
               
                    na.action = na.exclude,
                             family = poisson)

# performance::check_model(firstpod_ranova2)

pb_ranova_transects(firstpod_ranova2,
          "Date of first follicle: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/Date_first_follicle_2021_transects.docx")

# 2022-----
firstpod_ranova3 <- glmer((Julian_first_follicle-200) ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>% 
                            dplyr::filter(
                              is.na(Julian_first_follicle) == F &
                                Transect_ID != "Rural" &
                                Year == 2022),
                          na.action = na.exclude,
                    # add more iterations
                control=glmerControl(optCtrl=list(maxfun=2e5)),
                family = poisson)

# performance::check_model(firstpod_ranova3)

pb_ranova_transects(firstpod_ranova3,
          "Date of first follicle: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/Date_first_follicle_2022_transects_test.docx")



# Peduncles-----
# 2020-----
peduncles_ranova1 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2020),
             
                             na.action = na.exclude)

performance::check_model(peduncles_ranova1)

pb_ranova_transects(peduncles_ranova1,
          "Peduncles: 2020",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2020_transects.docx")


# 2021-----
peduncles_ranova2 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2021), 
                
                            na.action = na.exclude)

# performance::check_model(peduncles_ranova2)

pb_ranova_transects(peduncles_ranova2,
          "Peduncles: 2021",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2021_transects.docx")

# 2022-----
peduncles_ranova3 <- glmer.nb(Peduncles ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural" &
                                               Year == 2022),
                           na.action = na.exclude)

# performance::check_model(peduncles_ranova3)



pb_ranova_transects(peduncles_ranova3,
          "Peduncles: 2022",
          "./Reproductive_trait_analyses/Tables/Ranova/peduncles_2022_transects.docx")

```

## Recalculate PVE for non-Gaussian models
As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution.
The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection.
These new PVEs will be estimates. This is *not* a perfect solution but it will help us approximate PVE for these variables.
### Q1
```{r}
# main models
flsucc_lmer <- lmer(as.numeric(Flowered) ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = reproduc %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude)

flowers_lmer <- lmer(mean_flower_count ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = flowering %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude)

fltime_lmer <- update(flowers_lmer,
                      as.numeric(flowering_time) ~.)

flstart_lmer <- update(flowers_lmer,
                      Julian_oldest_inflor ~.)

pods_lmer <- update(flowers_lmer,
                      Pods ~.)

firstpod_lmer <- update(flowers_lmer,
                      Julian_first_follicle ~.)

peduncles_lmer <- update(flowers_lmer,
                      Peduncles ~.)

# get PVE from models
pve_flsucc    <- PVE_lm(flsucc_lmer) 
pve_flowers   <- PVE_lm(flowers_lmer)
pve_fltime    <- PVE_lm(fltime_lmer)
pve_flstart   <- PVE_lm(flstart_lmer) 
pve_pods      <- PVE_lm(pods_lmer)
pve_firstpod  <- PVE_lm(firstpod_lmer)
pve_peduncles <- PVE_lm(peduncles_lmer)


pve_flsucc_city     <- PVE_lm(update(flsucc_lmer, .~. + City_dist))
pve_flowers_city    <- PVE_lm(update(flowers_lmer, .~. + City_dist))
pve_fltime_city     <- PVE_lm(update(fltime_lmer, .~. + City_dist))
pve_flstart_city    <- PVE_lm(update(flstart_lmer, .~. + City_dist))
pve_pods_city       <- PVE_lm(update(pods_lmer, .~. + City_dist))
pve_firstpod_city   <- PVE_lm(update(firstpod_lmer, .~. + City_dist))
pve_peduncles_city  <- PVE_lm(update(peduncles_lmer, .~. + City_dist))


pve_flsucc_urbsc    <- PVE_lm(update(flsucc_lmer, .~. + Urb_score))
pve_flowers_urbsc   <- PVE_lm(update(flowers_lmer, .~. + Urb_score))
pve_fltime_urbsc    <- PVE_lm(update(fltime_lmer, .~. + Urb_score))
pve_flstart_urbsc   <- PVE_lm(update(flstart_lmer, .~. + Urb_score))
pve_pods_urbsc      <- PVE_lm(update(pods_lmer, .~. + Urb_score))
pve_firstpod_urbsc  <- PVE_lm(update(firstpod_lmer, .~. + Urb_score))
pve_peduncles_urbsc <- PVE_lm(update(peduncles_lmer, .~. + Urb_score))



# make tables
recalc_tab1.1 <- pve_table_recalc(pve_flsucc,
                                  pve_flowers,
                                  pve_fltime,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab1.2 <- pve_table_recalc(pve_flstart,
                                  pve_pods, 
                                  pve_firstpod,
                 "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab1.3 <- pve_peduncles %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()
  
  
recalc_tab2.1 <- pve_table_recalc(pve_flsucc_city,
                                  pve_flowers_city, 
                                  pve_fltime_city,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab2.2 <- pve_table_recalc(pve_flstart_city,
                                  pve_pods_city, 
                                  pve_firstpod_city,
                 "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab2.3 <- pve_peduncles_city %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()


recalc_tab3.1 <- pve_table_recalc(pve_flsucc_urbsc,
                                  pve_flowers_urbsc,
                                  pve_fltime_urbsc,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab3.2 <- pve_table_recalc(pve_flstart_urbsc,
                                  pve_pods_urbsc, 
                                  pve_firstpod_urbsc,
                  "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab3.3 <- pve_peduncles_urbsc %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()


# Export to word
  word_export <- read_docx()
  
  body_add_par(word_export,
               value = "As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution. The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection. These new PVEs will be estimates. This is not a perfect solution but it will help us approximate PVE for these variables.")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 1: Test for variance among families and populations")
  body_add_flextable(word_export, recalc_tab1.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab1.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab1.3)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 2: Assess how much variance is explained by urbanization")
  body_add_par(word_export, value = "Urbanization = Distance to the City Center")
  body_add_flextable(word_export, recalc_tab2.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab2.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab2.3)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 3: Assess how much variance is explained by urbanization")
  body_add_par(word_export, value = "Urbanization = Urbanization Score")
  body_add_flextable(word_export, recalc_tab3.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab3.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab3.3)  
  
  print(word_export, here::here("./Reproductive_trait_analyses/Tables/Ranova/PVE_nonGaussmods/PVE_nonGaussmods_reproduction_Q1.docx"))

```

### Q2
```{r}
# main models
flsucc_lmer2 <- update(flsucc_lmer,
                             data = reproduc %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

flowers_lmer2 <- update(flowers_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

fltime_lmer2 <- update(fltime_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

flstart_lmer2 <- update(flstart_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

pods_lmer2 <- update(pods_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

firstpod_lmer2 <- update(firstpod_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

peduncles_lmer2 <- update(peduncles_lmer,
                             data = flowering %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))

# get PVE from models
pve_flsucc2    <- PVE_lm(flsucc_lmer2) 
pve_flowers2   <- PVE_lm(flowers_lmer2)
pve_fltime2    <- PVE_lm(fltime_lmer2)
pve_flstart2   <- PVE_lm(flstart_lmer2) 
pve_pods2      <- PVE_lm(pods_lmer2)
pve_firstpod2  <- PVE_lm(firstpod_lmer2)
pve_peduncles2 <- PVE_lm(peduncles_lmer2)


pve_flsucc_city2     <- PVE_lm(update(flsucc_lmer2, .~. + City_dist*Transect_ID))
pve_flowers_city2    <- PVE_lm(update(flowers_lmer2, .~. + City_dist*Transect_ID))
pve_fltime_city2     <- PVE_lm(update(fltime_lmer2, .~. + City_dist*Transect_ID))
pve_flstart_city2    <- PVE_lm(update(flstart_lmer2, .~. + City_dist*Transect_ID))
pve_pods_city2       <- PVE_lm(update(pods_lmer2, .~. + City_dist*Transect_ID))
pve_firstpod_city2   <- PVE_lm(update(firstpod_lmer2, .~. + City_dist*Transect_ID))
pve_peduncles_city2  <- PVE_lm(update(peduncles_lmer2, .~. + City_dist*Transect_ID))


pve_flsucc_urbsc2    <- PVE_lm(update(flsucc_lmer2, .~. + Urb_score*Transect_ID))
pve_flowers_urbsc2   <- PVE_lm(update(flowers_lmer2, .~. + Urb_score*Transect_ID))
pve_fltime_urbsc2    <- PVE_lm(update(fltime_lmer2, .~. + Urb_score*Transect_ID))
pve_flstart_urbsc2   <- PVE_lm(update(flstart_lmer2, .~. + Urb_score*Transect_ID))
pve_pods_urbsc2      <- PVE_lm(update(pods_lmer2, .~. + Urb_score*Transect_ID))
pve_firstpod_urbsc2  <- PVE_lm(update(firstpod_lmer2, .~. + Urb_score*Transect_ID))
pve_peduncles_urbsc2 <- PVE_lm(update(peduncles_lmer2, .~. + Urb_score*Transect_ID))



# make tables
recalc_tab1.1 <- pve_table_recalc(pve_flsucc2,
                                  pve_flowers2,
                                  pve_fltime2,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab1.2 <- pve_table_recalc(pve_flstart2,
                                  pve_pods2, 
                                  pve_firstpod2,
                 "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab1.3 <- pve_peduncles2 %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()
  
  
recalc_tab2.1 <- pve_table_recalc(pve_flsucc_city2,
                                  pve_flowers_city2, 
                                  pve_fltime_city2,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab2.2 <- pve_table_recalc(pve_flstart_city2,
                                  pve_pods_city2, 
                                  pve_firstpod_city2,
                 "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab2.3 <- pve_peduncles_city2 %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()


recalc_tab3.1 <- pve_table_recalc(pve_flsucc_urbsc2,
                                  pve_flowers_urbsc2,
                                  pve_fltime_urbsc2,
                 "Flowering success",
                  "Flowers per Inflorescence",
                  "Flowering time")

recalc_tab3.2 <- pve_table_recalc(pve_flstart_urbsc2,
                                  pve_pods_urbsc2, 
                                  pve_firstpod_urbsc2,
                  "Flowering start",
                  "Follicles",
                  "Date of first follicle")

recalc_tab3.3 <- pve_peduncles_urbsc2 %>%
      flextable() %>%
      flextable::add_header_row(.,
                                values = c("",
                                           "Inflorescences"),
                                colwidths = c(1,2)) %>%
      flextable::align(i = c(1,2),
                       align = "center",
                       part = "header") %>%
      flextable::align(j = c(2:3),
                       align = "center",
                       part = "body") %>%
      bold(i = 1, part = "header")%>%
      autofit()


# Export to word
  word_export <- read_docx()
  
  body_add_par(word_export,
               value = "As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution. The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection. These new PVEs will be estimates. This is not a perfect solution but it will help us approximate PVE for these variables.")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 1: Test for variance among families and populations")
  body_add_flextable(word_export, recalc_tab1.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab1.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab1.3)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 2: Assess how much variance is explained by urbanization")
  body_add_par(word_export, value = "Urbanization = Distance to the City Center")
  body_add_flextable(word_export, recalc_tab2.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab2.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab2.3)
  
  body_add_par(word_export, value = "")
  body_add_par(word_export, value = "")
  
  body_add_par(word_export, value = "Table 3: Assess how much variance is explained by urbanization")
  body_add_par(word_export, value = "Urbanization = Urbanization Score")
  body_add_flextable(word_export, recalc_tab3.1)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab3.2)
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, recalc_tab3.3)  
  
  print(word_export, here::here("./Reproductive_trait_analyses/Tables/Ranova/PVE_nonGaussmods/PVE_nonGaussmods_reproduction_Q2.docx"))

```

# Anova
## Flowering success
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_urbscore_alt.png"))
```

## Mean Flowers/inflor
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_urbscore_alt.png"))
```


## Mean flower size/inflorescence
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowerSize_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsize_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowerSize_urbscore_alt.png"))
```


## Flowering time
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_urbscore_alt.png"))
```


## Flowering start
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_citydist.png"))
```

#### Urb_score
```{r}
# working with 3 dfs instead of 2, so tweaking function to reflect his

lapply(flstart_mods_best_u, tidy_anova) %>%
      lapply(., as.data.frame) %>%
      purrr::reduce(full_join) %>%
      replace(., is.na(.), "-") %>%
      dplyr::filter(Predictor != "(Intercept)") %>%
  dplyr::mutate(Sites = ifelse(row_number() == 5, "Urban Only",Sites)) %>%
    dplyr::mutate(Sites = ifelse(row_number() == 6, "Urban Only",Sites)) %>%
      dplyr::mutate(Sites = ifelse(row_number() == 7, "Urban Only",Sites)) %>%

      flextable::flextable() %>% 
      merge_v(j = "Response") %>% 
    #  merge_v(j = "Sites") %>% 
      valign(valign = "top") %>%
      flextable::autofit() %>%
      merge_at(i = 1:2, j = 2) %>% 
      merge_at(i = 3:4, j = 2) %>% 
      merge_at(i = 5:7, j = 2) %>% 
      align(j = c(1, 3), align = "left", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "header") %>%
      flextable::compose(i = 1, j = 4, part = "header",
                         value = as_paragraph("χ", as_sup("2"))) %>%
      flextable::compose(i = 1, j = 5, part = "header",
                         value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
      #theme_booktabs()%>%
      fix_border_issues() %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringstart_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```



## Pods
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_urbscore_alt.png"))
```


## Date of first mature pod
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/first_Pods_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/first_Pods_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/first_Pods_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(first_pods_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/first_Pods_urbscore_alt.png"))
```

## Peduncles
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Peduncles_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```

## Export all best / alt models in separate word docs
### Distance / best
```{r}
all_models_best_c <- list(
flsucc_mods_best_c      , # flowering success
flowers_mods_best_c     , # mean flowers/inflor
flsize_mods_best_c      , # mean flower size
fltime_mods_best_c      , # flowering time
flstart_mods_best_c     , # flowering start
pods_mods_best_c        , # pods (follicles)
first_pods_mods_best_c  , # first pods (follicles)
peduncles_mods_best_c   ) # peduncles (inflorescences)


anovas_best_c <- lapply(all_models_best_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_c, "./Reproductive_trait_analyses/Figures/ANOVA/Best_models/all_anova_repro_best_distance.docx")
```

### Distance / alt
```{r}
all_models_alt_c <- list(
flsucc_mods_alt_c      , # flowering success
flowers_mods_alt_c     , # mean flowers/inflor
flsize_mods_alt_c      , # mean flower size
fltime_mods_alt_c      , # flowering time
# flstart_mods_alt_c     , # flowering start- NONE
pods_mods_alt_c        , # pods (follicles)
first_pods_mods_alt_c   , # first pods (follicles)
peduncles_mods_alt_c   ) # peduncles (inflorescences)

anovas_alt_c <- lapply(all_models_alt_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_c, "./Reproductive_trait_analyses/Figures/ANOVA/alt_models/all_anova_repro_alt_distance.docx")
```

### UrbScore / best
```{r}
all_models_best_u <- list(
flsucc_mods_best_u      , # flowering success
flowers_mods_best_u     , # mean flowers/inflor
flsize_mods_best_u      , # mean flower size
fltime_mods_best_u      , # flowering time
flstart_mods_best_u     , # flowering start
pods_mods_best_u        , # pods (follicles)
first_pods_mods_best_u  , # first pods (follicles)
peduncles_mods_best_u   ) # peduncles (inflorescences)

anovas_best_u <- lapply(all_models_best_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_u, "./Reproductive_trait_analyses/Figures/ANOVA/Best_models/all_anova_repro_best_urbscore.docx")
```

### UrbScore / alt
```{r}
all_models_alt_u <- list(
flsucc_mods_alt_u      , # flowering success
flowers_mods_alt_u     , # mean flowers/inflor
flsize_mods_alt_u      , # mean flower size
# fltime_mods_alt_u      , # flowering time - NONE
# flstart_mods_alt_u     , # flowering start - NONE
# pods_mods_alt_u        , # pods (follicles) - NONE
first_pods_mods_alt_u ) # , # first pods (follicles)
# peduncles_mods_alt_u   ) # peduncles (inflorescences) - NONE

anovas_alt_u <- lapply(all_models_alt_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_u, "./Reproductive_trait_analyses/Figures/ANOVA/alt_models/all_anova_repro_alt_urbscore.docx")

```

## Export comparisons of anovas w/1 vs. all years
### Q1
```{r}
# Flowering success-----
compare_anovas(
  update(flsucc_mods_best_c[[1]], .~. - City_dist),
  reproduc,
  "2022",
  "Flowering success",
  "./Reproductive_trait_analyses/Tables/Comparing_ANOVA/flsucc.docx")

# Mean flowers/inflors-----
compare_anovas(
  update(flowers_mods_best_c[[1]], .~. - City_dist),
  flowering,
  "2022",
  "Flowers per inflorescences",
  "./Reproductive_trait_analyses/Tables/Comparing_ANOVA/flowers.docx")


# Flower size-----
compare_anovas(
  update(flsize_mods_best_c[[1]], .~. - City_dist),
  flowering,
  "2022",
  "Flower size",
  "./Reproductive_trait_analyses/Tables/Comparing_ANOVA/flsize.docx")


# Flowering time-----
compare_anovas(
  update(fltime_mods_best_c[[1]], .~. - City_dist),
  flowering,
  "2022",
  "Flowering duration",
  "./Reproductive_trait_analyses/Tables/Comparing_ANOVA/fltime.docx")


# Flowering start-----
compare_anovas(
  update(flstart_mods_best_c[[1]], .~. - City_dist),
  flowering,
  "2022",
  "Date of first flower",
  "./Reproductive_trait_analyses/Tables/Comparing_ANOVA/flstart.docx")
# Pods-----
compare_anovas(
  update(pods_mods_best_c[[1]], .~. - City_dist),
  flowering,
  "2022",
  "Follicles",
  "./Reproductive_trait_analyses/Tables/Comparing_ANOVA/pods.docx")


# Date of first pod-----
compare_anovas(
  update(first_pods_mods_best_c[[1]], .~. - City_dist),
  flowering,
  "2022",
  "Date of first follicle",
  "./Reproductive_trait_analyses/Tables/Comparing_ANOVA/firstpod.docx")


# Peduncles-----
compare_anovas(
  update(peduncles_mods_best_c[[1]], .~. - City_dist),
  flowering,
  "2022",
  "Inflorescences",
  "./Reproductive_trait_analyses/Tables/Comparing_ANOVA/peduncles.docx")
```

### Q2
```{r}

```


# R-squared values
```{r}

# change REML to T
flsucc_mods_reml_T     <- reml_to_true(flsucc_mods     ) 
flowers_mods_reml_T    <- reml_to_true(flowers_mods     ) 
flsize_mods_reml_T     <- reml_to_true(flsize_mods      ) 
fltime_mods_reml_T     <- reml_to_true(fltime_mods      ) 
flstart_mods_reml_T    <- reml_to_true(flstart_mods     ) 
pods_mods_reml_T       <- reml_to_true(pods_mods       ) 
first_pods_mods_reml_T <- reml_to_true(first_pods_mods  ) 
peduncles_mods_reml_T  <- reml_to_true(peduncles_mods   ) 


all_models_reml_T <- list(
flsucc_mods_reml_T      , 
flowers_mods_reml_T     , 
flsize_mods_reml_T      , 
fltime_mods_reml_T      , 
flstart_mods_reml_T     , 
pods_mods_reml_T        , 
first_pods_mods_reml_T  , 
peduncles_mods_reml_T   ) 

names(all_models_reml_T) <- c(
"flsucc_mods"          ,
"flowers_mods"         ,
"flsize_mods"          ,
"fltime_mods",
"flstart_mods",
"pods_mods"            ,
"first_pods_mods",
"peduncles_mods")


# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

sink(here::here("./Reproductive_trait_analyses/Tables/Rsquared.txt"))
print(all_rsq)
sink()



# export as nice tables in word doc
flsucc_r2      <- make_r2_table( flsucc_mods_reml_T    ) 
flowers_r2       <- make_r2_table(flowers_mods_reml_T      )
flsize_r2 <- make_r2_table(flsize_mods_reml_T) 
first_pods_r2  <- make_r2_table(first_pods_mods_reml_T )


## these models don't have an alternative model for urb score/ urbsubs and will use this table format
make_r2_table_modif1 <- function(mods_reml_T){
  
  return(
    lapply(mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      as.data.table() %>%
      melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m", "City_urbsubs_alt.R2m",
                              "Usc_urbsubs_best.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c", "City_urbsubs_alt.R2c",
                              "Usc_urbsubs_best.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m", "Distance_Q2_alt.R2m",
                          "UrbScore_Q2_best.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c", "Distance_Q2_alt.R2c",
                          "UrbScore_Q2_best.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,
                    Distance_Q2_alt.R2m,
                    Distance_Q2_alt.R2c,
                    
                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_best.R2m,
                    UrbScore_Q2_best.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,4,2,2))%>%
      add_header_row(
        values = c("",
                   "Best Models", "Alternative Models",
                   "Best Models"),
        colwidths = c(1,4,2,4)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,6,4)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")
  )
}

fltime_r2 <- make_r2_table_modif1(fltime_mods_reml_T)
pods_r2  <- make_r2_table_modif1(pods_mods_reml_T)
peduncles_r2  <- make_r2_table_modif1(peduncles_mods_reml_T )


## this models don't have an alternative model for distance/ urbsubs PLUS has these 2 options for usc / urbsubs: Usc_urbsubs_transectonly & Usc_urbsubs_urbscoreonly... will use this table format
flstart_r2 <-  lapply(flstart_mods_reml_T, r.squaredGLMM) %>%
      as.data.frame()%>%
      rownames_to_column() %>%
      dplyr::mutate_at(2:length(.), round, 3) %>%
      as.data.table() %>%
      melt(.,
           measure = patterns("City_gr.R2m",           "Usc_gr.R2m",
                              "City_urbsubs_best.R2m",
                              "Usc_urbsubs_transectonly.R2m",  "Usc_urbsubs_urbscoreonly.R2m",
                              "City_gr.R2c",           "Usc_gr.R2c",
                              "City_urbsubs_best.R2c", 
                              "Usc_urbsubs_transectonly.R2c",  "Usc_urbsubs_urbscoreonly.R2c"),
           value.name = c("Distance_Q1.R2m",      "UrbScore_Q1.R2m",
                          "Distance_Q2_best.R2m", 
                          "UrbScore_Q2_transectonly.R2m", "UrbScore_Q2_urbscoreonly.R2m",
                          "Distance_Q1.R2c",      "UrbScore_Q1.R2c",
                          "Distance_Q2_best.R2c", 
                          "UrbScore_Q2_transectonly.R2c", "UrbScore_Q2_urbscoreonly.R2c")) %>%
      as.data.frame() %>%
      dplyr::select(rowname,
                    
                    Distance_Q1.R2m,
                    Distance_Q1.R2c,
                    Distance_Q2_best.R2m,
                    Distance_Q2_best.R2c,

                    UrbScore_Q1.R2m,
                    UrbScore_Q1.R2c,
                    UrbScore_Q2_urbscoreonly.R2m,
                    UrbScore_Q2_urbscoreonly.R2c,
                    UrbScore_Q2_transectonly.R2m,
                    UrbScore_Q2_transectonly.R2c) %>%
      dplyr::rename("Type" = 1) %>%
      flextable() %>%
      add_header_row(
        values = c("",
                   "Model 1",
                   "Model 2",
                   "Model 3",
                   "Model 4",
                   "Model 5"),
        colwidths = c(1,2,2,2,2,2))  %>%
      add_header_row(
        values = c("",
                   "All Populations", "Urban Populations",
                   "All Populations", "Urban Populations"),
        colwidths = c(1,2,2,2,4))%>%
      add_header_row(
        values = c("",
                   "Best Models", 
                   "Best Models", "Alternative Models"),
        colwidths = c(1,4,4,2)) %>%
      add_header_row(
        values = c("",
                   "Distance to City Center", "Urbanization Score"),
        colwidths = c(1,4,6)) %>%
      theme_box() %>%
      align(align = "center",
            part = "all") %>%
      flextable::compose(part = "header",
                         j = c(2,4,6,8,10), i = 5,
                         value = as_paragraph("R", as_sup("2"), "m")
      ) %>%
      flextable::compose(part = "header",
                         j = c(3,5,7,9,11), i = 5,
                         value = as_paragraph("R", as_sup("2"), "c")
      ) %>%
      autofit() %>%
      width(j = 1, width = 1, unit = "in")



# will do this in 3 docs b/c function accepts 3 tables at a time (something to try tweaking in the future)
# table 1
export_r2(flsucc_r2,
flowers_r2,
flsize_r2,
          "Flowering success",
          "Flowers per inflorescence", 
          "Flower size",
          "./Reproductive_trait_analyses/Tables/R2_Reproduction1.docx")

# table 2
export_r2(
fltime_r2,
flstart_r2      ,
pods_r2 ,
          "Flowering time",
          "Date of first flower", 
          "Follicles",
          "./Reproductive_trait_analyses/Tables/R2_Reproduction2.docx")

# table 3: will just use code from function
  word_export <- read_docx()
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Date of first follicle", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, first_pods_r2)
  
  body_add_break(word_export)

  body_add_par(word_export, value = paste("R-squared estimates for",  "Inflorescences", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, peduncles_r2)
  
  word_export <- body_end_section_landscape(word_export)
  print(word_export, here::here("./Reproductive_trait_analyses/Tables/R2_Reproduction3.docx"))
```

# Calculate heritability, Qst, and CVA
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"
## Calculate values per trait
```{r}
# Flowering success-----
update(
    flsucc_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

# residual variance:
resid_var <- update(
     flsucc_mods_best_c[[1]], REML = T) %>%
    sigma()

flsucc_mean <- reproduc %>%
  dplyr::summarize(Mean = mean(Flowered ,
                               na.rm = T)) %>%
  as.numeric() # can't calculate this because it's 0s x 1s... will be 0

qg_flsucc <- calc_quantgenvars( 0.70759 ,
                   0.54422 ,
                   resid_var,
                   NA,
                   "Flowering Success")


# Mean flowers/inflor -----
update(
    flowers_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flowers_mean <- flowering %>%
  dplyr::summarize(Mean = mean(mean_flower_count ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     flowers_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flowers <- calc_quantgenvars(0.085598,
                   0.129033,
                   resid_var,
                   flowers_mean,
                   "Mean flowers/inflor")


# Mean flower size/inflorescence -----
update(
    flsize_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flsize_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Overall_mean ,
                               na.rm = T)) %>%
  as.numeric()

qg_flsize <- calc_quantgenvars( 2.1742  ,
                   1.7583  ,
                   4.6466  ,
                   flsize_mean,
                   "Flower size")


# Flowering time -----
update(
    fltime_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

fltime_mean <- flowering %>%
  dplyr::summarize(Mean = mean(flowering_time_num ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     fltime_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_fltime <- calc_quantgenvars( 4.8319e-05,
                   1.7015e-01,
                   resid_var,
                   fltime_mean,
                   "Flowering Duration")


# Flowering start -----
update(
    flstart_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

flstart_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_oldest_inflor ,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     flstart_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_flstart <- calc_quantgenvars( 4.0594e-07,
                   4.8286e-06,
                   resid_var,
                   flstart_mean,
                   "Flowering Start")


# Pods -----
update(
    pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Pods,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_pods <- calc_quantgenvars( 0.18623 ,
                   0.13145 ,
                   resid_var,
                   pods_mean,
                   "Follicles")


# Date of first mature pod -----
update(
    first_pods_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

first_pods_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Julian_first_follicle,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     first_pods_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_first_pods <- calc_quantgenvars( 0.058337,
                   0.016403,
                   resid_var,
                   first_pods_mean,
                   "Date of first follicle 2 in")


# Peduncles -----
update(
    peduncles_mods_best_c[[1]],
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

peduncles_mean <- flowering %>%
  dplyr::summarize(Mean = mean(Peduncles,
                               na.rm = T)) %>%
  as.numeric()


# residual variance:
resid_var <- update(
     peduncles_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_peduncles <- calc_quantgenvars( 0.19237 ,
                   0.25009 ,
                   resid_var,
                   peduncles_mean,
                   "Peduncles (Inflorescences)")


```

## Combine values into one table and export
```{r}
qg_joined <- list(
  qg_flsucc,
  qg_flowers,
  qg_flsize,
  qg_fltime,
  qg_flstart,
  qg_pods,
  qg_first_pods,
  qg_peduncles
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Reproductive_trait_analyses/Tables/quant_gen_reproduc.csv",
          row.names=FALSE)

```