# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import data

```{r}
source(knitr::purl("Reproductive_trait_analyses/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))
```

# Create ggpredict objects
## Flowering success
### Gradient
```{r}
# city_dist
flsucc_mods_best_c[1]
flsucc_gradient_01_pred <- ggeffects::ggpredict(flsucc_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
flsucc_mods_best_u[1]
flsucc_gradient_02_pred <- ggeffects::ggpredict(flsucc_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}
# city_dist
flsucc_mods_best_c[2]
flsucc_urbsubs_01_pred <- ggeffects::ggpredict(flsucc_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
flsucc_mods_best_u[2]
flsucc_urbsubs_02_pred <- ggeffects::ggpredict(flsucc_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Flower count/plant
### Gradient
```{r}

# city_dist
flowers_mods_best_c[[1]]
flowers_gradient_01_pred <- ggeffects::ggpredict(flowers_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
flowers_mods_best_u[[1]]
flowers_gradient_02_pred <- ggeffects::ggpredict(flowers_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
# city_dist
flowers_mods_best_c[[2]]
flowers_urbsubs_01_pred <- ggeffects::ggpredict(flowers_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
flowers_mods_best_u[[2]]
flowers_urbsubs_02_pred <- ggeffects::ggpredict(flowers_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Mean flower size/inflorescence
### Gradient
```{r}

# city_dist
flsize_mods_best_c[[1]]
flsize_gradient_01_pred <- ggeffects::ggpredict(flsize_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
flsize_mods_best_u[[1]]
flsize_gradient_02_pred <- ggeffects::ggpredict(flsize_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}

# city_dist
flsize_mods_best_c[[2]]
flsize_urbsubs_01_pred <- ggeffects::ggpredict(flsize_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
flsize_mods_best_u[[2]]
flsize_urbsubs_02_pred <- ggeffects::ggpredict(flsize_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```


## Flowering time
### Gradient
```{r}

# city_dist
fltime_mods_best_c[[1]]
fltime_gradient_01_pred <- ggeffects::ggpredict(fltime_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
fltime_mods_best_u[[1]]
fltime_gradient_02_pred <- ggeffects::ggpredict(fltime_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}

# city_dist
fltime_mods_best_c[[2]]
fltime_urbsubs_01_pred <- ggeffects::ggpredict(fltime_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
fltime_mods_best_u[[2]]
fltime_urbsubs_02_pred <- ggeffects::ggpredict(fltime_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Flowering start
### Gradient
```{r}
# city_dist
flstart_mods_best_c[[1]]
flstart_gradient_01_pred <- ggeffects::ggpredict(flstart_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
flstart_mods_best_u[[1]]
flstart_gradient_02_pred <- ggeffects::ggpredict(flstart_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}

# city_dist
flstart_mods_best_c[[2]]
flstart_urbsubs_01_pred <- ggeffects::ggpredict(flstart_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score- for this model, transect and urb score couldn't be put into same model. So there will be 2 figs for this instead of 1.
flstart_mods_best_u[[2]] # tests TRANSECT ONLY
flstart_urbsubs_02_pred_transect <- ggeffects::ggpredict(flstart_mods_best_u[[2]],
                                   terms = c("Transect_ID"),
                                   type = "fe")

flstart_mods_best_u[[3]] # tests URB SCORE ONLY
flstart_urbsubs_02_pred_urbscore <- ggeffects::ggpredict(flstart_mods_best_u[[3]],
                                   terms = c("Urb_score"),
                                   type = "fe")
```


## Pods
### Gradient
```{r}

# city_dist
pods_mods_best_c[1] 
pods_gradient_01_pred <- ggeffects::ggpredict(pods_mods_best_c[[1]] ,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
pods_mods_best_u[1] 
pods_gradient_02_pred <- ggeffects::ggpredict(pods_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}

# city_dist
pods_mods_best_c[2] 
pods_urbsubs_01_pred <- ggeffects::ggpredict(pods_mods_best_c[[2]] ,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
pods_mods_best_u[2] 
pods_urbsubs_02_pred <- ggeffects::ggpredict(pods_mods_best_u[[2]] ,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```


## Peduncles (Inflorescences)
### Gradient
```{r}

# city_dist
peduncles_mods_best_c[1] # CUBED
peduncles_gradient_01_pred <- ggeffects::ggpredict(peduncles_mods_best_c[[1]] ,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
peduncles_mods_best_u[1] # CUBED
peduncles_gradient_02_pred <- ggeffects::ggpredict(peduncles_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}

# city_dist
peduncles_mods_best_c[2] # SQUARED
peduncles_urbsubs_01_pred <- ggeffects::ggpredict(peduncles_mods_best_c[[2]] ,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
peduncles_mods_best_u[2] 
peduncles_urbsubs_02_pred <- ggeffects::ggpredict(peduncles_mods_best_u[[2]] ,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```


# Create regression plots- UPDATE
## Gradient
### City_dist
```{r}
# LDMC-----
ggpred_Q1.citydist_ldmc <- 
ggplot(ldmc_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Leaf Dry Matter Content") +
  ylim(NA, 0.19) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(ldmc_mods_best_c[[1]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
size = 4.5)

ggpred_Q1.citydist_ldmc



```

### Urb_score
```{r}
# LDMC-----
ggpred_Q1.urbscore_ldmc <- 
ggplot(ldmc_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = "Leaf Dry Matter Content") +
 ylim(0.165, NA) +
    xlim(4, -4) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(ldmc_mods_best_u[[1]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
size = 4.5)

ggpred_Q1.urbscore_ldmc



```

## Urban Subtransects
### City_dist
```{r}
# LDMC-----

levels(ldmc_urbsubs_01_pred$group)

ggpred_Q2.citydist_ldmc <-
ggplot(ldmc_urbsubs_01_pred) +
  labs(x = "Distance to Urban Center (km)",
       y = "Leaf Dry Matter Content",
       color = "Transect",
       fill = "Transect") +
 # ylim(NA, 0.19) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 1, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(ldmc_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 1, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(ldmc_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
size = 4.5)

ggpred_Q2.citydist_ldmc



# Flowering duration-----

levels(fltime_urbsubs_01_pred$group)

ggpred_Q2.citydist_fltime <-
ggplot(fltime_urbsubs_01_pred) +
  labs(x = "Distance to Urban Center (km)",
       y = "Flowering Duration (days)",
       color = "Transect",
       fill = "Transect") +
 # ylim(NA, 0.19) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.14,
                    label = paste0(" Distance: p = ", tidy_anova(fltime_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Distance to City Center") %>%
dplyr::select(p))),
size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.07,
                    label = paste0(" Transect: p = ", tidy_anova(fltime_mods_best_c[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
size = 4.5)

ggpred_Q2.citydist_fltime

# dev.copy2pdf(file = here::here("./Reproductive_trait_analyses/Figures/Q1_grad_citydist_floweringduration.pdf"),
#              width = 3.5, height = 3.75*1.1)

```

### Urb score
```{r}
# LDMC-----

levels(ldmc_urbsubs_02_pred$group)

ggpred_Q2.urbsubs_ldmc <-
ggplot(ldmc_urbsubs_02_pred) +
  labs(x = "Urbanization Score",
       y = "Leaf Dry Matter Content",
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 0.24) +
  xlim(4, -2) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 1, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(ldmc_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Urbanization Score") %>%
dplyr::select(p))),
size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 1, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(ldmc_mods_best_u[[2]]) %>%
dplyr::filter(Predictor == "Subtransect") %>%
dplyr::select(p))),
size = 4.5)

ggpred_Q2.urbsubs_ldmc





```

## Combine plots into one figure- UPDATE
### Gradient / City_dist
```{r}
gradient_citydist_plots <- ggarrange(
# ggpred_Q1.citydist_ldmc,
# ggpred_Q1.citydist_sla,
# ggpred_Q1.citydist_height_e,
# ggpred_Q1.citydist_height_l,
# ggpred_Q1.citydist_rgr,
# ggpred_Q1.citydist_ramets_e,
# ggpred_Q1.citydist_ramets_l,
# ggpred_Q1.citydist_mortality +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Reproductive_trait_analyses/Figures/Q1_grad_citydist_Reproduction.pdf"),
             width = 14, height = 7.5)
```


### Gradient / Urbanization Score
```{r}
gradient_urbscore_plots <- ggarrange(
# ggpred_Q1.urbscore_ldmc,
# ggpred_Q1.urbscore_sla,
# ggpred_Q1.urbscore_height_e,
# ggpred_Q1.urbscore_height_l,
# ggpred_Q1.urbscore_rgr,
# ggpred_Q1.urbscore_ramets_e,
# ggpred_Q1.urbscore_ramets_l,
# ggpred_Q1.urbscore_mortality +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Reproductive_trait_analyses/Figures/Q1_grad_urbscore_Reproduction.pdf"),
             width = 14, height = 7.5)
```

### Urb Subtransects / City_dist
```{r}
urbsubs_citydist_plots <- ggarrange(
  # ggpred_Q2.citydist_ldmc,
  # ggpred_Q2.citydist_sla,
  # ggpred_Q2.citydist_height_e,
  # ggpred_Q2.citydist_height_l,
  # ggpred_Q2.citydist_rgr,
  # ggpred_Q2.citydist_ramets_e,
  # ggpred_Q2.citydist_ramets_l,
  # ggpred_Q2.citydist_mortality +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Reproductive_trait_analyses/Figures/Q2_urbsubs_citydist_Reproduction.pdf"),
             width = 14.5, height = 8)
```


### Urb Subtransects / Urbanization Score
```{r}
urbsubs_urbscore_plots <- ggarrange(
  # ggpred_Q2.urbsubs_ldmc,
  # ggpred_Q2.urbsubs_sla,
  # ggpred_Q2.urbsubs_height_e,
  # ggpred_Q2.urbsubs_height_l,
  # ggpred_Q2.urbsubs_rgr,
  # ggpred_Q2.urbsubs_ramets_e,
  # ggpred_Q2.urbsubs_ramets_l,
  # ggpred_Q2.urbsubs_mortality +
            font("x.text"),
          ncol = 4,
          nrow = 2,
          align = "hv",
          labels = list("A", "B", "C", "D", "E", "F", "G"),
          font.label = (size =16),
          common.legend = T,
          legend = "top") %T>%
  plot

dev.copy2pdf(file = here::here("./Reproductive_trait_analyses/Figures/Q2_urbsubs_urbscore_Reproduction.pdf"),
             width = 14.5, height = 8)
```



# Find estimated marginal means at terminii- UPDATE
## Urban Subtransects
### City_dist
#### Flowering time
```{r}
# PERCENT difference, transects:
Calc_percent_change_transects(fltime_urbsubs_01_pred) # Percent change from non-corridor to corridor subtransect: 57.6%
```

### Urbanization score
#### SLA
```{r}
# PERCENT CHANGE, suburban to urban terminus:
Calc_percent_change_urbsubs(sla_urbsubs_02_pred) # 3.7%
```
