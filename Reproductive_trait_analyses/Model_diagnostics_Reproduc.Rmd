# Load libraries & functions
```{r}
source("libraries.R")
source("functions.R")
```

# Import data
```{r}
reproduc <- read.csv(here::here("./Joined_annual_data/reproductive.csv"), na.strings=c("NO PLANT", "none", "NA"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1)%>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Pop_ID", "Patch_ID", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Pop_ID", "Patch_ID", "Transect_ID", "Urb_Rur", "Flowered")), as.factor) %>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))

str(reproduc)

flowering <- read.csv(here::here("./Joined_annual_data/flowering.csv"), na.strings=c("NO PLANT", "none", "NA"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1)%>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Pop_ID", "Patch_ID", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Pop_ID", "Patch_ID", "Transect_ID", "Urb_Rur")), as.factor) %>%
    dplyr::mutate_at(vars(c(Date_oldest_inflor_flower,
                            Date_youngest_inflor_flower,
                            Date_first_follicle_2in)),
                     as.Date,
                     format = '%m/%d/%Y') %>%
  dplyr::mutate(flowering_time = Date_youngest_inflor_flower-Date_oldest_inflor_flower + 1) %>% # if I don't add 1, then it will say some plants flowered for 0 days
  relocate(flowering_time,
           .before = Date_first_follicle_2in) %>%
  dplyr::mutate(Julian_oldest_inflor = as.numeric(format(Date_oldest_inflor_flower, "%j")),
                Julian_first_follicle = as.numeric(format(Date_first_follicle_2in, "%j"))) %>%
  dplyr::mutate(Fam_uniq = as.factor(paste0(Population, "_", Family)))

str(flowering)
```

# Model diagnostics
## Flowering success
### Gradient
#### City_dist
```{r}
flsucc_gr_city1 <- glmmTMB(Flowered ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist,
  data = reproduc,
  family = binomial(link = "logit"))


# plot(DHARMa::simulateResiduals(flsucc_gr_city1))


# # test for gxe intxns
# gxe_test_flsucc1 <- glmmTMB(Flowered ~
#                              Year +
#                              (1|Population/Family) +
#                              City_dist*Block,
#   data = reproduc,
#   family = binomial(link = "logit"))
# 
# test_gxe(flsucc_gr_city1, gxe_test_flsucc1) # reg mod best
```

#### Urb_score
```{r}
flsucc_gr_usc1 <- glmmTMB(Flowered ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             Urb_score,
  data = reproduc,
  family = binomial(link = "logit"))


# plot(DHARMa::simulateResiduals(flsucc_gr_usc1))


# # test for gxe intxns
# gxe_test_flsucc2 <- glmmTMB(Flowered ~
#                              Year +
#                              (1|Population/Family) +
#                              Urb_score*Block,
#   data = reproduc,
#   family = binomial(link = "logit"))
# 
# test_gxe(flsucc_gr_usc1, gxe_test_flsucc2) # reg mod best
```

### Urban subtransects
#### City_dist
```{r}
flsucc_urbsubs_city1 <- glmmTMB(Flowered ~
                              Block +
                              Year +
                             (1|Population/Family) +
                             City_dist * Transect_ID,
  data = reproduc %>%
    dplyr::filter(Transect_ID != "Rural"),
  family = binomial)

# plot(DHARMa::simulateResiduals(flsucc_urbsubs_city1))


## MAIN EFFECTS
flsucc_urbsubs_city1_ME <- glmmTMB(Flowered ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist + Transect_ID,
  data = reproduc %>%
    dplyr::filter(Transect_ID != "Rural"),
  family = binomial(link = "logit"))


# plot(DHARMa::simulateResiduals(flsucc_urbsubs_city1_ME))
# AIC(flsucc_urbsubs_city1, flsucc_urbsubs_city1_ME) # ME model best but <2 from full

# # test for gxe
# gxe_test_flsucc3 <- glmmTMB(Flowered ~
#                              Year +
#                              City_dist*Transect_ID +
#                              (1|Population/Family) +
#                              City_dist*Block,
#   data = reproduc %>%
#     dplyr::filter(Transect_ID != "Rural"),
#   family = binomial(link = "logit"))
# 
# test_gxe(flsucc_urbsubs_city1, gxe_test_flsucc3) # reg mod best
```

#### Urb_score
```{r}
flsucc_urbsubs_usc1 <- glmmTMB(Flowered ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             Urb_score * Transect_ID,
  data = reproduc %>%
    dplyr::filter(Transect_ID != "Rural"),
  family = binomial(link = "logit"))

# plot(DHARMa::simulateResiduals(flsucc_urbsubs_usc1))


## MAIN EFFECTS
flsucc_urbsubs_usc1_ME <- glmmTMB(Flowered ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             Urb_score + Transect_ID,
  data = reproduc %>%
    dplyr::filter(Transect_ID != "Rural"),
  family = binomial(link = "logit"))


# plot(DHARMa::simulateResiduals(flsucc_urbsubs_usc1_ME))
# AIC(flsucc_urbsubs_usc1, flsucc_urbsubs_usc1_ME) # ME model best but <2 from full


# # test for gxe
# gxe_test_flsucc4 <- glmmTMB(Flowered ~
#                              Year +
#                              Urb_score*Transect_ID +
#                              (1|Population/Family) +
#                              Urb_score*Block,
#   data = reproduc %>%
#     dplyr::filter(Transect_ID != "Rural"),
#   family = binomial(link = "logit"))
# 
# test_gxe(flsucc_urbsubs_usc1, gxe_test_flsucc4) # reg mod best
```


## Mean flower count/inflor
### Gradient
#### City_dist
```{r}
## Basic data exploration
# plot(mean_flower_count ~ City_dist, data = flowering)
# 
# boxplot(mean_flower_count ~ Block, data = flowering)
# 
# boxplot(mean_flower_count ~ Year, data = flowering)


flowers_gr_city1 <- glmmTMB(mean_flower_count ~
                                          Block +
                                          Year +
                                          (1|Population/Family) +
                                          City_dist, 
                                        data = flowering,
                            family = nbinom2)

# plot(DHARMa::simulateResiduals(flowers_gr_city1)) 

# # test for gxe
# gxe_test_flowers <- glmmTMB(mean_flower_count ~
#                                           Block*City_dist +
#                                           Year +
#                               (1|Population/Family),
#                                         data = flowering,
#                             family = nbinom2)
# 
# test_gxe(flowers_gr_city1, gxe_test_flowers) # reg mod best
```

#### Urb_score
```{r}
flowers_gr_usc1 <- glmmTMB(mean_flower_count ~
                                          Block +
                                          Year +
                                          (1|Population/Family) +
                                          Urb_score, 
                                        data = flowering,
                            family = nbinom2)

# plot(DHARMa::simulateResiduals(flowers_gr_usc1))

# # test for gxe
# gxe_test_flowers2 <- glmmTMB(mean_flower_count ~
#                                           Block*Urb_score +
#                                           Year +
#                               (1|Population/Family),
#                                         data = flowering,
#                             family = nbinom2)
# 
# test_gxe(flowers_gr_usc1, gxe_test_flowers2) # reg mod best
```


### Urban Subtransects
#### City_dist
```{r}
flowers_urbsubs_city1 <- glmmTMB(mean_flower_count ~
                                         Block +
                                          Year +
                                          (1|Population/Family) +
                                          City_dist * Transect_ID, 
                                        data = flowering %>%
                                   dplyr::filter(Transect_ID != "Rural"),
                            family = nbinom2) 
# plot(DHARMa::simulateResiduals(flowers_urbsubs_city1))

## MAIN EFFECTS
flowers_urbsubs_city1_ME <- glmmTMB(mean_flower_count ~
                                          Block +
                                          Year +
                                          (1|Population/Family) +
                                          City_dist + Transect_ID, 
                                        data = flowering %>%
                                   dplyr::filter(Transect_ID != "Rural"),
                            family = nbinom2)

# car::Anova(flowers_urbsubs_city1_ME)
# plot(DHARMa::simulateResiduals(flowers_urbsubs_city1_ME))
# AIC(flowers_urbsubs_city1, flowers_urbsubs_city1_ME) # ME model better but <2 AIC from full


# # test for gxe
# gxe_test_flowers3 <- glmmTMB(mean_flower_count ~
#                                           Block*City_dist +
#                                           Year +
#                                City_dist*Transect_ID +
#                               (1|Population/Family),
#                              data = flowering %>%
#                                    dplyr::filter(Transect_ID != "Rural"),
#                             family = nbinom2)
# 
# test_gxe(flowers_urbsubs_city1, gxe_test_flowers3) # reg mod best
```

#### Urb_score
```{r}
flowers_urbsubs_usc1 <- glmmTMB(mean_flower_count ~
                                          Block +
                                          Year +
                                          (1|Population/Family) +
                                          Urb_score * Transect_ID, 
                                        data = flowering %>%
                                   dplyr::filter(Transect_ID != "Rural"),
                            family = nbinom2) 

# plot(DHARMa::simulateResiduals(flowers_urbsubs_usc1))


## MAIN EFFECTS
flowers_urbsubs_usc1_ME <- glmmTMB(mean_flower_count ~
                                          Block +
                                          Year +
                                          (1|Population/Family) +
                                          Urb_score + Transect_ID, 
                                        data = flowering %>%
                                   dplyr::filter(Transect_ID != "Rural"),
                            family = nbinom2) 

# plot(DHARMa::simulateResiduals(flowers_urbsubs_usc1_ME))
# AIC(flowers_urbsubs_usc1, flowers_urbsubs_usc1_ME) # full model better but <2 AIC from ME


# # test for gxe
# gxe_test_flowers4 <- glmmTMB(mean_flower_count ~
#                                           Block*Urb_score +
#                                           Year +
#                                Urb_score*Transect_ID +
#                               (1|Population/Family),
#                              data = flowering %>%
#                                    dplyr::filter(Transect_ID != "Rural"),
#                             family = nbinom2)
# 
# test_gxe(flowers_urbsubs_usc1 , gxe_test_flowers4) # stat equiv
# car::Anova(gxe_test_flowers4, type = "III") # block*urb_score sig (p = 0.0469) and block is only marg sig (it's sig in reg model, which also has transect as marg sig). Urbscore*transect sig in gxe mod, marg sig in reg mod
# car::Anova(flowers_urbsubs_usc1 , type = "III")
# 
# 
# # compare ranovas
# # have to use glmer instead of glmmtmb- ranova can't use glmmtmb- otherwise identical models
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer.nb(mean_flower_count ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block +
#                 Urb_score*Transect_ID,
#               data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5))) 
# 
# #     small mod 1
# smmod1 <- glmer.nb(mean_flower_count ~
#               #    Year +
#                   (1|Population) +
#                   Urb_score*Block+
#                 Urb_score*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5))) 
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer.nb(mean_flower_count ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block+
#                 Urb_score*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5))) 
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 0.4837
# 
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer.nb(mean_flower_count ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                    Block+
#                 Urb_score*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5))) 
# 
# #     small mod 1
# smmod1.reg <- glmer.nb(mean_flower_count ~
#               #    Year +
#                   (1|Population) +
#                    Block+
#                 Urb_score*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5))) 
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer.nb(mean_flower_count ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                 Urb_score*Transect_ID +
#                Block,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5))) 
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 1. This is also true when I set nAGQ = 0 for both mods

# mod comparison-----
# qualitatively identical so I'll keep using regular model.

```

## Mean flower size/inflorescence
### Gradient
#### City_dist
```{r}
## Basic data exploration
# plot(Overall_mean ~ City_dist, data = flowering)
# 
# boxplot(Overall_mean ~ Block, data = flowering)
# 
# boxplot(Overall_mean ~ Year, data = flowering)

flsize_gr_city1 <- glmmTMB(Overall_mean ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist, 
                           data = flowering)

# plot(DHARMa::simulateResiduals(flsize_gr_city1))
# performance::check_model(flsize_gr_city1)

# # test for gxe
# gxe_test_flsize <-  glmmTMB(Overall_mean ~
#                              Block*City_dist +
#                              Year +
#                              (1|Population/Family), 
#                            data = flowering)
# 
# test_gxe(flsize_gr_city1, gxe_test_flsize) # reg mod best
```

#### Urb_score
```{r}
flsize_gr_usc1 <- glmmTMB(Overall_mean ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             Urb_score, 
                           data = flowering,
                          REML = F)

# plot(DHARMa::simulateResiduals(flsize_gr_usc1))
# performance::check_model(flsize_gr_usc1)

# # test for gxe
# gxe_test_flsize2 <-  glmmTMB(Overall_mean ~
#                              Block*Urb_score +
#                              Year +
#                              (1|Population/Family),
#                            data = flowering)
# 
# test_gxe(flsize_gr_usc1, gxe_test_flsize2) # reg mod best
```

### Urban Subtransects
#### City_dist
```{r}
flsize_urbsubs_city1 <- glmmTMB(Overall_mean ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist * Transect_ID, 
                           data = flowering %>%
                             dplyr::filter(Transect_ID != "Rural"))

# plot(DHARMa::simulateResiduals(flsize_urbsubs_city1))
# performance::check_model(flsize_urbsubs_city1)


## MAIN EFFECTS
flsize_urbsubs_city1_ME <- glmmTMB(Overall_mean ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             City_dist + Transect_ID, 
                           data = flowering %>%
                             dplyr::filter(Transect_ID != "Rural")) 

# plot(DHARMa::simulateResiduals(flsize_urbsubs_city1_ME))
# performance::check_model(flsize_urbsubs_city1_ME)
# AIC(flsize_urbsubs_city1, flsize_urbsubs_city1_ME) # ME model best but <2 AIC from ME


# # test for gxe
# gxe_test_flsize3 <-  glmmTMB(Overall_mean ~
#                              Block*City_dist +
#                                Transect_ID*City_dist +
#                              Year +
#                              (1|Population/Family),
#                             data = flowering %>%
#                              dplyr::filter(Transect_ID != "Rural"))
# 
# test_gxe(flsize_urbsubs_city1, gxe_test_flsize3) # gxe mod best
# car::Anova(flsize_urbsubs_city1, type = "III")
# car::Anova(gxe_test_flsize3, type = "III") # block*urb sig: p = 0.0312, otherwise identical
# 
# 
# # compare ranovas
# # have to use lmer instead of glmmtmb- ranova can't use glmmtmb- otherwise identical models
# # GxE MOD
# ranova(lmer(Overall_mean ~
#                                Block*City_dist +
#                          #      Year +
#                                (1|Population/Family) +
#                                City_dist * Transect_ID,
#                               data = flowering %>%
#                              dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#                                REML = F))
# # p(Population) = 0.5019. p(Family) = 0.5809.
# 
# # REG MOD
# ranova( lmer(Overall_mean ~
#                                         Block +
#                                  #       Year +
#                                         (1|Population/Family) +
#                                         City_dist * Transect_ID,
#                               data = flowering %>%
#                              dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#                                REML = F))
# # p(Population) = 0.4185. p(Family) = 0.5764
# #
# # p-values for both mods nearly identical, so I'll keep using regular model. This is also true when year is added.
```

#### Urb_score
```{r}
flsize_urbsubs_usc1 <- glmmTMB(Overall_mean ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             Urb_score * Transect_ID, 
                           data = flowering %>%
                             dplyr::filter(Transect_ID != "Rural")) 

# plot(DHARMa::simulateResiduals(flsize_urbsubs_usc1))
# performance::check_model(flsize_urbsubs_usc1)

## MAIN EFFECTS
flsize_urbsubs_usc1_ME <- glmmTMB(Overall_mean ~
                             Block +
                             Year +
                             (1|Population/Family) +
                             Urb_score + Transect_ID,
                           data = flowering %>%
                             dplyr::filter(Transect_ID != "Rural"))

# plot(DHARMa::simulateResiduals(flsize_urbsubs_usc1_ME))
# performance::check_model(flsize_urbsubs_usc1_ME)
# AIC(flsize_urbsubs_usc1, flsize_urbsubs_usc1_ME) # ME model best but <2 AIC from full

# # test for gxe
# gxe_test_flsize4 <-  glmmTMB(Overall_mean ~
#                              Block*Urb_score +
#                                Transect_ID*Urb_score +
#                              Year +
#                              (1|Population/Family),
#                             data = flowering %>%
#                              dplyr::filter(Transect_ID != "Rural"))
# 
# test_gxe(flsize_urbsubs_usc1, gxe_test_flsize4) # mods stat equiv
# car::Anova(flsize_urbsubs_usc1, type = "III")
# car::Anova(gxe_test_flsize4, type = "III") # qualitatively identical
```

## Flowering time
### Gradient
#### City_dist
```{r}
flowering$flowering_time_num <- as.numeric(flowering$flowering_time)

fl_time_gr_city1 <- glmmTMB(flowering_time_num ~
                                           Block +
                                           Year +
                                          (1|Population/Family) +
                                          City_dist, 
                                        data = flowering,
                            family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_time_gr_city1))
# performance::check_model(fl_time_gr_city1)
# car::Anova(fl_time_gr_city1)


# # test for gxe
# gxe_test_fltime <- glmmTMB(flowering_time_num ~
#                                           Block*City_dist +
#                                           Year +
#                               (1|Population/Family),
#                                         data = flowering,
#                             family = nbinom2)
# 
# test_gxe(fl_time_gr_city1, gxe_test_fltime) # reg mod best
```

#### Urb_score
```{r}
fl_time_gr_usc1 <- glmmTMB(flowering_time_num ~
                                           Block +
                                           Year +
                                          (1|Population/Family) +
                                          Urb_score, 
                                        data = flowering,
                            family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_time_gr_usc1))
# performance::check_model(fl_time_gr_usc1)
# car::Anova(fl_time_gr_usc1)


# # test for gxe
# gxe_test_fltime2 <- glmmTMB(flowering_time_num ~
#                                           Block*Urb_score +
#                                           Year +
#                               (1|Population/Family),
#                                         data = flowering,
#                             family = nbinom2)
# 
# test_gxe(fl_time_gr_usc1, gxe_test_fltime2) # reg mod best
```

### Urban Subtransects
#### City_dist
```{r}
# full model
fl_time_urbsubs_city1 <- glmmTMB(flowering_time_num ~
                                           Block +
                                           Year +
                                          (1|Population/Family) +
                                          City_dist * Transect_ID, 
                                        data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural"),
                            family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_time_urbsubs_city1))
# performance::check_model(fl_time_urbsubs_city1)
# car::Anova(fl_time_urbsubs_city1)


# reduced model
fl_time_urbsubs_city1_ME <- glmmTMB(flowering_time_num ~
                                           Block +
                                           Year +
                                          (1|Population/Family) +
                                          City_dist + Transect_ID, 
                                        data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural"),
                            family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_time_urbsubs_city1_ME))
# performance::check_model(fl_time_urbsubs_city1_ME)
# car::Anova(fl_time_urbsubs_city1_ME)
# AIC(fl_time_urbsubs_city1, fl_time_urbsubs_city1_ME) # ME model best but <2 AIC from full


# test for gxe
gxe_test_fltime3 <- glmmTMB(flowering_time_num ~
                                          Block*City_dist +
                                          Transect_ID*City_dist +
                                          Year +
                              (1|Population/Family),
                                         data = flowering %>%
                               dplyr::filter(Transect_ID != "Rural"),
                            family = nbinom2)

test_gxe(fl_time_urbsubs_city1, gxe_test_fltime3) # reg mod best
```

#### Urb_score
```{r}
# full model
fl_time_urbsubs_usc1 <- glmmTMB(flowering_time_num ~
                                  Block +
                                  Year +
                                  (1|Population/Family) +
                                  Urb_score * Transect_ID,
                                data = flowering %>%
                                  dplyr::filter(Transect_ID != "Rural"),
                                family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_time_urbsubs_usc1))
# performance::check_model(fl_time_urbsubs_usc1)
# car::Anova(fl_time_urbsubs_usc1)


# reduced model
fl_time_urbsubs_usc1_ME <- glmmTMB(flowering_time_num ~
                                     Block +
                                     Year +
                                     (1|Population/Family) +
                                     Urb_score + Transect_ID, 
                                   data = flowering %>%
                                     dplyr::filter(Transect_ID != "Rural"),
                                   family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_time_urbsubs_usc1_ME))
# performance::check_model(fl_time_urbsubs_usc1_ME)
# car::Anova(fl_time_urbsubs_usc1_ME)
# AIC(fl_time_urbsubs_usc1, fl_time_urbsubs_usc1_ME) # full model best


# # test for gxe
# gxe_test_fltime4 <- glmmTMB(flowering_time_num ~
#                                           Block*Urb_score +
#                                           Transect_ID*Urb_score +
#                                           Year +
#                               (1|Population/Family),
#                                          data = flowering %>%
#                                dplyr::filter(Transect_ID != "Rural"),
#                             family = nbinom2)
# 
# test_gxe(fl_time_urbsubs_usc1, gxe_test_fltime4) # reg mod best
```

## Flowering start
### Gradient
#### City_dist
```{r}
## Basic data exploration
# plot(Julian_oldest_inflor ~ City_dist, data = flowering)
# 
# boxplot(Julian_oldest_inflor ~ Block, data = flowering)
# 
# boxplot(Julian_oldest_inflor ~ Year, data = flowering)

# won't converge with nbinom1 or 2 families with all fixed effects unless I subtract a number like 170. Either way, there's no effect of urbanization
fl_start_gr_city1 <- glmmTMB(Julian_oldest_inflor-170 ~
                               Block +
                               Year +
                               (1|Population/Family) +
                               City_dist, 
                             data = flowering,
                             family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_start_gr_city1))
# performance::check_model(fl_start_gr_city1)
# car::Anova(fl_start_gr_city1)


# # test for gxe
# gxe_test_flstart <- glmmTMB(Julian_oldest_inflor-170 ~
#                                Year +
#                                (1|Population/Family) +
#                                City_dist*Block,
#                              data = flowering,
#                              family = nbinom2)
# 
# test_gxe(fl_start_gr_city1, gxe_test_flstart) # stat equiv
# car::Anova(fl_start_gr_city1, type = "III") 
# car::Anova(gxe_test_flstart, type = "III") # block*city sig (p = 0.03742)
# 
# 
# # compare ranovas
# # have to use glmer.nb instead of glmmtmb- ranova can't use glmmtmb- otherwise identical models
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block,
#               data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               nAGQ = 0) # doesn't converge w/o this
# 
# #     small mod 1
# smmod1 <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population) +
#                   City_dist*Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               nAGQ = 0)
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               nAGQ = 0)
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 1
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               nAGQ = 0)
# 
# #     small mod 1
# smmod1.reg <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population) +
#                   City_dist + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               nAGQ = 0)
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer.nb(Julian_oldest_inflor - 170 ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#              nAGQ = 0)
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 1
# # mod comparison-----
# # qualitatively identical so I'll keep using regular model.
```

#### Urb_score
```{r}
fl_start_gr_usc1 <- glmmTMB(Julian_oldest_inflor -170 ~
                                          Block +
                                           Year +
                                          (1|Population/Family) +
                                          Urb_score, 
                                        data = flowering,
                             family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_start_gr_usc1))
# performance::check_model(fl_start_gr_usc1)
# car::Anova(fl_start_gr_usc1)


# # test for gxe
# gxe_test_flstart2 <- glmmTMB(Julian_oldest_inflor -170 ~
#                                Year +
#                                (1|Population/Family) +
#                                Urb_score*Block,
#                              data = flowering,
#                              family = nbinom2)
# 
# test_gxe(fl_start_gr_usc1, gxe_test_flstart2) # stat equiv
# car::Anova(fl_start_gr_usc1, type = "III")
# car::Anova(gxe_test_flstart2, type = "III") # block*city marg sig (p = 0.0755)
# 
# 
# # compare ranovas
# # have to use glmer.nb instead of glmmtmb- ranova can't use glmmtmb- otherwise identical models
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block,
#               data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               control=glmerControl(optimizer="bobyqa",
#                             optCtrl=list(maxfun=2e5)))
# 
# #     small mod 1
# smmod1 <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population) +
#                   Urb_score*Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               control=glmerControl(optimizer="bobyqa",
#                             optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               control=glmerControl(optimizer="bobyqa",
#                             optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 1
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   Urb_score + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               control=glmerControl(optimizer="bobyqa",
#                             optCtrl=list(maxfun=2e5)))
# #     small mod 1
# smmod1.reg <- glmer.nb(Julian_oldest_inflor - 170 ~
#               #    Year +
#                   (1|Population) +
#                   Urb_score + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               control=glmerControl(optimizer="bobyqa",
#                             optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer.nb(Julian_oldest_inflor - 170 ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                   Urb_score + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               control=glmerControl(optimizer="bobyqa",
#                             optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 1
# # mod comparison-----
# # qualitatively identical so I'll keep using regular model.
```

### Urban subtransects
#### City_dist
```{r}
fl_start_urbsubs_city1 <- glmmTMB(Julian_oldest_inflor - 170 ~
                                    Block +
                                         Year +
                                    (1|Population/Family) +
                                    City_dist * Transect_ID, 
                                        data = flowering %>%
                                    dplyr::filter(Transect_ID != "Rural"),
                             family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_start_urbsubs_city1))
# performance::check_model(fl_start_urbsubs_city1)


# Main effects model
fl_start_urbsubs_city1_ME <- glmmTMB(Julian_oldest_inflor -170 ~
                                           Block +
                                           Year +
                                          (1|Population/Family) +
                                          City_dist + Transect_ID, 
                                        data = flowering %>%
                                    dplyr::filter(Transect_ID != "Rural"),
                             family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_start_urbsubs_city1_ME))
# performance::check_model(fl_start_urbsubs_city1_ME)
# car::Anova(fl_start_urbsubs_city1_ME)
# summary(fl_start_urbsubs_city1_ME)

# AIC(fl_start_urbsubs_city1, fl_start_urbsubs_city1_ME) # ME best model but stat equiv


# # test for gxe
# gxe_test_flstart3 <- glmmTMB(Julian_oldest_inflor - 170 ~
#                                Block*City_dist +
#                                Year +
#                                (1|Population/Family) +
#                                Transect_ID*City_dist,
#                              data = flowering %>%
#                                dplyr::filter(Transect_ID != "Rural"),
#                              family = nbinom2)
# 
# test_gxe(fl_start_urbsubs_city1_ME, gxe_test_flstart3) # gxe mod best
# car::Anova(gxe_test_flstart3, type = "III") # block*city very sig (p = 0.0009855 )
# car::Anova(fl_start_urbsubs_city1_ME, type = "III")


# # compare ranovas
# # have to use glmer instead of glmmtmb- ranova can't use glmmtmb- otherwise identical models
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer.nb(Julian_oldest_inflor-170 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block +
#                 City_dist*Transect_ID,
#               data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               nAGQ = 0) # won't converge w/o this
# 
# #     small mod 1
# smmod1 <- glmer.nb(Julian_oldest_inflor-170 ~
#               #    Year +
#                   (1|Population) +
#                   City_dist*Block +
#                 City_dist*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               nAGQ = 0)
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer.nb(Julian_oldest_inflor-170 ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block +
#                 City_dist*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               nAGQ = 0)
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 0.9191
# 
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer.nb(Julian_oldest_inflor-170 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               nAGQ = 0)
# 
# #     small mod 1
# smmod1.reg <- glmer.nb(Julian_oldest_inflor-170 ~
#               #    Year +
#                   (1|Population) +
#                   City_dist*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               nAGQ = 0)
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer.nb(Julian_oldest_inflor-170 ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               nAGQ = 0)
# 
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 1
# # mod comparison-----
# # qualitatively identical so I'll keep using regular model.
```

#### Urb_score
```{r}
fl_start_urbsubs_usc1 <- glmmTMB(Julian_oldest_inflor - 170 ~
                                           Block +
                                           Year +
                                          (1|Population/Family) +
                                          Urb_score * Transect_ID,
                                        data = flowering %>%
                                    dplyr::filter(Transect_ID != "Rural"),
                             family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_start_urbsubs_usc1))
# performance::check_model(fl_start_urbsubs_usc1)


# Main effects model
fl_start_urbsubs_usc1_ME <- glmmTMB(Julian_oldest_inflor - 170~
                                           Block +
                                           Year +
                                          (1|Population/Family) +
                                          Urb_score +
                                      Transect_ID, 
                                        data = flowering %>%
                                    dplyr::filter(Transect_ID != "Rural"),
                             family = nbinom2)

# plot(DHARMa::simulateResiduals(fl_start_urbsubs_usc1_m1))
# performance::check_model(fl_start_urbsubs_usc1_m1)

# AIC(fl_start_urbsubs_usc1, fl_start_urbsubs_usc1_ME) # m1 best but stat equiv

# # test for gxe
# gxe_test_flstart4 <- glmmTMB(Julian_oldest_inflor - 170~
#                                Block*Urb_score +
#                                Year +
#                                (1|Population/Family) +    Transect_ID*Urb_score,
#                              data = flowering %>%
#                                dplyr::filter(Transect_ID != "Rural"),
#                              family = nbinom2)
# 
# test_gxe(fl_start_urbsubs_usc1, gxe_test_flstart4) # stat equiv
# car::Anova(gxe_test_flstart4, type = "III") # block*urb score not sig
# car::Anova(fl_start_urbsubs_usc1, type = "III")
```

## Pods
#### Gradient
##### City_dist
```{r}
pods_gr_city1 <- glmmTMB(Pods ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           City_dist,
                         data = flowering,
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(pods_gr_city1))
# performance::check_model(pods_gr_city1)
# car::Anova(pods_gr_city1)

# # test for gxe
# gxe_test_pods <- glmmTMB(Pods ~
#                            Block*City_dist +
#                            Year +
#                            (1|Population/Family),
#                          data = flowering,
#                          family = nbinom2)
# 
# test_gxe(pods_gr_city1, gxe_test_pods) # reg mod best
```

##### Urb_score
```{r}
pods_gr_usc1 <- glmmTMB(Pods ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           Urb_score,
                         data = flowering,
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(pods_gr_usc1))
# performance::check_model(pods_gr_usc1)
# car::Anova(pods_gr_usc1)

# # test for gxe
# gxe_test_pods2 <- glmmTMB(Pods ~
#                            Block*Urb_score +
#                            Year +
#                            (1|Population/Family),
#                          data = flowering,
#                          family = nbinom2)
# 
# test_gxe(pods_gr_city1, gxe_test_pods2) # reg mod best
```

#### Urban Subtransects
##### City_dist
```{r}
pods_urbsubs_city1 <- glmmTMB(Pods ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           City_dist * Transect_ID,
                         data = flowering %>%
                           dplyr::filter(Transect_ID != "Rural"),
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(pods_urbsubs_city1))
# performance::check_model(pods_urbsubs_city1)
# car::Anova(pods_urbsubs_city1)


# MAIN EFFECTS MODEL
pods_urbsubs_city1_ME <- glmmTMB(Pods ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           City_dist + Transect_ID,
                         data = flowering %>%
                           dplyr::filter(Transect_ID != "Rural"),
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(pods_urbsubs_city1_ME)) # looks fine
# performance::check_model(pods_urbsubs_city1_ME)
# car::Anova(pods_urbsubs_city1_ME)

AIC(pods_urbsubs_city1, pods_urbsubs_city1_ME) # ME model lower AIC but <2 away


# # test for gxe
# gxe_test_pods3 <- glmmTMB(Pods ~
#                            Block*City_dist +
#                            Year +
#                             Transect_ID*City_dist +
#                            (1|Population/Family),
#                           data = flowering %>%
#                            dplyr::filter(Transect_ID != "Rural"),
#                           family = nbinom2)
# 
# test_gxe(pods_urbsubs_city1, gxe_test_pods3) # stat equiv
# car::Anova(pods_urbsubs_city1, type = "III") # block isn't sig in gxe mod, otherwise qual identical
# car::Anova(gxe_test_pods3, type = "III")
```

##### Urb_score
```{r}
pods_urbsubs_usc1 <- glmmTMB(Pods ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           Urb_score * Transect_ID,
                         data = flowering %>%
                           dplyr::filter(Transect_ID != "Rural"),
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(pods_urbsubs_usc1))
# performance::check_model(pods_urbsubs_usc1)
# car::Anova(pods_urbsubs_usc1)


# MAIN EFFECTS MODEL
pods_urbsubs_usc1_ME <- glmmTMB(Pods ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           Urb_score + Transect_ID,
                         data = flowering %>%
                           dplyr::filter(Transect_ID != "Rural"),
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(pods_urbsubs_usc1_ME)) # looks fine
# performance::check_model(pods_urbsubs_usc1_ME)
# car::Anova(pods_urbsubs_usc1_ME)
# 
# AIC(pods_urbsubs_usc1, pods_urbsubs_usc1_ME) # full model lower AIC


# # test for gxe
# gxe_test_pods4 <- glmmTMB(Pods ~
#                            Block*Urb_score +
#                            Year +
#                             Transect_ID*Urb_score +
#                            (1|Population/Family),
#                           data = flowering %>%
#                            dplyr::filter(Transect_ID != "Rural"),
#                           family = nbinom2)
# 
# test_gxe(pods_urbsubs_usc1 , gxe_test_pods4) # stat equiv
# car::Anova(pods_urbsubs_usc1 , type = "III") # block*urb_score marg sig in gxe mod, otherwise qual identical
# car::Anova(gxe_test_pods4, type = "III")
# 
# 
# # compare ranovas
# # have to use glmer instead of glmmtmb- ranova can't use glmmtmb- otherwise identical models
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer.nb(Pods ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block+
#                             Transect_ID*Urb_score,
#               data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# #     small mod 1
# smmod1 <- glmer.nb(Pods ~
#               #    Year +
#                   (1|Population) +
#                   Urb_score*Block+
#                             Transect_ID*Urb_score,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer.nb(Pods ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block+
#                             Transect_ID*Urb_score,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 1
# 
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer.nb(Pods ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   Urb_score + Block+
#                             Transect_ID*Urb_score,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# #     small mod 1
# smmod1.reg <- glmer.nb(Pods ~
#               #    Year +
#                   (1|Population) +
#                   Urb_score + Block+
#                             Transect_ID*Urb_score,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p = 1
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer.nb(Pods ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                   Urb_score + Block+
#                             Transect_ID*Urb_score,
#                 data = flowering %>%
#                 dplyr::filter(Transect_ID != "Rural" & Year == "2022"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 1
# # mod comparison-----
# # qualitatively identical so I'll keep using regular model.

```

## Date of first follicle
### Gradient
#### City_dist
```{r}
## Basic data exploration
# plot(Julian_first_follicle ~ City_dist, data = flowering)
# 
# boxplot(Julian_first_follicle ~ Block, data = flowering)
# 
# boxplot(Julian_first_follicle ~ Year, data = flowering)

pod_start_gr_city1 <- glmmTMB(Julian_first_follicle-170 ~
                               Block +
                               Year +
                               (1|Population/Family) +
                               City_dist, 
                             data = flowering,
                             family = poisson)

# plot(DHARMa::simulateResiduals(pod_start_gr_city1))
# car::Anova(pod_start_gr_city1)



# # test for gxe
# gxe_test_firstpods <- glmmTMB(Julian_first_follicle-170 ~
#                                City_dist*Block +
#                                 as.factor(Year) +
#                                 (1|Population/Family),
#                               data = flowering,
#                               family = poisson)
# 
# test_gxe(pod_start_gr_city1, gxe_test_firstpods) # gxe mod best
# car::Anova(pod_start_gr_city1, type = "III") # block*city highly sig (p = 0.006497)
# car::Anova(gxe_test_firstpods, type = "III")
# 
# 
# # compare ranovas
# # have to use glmer instead of glmmtmb- ranova can't use glmmtmb- otherwise identical models
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer(Julian_first_follicle-200 ~ # using 200 here because I used 200 when doing the ranovas. Better diagnostics for 1 year
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block,
#               data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# #     small mod 1
# smmod1 <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   City_dist*Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p << 0.001
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE), 
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 0.6838 when smmod2 has nAGQ = 0; p = 1 when I use bobyqa optimizer (but model doesn't converge)
# 
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE), 
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# #     small mod 1
# smmod1.reg <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   City_dist + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p << 0.001
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer(Julian_first_follicle-200 ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE), 
#              family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 0.6809 when smmod2 has nAGQ = 0; p = 0.9532 when I use bobyqa optimizer (but model doesn't converge)
# # mod comparison-----
# # qualitatively identical so I'll keep using regular model.
```

#### Urb_score
```{r}
pod_start_gr_usc1 <- glmmTMB(Julian_first_follicle - 170 ~
                               Block +
                               Year +
                               (1|Population/Family) +
                               Urb_score, 
                             data = flowering,
                             family = poisson)

# plot(DHARMa::simulateResiduals(pod_start_gr_usc1))
# car::Anova(pod_start_gr_usc1)

# # test for gxe
# gxe_test_firstpods2 <- glmmTMB(Julian_first_follicle - 170 ~
#                                Urb_score*Block +
#                                 (Year) +
#                                 (1|Population/Family),
#                               data = flowering,
#                               family = poisson)
# 
# test_gxe(pod_start_gr_usc1, gxe_test_firstpods2) # gxe mod best
# car::Anova(pod_start_gr_usc1, type = "III") # urbsc * block marg sig (p = 0.07129)
# car::Anova(gxe_test_firstpods2, type = "III")
# 
# 
# # # compare ranovas
# # have to use glmer instead of glmmtmb- ranova can't use glmmtmb- otherwise identical models
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block,
#               data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# #     small mod 1
# smmod1 <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   Urb_score*Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p << 0.001
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE), 
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 0.6838 when smmod2 has nAGQ = 0; p = 1 when I use bobyqa optimizer (though model DOES converge)
# 
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   Urb_score + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE), 
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# #     small mod 1
# smmod1.reg <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   Urb_score + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p << 0.001
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer(Julian_first_follicle-200 ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                   Urb_score + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE), 
#              family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 0.6840 when smmod2 has nAGQ = 0; p = 1 when I use bobyqa optimizer (though model DOES converge)
# # mod comparison-----
# # qualitatively identical so I'll keep using regular model.
```

### Urban Subtransects
#### City_dist
```{r}
# full model
pod_start_urbsubs_city1 <- glmmTMB(Julian_first_follicle -170 ~
                               Block +
                               Year +
                               (1|Population/Family) +
                               City_dist * Transect_ID, 
                             data = flowering  %>%
                           dplyr::filter(Transect_ID != "Rural"),
                             family = poisson)

# plot(DHARMa::simulateResiduals(pod_start_urbsubs_city1))
# car::Anova(pod_start_urbsubs_city1)


# ME model
pod_start_urbsubs_city1_ME <- glmmTMB(Julian_first_follicle-170 ~
                               Block +
                               Year +
                               (1|Population/Family) +
                               City_dist + Transect_ID, 
                             data = flowering  %>%
                           dplyr::filter(Transect_ID != "Rural"),
                             family = poisson)

# plot(DHARMa::simulateResiduals(pod_start_urbsubs_city1_ME))
# car::Anova(pod_start_urbsubs_city1_ME)

# AIC(pod_start_urbsubs_city1, pod_start_urbsubs_city1_ME) # ME model better but <2 AIC from full


# # test for gxe
# gxe_test_firstpods3 <- glmmTMB(Julian_first_follicle-170 ~
#                                Block*City_dist +
#                                Year +
#                                (1|Population/Family) +
#                                City_dist*Transect_ID,
#                              data = flowering  %>%
#                            dplyr::filter(Transect_ID != "Rural"),
#                              family = poisson)
# 
# test_gxe(pod_start_urbsubs_city1, gxe_test_firstpods3) # gxe mod best
# car::Anova(pod_start_urbsubs_city1, type = "III") # block*city highly sig (p < 0.001)
# car::Anova(gxe_test_firstpods3, type = "III")
# 
# 
# # compare ranovas
# # have to use glmer instead of glmmtmb- ranova can't use glmmtmb- otherwise identical models
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block + 
#                 City_dist*Transect_ID,
#               data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# #     small mod 1
# smmod1 <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   City_dist*Block +
#                 City_dist*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p << 0.001
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block + 
#                 City_dist*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 0.9988
# 
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# #     small mod 1
# smmod1.reg <- glmer(Julian_first_follicle-200 ~
#               #    Year +
#                   (1|Population) +
#                   City_dist*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#               family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p << 0.001
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer(Julian_first_follicle-200 ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 is.na(Julian_first_follicle) == FALSE &
#                                 Transect_ID != "Rural"),
#              family = poisson,
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)))
# 
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 0.7372 when smmod2 has nAGQ = 0; p = 1 when I use bobyqa optimizer (but model doesn't converge)
# # mod comparison-----
# # qualitatively identical so I'll keep using regular model.
```

#### Urb_score
```{r}
# full model
pod_start_urbsubs_usc1 <- glmmTMB(Julian_first_follicle-170 ~
                               Block +
                               Year +
                               (1|Population/Family) +
                               Urb_score * Transect_ID, 
                             data = flowering  %>%
                           dplyr::filter(Transect_ID != "Rural"),
                             family = poisson)

# plot(DHARMa::simulateResiduals(pod_start_urbsubs_usc1))
# car::Anova(pod_start_urbsubs_usc1)


# ME model
pod_start_urbsubs_usc1_ME <- glmmTMB(Julian_first_follicle-170 ~
                               Block +
                               Year +
                               (1|Population/Family) +
                               Urb_score + Transect_ID, 
                             data = flowering  %>%
                           dplyr::filter(Transect_ID != "Rural"),
                             family = poisson)

# plot(DHARMa::simulateResiduals(pod_start_urbsubs_usc1_ME))
# car::Anova(pod_start_urbsubs_usc1_ME)

# AIC(pod_start_urbsubs_usc1, pod_start_urbsubs_usc1_ME) # full model best


# # test for gxe
# gxe_test_firstpods4 <- glmmTMB(Julian_first_follicle-170 ~
#                                Block*Urb_score +
#                                Year +
#                                (1|Population/Family) +
#                                Urb_score*Transect_ID,
#                              data = flowering  %>%
#                            dplyr::filter(Transect_ID != "Rural"),
#                              family = poisson)
# 
# test_gxe(pod_start_urbsubs_usc1, gxe_test_firstpods4) # reg mod best
```

## Peduncles (Inflorescences)
#### Gradient
##### City_dist
```{r}
# hist(flowering$Peduncles) # very right-skewed. Looks like there might be a few outliers

peduncles_gr_city1 <- glmmTMB(Peduncles ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           City_dist,
                         data = flowering,
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(peduncles_gr_city1)) 
# performance::check_model(peduncles_gr_city1)
# performance::check_outliers(peduncles_gr_city1) # no outliers
# car::Anova(peduncles_gr_city1)

# # test for gxe
# gxe_test_peds <- glmmTMB(Peduncles ~
#                            Year +
#                            (1|Population/Family) +
#                            City_dist*Block,
#                          data = flowering,
#                          family = nbinom2)
# 
# test_gxe(peduncles_gr_city1, gxe_test_peds) # reg mod best
```

##### Urb_score
```{r}
peduncles_gr_usc1 <- glmmTMB(Peduncles ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           Urb_score,
                         data = flowering,
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(peduncles_gr_usc1)) 
# performance::check_model(peduncles_gr_usc1)
# car::Anova(peduncles_gr_usc1)

# # test for gxe
# gxe_test_peds2 <- glmmTMB(Peduncles ~
#                            Year +
#                            (1|Population/Family) +
#                            Urb_score*Block,
#                          data = flowering,
#                          family = nbinom2)
# 
# test_gxe(peduncles_gr_usc1, gxe_test_peds2) # stat equivalent
# car::Anova(peduncles_gr_usc1, type = "III") # qualitatively identical (no block*city intxn)
# car::Anova(gxe_test_peds2, type = "III")
```

#### Urban Subtransects
##### City_dist
```{r}
peduncles_urbsubs_city1 <- glmmTMB(Peduncles^2 ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           City_dist * Transect_ID,
                         data = flowering %>%
                           dplyr::filter(Transect_ID != "Rural"),
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(peduncles_urbsubs_city1))


# MAIN EFFECTS MODEL
peduncles_urbsubs_city1_ME <- glmmTMB(Peduncles^2 ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           City_dist + Transect_ID,
                         data = flowering %>%
                           dplyr::filter(Transect_ID != "Rural"),
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(peduncles_urbsubs_city1_ME))
# 
# AIC(peduncles_urbsubs_city1, peduncles_urbsubs_city1_ME) # ME model best but <2 AIC from full
# 
# car::Anova(peduncles_urbsubs_city1_ME)


# # test for gxe
# gxe_test_peds3 <- glmmTMB(Peduncles^2 ~
#                            Year +
#                            (1|Population/Family) +
#                            City_dist*Block +
#                             City_dist*Transect_ID,
#                          data = flowering %>%
#                            dplyr::filter(Transect_ID != "Rural"),
#                          family = nbinom2)
# 
# test_gxe(peduncles_urbsubs_city1, gxe_test_peds3) # gxe mod best
# car::Anova(peduncles_urbsubs_city1, type = "III") # block*city sig (p = 0.0112)
# car::Anova(gxe_test_peds3, type = "III")
# 
# 
# compare ranovas
# using poisson instead of negative binomial because I get a warning message w/large models: "Warning message: In theta.ml(Y, mu, weights = object@resp$weights, limit = limit, : iteration limit reached"
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block + 
#                 City_dist*Transect_ID,
#               data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#               family = poisson)
# 
# #     small mod 1
# smmod1 <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population) +
#                   City_dist*Block +
#                 City_dist*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
#               
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#               family = poisson)
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p = 1 w/nbinom (glmer.nb); p << 0.001 w/poisson
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Block + 
#                 City_dist*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#               family = poisson)
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 0.1746 w/nbinom, p = 0.1775 w/poisson
# 
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
#               
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#               family = poisson)
# 
# #     small mod 1
# smmod1.reg <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population) +
#                   City_dist*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
#               
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#               family = poisson)
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p = 1 w/nbinom; p << 0.001 w/poisson
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer(Peduncles ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                   City_dist*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
#              
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#               family = poisson)
# 
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 0.03224 w/nbinom; p = 0.2426 w/poisson
# # mod comparison-----
# # qualitatively identical so I'll keep using regular model.
```

##### Urb_score
```{r}
peduncles_urbsubs_usc1 <- glmmTMB(Peduncles ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           Urb_score * Transect_ID,
                         data = flowering %>%
                           dplyr::filter(Transect_ID != "Rural"),
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(peduncles_urbsubs_usc1))
# performance::check_model(peduncles_urbsubs_usc1)


# MAIN EFFECTS MODEL
peduncles_urbsubs_usc1_ME <- glmmTMB(Peduncles ~
                           Block +
                           Year +
                           (1|Population/Family) +
                           Urb_score + Transect_ID,
                         data = flowering %>%
                           dplyr::filter(Transect_ID != "Rural"),
                         family = nbinom2)

# plot(DHARMa::simulateResiduals(peduncles_urbsubs_usc1_ME)) # looks good
# 
# performance::check_model(peduncles_urbsubs_usc1_ME)
# 
# AIC(peduncles_urbsubs_usc1, peduncles_urbsubs_usc1_ME) #full model best model


# # test for gxe
# gxe_test_peds4 <- glmmTMB(Peduncles ~
#                            Year +
#                            (1|Population/Family) +
#                            Urb_score*Block +
#                             Urb_score*Transect_ID,
#                          data = flowering %>%
#                            dplyr::filter(Transect_ID != "Rural"),
#                          family = nbinom2)
# 
# test_gxe(peduncles_urbsubs_usc1, gxe_test_peds4) # stat equivalent
# car::Anova(peduncles_urbsubs_usc1, type = "III") # block*city sig (p = 0.0411)
# car::Anova(gxe_test_peds4, type = "III")
# 
# 
# # compare ranovas
# using poisson instead of neg bin, like I did for city_dist
# # GxE MOD-----
# #   test family
# #     large mod
# lgmod1 <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block +
#                 Urb_score*Transect_ID,
#               data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#               family = poisson)
# 
# #     small mod 1
# smmod1 <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population) +
#                   Urb_score*Block +
#                 Urb_score*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#               family = poisson)
# 
# PBmodcomp(lgmod1, smmod1, seed = 45, nsim = 10) # p = 0.002118
# 
# # test pop
# #     small mod 2
# smmod2 <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Block +
#                 Urb_score*Transect_ID,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude, 
#               family = poisson)
# 
# PBmodcomp(lgmod1, smmod2, seed = 45, nsim = 10) # p = 0.1392
# 
# 
# # REG MOD-----
# #   test family
# #     large mod
# lgmod1.reg <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population) +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
# 
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude, 
#               family = poisson)
# 
# #     small mod 1
# smmod1.reg <- glmer(Peduncles ~
#               #    Year +
#                   (1|Population) +
#                   Urb_score*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
# 
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#               family = poisson)
# 
# PBmodcomp(lgmod1.reg, smmod1.reg, seed = 45, nsim = 10) # p << 0.001
# 
# # test pop
# #     small mod 2
# smmod2.reg <- glmer(Peduncles ~
#              #     Year +
#                   (1|Population:Fam_uniq) +
#                   Urb_score*Transect_ID + Block,
#                 data = flowering %>%
#                 dplyr::filter(Year == "2022" &
#                                 Transect_ID != "Rural"),
# 
#               control=glmerControl(optimizer="bobyqa",
#                              optCtrl=list(maxfun=2e5)),
#                             na.action = na.exclude,
#              family = poisson)
# 
# 
# PBmodcomp(lgmod1.reg, smmod2.reg, seed = 45, nsim = 10) # p = 0.31007
# # mod comparison-----
# # qualitatively identical so I'll keep using regular model.
```

# Models for use in analysis
## Flowering success
```{r}
flsucc_mods <- list(
## City_dist / gradient
flsucc_gr_city1 ,
## Urbanization score / gradient
flsucc_gr_usc1 ,
## City_dist / urban subtransects
flsucc_urbsubs_city1, # qualitatively identical model
flsucc_urbsubs_city1_ME, # Best model
## Urbanization score  / urban subtransects
flsucc_urbsubs_usc1, # qualitatively identical model
flsucc_urbsubs_usc1_ME # Best model
)
names(flsucc_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best"
)
```

## Mean flower count
```{r}
flowers_mods <- list(
## City_dist / gradient
flowers_gr_city1 ,
## Urbanization score / gradient
flowers_gr_usc1 ,
## City_dist / urban subtransects
flowers_urbsubs_city1, # Qualitatively identical model (<2 AIC away)
flowers_urbsubs_city1_ME, # Best model
## Urbanization score  / urban subtransects
flowers_urbsubs_usc1, # Best model
flowers_urbsubs_usc1_ME # Qualitatively identical model (<2 AIC away)
)
names(flowers_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_best",
                     "Usc_urbsubs_alt")
```

## Flower size
```{r}
flsize_mods <- list(
## City_dist / gradient
flsize_gr_city1 ,
## Urbanization score / gradient
flsize_gr_usc1 ,
## City_dist / urban subtransects
flsize_urbsubs_city1, # Qualitatively identical model (<2 AIC away)
flsize_urbsubs_city1_ME, # Best model
## Urbanization score  / urban subtransects
flsize_urbsubs_usc1, # >2 AIC from best model
flsize_urbsubs_usc1_ME  # Best model
)
names(flsize_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")
```

## Flowering time
```{r}
fltime_mods <- list(
## City_dist / gradient
fl_time_gr_city1 ,
## Urbanization score / gradient
fl_time_gr_usc1 ,
## City_dist / urban subtransects
fl_time_urbsubs_city1,   # Qualitatively identical model (<2 AIC away)
fl_time_urbsubs_city1_ME, # Best model
## Urbanization score  / urban subtransects
# fl_time_urbsubs_usc1, 
fl_time_urbsubs_usc1_ME  # Best model
)


names(fltime_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     # "Usc_urbsubs_alt",
                     "Usc_urbsubs_best")

```

## Flowering start
```{r}
flstart_mods <- list(

## City_dist / gradient
fl_start_gr_city1 ,

## Urbanization score / gradient
fl_start_gr_usc1 ,

## City_dist / urban subtransects
fl_start_urbsubs_city1, # qual equivalent mod
fl_start_urbsubs_city1_ME, # Best model

## Urbanization score  / urban subtransects
fl_start_urbsubs_usc1, # best model
fl_start_urbsubs_usc1_ME # qual equiv mod

)

names(flstart_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_best",
                     "Usc_urbsubs_alt")
```

## Pods
```{r}
pods_mods <- list(

## City_dist / gradient
pods_gr_city1 ,

## Urbanization score / gradient
pods_gr_usc1 ,

## City_dist / urban subtransects
pods_urbsubs_city1, # Best model
pods_urbsubs_city1_ME, # Qualitatively identical model (<2 AIC away)

## Urbanization score  / urban subtransects
pods_urbsubs_usc1  #,# Best model 
# pods_urbsubs_usc1_ME 

)


names(pods_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_best",
                     "City_urbsubs_alt",
                     # "Usc_urbsubs_alt",
                     "Usc_urbsubs_best"
                     )
```

## Date of first mature pod
```{r}
first_pods_mods <- list(

## City_dist / gradient
pod_start_gr_city1 ,

## Urbanization score / gradient
pod_start_gr_usc1 ,

## City_dist / urban subtransects
pod_start_urbsubs_city1, # Qualitatively identical model (<2 AIC away)
pod_start_urbsubs_city1_ME, # Best model

## Urbanization score  / urban subtransects
pod_start_urbsubs_usc1 # Best model 

)


names(first_pods_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_best"
                     )
```

## Peduncles
```{r}
peduncles_mods <- list(

## City_dist / gradient
peduncles_gr_city1 ,

## Urbanization score / gradient
peduncles_gr_usc1 ,

## City_dist / urban subtransects
peduncles_urbsubs_city1, # Qualitatively identical model (<2 AIC away)
peduncles_urbsubs_city1_ME, # Best model

## Urbanization score  / urban subtransects
peduncles_urbsubs_usc1 #, # Best model
# peduncles_urbsubs_usc1_ME 

)


names(peduncles_mods) <- c("City_gr",
                     "Usc_gr",
                     "City_urbsubs_alt",
                     "City_urbsubs_best",
                     "Usc_urbsubs_best")
```


# Final models
## Create final list
```{r}
all_models <- list(
flsucc_mods      , # flowering success
flowers_mods     , # mean flowers/inflor
flsize_mods      , # mean flower size
fltime_mods      , # flowering time
flstart_mods     , # flowering start
pods_mods        , # pods (follicles)
first_pods_mods  , # first pods (follicles)
peduncles_mods   ) # peduncles (inflorescences)

names(all_models) <- c(
"flsucc_mods"          ,
"flowers_mods"         ,
"flsize_mods"          ,
"fltime_mods",
"flstart_mods",
"pods_mods"            ,
"first_pods_mods",
"peduncles_mods")
```

## Create separate lists of best vs. alt models for city_dist vs urb_score
### flowering success
```{r}
## Best
### City_dist
flsucc_mods_best_c <- flsucc_mods[c(1,4)]

### Urb_score
flsucc_mods_best_u <- flsucc_mods[c(2,6)]

## Alt
### City_dist
flsucc_mods_alt_c <- flsucc_mods[3]

### Urb_score
flsucc_mods_alt_u <- flsucc_mods[5]
```

### mean flowers/inflor
```{r}
## Best
### City_dist
flowers_mods_best_c <- flowers_mods[c(1,4)]

### Urb_score
flowers_mods_best_u <- flowers_mods[c(2,5)]

## Alt
### City_dist
flowers_mods_alt_c <- flowers_mods[3]

### Urb_score
flowers_mods_alt_u <- flowers_mods[6]
```


### mean flower size
```{r}
## Best
### City_dist
flsize_mods_best_c <- flsize_mods[c(1,4)]

### Urb_score
flsize_mods_best_u <- flsize_mods[c(2,6)]

## Alt
### City_dist
flsize_mods_alft_c <- flsize_mods[3]

### Urb_score
flsize_mods_alt_u <- flsize_mods[5]

```

### flowering time
```{r}
## Best
### City_dist
fltime_mods_best_c <- fltime_mods[c(1,4)]

### Urb_score
fltime_mods_best_u <- fltime_mods[c(2,5)]

## Alt
### City_dist
fltime_mods_alt_c <- fltime_mods[3]

### Urb_score
# NONE
```

### flowering start
```{r}
## Best
### City_dist
flstart_mods_best_c <- flstart_mods[c(1,4)]

### Urb_score
flstart_mods_best_u <- flstart_mods[c(2,5)] 

## Alt
### City_dist
flstart_mods_alt_c <- flstart_mods[3] 

### Urb_score
flstart_mods_alt_u <- flstart_mods[6] 
```

### pods (follicles)
```{r}
## Best
### City_dist
pods_mods_best_c <- pods_mods[c(1,3)]

### Urb_score
pods_mods_best_u <- pods_mods[c(2,5)]

## Alt
### City_dist
pods_mods_alt_c <- pods_mods[4]

### Urb_score
# NONE
```


### date of first mature pod
```{r}
## Best
### City_dist
first_pods_mods_best_c <- first_pods_mods[c(1,4)]

### Urb_score
first_pods_mods_best_u <- first_pods_mods[c(2,5)]

## Alt
### City_dist
first_pods_mods_alt_c <- first_pods_mods[3]

### Urb_score
# NONE
```

### peduncles (inflorescences)
```{r}
## Best
### City_dist
peduncles_mods_best_c <- peduncles_mods[c(1,4)]

### Urb_score
peduncles_mods_best_u <- peduncles_mods[c(2,5)]

## Alt
### City_dist
peduncles_mods_alt_c <- peduncles_mods[3]

### Urb_score- NONE
```

