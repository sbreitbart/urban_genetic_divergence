---
title: "Reproductive Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients
# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

NOTES:

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| All reproductive traits     |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import data
```{r}
reproduc <- read.csv(here::here("./Joined_annual_data/reproductive.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1)

flowering <- read.csv(here::here("./Joined_annual_data/flowering.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1)
```


## MAKE DIAGNOSTIC RMD NEXT, THEN FIGURE OUT HOW TO STRUCTURE REST OF THIS
### ***taken from old doc; update***
##### Entire gradient: *Nothing sig for either
###### City_dist
```{r}
car::Anova(flowering_gr_city_m1)
# nothing significant



# ANy variation within families or populations?

##### TACTIC 1: try bootstrapping #####
# NOT PERFECT b/c can't nest family within pop but trying a few ways to get at the correct answer.
# https://www.ssc.wisc.edu/sscc/pubs/MM/MM_TestEffects.html#test-of-random-parameter
# library(pbkrtest) # Parametric Bootstrap, Kenward-Roger and Satterthwaite Based
Methods for Test in Mixed Models
# library(pbnm)
# 
# # JUST POPULATION
# gmm <-  glmer(Flowered2020 ~ City_dist + (1|Population), # can't leave in Family... doesn't work
#               family = binomial(link = "logit"),
#               data = reproductive,
#              nAGQ = 0)
# 
# # IDEAL MODEL (DOESN'T WORK w/glmer THOUGH)
# gmm1 <-  glmer(Flowered2020 ~ City_dist + (1|Population/Family), 
#               family = binomial(link = "logit"),
#               data = reproductive,
#              nAGQ = 0)
# 
# # POP:FAMILY
# gmm2 <-  glmer(Flowered2020 ~ City_dist + (1|Population:Family), # can't leave in Family as nested but CAN as crossed
#               family = binomial(link = "logit"),
#               data = reproductive,
#              nAGQ = 0)
# 
# # UNIQUE FAMILIES
# reproductive$Family_unique <- paste(reproductive$Population, reproductive$Family)
# gmm3 <-  glmer(Flowered2020 ~ City_dist + (1|Family_unique),
#               family = binomial(link = "logit"),
#               data = reproductive,
#              nAGQ = 0)
# 
# # EQUIVALENT TO FAM NESTED W/IN POP
# gmm4 <-  glmer(Flowered2020 ~ City_dist + (1|Population:Family) + (1|Population),
#               family = binomial(link = "logit"),
#               data = reproductive,
#              nAGQ = 0)
# 
# 
# # REDUCED MODEL
# gmmDG1 <- glm(Flowered2020 ~ City_dist,
#               family = binomial(link = "logit"),
#               data = reproductive)
# 
# ### RESULTS ###
# # POPULATION (so, results are about populations)
# pbgmmDg1 <- pbnm(gmm,gmmDG1,nsim=1000,tasks=10,cores=2,seed=3400835) 
# summary(pbgmmDg1) # p = 0.031...  var among pops
# 
# # EQUIVALENT TO FAM NESTED W/IN POP (so, results are about populations)
# pbgmmDg4 <- pbnm(gmm4,gmmDG1,nsim=1000,tasks=10,cores=2,seed=3400835) 
# ranova_pop <- summary(pbgmmDg4) %T>%
#   print() # p = 0.028... var among pops accounting for fams
# 
# # POP:FAMILY (so, results are about families)- accounts for fams being in same pop
# pbgmmDg2 <- pbnm(gmm2,gmmDG1,nsim=1000,tasks=10,cores=2,seed=3400835) 
# ranova_fam <- summary(pbgmmDg2) %T>%
#   print() # p = 0.191... little var among families crossed w/ pops
# 
# # UNIQUE FAMILIES (so, results are about families)
# pbgmmDg3 <- pbnm(gmm3,gmmDG1,nsim=1000,tasks=10,cores=2,seed=3400835) 
# summary(pbgmmDg3) # p = 0.258... little var among families, period
# 
# 
# 
# sum.1 <- summary(gmm4)
# 
# variances1 <- print(VarCorr(gmm4),comp="Variance") %>%
#   as.data.frame() %>%
#   dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
#   dplyr::select(., c(grp, vcov, PVE)) %>%
#   dplyr::rename(., Group = grp,
#                 Variance = vcov)
# 
# # export percent variance explained
# write.table(variances1, here::here("./Figures_Tables/ranova_PVE/2020_Floweringsuccess_glmer_PVE.csv"), col.names=TRUE, sep=",", append=TRUE)
# 
# # export ranova
# sink(here::here("./Figures_Tables/ranova_PVE/2020_Floweringsuccess_glmer_ranova.csv"))
# print("POPULATION", sep="\n\n")
# print(ranova_pop, sep="\n\n")
#   cat("\n")
# print("FAMILY", sep="\n\n")
# print(ranova_fam, sep="\n\n")
#   cat("\n")
# if (ranova_pop[1] <= 0.05){
#   print ('There is variance among populations')}
# if (ranova_pop[1] > 0.05){
#   print ("There is not much variance among populations")}
# if (ranova_fam[1] <= 0.05){
#   print ("There is variance among families")}
# if (ranova_fam[1] > 0.05){
#   print ("There is not much variance among families")}
# sink()


```

###### Urb_score
```{r}
car::Anova(flowering_gr_urb_m1)
# not sig


```

##### Urban subtransects: *Nothing sig for either
###### City_dist
```{r}
car::Anova(flowering_urbsubs_city_m1) # nothing sig
car::Anova(flowering_urbsubs_city_m1_ME) # nothing sig

AIC(flowering_urbsubs_city_m1, flowering_urbsubs_city_m1_ME) # <2 away




# ANy variation within families or populations?

##### TACTIC 1: try bootstrapping #####
# NOT PERFECT b/c can't nest family within pop but trying a few ways to get at the correct answer.
# https://www.ssc.wisc.edu/sscc/pubs/MM/MM_TestEffects.html#test-of-random-parameter


### MODEL 1: CITY_DIST ###
##########################
# 
# # JUST POPULATION
# gmm <-  glmer(Flowered2020 ~ City_dist + (1|Population), # can't leave in Family... doesn't work
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#   nAGQ = 0)
# 
# # IDEAL MODEL (DOESN'T WORK w/glmer THOUGH)
# gmm1 <-  glmer(Flowered2020 ~ City_dist + (1|Population/Family), 
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#              nAGQ = 0)
# 
# # POP:FAMILY
# gmm2 <-  glmer(Flowered2020 ~ City_dist + (1|Population:Family), # can't leave in Family as nested but CAN as crossed
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#              nAGQ = 0)
# 
# # UNIQUE FAMILIES
# gmm3 <-  glmer(Flowered2020 ~ City_dist + (1|Family_unique),
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#              nAGQ = 0)
# 
# # EQUIVALENT TO FAM NESTED W/IN POP
# gmm4 <-  glmer(Flowered2020 ~ City_dist + (1|Population:Family) + (1|Population),
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#              nAGQ = 0)
# 
# 
# # REDUCED MODEL 1
# gmmDG1 <- glm(Flowered2020 ~ City_dist,
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"))
# 
# 
# 
# ### RESULTS ###
# # POPULATION (so, results are about populations)
# pbgmmDg1 <- pbnm(gmm,gmmDG1,nsim=1000,tasks=10,cores=2,seed=3400835) 
# summary(pbgmmDg1) # p = 0.032...  var among pops
# 
# # EQUIVALENT TO FAM NESTED W/IN POP (so, results are about populations)
# pbgmmDg4 <- pbnm(gmm4,gmmDG1,nsim=1000,tasks=10,cores=2,seed=3400835) 
# ranova_pop <- summary(pbgmmDg4) %T>%
#   print() # p = 0.049... var among pops accounting for fams
# 
# # POP:FAMILY (so, results are about families)- accounts for fams being in same pop
# pbgmmDg2 <- pbnm(gmm2,gmmDG1,nsim=1000,tasks=10,cores=2,seed=3400835) 
# ranova_fam <- summary(pbgmmDg2) %T>%
#   print() # p = 0.23... little var among families crossed w/ pops
# 
# # UNIQUE FAMILIES (so, results are about families)
# pbgmmDg3 <- pbnm(gmm3,gmmDG1,nsim=1000,tasks=10,cores=2,seed=3400835) 
# summary(pbgmmDg3) # p = 0.23... little var among families, period
# 
# 
# 
# ### MODEL 2: TRANSECT_ID ###
# ##########################
# 
# # JUST POPULATION
# gmm.2 <-  glmer(Flowered2020 ~ Transect_ID + (1|Population), # can't leave in Family... doesn't work
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#   nAGQ = 0)
# 
# # IDEAL MODEL (DOESN'T WORK w/glmer THOUGH)
# gmm1.2 <-  glmer(Flowered2020 ~ Transect_ID + (1|Population/Family), 
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#              nAGQ = 0)
# 
# # POP:FAMILY
# gmm2.2 <-  glmer(Flowered2020 ~ Transect_ID + (1|Population:Family), # can't leave in Family as nested but CAN as crossed
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#              nAGQ = 0)
# 
# # UNIQUE FAMILIES
# gmm3.2 <-  glmer(Flowered2020 ~ Transect_ID + (1|Family_unique),
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#              nAGQ = 0)
# 
# # EQUIVALENT TO FAM NESTED W/IN POP
# gmm4.2 <-  glmer(Flowered2020 ~ Transect_ID + (1|Population:Family) + (1|Population),
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"),
#              nAGQ = 0)
# 
# # REDUCED MODEL 2
# gmmDG1.2 <- glm(Flowered2020 ~ Transect_ID,
#               family = binomial(link = "logit"),
#   data = reproductive %>% filter(Urb_Rur == "Urban"))
# 
# 
# 
# ### RESULTS ###
# # POPULATION (so, results are about populations)
# pbgmmDg1.2 <- pbnm(gmm.2,gmmDG1.2,nsim=1000,tasks=10,cores=2,seed=3400835) 
# summary(pbgmmDg1.2) # p = 0.027...  var among pops
# 
# # EQUIVALENT TO FAM NESTED W/IN POP (so, results are about populations)
# pbgmmDg4.2 <- pbnm(gmm4.2,gmmDG1.2,nsim=1000,tasks=10,cores=2,seed=3400835) 
# ranova_pop.2 <- summary(pbgmmDg4.2) %T>%
#   print() # p = 0.049... var among pops accounting for fams
# 
# # POP:FAMILY (so, results are about families)- accounts for fams being in same pop
# pbgmmDg2.2 <- pbnm(gmm2.2,gmmDG1.2,nsim=1000,tasks=10,cores=2,seed=3400835) 
# ranova_fam.2 <- summary(pbgmmDg2.2) %T>%
#   print() # p = 0.216... little var among families crossed w/ pops
# 
# # UNIQUE FAMILIES (so, results are about families)
# pbgmmDg3.2 <- pbnm(gmm3.2,gmmDG1.2,nsim=1000,tasks=10,cores=2,seed=3400835) 
# summary(pbgmmDg3.2) # p = 0.216... little var among families, period
# 
# 
# 
# 
# sum.1 <- summary(gmm4)
# 
# variances1 <- print(VarCorr(gmm4),comp="Variance") %>%
#   as.data.frame() %>%
#   dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
#   dplyr::select(., c(grp, vcov, PVE)) %>%
#   dplyr::rename(., Group = grp,
#                 Variance = vcov)
# 
# # export percent variance explained
# write.table(variances1, here::here("./Figures_Tables/ranova_PVE/2020_Floweringsuccess_urban_glmer_PVE.csv"), col.names=TRUE, sep=",", append=TRUE)
# 
# # export ranova
# sink(here::here("./Figures_Tables/ranova_PVE/2020_Floweringsuccess_urban_glmer_ranova.csv"))
# print("POPULATION", sep="\n\n")
# print(ranova_pop, sep="\n\n")
#   cat("\n")
# print("FAMILY", sep="\n\n")
# print(ranova_fam, sep="\n\n")
#   cat("\n")
# if (ranova_pop[1] <= 0.05){
#   print ('There is variance among populations')}
# if (ranova_pop[1] > 0.05){
#   print ("There is not much variance among populations")}
# if (ranova_fam[1] <= 0.05){
#   print ("There is variance among families")}
# if (ranova_fam[1] > 0.05){
#   print ("There is not much variance among families")}
#   
# cat("\n")
# cat("\n")
# 
# print("POPULATION", sep="\n\n")
# print(ranova_pop.2, sep="\n\n")
#   cat("\n")
# print("FAMILY", sep="\n\n")
# print(ranova_fam.2, sep="\n\n")
#   cat("\n")
# if (ranova_pop.2[1] <= 0.05){
#   print ('Variance among populations differs by urban subtransect')}
# if (ranova_pop.2[1] > 0.05){
#   print ("Variance among populations does not differ by urban subtransect")}
# if (ranova_fam.2[1] <= 0.05){
#   print ("Variance among families differs by urban subtransect")}
# if (ranova_fam.2[1] > 0.05){
#   print ("Variance among families does not differ by urban subtransect")}
# sink()
```

###### Urb_score
```{r}
car::Anova(flowering_urbsubs_usc_m1) # nothing sig
car::Anova(flowering_urbsubs_usc_m1_ME) # nothing sig

AIC(flowering_urbsubs_usc_m1, flowering_urbsubs_usc_m1_ME) # <2 away
```





#### Sig difference between urb vs rural? (Odds ratio)
```{r}
# # How many plants flowered per subtransect? using 2019 alive plants
# tib1 <- reproductive %>%
#   filter(Alive_DC1 != '0')%>%
#   group_by(Flowered2020, Urb_Rur) %>%
#   tally()
# tib1
# 
# 
# Flowered_ttest <- matrix(c(21, 3, 556, 282), nrow = 2,
#                          dimnames = list(
#                            c("Urban", "Rural"),
#                            c("Flowered", "Didn't Flower")))
# 
# fisher.test(Flowered_ttest, alternative = "two.sided")
# # odds ratio = 3.5464
# # p = 0.02859
# # medium effect size


# How many plants flowered per subtransect? using 2020 alive plants

tib2 <- reproductive %>%
  filter(Alive_DC1 == 1) %>%
  group_by(Flowered2020, Urb_Rur) %>%
  tally()
tib2


Flowered_ttest2 <- matrix(c(
  as.integer(tib2[2,3]),
  as.integer(tib2[4,3]),
  as.integer(tib2[4,3]),
  as.integer(tib2[3,3])),
  nrow = 2,
  dimnames = list(
    c("Rural", "Urban"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest2, alternative = "two.sided")
# odds ratio = 3.761
# p = 0.0655
# Medium effect size

chisq.test(Flowered_ttest2)
# X-squared = 3.823, df = 1, p-value = 0.05055





# How many populations had at least one plant flower per subtransect? using 2020 alive plants

tib3 <- reproductive %>%
  group_by(Population, Flowered2020, Urb_Rur) %>%
  dplyr::summarise(Pops = n_distinct(Population),
                   Urb_Rur = first(Urb_Rur)) %>%
  group_by(Population, Urb_Rur) %>%
  dplyr::summarise(Flowered = sum(as.integer(Flowered2020)),
                   Urb_Rur = first(Urb_Rur)) %>%
  group_by(Urb_Rur, Flowered) %>%
  dplyr::summarise(Pops = n_distinct(Population))
  
tib3
# Flowered = 1: Flowered
# Flowered = 0: Didn't flower



Flowered_ttest3 <- matrix(c(
  as.integer(tib3[2,3]),
  as.integer(tib3[4,3]),
  as.integer(tib3[4,3]),
  as.integer(tib3[3,3])),
  nrow = 2,
  dimnames = list(
    c("Rural", "Urban"),
    c("Flowered", "Didn't Flower")))

fisher.test(Flowered_ttest3, alternative = "two.sided")
# odds ratio = 0.5064
# p = 0.5034
# Medium effect size


chisq.test(Flowered_ttest3)
# X-squared = 0.3782, df = 1, p-value = 0.5386
```



#### Sig difference between urb:north vs urb:south? (Odds ratio)
```{r}
# How many plants flowered per subtransect? using 2020 alive plants

tib4 <- reproductive %>%
  filter(., Transect_ID != 'Rural') %>%
  group_by(Flowered2020, Transect_ID) %>%
  tally()
tib4


Flowered_ttest4 <- matrix(c(
  as.integer(tib4[3,3]),
  as.integer(tib4[4,3]),
  as.integer(tib4[1,3]),
  as.integer(tib4[2,3])),
  nrow = 2,
  dimnames = list(
    c("North", "South"),
    c("Flowered", "Didn't Flower"))) %T>%
  print()

fisher.test(Flowered_ttest4, alternative = "two.sided")
# odds ratio = 0.782
# p = 0.660 (CAN'T REJECT THE NULL)
# negligible effect size

chisq.test(Flowered_ttest4)
# X-squared = 0.081128, df = 1, p-value = 0.7758






# How many populations had at least one plant flower per subtransect? using 2020 alive plants

tib5 <- reproductive %>%
  filter(., Transect_ID != "Rural") %>%
  group_by(Population, Flowered2020, Transect_ID) %>%
  dplyr::summarise(Pops = n_distinct(Population),
                   Transect_ID = first(Transect_ID)) %>%
  group_by(Population, Transect_ID) %>%
  dplyr::summarise(Flowered = sum(as.integer(Flowered2020)),
                   Transect_ID = first(Transect_ID)) %>%
  group_by(Transect_ID, Flowered) %>%
  dplyr::summarise(Pops = n_distinct(Population))
  
tib5
# Flowered = 0: Didn't flower
# Flowered = 1: Did flower



Flowered_ttest5 <- matrix(c(
  as.integer(tib5[1,3]),
  as.integer(tib5[3,3]),
  as.integer(tib5[2,3]),
  as.integer(tib5[4,3])),
  nrow = 2,
  dimnames = list(
    c("North", "South"),
    c("Didn't Flower", "Flowered"))) %T>%
  print()

fisher.test(Flowered_ttest5, alternative = "two.sided")
# odds ratio = 0.851
# p = 1 (NOT SIGNIFICANT; CAN'T REJECT NULL)
# small effect size

chisq.test(Flowered_ttest5)
# X-squared = 0.41878, df = 1, p-value = 0.5175
```


#### Block effect?
```{r}
glmer(Flowered2020 ~ Block + (1|Population/Family),
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=1,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))

car::Anova(glmer(Flowered2020 ~ Block + (1|Population/Family),
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=1,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# Block is significant, so yes, the number of plants that flowered DID significantly vary by block.

summary(glmer(Flowered2020 ~ Block + (1|Population/Family),
  data = reproductive,
  family = binomial(link = "logit"),
  nAGQ=1,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
```
