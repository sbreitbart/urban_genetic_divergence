---
title: "Reproductive Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

NOTES:

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| All reproductive traits     |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
```{r}
source(knitr::purl("Reproductive_trait_analyses/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))
```

# Ranova- RETURN HERE
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
- Also using Pop/Fam instead of Pop:Fam or Pop/Fam_uniq like I did when making models earlier
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## Gradient / City_dist
# Anova
## Flowering success
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_urbscore_alt.png"))
```

## Total flowers/plant
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_urbscore_alt.png"))
```


## Mean flower size/inflorescence
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsize_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowerSize_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```


## Flowering time
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringtime_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(fltime_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringtime_urbscore_alt.png"))
```


## Flowering start
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_citydist.png"))
```

#### Urb_score
```{r}
# working with 3 dfs instead of 2, so tweaking function to reflect his

lapply(flstart_mods_best_u, tidy_anova) %>%
      lapply(., as.data.frame) %>%
      purrr::reduce(full_join) %>%
      replace(., is.na(.), "-") %>%
      dplyr::filter(Predictor != "(Intercept)") %>%
  dplyr::mutate(Sites = ifelse(row_number() == 5, "Urban Only",Sites)) %>%
    dplyr::mutate(Sites = ifelse(row_number() == 6, "Urban Only",Sites)) %>%
      dplyr::mutate(Sites = ifelse(row_number() == 7, "Urban Only",Sites)) %>%

      flextable::flextable() %>% 
      merge_v(j = "Response") %>% 
    #  merge_v(j = "Sites") %>% 
      valign(valign = "top") %>%
      flextable::autofit() %>%
      merge_at(i = 1:2, j = 2) %>% 
      merge_at(i = 3:4, j = 2) %>% 
      merge_at(i = 5:7, j = 2) %>% 
      align(j = c(1, 3), align = "left", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "all") %>%
      align(j = c(2,4,5), align = "center", part = "header") %>%
      flextable::compose(i = 1, j = 4, part = "header",
                         value = as_paragraph("Ï‡", as_sup("2"))) %>%
      flextable::compose(i = 1, j = 5, part = "header",
                         value = as_paragraph(as_i("p"))) %>%
      fontsize(size = 12, part = "header") %>%
      fontsize(size = 12, part = "body") %>%
      #theme_booktabs()%>%
      fix_border_issues() %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Floweringstart_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flstart_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Floweringstart_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```



## Pods
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_urbscore_alt.png"))
```


## Peduncles
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Peduncles_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```

# Odds Ratio
## Flowering success: Compare urb vs rural populations (NS)
```{r}
Flowering_pops <- reproduc %>%
  dplyr::group_by(Population, Year, Urb_Rur) %>%
  dplyr::summarise(Pop_flowered = sum(Flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_cumulative <- Flowering_pops %>%
  dplyr::group_by(Population, Urb_Rur) %>%
  dplyr::summarise(Pop_flowered = sum(Pop_flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_urbrur_cumulative <- Flowering_pops_cumulative %>%
  dplyr::group_by(Urb_Rur) %>%
  dplyr::summarise(Pops_flowered = sum(Pop_flowered),
                   Pops_total = n_distinct(Population)
                   ) %T>%
  print()


Flowered_ttest2 <- matrix(c(
  as.integer(Flowering_pops_urbrur_cumulative[1,2]),
  
  as.integer(Flowering_pops_urbrur_cumulative[2,2]),
  
  as.integer(Flowering_pops_urbrur_cumulative[1,3]) - as.integer(Flowering_pops_urbrur_cumulative[1,2]),
  
  as.integer(Flowering_pops_urbrur_cumulative[2,3]) - as.integer(Flowering_pops_urbrur_cumulative[2,2])
  ),
  
  nrow = 2,
  dimnames = list(
    c("Rural", "Urban"),
    c("Flowered", "Didn't Flower"))) %T>%
  print()

fisher.test(Flowered_ttest2, alternative = "two.sided")
# odds ratio = 2.136676 
# p = 0.34
# Small effect size

chisq.test(Flowered_ttest2)
# X-squared = 0.5472, df = 1, p-value = 0.4595

```


## Flowering success: Compare corridor vs non-corridor pops (NS)
```{r}
Flowering_pops_urban <- reproduc %>%
  dplyr::group_by(Population, Year, Transect_ID) %>%
  dplyr::filter(Transect_ID != "Rural") %>%
  dplyr::summarise(Pop_flowered = sum(Flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_urban_cumulative <- Flowering_pops_urban %>%
  dplyr::group_by(Population, Transect_ID) %>%
  dplyr::summarise(Pop_flowered = sum(Pop_flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_transects_cumulative <- Flowering_pops_urban_cumulative %>%
  dplyr::group_by(Transect_ID) %>%
  dplyr::summarise(Pops_flowered = sum(Pop_flowered),
                   Pops_total = n_distinct(Population)
                   ) %T>%
  print()


Flowered_ttest2 <- matrix(c(
  as.integer(Flowering_pops_transects_cumulative[1,2]),
  
  as.integer(Flowering_pops_transects_cumulative[2,2]),
  
  as.integer(Flowering_pops_transects_cumulative[1,3]) - as.integer(Flowering_pops_transects_cumulative[1,2]),
  
  as.integer(Flowering_pops_transects_cumulative[2,3]) - as.integer(Flowering_pops_transects_cumulative[2,2])
  ),
  
  nrow = 2,
  dimnames = list(
    c("Non-Corridor", "Corridor"),
    c("Flowered", "Didn't Flower"))) %T>%
  print()

fisher.test(Flowered_ttest2, alternative = "two.sided")
# odds ratio = 0.8501017  
# p = 1
# Small effect size

chisq.test(Flowered_ttest2)
# X-squared = 1.3188e-31, df = 1, p-value = 1

```

# R-squared values
```{r}
# took out lists 4 and 5 from all_models- the herbivory ones- because R.squaredGLMM can't intake models with beta family
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

# pretty low marginal R2 values. Some conditional R2 are high but most low
```