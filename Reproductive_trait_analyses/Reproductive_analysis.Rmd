---
title: "Reproductive Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console

# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

NOTES:

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| All reproductive traits     |           | X         | X         |
+-----------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import data
```{r}
reproduc <- read.csv(here::here("./Joined_annual_data/reproductive.csv"), na.strings=c("NO PLANT", "none", "NA"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1)%>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.factor)

flowering <- read.csv(here::here("./Joined_annual_data/flowering.csv"), na.strings=c("NO PLANT", "none", "NA"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1)%>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.factor) 
```

## Import final models
### Create full list
```{r}
source(knitr::purl("Reproductive_trait_analyses/Model_diagnostics_Reproduc.Rmd", quiet=TRUE))

all_models <- list(
flsucc_mods      , # flowering success
flowers_mods     , # total flowers/plant
flsize_mods      , # mean flower size
pods_mods        , # pods (follicles)
peduncles_mods   ) # peduncles (inflorescences)

names(all_models) <- c(
"flsucc_mods"          ,
"flowers_mods"         ,
"flsize_mods"          ,
"pods_mods"            ,
"peduncles_mods")
```

### Create separate lists of best vs. alt models for city_dist vs urb_score
#### flowering success
```{r}
## Best
### City_dist
flsucc_mods_best_c <- flsucc_mods[c(1,4)]

### Urb_score
flsucc_mods_best_u <- flsucc_mods[c(2,6)]

## Alt
### City_dist
flsucc_mods_alt_c <- flsucc_mods[3]

### Urb_score
flsucc_mods_alt_u <- flsucc_mods[5]
```

#### total flowers/plant
```{r}
## Best
### City_dist
flowers_mods_best_c <- flowers_mods[c(1,4)]

### Urb_score
flowers_mods_best_u <- flowers_mods[c(2,6)]

## Alt
### City_dist
flowers_mods_alt_c <- flowers_mods[3]

### Urb_score
flowers_mods_alt_u <- flowers_mods[5]

```


#### mean flower size
```{r}
## Best
### City_dist
flsize_mods_best_c <- flsize_mods[c(1,4)]

### Urb_score
flsize_mods_best_u <- flsize_mods[c(2,5)]

## Alt
### City_dist
flsize_mods_alt_c <- flsize_mods[3]

### Urb_score- NONE
```

#### pods (follicles)
```{r}
## Best
### City_dist
pods_mods_best_c <- pods_mods[c(1,4)]

### Urb_score
pods_mods_best_u <- pods_mods[c(2,5)]

## Alt
### City_dist
pods_mods_alt_c <- pods_mods[3]

### Urb_score
pods_mods_alt_u <- pods_mods[6]
```


#### peduncles (inflorescences)
```{r}
## Best
### City_dist
peduncles_mods_best_c <- peduncles_mods[c(1,4)]

### Urb_score
peduncles_mods_best_u <- peduncles_mods[c(2,5)]

## Alt
### City_dist
peduncles_mods_alt_c <- peduncles_mods[3]

### Urb_score- NONE
```

# Ranova- RETURN HERE
The point: to determine if there is much genetic diversity present within populations for natural selection to act on.
- ranova can't handle GLMMTMB functions so I'll use lmer instead
- Also using Pop/Fam instead of Pop:Fam or Pop/Fam_uniq like I did when making models earlier
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## Gradient / City_dist
# Anova
## Flowering success
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(flsucc_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(flsucc_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FloweringSuccess_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flsucc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FloweringSuccess_urbscore_alt.png"))
```

## Total flowers/plant
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(flowers_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(flowers_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowersPerPlant_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(flowers_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowersPerPlant_urbscore_alt.png"))
```


## Mean flower size/inflorescence
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(flsize_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(flsize_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/FlowerSize_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(flsize_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/FlowerSize_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```


## Pods
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(pods_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(pods_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Pods_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(pods_mods_alt_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Pods_urbscore_alt.png"))
```


## Peduncles
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(peduncles_mods_best_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(peduncles_mods_best_u) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Best_models/Peduncles_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(peduncles_mods_alt_c) %>%
  save_as_image(., path = here::here("./Reproductive_trait_analyses/Figures/ANOVA/Alt_models/Peduncles_citydist_alt.png"))
```

#### Urb_score
```{r}
# NONE
```

# Odds Ratio
## Flowering success: Compare urb vs rural populations (NS)
```{r}
Flowering_pops <- reproduc %>%
  dplyr::group_by(Population, Year, Urb_Rur) %>%
  dplyr::summarise(Pop_flowered = sum(Flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_cumulative <- Flowering_pops %>%
  dplyr::group_by(Population, Urb_Rur) %>%
  dplyr::summarise(Pop_flowered = sum(Pop_flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_urbrur_cumulative <- Flowering_pops_cumulative %>%
  dplyr::group_by(Urb_Rur) %>%
  dplyr::summarise(Pops_flowered = sum(Pop_flowered),
                   Pops_total = n_distinct(Population)
                   ) %T>%
  print()


Flowered_ttest2 <- matrix(c(
  as.integer(Flowering_pops_urbrur_cumulative[1,2]),
  
  as.integer(Flowering_pops_urbrur_cumulative[2,2]),
  
  as.integer(Flowering_pops_urbrur_cumulative[1,3]) - as.integer(Flowering_pops_urbrur_cumulative[1,2]),
  
  as.integer(Flowering_pops_urbrur_cumulative[2,3]) - as.integer(Flowering_pops_urbrur_cumulative[2,2])
  ),
  
  nrow = 2,
  dimnames = list(
    c("Rural", "Urban"),
    c("Flowered", "Didn't Flower"))) %T>%
  print()

fisher.test(Flowered_ttest2, alternative = "two.sided")
# odds ratio = 2.136676 
# p = 0.34
# Small effect size

chisq.test(Flowered_ttest2)
# X-squared = 0.5472, df = 1, p-value = 0.4595

```


## Flowering success: Compare corridor vs non-corridor pops (NS)
```{r}
Flowering_pops_urban <- reproduc %>%
  dplyr::group_by(Population, Year, Transect_ID) %>%
  dplyr::filter(Transect_ID != "Rural") %>%
  dplyr::summarise(Pop_flowered = sum(Flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_urban_cumulative <- Flowering_pops_urban %>%
  dplyr::group_by(Population, Transect_ID) %>%
  dplyr::summarise(Pop_flowered = sum(Pop_flowered)) %>%
  dplyr::mutate(Pop_flowered = case_when(Pop_flowered >= 1 ~ 1,
                                         Pop_flowered == 0 ~ 0)) %T>%
  print()

Flowering_pops_transects_cumulative <- Flowering_pops_urban_cumulative %>%
  dplyr::group_by(Transect_ID) %>%
  dplyr::summarise(Pops_flowered = sum(Pop_flowered),
                   Pops_total = n_distinct(Population)
                   ) %T>%
  print()


Flowered_ttest2 <- matrix(c(
  as.integer(Flowering_pops_transects_cumulative[1,2]),
  
  as.integer(Flowering_pops_transects_cumulative[2,2]),
  
  as.integer(Flowering_pops_transects_cumulative[1,3]) - as.integer(Flowering_pops_transects_cumulative[1,2]),
  
  as.integer(Flowering_pops_transects_cumulative[2,3]) - as.integer(Flowering_pops_transects_cumulative[2,2])
  ),
  
  nrow = 2,
  dimnames = list(
    c("Non-Corridor", "Corridor"),
    c("Flowered", "Didn't Flower"))) %T>%
  print()

fisher.test(Flowered_ttest2, alternative = "two.sided")
# odds ratio = 0.8501017  
# p = 1
# Small effect size

chisq.test(Flowered_ttest2)
# X-squared = 1.3188e-31, df = 1, p-value = 1

```

# R-squared values
```{r}
# took out lists 4 and 5 from all_models- the herbivory ones- because R.squaredGLMM can't intake models with beta family
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

# pretty low marginal R2 values. Some conditional R2 are high but most low
```