---
title: "KSR_2019_Height_Survival_Analysis1"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: yes

---

# 1.1 Load packages

```{r}
library(dplyr)
library(reshape)
library(reshape2)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# 1.2 Import data

```{r, import}
Data <- read.table("~/R_Projects/CommonGardenExperiment_2019Data/DataAnalysis_FirstHeightSurvivalMeasurement_20190610.csv", na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",")

Distances <- read.table("~/R_Projects/CommonGardenExperiment_2019Data/Transect_Milkweed_HaversineData_forjoining.csv", na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",")
```

# 1.2 Remove rows without plants, empty columns
Though 46 holes were dug per 21 rows of the field plot, each hole was not filled with a plant- ex. Row 1 has empty holes until plot column 13. Removing those empty spreadsheet rows as well as empty spreadsheet columns.
```{r}
b <- is.na(Data$Block) == TRUE
b2 <- c(1:nrow(Data))[b]
Data <- Data[-b2,]
Data <- Data[,-(29:35)]
names(Data)[1]<-"Row"
```


# 1.3 Make certain columns factors

```{r message=FALSE, warning=FALSE}

Data$Block <- factor(Data$Block)
Data$Population <- factor(Data$Population)
Data$Family <- factor(Data$Family)
Data$Replicate <- factor(Data$Replicate)

str(Data)
```


# 1.4 Create survival table
Table (then, data frame) shows each population x family combination (up to 5 families per population), alongside how many plants per population's family might be alive (column "maybe"), is definitely alive (column "no"), and is not alive because there was no plant found in the pot (column "nothing there"). These 3 categories are answers to the question, "is the plant dead?". 
```{r}
tab1 <- table(Data$Population,Data$Family, Data$Dead)
tab2 <- as.data.frame(tab1)
names(tab2)[1]<-"Population"
names(tab2)[2]<-"Family"
names(tab2)[3]<-"Dead"

a <- spread(tab2, Dead, Freq)

```

# 1.5 Edit table
Adding a "Total" column showing the total number of plants per population family. If the "Total" column = 0, removing that row. Before planting, that family had not been represented with replicates in the first place.
```{r}
a$Total <- NA
names(a)[5] <- "nothing_there"
a$Total <- rowSums(a[3:5])

a$maybe <- as.numeric(a$maybe)
a$no <- as.numeric(a$no)
a$nothing_there <- as.numeric(a$nothing_there)

a<-a[!(a$Total==0),] # removing rows corresponding to populations' a priori empty families

```


# 1.6 Find probable, definite survival percentages per family
Adding two columns which indicate the percentage of plants per family that are definitely alive (all dead=no plants) or probably alive (all dead=no plants + half of dead=maybe plants).
```{r}

a$Pct_Survival_Definite <- NA
a$Pct_Survival_Definite <- a$no/a$Total # definite survival assumes none of "maybe" milkweed survive
a$Pct_Survival_Definite <- signif(a$Pct_Survival_Definite, 2)*100

a$Pct_Survival_Probably <- NA
a$Pct_Survival_Probably <- (a$no + 0.5*a$maybe)/a$Total  # probable survival assumes half of "maybe" milkweed survive
a$Pct_Survival_Probably <- signif(a$Pct_Survival_Probably, 2)*100

a

```


# 1.7 Find probable, definite survival percentages per population
Same idea as in section 1.6 (table e), except percentages are for each population (combining each populations' families). Table f shows the total number of plants categorized as dead=no, dead=maybe, and dead=yes (aka "nothing there").
```{r}
e <- a %>% group_by(Population) %>% summarise(sum_no = sum(no),
                                              sum_maybe = sum(maybe),
                                              sum_nothingthere = sum(nothing_there),
                                              sum_total = sum(Total))

e$Pct_Survival_Definite <- NA
e$Pct_Survival_Definite <- e$sum_no/e$sum_total # definite survival assumes none of "maybe" milkweed survive
e$Pct_Survival_Definite <- signif(e$Pct_Survival_Definite, 2)*100

e$Pct_Survival_Probably <- NA
e$Pct_Survival_Probably <- (e$sum_no + 0.5*e$sum_maybe)/e$sum_total # probable survival assumes half of "maybe" milkweed survive
e$Pct_Survival_Probably <- signif(e$Pct_Survival_Probably, 2)*100

e


f <- as.data.frame(table(Data$Dead)) # total plants for each mortality status
names(f)[1]<-"Dead?"
names(f)[2]<-"Count"
f[1,2] + f[2,2] + f[3,2] # Total plants

f
```

#1.8 Plot of survival per population vs. distance from city center

```{r}
# When population location is spread over a few sites (e.g. there are several AS identifiers and only 1 MW identifier), coordinates chosen correspond to first AS site. E.g. For MW003, there are two AS sites- AS003 & AS004. AS003 will be designated to show the location of MW003. Same practice for MW004, 005, 006, 007.

Dist_merged <- merge(x = e, y = Distances, by = "Population", all.x = TRUE)

# Plot and stats for probable percent survival vs. distance from city center (weighted by total plants per population)
fig1 <- ggplot(Dist_merged, aes(x = Dist_city_center_km_Yonge_Bloor, y = Pct_Survival_Probably, weights=Dist_merged$sum_total)) +
  labs(x = "Distance to urban center (km)", y = "Survival Rate (Probable)") +
  geom_point(shape=21) +
  geom_smooth(method = "lm", se = T, mapping = aes(weight = Dist_merged$sum_total*0.5)) +
  scale_y_continuous(breaks=c(0,20, 40, 60,80,100), limits=c(0,100)) + 
  ggtitle('Weighted Probable Population Survival Rate vs. Distance from City Center')
fig1

Fig1_stats <- lm(Pct_Survival_Probably ~ Dist_city_center_km_Yonge_Bloor, data=Dist_merged, weights=sqrt(Dist_merged$Pct_Survival_Probably))
par(mfrow=c(2,2))
plot(Fig1_stats)
summary(Fig1_stats)


# Plot and stats for probable percent survival vs. distance from city center
fig2 <- ggplot(Dist_merged, aes(x = Dist_city_center_km_Yonge_Bloor, y = Pct_Survival_Probably)) +
  labs(x = "Distance to urban center (km)", y = "Survival Rate (Probable)") +
  geom_point(shape=21) +
  geom_smooth(method = "lm", se = T) +
  scale_y_continuous(breaks=c(0,20, 40, 60,80,100), limits=c(0,100)) + 
  ggtitle('Probable Population Survival Rate vs. Distance from City Center')
fig2

Fig2_stats <- lm(Pct_Survival_Probably ~ Dist_city_center_km_Yonge_Bloor, data=Dist_merged)
par(mfrow=c(2,2))
plot(Fig2_stats)
summary(Fig2_stats)

# Plot and stats for definite percent survival vs. distance from city center (weighted by total plants per population)
fig3 <- ggplot(Dist_merged, aes(x = Dist_city_center_km_Yonge_Bloor, y = Pct_Survival_Definite, weights=Dist_merged$sum_total)) +
  labs(x = "Distance to urban center (km)", y = "Survival Rate (Definite)") +
  geom_point(shape=21) +
  geom_smooth(method = "lm", se = T, mapping = aes(weight = Dist_merged$sum_total*0.5)) +
  scale_y_continuous(breaks=c(0,20, 40, 60,80,100), limits=c(0,100)) + 
  ggtitle('Weighted Definite Population Survival Rate vs. Distance from City Center')
fig3

Fig3_stats <- lm(Pct_Survival_Definite ~ Dist_city_center_km_Yonge_Bloor, data=Dist_merged, weights=sqrt(Dist_merged$Pct_Survival_Definite))
par(mfrow=c(2,2))
plot(Fig3_stats)
summary(Fig3_stats)


# Plot and stats for definite percent survival vs. distance from city center
fig4 <- ggplot(Dist_merged, aes(x = Dist_city_center_km_Yonge_Bloor, y = Pct_Survival_Definite)) +
  labs(x = "Distance to urban center (km)", y = "Survival Rate (Definite)") +
  geom_point(shape=21) +
  geom_smooth(method = "lm", se = T) +
  scale_y_continuous(breaks=c(0,20, 40, 60,80,100), limits=c(0,100)) + 
  ggtitle('Definite Population Survival Rate vs. Distance from City Center')
fig4

Fig4_stats <- lm(Pct_Survival_Definite ~ Dist_city_center_km_Yonge_Bloor, data=Dist_merged)
par(mfrow=c(2,2))
plot(Fig4_stats)
summary(Fig4_stats)

```

