---
title: "Growth/Morphological Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients
# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+---------------------------------+-----------+-----------+-----------+
| Trait                           | 2019 Data | 2020 Data | 2021 Data |
+=================================+:=========:+:=========:+:=========:+
| LDMC & SLA                      |           | X         |           |
+---------------------------------+-----------+-----------+-----------+
| All other growth-related traits | X         | X         | X         |
+---------------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
### Create full list
```{r}
source(knitr::purl("Growth_trait_analyses/Model_diagnostics_Growth.Rmd", quiet=TRUE))
```

# Ranova
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## gaussian distribution models
### Gradient
#### City_dist
```{r}
# LDMC-------
ldmc_ranova_mod1 <- lmer(LDMC ~
                           (1|Population/Family) +
                           Block +
                           City_dist,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 1),
                           REML = T)

ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ldmc.html"))


# SLA-----
sla_ranova_mod1 <- lmer(SLA ~
                          (1|Population/Family) +
                          Block +
                          City_dist,
                        data = sla_ldmc,
                        REML = T)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/sla.html"))


# Rel growth rate-----
rgr_ranova_mod1 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                        data = heights,
                        REML = T)


rgr_ranova1 <- CreateRanovaOutput(rgr_ranova_mod1, "Relative growth rate") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/rgr.html"))

# Total_Height_early-----
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                        data = heights,
                        REML = T)


heights_e_ranova1 <- CreateRanovaOutput(heights_e_ranova_mod1, "Height (before flowering)") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/heights_early.html"))


# Total_Height_late-----
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                        data = heights,
                        REML = T)


heights_l_ranova1 <- CreateRanovaOutput(heights_l_ranova_mod1, "Height (after flowering)") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/heights_late.html"))
```

#### Urb_score- NOT UPDATED SINCE MAY 2022
```{r}
# LDMC-------
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 1),
                           REML = T)

ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod2, "LDMC") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/ldmc.html"))


# SLA-----
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Urb_score,
                        data = sla_ldmc,
                        REML = T)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod2, "SLA") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/sla.html"))
```

### Urban subtransects
#### City_dist
```{r}
# LDMC-------
## test City_dist
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + Block + City_dist,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test Transect
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + Block + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC (Distance)")
ldmc_ranova2 <- CreateRanovaOutput_Q2(ldmc_ranova_mod2, "LDMC (Transect)")

flextable::save_as_html(ldmc_ranova1,
                        ldmc_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ldmc_transects.html"))


# SLA-----
## test City_dist
sla_ranova_mod1 <- lmer(sqrt(SLA) ~ (1|Population/Family) + Block + City_dist,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + Block + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA (Distance)")
sla_ranova2 <- CreateRanovaOutput_Q2(sla_ranova_mod2, "SLA (Transect)")

flextable::save_as_html(sla_ranova1,
                        sla_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/sla_transects.html"))

# Rel growth rate-----
## test City_dist
rgr_ranova_mod1 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
rgr_ranova_mod2 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          Transect_ID,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


rgr_ranova1 <- CreateRanovaOutput(rgr_ranova_mod1, "Relative growth rate (Distance)")
rgr_ranova2 <- CreateRanovaOutput_Q2(rgr_ranova_mod2, "Relative growth rate (Transect)")

flextable::save_as_html(rgr_ranova1,
                        rgr_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/rgr_transects.html"))


# Total_Height_early-----
## test City_dist
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
heights_e_ranova_mod2 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          Transect_ID,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


heights_e_ranova1 <- CreateRanovaOutput(heights_e_ranova_mod1, "Heights (before flowering) (Distance)")
heights_e_ranova2 <- CreateRanovaOutput_Q2(heights_e_ranova_mod2, "Heights (before flowering) (Transect)")

flextable::save_as_html(heights_e_ranova1,
                        heights_e_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/heights_e_transects.html"))

# Total_Height_late-----
## test City_dist
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
heights_l_ranova_mod2 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          Transect_ID,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


heights_l_ranova1 <- CreateRanovaOutput(heights_l_ranova_mod1, "Heights (after flowering) (Distance)")
heights_l_ranova2 <- CreateRanovaOutput_Q2(heights_l_ranova_mod2, "Heights (after flowering) (Transect)")

flextable::save_as_html(heights_l_ranova1,
                        heights_l_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/heights_l_transects.html"))
```

#### Urb_score- NOT UPDATED SINCE MAY 2022
```{r}
# LDMC-------
## test Urb_score
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC (Urbanization Score)")
ldmc_ranova2 <- CreateRanovaOutput_Q2(ldmc_ranova_mod2, "LDMC (Transect)")

flextable::save_as_html(ldmc_ranova1,
                        ldmc_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/ldmc_transects.html"))


# SLA-----
## test Urb_score
sla_ranova_mod1 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA (Urbanization Score)")
sla_ranova2 <- CreateRanovaOutput_Q2(sla_ranova_mod2, "SLA (Transect)")

flextable::save_as_html(sla_ranova1,
                        sla_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/sla_transects.html"))

```


## poisson models- use pbmodcomp()
### Gradient
```{r}
# Number of ramets (early)-------

# take out fam- NOT CONVERGING unless I add nagq = 0
full <- glmer(Ramets_early ~
                Block +
                 Year +
                 (1|Population) +
                  City_dist,
                data = heights,
              family = poisson,
              nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

ramets_e_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(ramets_e_ranova.pop) # p = 0.342 w/nsim = 10, 100, and 1000

# PVE
get_pve(full) # 5.303


# take out pop
full <- glmer(Ramets_early ~
                Block + Year +
                (1|Population/Family) + City_dist,
                              data = heights,
                              family = poisson,
              nAGQ = 0,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)

ramets_e_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
                    cl = makeCluster(6))

tidy(ramets_e_ranova.fam) # Family: p ~ 0.328

# PVE
get_pve(full) # 16.478


# merge Pop and Fam ranovas
ramets_e_ranova1 <- CreateRanovaOutput_bootstrap(ramets_e_ranova.fam, ramets_e_ranova.pop, "Ramets, before flowering") %T>%
  flextable::save_as_html(path = here::here("./Growth_trait_analyses/Tables/Ranova/ramets_early.html"))


# Number of ramets (LATE)-------

# take out fam- NOT CONVERGING unless I add nagq = 0
full <- glmer(Ramets_late ~
               Block +
              Year +
                 (1|Population) +
                  City_dist,
                data = heights,
              family = poisson,
              nAGQ = 0,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

ramets_l_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(ramets_l_ranova.pop) # p = 0.160

get_pve(full) # 2.08



# take out pop
full <- glmer(Ramets_late ~
                Block + Year +
                (1|Population/Family) + City_dist,
                              data = heights,
                              family = poisson,
              nAGQ = 0,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)

ramets_l_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
                    cl = makeCluster(7))

tidy(ramets_l_ranova.fam) # Family: p ~ 0.137

get_pve(full) # 8.065



# merge Pop and Fam ranovas
ramets_l_ranova1 <- CreateRanovaOutput_bootstrap(ramets_l_ranova.fam, ramets_l_ranova.pop, "Ramets, after flowering") %T>%
  flextable::save_as_html(path = here::here("./Growth_trait_analyses/Tables/Ranova/ramets_late.html"))

# Mortality-------

# take out fam
full <- glmer(Dead ~
                 Block +
                Year +
                (1|Population) +
                City_dist,
              data = survival ,
              family = binomial,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

surv_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(rep("localhost", 8)))

tidy(surv_ranova.pop) # p = 0.786
get_pve(full) # 7.667


# take out pop
full <- glmer(Dead ~
                 Block +
                Year +
                (1|Population/Family) +
                City_dist,
              data = survival ,
              family = binomial,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

surv_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(rep("localhost", 8)))

tidy(surv_ranova.fam) # Family: p ~ 0.805

get_pve(full) # 21.311


# merge Pop and Fam ranovas
surv_ranova1 <- CreateRanovaOutput_bootstrap(
  surv_ranova.fam, 
  surv_ranova.pop,
  "Mortality") %T>%
  flextable::save_as_html(path = here::here("./Growth_trait_analyses/Tables/Ranova/mortality.html"))

```

### Urb subs
```{r}
# Ramets (before flowering)-------
## test city_dist
### take out fam
full <- glmer(Ramets_early ~
               Block +
               Year +
                (1|Population) + City_dist,
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = poisson,
              nAGQ = 0,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)


ramets_e_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(ramets_e_ranova.pop) # Pop: p ~ 0.102

get_pve(full) # 6.993



### take out pop
full <- glmer(Ramets_early ~
                Block + Year +
                (1|Population/Family) + City_dist,
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = poisson,
              nAGQ = 0,
             na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))  )

reduced <- update(full, .~. - City_dist)


ramets_e_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(ramets_e_ranova.fam) # Family: p ~ 0.137

get_pve(full) # 18.643


## test transect
test_tr <- glmer(Ramets_early ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = poisson,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
ramets_e_ranova1 <- CreateRanovaOutput_bootstrap(
  ramets_e_ranova.fam,
  ramets_e_ranova.pop,
  "Ramets, before flowering (Distance)")

## test transect
ramets_e_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Ramets, before flowering: (Transect)")

flextable::save_as_html(ramets_e_ranova1,
                        ramets_e_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ramets_e_transects.html"))



# Ramets (after flowering)-------
## test city_dist
### take out fam- WON'T CONVERGE unless nagq = 0
full <- glmer(Ramets_late ~
               Block +
               Year +
                (1|Population) + City_dist,
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = poisson,
              nAGQ = 0,
             na.action = na.exclude # THIS LINE IS IMPORTANT
    # ,control=glmerControl(optimizer="bobyqa",
    #                         optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)


ramets_l_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(ramets_l_ranova.pop) # Pop: p ~ 0.102

get_pve(full) # 2.082



### take out pop
full <- glmer(Ramets_late ~
               Block + Year +
                (1|Population/Family) + City_dist + Transect_ID,
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),                              family = poisson,
              nAGQ = 0,
             na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))  )

reduced <- update(full, .~. - City_dist)

ramets_l_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(6))

tidy(ramets_l_ranova.fam) # Family: p ~ 0.0936

get_pve(full) # 8.629


## test transect
test_tr <- glmer(Ramets_late ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = poisson,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
ramets_l_ranova1 <- CreateRanovaOutput_bootstrap(ramets_l_ranova.fam, ramets_l_ranova.pop, "Ramets, after flowering: (Distance)")

## test transect
ramets_l_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Ramets, after flowering: (Transect)")

flextable::save_as_html(ramets_l_ranova1,
                        ramets_l_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ramets_l_transects.html"))

# Mortality-------

## test city_dist
### take out fam
full <- glmer(Dead ~
                 Block +
                Year +
                (1|Population) +
                City_dist,
              data = survival %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

surv_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(rep("localhost", 6)))

tidy(surv_ranova.pop) # p = 0.321

get_pve(full) # 7.748


# take out pop
full <- glmer(Dead ~
                 Block +
                Year +
                (1|Population/Family) +
                City_dist,
              data = survival %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)

reduced <- update(full, .~. - City_dist)

surv_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(rep("localhost", 6)))

tidy(surv_ranova.fam) # Family: p ~ 0.149

get_pve(full) # 24.011



## test transect
test_tr <-  glmer(Dead ~
                 Block +
                Year +
                (1|Population/Family) +
                Transect_ID,
              data = survival %>%
                dplyr::filter(Transect_ID != "Rural"),
              family = binomial,
            na.action = na.exclude # THIS LINE IS IMPORTANT
    ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
)


# merge Pop and Fam ranovas
## test City_dist
surv_ranova1 <- CreateRanovaOutput_bootstrap(
  surv_ranova.fam,
  surv_ranova.pop,
  "Mortality (Distance)")

## test transect
surv_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Mortality (Transect)")

flextable::save_as_html(surv_ranova1,
                        surv_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Mortality_transects.html"))
```

## Create figure showing % variance explained per component
Note: Can only do this for gaussian models for Q1. For models with transect as an effect, I can calculate PVE for models testing effect of distance only- not transect. But since I'm not as interested in that, I won't generate those plots now.
```{r}

# can't figure out how to convert these ranova html tables with PVE into df or tibble or anything else with code.
# So I'll just create an excel file combining the data from traits for which I could calculate PVE ("PVE_growth_Q1.xlsx"), including these traits:
# -relative growth rate ("rgr.html")
# -LDMC ("ldmc.html")
# -SLA ("sla.html")
# -Height (before flowering) ("heights_early.html")
# -Height (after flowering) ("heights_late.html")



pve <- read.csv(here::here("./Growth_trait_analyses/Tables/Ranova/pve_growth_Q1.csv")) %>%
  dplyr::rename(Variable = 1) %>%
  # make alphabetical order for plot
   mutate(Variable = fct_reorder(Variable,
                                 desc(Variable)))

library("ggsci")

pve_growth <- ggplot(pve,
       aes(
         fill=Group,
         y=PVE,
         x=Variable)
       ) + 
  geom_bar(position="stack",
           stat="identity") +
  scale_fill_discrete(labels = c("Family",
                                 "Population",
                                 "Residual")) +
  scale_fill_tron(alpha = 0.7) +
  theme_pubr() +
  xlab("") +
  ylab("% Variance Explained") +
  coord_flip()
pve_growth

ggsave(filename = "pve_growth_Q1.png",
         plot = pve_growth,
         path = here::here("./Growth_trait_analyses/Figures/PVE/"),
         width = 20,
         height = 8,
         units = "cm")
```

# Anova
## LDMC

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/LDMC_citydist.png"))

```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/LDMC_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/LDMC_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/LDMC_urbscore_alt.png"))
```

## SLA

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(sla_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/sla_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(sla_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/sla_urbscore.png"))
```

### Alt Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/sla_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/sla_urbscore_alt.png"))
```

## Heights- Early

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_urbscore_alt.png"))
```

## Heights- Late

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods_altmods(heights_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods_altmods(heights_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_urbscore_alt.png"))
```

## Relative growth rate

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(rgr_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(rgr_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods_altmods(rgr_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods_altmods(rgr_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_urbscore_alt.png"))
```

## Ramets- Early

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods_altmods(ramets_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods_altmods(ramets_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_urbscore_alt.png"))
```

## Ramets- Late

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_urbscore_alt.png"))
```

## Mortality
#### City_dist

```{r}
make_all_anovas_tidy_altmods(mortality_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/mortality_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(mortality_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/mortality_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(mortality_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/mortality_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(mortality_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/mortality_urbscore_alt.png"))
```

# R-squared values

```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Growth_trait_analyses/Tables/Rsquare.csv"))
```

# Calculate heritability, Qst, and CVA
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"
```{r}
# LDMC-----
update(
    ldmc_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ldmc_mean <- sla_ldmc %>%
  dplyr::filter(LDMC < 1) %>% # as done in model
  dplyr::summarize(Mean = mean(LDMC,
                               na.rm = T)) %>%
  as.numeric()

qg_ldmc <- calc_quantgenvars( 9.4956e-06,
                   2.2071e-05,
                   0.387388,
                   5.8581e-02,
                   "LDMC")


# SLA-----
update(
    sla_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

sla_mean <- sla_ldmc %>%
  dplyr::summarize(Mean = mean(SLA,
                               na.rm = T)) %>%
  as.numeric()

qg_sla <- calc_quantgenvars(4.5386e-06,
                   9.5195e-06,
                    4.0241e-01,
                   sla_mean,
                   "SLA")


# heights, early-----

update(
    heights_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_early,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_e <- calc_quantgenvars(0.36591,
                                  0.15034 ,
                                  1.12547 ,
                   heights_e_mean,
                   "Height (before flowering)")


# heights, late-----

update(
    heights_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_late,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_l <- calc_quantgenvars(0.49420 ,
                                  0.22338  ,
                                  1.56537  ,
                   heights_l_mean,
                   "Height (after flowering)")

# RGR-----
update(
    rgr_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

rgr_mean <- heights %>%
  dplyr::summarize(Mean = mean(rel_growth_rate,
                               na.rm = T)) %>%
  as.numeric()
 
qg_rgr <- calc_quantgenvars( 3.8967e-06 ,
                             2.6174e-03 ,
                            5.5405e-02,
                   rgr_mean,
                   "Relative growth rate")

# Ramets, early-----
update(
    ramets_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_early,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_early_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_e <- calc_quantgenvars( 0.247111,
                             0.080902,
                            resid_var,
                   ramets_e_mean,
                   "Ramets (before flowering)")

# Ramets, late-----
update(
    ramets_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_late,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_late_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_l <- calc_quantgenvars( 0.187996,
                             0.052465,
                            resid_var,
                   ramets_l_mean,
                   "Ramets (after flowering)")


# Survival-----
update(
    mortality_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

surv_mean <- survival %>%
  as.data.frame %>%
  dplyr::summarize(Mean = mean(Dead ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     mortality_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_survival <- calc_quantgenvars(6.6969e-08,
                   1.3094e-05,
                   resid_var ,
                   NA, # can't calculate this because it involves dividing by zero
                   "Mortality")
```

## Combine values into one table and export
```{r}
qg_joined <- list(qg_ldmc,
                  qg_sla,
                  qg_heights_e,
                  qg_heights_l,
                  qg_rgr,
                  qg_ramets_e,
                  qg_ramets_l,
                  qg_survival
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Growth_trait_analyses/Tables/quant_gen_growth.csv",
          row.names=FALSE)

```