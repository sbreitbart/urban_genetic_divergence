# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
### Create full list
```{r}
source(knitr::purl("Growth_trait_analyses/Model_diagnostics_Growth.Rmd", quiet=TRUE))
```

# Ranova
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## gaussian distribution models
### Gradient
```{r}
# LDMC-------
ldmc_ranova_mod1 <- lmer((LDMC)^(1/3) ~
                           (1|Population/Family) ,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 0.7),
                           REML = T)

# Check diagnostics and transform if necessary
performance::check_model(ldmc_ranova_mod1)

# export
ranova_2step(ldmc_ranova_mod1,
             "LDMC",
             "./Growth_trait_analyses/Tables/Ranova/ldmc.docx")


# SLA-----
sla_ranova_mod1 <- lmer(SLA^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = sla_ldmc %>%
                          dplyr::filter(is.na(SLA) == F),
                        REML = T)

# check diagnostics and transform if necessary
performance::check_model(sla_ranova_mod1)

# export
ranova_2step(sla_ranova_mod1,
             "SLA",
             "./Growth_trait_analyses/Tables/Ranova/sla.docx")


# Rel growth rate-----
# 2019--------
rgr_ranova_mod1 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2019),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod1)

# export
ranova_2step(rgr_ranova_mod1,
             "Relative growth rate: 2019",
             "./Growth_trait_analyses/Tables/Ranova/rgr_2019.docx")


# 2020--------
rgr_ranova_mod2 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2020),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod2)

# export
ranova_2step(rgr_ranova_mod2,
             "Relative growth rate: 2020",
             "./Growth_trait_analyses/Tables/Ranova/rgr_2020.docx")


# 2021--------
rgr_ranova_mod3 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2021),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod3)

# export
ranova_2step(rgr_ranova_mod3,
             "Relative growth rate: 2021",
             "./Growth_trait_analyses/Tables/Ranova/rgr_2021.docx")



# Total_Height_early-----
# 2019-----
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2019),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod1)

# export
ranova_2step(heights_e_ranova_mod1,
             "Height, before flowering: 2019",
             "./Growth_trait_analyses/Tables/Ranova/heights_early_2019.docx")


# 2020-----
heights_e_ranova_mod2 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2020),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod2)

# export
ranova_2step(heights_e_ranova_mod2,
             "Height, before flowering: 2020",
             "./Growth_trait_analyses/Tables/Ranova/heights_early_2020.docx")


# 2021-----
heights_e_ranova_mod3 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2021),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod3)

# export
ranova_2step(heights_e_ranova_mod3,
             "Height, before flowering: 2021",
             "./Growth_trait_analyses/Tables/Ranova/heights_early_2021.docx")



# Total_Height_late-----
# 2019-----
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2019),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod1)

# export
ranova_2step(heights_l_ranova_mod1,
             "Height, after flowering: 2019",
             "./Growth_trait_analyses/Tables/Ranova/heights_late_2019.docx")


# 2020-----
heights_l_ranova_mod2 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2020),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod2)

# export
ranova_2step(heights_l_ranova_mod2,
             "Height, after flowering: 2020",
             "./Growth_trait_analyses/Tables/Ranova/heights_late_2020.docx")


# 2021-----
heights_l_ranova_mod3 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2021),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod3)

# export
ranova_2step(heights_l_ranova_mod3,
             "Height, after flowering: 2021",
             "./Growth_trait_analyses/Tables/Ranova/heights_late_2021.docx")


```

### Urban subtransects
```{r}
# LDMC-------
ldmc_ranova_mod1 <- lmer(LDMC^(1/3) ~
                           (1|Population/Family) +
                           Block,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural" & LDMC < 0.7),
                           REML = T)


# check diagnostics and transform if necessary
performance::check_model(ldmc_ranova_mod1)

ranova_transect(ldmc_ranova_mod1,
                "LDMC",
                "./Growth_trait_analyses/Tables/Ranova/ldmc_transects.docx")


# SLA-----
sla_ranova_mod1 <- lmer((SLA)^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(sla_ranova_mod1)

ranova_transect(sla_ranova_mod1,
                "SLA",
                "./Growth_trait_analyses/Tables/Ranova/sla_transects.docx")


# Rel growth rate-----
# 2019-----
rgr_ranova_mod1 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block ,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2019),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod1)

ranova_transect(rgr_ranova_mod1,
                "Relative growth rate: 2019",
                "./Growth_trait_analyses/Tables/Ranova/rgr_transects_2019.docx")


# 2020-----
rgr_ranova_mod2 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block ,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod2)

ranova_transect(rgr_ranova_mod2,
                "Relative growth rate: 2020",
                "./Growth_trait_analyses/Tables/Ranova/rgr_transects_2020.docx")


# 2021-----
rgr_ranova_mod3 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block ,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod3)

ranova_transect(rgr_ranova_mod3,
                "Relative growth rate: 2021",
                "./Growth_trait_analyses/Tables/Ranova/rgr_transects_2021.docx")


# Total_Height_early-----
# 2019-----
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2019),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod1)

ranova_transect(heights_e_ranova_mod1,
                "Height before flowering: 2019",
                "./Growth_trait_analyses/Tables/Ranova/heights_e_transects_2019.docx")


# 2020-----
heights_e_ranova_mod2 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod2)

ranova_transect(heights_e_ranova_mod2,
                "Height before flowering: 2020",
                "./Growth_trait_analyses/Tables/Ranova/heights_e_transects_2020.docx")


# 2021-----
heights_e_ranova_mod3 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod3)

ranova_transect(heights_e_ranova_mod3,
                "Height before flowering: 2021",
                "./Growth_trait_analyses/Tables/Ranova/heights_e_transects_2021.docx")

# Total_Height_late-----
# 2019-----
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2019),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod1)

ranova_transect(heights_l_ranova_mod1,
                "Height after flowering: 2019",
                "./Growth_trait_analyses/Tables/Ranova/heights_l_transects_2019.docx")


# 2020-----
heights_l_ranova_mod2 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod2)

ranova_transect(heights_l_ranova_mod2,
                "Height after flowering: 2020",
                "./Growth_trait_analyses/Tables/Ranova/heights_l_transects_2020.docx")


# 2021-----
heights_l_ranova_mod3 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod3)

ranova_transect(heights_l_ranova_mod3,
                "Height after flowering: 2021",
                "./Growth_trait_analyses/Tables/Ranova/heights_l_transects_2021.docx")

```

## non-gaussian models
### Gradient
```{r}
# Number of ramets (early)-------
# 2019-----
ramets_e_ranova1 <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2019),
                            na.action = na.exclude,
                     #      
                             family = poisson)

# performance::check_model(ramets_e_ranova1)

pb_ranova_2step(ramets_e_ranova1,
          "Ramets before flowering: 2019",
           "./Growth_trait_analyses/Tables/Ranova/ramets_early_2019.docx")


# 2020-----
ramets_e_ranova2 <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                        #   
                             family = poisson)

# performance::check_model(ramets_e_ranova2)

pb_ranova_2step(ramets_e_ranova2,
          "Ramets before flowering: 2020",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2020.docx")


# 2021-----
ramets_e_ranova3 <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                       #     
                             family = poisson)

# performance::check_model(ramets_e_ranova3)
summary(ramets_e_ranova3)
insight::get_variance_random(ramets_e_ranova3)
pb_ranova_2step(ramets_e_ranova3,
          "Ramets before flowering: 2021",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2021.docx")


# Number of ramets (LATE)-------
# 2019-----
ramets_l_ranova1 <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2019),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(ramets_l_ranova1)

pb_ranova_2step(ramets_l_ranova1,
          "Ramets after flowering: 2019",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2019.docx")


# 2020-----
ramets_l_ranova2 <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                       #   
                             family = poisson)

# performance::check_model(ramets_l_ranova2)

pb_ranova_2step(ramets_l_ranova2,
          "Ramets after flowering: 2020",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2020.docx")


# 2021-----
ramets_l_ranova3 <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                      #    
                             family = poisson)

# performance::check_model(ramets_l_ranova3)

pb_ranova_2step(ramets_l_ranova3,
          "Ramets after flowering: 2021",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2021.docx")



# Mortality-------
# 2019-----
mortality_ranova1 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2019),
                            na.action = na.exclude, # ,control=glmerControl(optimizer="bobyqa",
  #                           optCtrl=list(maxfun=2e5)),
                           
                             family = binomial)

# performance::check_model(mortality_ranova1)

pb_ranova_2step(mortality_ranova1,
          "Mortality: 2019",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2019.docx")

# 2020-----
mortality_ranova2 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
  control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)),                             family = binomial)

# performance::check_model(mortality_ranova2)

pb_ranova_2step(mortality_ranova2,
          "Mortality: 2020",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2020.docx")


# 2021-----
mortality_ranova3 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2021),

                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(mortality_ranova3)

pb_ranova_2step(mortality_ranova3,
          "Mortality: 2021",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2021.docx")

# 2022-----
mortality_ranova4 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2022),
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(mortality_ranova4)

pb_ranova_2step(mortality_ranova4,
          "Mortality: 2022",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2022.docx")


```

### Urb subs
```{r}
# Ramets (before flowering)-------
# 2019-----
ramets_e_ranova1_pb <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2019),
                            na.action = na.exclude,
  control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)),                              family = poisson)

# performance::check_model(ramets_e_ranova1_pb)

pb_ranova_transects(ramets_e_ranova1_pb,
          "Ramets before flowering: 2019",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2019_transects.docx")



# 2020-----
ramets_e_ranova2_pb <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
  control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)),                              family = poisson)

# performance::check_model(ramets_e_ranova2_pb)

pb_ranova_transects(ramets_e_ranova2_pb,
          "Ramets before flowering: 2020",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2020_transects.docx")


# 2021-----
ramets_e_ranova3_pb <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                              control = glmerControl(optimizer = "Nelder_Mead"),
                            family = poisson)

# performance::check_model(ramets_e_ranova3_pb)

pb_ranova_transects(ramets_e_ranova3_pb,
          "Ramets before flowering: 2021",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2021_transects.docx")


# Ramets (after flowering)-------
# 2019-----
ramets_l_ranova1_pb <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2019),
                            na.action = na.exclude,
                     
                             family = poisson)

# performance::check_model(ramets_l_ranova1_pb)

pb_ranova_transects(ramets_l_ranova1_pb,
          "Ramets after flowering: 2019",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2019_transects.docx")



# 2020-----
ramets_l_ranova2_pb <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
                     
                             family = poisson)

# performance::check_model(ramets_l_ranova2_pb)

pb_ranova_transects(ramets_l_ranova2_pb,
          "Ramets after flowering: 2020",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2020_transects.docx")


# 2021-----
ramets_l_ranova3_pb <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                     
                             family = poisson)

# performance::check_model(ramets_l_ranova3_pb)

pb_ranova_transects(ramets_l_ranova3_pb,
          "Ramets after flowering: 2021",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2021_transects.docx")



# Mortality-------
# 2019-----
surv_ranova1_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2019),
                            na.action = na.exclude,
                     
                             family = binomial)

# performance::check_model(surv_ranova1_pb)

pb_ranova_transects(surv_ranova1_pb,
          "Mortality: 2019",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2019_transects.docx")


# 2020-----
surv_ranova2_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
                     
                             family = binomial)

# performance::check_model(surv_ranova2_pb)

pb_ranova_transects(surv_ranova2_pb,
          "Mortality: 2020",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2020_transects.docx")


# 2021-----
surv_ranova3_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                
                             family = binomial)

# performance::check_model(surv_ranova3_pb)

pb_ranova_transects(surv_ranova3_pb,
          "Mortality: 2021",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2021_transects.docx")


# 2022-----
surv_ranova4_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2022),
                            na.action = na.exclude,
                     
                             family = binomial)

# performance::check_model(surv_ranova4_pb)

pb_ranova_transects(surv_ranova4_pb,
          "Mortality: 2022",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2022_transects.docx")


```

## Recalculate PVE for non-Gaussian models
As far as we know, there isn't a solid way to calculate percent variance explained for variables with a non-Gaussian distribution.
The way that we handled this was to refit our non-Gaussian models (generalized linear mixed models) to general linear mixed models, then extract PVE for the last year of data collection.
These new PVEs will be estimates. This is *not* a perfect solution but it will help us approximate PVE for these variables.
### Q1
```{r}
# main models
ramets_e_lmer <- lmer(Ramets_early ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

ramets_l_lmer <- lmer(Ramets_late ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude)

survival_lmer <- lmer(as.numeric(Dead) ~
                               (1|Block) +
                               (1|Population) +
                               (1|Population:Fam_uniq),
                             data = survival %>%
                               dplyr::filter(Year == 2022),
                          na.action = na.exclude)

# get PVE from models
pve_rbf <- PVE_lm(ramets_e_lmer) 
pve_raf <- PVE_lm(ramets_l_lmer)
pve_surv <- PVE_lm(survival_lmer)

pve_rbf_city <- PVE_lm(update(ramets_e_lmer, .~. + City_dist))
pve_raf_city <- PVE_lm(update(ramets_l_lmer, .~. + City_dist))
pve_surv_city <- PVE_lm(update(survival_lmer, .~. + City_dist))

pve_rbf_urbsc <- PVE_lm(update(ramets_e_lmer, .~. + Urb_score))
pve_raf_urbsc <- PVE_lm(update(ramets_l_lmer, .~. + Urb_score))
pve_surv_urbsc <- PVE_lm(update(survival_lmer, .~. + Urb_score))


# make tables
recalc_tab1 <- pve_table_recalc(pve_rbf, pve_raf, pve_surv,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

recalc_tab2 <- pve_table_recalc(pve_rbf_city, pve_raf_city, pve_surv_city,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

recalc_tab3 <- pve_table_recalc(pve_rbf_urbsc, pve_raf_urbsc, pve_surv_urbsc,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

# Export to word
export_recalc(recalc_tab1,
              recalc_tab2,
              recalc_tab3,
              "./Growth_trait_analyses/Tables/Ranova/PVE_nonGaussmods/PVE_nonGaussmods_growth_Q1.docx")

```

### Q2
```{r}
# main models
ramets_e_lmer2 <- update(ramets_e_lmer,
                             data = heights %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"))

ramets_l_lmer2 <- update(ramets_l_lmer,
                             data = heights %>%
                               dplyr::filter(Year == 2021 &
                                            Transect_ID != "Rural"))

survival_lmer2 <- update(survival_lmer,
                             data = survival %>%
                               dplyr::filter(Year == 2022 &
                                            Transect_ID != "Rural"))
# get PVE from models
pve_rbf2 <- PVE_lm(ramets_e_lmer2) 
pve_raf2 <- PVE_lm(ramets_l_lmer2)
pve_surv2 <- PVE_lm(survival_lmer2)

pve_rbf_city2 <- PVE_lm(update(ramets_e_lmer2, .~. + City_dist*Transect_ID))
pve_raf_city2 <- PVE_lm(update(ramets_l_lmer2, .~. + City_dist*Transect_ID))
pve_surv_city2 <- PVE_lm(update(survival_lmer2, .~. + City_dist*Transect_ID))

pve_rbf_urbsc2 <- PVE_lm(update(ramets_e_lmer2, .~. + Urb_score*Transect_ID))
pve_raf_urbsc2 <- PVE_lm(update(ramets_l_lmer2, .~. + Urb_score*Transect_ID))
pve_surv_urbsc2 <- PVE_lm(update(survival_lmer2, .~. + Urb_score*Transect_ID))


# make tables
recalc_tab1_Q2 <- pve_table_recalc(pve_rbf2, pve_raf2, pve_surv2,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

recalc_tab2_Q2 <- pve_table_recalc(pve_rbf_city2, pve_raf_city2, pve_surv_city2,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

recalc_tab3_Q2 <- pve_table_recalc(pve_rbf_urbsc2, pve_raf_urbsc2, pve_surv_urbsc2,
                 "Ramets before flowering",
                              "Ramets after flowering",
                              "Mortality")

# Export to word
export_recalc(recalc_tab1_Q2,
              recalc_tab2_Q2,
              recalc_tab3_Q2,
              "./Growth_trait_analyses/Tables/Ranova/PVE_nonGaussmods/PVE_nonGaussmods_growth_Q2.docx")
```



## Create figure showing % variance explained per component
Note: Can only do this for gaussian models for Q1. For models with transect as an effect, I can calculate PVE for models testing effect of distance only- not transect. But since I'm not as interested in that, I won't generate those plots now.
```{r}

# can't figure out how to convert these ranova html tables with PVE into df or tibble or anything else with code.
# So I'll just create an excel file combining the data from traits for which I could calculate PVE ("PVE_growth_Q1.xlsx"), including these traits:
# -relative growth rate ("rgr.html")
# -LDMC ("ldmc.html")
# -SLA ("sla.html")
# -Height (before flowering) ("heights_early.html")
# -Height (after flowering) ("heights_late.html")



pve <- read.csv(here::here("./Growth_trait_analyses/Tables/Ranova/pve_growth_Q1.csv")) %>%
  dplyr::rename(Variable = 1) %>%
  # make alphabetical order for plot
   mutate(Variable = fct_reorder(Variable,
                                 desc(Variable)))

library("ggsci")

pve_growth <- ggplot(pve,
       aes(
         fill=Group,
         y=PVE,
         x=Variable)
       ) + 
  geom_bar(position="stack",
           stat="identity") +
  scale_fill_discrete(labels = c("Family",
                                 "Population",
                                 "Residual")) +
  scale_fill_tron(alpha = 0.7) +
  theme_pubr() +
  xlab("") +
  ylab("% Variance Explained") +
  coord_flip()
pve_growth

ggsave(filename = "pve_growth_Q1.png",
         plot = pve_growth,
         path = here::here("./Growth_trait_analyses/Figures/PVE/"),
         width = 20,
         height = 8,
         units = "cm")
```

# Anova
## Export all best / alt multi-year models in separate word docs
### Distance / best
```{r}
all_models_best_c <- list(
ldmc_mods_best_c,
sla_mods_best_c,
heights_early_mods_best_c,
heights_late_mods_best_c,
rgr_mods_best_c,
ramets_early_mods_best_c,
ramets_late_mods_best_c,
mortality_mods_best_c    )


anovas_best_c <- lapply(all_models_best_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_c, "./Growth_trait_analyses/Figures/ANOVA/Best_models/all_anova_growth_best_distance.docx")
```

### Distance / alt
```{r}
all_models_alt_c <- list(
ldmc_mods_alt_c,
sla_mods_alt_c,
heights_early_mods_alt_c,
heights_late_mods_alt_c,
rgr_mods_alt_c,
ramets_early_mods_alt_c,
ramets_late_mods_alt_c,
mortality_mods_alt_c    )

anovas_alt_c <- lapply(all_models_alt_c, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_c, "./Growth_trait_analyses/Figures/ANOVA/Alt_models/all_anova_growth_alt_distance.docx")
```

### UrbScore / best
```{r}
all_models_best_u <- list(
ldmc_mods_best_u,
sla_mods_best_u,
heights_early_mods_best_u,
heights_late_mods_best_u,
rgr_mods_best_u,
ramets_early_mods_best_u,
ramets_late_mods_best_u,
mortality_mods_best_u    )

anovas_best_u <- lapply(all_models_best_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_best_u, "./Growth_trait_analyses/Figures/ANOVA/Best_models/all_anova_growth_best_urbscore.docx")
```

### UrbScore / alt
```{r}
all_models_alt_u <- list(
ldmc_mods_alt_u,
sla_mods_alt_u,
heights_early_mods_alt_u,
heights_late_mods_alt_u,
rgr_mods_alt_u,
ramets_early_mods_alt_u,
ramets_late_mods_alt_u,
mortality_mods_alt_u    )

anovas_alt_u <- lapply(all_models_alt_u, make_all_anovas_tidy_altmods)

export_anovas(anovas_alt_u, "./Growth_trait_analyses/Figures/ANOVA/Alt_models/all_anova_growth_alt_urbscore.docx")

```

## Export comparisons of anovas w/1 vs. all years
### Q1
```{r}
# LDMC & SLA-----
# only one year of data for this. Compared anovas in "./Growth_trait_analyses/Tables/Ranova/nsim_10/LDMC.docx" and "./Growth_trait_analyses/Tables/Ranova/nsim_10/SLA.docx" and "./Growth_trait_analyses/Figures/ANOVA/Best_models/all_anova_Growth_best_distance.docx" and "...urbscore.docx" and they're qualitatively identical (very similar too)

# height before flowering-----
compare_anovas(
  update(heights_early_mods_best_c[[1]], .~. - City_dist),
  heights,
  "2021",
  "Height before flowering",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/heights_early.docx")

# height after flowering-----
compare_anovas(
  update(heights_late_mods_best_c[[1]], .~. - City_dist),
  heights,
  "2021",
  "Height after flowering",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/heights_late.docx")

# relative growth rate-----
compare_anovas(
  update(rgr_mods_best_c[[1]], .~. - City_dist),
  heights,
  "2021",
  "Relative growth rate",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/rgr.docx")

# ramets before flowering-----
compare_anovas(
  update(ramets_early_mods_best_c[[1]], .~. - City_dist),
  heights,
  "2021",
  "Ramets before flowering",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/ramets_early.docx")

# ramets after flowering-----
compare_anovas(
  update(ramets_late_mods_best_c[[1]], .~. - City_dist),
  heights,
  "2021",
  "Ramets after flowering",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/ramets_late.docx")

# mortality-----
compare_anovas(
  update(mortality_mods_best_c[[1]], .~. - City_dist),
  survival,
  "2022",
  "Mortality",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/mortality.docx")

```

### Q2
```{r}
# LDMC & SLA-----
# only one year of data for this. Compared anovas in "./Growth_trait_analyses/Tables/Ranova/nsim_10/LDMC_transects.docx" and "./Growth_trait_analyses/Tables/Ranova/nsim_10/SLA_transects.docx" and "./Growth_trait_analyses/Figures/ANOVA/Best_models/all_anova_Growth_best_distance.docx" and "...urbscore.docx" and they're qualitatively identical (very similar too)

# height before flowering-----
compare_anovas_transects(
  update(heights_early_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  heights,
  "2021",
  "Height before flowering",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/heights_early_transects.docx")

# height after flowering-----
compare_anovas_transects(
  update(heights_late_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  heights,
  "2021",
  "Height after flowering",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/heights_late_transects.docx")

# relative growth rate-----
compare_anovas_transects(
  update(rgr_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  heights,
  "2021",
  "Relative growth rate",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/rgr_transects.docx")

# ramets before flowering-----
compare_anovas_transects(
  update(ramets_early_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  heights,
  "2021",
  "Ramets before flowering",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/ramets_early_transects.docx")

# ramets after flowering-----
compare_anovas_transects(
  update(ramets_late_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  heights,
  "2021",
  "Ramets after flowering",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/ramets_late_transects.docx")

# mortality-----
compare_anovas_transects(
  update(mortality_mods_best_c[[2]], .~. - City_dist*Transect_ID),
  survival,
  "2022",
  "Mortality",
  "./Growth_trait_analyses/Tables/Comparing_ANOVA/mortality_transects.docx")

```

# R-squared values
```{r}
# change REML to T
ldmc_mods_reml_T      <- reml_to_true(ldmc_mods)
sla_mods_reml_T       <- reml_to_true(sla_mods)
heights_e_mods_reml_T <- reml_to_true(heights_early_mods)
heights_l_mods_reml_T <- reml_to_true(heights_late_mods)
rgr_mods_reml_T       <- reml_to_true(rgr_mods)
ramets_e_mods_reml_T  <- reml_to_true(ramets_early_mods)
ramets_l_mods_reml_T  <- reml_to_true(ramets_late_mods)
mortality_mods_reml_T <- reml_to_true(mortality_mods)

all_models_reml_T <- list(
ldmc_mods_reml_T      ,
sla_mods_reml_T       ,
heights_e_mods_reml_T ,
heights_l_mods_reml_T ,
rgr_mods_reml_T       ,
ramets_e_mods_reml_T  ,
ramets_l_mods_reml_T  ,
mortality_mods_reml_T )

names(all_models_reml_T) <- c(
"ldmc_mods"      ,
"sla_mods"       ,
"heights_e_mods" ,
"heights_l_mods" ,
"rgr_mods"       ,
"ramets_e_mods"  ,
"ramets_l_mods"  ,
"mortality_mods" )

# export to csv
all_rsq <- lapply(all_models_reml_T, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Growth_trait_analyses/Tables/Rsquare.csv"))



# export as nice tables in word doc
ldmc_r2      <- make_r2_table( ldmc_mods_reml_T    ) 
sla_r2       <- make_r2_table(sla_mods_reml_T      ) 
heights_e_r2 <- make_r2_table(heights_e_mods_reml_T) 
heights_l_r2 <- make_r2_table( heights_l_mods_reml_T) 
rgr_r2       <- make_r2_table(rgr_mods_reml_T      ) 
ramets_e_r2  <- make_r2_table(ramets_e_mods_reml_T) 
ramets_l_r2  <- make_r2_table( ramets_l_mods_reml_T ) 
morality_r2  <- make_r2_table( mortality_mods_reml_T) 

# will do this in 3 docs b/c function accepts 3 tables at a time (something to try tweaking in the future)
# table 1
export_r2(ldmc_r2    , 
sla_r2      ,
heights_e_r2,
          "LDMC",
          "SLA", 
          "Height before flowering",
          "./Growth_trait_analyses/Tables/R2_growth1.docx")
# table 2
export_r2(
heights_l_r2,
rgr_r2      ,
ramets_e_r2 ,
          "Height after flowering",
          "Relative growth rate", 
          "Ramets before flowering",
          "./Growth_trait_analyses/Tables/R2_growth2.docx")

# table 3: will just use code from function
  word_export <- read_docx()
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Ramets, after flowering", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, ramets_l_r2)
  
  body_add_break(word_export)
  
  body_add_par(word_export, value = paste("R-squared estimates for",  "Mortality", "Models"), style = "heading 1")
  body_add_par(word_export, value = "")
  body_add_flextable(word_export, morality_r2)
  
  word_export <- body_end_section_landscape(word_export)
  print(word_export, here::here("./Growth_trait_analyses/Tables/R2_growth3.docx"))
```

# Calculate heritability, Qst, and CVA
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"
```{r}
# LDMC-----
update(
    ldmc_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ldmc_mean <- sla_ldmc %>%
  dplyr::filter(LDMC < 1) %>% # as done in model
  dplyr::summarize(Mean = mean(LDMC,
                               na.rm = T)) %>%
  as.numeric()

qg_ldmc <- calc_quantgenvars( 9.4956e-06,
                   2.2071e-05,
                   0.387388,
                   5.8581e-02,
                   "LDMC")


# SLA-----
update(
    sla_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

sla_mean <- sla_ldmc %>%
  dplyr::summarize(Mean = mean(SLA,
                               na.rm = T)) %>%
  as.numeric()

qg_sla <- calc_quantgenvars(4.5386e-06,
                   9.5195e-06,
                    4.0241e-01,
                   sla_mean,
                   "SLA")


# heights, early-----

update(
    heights_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_early,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_e <- calc_quantgenvars(0.36591,
                                  0.15034 ,
                                  1.12547 ,
                   heights_e_mean,
                   "Height (before flowering)")


# heights, late-----

update(
    heights_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_late,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_l <- calc_quantgenvars(0.49420 ,
                                  0.22338  ,
                                  1.56537  ,
                   heights_l_mean,
                   "Height (after flowering)")

# RGR-----
update(
    rgr_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

rgr_mean <- heights %>%
  dplyr::summarize(Mean = mean(rel_growth_rate,
                               na.rm = T)) %>%
  as.numeric()
 
qg_rgr <- calc_quantgenvars( 3.8967e-06 ,
                             2.6174e-03 ,
                            5.5405e-02,
                   rgr_mean,
                   "Relative growth rate")

# Ramets, early-----
update(
    ramets_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_early,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_early_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_e <- calc_quantgenvars( 0.247111,
                             0.080902,
                            resid_var,
                   ramets_e_mean,
                   "Ramets (before flowering)")

# Ramets, late-----
update(
    ramets_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_late,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_late_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_l <- calc_quantgenvars( 0.187996,
                             0.052465,
                            resid_var,
                   ramets_l_mean,
                   "Ramets (after flowering)")


# Survival-----
update(
    mortality_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

surv_mean <- survival %>%
  as.data.frame %>%
  dplyr::summarize(Mean = mean(Dead ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     mortality_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_survival <- calc_quantgenvars(6.6969e-08,
                   1.3094e-05,
                   resid_var ,
                   NA, # can't calculate this because it involves dividing by zero
                   "Mortality")
```

## Combine values into one table and export
```{r}
qg_joined <- list(qg_ldmc,
                  qg_sla,
                  qg_heights_e,
                  qg_heights_l,
                  qg_rgr,
                  qg_ramets_e,
                  qg_ramets_l,
                  qg_survival
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Growth_trait_analyses/Tables/quant_gen_growth.csv",
          row.names=FALSE)

```