---
title: "Growth/Morphological Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -make a ReadMe file for each level
# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+---------------------------------+-----------+-----------+-----------+
| Trait                           | 2019 Data | 2020 Data | 2021 Data |
+=================================+:=========:+:=========:+:=========:+
| LDMC & SLA                      |           | X         |           |
+---------------------------------+-----------+-----------+-----------+
| All other growth-related traits | X         | X         | X         |
+---------------------------------+-----------+-----------+-----------+

# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import final models
### Create full list
```{r}
source(knitr::purl("Growth_trait_analyses/Model_diagnostics_Growth.Rmd", quiet=TRUE))
```

# Ranova
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## gaussian distribution models
### Gradient
```{r}
# LDMC-------
ldmc_ranova_mod1 <- lmer(sqrt(LDMC) ~
                           (1|Population/Family) +
                           Block,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 1),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(ldmc_ranova_mod1)

# export
ranova_2step(ldmc_ranova_mod1,
             "LDMC",
             "./Growth_trait_analyses/Tables/Ranova/ldmc.docx")


# SLA-----
sla_ranova_mod1 <- lmer(SLA^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = sla_ldmc,
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(sla_ranova_mod1)

# export
ranova_2step(sla_ranova_mod1,
             "SLA",
             "./Growth_trait_analyses/Tables/Ranova/sla.docx")


# Rel growth rate-----
# 2019--------
rgr_ranova_mod1 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2019),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod1)

# export
ranova_2step(rgr_ranova_mod1,
             "Relative growth rate: 2019",
             "./Growth_trait_analyses/Tables/Ranova/rgr_2019.docx")


# 2020--------
rgr_ranova_mod2 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2020),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod2)

# export
ranova_2step(rgr_ranova_mod2,
             "Relative growth rate: 2020",
             "./Growth_trait_analyses/Tables/Ranova/rgr_2020.docx")


# 2021--------
rgr_ranova_mod3 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2021),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod3)

# export
ranova_2step(rgr_ranova_mod3,
             "Relative growth rate: 2021",
             "./Growth_trait_analyses/Tables/Ranova/rgr_2021.docx")



# Total_Height_early-----
# 2019-----
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2019),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod1)

# export
ranova_2step(heights_e_ranova_mod1,
             "Height, before flowering: 2019",
             "./Growth_trait_analyses/Tables/Ranova/heights_early_2019.docx")


# 2020-----
heights_e_ranova_mod2 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2020),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod2)

# export
ranova_2step(heights_e_ranova_mod2,
             "Height, before flowering: 2020",
             "./Growth_trait_analyses/Tables/Ranova/heights_early_2020.docx")


# 2021-----
heights_e_ranova_mod3 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2021),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod3)

# export
ranova_2step(heights_e_ranova_mod3,
             "Height, before flowering: 2021",
             "./Growth_trait_analyses/Tables/Ranova/heights_early_2021.docx")



# Total_Height_late-----
# 2019-----
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2019),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod1)

# export
ranova_2step(heights_l_ranova_mod1,
             "Height, after flowering: 2019",
             "./Growth_trait_analyses/Tables/Ranova/heights_late_2019.docx")


# 2020-----
heights_l_ranova_mod2 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2020),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod2)

# export
ranova_2step(heights_l_ranova_mod2,
             "Height, after flowering: 2020",
             "./Growth_trait_analyses/Tables/Ranova/heights_late_2020.docx")


# 2021-----
heights_l_ranova_mod3 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                        data = heights %>%
                          dplyr::filter(Year == 2021),
                        REML = T)


# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod3)

# export
ranova_2step(heights_l_ranova_mod3,
             "Height, after flowering: 2021",
             "./Growth_trait_analyses/Tables/Ranova/heights_late_2021.docx")


```

### Urban subtransects
```{r}
# LDMC-------
ldmc_ranova_mod1 <- lmer(LDMC ~
                           (1|Population/Family) +
                           Block,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)


# check diagnostics and transform if necessary
performance::check_model(ldmc_ranova_mod1)

ranova_transect(ldmc_ranova_mod1,
                "LDMC",
                "./Growth_trait_analyses/Tables/Ranova/ldmc_transects.docx")


# SLA-----
sla_ranova_mod1 <- lmer(sqrt(SLA) ~
                          (1|Population/Family) +
                          Block,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(sla_ranova_mod1)

ranova_transect(sla_ranova_mod1,
                "SLA",
                "./Growth_trait_analyses/Tables/Ranova/sla_transects.docx")


# Rel growth rate-----
# 2019-----
rgr_ranova_mod1 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block ,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2019),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod1)

ranova_transect(rgr_ranova_mod1,
                "Relative growth rate: 2019",
                "./Growth_trait_analyses/Tables/Ranova/rgr_transects_2019.docx")


# 2020-----
rgr_ranova_mod2 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block ,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod2)

ranova_transect(rgr_ranova_mod2,
                "Relative growth rate: 2020",
                "./Growth_trait_analyses/Tables/Ranova/rgr_transects_2020.docx")


# 2021-----
rgr_ranova_mod3 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block ,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(rgr_ranova_mod3)

ranova_transect(rgr_ranova_mod3,
                "Relative growth rate: 2021",
                "./Growth_trait_analyses/Tables/Ranova/rgr_transects_2021.docx")


# Total_Height_early-----
# 2019-----
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2019),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod1)

ranova_transect(heights_e_ranova_mod1,
                "Height before flowering: 2019",
                "./Growth_trait_analyses/Tables/Ranova/heights_e_transects_2019.docx")


# 2020-----
heights_e_ranova_mod2 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod2)

ranova_transect(heights_e_ranova_mod2,
                "Height before flowering: 2020",
                "./Growth_trait_analyses/Tables/Ranova/heights_e_transects_2020.docx")


# 2021-----
heights_e_ranova_mod3 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_e_ranova_mod3)

ranova_transect(heights_e_ranova_mod3,
                "Height before flowering: 2021",
                "./Growth_trait_analyses/Tables/Ranova/heights_e_transects_2021.docx")

# Total_Height_late-----
# 2019-----
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2019),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod1)

ranova_transect(heights_l_ranova_mod1,
                "Height after flowering: 2019",
                "./Growth_trait_analyses/Tables/Ranova/heights_l_transects_2019.docx")


# 2020-----
heights_l_ranova_mod2 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2020),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod2)

ranova_transect(heights_l_ranova_mod2,
                "Height after flowering: 2020",
                "./Growth_trait_analyses/Tables/Ranova/heights_l_transects_2020.docx")


# 2021-----
heights_l_ranova_mod3 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural" &
                                          Year == 2021),
                           REML = T)

# check diagnostics and transform if necessary
performance::check_model(heights_l_ranova_mod3)

ranova_transect(heights_l_ranova_mod3,
                "Height after flowering: 2021",
                "./Growth_trait_analyses/Tables/Ranova/heights_l_transects_2021.docx")

```

## non-gaussian models
### Gradient
```{r}
# Number of ramets (early)-------
# 2019-----
ramets_e_ranova1 <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Year == 2019),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(ramets_e_ranova1)

pb_ranova_2step(ramets_e_ranova1,
          "Ramets before flowering: 2019",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2019.docx")


# 2020-----
ramets_e_ranova2 <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(ramets_e_ranova2)

pb_ranova_2step(ramets_e_ranova2,
          "Ramets before flowering: 2020",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2020.docx")


# 2021-----
ramets_e_ranova3 <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(ramets_e_ranova3)

pb_ranova_2step(ramets_e_ranova3,
          "Ramets before flowering: 2021",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2021.docx")


# Number of ramets (LATE)-------
# 2019-----
ramets_l_ranova1 <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Year == 2019),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(ramets_l_ranova1)

pb_ranova_2step(ramets_l_ranova1,
          "Ramets after flowering: 2019",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2019.docx")


# 2020-----
ramets_l_ranova2 <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(ramets_l_ranova2)

pb_ranova_2step(ramets_l_ranova2,
          "Ramets after flowering: 2020",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2020.docx")


# 2021-----
ramets_l_ranova3 <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Year == 2021),
                            na.action = na.exclude,
                             family = poisson)

# performance::check_model(ramets_l_ranova3)

pb_ranova_2step(ramets_l_ranova3,
          "Ramets after flowering: 2021",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2021.docx")



# Mortality-------
# 2019-----
mortality_ranova1 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = survival %>%
                               dplyr::filter(Year == 2019),
                            na.action = na.exclude,
                             # ,control=glmerControl(optimizer="bobyqa",
  #                           optCtrl=list(maxfun=2e5)),
                           nAGQ = 0, # doesn't converge w/o this
                             family = binomial)

# performance::check_model(mortality_ranova1)

pb_ranova_2step(mortality_ranova1,
          "Mortality: 2019",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2019.docx")

# 2020-----
mortality_ranova2 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = survival %>%
                               dplyr::filter(Year == 2020),
                            na.action = na.exclude,
  control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)),                             family = binomial)

# performance::check_model(mortality_ranova2)

pb_ranova_2step(mortality_ranova2,
          "Mortality: 2020",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2020test.docx")


# 2021-----
mortality_ranova3 <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = survival %>%
                               dplyr::filter(Year == 2021),
                           nAGQ = 0, # doesn't converge w/o this
                            na.action = na.exclude,
                             family = binomial)

# performance::check_model(mortality_ranova3)

pb_ranova_2step(mortality_ranova3,
          "Mortality: 2021",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2021.docx")

```

### Urb subs
```{r}
# Ramets (before flowering)-------
# 2019-----
ramets_e_ranova1_pb <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2019),
                            na.action = na.exclude,
  control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)),                              family = poisson)

# performance::check_model(ramets_e_ranova1_pb)

pb_ranova_transects(ramets_e_ranova1_pb,
          "Ramets before flowering: 2019",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2019_transects.docx")



# 2020-----
ramets_e_ranova2_pb <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
  control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)),                              family = poisson)

# performance::check_model(ramets_e_ranova2_pb)

pb_ranova_transects(ramets_e_ranova2_pb,
          "Ramets before flowering: 2020",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2020_transects.docx")


# 2021-----
ramets_e_ranova3_pb <- glmer(Ramets_early ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                            nAGQ = 0,
                             family = poisson)

# performance::check_model(ramets_e_ranova3_pb)

pb_ranova_transects(ramets_e_ranova3_pb,
          "Ramets before flowering: 2021",
          "./Growth_trait_analyses/Tables/Ranova/ramets_early_2021_transects.docx")


# Ramets (after flowering)-------
# 2019-----
ramets_l_ranova1_pb <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2019),
                            na.action = na.exclude,
                            nAGQ = 0,
                             family = poisson)

# performance::check_model(ramets_l_ranova1_pb)

pb_ranova_transects(ramets_l_ranova1_pb,
          "Ramets after flowering: 2019",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2019_transects.docx")



# 2020-----
ramets_l_ranova2_pb <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
                            nAGQ = 0,
                             family = poisson)

# performance::check_model(ramets_l_ranova2_pb)

pb_ranova_transects(ramets_l_ranova2_pb,
          "Ramets after flowering: 2020",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2020_transects.docx")


# 2021-----
ramets_l_ranova3_pb <- glmer(Ramets_late ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = heights %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                            nAGQ = 0,
                             family = poisson)

# performance::check_model(ramets_l_ranova3_pb)

pb_ranova_transects(ramets_l_ranova3_pb,
          "Ramets after flowering: 2021",
          "./Growth_trait_analyses/Tables/Ranova/ramets_late_2021_transects.docx")



# Mortality-------
# 2019-----
surv_ranova1_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2019),
                            na.action = na.exclude,
                            nAGQ = 0,
                             family = binomial)

# performance::check_model(surv_ranova1_pb)

pb_ranova_transects(surv_ranova1_pb,
          "Mortality: 2019",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2019_transects.docx")


# 2020-----
surv_ranova2_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2020),
                            na.action = na.exclude,
                            nAGQ = 0,
                             family = binomial)

# performance::check_model(surv_ranova2_pb)

pb_ranova_transects(surv_ranova2_pb,
          "Mortality: 2020",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2020_transects.docx")


# 2021-----
surv_ranova3_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2021),
                            na.action = na.exclude,
                            nAGQ = 0,
                             family = binomial)

# performance::check_model(surv_ranova3_pb)

pb_ranova_transects(surv_ranova3_pb,
          "Mortality: 2021",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2021_transects.docx")


# 2022-----
surv_ranova4_pb <- glmer(Dead ~
                               Block +
                               (1|Population) +
                               (1|Population:Family),
                             data = survival %>%
                               dplyr::filter(Transect_ID != "Rural" & 
                                                Year == 2022),
                            na.action = na.exclude,
                            nAGQ = 0,
                             family = binomial)

# performance::check_model(surv_ranova4_pb)

pb_ranova_transects(surv_ranova4_pb,
          "Mortality: 2022",
          "./Growth_trait_analyses/Tables/Ranova/mortality_2022_transects.docx")


```

## Create figure showing % variance explained per component
Note: Can only do this for gaussian models for Q1. For models with transect as an effect, I can calculate PVE for models testing effect of distance only- not transect. But since I'm not as interested in that, I won't generate those plots now.
```{r}

# can't figure out how to convert these ranova html tables with PVE into df or tibble or anything else with code.
# So I'll just create an excel file combining the data from traits for which I could calculate PVE ("PVE_growth_Q1.xlsx"), including these traits:
# -relative growth rate ("rgr.html")
# -LDMC ("ldmc.html")
# -SLA ("sla.html")
# -Height (before flowering) ("heights_early.html")
# -Height (after flowering) ("heights_late.html")



pve <- read.csv(here::here("./Growth_trait_analyses/Tables/Ranova/pve_growth_Q1.csv")) %>%
  dplyr::rename(Variable = 1) %>%
  # make alphabetical order for plot
   mutate(Variable = fct_reorder(Variable,
                                 desc(Variable)))

library("ggsci")

pve_growth <- ggplot(pve,
       aes(
         fill=Group,
         y=PVE,
         x=Variable)
       ) + 
  geom_bar(position="stack",
           stat="identity") +
  scale_fill_discrete(labels = c("Family",
                                 "Population",
                                 "Residual")) +
  scale_fill_tron(alpha = 0.7) +
  theme_pubr() +
  xlab("") +
  ylab("% Variance Explained") +
  coord_flip()
pve_growth

ggsave(filename = "pve_growth_Q1.png",
         plot = pve_growth,
         path = here::here("./Growth_trait_analyses/Figures/PVE/"),
         width = 20,
         height = 8,
         units = "cm")
```

# Anova
## LDMC

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/LDMC_citydist.png"))

```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/LDMC_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/LDMC_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/LDMC_urbscore_alt.png"))
```

## SLA

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(sla_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/sla_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(sla_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/sla_urbscore.png"))
```

### Alt Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/sla_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/sla_urbscore_alt.png"))
```

## Heights- Early

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_urbscore_alt.png"))
```

## Heights- Late

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods_altmods(heights_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods_altmods(heights_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_urbscore_alt.png"))
```

## Relative growth rate

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(rgr_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(rgr_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods_altmods(rgr_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods_altmods(rgr_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_urbscore_alt.png"))
```

## Ramets- Early

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods_altmods(ramets_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods_altmods(ramets_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_urbscore_alt.png"))
```

## Ramets- Late

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_urbscore_alt.png"))
```

## Mortality
#### City_dist

```{r}
make_all_anovas_tidy_altmods(mortality_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/mortality_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(mortality_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/mortality_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(mortality_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/mortality_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(mortality_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/mortality_urbscore_alt.png"))
```

# R-squared values

```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE) %T>%
  write.csv(here::here("./Growth_trait_analyses/Tables/Rsquare.csv"))
```

# Calculate heritability, Qst, and CVA
Just looking at gradient models- all pops included. 

h2 represents the average heritability across populations after removing the genetic effects due to population differences.

"[CVA, or additive genetic coefficient of variation] provides a measure of genetic variation standardized by the mean, allowing to qualitatively comparing genetic variation among different traits"
```{r}
# LDMC-----
update(
    ldmc_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ldmc_mean <- sla_ldmc %>%
  dplyr::filter(LDMC < 1) %>% # as done in model
  dplyr::summarize(Mean = mean(LDMC,
                               na.rm = T)) %>%
  as.numeric()

qg_ldmc <- calc_quantgenvars( 9.4956e-06,
                   2.2071e-05,
                   0.387388,
                   5.8581e-02,
                   "LDMC")


# SLA-----
update(
    sla_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

sla_mean <- sla_ldmc %>%
  dplyr::summarize(Mean = mean(SLA,
                               na.rm = T)) %>%
  as.numeric()

qg_sla <- calc_quantgenvars(4.5386e-06,
                   9.5195e-06,
                    4.0241e-01,
                   sla_mean,
                   "SLA")


# heights, early-----

update(
    heights_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_early,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_e <- calc_quantgenvars(0.36591,
                                  0.15034 ,
                                  1.12547 ,
                   heights_e_mean,
                   "Height (before flowering)")


# heights, late-----

update(
    heights_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

heights_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Total_Height_late,
                               na.rm = T)) %>%
  as.numeric()

qg_heights_l <- calc_quantgenvars(0.49420 ,
                                  0.22338  ,
                                  1.56537  ,
                   heights_l_mean,
                   "Height (after flowering)")

# RGR-----
update(
    rgr_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

rgr_mean <- heights %>%
  dplyr::summarize(Mean = mean(rel_growth_rate,
                               na.rm = T)) %>%
  as.numeric()
 
qg_rgr <- calc_quantgenvars( 3.8967e-06 ,
                             2.6174e-03 ,
                            5.5405e-02,
                   rgr_mean,
                   "Relative growth rate")

# Ramets, early-----
update(
    ramets_early_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_e_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_early,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_early_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_e <- calc_quantgenvars( 0.247111,
                             0.080902,
                            resid_var,
                   ramets_e_mean,
                   "Ramets (before flowering)")

# Ramets, late-----
update(
    ramets_late_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

ramets_l_mean <- heights %>%
  dplyr::summarize(Mean = mean(Ramets_late,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
    ramets_late_mods_best_c[[1]], REML = T) %>%
    sigma()
 
qg_ramets_l <- calc_quantgenvars( 0.187996,
                             0.052465,
                            resid_var,
                   ramets_l_mean,
                   "Ramets (after flowering)")


# Survival-----
update(
    mortality_mods_best_c[[1]], 
    .~. -City_dist, # omitting city_dist
    REML = T) %>% VarCorr()

surv_mean <- survival %>%
  as.data.frame %>%
  dplyr::summarize(Mean = mean(Dead ,
                               na.rm = T)) %>%
  as.numeric()

# residual variance:
resid_var <- update(
     mortality_mods_best_c[[1]], REML = T) %>%
    sigma()

qg_survival <- calc_quantgenvars(6.6969e-08,
                   1.3094e-05,
                   resid_var ,
                   NA, # can't calculate this because it involves dividing by zero
                   "Mortality")
```

## Combine values into one table and export
```{r}
qg_joined <- list(qg_ldmc,
                  qg_sla,
                  qg_heights_e,
                  qg_heights_l,
                  qg_rgr,
                  qg_ramets_e,
                  qg_ramets_l,
                  qg_survival
                  ) %>% 
  bind_rows() %>%
  dplyr::mutate_at(2:4, round, 3) %>%
  write.csv(file = "./Growth_trait_analyses/Tables/quant_gen_growth.csv",
          row.names=FALSE)

```