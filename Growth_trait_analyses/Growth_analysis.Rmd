---
title: "Growth/Morphological Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients
# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+---------------------------------+-----------+-----------+-----------+
| Trait                           | 2019 Data | 2020 Data | 2021 Data |
+=================================+:=========:+:=========:+:=========:+
| LDMC & SLA                      |           | X         |           |
+---------------------------------+-----------+-----------+-----------+
| All other growth-related traits | X         | X         | X         |
+---------------------------------+-----------+-----------+-----------+

# Set up notebook

## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import data

```{r}
# SLA & LDMC-----
sla_ldmc <- read.csv(here::here("./CommonGardenExperiment_2020Data/clean_data/2020_sla_ldmc_clean.csv")) %>%
  dplyr::select(., -c(1:2)) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block")), as.factor)

str(sla_ldmc)
sla_ldmc %<>%
  dplyr::mutate(Fam_uniq = paste0(Population, "_", Family))

heights <- read.csv(here::here("./Joined_annual_data/heights.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %>%
  dplyr::mutate_at(vars(c("rel_growth_rate")), as.numeric)

str(heights)



survival <- read.csv(here::here("./Joined_annual_data/survival.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor)

str(survival)
```

## Import final models

### Create full list

```{r}
source(knitr::purl("Growth_trait_analyses/Model_diagnostics_Growth.Rmd", quiet=TRUE))

all_models <- list(
ldmc_mods,
sla_mods,
heights_early_mods,
heights_late_mods,
rgr_mods,
ramets_early_mods,
ramets_late_mods #,
# mortality_mods -- add when ready
)

names(all_models) <- c(
"ldmc_mods",
"sla_mods",
"heights_early_mods",
"heights_late_mods",
"rgr_mods",
"ramets_early_mods",
"ramets_late_mods" #,
# "mortality_mods" -- add when ready
  )
```

### Create separate lists of best vs. alt models for city_dist vs urb_score

#### LDMC

```{r}
## Best
### City_dist
ldmc_mods_best_c <- ldmc_mods[c(1,4)]

### Urb_score
ldmc_mods_best_u <- ldmc_mods[c(2,6)]

## Alt
### City_dist
ldmc_mods_alt_c <- ldmc_mods[3]

### Urb_score
ldmc_mods_alt_u <- ldmc_mods[5]
```

#### SLA

```{r}
## Best
### City_dist
sla_mods_best_c <- sla_mods[c(1,4)]

### Urb_score
sla_mods_best_u <- sla_mods[c(2,6)]

## Alt
### City_dist
sla_mods_alt_c <- sla_mods[3]

### Urb_score
sla_mods_alt_u <- sla_mods[5]
```

#### Heights- Early

```{r}
## Best
### City_dist
heights_early_mods_best_c <- heights_early_mods[c(1,4)]

### Urb_score
heights_early_mods_best_u <- heights_early_mods[c(2,6)]

## Alt
### City_dist
heights_early_mods_alt_c <- heights_early_mods[3]

### Urb_score
heights_early_mods_alt_u <- heights_early_mods[5]
```

#### Heights- Late

```{r}
## Best
### City_dist
heights_late_mods_best_c <- heights_late_mods[c(1,4)]

### Urb_score
heights_late_mods_best_u <- heights_late_mods[c(2,6)]

## Alt
### City_dist
heights_late_mods_alt_c <- heights_late_mods[3]

### Urb_score
heights_late_mods_alt_u <- heights_late_mods[5]
```

#### Relative growth rate

```{r}
## Best
### City_dist
rgr_mods_best_c <- rgr_mods[c(1,4)]

### Urb_score
rgr_mods_best_u <- rgr_mods[c(2,5)]

## Alt
### City_dist
rgr_mods_alt_c <- rgr_mods[3]

### Urb_score
rgr_mods_alt_u <- rgr_mods[6]
```

#### Ramets- Early

```{r}
## Best
### City_dist
ramets_early_mods_best_c <- ramets_early_mods[c(1,4)]

### Urb_score
ramets_early_mods_best_u <- ramets_early_mods[c(2,6)]

## Alt
### City_dist
ramets_early_mods_alt_c <- ramets_early_mods[3]

### Urb_score
ramets_early_mods_alt_u <- ramets_early_mods[5]
```

#### Ramets- Late

```{r}
## Best
### City_dist
ramets_late_mods_best_c <- ramets_late_mods[c(1,4)]

### Urb_score
ramets_late_mods_best_u <- ramets_late_mods[c(2,6)]

## Alt
### City_dist
ramets_late_mods_alt_c <- ramets_late_mods[3]

### Urb_score
ramets_late_mods_alt_u <- ramets_late_mods[5]
```

#### Mortality

```{r}
# ## Best
# ### City_dist
# ldmc_mods_best_c <- ldmc_mods[c(1,4)]
# 
# ### Urb_score
# ldmc_mods_best_u <- ldmc_mods[c(2,6)]
# 
# ## Alt
# ### City_dist
# ldmc_mods_alt_c <- ldmc_mods[3]
# 
# ### Urb_score
# ldmc_mods_alt_u <- ldmc_mods[5]
```

# Ranova (RETURN)
## Gradient
### City_dist
```{r}
# LDMC-------
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + City_dist,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 1),
                           REML = T)

ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ldmc.html"))


# SLA-----
sla_ranova_mod1 <- lmer(SLA ~ (1|Population/Family) + (1|Block) + City_dist,
                        data = sla_ldmc,
                        REML = T)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/sla.html"))


```

### Urb_score
```{r}
# LDMC-------
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 1),
                           REML = T)

ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod2, "LDMC") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/ldmc.html"))


# SLA-----
# same output as Pop:Fam_uniq
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Urb_score,
                        data = sla_ldmc,
                        REML = T)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod2, "SLA") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/sla.html"))
```

## Urban subtransects
### City_dist
```{r}
# LDMC-------
## test City_dist
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + City_dist,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test Transect
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC (Distance)")
ldmc_ranova2 <- CreateRanovaOutput_Q2(ldmc_ranova_mod2, "LDMC (Transect)")

flextable::save_as_html(ldmc_ranova1,
                        ldmc_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ldmc_transects.html"))


# SLA-----
## test City_dist
sla_ranova_mod1 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + City_dist,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA (Distance)")
sla_ranova2 <- CreateRanovaOutput_Q2(sla_ranova_mod2, "SLA (Transect)")

flextable::save_as_html(sla_ranova1,
                        sla_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/sla_transects.html"))

```

### Urb_score
```{r}
# LDMC-------
## test Urb_score
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC (Urbanization Score)")
ldmc_ranova2 <- CreateRanovaOutput_Q2(ldmc_ranova_mod2, "LDMC (Transect)")

flextable::save_as_html(ldmc_ranova1,
                        ldmc_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/ldmc_transects.html"))


# SLA-----
## test Urb_score
sla_ranova_mod1 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA (Urbanization Score)")
sla_ranova2 <- CreateRanovaOutput_Q2(sla_ranova_mod2, "SLA (Transect)")

flextable::save_as_html(sla_ranova1,
                        sla_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/sla_transects.html"))

```


# Anova

## LDMC

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/LDMC_citydist.png"))

lapply(ldmc_mods_best_c, MuMIn::r.squaredGLMM)

```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/LDMC_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/LDMC_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/LDMC_urbscore_alt.png"))
```

## SLA

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(sla_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/sla_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(sla_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/sla_urbscore.png"))
```

### Alt Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/sla_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/sla_urbscore_alt.png"))
```

## Heights- Early

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(heights_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(heights_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_urbscore_alt.png"))
```

## Heights- Late

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(heights_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(heights_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_urbscore_alt.png"))
```

## Relative growth rate

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(rgr_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(rgr_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(rgr_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(rgr_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_urbscore_alt.png"))
```

## Ramets- Early

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(ramets_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(ramets_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_urbscore_alt.png"))
```

## Ramets- Late

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(ramets_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(ramets_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_urbscore_alt.png"))
```

## Mortality (RETURN)

# R-squared values

```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

# super low marginal R2 values
```

# Calculate heritability & Qst (RETURN)

# Calculate additive genetic coefficient of variation (RETURN)

```{r}


```

# Find estimated marginal means at terminii- put this in figs script eventually- ADD SLA/LDMC MODS

## Urban Subtransects

### City_dist

#### Ramets, after flowering

```{r}
# create ggpredict object
ramets_late_mods_best_c[2]
ramets_late_urbsubs_01_pred <- ggeffects::ggpredict(heights_late_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# find EMM
# PERCENT CHANGE, suburban to urban terminus:
Calc_percent_change_urbsubs(ramets_late_urbsubs_01_pred) # 6.2%
```

#### Height, after flowering

```{r}
# create ggpredict object
heights_late_mods_best_c[2]
heights_late_urbsubs_01_pred <- ggeffects::ggpredict(heights_late_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# find EMM
Calc_percent_change_transects(heights_late_urbsubs_01_pred) # 6.2%
```
