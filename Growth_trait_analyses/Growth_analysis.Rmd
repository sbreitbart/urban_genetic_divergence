---
title: "Growth/Morphological Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients
# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+-----------------------------+-----------+-----------+-----------+
| Trait                       | 2019 Data | 2020 Data | 2021 Data |
+=============================+:=========:+:=========:+:=========:+
| All growth-related traits   | X         | X         | X         |
+-----------------------------+-----------+-----------+-----------+


# Set up notebook
## Load libraries and add functions
```{r}
source("libraries.R")
source("functions.R")
```

## Import data
```{r}
heights <- read.csv(here::here("./Joined_annual_data/heights.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor) %>%
  dplyr::mutate_at(vars(c("rel_growth_rate")), as.numeric)

str(heights)



survival <- read.csv(here::here("./Joined_annual_data/survival.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -1) %>%
  dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.character) %>%
    dplyr::mutate_at(vars(c("Population", "Family", "Replicate", "Block", "Year", "Transect_ID", "Urb_Rur")), as.factor)

str(survival)
```

## Import final models
### Create full list
```{r}
source(knitr::purl("Growth_trait_analyses/Model_diagnostics_Growth.Rmd", quiet=TRUE))

all_models <- list(
heights_early_mods,
heights_late_mods,
rgr_mods,
ramets_early_mods,
ramets_late_mods #,
# mortality_mods -- add when ready
)

names(all_models) <- c(
"heights_early_mods",
"heights_late_mods",
"rgr_mods",
"ramets_early_mods",
"ramets_late_mods" #,
# "mortality_mods" -- add when ready
  )
```

### Create separate lists of best vs. alt models for city_dist vs urb_score
#### Heights- Early
```{r}
## Best
### City_dist
heights_early_mods_best_c <- heights_early_mods[c(1,4)]

### Urb_score
heights_early_mods_best_u <- heights_early_mods[c(2,6)]

## Alt
### City_dist
heights_early_mods_alt_c <- heights_early_mods[3]

### Urb_score
heights_early_mods_alt_u <- heights_early_mods[5]
```

#### Heights- Late
```{r}
## Best
### City_dist
heights_late_mods_best_c <- heights_late_mods[c(1,4)]

### Urb_score
heights_late_mods_best_u <- heights_late_mods[c(2,6)]

## Alt
### City_dist
heights_late_mods_alt_c <- heights_late_mods[3]

### Urb_score
heights_late_mods_alt_u <- heights_late_mods[5]
```

#### Relative growth rate
```{r}
## Best
### City_dist
rgr_mods_best_c <- rgr_mods[c(1,4)]

### Urb_score
rgr_mods_best_u <- rgr_mods[c(2,5)]

## Alt
### City_dist
rgr_mods_alt_c <- rgr_mods[3]

### Urb_score
rgr_mods_alt_u <- rgr_mods[6]
```

#### Ramets- Early
```{r}
## Best
### City_dist
ramets_early_mods_best_c <- ramets_early_mods[c(1,4)]

### Urb_score
ramets_early_mods_best_u <- ramets_early_mods[c(2,6)]

## Alt
### City_dist
ramets_early_mods_alt_c <- ramets_early_mods[3]

### Urb_score
ramets_early_mods_alt_u <- ramets_early_mods[5]
```

#### Ramets- Late
```{r}
## Best
### City_dist
ramets_late_mods_best_c <- ramets_late_mods[c(1,4)]

### Urb_score
ramets_late_mods_best_u <- ramets_late_mods[c(2,6)]

## Alt
### City_dist
ramets_late_mods_alt_c <- ramets_late_mods[3]

### Urb_score
ramets_late_mods_alt_u <- ramets_late_mods[5]
```

#### Mortality
```{r}
# ## Best
# ### City_dist
# ldmc_mods_best_c <- ldmc_mods[c(1,4)]
# 
# ### Urb_score
# ldmc_mods_best_u <- ldmc_mods[c(2,6)]
# 
# ## Alt
# ### City_dist
# ldmc_mods_alt_c <- ldmc_mods[3]
# 
# ### Urb_score
# ldmc_mods_alt_u <- ldmc_mods[5]
```

# Ranova (RETURN)
# Anova
## Heights- Early
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(heights_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(heights_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_urbscore_alt.png"))
```

## Heights- Late
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(heights_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(heights_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(heights_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(heights_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_urbscore_alt.png"))
```


## Relative growth rate
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(rgr_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(rgr_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(rgr_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(rgr_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_urbscore_alt.png"))
```


## Ramets- Early
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(ramets_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(ramets_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_urbscore_alt.png"))
```


## Ramets- Late
### Best Models
#### City_dist
```{r}
make_all_anovas_tidy(ramets_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_citydist.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy(ramets_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_urbscore.png"))
```

### Alternative Models
#### City_dist
```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_citydist_alt.png"))
```

#### Urb_score
```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_urbscore_alt.png"))
```


## Mortality (RETURN)
# R-squared values
```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)

# super low marginal R2 values
```


# Calculate heritability & Qst (RETURN)
# Calculate additive genetic coefficient of variation (RETURN)
```{r}


```
# Find estimated marginal means at terminii- put this in figs script eventually
## Urban Subtransects
### City_dist
#### Ramets, after flowering
```{r}
# create ggpredict object
ramets_late_mods_best_c[2]
ramets_late_urbsubs_01_pred <- ggeffects::ggpredict(heights_late_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# find EMM
# PERCENT CHANGE, suburban to urban terminus:
Calc_percent_change_urbsubs(ramets_late_urbsubs_01_pred) # 6.2%
```


#### Height, after flowering
```{r}
# create ggpredict object
heights_late_mods_best_c[2]
heights_late_urbsubs_01_pred <- ggeffects::ggpredict(heights_late_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# find EMM
Calc_percent_change_transects(heights_late_urbsubs_01_pred) # 6.2%
```

