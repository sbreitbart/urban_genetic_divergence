---
title: "Growth/Morphological Trait Analysis"
author: "Sophie Breitbart"
output:
  html_document:
    number_sections: true
    df_print: paged
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '2'
editor_options: 
  chunk_output_type: console
NOTES:
  -Still to do--
    -try to do an RDA (or PCA?) with all the traits
    -make a ReadMe file for each level
    -calculate heritability coefficients
# WHEN TOTALLY DONE, type this:
# renv::activate()
# renv::snapshot()
---

+---------------------------------+-----------+-----------+-----------+
| Trait                           | 2019 Data | 2020 Data | 2021 Data |
+=================================+:=========:+:=========:+:=========:+
| LDMC & SLA                      |           | X         |           |
+---------------------------------+-----------+-----------+-----------+
| All other growth-related traits | X         | X         | X         |
+---------------------------------+-----------+-----------+-----------+

# Set up notebook

## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import final models

### Create full list

```{r}
source(knitr::purl("Growth_trait_analyses/Model_diagnostics_Growth.Rmd", quiet=TRUE))
```

# Ranova
## Set seed for random processes (bootstrapping)
```{r}
set.seed(45)
```

## gaussian distribution models
### Gradient
#### City_dist
```{r}
# LDMC-------
ldmc_ranova_mod1 <- lmer(LDMC ~
                           (1|Population/Family) +
                           Block +
                           City_dist,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 1),
                           REML = T)

ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ldmc.html"))


# SLA-----
sla_ranova_mod1 <- lmer(SLA ~
                          (1|Population/Family) +
                          Block +
                          City_dist,
                        data = sla_ldmc,
                        REML = T)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/sla.html"))


# Rel growth rate-----
rgr_ranova_mod1 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                        data = heights,
                        REML = T)


rgr_ranova1 <- CreateRanovaOutput(rgr_ranova_mod1, "Relative growth rate") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/rgr.html"))

# Total_Height_early-----
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                        data = heights,
                        REML = T)


heights_e_ranova1 <- CreateRanovaOutput(heights_e_ranova_mod1, "Height (before flowering)") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/heights_early.html"))


# Total_Height_late-----
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                        data = heights,
                        REML = T)


heights_l_ranova1 <- CreateRanovaOutput(heights_l_ranova_mod1, "Height (after flowering)") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/heights_late.html"))
```

#### Urb_score- NOT UPDATED SINCE MAY 2022
```{r}
# LDMC-------
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                               dplyr::filter(LDMC < 1),
                           REML = T)

ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod2, "LDMC") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/ldmc.html"))


# SLA-----
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Urb_score,
                        data = sla_ldmc,
                        REML = T)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod2, "SLA") %T>%
  flextable::save_as_html(.,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/sla.html"))
```

### Urban subtransects- add heights
#### City_dist
```{r}
# LDMC-------
## test City_dist
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + Block + City_dist,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test Transect
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + Block + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC (Distance)")
ldmc_ranova2 <- CreateRanovaOutput_Q2(ldmc_ranova_mod2, "LDMC (Transect)")

flextable::save_as_html(ldmc_ranova1,
                        ldmc_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ldmc_transects.html"))


# SLA-----
## test City_dist
sla_ranova_mod1 <- lmer(sqrt(SLA) ~ (1|Population/Family) + Block + City_dist,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + Block + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA (Distance)")
sla_ranova2 <- CreateRanovaOutput_Q2(sla_ranova_mod2, "SLA (Transect)")

flextable::save_as_html(sla_ranova1,
                        sla_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/sla_transects.html"))

# Rel growth rate-----
## test City_dist
rgr_ranova_mod1 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
rgr_ranova_mod2 <- lmer(rel_growth_rate^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          Transect_ID,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


rgr_ranova1 <- CreateRanovaOutput(rgr_ranova_mod1, "Relative growth rate (Distance)")
rgr_ranova2 <- CreateRanovaOutput_Q2(rgr_ranova_mod2, "Relative growth rate (Transect)")

flextable::save_as_html(rgr_ranova1,
                        rgr_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/rgr_transects.html"))


# Total_Height_early-----
## test City_dist
heights_e_ranova_mod1 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
heights_e_ranova_mod2 <- lmer(Total_Height_early^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          Transect_ID,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


heights_e_ranova1 <- CreateRanovaOutput(heights_e_ranova_mod1, "Heights (before flowering) (Distance)")
heights_e_ranova2 <- CreateRanovaOutput_Q2(heights_e_ranova_mod2, "Heights (before flowering) (Transect)")

flextable::save_as_html(heights_e_ranova1,
                        heights_e_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/heights_e_transects.html"))

# Total_Height_late-----
## test City_dist
heights_l_ranova_mod1 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          City_dist,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
heights_l_ranova_mod2 <- lmer(Total_Height_late^(1/3) ~
                          (1|Population/Family) +
                          Block +
                          Year +
                          Transect_ID,
                             data = heights %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


heights_l_ranova1 <- CreateRanovaOutput(heights_l_ranova_mod1, "Heights (after flowering) (Distance)")
heights_l_ranova2 <- CreateRanovaOutput_Q2(heights_l_ranova_mod2, "Heights (after flowering) (Transect)")

flextable::save_as_html(heights_l_ranova1,
                        heights_l_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/heights_l_transects.html"))
```

#### Urb_score- NOT UPDATED SINCE MAY 2022
```{r}
# LDMC-------
## test Urb_score
ldmc_ranova_mod1 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
ldmc_ranova_mod2 <- lmer(LDMC ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


ldmc_ranova1 <- CreateRanovaOutput(ldmc_ranova_mod1, "LDMC (Urbanization Score)")
ldmc_ranova2 <- CreateRanovaOutput_Q2(ldmc_ranova_mod2, "LDMC (Transect)")

flextable::save_as_html(ldmc_ranova1,
                        ldmc_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/ldmc_transects.html"))


# SLA-----
## test Urb_score
sla_ranova_mod1 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Urb_score,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = T)

## test transect
sla_ranova_mod2 <- lmer(sqrt(SLA) ~ (1|Population/Family) + (1|Block) + Transect_ID,
                             data = sla_ldmc %>%
                          dplyr::filter(Transect_ID != "Rural"),
                           REML = F)


sla_ranova1 <- CreateRanovaOutput(sla_ranova_mod1, "SLA (Urbanization Score)")
sla_ranova2 <- CreateRanovaOutput_Q2(sla_ranova_mod2, "SLA (Transect)")

flextable::save_as_html(sla_ranova1,
                        sla_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/Urb_score/sla_transects.html"))

```


## poisson models- use pbmodcomp()
### Gradient
```{r}
# Number of ramets (early)-------

# take out fam- NOT CONVERGING with poisson and can't use nbinom2...
# full <- glmer(Ramets_early ~
#                 Block +
#                  Year + 
#                  (1|Population) +
#                   City_dist,
#                 data = heights,
#               family = poisson,
#             na.action = na.exclude # THIS LINE IS IMPORTANT
#     # ,control=glmerControl(optimizer="bobyqa",
#     #                         optCtrl=list(maxfun=2e5))
# )
# 
# reduced <- update(full, .~. - City_dist)
# 
# ramets_e_ranova.pop <- PBmodcomp(full, reduced,
#           nsim = 1000,          
#           cl = makeCluster(7))
# 
# tidy(ramets_e_ranova.pop) # p = 0.
# 
# 
# 
# take out pop
full <- glmer(Ramets_early ~
                Block + Year +
                (1|Fam_uniq) + City_dist,
                              data = heights,
                              family = nbinom2,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)

ramets_e_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
                    cl = makeCluster(7))

tidy(ramets_e_ranova.fam) # Family: p ~ 0.




# merge Pop and Fam ranovas
herbiv_e_bin_ranova1 <- CreateRanovaOutput_bootstrap(ramets_e_ranova.fam, ramets_e_ranova.pop, "Ramets, before flowering") %T>%
  flextable::save_as_html(path = here::here("./Growth_trait_analyses/Tables/Ranova/ramets_early.html"))


# Number of ramets (LATE)-------

# # take out fam- NOT CONVERGING with poisson and can't use nbinom2...
# full <- glmer(Ramets_late ~
#             #    Block +
#               #   Year +
#                  (1|Population) +
#                   City_dist,
#                 data = heights,
#               family = poisson,
#             na.action = na.exclude # THIS LINE IS IMPORTANT
#     # ,control=glmerControl(optimizer="bobyqa",
#     #                         optCtrl=list(maxfun=2e5))
# )
# 
# reduced <- update(full, .~. - City_dist)
# 
# ramets_l_ranova.pop <- PBmodcomp(full, reduced,
#           nsim = 1000,
#           cl = makeCluster(7))
# 
# tidy(ramets_l_ranova.pop) # p = 0.



# take out pop
full <- glmer(Ramets_late ~
                Block + Year +
                (1|Fam_uniq) + City_dist,
                              data = heights,
                              family = nbinom2,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- update(full, .~. - City_dist)

ramets_l_ranova.fam <- PBmodcomp(full, reduced,
          nsim = 1000,
                    cl = makeCluster(7))

tidy(ramets_l_ranova.fam) # Family: p ~ 0.




# merge Pop and Fam ranovas
herbiv_l_bin_ranova1 <- CreateRanovaOutput_bootstrap(ramets_l_ranova.fam, ramets_l_ranova.pop, "Ramets, after flowering") %T>%
  flextable::save_as_html(path = here::here("./Growth_trait_analyses/Tables/Ranova/ramets_late.html"))
```

### Urb subs
```{r}
# Ramets (before flowering)-------
## test city_dist
### take out fam
full <- glmer(Ramets_early ~
            #    Block +
            #    Year + 
                (1|Population) + City_dist,
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = poisson,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

reduced <- glmer(Ramets_early ~
              #  Block + Year + 
                (1|Population),
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = poisson,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  )

ramets_e_ranova.pop <- PBmodcomp(full, reduced,
          nsim = 1000,
          cl = makeCluster(7))

tidy(ramets_e_ranova.pop) # Pop: p ~ 0.


# ### take out pop- WON'T CONVERGE
# full <- glmer(Ramets_early ~
#           #      Block + Year + 
#                 (1|Fam_uniq) + City_dist + Transect_ID,
#                               data = heights %>%
#                 dplyr::filter(Transect_ID != "Rural"),                              family = poisson,
#              na.action = na.exclude # THIS LINE IS IMPORTANT
#   )
# 
# reduced <- glmer(Ramets_early ~
#                 Block + Year + 
#                 (1|Fam_uniq),
#                               data = heights %>%
#                 dplyr::filter(Transect_ID != "Rural"),                              family = poisson,
#              na.action = na.exclude # THIS LINE IS IMPORTANT
#   )
# 
# ramets_e_ranova.fam <- PBmodcomp(full, reduced,
#           nsim = 1000,
#           cl = makeCluster(7))
# 
# tidy(ramets_e_ranova.fam) # Family: p ~ 0.



## test transect
test_tr <- glmer(Ramets_early ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = poisson,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist
ramets_e_ranova1 <- CreateRanovaOutput_bootstrap(ramets_e_ranova.fam, ramets_e_ranova.pop, "Ramets, before flowering: (Distance)")

## test transect
ramets_e_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Ramets, before flowering: (Transect)")

flextable::save_as_html(ramets_e_ranova1,
                        ramets_e_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ramets_e_transects.html"))



# Ramets (after flowering)-------
## test city_dist
# ### take out fam- WON'T CONVERGE
# full <- glmer(Ramets_late ~
#             #    Block +
#             #    Year + 
#                 (1|Population) + City_dist,
#                               data = heights %>%
#                 dplyr::filter(Transect_ID != "Rural"),
#                               family = poisson,
#              na.action = na.exclude # THIS LINE IS IMPORTANT
#   )
# 
# reduced <- glmer(Ramets_late ~
#               #  Block + Year + 
#                 (1|Population),
#                               data = heights %>%
#                 dplyr::filter(Transect_ID != "Rural"),
#                               family = poisson,
#              na.action = na.exclude # THIS LINE IS IMPORTANT
#   )
# 
# ramets_l_ranova.pop <- PBmodcomp(full, reduced,
#           nsim = 1000,
#           cl = makeCluster(7))
# 
# tidy(ramets_l_ranova.pop) # Pop: p ~ 0.


# ### take out pop- WON'T CONVERGE
# full <- glmer(Ramets_late ~
#           #      Block + Year + 
#                 (1|Fam_uniq) + City_dist + Transect_ID,
#                               data = heights %>%
#                 dplyr::filter(Transect_ID != "Rural"),                              family = poisson,
#              na.action = na.exclude # THIS LINE IS IMPORTANT
#   )
# 
# reduced <- glmer(Ramets_late ~
#                 Block + Year + 
#                 (1|Fam_uniq),
#                               data = heights %>%
#                 dplyr::filter(Transect_ID != "Rural"),                              family = poisson,
#              na.action = na.exclude # THIS LINE IS IMPORTANT
#   )
# 
# ramets_l_ranova.fam <- PBmodcomp(full, reduced,
#           nsim = 1000,
#           cl = makeCluster(7))
# 
# tidy(ramets_l_ranova.fam) # Family: p ~ 0.



## test transect
test_tr <- glmer(Ramets_late ~
                Block + Year + 
                (1|Population/Family) + Transect_ID,
                              data = heights %>%
                dplyr::filter(Transect_ID != "Rural"),
                              family = poisson,
             na.action = na.exclude # THIS LINE IS IMPORTANT
  ,control=glmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5))
  )


# merge Pop and Fam ranovas
## test city_dist- WON'T CONVERGE so not exporting
# ramets_l_ranova1 <- CreateRanovaOutput_bootstrap(ramets_l_ranova.fam, ramets_l_ranova.pop, "Ramets, before flowering: (Distance)")

## test transect
ramets_l_ranova2 <- CreateRanovaOutput_Q2(test_tr, "Ramets, before flowering: (Transect)")

flextable::save_as_html(# ramets_l_ranova1,
                        ramets_l_ranova2,
                        path = here::here("./Growth_trait_analyses/Tables/Ranova/ramets_l_transects.html"))

```

# Anova
## LDMC

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/LDMC_citydist.png"))

lapply(ldmc_mods_best_c, MuMIn::r.squaredGLMM)

```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/LDMC_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/LDMC_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ldmc_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/LDMC_urbscore_alt.png"))
```

## SLA

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(sla_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/sla_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(sla_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/sla_urbscore.png"))
```

### Alt Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/sla_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(sla_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/sla_urbscore_alt.png"))
```

## Heights- Early

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(heights_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(heights_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_early_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_early_urbscore_alt.png"))
```

## Heights- Late

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(heights_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(heights_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/heights_late_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(heights_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(heights_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/heights_late_urbscore_alt.png"))
```

## Relative growth rate

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(rgr_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(rgr_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/rgr_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(rgr_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(rgr_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/rgr_urbscore_alt.png"))
```

## Ramets- Early

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(ramets_early_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(ramets_early_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_early_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_early_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_early_urbscore_alt.png"))
```

## Ramets- Late

### Best Models

#### City_dist

```{r}
make_all_anovas_tidy(ramets_late_mods_best_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_citydist.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy(ramets_late_mods_best_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Best_models/ramets_late_urbscore.png"))
```

### Alternative Models

#### City_dist

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_c) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_citydist_alt.png"))
```

#### Urb_score

```{r}
make_all_anovas_tidy_altmods(ramets_late_mods_alt_u) %>%
  save_as_image(., path = here::here("./Growth_trait_analyses/Figures/ANOVA/Alt_models/ramets_late_urbscore_alt.png"))
```

## Mortality (RETURN)

# R-squared values

```{r}
all_rsq <- lapply(all_models, lapply, r.squaredGLMM) %>%
  unlist(recursive = FALSE)
```

# Calculate heritability & Qst
```{r}
# LDMC-----
VarCorr(
  update(
    ldmc_mods_best_c[[1]],
    REML = T))

Calc_h2_qst(1.3396e-06,
            7.0523e-06 ,
            5.8534e-02 )

# SLA-----
VarCorr(
  update(
    sla_mods_best_c[[1]],
    REML = T))

Calc_h2_qst(2.9928e-06  ,
            8.0526e-06  ,
            4.0263e-01  )

# heights, early-----
VarCorr(
  update(
    heights_early_mods_best_c[[1]],
    REML = T))

Calc_h2_qst(0.36649 ,
 0.14126 ,
 1.12561  )

# heights, late-----
VarCorr(
  update(
    heights_late_mods_best_c[[1]],
    REML = T))

Calc_h2_qst( 0.49538 ,
0.21298 ,
1.56541)

# RGR-----
VarCorr(
  update(
    rgr_mods_best_c[[1]],
    REML = T))

Calc_h2_qst(  4.4689e-06,
2.8540e-03,
5.5411e-02)

# Ramets, early-----
VarCorr(
  update(
    ramets_early_mods_best_c[[1]],
    REML = T))

# residual variance:
resid_var <- update(
    ramets_early_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst( 0.247471,
 0.081492,
 resid_var)


# Ramets, late-----
VarCorr(
  update(
    ramets_late_mods_best_c[[1]],
    REML = T))

# residual variance:
resid_var <- update(
    ramets_late_mods_best_c[[1]], REML = T) %>%
    sigma()

Calc_h2_qst(0.188467,
 0.046818,
 resid_var)

```

# Calculate additive genetic coefficient of variation (RETURN)

```{r}


```
