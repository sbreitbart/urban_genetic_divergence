# Set up notebook
## Load libraries and add functions

```{r}
source("libraries.R")
source("functions.R")
```

## Import data

```{r}
source(knitr::purl("Growth_trait_analyses/Model_diagnostics_Growth.Rmd", quiet=TRUE))
```

# Create ggpredict objects
## LDMC
### Gradient
```{r}
# city_dist
ldmc_mods_best_c[1]
ldmc_gradient_01_pred <- ggeffects::ggpredict(ldmc_mods_best_c[[1]],
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
ldmc_mods_best_u[1]
ldmc_gradient_02_pred <- ggeffects::ggpredict(ldmc_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}
# city_dist
ldmc_mods_best_c[2]
ldmc_urbsubs_01_pred <- ggeffects::ggpredict(ldmc_mods_best_c[[2]],
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
ldmc_mods_best_u[2]
ldmc_urbsubs_02_pred <- ggeffects::ggpredict(ldmc_mods_best_u[[2]],
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## SLA
### Gradient
```{r}
sla_ldmc$sla_cuberoot <- (sla_ldmc$SLA)^(1/3)

sla_mod1 <- update(
  sla_mods_best_c[[1]],
  sla_cuberoot ~ .
)

sla_mod2 <- update(
  sla_mods_best_u[[1]],
  sla_cuberoot ~ .
)

# city_dist
sla_mods_best_c[1] # CUBE ROOT transformed
sla_gradient_01_pred <- ggeffects::ggpredict(sla_mod1,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
sla_mods_best_u[1] # CUBE ROOT transformed
sla_gradient_02_pred <- ggeffects::ggpredict(sla_mod2,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
sla_mod3 <- update(
  sla_mods_best_c[[2]],
  sla_cuberoot ~ .
)

sla_mod4 <- update(
  sla_mods_best_u[[2]],
  sla_cuberoot ~ .
)

# city_dist
sla_mods_best_c[2] # CUBE ROOT transformed
sla_urbsubs_01_pred <- ggeffects::ggpredict(sla_mod3,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
sla_mods_best_u[2] # CUBE ROOT transformed
sla_urbsubs_02_pred <- ggeffects::ggpredict(sla_mod4,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Height- before flowering
### Gradient
```{r}

heights$heights_e_cuberoot <- (heights$Total_Height_early)^(1/3)

heights_e_mod1 <- update(
  heights_early_mods_best_c[[1]],
  heights_e_cuberoot ~ .
)

heights_e_mod2 <- update(
  heights_early_mods_best_u[[1]],
  heights_e_cuberoot ~ .
)


# city_dist
heights_early_mods_best_c[1] # cube root transfomred
heights_early_gradient_01_pred <- ggeffects::ggpredict(heights_e_mod1,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
heights_early_mods_best_u[1] # cube root transfomred
heights_early_gradient_02_pred <- ggeffects::ggpredict(heights_e_mod2,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}

heights_e_mod3 <- update(
  heights_early_mods_best_c[[2]],
  heights_e_cuberoot ~ .
)

heights_e_mod4 <- update(
  heights_early_mods_best_u[[2]],
  heights_e_cuberoot ~ .
)

# city_dist
heights_early_mods_best_c[2] # cube root transfomred
heights_early_urbsubs_01_pred <- ggeffects::ggpredict(heights_e_mod3,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
heights_early_mods_best_u[2] # cube root transfomred
heights_early_urbsubs_02_pred <- ggeffects::ggpredict(heights_e_mod4,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```


## Height- after flowering
### Gradient
```{r}
heights$heights_l_cuberoot <- (heights$Total_Height_late)^(1/3)

heights_l_mod1 <- update(
  heights_late_mods_best_c[[1]],
  heights_l_cuberoot ~ .
)

heights_l_mod2 <- update(
  heights_late_mods_best_u[[1]],
  heights_l_cuberoot ~ .
)


# city_dist
heights_late_mods_best_c[1] # cube root transfomred
heights_late_gradient_01_pred <- ggeffects::ggpredict(heights_l_mod1,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
heights_late_mods_best_u[1] # cube root transfomred
heights_late_gradient_02_pred <- ggeffects::ggpredict(heights_l_mod2,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}

heights_l_mod3 <- update(
  heights_late_mods_best_c[[2]],
  heights_l_cuberoot ~ .
)

heights_l_mod4 <- update(
  heights_late_mods_best_u[[2]],
  heights_l_cuberoot ~ .
)
# city_dist
heights_late_mods_best_c[2] # cube root transfomred
heights_late_urbsubs_01_pred <- ggeffects::ggpredict(heights_l_mod3,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
heights_late_mods_best_u[2] # cube root transfomred
heights_late_urbsubs_02_pred <- ggeffects::ggpredict(heights_l_mod4,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```

## Relative growth rate
### Gradient
```{r}
heights$rgr_cuberoot <- (heights$rel_growth_rate)^(1/3)

rgr_mod1 <- update(
  rgr_mods_best_c[[1]],
  rgr_cuberoot ~ .
)

rgr_mod2 <- update(
  rgr_mods_best_u[[1]],
  rgr_cuberoot ~ .
)

# city_dist
rgr_mods_best_c[1] # CUBE ROOT transformed
rgr_gradient_01_pred <- ggeffects::ggpredict(rgr_mod1,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
rgr_mods_best_u[1] # CUBE ROOT transformed
rgr_gradient_02_pred <- ggeffects::ggpredict(rgr_mod2,
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()

```

### Urban Subtransects
```{r}
rgr_mod3 <- update(
  rgr_mods_best_c[[2]],
  rgr_cuberoot ~ .
)

rgr_mod4 <- update(
  rgr_mods_best_u[[2]],
  rgr_cuberoot ~ .
)

# city_dist
rgr_mods_best_c[2] # CUBE ROOT transformed
rgr_urbsubs_01_pred <- ggeffects::ggpredict(rgr_mod3,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
rgr_mods_best_u[2] # CUBE ROOT transformed
rgr_urbsubs_02_pred <- ggeffects::ggpredict(rgr_mod4,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```


## Ramets- before flowering
### Gradient
```{r}

# city_dist
ramets_early_mods_best_c[1] 
ramets_early_gradient_01_pred <- ggeffects::ggpredict(ramets_early_mods_best_c[[1]] ,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
ramets_early_mods_best_u[1] 
ramets_early_gradient_02_pred <- ggeffects::ggpredict(ramets_early_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}

# city_dist
ramets_early_mods_best_c[2] 
ramets_early_urbsubs_01_pred <- ggeffects::ggpredict(ramets_early_mods_best_c[[2]] ,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
ramets_early_mods_best_u[2] 
ramets_early_urbsubs_02_pred <- ggeffects::ggpredict(ramets_early_mods_best_u[[2]] ,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```


## Ramets- after flowering
### Gradient
```{r}

# city_dist
ramets_late_mods_best_c[1] 
ramets_late_gradient_01_pred <- ggeffects::ggpredict(ramets_late_mods_best_c[[1]] ,
                                   terms = c("City_dist"),
                                   type = "fe") %>%
  as.data.frame() 

# urb_score
ramets_late_mods_best_u[1] 
ramets_late_gradient_02_pred <- ggeffects::ggpredict(ramets_late_mods_best_u[[1]],
                                   terms = c("Urb_score"),
                                   type = "fe") %>%
  as.data.frame()
```

### Urban Subtransects
```{r}

# city_dist
ramets_late_mods_best_c[2] 
ramets_late_urbsubs_01_pred <- ggeffects::ggpredict(ramets_late_mods_best_c[[2]] ,
                                   terms = c("City_dist", "Transect_ID"),
                                   type = "fe") %>%
  as.data.frame()

# urb_score
ramets_late_mods_best_u[2] 
ramets_late_urbsubs_02_pred <- ggeffects::ggpredict(ramets_late_mods_best_u[[2]] ,
                                   terms = c("Urb_score", "Transect_ID"),
                                   type = "fe")
```


## Mortality ??
# Create regression plots
## Gradient
### City_dist
```{r}
# LDMC-----
ggpred_Q1.citydist_ldmc <- 
ggplot(ldmc_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = "Leaf Dry Matter Content") +
  ylim(0.15, 0.18) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(ldmc_mods_best_c[[1]])$p)),
                size = 4.5)

ggpred_Q1.citydist_ldmc



# SLA-----
ggpred_Q1.citydist_sla <- ggplot(sla_gradient_01_pred) +
  rep_geoms +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Specific Leaf Area "(cm^2/g))) +
  ylim(18, 26) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Distance: p = ", tidy_anova(sla_mods_best_c[[1]])$p)),
                size = 4.5)

ggpred_Q1.citydist_sla



```

### Urb_score
```{r}
# LDMC-----
ggpred_Q1.urbscore_ldmc <- 
ggplot(ldmc_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = "Leaf Dry Matter Content") +
  xlim(4, -4) +
  ylim(0.15, 0.18) +
  theme_1() +
  
# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(ldmc_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.urbscore_ldmc



# SLA-----
ggpred_Q1.urbscore_sla <- ggplot(sla_gradient_02_pred) +
  rep_geoms +
  labs(x = "Urbanization Score",
       y = expression("sqrt(Specific Leaf Area) "(cm^2/g))) +
  ylim(19.5, 21.5) +
    xlim(4, -4) +
  theme_1() +
#   # adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.08,
                    label = paste0(" Urb. Score: p = ", tidy_anova(sla_mods_best_u[[1]])$p)),
                size = 4.5)

ggpred_Q1.urbscore_sla



```

## Urban Subtransects
### City_dist
```{r}
# LDMC-----
ggpred_Q2.citydist_ldmc <-
ggplot(ldmc_urbsubs_01_pred) +
  labs(x = "Distance to Urban Center (km)",
       y = "Leaf Dry Matter Content",
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 0.19) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 1, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(ldmc_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 1, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(ldmc_mods_best_c[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.citydist_ldmc

# SLA-----
ggpred_Q2.citydist_sla <- 
ggplot(sla_urbsubs_01_pred) +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Specific Leaf Area "(cm^2/g)),
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 22) +
  xlim(0, NA) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 1, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(sla_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 1, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(sla_mods_best_c[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.citydist_sla


# herbivory: Before flowering-----
## factors (transects) for this object are North, then South. To keep legend consistent, reorder levels first
heights_late_urbsubs_01_pred$group <- factor(heights_late_urbsubs_01_pred$group,
                                   levels(heights_late_urbsubs_01_pred$group)[c(2,1)])
levels(heights_late_urbsubs_01_pred$group)

ggpred_Q2.citydist_height_late <- 
ggplot(heights_late_urbsubs_01_pred) +
  rep_geoms2 +
  labs(x = "Distance to Urban Center (km)",
       y = expression("Height (After Flowering) (cm)"^{1/2}),
       color = "Transect",
       fill = "Transect") +
  scale_y_continuous(limits = c(45, 65))+
  xlim(0, NA) +
  theme_1() +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Distance: p = ", tidy_anova(heights_late_mods_best_c[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(heights_late_mods_best_c[[2]])$p[2])),
                size = 4.5) 

ggpred_Q2.citydist_height_late


```

### Urb_score
```{r}
# LDMC-----
ggpred_Q2.urbsubs_ldmc <-
ggplot(ldmc_urbsubs_02_pred) +
  labs(x = "Urbanization Score",
       y = "Leaf Dry Matter Content",
       color = "Transect",
       fill = "Transect") +
  ylim(NA, 0.19) +
  xlim(4, -2) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(ldmc_mods_best_u[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(ldmc_mods_best_u[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.urbsubs_ldmc


# SLA-----
ggpred_Q2.urbsubs_sla <- 
ggplot(sla_urbsubs_02_pred) +
  labs(x = "Urbanization Score",
       y = expression("Specific Leaf Area "(cm^2/g)),
       color = "Transect",
       fill = "Transect") +
  ylim(18, 22.5) +
  xlim(4, -2) +
  theme_1() +
  rep_geoms2 +

# adding stats from ANOVA
           ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.97,
                    label = paste0(" Urb. Score: p = ", tidy_anova(sla_mods_best_u[[2]])$p[1])),
                size = 4.5) +
  ggpp::geom_text_npc(aes(npcx = 0.05, npcy = 0.88,
                    label = paste0(" Transect: p = ", tidy_anova(sla_mods_best_u[[2]])$p[2])),
                size = 4.5)

ggpred_Q2.urbsubs_sla


```

# Create boxplots
## Heights- Late
```{r}
ggplot(heights %>%
         dplyr::filter(Transect_ID != "Rural"),
       aes(x = Transect_ID,
           y = Total_Height_late)) + 
  geom_boxplot(
       size = 0.5) + 
  # geom_point(position = "jitter") + 
  theme_pubclean()
```

# Find estimated marginal means at terminii
## Gradient
### City_dist
### Urbanization Score
## Urban Subtransects
### City_dist
#### LDMC
```{r}
# PERCENT CHANGE, suburban to urban terminus:
Calc_percent_change_urbsubs(ldmc_urbsubs_01_pred) # 10.9%
```

#### Ramets, after flowering

```{r}
# PERCENT CHANGE, suburban to urban terminus:
Calc_percent_change_urbsubs(ramets_late_urbsubs_01_pred) # 6.2%
```

#### Height, after flowering

```{r}
Calc_percent_change_transects(heights_late_urbsubs_01_pred) # 6.2%
```

### Urbanization Score