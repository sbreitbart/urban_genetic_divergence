---
title: "KSR_2019"
output: html_document
---

1/2022: This rmd contains the data and analysis for only the 2019 growing season. This year was majorly different from 2020 (and likely 2021), so much that it made checking model assumptions very difficult. As of now, it seems smarter to analyze this year separately from the later years, when the milkweed were in later stages of development.

# Set up notebook
## Load packages
```{r}
library(dplyr) # A Grammar of Data Manipulation
# library(reshape)
# library(reshape2)
library(DHARMa) # Residual Diagnostics for Hierarchical (Multi-Level / Mixed) Regression Models
library(flextable) # Functions for Tabular Reporting
library(pbkrtest) # Parametric Bootstrap, Kenward-Roger and Satterthwaite Based Methods for Test in Mixed Models
# library(pbnm)
library(glmmTMB) # Generalized Linear Mixed Models using Template Model Builder
# library(redres)
library(tidyr) # Tidy Messy Data
library(broom.mixed) # Tidying Methods for Mixed Models
library(tidyverse) # Easily Install and Load the 'Tidyverse'
library(readxl) # Read Excel Files
library(broom) # Convert Statistical Objects into Tidy Tibbles
library(knitr) # A General-Purpose Package for Dynamic Report Generation in R
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics # Create Elegant Data Visualisations Using the Grammar of Graphics
# library(ggExtra)
# library("ggpubr")
library(devtools) # Tools to Make Developing R Packages Easier
# library(rpart)
library("tibble", lib.loc="~/R/win-library/3.5") # not installed on this machine
# library(ISLR)
library(MASS) # Support Functions and Datasets for Venables and Ripley's MASS
library(car) # Companion to Applied Regression
library(data.table) # Extension of `data.frame`
library(plyr) # Tools for Splitting, Applying and Combining Data
# library(MuMIn) # Multi-Model Inference # Multi-Model Inference # Multi-Model Inference
library(ggplot2) # Create Elegant Data Visualisations Using the Grammar of Graphics # Create Elegant Data Visualisations Using the Grammar of Graphics
library(gridExtra) # Miscellaneous Functions for "Grid" Graphics
library(Hmisc) # Harrell Miscellaneous
library(lme4) # Linear Mixed-Effects Models using 'Eigen' and S4
library(nlme) # Linear and Nonlinear Mixed Effects Models
library(lmerTest) # Tests in Linear Mixed Effects Models
library(vegan) # Community Ecology Package
# library(lindia)
# library(e1071)
library(ggpubr) # 'ggplot2' Based Publication Ready Plots
library(forcats) # Tools for Working with Categorical Variables (Factors)
library(multcomp) # Simultaneous Inference in General Parametric Models
library(lsmeans) # Least-Squares Means
# library(ggbiplot)
require(MASS) # Support Functions and Datasets for Venables and Ripley's MASS
require(scales) # Scale Functions for Visualization
# require(ggiraph)
# require(ggiraphExtra)
library(geosphere) # Spherical Trigonometry
library(vctrs) # Vector Helpers
library(here) # A Simpler Way to Find Your Files
library(stringi) # Character String Processing Facilities
```

## Add functions
```{r}
diagnostic<-function(x){
  plot(x)
  hist(x)
  qqnorm(x)
  qqline(x,lty=2, col="Red")

  skew<-function(x){
    m3<-sum((x-mean(x))^3)/length(x)
    s3<-sqrt(var(x))^3
    m3/s3}

  kurtosis<-function(x){
    m4<-sum((x-mean(x))^4)/length(x)
    s4<-var(x)^2
    m4/s4-3}

  print(paste("Kurtosis=", kurtosis(x), sep=""))
  print(paste("Skew=", skew(x), sep=""))
}


# GOOD CODE-----
anova_table_flx <- function(mod1) {

  flx_1 <-  car::Anova(mod1) %>% 
  tidy() %>%
  dplyr::mutate_if(.,
            is.character,
            str_replace_all,
            pattern = c("City_dist"),
            replacement = c("Distance to City Center")) %>%
    dplyr::mutate_if(.,
            is.character,
            str_replace_all,
            pattern = c("Urb_score"),
            replacement = c("Urbanization Score")) %>%
    dplyr::mutate_if(.,
            is.character,
            str_replace_all,
            pattern = c("Transect_ID"),
            replacement = c("Subtransect")) %>%
  rename_at(1, ~ "Effect") %>%
  rename_at(2, ~ "Chi Square" ) %>%
  rename_at(4, ~ "P" ) %>%
  # dplyr::select(-3) %>%
    flextable()  %>%
    colformat_num(j = c(2,4), digits = 3) %>%
    flextable::bold(., ~ P  == "< 0.001" | P <= 0.05, ~ P, bold = TRUE) %>%
    flextable::italic(., ~ P > 0.05 & P <= 0.1, ~ P, italic = TRUE) %>%
  # set_caption(., caption = "Does Urbanization Affect Year 2 Flowering?") %>%
  # align(., i = 1, part = "header", align = "center") %>%
  # add_footer_lines(., paste("Model formula: ", paste0(toString(formula(mod1)[3])))) %>%
  # italic(., italic = TRUE, part = "footer") %>%
  align_text_col(., align = "left") %>%
  align_nottext_col(., align = "center") %>%
  autofit(., add_w = 0.1, add_h = 0.1) 

  
      # make filename a string (from symbol)
  # filename1 <- toString(formula(mod1)[[2]])

  # can't figure out how to remove space from filename so it's staying for now...
  path_out = here::here("./Figures_Tables/ANOVA_tables_images/ ")
  
  save_as_image(flx_1,
                gsub(" ", "",
                     paste(path_out,
                      # filename1,
                      print(substitute(mod1)),
                      "_ANOVA.png")))

}

# use _transf function if response var has been transformed
# use _binomial or _quantitative when I had to fit 2 extra models per var: binomial and then, with positive values, quantitative
AIC_compare.city_dist <- function(full_model, ME_model) {
  
  data.frame(Model = c("Full model",
                       "Main effects only"),
                     AIC = c(AIC(full_model),
                             AIC(ME_model))) %>%
    write.csv(gsub(" ", "",
                   paste(here::here("./Figures_Tables/ANOVA_tables_images/ "),
                       "AIC_comparison_",
                       formula(full_model)[[2]],
                       "_city",
                       # deparse(substitute(full_model)),
                       ".csv")))
  
}
AIC_compare.city_dist_transf <- function(full_model, ME_model) {
  
  data.frame(Model = c("Full model",
                       "Main effects only"),
                     AIC = c(AIC(full_model),
                             AIC(ME_model))) %>%
    write.csv(gsub(" ", "",
                   paste(here::here("./Figures_Tables/ANOVA_tables_images/ "),
                       "AIC_comparison_",
                       toString(formula(full_model)[[2]][2]),
                       "_city",
                       # deparse(substitute(full_model)),
                       ".csv")))
  
}
AIC_compare.city_dist_transf_binomial <- function(full_model, ME_model) {
  
  data.frame(Model = c("Full model",
                       "Main effects only"),
                     AIC = c(AIC(full_model),
                             AIC(ME_model))) %>%
    write.csv(gsub(" ", "",
                   paste(here::here("./Figures_Tables/ANOVA_tables_images/ "),
                       "AIC_comparison_",
                       toString(formula(full_model)[[2]][2]),
                       "_city_binomial",
                       # deparse(substitute(full_model)),
                       ".csv")))
  
}
AIC_compare.city_dist_transf_quantitative <- function(full_model, ME_model) {
  
  data.frame(Model = c("Full model",
                       "Main effects only"),
                     AIC = c(AIC(full_model),
                             AIC(ME_model))) %>%
    write.csv(gsub(" ", "",
                   paste(here::here("./Figures_Tables/ANOVA_tables_images/ "),
                       "AIC_comparison_",
                       toString(formula(full_model)[[2]][2]),
                       "_city_quantitative",
                       # deparse(substitute(full_model)),
                       ".csv")))
  
}


AIC_compare.urb_score <- function(full_model, ME_model) {
  
  data.frame(Model = c("Full model",
                       "Main effects only"),
                     AIC = c(AIC(full_model),
                             AIC(ME_model))) %>%
    write.csv(gsub(" ", "",
                   paste(here::here("./Figures_Tables/ANOVA_tables_images/ "),
                       "AIC_comparison_",
                       toString(formula(full_model)[[2]]),
                       "_urbscore",
                       # deparse(substitute(full_model)),
                       ".csv")))
  
}
AIC_compare.urb_score_transf <- function(full_model, ME_model) {
  
  data.frame(Model = c("Full model",
                       "Main effects only"),
                     AIC = c(AIC(full_model),
                             AIC(ME_model))) %>%
    write.csv(gsub(" ", "",
                   paste(here::here("./Figures_Tables/ANOVA_tables_images/ "),
                       "AIC_comparison_",
                       toString(formula(full_model)[[2]][2]),
                       "_urbscore",
                       # deparse(substitute(full_model)),
                       ".csv")))
  
}
AIC_compare.urb_score_transf_binomial <- function(full_model, ME_model) {
  
  data.frame(Model = c("Full model",
                       "Main effects only"),
                     AIC = c(AIC(full_model),
                             AIC(ME_model))) %>%
    write.csv(gsub(" ", "",
                   paste(here::here("./Figures_Tables/ANOVA_tables_images/ "),
                       "AIC_comparison_",
                       toString(formula(full_model)[[2]][2]),
                       "_urbscore_binomial",
                       # deparse(substitute(full_model)),
                       ".csv")))
  
}
AIC_compare.urb_score_transf_quantitative <- function(full_model, ME_model) {
  
  data.frame(Model = c("Full model",
                       "Main effects only"),
                     AIC = c(AIC(full_model),
                             AIC(ME_model))) %>%
    write.csv(gsub(" ", "",
                   paste(here::here("./Figures_Tables/ANOVA_tables_images/ "),
                       "AIC_comparison_",
                       toString(formula(full_model)[[2]][2]),
                       "_urbscore_quantitative",
                       # deparse(substitute(full_model)),
                       ".csv")))
  
}



# get name of models so I can later export all model names with their formulas-----
qq <- function(...) sapply(substitute({ ... })[-1], deparse)

```

## Import data
```{r}
# 2019 data-----
data_clean_2019 <- read.csv(here::here("./CommonGardenExperiment_2019Data/clean_data/clean_data_2019KSR.csv"), na.strings=c("NO PLANT", "none"), blank.lines.skip=TRUE, header=TRUE, sep=",") %>%
  dplyr::select(., -c(1:2))

```

# Statistics: 2019
## Heights
### Early June height
#### lmer
##### Entire gradient: *Not sig for city_dis or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################
diagnostic(test1)

plot(test1, type = c("p", "smooth"))
plot(test1, sqrt(abs(resid(.))) ~ fitted(.),
     type = c("p", "smooth"))
qqnorm(residuals(test1))
qqline(residuals(test1))


### NESTED RANDOM EFFECTS-----
test1<- lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant


r.squaredGLMM(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_DC1 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant



# ANy variation within families or populations?
m.1 <- lmer(Total_Height_DC1 ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families
# 
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_EarlyJuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_EarlyJuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)
# is singular...

car::Anova(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant


r.squaredGLMM(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_DC1 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_DC1 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant

```

##### Urban subtransects: *transect sig for both
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)


car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_DC1 ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for within families

m.2 <- lmer(Total_Height_DC1 ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# YES among transects


m.3 <- lmer(Total_Height_DC1 ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# YES among transects (still)


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_earlyJuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_earlyJuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_earlyJuneHeight_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


AIC(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Mid June height
#### lmer
##### Entire gradient: *NOT sig for city_dist or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance NOT significant


r.squaredGLMM(lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant




# ANy variation within families or populations?
m.1 <- lmer(Total_Height_midJune ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant


r.squaredGLMM(lmer(Total_Height_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_midJune ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Total_Height_midJune ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant

```

##### Urban subtransects: *transect sig for both
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# singular, transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_midJune ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families

m.2 <- lmer(Total_Height_midJune ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# YES among transects though


m.3 <- lmer(Total_Height_midJune ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# YES amnog transects


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_urban_lmer_PVE.csv",
            col.names=TRUE, sep=",")
write.table(variances1,
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_midJuneHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Sept height
#### lmer
##### Entire gradient: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))
# distance not significant


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance not  significant

r.squaredGLMM(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))

# ANy variation within families or populations?
m.1 <- lmer(Total_Height_Sept ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families

sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)
# not singular...

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# not significant


### CROSSED RANDOM EFFECTS-----
lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)
# NOT singular!

car::Anova(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# not significant

r.squaredGLMM(lmer(Total_Height_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))

```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(Total_Height_Sept ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for among families

m.2 <- lmer(Total_Height_Sept ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# not among transects though


m.3 <- lmer(Total_Height_Sept ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# not sig in this or m.2


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",")
write.table(variances1,
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2),
            "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_SeptHeight_urban_lmer_PVE.csv", 
            col.names=TRUE, sep=",", append=TRUE)
```


###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


# Just main effects
car::Anova(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# nothing significant


AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(Total_Height_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```

## Relative Growth Rate
### Mid-June through Sept
#### lmer
##### Entire gradient: *Not sig for city_dis or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant


r.squaredGLMM(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F)
# NOT singular

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, REML = F))
# distance NOT significant




# ANy variation within families or populations?
m.1 <- lmer(rel_growth_rate ~ (1|Population/Family), data = heights_2019, REML = T)

ranova(m.1)
# YES for within families
# 
sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F)

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant


r.squaredGLMM(lmer(rel_growth_rate ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F)

car::Anova(lmer(rel_growth_rate ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, REML = F))
# nothing significant

```

##### Urban subtransects: *transect sig for both
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# singular

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC




# ANy variation among families or populations?
m.1 <- lmer(rel_growth_rate ~ (1|Population/Family), data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
ranova(m.1)
# YES for within families

m.2 <- lmer(rel_growth_rate ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
car::Anova(m.2)
# YES among transects


m.3 <- lmer(rel_growth_rate ~ (1|Population/Family) + Transect_ID, data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = T)
car::Anova(m.3)
# YES among transects (still)


sum.1 <- summary(m.1)

variances1 <- print(VarCorr(m.1),comp="Variance")
variances1 <- as.data.frame(variances1)
variances1 <- variances1 %>%
  dplyr::mutate(., PVE = vcov / sum(vcov)) %>%
  dplyr::select(., c(grp, vcov, PVE)) %>%
  dplyr::rename(., Group = grp,
                Variance = vcov)


write.table(ranova(m.1), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",")
write.table(variances1, "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
write.table(car::Anova(m.2), "~/R_Projects/chapter_two/Figures_Tables/ranova_PVE/2019_relgrowthrate_urban_lmer_PVE.csv", col.names=TRUE, sep=",", append=TRUE)
```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F)
# No warnings!!

car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# transect significant


# Just main effects
car::Anova(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
     control=lmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))

AIC(lmer(rel_growth_rate  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


## No. Ramets
### Early June ramets
NOTE: Originally used lmer but then switched to glmer w/poisson bc it's count data.
-This didn't change the story for gradient (city_dist nor urb_score)
-This DID change story for urb subs (urb_score: interaxn became sig)
#### glmer
##### Entire gradient: *Not sig for city_dis or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, family = poisson)
# NOT singular

car::Anova(glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, family = poisson))
# distance NOT significant


r.squaredGLMM(glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, family = poisson))

### CROSSED RANDOM EFFECTS-----
glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, family = poisson)
# NOT singular

car::Anova(glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, family = poisson))
# distance NOT significant


```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, family = poisson)
# not singular...

car::Anova(glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, family = poisson))
# nothing significant


r.squaredGLMM(glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, REML = F))

### CROSSED RANDOM EFFECTS-----
glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, family = poisson)
# NOT singular!

car::Anova(glmer(Num_Ramets_DC1 ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, family = poisson))
# nothing significant

```

##### Urban subtransects: *transect sig for both AND interaxn sig for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


# Just main effects
car::Anova(glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# No warnings!!

car::Anova(glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


# Just main effects
car::Anova(glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant


AIC(glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

AIC(glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best models" though just main effects lower AIC

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant and so is interaxn




### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# No warnings!!

car::Anova(glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect significant AND interaxn



AIC(glmer(Num_Ramets_DC1  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))


```


### Mid June ramets
NOTE: Originally used lmer but then switched to glmer w/poisson bc it's count data.
-This didn't change the story for gradient (city_dist nor urb_score)
-This DID change story for urb subs (urb_score: transect became marg sig)
#### glmer
##### Entire gradient: *NOT sig for city_dist or urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))

car::Anova(glmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance NOT significant


r.squaredGLMM(glmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

### CROSSED RANDOM EFFECTS-----
glmer(Ramets_midJune ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# NOT singular!

car::Anova(glmer(Ramets_midJune ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance NOT significant

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, family = poisson)

car::Anova(glmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, family = poisson))
# nothing significant


r.squaredGLMM(glmer(Ramets_midJune ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, family = poisson))

### CROSSED RANDOM EFFECTS-----
glmer(Ramets_midJune ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, family = poisson)
# NOT singular

car::Anova(glmer(Ramets_midJune ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, family = poisson))
# nothing significant

```

##### Urban subtransects: *transect marg sig for city_dist, not for urb_score
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson)
# singular

car::Anova(glmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# transect marg significant


# Just main effects
car::Anova(glmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# singular, transect marg significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# model not converging...

car::Anova(glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect marg significant


# Just main effects
car::Anova(glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# transect marg significant


AIC(glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

AIC(glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# AIC <2 apart; both "best models" though just main effects lower AIC

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson)
# singular

car::Anova(glmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# transect marg significant


# Just main effects
car::Anova(glmer(Ramets_midJune  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# transect marg significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson)
# No warnings!!

car::Anova(glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# transect marg significant


# Just main effects
car::Anova(glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID, 
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# transect marg significant


AIC(glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))

AIC(glmer(Ramets_midJune  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# AIC <2 apart; both "best models" though just main effects lower AIC

```


### Sept ramets
NOTE: Originally used lmer but then switched to glmer w/poisson bc it's count data.
-This didn't change the story for gradient OR urb subs (city_dist nor urb_score)
#### glmer
##### Entire gradient: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, family = poisson)
#  singular

car::Anova(glmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019, family = poisson))
# distance not significant


### CROSSED RANDOM EFFECTS-----
glmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# convergence warning

car::Anova(glmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# distance not  significant

r.squaredGLMM(glmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
#  singular...

car::Anova(glmer(Ramets_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_2019, family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# not significant


### CROSSED RANDOM EFFECTS-----
glmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, family = poisson)
# NOT singular!

car::Anova(glmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, family = poisson))
# not significant

r.squaredGLMM(glmer(Ramets_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = heights_2019, family = poisson))

```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# singular

car::Anova(glmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


# Just main effects
car::Anova(glmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
     control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson)
# No warnings!!

car::Anova(glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# nothing significant


# Just main effects
car::Anova(glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# nothing significant


AIC(glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))

AIC(glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# AIC <2 apart; both "best models" though just main effects lower AIC
```


###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson)
# singular

car::Anova(glmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# nothing significant


# Just main effects
car::Anova(glmer(Ramets_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson,
      control=glmerControl(optimizer="bobyqa",
                                  optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson)
# No warnings!!

car::Anova(glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# nothing significant


# Just main effects
car::Anova(glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# nothing significant


AIC(glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))

AIC(glmer(Ramets_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = heights_2019 %>% dplyr::filter(., Transect_ID != "Rural"), family = poisson))
# AIC <2 apart; both "best models" though just main effects lower AIC

```

## Herbivory
### Sept
#### glmer w/binomial distr.
NOTE: I originally fit these models w/herbivory scores ranging from 0 to 100 and used lmer. Then I switched to herbivory percents (dividing by 100) and using binomial distr. I would've used quasi-binomial but glmer can't handle that, only glm.
-The story didn't change when analyzing the entire gradient NOR urban subtransects: i.e. herbivory didn't change with urbanization when quantified with city_dist nor urb_score.
##### Entire gradient: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

# Using a binomial distribution bc glmer can't handle quasi-binomial, which is what the optimal model would be here.

### NESTED RANDOM EFFECTS-----
glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herb_2019,
  family = binomial(link = logit))
# is singular...

car::Anova(glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herb_2019,
  family = binomial(link = logit)))
# nothing is significant

r.squaredGLMM(glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + City_dist,
  data = herb_2019,
  family = binomial(link = logit)))  

### CROSSED RANDOM EFFECTS-----
glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herb_2019,
  family = binomial(link = logit))
#  singular

car::Anova(glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population:Family) + City_dist,
  data = herb_2019,
  family = binomial(link = logit)))
# distance not significant


```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herb_2019,
  family = binomial(link = logit))
# is singular...

car::Anova(glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herb_2019,
  family = binomial(link = logit)))
# nothing is significant

r.squaredGLMM(glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = herb_2019,
  family = binomial(link = logit)))
  

### CROSSED RANDOM EFFECTS-----
glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herb_2019,
  family = binomial(link = logit))
#  singular

car::Anova(glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = herb_2019,
  family = binomial(link = logit)))
#  not significant


```


##### Urban subtransects: *Not sig for either
###### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = logit))
# singular...

car::Anova(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
       family = binomial(link = logit)))
# nothingsignificant


# Just main effects
car::Anova(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = logit)))
# singular... nothing is significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
       family = binomial(link = logit))
#  singular...

car::Anova(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
      family = binomial(link = logit)))
# nothing is significant


# Just main effects
car::Anova(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
       family = binomial(link = logit)))
# singular... nothing is significant


AIC(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),   family = binomial(link = logit))
)

AIC(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),  family = binomial(link = logit))
)
# AIC <2 apart; both "best models" though main effects model has lower AIC

```

###### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
     family = binomial(link = logit))
# singular...

car::Anova(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
     family = binomial(link = logit))
)
# nothing significant


# Just main effects
car::Anova(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
     family = binomial(link = logit)))
# singular... nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
       family = binomial(link = logit))
#  singular...

car::Anova(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
       family = binomial(link = logit)))
# nothing significant


# Just main effects
car::Anova(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
       family = binomial(link = logit)))
# singular... nothing significant


AIC(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
     family = binomial(link = logit))
)

AIC(glmer(Herbivory_mean_Sept  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
     data = herb_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
     family = binomial(link = logit))
)
# AIC <2 apart; both "best models" though main effects model has lower AIC

```



## Survival
### glmer
#### Entire gradient: *Nothing sig for either
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Population/Family) + City_dist,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# CONVERGES when I set nAGQ to 0

car::Anova(glmer(Dead ~ (1|Block) + (1|Population/Family) + City_dist,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Population:Family) + City_dist,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# no problems


car::Anova(glmer(Dead ~ (1|Block) + (1|Population:Family) + City_dist,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant

```

##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################


### NESTED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# CONVERGES when I set nAGQ to 0

car::Anova(glmer(Dead ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
glmer(Dead ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5)))
# no problems


car::Anova(glmer(Dead ~ (1|Block) + (1|Population:Family) + Urb_score,
  data = surv_2019,
  family = binomial(link = "logit"),
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa",
                                 optCtrl=list(maxfun=2e5))))
# nothing significant


```


#### Urban subtransects: *interaxn sig for city_dist when crossed; nothing sig for urb_score
##### City_dist
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# no problems!

car::Anova(glmer(Dead  ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# interaxn marg significant


# Just main effects
car::Anova(glmer(Dead  ~ (1|Block) + (1|Population/Family) + City_dist + Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings

car::Anova(glmer(Dead  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# interaxn is significant



AIC(glmer(Dead  ~ (1|Block) + (1|Population:Family) + City_dist * Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(Dead  ~ (1|Block) + (1|Population:Family) + City_dist + Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC >2 apart; full model is "best model"
```


##### Urb_score
```{r}
# NO DIFFERENCE BETWEEN MODELS W/ CROSSED VS NESTED RANDOM EFFECTS #
###################################################################

### NESTED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# no problems!

car::Anova(glmer(Dead  ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Dead  ~ (1|Block) + (1|Population/Family) + Urb_score + Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant



### CROSSED RANDOM EFFECTS-----
# Full model
glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000)))
# No warnings

car::Anova(glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
  data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = binomial(link = "logit"),
  nAGQ=0,
  glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


# Just main effects
car::Anova(glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),
                 family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# nothing significant


AIC(glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score * Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))

AIC(glmer(Dead  ~ (1|Block) + (1|Population:Family) + Urb_score + Transect_ID,
                 data = surv_2019 %>% dplyr::filter(., Transect_ID != "Rural"),        family = binomial(link = "logit"),
                 nAGQ=0,
                 glmerControl(optimizer="bobyqa", optCtrl = list(maxfun = 100000))))
# AIC <2 apart; both "best models" though full model lower AIC
```


