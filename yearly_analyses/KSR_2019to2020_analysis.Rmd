---
title: "2019-2020 analysis"
output: html_document
---

Import data, then run script.

## Make combined 2019/2020 dfs
```{r}
# heights (includes heights and num. ramets)-----
## first make copy of data_clean_2019 with colnames that match heights_both_2020's
heights_2019 <- data_clean_2019 %>%
  dplyr::select(., c(1:6, 11:13, 18:19, 25:41)) %>%
  dplyr::filter(., Dead_2019 == 0) %>%
  dplyr::rename(., Dead = Dead_2019,
                Ramets_midJune = Num_Ramets_DC2, # doing this & following rows to compare btwn years
                Ramets_Sept = Num_Ramets_DC3, 
                Total_Height_midJune = Total_Height_DC2,
                Total_Height_Sept = Total_height_DC3) 
heights_2019$Year = 2019
heights_2019$rel_growth_rate <- as.character(heights_2019$rel_growth_rate)
heights_2019$rel_growth_rate <- as.numeric(heights_2019$rel_growth_rate)


# copy of 2020 data w/colnames that match 2019's
heights_2020 <- heights_both_2020 %>%
  dplyr::select(., -c(16)) %>%
  dplyr::rename(., Ramets_midJune = Ramets_June, # doing this & following rows to compare btwn years
                Total_Height_midJune = Total_Height_June) 
heights_2020$Year = 2020

# combine yearly dfs
heights_19_20 <- rbind.fill(heights_2019, heights_2020)
heights_19_20$Year <- as.factor(heights_19_20$Year)
heights_19_20$Family <- as.factor(heights_19_20$Family)
heights_19_20$Population <- as.factor(heights_19_20$Population)
heights_19_20$rel_growth_rate <- as.numeric(heights_19_20$rel_growth_rate)

# rm(heights_2019, heights_2020)

heights_19_20$Population <- as.factor(heights_19_20$Population)
heights_19_20$Family <- as.factor(heights_19_20$Family)




# herbivory-----
## first make copy of data_clean_2019 with colnames that match heights_both_2020's
herb_2019 <- data_clean_2019 %>%
  dplyr::select(., c(1:6, 18:19, 21, 32, 35:41)) %>%
  dplyr::filter(., Dead_2019 == 0) %>%
  dplyr::rename(., Dead = Dead_2019,
                Herbivory_mean_Sept = Herbivory_mean_DC3 # doing this to compare btwn years
                ) 
herb_2019$Year = 2019
herb_2019$Herbivory_mean_Sept <- as.character(herb_2019$Herbivory_mean_Sept)
herb_2019$Herbivory_mean_Sept <- as.numeric(herb_2019$Herbivory_mean_Sept)

# copy of 2020 data w/colnames that match 2019's
herb_2020 <- herbivory_both_2020 %>%
  dplyr::select(., -c(18)) %>%
  dplyr::rename(., Herbivory_mean_Sept = Herbivory.Sept_mean # doing thisto compare btwn years
                ) 
herb_2020$Year = 2020

# combine yearly dfs
herbivory_19_20 <- rbind.fill(herb_2019, herb_2020)

# rm(herb_2019, herb_2020)

herbivory_19_20$Population <- as.factor(herbivory_19_20$Population)
herbivory_19_20$Family <- as.factor(herbivory_19_20$Family)





# survival-----

## first make copy of data_clean_2019 with colnames that match heights_both_2020's
surv_2019 <- data_clean_2019 %>%
  dplyr::select(., c(1:6, 14:16, 25, 32, 35:41)) %>%
  dplyr::rename(., Dead = Dead_2019                ) 
surv_2019$Year = 2019

# copy of 2020 data w/colnames that match 2019's
surv_2020 <- survival_2020 %>%
  dplyr::select(., -c(12)) %>%
  dplyr::rename(., Dead = dead_2020 # doing thisto compare btwn years
                ) 
surv_2020$Year = 2020

# combine yearly dfs
survival_19_20 <- rbind.fill(surv_2019, surv_2020)

# rm(surv_2019, surv_2020)

survival_19_20$Population <- as.factor(survival_19_20$Population)
survival_19_20$Family <- as.factor(survival_19_20$Family)
survival_19_20$Block <- as.factor(survival_19_20$Block)
survival_19_20$Year <- as.factor(survival_19_20$Year)


```




# Statistics: 2019-2020 (seems better to do per year)
## Heights
### Mid June height
#### lmer: diagnostics
```{r}
# Gradient / city_dist----------
height_gr_dist_m1 <- lmer(Total_Height_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height_gr_dist_m1, type='diag')
# looks like there's some heteroskedasticity and it's right-skewed... try sqrt transformation


height_gr_dist_m2 <- lmer(sqrt(Total_Height_midJune) ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height_gr_dist_m2, type='diag')
# much better!



# Gradient / urb_score----------
height_gr_usc_m1 <- lmer(Total_Height_midJune ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score ,
  data = heights_19_20, REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height_gr_usc_m1, type='diag')
# looks like there's some heteroskedasticity and it's right-skewed... try sqrt transformation

height_gr_usc_m2 <- lmer(sqrt(Total_Height_midJune) ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score ,
  data = heights_19_20, REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height_gr_usc_m2, type='diag')
# much better!



# Urb sites / city_dist----------
height_urb_dist_m1 <- lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height_urb_dist_m1, type='diag')
# looks like there's some heteroskedasticity and it's right-skewed... try sqrt transformation

height_urb_dist_m2 <- lmer(sqrt(Total_Height_midJune)  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height_urb_dist_m2, type='diag')
# much better!

# main effects:
height_urb_dist_m2_ME <- lmer(sqrt(Total_Height_midJune)  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))





# Urb sites / urb_score----------
height_urb_usc_m1 <- lmer(Total_Height_midJune  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height_urb_usc_m1, type='diag')
# looks like there's some heteroskedasticity and it's right-skewed... try sqrt transformation

height_urb_usc_m2 <- lmer(sqrt(Total_Height_midJune)  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height_urb_usc_m2, type='diag')
# much better!


# main effects:
height_urb_usc_m2_ME <- lmer(sqrt(Total_Height_midJune)  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
```

#### Entire gradient: *dist & urb score not sig
##### City_dist
```{r}
car::Anova(height_gr_dist_m2)
# dist not significant

r.squaredGLMM(height_gr_dist_m2)
```

##### Urb_score
```{r}
car::Anova(height_gr_usc_m2)
# dist not significant

r.squaredGLMM(height_gr_usc_m2)
```

#### Urban subtransects: *transect sig for both
##### City_dist
```{r}
car::Anova(height_urb_dist_m2)
# dist not significant but transect ID is!

r.squaredGLMM(height_urb_dist_m2)


# just main effects
car::Anova(height_urb_dist_m2_ME)
# transect sig

r.squaredGLMM(height_urb_dist_m2_ME)

AIC((height_urb_dist_m2),
    (height_urb_dist_m2_ME)) # better but <2 AIC from full model
```

##### Urb_score
```{r}
car::Anova(height_urb_usc_m2)
# urb score not significant but transect ID is!

r.squaredGLMM(height_urb_usc_m2)


# just main effects
car::Anova(height_urb_usc_m2_ME)
# transect sig

r.squaredGLMM(height_urb_usc_m2_ME)

AIC((height_urb_usc_m2),
    (height_urb_usc_m2_ME)) # better but <2 AIC from full model
```


### Sept height- nothing sig. Look at yearly data
#### lmer: diagnostics
```{r}
# Gradient / city_dist----------
height2_gr_dist_m1 <- lmer(Total_Height_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height2_gr_dist_m1, type='diag')
# looks like there's some heteroskedasticity and it's right-skewed... try sqrt transformation


height2_gr_dist_m2 <- lmer(sqrt(Total_Height_Sept) ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height2_gr_dist_m2, type='diag')
# much better though still not good enough... two distinct clusters... try cube root

height2_gr_dist_m3 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height2_gr_dist_m3, type='diag')
# didn't help much... maybe this data isn't normal? is it bimodal?

hist(heights_19_20$Total_Height_Sept, breaks = 40)


# what do diagnostic plots look like for just 2020 data? (sqrt)
sjPlot::plot_model(lmer(sqrt(Total_Height_Sept) ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2020,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5))), type='diag')
# looks pretty good... and 2019 data?

sjPlot::plot_model(lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_2019,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5))), type='diag')
# better but still bimodal... take out zeros then do binomial- were plants alive (have heights > 0?), then look at quantitative measurements



# TAKING OUT PLANTS W/ZERO HEIGHT & FITTING A BINOMIAL MODEL
## THEN I'LL USE >0 DATA AND LOOK AT QUANTITATIVE MEASUREMENTS

# recode plants as having height or not
heights_19_20$Total_Height_Sept_binary <- heights_19_20$Total_Height_Sept
heights_19_20$Total_Height_Sept_binary[heights_19_20$Total_Height_Sept_binary > 0] <- 1

height2_gr_dist_m4 <- glmer((Total_Height_Sept_binary) ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  family = "binomial"(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(height2_gr_dist_m4)
plot(res)
# looks great!
summary(height2_gr_dist_m4)

car::Anova(height2_gr_dist_m4) # not sig



height2_gr_dist_m5 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1),
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_gr_dist_m5, type='diag')
# looks ok... still heavy tails and two distinct clumps... does this go away when I separate the years?

# 2019
height2_gr_dist_m5.2019 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1 & Year == 2019),
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_gr_dist_m5.2019, type='diag')
# looks pretty good- one clump instead of two...

# 2020
height2_gr_dist_m5.2020 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Population/Family) + City_dist,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1 & Year == 2020),
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_gr_dist_m5.2020, type='diag')
# again, looks pretty good- one clump instead of two...

car::Anova(height2_gr_dist_m5) # not sig
car::Anova(height2_gr_dist_m5.2019) # not sig
car::Anova(height2_gr_dist_m5.2020) # not sig


# look at correlation of height btwn years
heights_19_20_joined <- join(heights_2019[, c(1:6, 18)], heights_2020[,c(1:6, 12)], by = c("Row", "Column", "Population", "Block", "Replicate"))
heights_19_20_joined <- heights_19_20_joined[, -8]
colnames(heights_19_20_joined)[7] <- "Total_Height_Sept_2019"
colnames(heights_19_20_joined)[8] <- "Total_Height_Sept_2020"

ggplot(heights_19_20_joined, aes(x = Total_Height_Sept_2019, y = Total_Height_Sept_2020)) +
  geom_point() +
  geom_smooth(method = lm) +
  ggtitle("R-squared: ", summary(corr_heights_m1)$r.squared)

corr_heights_m1 <- lm(Total_Height_Sept_2019 ~ Total_Height_Sept_2020, heights_19_20_joined)
summary(corr_heights_m1)






# Gradient / urb_score----------
height2_gr_usc_m1 <- lmer(Total_Height_Sept ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score ,
  data = heights_19_20,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_gr_usc_m1, type='diag')
# looks like there's some heteroskedasticity and it's right-skewed... try sqrt transformation

height2_gr_usc_m2 <- lmer(sqrt(Total_Height_Sept) ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score ,
  data = heights_19_20,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_gr_usc_m2, type='diag')
# same issues as above...


# TAKING OUT PLANTS W/ZERO HEIGHT & FITTING A BINOMIAL MODEL
## THEN I'LL USE >0 DATA AND LOOK AT QUANTITATIVE MEASUREMENTS

height2_gr_usc_m3 <- glmer((Total_Height_Sept_binary) ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20,
  family = "binomial"(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(height2_gr_usc_m3)
plot(res)
# looks great!
summary(height2_gr_usc_m3)

car::Anova(height2_gr_usc_m3) # not sig



height2_gr_usc_m4 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1),
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_gr_usc_m4, type='diag')
# looks ok... still heavy tails and two distinct clumps... does this go away when I separate the years?

# 2019
height2_gr_usc_m4.2019 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1 & Year == 2019),
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_gr_usc_m4.2019, type='diag')
# looks pretty good- one clump instead of two...

# 2020
height2_gr_usc_m4.2020 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Population/Family) + Urb_score,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1 & Year == 2020),
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_gr_usc_m4.2020, type='diag')
# again, looks pretty good- one clump instead of two...

car::Anova(height2_gr_usc_m4) # not sig
car::Anova(height2_gr_usc_m4.2019) # not sig
car::Anova(height2_gr_usc_m4.2020) # not sig









# Urb sites / city_dist----------
height2_urb_dist_m1 <- lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height2_urb_dist_m1, type='diag')
# looks like there's some heteroskedasticity and it's right-skewed... try sqrt transformation

height2_urb_dist_m2 <- lmer(sqrt(Total_Height_Sept)  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height2_urb_dist_m2, type='diag')
# same issues as above



# TAKING OUT PLANTS W/ZERO HEIGHT & FITTING A BINOMIAL MODEL
## THEN I'LL USE >0 DATA AND LOOK AT QUANTITATIVE MEASUREMENTS

height2_urb_dist_m3 <- glmer((Total_Height_Sept_binary) ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
  data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = "binomial"(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(height2_urb_dist_m3)
plot(res)
# looks great!
summary(height2_urb_dist_m3)

car::Anova(height2_urb_dist_m3) # not sig



height2_urb_dist_m4 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1),
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_urb_dist_m4, type='diag')
# looks ok... still heavy tails and two distinct clumps... does this go away when I separate the years?

# 2019
height2_urb_dist_m4.2019 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1 & Year == 2019),
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_urb_dist_m4.2019, type='diag')
# looks pretty good- one clump instead of two...

# 2020
height2_urb_dist_m4.2020 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Population/Family) + City_dist * Transect_ID,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1 & Year == 2020),
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_urb_dist_m4.2020, type='diag')
# again, looks pretty good- one clump instead of two...

car::Anova(height2_urb_dist_m4) # city_dist MARGINALLY sig
car::Anova(height2_urb_dist_m4.2019) # not sig
car::Anova(height2_urb_dist_m4.2020) # not sig





# Urb sites / urb_score----------
height2_urb_usc_m1 <- lmer(Total_Height_Sept  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height2_urb_usc_m1, type='diag')
# looks like there's some heteroskedasticity and it's right-skewed... try sqrt transformation

height2_urb_usc_m2 <- lmer(sqrt(Total_Height_Sept)  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(height2_urb_usc_m2, type='diag')
# same issues as above


# TAKING OUT PLANTS W/ZERO HEIGHT & FITTING A BINOMIAL MODEL
## THEN I'LL USE >0 DATA AND LOOK AT QUANTITATIVE MEASUREMENTS

height2_urb_usc_m3 <- glmer((Total_Height_Sept_binary) ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
  data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
  family = "binomial"(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(height2_urb_usc_m3)
plot(res)
# looks great!
summary(height2_urb_usc_m3)

car::Anova(height2_urb_usc_m3) # not sig



height2_urb_usc_m4 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1),
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_urb_usc_m4, type='diag')
# looks ok... still heavy tails and two distinct clumps... does this go away when I separate the years?

# 2019
height2_urb_usc_m4.2019 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1 & Year == 2019),
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_urb_usc_m4.2019, type='diag')
# looks pretty good- one clump instead of two...

# 2020
height2_urb_usc_m4.2020 <- lmer((Total_Height_Sept)^(1/3) ~ (1|Block) + (1|Population/Family) + Urb_score * Transect_ID,
  data = heights_19_20 %>% filter(Total_Height_Sept_binary == 1 & Year == 2020),
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(height2_urb_usc_m4.2020, type='diag')
# again, looks pretty good- one clump instead of two...

car::Anova(height2_urb_usc_m4) # not sig
car::Anova(height2_urb_usc_m4.2019) # not sig
car::Anova(height2_urb_usc_m4.2020) # not sig


```
## Relative Growth Rate
### Mid-June through Sept
#### lmer: diagnostics
```{r}
# Gradient / city_dist----------
rgr_gr_dist_m1 <- lmer(rel_growth_rate ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(rgr_gr_dist_m1, type='diag')
# two clear clusters and tails


rgr_gr_dist_m2 <- lmer(sqrt(rel_growth_rate) ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(rgr_gr_dist_m2, type='diag')
# much better!




# Gradient / urb_score----------
rgr_gr_usc_m1 <- lmer(rel_growth_rate ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score ,
  data = heights_19_20, REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(rgr_gr_usc_m1, type='diag')
# two clear clusters and tails


rgr_gr_usc_m2 <- lmer(sqrt(rel_growth_rate) ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score ,
  data = heights_19_20, REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
sjPlot::plot_model(rgr_gr_usc_m2, type='diag')
# much better!



# Urb sites / city_dist----------
rgr_urb_dist_m1 <- lmer(rel_growth_rate  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(rgr_urb_dist_m1, type='diag')
# two clear clusters and tails

rgr_urb_dist_m2 <- lmer(sqrt(rel_growth_rate)  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(rgr_urb_dist_m2, type='diag')
# much better! still have some tails but this is the best model.


rgr_urb_dist_m3 <- lmer((rel_growth_rate)^(1/3)  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(rgr_urb_dist_m3, type='diag')
# too much

rgr_urb_dist_m4 <- lmer(log(rel_growth_rate + 1)  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(rgr_urb_dist_m4, type='diag')
# too much

hist(heights_19_20$rel_growth_rate)


# main effects:
rgr_urb_dist_m2_ME <- lmer(sqrt(rel_growth_rate)  ~ (1|Block) + (1|Year) +(1|Population/Family) + City_dist + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))





# Urb sites / urb_score----------
rgr_urb_usc_m1 <- lmer(rel_growth_rate  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(rgr_urb_usc_m1, type='diag')
# two clumps and left skew

rgr_urb_usc_m2 <- lmer(sqrt(rel_growth_rate)  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(rgr_urb_usc_m2, type='diag')
# much better! still tails though


rgr_urb_usc_m3 <- lmer((rel_growth_rate)^(1/3)  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score * Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

sjPlot::plot_model(rgr_urb_usc_m3, type='diag')
# too much

# main effects:
rgr_urb_usc_m2_ME <- lmer(sqrt(rel_growth_rate)  ~ (1|Block) + (1|Year) +(1|Population/Family) + Urb_score + Transect_ID,
     data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"), REML = F,
  control=lmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
```

#### Entire gradient: *Nothing sig
##### City_dist
```{r}
car::Anova(rgr_gr_dist_m2)
# dist not significant

r.squaredGLMM(rgr_gr_dist_m2)

```

##### Urb_score
```{r}
car::Anova(rgr_gr_usc_m2)
# dist not significant

r.squaredGLMM(rgr_gr_usc_m2)

```

#### Urban subtransects: *nothing sig
##### City_dist
```{r}
car::Anova(rgr_urb_dist_m2)
# nothing sig

r.squaredGLMM(rgr_urb_dist_m2)


# just main effects
car::Anova(rgr_urb_dist_m2_ME)
#  nothing sig

r.squaredGLMM(rgr_urb_dist_m2_ME)

AIC((rgr_urb_dist_m2),
    (rgr_urb_dist_m2_ME)) # better but <2 AIC from full model
```

##### Urb_score
```{r}
car::Anova(rgr_urb_usc_m2)
# nothing sig

r.squaredGLMM(rgr_urb_usc_m2)


# just main effects
car::Anova(rgr_urb_usc_m2_ME)
#  nothing sig

r.squaredGLMM(rgr_urb_usc_m2_ME)

AIC((rgr_urb_usc_m2),
    (rgr_urb_usc_m2_ME)) # better model
```


## No. Ramets- nothing sig
### Mid June ramets
#### glmer: diagnostics
```{r}
# Gradient / city_dist----------
ramets_gr_dist_m1 <- glmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(ramets_gr_dist_m1)
plot(res)
testOutliers(ramets_gr_dist_m1)
# looks good.




# Gradient / urb_score----------
ramets_gr_usc_m1 <- glmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20,
  family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(ramets_gr_usc_m1)
plot(res)
testOutliers(ramets_gr_usc_m1)
# looks good.



# Urb sites / city_dist----------
ramets_urb_dist_m1 <- glmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
    data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(ramets_urb_dist_m1)
plot(res)
# looks good.


# main effects:
ramets_urb_dist_m2_ME <- glmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) +  City_dist + Transect_ID,
    data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))




# Urb sites / urb_score----------
ramets_urb_usc_m1 <- glmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
    data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(ramets_urb_usc_m1)
plot(res)
testOutliers(ramets_urb_usc_m1)
# looks good.


# main effects:
ramets_urb_usc_m2_ME <- glmer(Ramets_midJune ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
    data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
```

#### Entire gradient: *NOT sig for city_dist or urb_score
##### City_dist
```{r}
car::Anova(ramets_gr_dist_m1)
# dist not significant

r.squaredGLMM(ramets_gr_dist_m1)
```

##### Urb_score
```{r}
car::Anova(ramets_gr_usc_m1)
# dist not significant

r.squaredGLMM(ramets_gr_usc_m1)

```

#### Urban subtransects: nothing sig
##### City_dist
```{r}
car::Anova(ramets_urb_dist_m1)
# nothing sig

r.squaredGLMM(ramets_urb_dist_m1)


# just main effects
car::Anova(ramets_urb_dist_m2_ME)
# nothing sig

r.squaredGLMM(ramets_urb_dist_m2_ME)

AIC((ramets_urb_dist_m1),
    (ramets_urb_dist_m2_ME)) # better but <2 AIC from full model
```

##### Urb_score
```{r}
car::Anova(ramets_urb_usc_m1)
# nothing sig

r.squaredGLMM(ramets_urb_usc_m1)


# just main effects
car::Anova(ramets_urb_usc_m2_ME)
# nothing sig

r.squaredGLMM(ramets_urb_usc_m2_ME)

AIC((ramets_urb_usc_m1),
    (ramets_urb_usc_m2_ME)) # better but <2 AIC from full model
```


### Sept ramets
#### glmer: diagnostics
```{r}
# Gradient / city_dist----------
ramets2_gr_dist_m1 <- glmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = heights_19_20,
  family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(ramets2_gr_dist_m1)
plot(res)
# looks good.




# Gradient / urb_score----------
ramets2_gr_usc_m1 <- glmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20,
  family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(ramets2_gr_usc_m1)
plot(res)
# looks good though try negative binomial to see if that'll satisfy KS test

ramets2_gr_usc_m2 <- glmmTMB(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = heights_19_20,
  family = nbinom1(),
  REML = F)
res <- simulateResiduals(ramets2_gr_usc_m2)
plot(res)
# model convergence problem... using poisson (though it doesn't make a difference... see anovas below)
car::Anova(ramets2_gr_usc_m1)
car::Anova(ramets2_gr_usc_m2)


# Urb sites / city_dist----------
ramets2_urb_dist_m1 <- glmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
    data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(ramets2_urb_dist_m1)
plot(res)
# looks good.


# main effects:
ramets2_urb_dist_m2_ME <- glmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) +  City_dist + Transect_ID,
    data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))




# Urb sites / urb_score----------
ramets2_urb_usc_m1 <- glmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
    data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(ramets2_urb_usc_m1)
plot(res)
# looks good.


# main effects:
ramets2_urb_usc_m2_ME <- glmer(Ramets_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
    data = heights_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = poisson,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
```

#### Entire gradient: *NOT sig for city_dist or urb_score
##### City_dist
```{r}
car::Anova(ramets2_gr_dist_m1)
# dist not significant

r.squaredGLMM(ramets2_gr_dist_m1)
```

##### Urb_score
```{r}
car::Anova(ramets2_gr_usc_m1)
# dist not significant

r.squaredGLMM(ramets2_gr_usc_m1)

```

#### Urban subtransects: nothing sig
##### City_dist
```{r}
car::Anova(ramets2_urb_dist_m1)
# nothing sig

r.squaredGLMM(ramets2_urb_dist_m1)


# just main effects
car::Anova(ramets2_urb_dist_m2_ME)
# nothing sig

r.squaredGLMM(ramets2_urb_dist_m2_ME)

AIC((ramets2_urb_dist_m1),
    (ramets2_urb_dist_m2_ME)) # better but <2 AIC from full model
```

##### Urb_score
```{r}
car::Anova(ramets2_urb_usc_m1)
# nothing sig

r.squaredGLMM(ramets2_urb_usc_m1)


# just main effects
car::Anova(ramets2_urb_usc_m2_ME)
# nothing sig

r.squaredGLMM(ramets2_urb_usc_m2_ME)

AIC((ramets2_urb_usc_m1),
    (ramets2_urb_usc_m2_ME)) # better but <2 AIC from full model
```

## Herbivory- DON'T USE THIS- LOOKING AT YEARLY DATA. MODELS NOT MEETING ASSUMPTIONS WELL AND YEARS HAVE PRETTY DIFFERENT DATA.
### Sept
#### glmer: diagnostics
```{r}
# Gradient / city_dist----------
herbivory_gr_dist_m1 <- glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = herbivory_19_20,
  family = "binomial"(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(herbivory_gr_dist_m1)
plot(res)
testDispersion(herbivory_gr_dist_m1)
# qqplot looks very off... try  ????
hist(herbivory_19_20$Herbivory_mean_Sept, breaks = 30)
summary(herbivory_gr_dist_m1)


herbivory_gr_dist_m2 <- glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Family) + City_dist,
  data = herbivory_19_20,
  family = "binomial"(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
res <- simulateResiduals(herbivory_gr_dist_m2)
plot(res)

# try removing pop and making families unique
herbivory_19_20[,"FamPop"] <- paste0(herbivory_19_20$Family, "-", herbivory_19_20$Population)

herbivory_gr_dist_m3 <- glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + City_dist,
  data = herbivory_19_20,
  family = "binomial"(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

summary(herbivory_gr_dist_m3)
# trying to find where all the variance is being eaten up/accounted for and still not finding it... try beta distribution


herbivory_gr_dist_m4 <- glmmTMB(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = herbivory_19_20,
  family = beta_family(link="logit"))
# Error in eval(family$initialize) : y values must be 0 < y < 1
# recode: 0s as 0.00001 & 1 as 0.999999

herbivory_19_20_recode <- herbivory_19_20
herbivory_19_20_recode$Herbivory_mean_Sept[herbivory_19_20_recode$Herbivory_mean_Sept == 1] <- 0.999999
herbivory_19_20_recode$Herbivory_mean_Sept[herbivory_19_20_recode$Herbivory_mean_Sept == 0] <- 0.000001



herbivory_gr_dist_m5 <- glmmTMB(Herbivory_mean_Sept  ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
  data = herbivory_19_20_recode,
  family = beta_family(link="logit"))
res <- simulateResiduals(herbivory_gr_dist_m5)
plot(res)
# IT WORKS

hist(herbivory_19_20$Herbivory_mean_Sept, breaks = 30)
summary(herbivory_gr_dist_m5)


herbivory_gr_dist_m6 <- glmmTMB(Herbivory_mean_Sept  ~ (1|Block) + Year + (1|Population/Family) + City_dist,
  data = herbivory_19_20_recode,
  family = beta_family(link="logit"))
res <- simulateResiduals(herbivory_gr_dist_m6)
plot(res)

herbivory_gr_dist_m7 <- glmmTMB(Herbivory_mean_Sept  ~ (1|Block) + Year + (1|FamPop) + City_dist,
  data = herbivory_19_20_recode,
  family = beta_family(link="logit"))
res <- simulateResiduals(herbivory_gr_dist_m7)
plot(res)

herbivory_gr_dist_m8 <- glmmTMB(Herbivory_mean_Sept  ~  Year + (1|FamPop) + City_dist,
  data = herbivory_19_20_recode,
  family = beta_family(link="logit"))
res <- simulateResiduals(herbivory_gr_dist_m8)
plot(res)

car::Anova(herbivory_gr_dist_m7) # doesn't run
car::Anova(herbivory_gr_dist_m8)



# Gradient / urb_score----------
herbivory_gr_usc_m1 <- glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = herbivory_19_20,
  family = binomial,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(herbivory_gr_usc_m1)
plot(res)
# try beta

herbivory_gr_usc_m2 <- glmmTMB(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = herbivory_19_20_recode,
  family = beta_family(link="logit"))

res <- simulateResiduals(herbivory_gr_usc_m2)
plot(res)


# Urb sites / city_dist----------
herbivory_urb_dist_m1 <- glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
    data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = binomial,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(herbivory_urb_dist_m1)
plot(res)
# try beta

herbivory_urb_dist_m2 <- glmmTMB(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
  data = herbivory_19_20_recode %>% dplyr::filter(., Transect_ID != "Rural"),
  family = beta_family(link="logit"))

res <- simulateResiduals(herbivory_urb_dist_m2)
plot(res)


# main effects:
herbivory_urb_dist_m2_ME <- herbivory_urb_dist_m2 <- glmmTMB(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist + Transect_ID,
  data = herbivory_19_20_recode %>% dplyr::filter(., Transect_ID != "Rural"),
  family = beta_family(link="logit"))




# Urb sites / urb_score----------
herbivory_urb_usc_m1 <- glmer(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
    data = herbivory_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = binomial,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(herbivory_urb_usc_m1)
plot(res)
# try beta

herbivory_urb_usc_m2 <- glmmTMB(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
  data = herbivory_19_20_recode %>% dplyr::filter(., Transect_ID != "Rural"),
  family = beta_family(link="logit"))

res <- simulateResiduals(herbivory_urb_usc_m2)
plot(res)


# # main effects:
herbivory_urb_usc_m2_ME <- glmmTMB(Herbivory_mean_Sept ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
  data = herbivory_19_20_recode %>% dplyr::filter(., Transect_ID != "Rural"),
  family = beta_family(link="logit"))
```

#### Entire gradient: *NOT sig for city_dist or urb_score
##### City_dist
```{r}
car::Anova(herbivory_gr_dist_m5)
# doesn't converge with all terms... 

r.squaredGLMM(herbivory_gr_dist_m5)
```

##### Urb_score
```{r}
car::Anova(ramets_gr_usc_m1)
# dist not significant

r.squaredGLMM(ramets_gr_usc_m1)

```

#### Urban subtransects: nothing sig
##### City_dist
```{r}
car::Anova(ramets_urb_dist_m1)
# nothing sig

r.squaredGLMM(ramets_urb_dist_m1)


# just main effects
car::Anova(ramets_urb_dist_m2_ME)
# nothing sig

r.squaredGLMM(ramets_urb_dist_m2_ME)

AIC((ramets_urb_dist_m1),
    (ramets_urb_dist_m2_ME)) # better but <2 AIC from full model
```

##### Urb_score
```{r}
car::Anova(ramets_urb_usc_m1)
# nothing sig

r.squaredGLMM(ramets_urb_usc_m1)


# just main effects
car::Anova(ramets_urb_usc_m2_ME)
# nothing sig

r.squaredGLMM(ramets_urb_usc_m2_ME)

AIC((ramets_urb_usc_m1),
    (ramets_urb_usc_m2_ME)) # better but <2 AIC from full model
```


## Survival
### glmer: diagnostics
```{r}
# Gradient / city_dist----------
survival_gr_dist_m1 <- glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist,
                               nAGQ=0,
  data = survival_19_20,
  family = binomial(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(survival_gr_dist_m1)
plot(res)
# looks great!



# Gradient / urb_score----------
survival_gr_usc_m1 <- glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score,
  data = survival_19_20,
  family = binomial(link = "logit"), 
  nAGQ=0,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(survival_gr_usc_m1)
plot(res)
# looks great!


# Urb sites / city_dist----------
survival_urb_dist_m1 <- glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) + City_dist * Transect_ID,
 data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
   nAGQ=0,
 family = binomial(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(survival_gr_dist_m1)
plot(res)
# looks good!


# main effects:
survival_urb_dist_m1_ME <- glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) +  City_dist + Transect_ID,
    data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
       nAGQ=0,
    family = binomial(link = "logit"),
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))




# Urb sites / urb_score----------
survival_urb_usc_m1 <- glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score * Transect_ID,
    data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = binomial(link = "logit"),
       nAGQ=0,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))

res <- simulateResiduals(survival_urb_usc_m1)
plot(res)
# looks good though it doesn't pass the KS test... I think it's fine though


# main effects:
survival_urb_usc_m1_ME <- glmer(Dead ~ (1|Block) + (1|Year) + (1|Population/Family) + Urb_score + Transect_ID,
    data = survival_19_20 %>% dplyr::filter(., Transect_ID != "Rural"),
    family = binomial,
       nAGQ=0,
  control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=2e5)))
```

### Entire gradient: *Nothing sig for either
#### City_dist
```{r}
car::Anova(survival_gr_dist_m1)
# dist not significant

r.squaredGLMM(survival_gr_dist_m1)

```

#### Urb_score
```{r}
car::Anova(survival_gr_usc_m1)
# dist not significant

r.squaredGLMM(survival_gr_usc_m1)

```


### Urban subtransects: *Interaxn sig for city_dist but nothing sig for urb_score
#### City_dist
```{r}
car::Anova(survival_urb_dist_m1)
# interaction sig!

r.squaredGLMM(survival_urb_dist_m1)


# just main effects
car::Anova(survival_urb_dist_m2_ME)
#  nothing sig

r.squaredGLMM(survival_urb_dist_m2_ME)

AIC((survival_urb_dist_m1),
    (survival_urb_dist_m1_ME)) # full model better
```


#### Urb_score
```{r}
car::Anova(survival_urb_usc_m1)
# nothing sig

r.squaredGLMM(survival_urb_usc_m1)


# just main effects
car::Anova(survival_urb_usc_m1_ME)
#  nothing sig

r.squaredGLMM(survival_urb_usc_m1_ME)

AIC((survival_urb_usc_m1),
    (survival_urb_usc_m1_ME)) # better but <2 AIC from full model
```


